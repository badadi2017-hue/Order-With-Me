<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order With Me - ERP</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #6366f1;
            --primary-light: rgba(99,102,241,0.10);
            --bg: #f0f2f8;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #f43f5e;
            --border: #e2e8f0;
            --warning: #f59e0b;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(79,70,229,0.14);
            --radius: 16px;
            --radius-sm: 10px;
            --header-h: 60px;
            --bottom-nav-h: 64px;
            /* Auth */
            --auth-bg-start: #f0f2f8;
            --auth-bg-end: #e4e8f5;
            --auth-card-bg: #ffffff;
            --auth-card-border: rgba(79,70,229,0.15);
            --auth-card-shadow: 0 20px 60px rgba(79,70,229,0.12);
            --auth-input-bg: rgba(79,70,229,0.04);
            --auth-input-border: rgba(79,70,229,0.18);
            --auth-input-color: #1e293b;
            --auth-title-color: #1e293b;
            --auth-sub-color: #64748b;
            --auth-brand-start: #4f46e5;
            --auth-brand-end: #06b6d4;
            --auth-select-option-bg: #ffffff;
        }
        body.dark-mode {
            --primary: #6366f1;
            --secondary: #818cf8;
            --primary-light: rgba(99,102,241,0.15);
            --bg: #0d0f1a;
            --card: #151929;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --border: #1e2740;
            --shadow: 0 2px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --auth-bg-start: #0d0f1a;
            --auth-bg-end: #151929;
            --auth-card-bg: #151929;
            --auth-card-border: rgba(99,102,241,0.25);
            --auth-card-shadow: 0 20px 60px rgba(0,0,0,0.6);
            --auth-input-bg: rgba(255,255,255,0.05);
            --auth-input-border: rgba(255,255,255,0.08);
            --auth-input-color: #e2e8f0;
            --auth-title-color: #e2e8f0;
            --auth-sub-color: #64748b;
            --auth-brand-start: #6366f1;
            --auth-brand-end: #22d3ee;
            --auth-select-option-bg: #151929;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            padding-bottom: calc(var(--bottom-nav-h) + 20px);
        }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 14px;
            border: 1px solid var(--border);
            overflow: visible;
            transition: box-shadow 0.25s, transform 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        /* ===== COLLAPSIBLE CARD ===== */
        .collapse-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        .collapse-card:hover { box-shadow: var(--shadow-md); }
        .collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 18px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            gap: 8px;
        }
        .collapse-header:hover { background: rgba(99,102,241,0.05); }
        .collapse-arrow {
            font-size: 11px;
            color: #94a3b8;
            transition: transform 0.25s ease;
            display: inline-block;
            flex-shrink: 0;
        }
        .collapse-arrow.open { transform: rotate(180deg); }
        .collapse-body {
            padding: 0 18px 16px 18px;
            border-top: 1px solid var(--border);
            animation: collapseIn 0.2s ease;
        }
        .collapse-body-inner { padding-top: 14px; }
        @keyframes collapseIn {
            from { opacity: 0; transform: translateY(-5px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .input-field {
            width: 100%;
            padding: 11px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
            background: var(--card);
        }
        .input-field::placeholder { color: #94a3b8; }
        .btn {
            width: 100%;
            padding: 13px 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            font-weight: 700;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(79,70,229,0.3);
            letter-spacing: 0.3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79,70,229,0.35); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .btn-success:hover { box-shadow: 0 8px 20px rgba(16,185,129,0.4); }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            box-shadow: none;
        }
        .btn-outline:hover { background: var(--primary-light); box-shadow: none; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        #auth-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--auth-bg-start) 0%, var(--auth-bg-end) 50%, var(--auth-bg-start) 100%);
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow: hidden;
            transition: background 0.4s ease;
        }
        #auth-screen::before {
            content: '';
            position: absolute;
            top: -100px; right: -100px;
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(99,102,241,0.12) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #auth-screen::after {
            content: '';
            position: absolute;
            bottom: -80px; left: -80px;
            width: 320px; height: 320px;
            background: radial-gradient(circle, rgba(16,185,129,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #login-box, #reg-box {
            background: var(--auth-card-bg) !important;
            border: 1px solid var(--auth-card-border) !important;
            box-shadow: var(--auth-card-shadow) !important;
            position: relative;
            z-index: 1;
            transition: background 0.4s, border 0.4s, box-shadow 0.4s;
        }
        .auth-brand {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            transition: all 0.4s;
        }
        .auth-brand-sub { color: var(--auth-sub-color); font-size: 13px; margin-bottom: 22px; transition: color 0.4s; }
        .auth-title-text { color: var(--auth-title-color) !important; transition: color 0.4s; }
        #login-box .input-field, #reg-box .input-field {
            background: var(--auth-input-bg);
            border-color: var(--auth-input-border);
            color: var(--auth-input-color);
            transition: background 0.4s, border-color 0.4s, color 0.4s;
        }
        #login-box .input-field:focus, #reg-box .input-field:focus {
            border-color: #6366f1;
            background: rgba(99,102,241,0.1);
        }
        #login-box .input-field::placeholder, #reg-box .input-field::placeholder { color: var(--auth-sub-color); }
        #login-box select.input-field option, #reg-box select.input-field option {
            background: var(--auth-select-option-bg);
            color: var(--auth-input-color);
        }
        .auth-link-text { color: var(--auth-sub-color); font-size: 13px; }
        .auth-link-highlight { color: #6366f1; font-weight: 700; cursor: pointer; }
        #app-screen { display: none; }
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes heartBeat {
            0%   { transform: scale(1); }
            14%  { transform: scale(1.3); }
            28%  { transform: scale(1); }
            42%  { transform: scale(1.25); }
            70%  { transform: scale(1); }
            100% { transform: scale(1); }
        }
        .header {
            background: linear-gradient(135deg, #3730a3 0%, #4f46e5 50%, #6366f1 100%);
            color: white;
            padding: 0 18px;
            height: var(--header-h);
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 24px rgba(79,70,229,0.35);
            display: flex; align-items: center; justify-content: space-between;
        }
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
            box-shadow: 0 4px 24px rgba(0,0,0,0.5);
        }
        .sidebar {
            position: fixed; top: 0; left: -300px; width: 270px; height: 100vh;
            background: var(--card);
            box-shadow: 8px 0 30px rgba(0,0,0,0.15);
            transition: left 0.35s cubic-bezier(0.4,0,0.2,1);
            z-index: 1000; padding: 0; box-sizing: border-box;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            display: none; z-index: 999;
            backdrop-filter: blur(3px);
        }
        .overlay.active { display: block; }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: linear-gradient(135deg, rgba(79,70,229,0.09), rgba(99,102,241,0.04));
            flex-shrink: 0;
        }
        body.dark-mode .sidebar-header {
            background: linear-gradient(135deg, rgba(99,102,241,0.14), rgba(99,102,241,0.05));
        }
        .sidebar-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .sidebar-edit-btn {
            background: var(--primary-light);
            border: 1px solid rgba(99,102,241,0.3);
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 9px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s, transform 0.15s;
            white-space: nowrap;
        }
        .sidebar-edit-btn:hover { background: rgba(99,102,241,0.2); transform: scale(1.03); }
        .sidebar-edit-btn.active-edit { background: var(--primary); color: white; border-color: var(--primary); }

        .sidebar-nav-area {
            padding: 12px 14px;
            flex: 1;
        }

        .menu-item {
            padding: 11px 14px; border-radius: 12px;
            font-size: 14px; cursor: pointer; margin-bottom: 4px;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s, transform 0.15s, color 0.2s;
            color: var(--text);
            user-select: none;
        }
        .menu-item:hover { background: var(--primary-light); transform: translateX(4px); }
        .menu-item.active-menu {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            box-shadow: 0 4px 12px rgba(79,70,229,0.25);
        }
        .menu-item.active-menu:hover { transform: none; }

        .menu-item.dragging {
            opacity: 0.5;
            background: var(--primary-light) !important;
            border: 2px dashed var(--primary);
            transform: scale(0.97);
        }
        .menu-item.drag-over {
            border-top: 2px solid var(--primary);
            margin-top: -2px;
        }
        .drag-handle {
            display: none;
            cursor: grab;
            color: #94a3b8;
            font-size: 14px;
            padding: 0 6px 0 0;
            flex-shrink: 0;
        }
        .drag-handle:active { cursor: grabbing; }
        body.menu-edit-mode .drag-handle { display: inline; }
        body.menu-edit-mode .menu-item { cursor: grab; }
        body.menu-edit-mode .menu-item:hover { transform: none; }
        body.menu-edit-mode .menu-item.active-menu:hover { transform: none; }
        /* CRITICAL: Prevent child spans from intercepting drag events */
        body.menu-edit-mode .drag-handle { pointer-events: auto !important; cursor: grab !important; }
        body.menu-edit-mode .menu-item { cursor: grab !important; }
        body.menu-edit-mode .menu-item:active { cursor: grabbing !important; }
        body.menu-edit-mode .menu-item * { pointer-events: none; }
        body.menu-edit-mode .menu-section-label * { pointer-events: none; }
        .menu-item.dragging { opacity: 0.4; }
        .menu-item.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }
        .menu-section-label.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }

        .menu-section-label {
            font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
            margin-bottom: 6px; margin-left: 4px; margin-top: 4px;
            color: #94a3b8; text-transform: uppercase;
            display: flex; align-items: center; gap: 6px;
        }
        .menu-section-label .drag-handle { display: none; }
        body.menu-edit-mode .menu-section-label .drag-handle { display: inline; }
        .menu-hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }
        .qa-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 10px 6px; border-radius: 12px; border: 1.5px solid var(--border);
            background: var(--bg); cursor: pointer; transition: all 0.2s; text-align: center;
            font-family: 'Poppins', sans-serif; color: var(--text); position: relative; overflow: hidden;
        }
        .qa-btn:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79,70,229,0.15); }
        .qa-btn:active { transform: translateY(0); }
        .qa-btn-icon { font-size: 20px; line-height: 1; }
        .qa-btn-label { font-size: 10px; font-weight: 700; color: var(--text); line-height: 1.2; }
        .qa-btn-count { font-size: 9px; color: #94a3b8; font-weight: 600; }
        .qa-badge { position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; font-size: 8px; font-weight: 800; padding: 1px 5px; border-radius: 99px; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
        .dash-card {
            border-radius: 16px; padding: 14px 16px;
            transition: transform 0.25s, box-shadow 0.25s;
            border: 1px solid transparent;
            position: relative; overflow: hidden;
        }
        .dash-card::before {
            content: '';
            position: absolute; top: -20px; right: -20px;
            width: 80px; height: 80px; border-radius: 50%;
            opacity: 0.12;
        }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        .dc-today  { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #a7f3d0; }
        .dc-today::before { background: #10b981; }
        .dc-today .dc-val { color: #065f46; }
        .dc-today .dc-lbl { color: #047857; }
        .dc-today .dc-icon-bg { background: rgba(16,185,129,0.15); color: #10b981; }
        .dc-total  { background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-color: #c7d2fe; }
        .dc-total::before { background: #4f46e5; }
        .dc-total .dc-val { color: #3730a3; }
        .dc-total .dc-lbl { color: #4338ca; }
        .dc-total .dc-icon-bg { background: rgba(79,70,229,0.15); color: #4f46e5; }
        .dc-orders { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #bae6fd; }
        .dc-orders::before { background: #0284c7; }
        .dc-orders .dc-val { color: #0c4a6e; }
        .dc-orders .dc-lbl { color: #0369a1; }
        .dc-orders .dc-icon-bg { background: rgba(2,132,199,0.15); color: #0284c7; }
        .dc-alert  { background: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%); border-color: #fecdd3; }
        .dc-alert::before { background: #f43f5e; }
        .dc-alert .dc-val { color: #9f1239; }
        .dc-alert .dc-lbl { color: #be123c; }
        .dc-alert .dc-icon-bg { background: rgba(244,63,94,0.15); color: #f43f5e; }
        /* Dark mode */
        body.dark-mode .dc-today  { background: linear-gradient(135deg, rgba(16,185,129,0.18), rgba(16,185,129,0.06)); border-color: rgba(16,185,129,0.25); }
        body.dark-mode .dc-today .dc-val { color: #34d399; } body.dark-mode .dc-today .dc-lbl { color: #6ee7b7; }
        body.dark-mode .dc-total  { background: linear-gradient(135deg, rgba(99,102,241,0.18), rgba(99,102,241,0.06)); border-color: rgba(99,102,241,0.25); }
        body.dark-mode .dc-total .dc-val { color: #818cf8; } body.dark-mode .dc-total .dc-lbl { color: #a5b4fc; }
        body.dark-mode .dc-orders { background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(34,211,238,0.04)); border-color: rgba(34,211,238,0.2); }
        body.dark-mode .dc-orders .dc-val { color: #22d3ee; } body.dark-mode .dc-orders .dc-lbl { color: #67e8f9; }
        body.dark-mode .dc-alert  { background: linear-gradient(135deg, rgba(244,63,94,0.18), rgba(244,63,94,0.06)); border-color: rgba(244,63,94,0.25); }
        body.dark-mode .dc-alert .dc-val { color: #fb7185; } body.dark-mode .dc-alert .dc-lbl { color: #fda4af; }
        .dc-icon-bg { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 10px; }
        .dc-today .dc-icon-bg svg, .dc-today .dc-icon-bg { stroke: #10b981; }
        .dc-total .dc-icon-bg svg, .dc-total .dc-icon-bg { stroke: #4f46e5; }
        .dc-orders .dc-icon-bg svg, .dc-orders .dc-icon-bg { stroke: #0284c7; }
        .dc-alert .dc-icon-bg svg, .dc-alert .dc-icon-bg { stroke: #f43f5e; }
        .dc-lbl { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; margin-bottom: 2px; }
        .dc-val { font-size: 18px; font-weight: 900; line-height: 1.1; }
        .dc-icon { display: none; } /* replaced by dc-icon-bg */
        .card-success { border-left: 3px solid var(--success); }
        /* Manager-only columns: hidden for salesman role */
        body.role-salesman .mgr-only-col { display: none !important; }
        /* Shop Notes */
        .shop-note-card { background: rgba(245,158,11,0.07); border:1.5px solid rgba(245,158,11,0.25); border-radius:14px; padding:12px 14px; margin-bottom:8px; }
        .shop-note-card .note-meta { font-size:10px; color:#94a3b8; margin-top:4px; }
        .shop-note-card .note-text { font-size:13px; color:var(--text); font-weight:500; line-height:1.5; }
        .shop-note-badge { display:inline-block; font-size:10px; font-weight:700; background:rgba(245,158,11,0.15); color:#b45309; border-radius:20px; padding:2px 8px; margin-left:6px; vertical-align:middle; }
        .card-warning  { border-left: 3px solid var(--warning); }
        .card-danger   { border-left: 3px solid var(--danger); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 10px; }

        .collapsible-section {
            border: 1.5px solid var(--border);
            border-radius: 16px;
            margin-bottom: 14px;
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow);
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            background: var(--card);
            user-select: none;
            transition: background 0.2s;
        }
        .collapsible-header:hover { background: var(--primary-light); }
        .collapsible-header .ch-title {
            font-size: 15px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
        }
        .collapsible-header .ch-arrow {
            font-size: 12px; color: #94a3b8;
            transition: transform 0.3s;
        }
        .collapsible-header.open .ch-arrow { transform: rotate(180deg); }
        .collapsible-body {
            display: none;
            padding: 0 20px 18px;
            border-top: 1px solid var(--border);
            animation: fadeUp 0.25s ease;
        }
        .collapsible-body.open { display: block; }

        .collapse-btn {
            background: var(--primary-light);
            color: var(--primary);
            cursor: pointer; padding: 11px 16px; width: 100%;
            border: 1px dashed var(--primary);
            text-align: center; outline: none;
            font-size: 13px; font-weight: 700;
            border-radius: 12px; margin-bottom: 14px;
            transition: background 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .collapse-btn:hover { background: rgba(79,70,229,0.18); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; min-width: 600px; }
        .data-table th {
            background: var(--primary-light);
            padding: 12px 14px;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
            white-space: nowrap;
            font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
        }
        .data-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--primary-light); }
        /* PDF page-break safety */
        .data-table tr  { page-break-inside: avoid; break-inside: avoid; }
        .data-table td,
        .data-table th  { page-break-inside: avoid; break-inside: avoid; }

        /* ===== GLASSMORPHISM SYSTEM ===== */
        :root {
            --glass-bg: rgba(255,255,255,0.72);
            --glass-border: rgba(255,255,255,0.5);
            --glass-shadow: 0 8px 32px rgba(79,70,229,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
            --glass-blur: blur(18px) saturate(1.6);
            --glass-dark-bg: rgba(21,25,41,0.72);
            --glass-dark-border: rgba(255,255,255,0.08);
        }

        /* Cards get glass effect */
        .card {
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border) !important;
            box-shadow: var(--glass-shadow) !important;
        }
        body.dark-mode .card {
            background: var(--glass-dark-bg) !important;
            border: 1px solid var(--glass-dark-border) !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35), 0 1.5px 8px rgba(0,0,0,0.2) !important;
        }

        /* Collapse cards */
        .collapse-card {
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-color: var(--glass-border) !important;
            box-shadow: var(--glass-shadow) !important;
        }
        body.dark-mode .collapse-card {
            background: var(--glass-dark-bg) !important;
            border-color: var(--glass-dark-border) !important;
        }

        /* Header glass */
        .header {
            background: linear-gradient(135deg, rgba(55,48,163,0.88) 0%, rgba(79,70,229,0.90) 50%, rgba(99,102,241,0.88) 100%) !important;
            backdrop-filter: blur(20px) saturate(1.8);
            -webkit-backdrop-filter: blur(20px) saturate(1.8);
            box-shadow: 0 4px 32px rgba(79,70,229,0.30), 0 1px 0 rgba(255,255,255,0.12) inset !important;
        }
        body.dark-mode .header {
            background: linear-gradient(135deg, rgba(30,27,75,0.92) 0%, rgba(49,46,129,0.90) 50%, rgba(55,48,163,0.88) 100%) !important;
        }

        /* Sidebar glass */
        .sidebar {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(24px) saturate(1.7);
            -webkit-backdrop-filter: blur(24px) saturate(1.7);
            box-shadow: 8px 0 40px rgba(79,70,229,0.12), 2px 0 0 rgba(255,255,255,0.4) inset !important;
            border-right: 1px solid var(--glass-border) !important;
        }
        body.dark-mode .sidebar {
            background: var(--glass-dark-bg) !important;
            box-shadow: 8px 0 40px rgba(0,0,0,0.4) !important;
            border-right: 1px solid var(--glass-dark-border) !important;
        }

        /* Sidebar header */
        .sidebar-header {
            background: linear-gradient(135deg, rgba(79,70,229,0.12), rgba(99,102,241,0.05)) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.35) !important;
        }
        body.dark-mode .sidebar-header {
            background: linear-gradient(135deg, rgba(99,102,241,0.18), rgba(99,102,241,0.06)) !important;
            border-bottom: 1px solid rgba(255,255,255,0.06) !important;
        }

        /* Bottom nav glass */
        #bottomNav {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(24px) saturate(1.8);
            -webkit-backdrop-filter: blur(24px) saturate(1.8);
            border-top: 1px solid var(--glass-border) !important;
            box-shadow: 0 -4px 24px rgba(79,70,229,0.10), 0 -1px 0 rgba(255,255,255,0.5) inset !important;
        }
        body.dark-mode #bottomNav {
            background: var(--glass-dark-bg) !important;
            border-top: 1px solid var(--glass-dark-border) !important;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.4) !important;
        }

        /* Active menu item glass */
        .menu-item.active-menu {
            background: linear-gradient(135deg, rgba(79,70,229,0.82), rgba(99,102,241,0.78)) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.22) !important;
        }

        /* Body background - subtle gradient mesh for glass to reflect */
        body:not(.custom-bg) {
            background: linear-gradient(135deg, #e8ecf8 0%, #eef0fb 30%, #f0f4ff 60%, #e6eaf6 100%) !important;
        }
        body.dark-mode:not(.custom-bg) {
            background: linear-gradient(135deg, #090b14 0%, #0d0f1c 40%, #0f1220 70%, #0b0d18 100%) !important;
        }
        body.custom-bg.anim-bg {
            animation: bgShift 12s ease infinite !important;
        }

        /* Toast glass */
        .toast {
            backdrop-filter: blur(16px) saturate(1.5);
            -webkit-backdrop-filter: blur(16px) saturate(1.5);
            background: var(--glass-bg) !important;
            border: 1px solid var(--glass-border) !important;
        }
        body.dark-mode .toast {
            background: var(--glass-dark-bg) !important;
            border: 1px solid var(--glass-dark-border) !important;
        }

        /* Modal glass */
        #resetPassModal > div, #showPassModal > div, #deleteConfirmModal > div {
            backdrop-filter: blur(20px) saturate(1.6);
            -webkit-backdrop-filter: blur(20px) saturate(1.6);
            background: var(--glass-bg) !important;
            border: 1px solid var(--glass-border) !important;
        }
        body.dark-mode #resetPassModal > div,
        body.dark-mode #showPassModal > div {
            background: var(--glass-dark-bg) !important;
            border: 1px solid var(--glass-dark-border) !important;
        }

        /* Quick action buttons glass */
        .qa-btn {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border) !important;
        }
        body.dark-mode .qa-btn {
            background: var(--glass-dark-bg) !important;
            border: 1px solid var(--glass-dark-border) !important;
        }

        /* Collapsible sections */
        .collapsible-section {
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1.5px solid var(--glass-border) !important;
            box-shadow: var(--glass-shadow) !important;
        }
        body.dark-mode .collapsible-section {
            background: var(--glass-dark-bg) !important;
            border-color: var(--glass-dark-border) !important;
        }
        .collapsible-header {
            background: transparent !important;
        }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); padding: 13px 22px;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 3000; display: none;
            border-left: 4px solid var(--primary);
            font-weight: 600; font-size: 14px; color: var(--text);
        }

        /* ===== UNDO SNACKBAR ===== */
        #undo-bar {
            position: fixed; bottom: calc(var(--bottom-nav-h) + 12px); left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: #1e293b; color: white;
            padding: 12px 16px; border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.40), 0 2px 8px rgba(0,0,0,0.2);
            z-index: 4000; display: flex; align-items: center; gap: 12px;
            font-size: 13px; font-weight: 600;
            transition: transform 0.38s cubic-bezier(0.34,1.56,0.64,1), visibility 0s linear 0.38s;
            white-space: nowrap; max-width: 92vw;
            visibility: hidden; pointer-events: none;
            border: 1px solid rgba(255,255,255,0.08);
        }
        #undo-bar.visible {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
            pointer-events: auto;
            transition: transform 0.38s cubic-bezier(0.34,1.56,0.64,1), visibility 0s linear 0s;
        }
        #undo-bar .undo-icon {
            width: 30px; height: 30px; border-radius: 8px;
            background: rgba(244,63,94,0.2); display: flex; align-items: center;
            justify-content: center; font-size: 15px; flex-shrink: 0;
        }
        #undo-bar .undo-msg { flex: 1; opacity: 0.92; font-size: 12.5px; }
        #undo-bar .undo-msg .undo-label { font-size: 10px; opacity: 0.6; font-weight: 500; display: block; margin-bottom: 1px; letter-spacing: 0.3px; text-transform: uppercase; }
        #undo-bar .undo-timer-ring {
            width: 28px; height: 28px; flex-shrink: 0;
            position: relative;
        }
        #undo-bar .undo-timer-ring svg { transform: rotate(-90deg); }
        #undo-bar .undo-timer-ring circle {
            fill: none; stroke: rgba(255,255,255,0.15); stroke-width: 2.5;
        }
        #undo-bar .undo-timer-ring .ring-progress {
            stroke: #10b981; stroke-dasharray: 72; stroke-dashoffset: 0;
            transition: stroke-dashoffset linear;
            stroke-linecap: round;
        }
        #undo-bar .undo-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white; border: none;
            padding: 8px 16px; border-radius: 10px; font-size: 12.5px;
            font-weight: 800; cursor: pointer; font-family: 'Poppins', sans-serif;
            flex-shrink: 0; transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 3px 10px rgba(16,185,129,0.4);
            letter-spacing: 0.3px;
        }
        #undo-bar .undo-btn:hover { transform: scale(1.06); box-shadow: 0 5px 16px rgba(16,185,129,0.55); }
        #undo-bar .undo-dismiss {
            background: rgba(255,255,255,0.08); border: none; color: rgba(255,255,255,0.5);
            font-size: 14px; cursor: pointer; padding: 5px 7px; line-height: 1;
            flex-shrink: 0; border-radius: 7px; transition: background 0.2s;
        }
        #undo-bar .undo-dismiss:hover { background: rgba(255,255,255,0.15); color: white; }
        body.dark-mode #undo-bar { background: #0f172a; border-color: rgba(255,255,255,0.12); }
        .highlight-box {
            display: none;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 12px 14px; border-radius: 12px;
            font-size: 13px; margin-bottom: 12px;
            font-weight: 600; line-height: 1.6;
        }
        body.dark-mode .highlight-box {
            background: rgba(34,211,238,0.08);
            border-color: rgba(34,211,238,0.25);
            color: #22d3ee;
        }
        .toggle-box {
            display: flex; background: var(--bg);
            border-radius: 12px; margin-bottom: 12px;
            border: 1.5px solid var(--border); overflow: hidden;
        }
        .toggle-box label {
            flex: 1; text-align: center; padding: 10px 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: background 0.25s, color 0.25s; color: var(--text);
        }
        .toggle-box label:has(input:checked) {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
        }
        .toggle-box input { display: none; }
        /* ===== ATTENDANCE STYLES ===== */
        .att-salesman-row {
            background: var(--bg); border: 1.5px solid var(--border); border-radius: 14px;
            padding: 12px 14px; display: flex; align-items: center; gap: 12px;
            transition: border-color 0.2s;
        }
        .att-salesman-row .att-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white; font-size: 15px; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .att-salesman-row .att-name { font-weight: 700; font-size: 13px; flex: 1; }
        .att-status-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .att-status-btn {
            border: 1.5px solid var(--border); background: var(--card);
            border-radius: 8px; padding: 5px 10px; font-size: 11px; font-weight: 700;
            cursor: pointer; font-family: 'Poppins', sans-serif; color: #64748b;
            transition: all 0.15s; white-space: nowrap;
        }
        .att-status-btn.selected-present  { background: rgba(16,185,129,0.15); border-color: #10b981; color: #065f46; }
        .att-status-btn.selected-absent   { background: rgba(244,63,94,0.12);  border-color: #f43f5e; color: #9f1239; }
        .att-status-btn.selected-halfday  { background: rgba(245,158,11,0.12); border-color: #f59e0b; color: #92400e; }
        .att-status-btn.selected-leave    { background: rgba(99,102,241,0.12); border-color: #6366f1; color: #3730a3; }

        .att-pct-bar { height: 6px; border-radius: 99px; background: var(--border); overflow: hidden; margin-top: 4px; }
        .att-pct-bar-fill { height: 100%; border-radius: 99px; transition: width 0.6s; }

        /* ===== CLASSIC INVOICE BILL STYLES ===== */
        .bill-container {
            background: #ffffff; color: #1a1a2e;
            max-width: 520px; margin: 0 auto; padding: 0;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border: 1px solid #e2e8f0; position: relative;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        /* Logo banner */
        .bill-logo-wrap {
            text-align: center;
            padding: 8px 20px 0 20px;
            background: #fff;
        }
        .bill-logo-wrap img {
            max-height: 40px; max-width: 160px;
            object-fit: contain; display: block; margin: 0 auto;
        }
        /* Header band â€” compact, professional */
        .bill-header {
            background: #ffffff;
            color: #1a1a2e;
            text-align: center;
            padding: 6px 20px 5px;
            border-bottom: 2px double #1a1a2e;
            margin-top: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .bill-header h1 {
            margin: 0; font-size: 15px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 2px; color: #1a1a2e;
        }
        .bill-header .bill-tagline {
            font-size: 8.5px; color: #94a3b8;
            letter-spacing: 1px; margin-top: 0;
            border-left: 1.5px solid #cbd5e1;
            padding-left: 10px;
            text-transform: uppercase;
        }
        /* Invoice info strip */
        .bill-info-strip {
            display: flex; justify-content: space-between;
            padding: 8px 16px; background: #f8faff;
            border-bottom: 1px solid #e2e8f0;
            font-size: 10.5px; color: #1a1a2e; gap: 10px;
        }
        .bill-info-strip .billed-to { flex: 1; }
        .bill-info-strip .billed-to .label { font-size: 8px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .bill-info-strip .billed-to .shop-name { font-size: 12px; font-weight: 800; color: #1a1a2e; line-height: 1.2; }
        .bill-info-strip .billed-to .shop-detail { font-size: 9.5px; color: #64748b; margin-top: 1px; }
        .bill-info-strip .bill-meta-right { text-align: right; flex-shrink: 0; }
        .bill-info-strip .bill-meta-right .meta-row { display: flex; justify-content: flex-end; gap: 6px; margin-bottom: 1px; font-size: 9.5px; }
        .bill-info-strip .bill-meta-right .meta-row .key { color: #64748b; }
        .bill-info-strip .bill-meta-right .meta-row .val { font-weight: 700; color: #1a1a2e; }
        /* Table */
        .bill-table {
            width: 100%; border-collapse: collapse;
            font-size: 11.5px; margin: 0;
        }
        .bill-table thead tr {
            background: #f1f5f9; color: #1a1a2e;
            border-bottom: 2px solid #1a1a2e;
        }
        .bill-table thead th {
            padding: 9px 10px; font-size: 9.5px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.8px;
            white-space: nowrap; border: 1px solid #cbd5e1;
            color: #1a1a2e;
            page-break-inside: avoid; break-inside: avoid;
        }
        .bill-table thead th:last-child,
        .bill-table thead th.col-rate,
        .bill-table thead th.col-amt { text-align: right; }
        .bill-table thead th.col-qty { text-align: center; }
        .bill-table tbody tr { page-break-inside: avoid; break-inside: avoid; }
        .bill-table tbody tr:nth-child(even) td { background: #f8faff; }
        .bill-table tbody tr:nth-child(odd)  td { background: #ffffff; }
        .bill-table td {
            padding: 9px 10px; border: 1px solid #e2e8f0;
            color: #1a1a2e; vertical-align: middle;
            page-break-inside: avoid; break-inside: avoid;
        }
        .bill-table td.col-sl  { color: #94a3b8; font-size: 10px; text-align: center; width: 28px; }
        .bill-table td.col-desc .prod-name { font-weight: 700; font-size: 12px; }
        .bill-table td.col-rate { text-align: right; white-space: nowrap; }
        .bill-table td.col-qty  { text-align: center; font-weight: 700; }
        .bill-table td.col-amt  { text-align: right; font-weight: 700; white-space: nowrap; }
        /* Totals block */
        .bill-totals-block {
            padding: 10px 16px 12px;
            border-top: 2px solid #1a1a2e;
            background: #fff;
        }
        .bill-totals-block .totals-row {
            display: flex; justify-content: flex-end; align-items: center;
            gap: 20px; padding: 4px 0; font-size: 11.5px;
        }
        .bill-totals-block .totals-row .t-label { color: #64748b; }
        .bill-totals-block .totals-row .t-val   { font-weight: 700; color: #1a1a2e; min-width: 80px; text-align: right; }
        .bill-totals-block .grand-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px; padding-top: 8px;
            border-top: 1.5px dashed #c7d2e0;
        }
        .bill-totals-block .grand-row .g-label {
            font-size: 12px; font-weight: 800; color: #1a1a2e;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .bill-totals-block .grand-row .g-val {
            font-size: 17px; font-weight: 900; color: #1a1a2e;
        }
        /* Footer */
        .bill-footer {
            background: #f8faff; border-top: 1px solid #e2e8f0;
            padding: 10px 20px; text-align: center;
            font-size: 9.5px; color: #94a3b8; letter-spacing: 0.3px;
        }
        .bill-footer .thank-you {
            font-size: 11px; font-weight: 700; color: #2d3561;
            margin-bottom: 3px; letter-spacing: 1px;
        }
        /* Signature row */
        .bill-sign-row {
            display: flex; justify-content: space-between;
            padding: 14px 20px 10px; font-size: 10px; color: #64748b;
        }
        .bill-sign-row .sign-box {
            text-align: center; min-width: 100px;
        }
        .bill-sign-row .sign-box .sign-line {
            border-top: 1px solid #c7d2e0; padding-top: 4px; margin-top: 24px;
        }
        .daily-pass-card {
            border: 1.5px solid rgba(99,102,241,0.3) !important;
            background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02)) !important;
        }
        .pass-display {
            background: var(--bg);
            border: 2px dashed rgba(99,102,241,0.35);
            border-radius: 12px;
            padding: 20px; text-align: center; margin: 12px 0;
            letter-spacing: 8px; font-size: 24px; font-weight: 700;
            color: var(--primary); font-family: 'Courier New', monospace;
        }
        .pass-validity { font-size: 11px; color: #64748b; text-align: center; margin-top: 6px; }
        .master-unlock { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .master-unlock input { flex: 1; margin-bottom: 0 !important; }
        .master-unlock button { width: auto; margin-bottom: 0 !important; padding: 12px 16px; white-space: nowrap; flex-shrink: 0; }
        .pass-locked-msg { text-align: center; padding: 16px; color: #64748b; font-size: 13px; }
        .pass-locked-msg .lock-icon { font-size: 32px; display: block; margin-bottom: 8px; }

        .report-filter-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .report-filter-bar select, .report-filter-bar input[type="date"] {
            flex: 1; min-width: 120px;
            padding: 9px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            background: var(--card);
            color: var(--text);
            outline: none;
        }
        .report-filter-bar select:focus, .report-filter-bar input[type="date"]:focus {
            border-color: var(--primary);
        }

        .date-preset-grid {
            display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .preset-btn {
            padding: 7px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .preset-btn:hover, .preset-btn.active-preset {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .sort-toggle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .sort-option {
            padding: 9px 10px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
        }
        .sort-option:hover, .sort-option.active-sort {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            border-color: var(--primary);
        }
        .report-stat-mini {
            background: var(--card);
            border-radius: 14px;
            padding: 14px 16px;
            flex: 1;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .report-stat-mini:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .report-stat-mini .rsm-lbl { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; }
        .report-stat-mini .rsm-val { font-size: 18px; font-weight: 900; margin-top: 3px; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }
        .due-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .due-badge.has-due { background: rgba(244,63,94,0.12); color: #f43f5e; }
        .due-badge.cleared { background: rgba(16,185,129,0.12); color: #10b981; }
        .payment-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px;
        }
        .payment-row:last-child { border-bottom: none; }
        .return-item-row {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 0; border-bottom: 1px solid var(--border);
        }
        .visit-card {
            border-left: 3px solid var(--primary);
            padding: 12px 14px; border-radius: 12px;
            background: var(--bg); margin-bottom: 10px;
            font-size: 13px;
        }
        .visit-card .vc-shop { font-weight: 700; font-size: 14px; color: var(--primary); }
        .visit-card .vc-meta { color: #64748b; font-size: 11px; margin-top: 3px; }
        .perf-card {
            border-radius: 14px; padding: 16px;
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.02));
            border: 1px solid rgba(99,102,241,0.15); margin-bottom: 12px;
        }
        .perf-rank { font-size: 22px; font-weight: 800; margin-right: 8px; }
        .perf-bar-wrap { background: var(--border); border-radius: 99px; height: 8px; margin-top: 8px; }
        .perf-bar { background: linear-gradient(90deg, var(--primary), #6366f1); border-radius: 99px; height: 8px; transition: width 0.6s ease; }
        .pnl-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px;
        }
        .pnl-row:last-child { border-bottom: none; }
        .pnl-total-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; font-size: 16px; font-weight: 800;
            border-top: 2px solid var(--primary); margin-top: 8px;
        }
        .item-disc-badge {
            background: rgba(245,158,11,0.15); color: var(--warning);
            font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px;
            border: 1px solid rgba(245,158,11,0.3);
        }
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
            box-shadow: 0 4px 15px rgba(37,211,102,0.3);
        }
        .btn-whatsapp:hover { box-shadow: 0 8px 20px rgba(37,211,102,0.4); }

        .due-shop-card {
            border-radius: 16px; padding: 18px; margin-bottom: 14px;
            border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); transition: box-shadow 0.3s;
        }
        .due-progress-wrap { background: var(--border); border-radius: 99px; height: 10px; margin: 10px 0 6px; overflow: hidden; }
        .due-progress-bar { height: 10px; border-radius: 99px; transition: width 0.6s ease; }
        .due-stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; padding: 6px 0; }
        .due-total-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 800; padding: 10px 0 0; border-top: 2px solid var(--border); margin-top: 6px; }

        .due-payment-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        .due-payment-table th { background: rgba(16,185,129,0.1); padding: 8px 10px; border-bottom: 2px solid rgba(16,185,129,0.3); color: #10b981; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .due-payment-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .due-payment-table tr:last-child td { border-bottom: none; }
        .due-payment-table tr:hover td { background: rgba(16,185,129,0.05); }

        .action-btn {
            border: none; background: none; cursor: pointer;
            padding: 3px 7px; border-radius: 6px;
            font-size: 12px; font-family: 'Poppins', sans-serif;
            font-weight: 600; transition: background 0.2s;
        }
        .action-btn-edit { color: var(--warning); border: 1px solid rgba(245,158,11,0.35); }
        .action-btn-edit:hover { background: rgba(245,158,11,0.12); }
        .action-btn-delete { color: var(--danger); border: 1px solid rgba(244,63,94,0.35); }
        .action-btn-delete:hover { background: rgba(244,63,94,0.12); }

        #due-pdf-zone, #returns-pdf-zone, #visits-pdf-zone { background: white; color: #1a1a2e; }

        .sidebar-bottom {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* ===== BOTTOM NAVIGATION BAR ===== */
        #bottomNav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-h);
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 200;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        .bn-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
            border: none;
            background: none;
            font-family: 'Poppins', sans-serif;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        .bn-item:active { background: var(--primary-light); }
        .bn-icon {
            width: 22px; height: 22px;
            line-height: 1;
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
            color: #94a3b8;
        }
        .bn-item.bn-active .bn-icon { color: var(--primary); }
        .bn-icon svg { width: 22px; height: 22px; transition: transform 0.2s; }
        .bn-item.bn-active .bn-icon svg { transform: translateY(-2px); }
        .bn-label {
            font-size: 9px;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            transition: color 0.2s;
        }
        /* bn-active icon handled in SVG rule above */
        .bn-item.bn-active .bn-label { color: var(--primary); }
        .bn-item.bn-active::before {
            content: '';
            position: absolute;
            top: 0; left: 20%; right: 20%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 0 0 4px 4px;
        }
        .bn-badge {
            position: absolute;
            top: 6px; right: calc(50% - 18px);
            background: var(--danger);
            color: white;
            font-size: 8px; font-weight: 800;
            padding: 1px 5px;
            border-radius: 99px;
            min-width: 16px;
            text-align: center;
            border: 2px solid var(--card);
        }

        @media print {
            body * { visibility: hidden; background: white !important; }
            #a5-print-zone, #a5-print-zone * { visibility: visible; }
            #a5-print-zone {
                position: absolute; left: 0; top: 0;
                width: 100%; margin: 0; padding: 0;
                box-shadow: none; border: none;
                border-radius: 0;
            }
            .bill-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bill-table thead tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bill-table tbody tr:nth-child(even) td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        /* ===== ADMIN PANEL DRAG & DROP ===== */
        .admin-panel-area { display: flex; flex-direction: column; }
        .collapse-card.admin-draggable { position: relative; transition: box-shadow 0.2s, transform 0.15s; }
        body.admin-edit-mode .collapse-card.admin-draggable { cursor: grab; }
        body.admin-edit-mode .collapse-card.admin-draggable:active { cursor: grabbing; }
        .collapse-card.admin-draggable.admin-dragging { opacity: 0.45; transform: scale(0.98); border: 2px dashed var(--primary) !important; background: var(--primary-light) !important; box-shadow: none; }
        .collapse-card.admin-draggable.admin-drag-over { border-top: 3px solid var(--primary) !important; box-shadow: 0 -4px 0 var(--primary) !important; transform: translateY(2px); }
        .admin-drag-handle {
            display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 8px; cursor: grab;
            color: #94a3b8; background: var(--bg); border: 1.5px solid var(--border);
            flex-shrink: 0; transition: color 0.2s, background 0.2s, border-color 0.2s;
            margin-right: 4px;
        }
        .admin-drag-handle:hover { color: var(--primary); background: var(--primary-light); border-color: var(--primary); }
        .admin-drag-handle:active { cursor: grabbing; }
        .admin-panel-edit-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.04));
            border: 1.5px solid rgba(99,102,241,0.2); border-radius: 14px;
            padding: 10px 14px; margin-bottom: 12px;
            font-size: 12px; font-weight: 600; color: var(--text);
            display: none;
        }
        .admin-panel-edit-bar.visible { display: flex; }
        .admin-panel-edit-bar .edit-hint { display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; }
        
        /* ===== QUOTATION BUILDER ===== */
        .qt-theme-btn.active-theme { border-color: #4f46e5 !important; box-shadow: 0 0 0 3px rgba(79,70,229,0.25) !important; }
        .qt-item-row { display:flex; gap:6px; align-items:center; margin-bottom:8px; background:var(--bg); border-radius:10px; padding:8px 10px; border:1px solid var(--border); }
        .qt-item-row input { margin-bottom:0 !important; padding:8px 10px !important; font-size:12px !important; }
        .qt-item-name  { flex:2; }
        .qt-item-qty   { flex:0 0 56px; }
        .qt-item-rate  { flex:0 0 76px; }
        .qt-item-del   { flex:0 0 32px; height:36px; border:none; background:rgba(244,63,94,0.1); color:#f43f5e; border-radius:8px; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background 0.2s; }
        .qt-item-del:hover { background:rgba(244,63,94,0.2); }
        @keyframes qtPulse {
            0%,100% { transform: scale(1); box-shadow: 0 2px 6px rgba(239,68,68,0.5); }
            50%      { transform: scale(1.18); box-shadow: 0 3px 10px rgba(239,68,68,0.7); }
        }
        .qt-tracker-item { background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:13px 14px; margin-bottom:10px; transition:box-shadow 0.2s; }
        .qt-tracker-item:hover { box-shadow: var(--shadow-md); }
        .qt-status-badge { display:inline-block; border-radius:99px; padding:3px 10px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; }
        .qt-status-pending  { background:rgba(245,158,11,0.15); color:#b45309; }
        .qt-status-sent     { background:rgba(16,185,129,0.15); color:#065f46; }
        .qt-status-accepted { background:rgba(99,102,241,0.15); color:#4338ca; }
        .qt-status-rejected { background:rgba(244,63,94,0.12); color:#be123c; }
        .qt-doc { max-width:540px; margin:0 auto; font-family:'Arial',sans-serif; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
        .qt-doc-header { padding:10px 18px 9px; }
        .qt-doc-title  { font-size:17px; font-weight:900; letter-spacing:2.5px; text-transform:uppercase; margin:0 0 1px; }
        .qt-doc-sub    { font-size:9px; letter-spacing:1.5px; opacity:0.7; }
        .qt-doc-body   { background:#fff; }
        .qt-doc-strip  { display:flex; justify-content:space-between; padding:7px 16px; border-bottom:1px solid #e2e8f0; font-size:10.5px; gap:10px; }
        .qt-doc-table  { width:100%; border-collapse:collapse; font-size:11px; }
        .qt-doc-table thead tr { background:#f1f5f9; }
        .qt-doc-table th { padding:7px 9px; font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:0.8px; white-space:nowrap; border:1px solid #cbd5e1; color:#1a1a2e; }
        .qt-doc-table td { padding:7px 9px; border:1px solid #e2e8f0; color:#1a1a2e; vertical-align:middle; }
        .qt-doc-table tbody tr:nth-child(even) td { background:#f8faff; }
        .qt-totals { padding:8px 14px 10px; border-top:2px solid #1a1a2e; background:#fff; }
        .qt-totals-row { display:flex; justify-content:flex-end; align-items:center; gap:16px; padding:2px 0; font-size:11px; }
        .qt-grand-row  { display:flex; justify-content:space-between; align-items:center; margin-top:6px; padding-top:6px; border-top:1.5px dashed #c7d2e0; }
        .qt-footer { background:#f8faff; border-top:1px solid #e2e8f0; padding:7px 16px; text-align:center; font-size:9px; color:#94a3b8; }
        .qt-footer .qt-footer-title { font-size:10px; font-weight:700; color:#2d3561; margin-bottom:2px; letter-spacing:1px; }
        .qt-sign-row { display:flex; justify-content:space-between; padding:10px 16px 8px; font-size:9.5px; color:#64748b; }
        .qt-sign-box  { text-align:center; min-width:90px; }
        .qt-sign-box .sign-line { border-top:1px solid #c7d2e0; padding-top:3px; margin-top:20px; }

        /* ===== NOTIFICATION SYSTEM ===== */
        .notif-bell-btn {
            position: relative;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 10px;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: white;
            transition: background 0.2s, transform 0.2s;
            flex-shrink: 0;
        }
        .notif-bell-btn:hover { background: rgba(255,255,255,0.28); }
        .notif-bell-btn:active { transform: scale(0.92); }
        .notif-badge {
            position: absolute;
            top: -4px; right: -4px;
            background: #f43f5e;
            color: white;
            font-size: 9px; font-weight: 800;
            min-width: 17px; height: 17px;
            border-radius: 99px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid transparent;
            line-height: 1;
            padding: 0 3px;
            animation: notifPop 0.35s cubic-bezier(0.34,1.56,0.64,1);
            pointer-events: none;
        }
        .notif-badge.hidden { display: none; }
        @keyframes notifPop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes bellShake {
            0%,100% { transform: rotate(0deg); }
            15% { transform: rotate(18deg); }
            30% { transform: rotate(-14deg); }
            45% { transform: rotate(10deg); }
            60% { transform: rotate(-6deg); }
            75% { transform: rotate(3deg); }
        }
        .notif-bell-btn.shake svg { animation: bellShake 0.6s ease; }

        /* Panel backdrop */
        .notif-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(3px);
            z-index: 1099;
            display: none; opacity: 0;
            transition: opacity 0.25s;
        }
        .notif-backdrop.open { display: block; opacity: 1; }

        /* Notification panel */
        .notif-panel {
            position: fixed;
            top: 0; right: -380px;
            width: 360px; max-width: 96vw;
            height: 100dvh;
            background: var(--card);
            box-shadow: -8px 0 40px rgba(0,0,0,0.18);
            z-index: 1100;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--border);
            transition: right 0.32s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
        }
        .notif-panel.open { right: 0; }

        .notif-panel-head {
            background: linear-gradient(135deg, #3730a3, #4f46e5, #6366f1);
            padding: 16px 18px 14px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        body.dark-mode .notif-panel-head {
            background: linear-gradient(135deg, #1e1b4b, #312e81, #3730a3);
        }
        .notif-panel-title {
            font-size: 15px; font-weight: 800; color: white;
            display: flex; align-items: center; gap: 8px;
        }
        .notif-panel-count {
            background: rgba(255,255,255,0.2);
            font-size: 11px; padding: 2px 8px;
            border-radius: 20px; font-weight: 700;
            color: white;
        }
        .notif-close-btn {
            background: rgba(255,255,255,0.15); border: none;
            border-radius: 8px; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-size: 16px;
            transition: background 0.2s;
        }
        .notif-close-btn:hover { background: rgba(255,255,255,0.3); }

        /* Filter tabs */
        .notif-filters {
            display: flex; gap: 6px; padding: 12px 14px 8px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto; scrollbar-width: none; flex-shrink: 0;
            background: var(--card);
        }
        .notif-filters::-webkit-scrollbar { display: none; }
        .notif-filter-tab {
            padding: 5px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
            border: 1.5px solid var(--border);
            background: var(--bg); color: var(--text-muted);
            cursor: pointer; white-space: nowrap;
            transition: all 0.2s; flex-shrink: 0;
        }
        .notif-filter-tab.active {
            background: var(--primary); color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 10px rgba(79,70,229,0.35);
        }

        /* Mark all read row */
        .notif-actions-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 16px; border-bottom: 1px solid var(--border);
            flex-shrink: 0; background: var(--card);
        }
        .notif-mark-all {
            font-size: 11px; font-weight: 700; color: var(--primary);
            cursor: pointer; padding: 4px 8px; border-radius: 6px;
            transition: background 0.2s;
        }
        .notif-mark-all:hover { background: var(--primary-light); }
        .notif-clear-all {
            font-size: 11px; color: var(--text-muted); cursor: pointer;
            padding: 4px 8px; border-radius: 6px; transition: background 0.2s;
        }
        .notif-clear-all:hover { background: rgba(244,63,94,0.08); color: #f43f5e; }

        /* Scroll area */
        .notif-list {
            flex: 1; overflow-y: auto; padding: 10px 12px 16px;
            scroll-behavior: smooth;
        }
        .notif-list::-webkit-scrollbar { width: 4px; }
        .notif-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* Date group header */
        .notif-date-label {
            font-size: 10px; font-weight: 800; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.8px;
            padding: 10px 4px 5px; display: flex; align-items: center; gap: 8px;
        }
        .notif-date-label::after {
            content: ''; flex: 1; height: 1px; background: var(--border);
        }

        /* Notification item */
        .notif-item {
            display: flex; gap: 11px; align-items: flex-start;
            padding: 11px 10px; border-radius: 12px; margin-bottom: 6px;
            background: var(--bg); border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s; position: relative;
            animation: notifSlideIn 0.25s ease;
        }
        @keyframes notifSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .notif-item:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.1); transform: translateY(-1px); border-color: var(--primary); }
        .notif-item.unread {
            background: var(--card);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(79,70,229,0.1);
        }
        .notif-item.unread::before {
            content: '';
            position: absolute; top: 12px; right: 10px;
            width: 7px; height: 7px;
            background: var(--primary); border-radius: 50%;
        }
        .notif-icon-wrap {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; flex-shrink: 0;
        }
        /* Type colors */
        .notif-icon-wrap.delivery  { background: rgba(245,158,11,0.15); }
        .notif-icon-wrap.payment   { background: rgba(16,185,129,0.15); }
        .notif-icon-wrap.quotation { background: rgba(99,102,241,0.15); }
        .notif-icon-wrap.order     { background: rgba(6,182,212,0.15); }
        .notif-icon-wrap.stock     { background: rgba(244,63,94,0.12); }
        .notif-icon-wrap.system    { background: rgba(100,116,139,0.12); }
        .notif-icon-wrap.due       { background: rgba(239,68,68,0.12); }

        .notif-content { flex: 1; min-width: 0; }
        .notif-title { font-size: 12.5px; font-weight: 700; color: var(--text); line-height: 1.3; margin-bottom: 2px; }
        .notif-body  { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
        .notif-time  { font-size: 9.5px; color: #94a3b8; margin-top: 4px; font-weight: 600; }
        .notif-tag   {
            display: inline-block; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 1px 7px; border-radius: 20px; margin-top: 5px;
        }
        .tag-delivery  { background: rgba(245,158,11,0.15); color: #b45309; }
        .tag-payment   { background: rgba(16,185,129,0.15); color: #065f46; }
        .tag-quotation { background: rgba(99,102,241,0.15); color: #4338ca; }
        .tag-order     { background: rgba(6,182,212,0.15); color: #0e7490; }
        .tag-stock     { background: rgba(244,63,94,0.12); color: #be123c; }
        .tag-system    { background: rgba(100,116,139,0.12); color: #475569; }
        .tag-due       { background: rgba(239,68,68,0.12); color: #b91c1c; }

        .notif-empty {
            text-align: center; padding: 48px 20px;
            color: var(--text-muted);
        }
        .notif-empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .notif-empty-text { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
        .notif-empty-sub  { font-size: 12px; opacity: 0.7; }

        /* Mini toast for new notif */
        .notif-toast {
            position: fixed;
            top: 70px; right: 16px;
            background: var(--card);
            border: 1.5px solid var(--border);
            border-radius: 14px;
            padding: 10px 14px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            z-index: 1200;
            max-width: 300px;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
            border-left: 3px solid var(--primary);
        }
        .notif-toast.show { transform: translateX(0); }
        .notif-toast-icon { font-size: 22px; flex-shrink: 0; }
        .notif-toast-text { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.4; }

        /* ===== SETTINGS BUTTON ===== */
        .settings-btn {
            background: rgba(255,255,255,0.15);
            border: none; border-radius: 10px;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white;
            transition: background 0.2s, transform 0.3s;
            position: relative;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.25); }
        .settings-btn.active svg { animation: spinSlow 2s linear infinite; }
        @keyframes spinSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ===== SETTINGS PANEL ===== */
        .settings-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1050; display: none;
            backdrop-filter: blur(3px);
        }
        .settings-backdrop.active { display: block; }
        .settings-panel {
            position: fixed;
            top: calc(var(--header-h) + 8px);
            right: 12px;
            width: 300px;
            max-height: calc(100vh - var(--header-h) - 80px);
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.22), 0 0 0 1px var(--border);
            z-index: 1060;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(-10px) scale(0.97);
            opacity: 0;
            transition: transform 0.28s cubic-bezier(0.34,1.56,0.64,1), opacity 0.22s ease;
        }
        .settings-panel.active {
            display: flex;
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .settings-panel-head {
            background: linear-gradient(135deg, #3730a3, #4f46e5);
            padding: 14px 16px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .settings-panel-title { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; }
        .settings-close-btn {
            background: rgba(255,255,255,0.15); border: none;
            border-radius: 8px; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-size: 14px;
            transition: background 0.2s;
        }
        .settings-close-btn:hover { background: rgba(255,255,255,0.3); }
        .settings-body { overflow-y: auto; padding: 14px; flex: 1; }
        .settings-body::-webkit-scrollbar { width: 4px; }
        .settings-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .settings-section-label {
            font-size: 10px; font-weight: 800; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.8px;
            margin-bottom: 8px; margin-top: 14px;
        }
        .settings-section-label:first-child { margin-top: 0; }

        /* Theme toggle row */
        .settings-theme-row {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); border: 1.5px solid var(--border);
            border-radius: 14px; padding: 12px 14px;
            margin-bottom: 4px;
        }
        .settings-theme-left { display: flex; align-items: center; gap: 10px; }
        .settings-theme-icon { font-size: 20px; width: 36px; height: 36px; background: var(--primary-light); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .settings-theme-label { font-size: 13px; font-weight: 700; color: var(--text); }
        .settings-theme-sub { font-size: 10px; color: var(--text-muted); }
        /* iOS-style toggle */
        .ios-toggle { position: relative; width: 44px; height: 26px; flex-shrink: 0; }
        .ios-toggle input { opacity: 0; width: 0; height: 0; }
        .ios-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: #d1d5db; border-radius: 26px;
            transition: background 0.3s;
        }
        .ios-slider::before {
            content: ''; position: absolute;
            width: 20px; height: 20px; left: 3px; bottom: 3px;
            background: white; border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input:checked + .ios-slider { background: var(--primary); }
        input:checked + .ios-slider::before { transform: translateX(18px); }

        /* BG presets grid */
        .bg-presets-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .bg-preset-btn {
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.2s;
            aspect-ratio: 1;
            position: relative;
        }
        .bg-preset-btn:hover { transform: scale(1.06); border-color: var(--primary); }
        .bg-preset-btn.active-bg { border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(79,70,229,0.3) !important; }
        .bg-preset-btn .bp-preview {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .bg-preset-btn .bp-check {
            position: absolute; top: 2px; right: 2px;
            background: var(--primary); color: white;
            width: 14px; height: 14px; border-radius: 50%;
            font-size: 8px; display: none;
            align-items: center; justify-content: center;
        }
        .bg-preset-btn.active-bg .bp-check { display: flex; }

        /* Accent color row */
        .accent-colors-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
        .accent-dot {
            width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; border: 2.5px solid transparent;
            transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .accent-dot:hover { transform: scale(1.18); }
        .accent-dot.active-accent { border-color: var(--text) !important; transform: scale(1.1); }

        /* ===== LOGIN SCREEN ANIMATIONS ===== */
        @keyframes cartBounce {
            0%   { transform: translateY(0) rotate(0deg); }
            20%  { transform: translateY(-14px) rotate(-8deg); }
            40%  { transform: translateY(0px) rotate(5deg); }
            55%  { transform: translateY(-6px) rotate(-3deg); }
            70%  { transform: translateY(0px) rotate(2deg); }
            85%  { transform: translateY(-3px) rotate(0deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        @keyframes cartGlow {
            0%, 100% { box-shadow: 0 8px 24px rgba(79,70,229,0.35); }
            50%       { box-shadow: 0 12px 36px rgba(99,102,241,0.6), 0 0 0 6px rgba(79,70,229,0.12); }
        }
        @keyframes brandReveal {
            0%   { opacity: 0; letter-spacing: 8px; transform: translateY(8px); }
            100% { opacity: 1; letter-spacing: 0px; transform: translateY(0); }
        }
        @keyframes subReveal {
            0%   { opacity: 0; transform: translateY(6px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes cardEntrance {
            0%   { opacity: 0; transform: translateY(24px) scale(0.96); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes floatOrb1 {
            0%, 100% { transform: translate(0,0) scale(1); }
            33%       { transform: translate(20px,-15px) scale(1.08); }
            66%       { transform: translate(-10px, 10px) scale(0.95); }
        }
        @keyframes floatOrb2 {
            0%, 100% { transform: translate(0,0) scale(1); }
            40%       { transform: translate(-18px, 12px) scale(1.05); }
            70%       { transform: translate(12px, -8px) scale(0.98); }
        }
        @keyframes shimmer {
            0%   { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes particleFloat {
            0%   { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0.6; }
            50%  { transform: translateY(-20px) translateX(10px) rotate(180deg); opacity: 0.9; }
            100% { transform: translateY(0) translateX(0) rotate(360deg); opacity: 0.6; }
        }
        .auth-login-card-animated {
            animation: cardEntrance 0.65s cubic-bezier(0.34,1.2,0.64,1) forwards;
        }
        .auth-cart-icon-wrap {
            animation: cartBounce 2.4s ease-in-out infinite 0.8s, cartGlow 2.4s ease-in-out infinite 0.8s;
        }
        .auth-brand-animated {
            animation: brandReveal 0.7s ease forwards 0.3s;
            opacity: 0;
        }
        .auth-brand-sub-animated {
            animation: subReveal 0.5s ease forwards 0.6s;
            opacity: 0;
        }
        .auth-orb-1 {
            position: absolute; top: -120px; right: -100px;
            width: 380px; height: 380px;
            background: radial-gradient(circle, rgba(99,102,241,0.18) 0%, transparent 65%);
            border-radius: 50%; pointer-events: none;
            animation: floatOrb1 8s ease-in-out infinite;
        }
        .auth-orb-2 {
            position: absolute; bottom: -80px; left: -80px;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(16,185,129,0.14) 0%, transparent 65%);
            border-radius: 50%; pointer-events: none;
            animation: floatOrb2 10s ease-in-out infinite 2s;
        }
        .auth-orb-3 {
            position: absolute; top: 40%; left: 10%;
            width: 180px; height: 180px;
            background: radial-gradient(circle, rgba(6,182,212,0.1) 0%, transparent 65%);
            border-radius: 50%; pointer-events: none;
            animation: floatOrb1 12s ease-in-out infinite 1s;
        }
        .auth-particle {
            position: absolute; width: 6px; height: 6px;
            border-radius: 50%; pointer-events: none;
            opacity: 0;
        }
        .auth-particle-1 { top: 15%; left: 10%; background: rgba(99,102,241,0.5); animation: particleFloat 4s ease-in-out infinite 0s; }
        .auth-particle-2 { top: 25%; right: 15%; background: rgba(16,185,129,0.5); animation: particleFloat 5s ease-in-out infinite 0.8s; width:8px; height:8px; }
        .auth-particle-3 { bottom: 30%; left: 20%; background: rgba(6,182,212,0.5); animation: particleFloat 4.5s ease-in-out infinite 1.5s; }
        .auth-particle-4 { bottom: 20%; right: 12%; background: rgba(139,92,246,0.5); animation: particleFloat 6s ease-in-out infinite 0.4s; width:5px; height:5px; }
        .auth-particle-5 { top: 50%; left: 5%; background: rgba(245,158,11,0.4); animation: particleFloat 3.5s ease-in-out infinite 2s; width:4px; height:4px; }
        .auth-particle-6 { top: 70%; right: 8%; background: rgba(244,63,94,0.4); animation: particleFloat 5.5s ease-in-out infinite 1s; width:7px; height:7px; }
        .auth-shimmer-badge {
            display: inline-block;
            background: linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2.5s ease-in-out infinite;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ===== UNDO SNACKBAR ===== -->
    <div id="undo-bar">
        <div class="undo-icon">ðŸ—‘ï¸</div>
        <span class="undo-msg" id="undo-msg"><span class="undo-label">Deleted</span>Item removed</span>
        <div class="undo-timer-ring">
            <svg width="28" height="28" viewBox="0 0 28 28">
                <circle cx="14" cy="14" r="11.5"/>
                <circle class="ring-progress" id="undo-ring" cx="14" cy="14" r="11.5" stroke-dasharray="72" stroke-dashoffset="0"/>
            </svg>
        </div>
        <button class="undo-btn" onclick="executeUndo()">â†© Undo</button>
        <button class="undo-dismiss" onclick="dismissUndo()">âœ•</button>
    </div>

    <!-- ===== AUTH SCREEN ===== -->
    <div id="auth-screen">
        <!-- Animated background orbs -->
        <div class="auth-orb-1"></div>
        <div class="auth-orb-2"></div>
        <div class="auth-orb-3"></div>
        <!-- Floating particles -->
        <div class="auth-particle auth-particle-1"></div>
        <div class="auth-particle auth-particle-2"></div>
        <div class="auth-particle auth-particle-3"></div>
        <div class="auth-particle auth-particle-4"></div>
        <div class="auth-particle auth-particle-5"></div>
        <div class="auth-particle auth-particle-6"></div>

        <!-- Theme Toggle -->
        <button id="authThemeToggle" onclick="toggleAuthTheme()" title="Toggle theme" style="
            position: absolute; top: 18px; right: 18px; z-index: 10;
            background: var(--auth-card-bg); border: 1.5px solid var(--auth-card-border);
            border-radius: 50px; padding: 8px 16px; cursor: pointer;
            font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600;
            color: var(--auth-title-color); display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 12px rgba(79,70,229,0.12); transition: all 0.3s ease;
        ">
            <span id="authThemeIcon">ðŸŒ™</span>
            <span id="authThemeLabel">Dark</span>
        </button>

        <div id="login-box" class="card auth-login-card-animated" style="width:100%; max-width:380px; text-align:center; padding:32px 28px;">
            <!-- Animated cart icon -->
            <div class="auth-cart-icon-wrap" style="width:64px;height:64px;background:linear-gradient(135deg,#4f46e5,#6366f1);border-radius:18px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;box-shadow:0 8px 24px rgba(79,70,229,0.35);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            </div>
            <div class="auth-brand auth-brand-animated">Order With Me</div>
            <div class="auth-brand-sub auth-brand-sub-animated" style="display:flex;align-items:center;justify-content:center;gap:6px;">
                <span class="auth-shimmer-badge" style="background:linear-gradient(90deg,rgba(79,70,229,0.0),rgba(79,70,229,0.15),rgba(79,70,229,0.0));background-size:200%;animation:shimmer 2.5s ease-in-out infinite;padding:2px 10px;border-radius:20px;border:1px solid rgba(79,70,229,0.15);">Business ERP</span>
                <span>â€” Sign in to continue</span>
            </div>
            <input type="text" id="loginUsername" class="input-field" placeholder="Username" onkeydown="if(event.key==='Enter') loginUser()">
            <input type="password" id="loginPassword" class="input-field" placeholder="Password" onkeydown="if(event.key==='Enter') loginUser()">
            <button class="btn btn-success" onclick="loginUser()" id="btnLogin">Login</button>
            <p class="auth-link-text">No account? <span class="auth-link-highlight" onclick="toggleAuthView('reg')">Register here</span></p>
        </div>
        <div id="reg-box" class="card" style="width:100%; max-width:380px; display:none; padding:28px;">
            <div style="font-size:20px; font-weight:800; text-align:center; margin-bottom:18px;" class="auth-title-text">Create Account</div>
            <input type="text" id="regName" class="input-field" placeholder="Full Name">
            <input type="text" id="regUser" class="input-field" placeholder="Unique Username">
            <input type="password" id="regPass" class="input-field" placeholder="Password (min 6 chars)">
            <select id="regRole" class="input-field">
                <option value="salesman">Salesman</option>
                <option value="manager">Manager</option>
            </select>
            <input type="password" id="pinBox" class="input-field" placeholder="Registration Password">
            <button class="btn" onclick="registerUser()" id="btnReg">Create Account</button>
            <p class="auth-link-text" style="text-align:center;">Have account? <span class="auth-link-highlight" onclick="toggleAuthView('login')">Login here</span></p>
        </div>

        <!-- Credit -->
        <div style="
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            text-align: center; z-index: 2; white-space: nowrap;
        ">
            <span style="
                font-family: 'Poppins', sans-serif;
                font-size: 13px;
                font-weight: 600;
                background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                opacity: 0.75;
                letter-spacing: 0.5px;
            ">Made With <span style="display:inline-block; animation: heartBeat 1.2s ease-in-out infinite; -webkit-text-fill-color: #f43f5e;">â¤ï¸</span> By Aditya</span>
        </div>
    </div>

    <div id="app-screen">
        <!-- OFFLINE STATUS BAR -->
        <div id="offlineBar" style="display:none; position:fixed; top:0; left:0; right:0; z-index:10000; background:linear-gradient(135deg,#f59e0b,#d97706); color:white; text-align:center; padding:8px 16px; font-size:13px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            ðŸ“µ Offline â€” Orders will be saved locally and synced when back online
            <span id="offlinePendingCount" style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; margin-left:8px; font-size:12px;"></span>
        </div>

        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

        <!-- ===== SIDEBAR ===== -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <div id="sideAvatar" onclick="openProfilePicModal()" title="Change profile picture" style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#8b5cf6);color:white;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0;cursor:pointer;position:relative;overflow:hidden;transition:all 0.2s;" onmouseover="document.getElementById('avatarOverlay').style.opacity='1'" onmouseout="document.getElementById('avatarOverlay').style.opacity='0'">U
                        <div id="avatarOverlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;font-size:14px;border-radius:50%;opacity:0;transition:opacity 0.2s;">ðŸ“·</div>
                    </div>
                    <input type="file" id="profilePicInput" accept="image/*" style="display:none;" onchange="handleProfilePicChange(event)">
                    <div style="flex:1;min-width:0;">
                        <h3 id="sideName" style="margin:0;font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">User</h3>
                        <p id="sideRole" style="font-size:10px;color:white;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:3px 0 0;background:var(--primary);display:inline-block;padding:2px 9px;border-radius:20px;">Role</p>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                        <button onclick="logoutApp()" style="padding:4px 11px;border:none;border-radius:20px;background:linear-gradient(135deg,#f43f5e,#e11d48);color:white;font-weight:700;font-size:11px;cursor:pointer;font-family:'Poppins',sans-serif;box-shadow:0 2px 8px rgba(244,63,94,0.3);">Logout</button>
                        <span style="font-size:10px;font-weight:700;color:var(--primary);background:var(--primary-light);padding:2px 8px;border-radius:20px;border:1px solid rgba(99,102,241,0.2);">V2.5.3</span>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="sidebar-edit-btn" id="menuEditBtn" onclick="toggleMenuEditMode()">âœï¸ Edit Menu</button>
                </div>
                <div id="menuEditHint" style="display:none; font-size:11px; color:#64748b; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:8px; padding:6px 10px; margin-top:6px;">
                    ðŸ–±ï¸ Drag items to reorder. Click âœ… Done when finished.
                </div>
            </div>

            <div class="sidebar-nav-area" id="sidebarNavArea">
                <!-- Menu items rendered dynamically -->
            </div>

            <div class="sidebar-bottom">
                <button onclick="toggleThemeManually()" id="themeToggleBtn"
                    style="width:100%; padding:8px 6px; border:1.5px solid var(--border); border-radius:10px;
                           background:var(--bg); color:var(--text); font-weight:700; font-size:11px;
                           cursor:pointer; font-family:'Poppins',sans-serif; letter-spacing:0.3px;
                           transition:background 0.2s, transform 0.15s;"
                    onmouseover="this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.transform=''">
                    ðŸŒ™ Dark
                </button>
                <input type="checkbox" id="themeToggleCheckbox" onchange="toggleThemeManually()" style="display:none;">
                <div style="text-align:center; font-size:12px; font-weight:600; color:#64748b; margin-top:12px;">Made With â¤ï¸ By Aditya</div>
            </div>
        </div>

        <div class="header no-print">
            <div style="display:flex; align-items:center; gap:14px;">
                <button onclick="toggleMenu()" style="background:rgba(255,255,255,0.15); border:none; border-radius:10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:white; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </button>
                <h3 id="pageTitle" style="margin:0; font-size:15px; font-weight:700; letter-spacing:0.5px; color:white;">DASHBOARD</h3>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="realTimeClock" style="text-align:right; line-height:1.3;"></div>
                <!-- Notification Bell -->
                <button class="notif-bell-btn" id="notifBellBtn" onclick="toggleNotifPanel()" title="Notifications">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span class="notif-badge hidden" id="notifBadge">0</span>
                </button>
                <!-- Settings Button -->
                <button class="settings-btn" id="settingsBtnHeader" onclick="toggleSettingsPanel()" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- ===== NOTIFICATION PANEL ===== -->
        <div class="notif-backdrop" id="notifBackdrop" onclick="closeNotifPanel()"></div>
        <div class="notif-panel" id="notifPanel">
            <!-- Header -->
            <div class="notif-panel-head">
                <div class="notif-panel-title">
                    <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    Notifications
                    <span class="notif-panel-count" id="notifPanelCount">0</span>
                </div>
                <button class="notif-close-btn" onclick="closeNotifPanel()">âœ•</button>
            </div>
            <!-- Filter tabs -->
            <div class="notif-filters" id="notifFilters">
                <div class="notif-filter-tab active" onclick="filterNotifs('all',this)">All</div>
                <div class="notif-filter-tab" onclick="filterNotifs('order',this)">ðŸ“¦ Orders</div>
                <div class="notif-filter-tab" onclick="filterNotifs('delivery',this)">ðŸšš Delivery</div>
                <div class="notif-filter-tab" onclick="filterNotifs('payment',this)">ðŸ’° Payments</div>
                <div class="notif-filter-tab" onclick="filterNotifs('quotation',this)">ðŸ“‹ Quotation</div>
                <div class="notif-filter-tab" onclick="filterNotifs('stock',this)">ðŸ“¦ Stock</div>
                <div class="notif-filter-tab" onclick="filterNotifs('due',this)">âš ï¸ Due</div>
            </div>
            <!-- Actions row -->
            <div class="notif-actions-row">
                <span class="notif-mark-all" onclick="markAllNotifsRead()">âœ“ Mark all read</span>
                <span class="notif-clear-all" onclick="clearAllNotifs()">ðŸ—‘ Clear all</span>
            </div>
            <!-- List -->
            <div class="notif-list" id="notifList">
                <div class="notif-empty">
                    <div class="notif-empty-icon">ðŸ””</div>
                    <div class="notif-empty-text">No notifications yet</div>
                    <div class="notif-empty-sub">Activity updates will appear here</div>
                </div>
            </div>
        </div>

        <!-- Notification mini toast -->
        <div class="notif-toast" id="notifToast">
            <span class="notif-toast-icon" id="notifToastIcon">ðŸ””</span>
            <span class="notif-toast-text" id="notifToastText"></span>
        </div>

        <!-- ===== SETTINGS PANEL ===== -->
        <div class="settings-backdrop" id="settingsBackdrop" onclick="closeSettingsPanel()"></div>
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-panel-head">
                <div class="settings-panel-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Settings
                </div>
                <button class="settings-close-btn" onclick="closeSettingsPanel()">âœ•</button>
            </div>
            <div class="settings-body">

                <!-- Theme Toggle -->
                <div class="settings-section-label">ðŸŒ— Appearance</div>
                <div class="settings-theme-row">
                    <div class="settings-theme-left">
                        <div class="settings-theme-icon" id="settingsThemeIcon">ðŸŒ™</div>
                        <div>
                            <div class="settings-theme-label" id="settingsThemeLabel">Dark Mode</div>
                            <div class="settings-theme-sub">Switch to dark theme</div>
                        </div>
                    </div>
                    <label class="ios-toggle">
                        <input type="checkbox" id="settingsDarkToggle" onchange="settingsToggleTheme(this)">
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <!-- Accent Colors -->
                <div class="settings-section-label">ðŸŽ¨ Accent Color</div>
                <div class="accent-colors-row" id="accentColorRow">
                    <div class="accent-dot active-accent" style="background:linear-gradient(135deg,#4f46e5,#6366f1);" onclick="setAccentColor(this,'#4f46e5','#6366f1')" title="Indigo"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);" onclick="setAccentColor(this,'#7c3aed','#8b5cf6')" title="Violet"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);" onclick="setAccentColor(this,'#0ea5e9','#38bdf8')" title="Sky"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#10b981,#34d399);" onclick="setAccentColor(this,'#10b981','#34d399')" title="Emerald"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);" onclick="setAccentColor(this,'#f59e0b','#fbbf24')" title="Amber"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#f43f5e,#fb7185);" onclick="setAccentColor(this,'#f43f5e','#fb7185')" title="Rose"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#ec4899,#f472b6);" onclick="setAccentColor(this,'#ec4899','#f472b6')" title="Pink"></div>
                    <div class="accent-dot" style="background:linear-gradient(135deg,#64748b,#94a3b8);" onclick="setAccentColor(this,'#64748b','#94a3b8')" title="Slate"></div>
                </div>

                <!-- Background Presets -->
                <div class="settings-section-label">ðŸ–¼ï¸ Background Style</div>
                <div class="bg-presets-grid" id="bgPresetsGrid">
                    <div class="bg-preset-btn active-bg" data-bg="default" onclick="setBgPreset(this,'default')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#e8ecf8,#eef0fb,#f0f4ff);">Default</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="midnight" onclick="setBgPreset(this,'midnight')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#0a0a1a,#1a1a3e,#0a0a1a);">Night</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="aurora" onclick="setBgPreset(this,'aurora')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#064e3b,#0c4a6e,#3b0764);">Aurora</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="sunset" onclick="setBgPreset(this,'sunset')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#7c2d12,#ea580c,#fbbf24);">Sunset</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="ocean" onclick="setBgPreset(this,'ocean')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#0c4a6e,#0369a1,#38bdf8);">Ocean</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="rose" onclick="setBgPreset(this,'rose')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#4c0519,#be123c,#fb7185);">Rose</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="forest" onclick="setBgPreset(this,'forest')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#052e16,#166534,#4ade80);">Forest</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="galaxy" onclick="setBgPreset(this,'galaxy')">
                        <div class="bp-preview" style="background:radial-gradient(ellipse at 30% 60%,#3b0764,#0f172a,#1e1b4b);">Galaxy</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="cotton" onclick="setBgPreset(this,'cotton')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#fdf2f8,#fbcfe8,#fce7f3);">Cotton</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="lemon" onclick="setBgPreset(this,'lemon')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#fefce8,#fef08a,#fde047);">Lemon</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="mesh" onclick="setBgPreset(this,'mesh')">
                        <div class="bp-preview" style="background:conic-gradient(from 90deg at 40% 50%,#4f46e5,#0ea5e9,#10b981,#4f46e5);">Mesh</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                    <div class="bg-preset-btn" data-bg="charcoal" onclick="setBgPreset(this,'charcoal')">
                        <div class="bp-preview" style="background:linear-gradient(135deg,#111827,#1f2937,#374151);">Carbon</div>
                        <div class="bp-check">âœ“</div>
                    </div>
                </div>

                <!-- Animated BG toggle -->
                <div class="settings-theme-row" style="margin-top:10px;">
                    <div class="settings-theme-left">
                        <div class="settings-theme-icon">âœ¨</div>
                        <div>
                            <div class="settings-theme-label">Animated BG</div>
                            <div class="settings-theme-sub">Subtle moving gradients</div>
                        </div>
                    </div>
                    <label class="ios-toggle">
                        <input type="checkbox" id="settingsAnimBg" onchange="toggleAnimatedBg(this)" checked>
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <!-- Font Size -->
                <div class="settings-section-label">ðŸ”¤ Interface Scale</div>
                <div style="display:flex; gap:6px; margin-bottom:4px;">
                    <button onclick="setUiScale('small')" id="scaleSmall" style="flex:1;padding:8px 4px;border:1.5px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);font-weight:700;font-size:11px;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.2s;">A-</button>
                    <button onclick="setUiScale('normal')" id="scaleNormal" style="flex:1;padding:8px 4px;border:1.5px solid var(--primary);border-radius:10px;background:var(--primary-light);color:var(--primary);font-weight:700;font-size:13px;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.2s;">A</button>
                    <button onclick="setUiScale('large')" id="scaleLarge" style="flex:1;padding:8px 4px;border:1.5px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);font-weight:700;font-size:15px;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.2s;">A+</button>
                </div>

                <div style="margin-top:14px;text-align:center;">
                    <button onclick="resetAllSettings()" style="background:rgba(244,63,94,0.08);border:1.5px solid rgba(244,63,94,0.2);color:#f43f5e;border-radius:10px;padding:8px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;transition:all 0.2s;" onmouseover="this.style.background='rgba(244,63,94,0.15)'" onmouseout="this.style.background='rgba(244,63,94,0.08)'">â†º Reset to Defaults</button>
                </div>
            </div>
        </div>

        <!-- ===== BOTTOM NAVIGATION BAR ===== -->
        <nav id="bottomNav" class="no-print">
            <button class="bn-item bn-active" id="bn-dashboard" onclick="switchView('dashboard');updateBottomNav('dashboard')">
                <span class="bn-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </span><span class="bn-label">Home</span>
            </button>
            <button class="bn-item" id="bn-order" onclick="switchView('order');updateBottomNav('order')">
                <span class="bn-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                </span><span class="bn-label">Order</span>
            </button>
            <button class="bn-item" id="bn-history" onclick="switchView('history');updateBottomNav('history')">
                <span class="bn-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </span><span class="bn-label">History</span>
            </button>
            <button class="bn-item" id="bn-stock" onclick="switchView('stock');updateBottomNav('stock')">
                <span class="bn-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                </span><span class="bn-label">Stock</span>
            </button>
            <button class="bn-item" id="bn-more" onclick="toggleMenu()">
                <span class="bn-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </span><span class="bn-label">More</span>
            </button>
        </nav>

        <div style="padding:16px 16px 0 16px;">

            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view active">

                <!-- Hero Welcome Banner -->
                <div style="background:linear-gradient(135deg,#4f46e5,#6366f1,#8b5cf6); border-radius:20px; padding:20px 22px; margin-bottom:16px; position:relative; overflow:hidden;">
                    <div style="position:absolute;top:-30px;right:-20px;width:120px;height:120px;background:rgba(255,255,255,0.08);border-radius:50%;"></div>
                    <div style="position:absolute;bottom:-40px;right:40px;width:90px;height:90px;background:rgba(255,255,255,0.05);border-radius:50%;"></div>
                    <div style="font-size:20px;font-weight:800;color:white;margin-bottom:2px;">Hello, <span id="dashWelcomeName">User</span> ðŸ‘‹</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.72);">Here's your business snapshot</div>
                </div>

                <div class="dash-grid">
                    <div class="dash-card dc-today">
                        <div class="dc-icon-bg">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        </div>
                        <div class="dc-lbl">Today's Sales</div>
                        <div class="dc-val" id="dashTodaySales">â‚¹ 0.00</div>
                    </div>
                    <div class="dash-card dc-total">
                        <div class="dc-icon-bg">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <div class="dc-lbl">Total Sales</div>
                        <div class="dc-val" id="dashTotalSales">â‚¹ 0.00</div>
                    </div>
                    <div class="dash-card dc-orders">
                        <div class="dc-icon-bg">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                        </div>
                        <div class="dc-lbl">Total Orders</div>
                        <div class="dc-val" id="dashTotalOrders">0</div>
                    </div>
                    <div class="dash-card dc-alert">
                        <div class="dc-icon-bg">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        </div>
                        <div class="dc-lbl">Low Stock</div>
                        <div class="dc-val" id="dashLowStockCount">0</div>
                    </div>
                </div>
                <div id="managerChartsWrapper" style="display:none;">
                    <button type="button" class="collapse-btn" onclick="toggleCollapse('managerChartsArea')">ðŸ“Š Show / Hide Dashboard Charts</button>
                    <div class="dash-grid" id="managerChartsArea" style="display:none;">
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">ðŸ“ˆ Last 7 Days Sales Trend</div>
                            <div class="chart-container"><canvas id="dashSalesChart"></canvas></div>
                        </div>
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">ðŸ“¦ Top 5 Selling Items</div>
                            <div class="chart-container"><canvas id="dashItemChart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--primary); padding-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--primary);">âš¡ Quick Access</div>
                        <div style="font-size:9px; color:#94a3b8; font-weight:500; font-style:italic;">updates with your usage</div>
                    </div>
                    <div id="dashQuickAccess" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <div style="text-align:center; padding:14px 8px; background:var(--bg); border-radius:12px; color:#94a3b8; font-size:12px; grid-column:1/-1;">Navigate the app to build your shortcut list</div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--danger);">
                    <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--danger); margin-bottom:10px;">âš ï¸ Refill Alert â€” Stock â‰¤ 5</div>
                    <div id="dashLowStockList" style="font-size:13px; color:#64748b; max-height:150px; overflow-y:auto;">Loading...</div>
                </div>
            </div>

            <!-- ORDER PANEL -->
            <div id="view-order" class="view">
                <div class="card">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="orderShop" class="input-field" style="margin-bottom:8px; margin-top:8px;" onchange="showOrderDueAlert(this.value)"><option value="">-- Select Shop --</option></select>
                    <div id="orderDueAlert" style="display:none;"></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">Search & Add Items</div>
                    <input type="text" id="orderItemInput" list="orderItemDatalist" class="input-field" placeholder="ðŸ” Type item name to search..." oninput="showPriceInfo()" autocomplete="off">
                    <datalist id="orderItemDatalist"></datalist>
                    <div class="toggle-box">
                        <label><input type="radio" name="priceMode" value="auto" checked onchange="togglePriceMode()"> ðŸ¤– Auto Price</label>
                        <label style="border-left:1px solid var(--border);"><input type="radio" name="priceMode" value="manual" onchange="togglePriceMode()"> âœï¸ Manual Price</label>
                    </div>
                    <div id="priceHighlightBox" class="highlight-box"></div>
                    <div id="manualPriceContainer" style="display:none;">
                        <input type="number" id="manualPriceInput" class="input-field" placeholder="Enter manual/discounted price (â‚¹)">
                    </div>
                    <div id="itemDiscContainer" style="display:none;">
                        <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:6px; letter-spacing:0.5px;">Extra Discount on this Item</div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                            <input type="number" id="itemDiscInput" class="input-field" placeholder="Discount %" min="0" max="100" style="margin-bottom:0; flex:1;" oninput="updateDiscPreview()">
                            <span id="discPricePreview" style="font-size:13px; font-weight:700; color:var(--success); white-space:nowrap;"></span>
                        </div>
                    </div>
                    <div class="flex-between">
                        <input type="number" id="orderQty" class="input-field" placeholder="Qty" style="margin-bottom:0; flex:1;">
                        <button class="btn btn-outline" onclick="addToCart()" style="margin-bottom:0; width:70px; margin-left:10px;">Add</button>
                        <button class="btn btn-outline" onclick="undoCart()" style="margin-bottom:0; width:75px; margin-left:10px; border-color:var(--warning); color:var(--warning);">Undo</button>
                    </div>
                </div>
                <div class="card" id="cartCard" style="display:none;">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">ðŸ›’ Cart Items</div>
                    <div id="cartList"></div>
                    <div class="flex-between" style="margin-top:15px; font-weight:700; font-size:15px;">
                        <span>Total:</span><span id="cartTotal" style="color:var(--primary); font-size:20px;">â‚¹ 0.00</span>
                    </div>
                    <button class="btn btn-success" onclick="placeFinalOrder()" id="btnPlace" style="margin-top:15px;">Place Final Order</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="view-history" class="view">
                <div id="historyList"><div style="text-align:center; padding:20px; color:#64748b;">Loading...</div></div>
            </div>

        <!-- ===== DELIVERY CONFIRM MODAL ===== -->
        <div id="deliveryConfirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:6000; align-items:center; justify-content:center; padding:16px; backdrop-filter:blur(4px);">
            <div style="background:var(--card); border-radius:22px; width:100%; max-width:420px; max-height:90vh; overflow-y:auto; box-shadow:0 24px 64px rgba(0,0,0,0.3); border:1px solid var(--border);">
                <!-- Header -->
                <div style="padding:20px 20px 0 20px; position:sticky; top:0; background:var(--card); z-index:2; border-bottom:1px solid var(--border); padding-bottom:14px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <div style="font-size:17px; font-weight:800; color:var(--text);">ðŸšš Delivery Confirmation</div>
                        <button onclick="closeDeliveryConfirm()" style="background:var(--bg); border:1px solid var(--border); border-radius:10px; width:32px; height:32px; font-size:16px; cursor:pointer; color:var(--text);">âœ•</button>
                    </div>
                    <div id="dcShopInfo" style="font-size:13px; color:#64748b;"></div>
                </div>
                <!-- Body -->
                <div style="padding:16px 20px;">
                    <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.3); border-radius:12px; padding:11px 14px; font-size:12px; color:#92400e; margin-bottom:14px; line-height:1.6;">
                        âš ï¸ <b>Enter the quantity actually taken by the shop.</b> Set 0 if not taken. Total will update automatically.
                    </div>
                    <div id="dcItemsContainer"></div>
                    <!-- Summary -->
                    <div style="background:var(--primary-light); border-radius:14px; padding:14px; margin-top:8px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-size:13px; font-weight:700; color:var(--text);">Ordered Total</div>
                            <div id="dcOrderedTotal" style="font-size:14px; font-weight:800; color:#64748b;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
                            <div style="font-size:14px; font-weight:800; color:var(--text);">âœ… Delivered Total</div>
                            <div id="dcDeliveredTotal" style="font-size:18px; font-weight:900; color:var(--success);"></div>
                        </div>
                    </div>
                    <!-- Buttons -->
                    <div style="display:flex; gap:10px;">
                        <button onclick="confirmDelivery()" class="btn btn-success" style="margin-bottom:0; flex:2; background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                            âœ… Confirm Delivery
                        </button>
                        <button onclick="closeDeliveryConfirm()" class="btn btn-outline" style="margin-bottom:0; flex:1;">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== WHATSAPP INVOICE MODAL ===== -->
        <div id="waModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:10001; align-items:center; justify-content:center; padding:16px;">
            <div class="card" style="width:100%; max-width:360px; margin:0; padding:24px; text-align:center;">
                <div style="font-size:36px; margin-bottom:8px;">âœ…</div>
                <div style="font-weight:800; font-size:17px; margin-bottom:4px;">Order Placed!</div>
                <div id="waSummaryText" style="font-size:13px; color:#64748b; margin-bottom:18px;"></div>
                <div style="background:var(--bg); border-radius:14px; padding:14px; margin-bottom:16px; text-align:left;">
                    <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ“² Send WhatsApp Invoice</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span style="font-size:18px;">ðŸ‡®ðŸ‡³ +91</span>
                        <input type="tel" id="waPhoneInput" class="input-field" placeholder="Shop phone number" style="margin:0; flex:1;" maxlength="10">
                    </div>
                    <div id="waSavedPhoneHint" style="font-size:11px; color:#10b981; margin-top:6px; display:none;">âœ… Saved number auto-filled</div>
                </div>
                <button class="btn" onclick="sendWAInvoice()" style="background:linear-gradient(135deg,#25d366,#128c7e); box-shadow:0 4px 15px rgba(37,211,102,0.35); margin-bottom:10px;">
                    ðŸ’¬ Send WhatsApp Invoice
                </button>
                <button class="btn btn-outline" onclick="closeWAModal()" style="margin-bottom:0; font-size:13px;">
                    Skip â†’ Go to History
                </button>
            </div>
        </div>

            <div id="view-billing" class="view">
                <div class="card no-print">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Order to Generate Bill</label>
                    <select id="billingSelect" class="input-field" onchange="renderA5Bill()" style="margin-top:8px;"><option value="">-- Choose an Order --</option></select>
                </div>
                <div id="bill-preview-section" style="display:none;">
                    <div class="flex-between no-print" style="margin-bottom:15px;">
                        <button class="btn btn-outline" onclick="openPrintSizeModal()" style="margin-bottom:0; flex:1;">ðŸ–¨ï¸ Print</button>
                        <button class="btn btn-success" onclick="openBillSizePDFModal()" style="margin-bottom:0; flex:1; margin-left:10px;">ðŸ’¾ Save PDF</button>
                        <button class="btn btn-whatsapp" onclick="shareWhatsApp()" style="margin-bottom:0; flex:1; margin-left:10px;">ðŸ’¬ WhatsApp</button>
                    </div>

                    <!-- Print Size Modal -->
                    <div id="printSizeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
                         z-index:9999; align-items:center; justify-content:center; padding:20px;">
                        <div class="card" style="width:100%; max-width:320px; padding:24px; margin:0; text-align:center;">
                            <div style="font-size:28px; margin-bottom:8px;">ðŸ–¨ï¸</div>
                            <div style="font-weight:800; font-size:16px; margin-bottom:4px;">Select Print Size</div>
                            <div style="font-size:12px; color:#64748b; margin-bottom:20px;">Choose the paper size for printing</div>
                            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:18px;">
                                <button onclick="doPrint('A6')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--primary);
                                           background:linear-gradient(135deg,var(--primary),#6366f1); color:white;
                                           font-weight:800; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;">
                                    <span>ðŸ“„ A6 <span style="font-size:11px; font-weight:500; opacity:0.85;">(105 Ã— 148 mm)</span></span>
                                    <span style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; font-size:10px;">DEFAULT</span>
                                </button>
                                <button onclick="doPrint('A5')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s, background 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>ðŸ“„ A5 <span style="font-size:11px; font-weight:500; color:#64748b;">(148 Ã— 210 mm)</span></span>
                                </button>
                                <button onclick="doPrint('A4')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s, background 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>ðŸ“„ A4 <span style="font-size:11px; font-weight:500; color:#64748b;">(210 Ã— 297 mm)</span></span>
                                </button>
                            </div>
                            <button onclick="document.getElementById('printSizeModal').style.display='none'"
                                class="btn btn-outline" style="margin-bottom:0; font-size:13px;">Cancel</button>
                        </div>
                    </div>

                    <!-- Save PDF Size Modal -->
                    <div id="billPDFSizeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
                         z-index:9999; align-items:center; justify-content:center; padding:20px;">
                        <div class="card" style="width:100%; max-width:320px; padding:24px; margin:0; text-align:center;">
                            <div style="font-size:28px; margin-bottom:8px;">ðŸ’¾</div>
                            <div style="font-weight:800; font-size:16px; margin-bottom:4px;">Select PDF Size</div>
                            <div style="font-size:12px; color:#64748b; margin-bottom:20px;">Choose the page size for the saved PDF</div>
                            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:18px;">
                                <button onclick="downloadBillPDF('A6')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--primary);
                                           background:linear-gradient(135deg,var(--primary),#6366f1); color:white;
                                           font-weight:800; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;">
                                    <span>ðŸ“„ A6 <span style="font-size:11px; font-weight:500; opacity:0.85;">(105 Ã— 148 mm)</span></span>
                                    <span style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; font-size:10px;">DEFAULT</span>
                                </button>
                                <button onclick="downloadBillPDF('A5')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>ðŸ“„ A5 <span style="font-size:11px; font-weight:500; color:#64748b;">(148 Ã— 210 mm)</span></span>
                                </button>
                                <button onclick="downloadBillPDF('A4')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>ðŸ“„ A4 <span style="font-size:11px; font-weight:500; color:#64748b;">(210 Ã— 297 mm)</span></span>
                                </button>
                            </div>
                            <button onclick="document.getElementById('billPDFSizeModal').style.display='none'"
                                class="btn btn-outline" style="margin-bottom:0; font-size:13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="a5-print-zone" class="bill-container">
                        <!-- Logo (shown only if set) -->
                        <div class="bill-logo-wrap" id="b-logoWrap" style="display:none;">
                            <img id="b-logoImg" src="" alt="Brand Logo">
                        </div>
                        <!-- Dark header band -->
                        <div class="bill-header">
                            <h1 id="b-companyName">Order With Me</h1>
                            <div class="bill-tagline">TAX INVOICE / RETAIL BILL</div>
                        </div>
                        <!-- Info strip -->
                        <div class="bill-info-strip">
                            <div class="billed-to">
                                <div class="label">Billed To</div>
                                <div class="shop-name" id="b-shopName">Shop Name</div>
                                <div class="shop-detail" id="b-shopPhone"></div>
                                <div class="shop-detail" id="b-shopAddr"></div>
                            </div>
                            <div class="bill-meta-right">
                                <div class="meta-row"><span class="key">Bill No</span><span class="val" id="b-orderId">#000000</span></div>
                                <div class="meta-row"><span class="key">Date</span><span class="val" id="b-date">--</span></div>
                                <div class="meta-row"><span class="key">Sales Rep</span><span class="val" id="b-salesman">--</span></div>
                            </div>
                        </div>
                        <!-- Items table -->
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th class="col-sl">Sl</th>
                                    <th class="col-desc">Item Description</th>
                                    <th class="col-rate">Rate (â‚¹)</th>
                                    <th class="col-qty">Qty</th>
                                    <th class="col-amt">Amount (â‚¹)</th>
                                </tr>
                            </thead>
                            <tbody id="b-itemsBody"></tbody>
                        </table>
                        <!-- Totals block -->
                        <div class="bill-totals-block">
                            <div class="totals-row">
                                <span class="t-label">Sub Total</span>
                                <span class="t-val" id="b-subTotal">0.00</span>
                            </div>
                            <div class="totals-row" id="b-discountRow" style="display:none;">
                                <span class="t-label">Discount</span>
                                <span class="t-val" id="b-discount" style="color:#f43f5e;">- 0.00</span>
                            </div>
                            <div class="grand-row">
                                <span class="g-label">Grand Total</span>
                                <span class="g-val">â‚¹ <span id="b-grandTotal">0.00</span></span>
                            </div>
                        </div>
                        <!-- Signature row -->
                        <div class="bill-sign-row">
                            <div class="sign-box">
                                <div class="sign-line">Customer Signature</div>
                            </div>
                            <div class="sign-box">
                                <div class="sign-line">Authorised Signatory</div>
                            </div>
                        </div>
                        <!-- Footer -->
                        <div class="bill-footer">
                            <div class="thank-you">âœ¦ THANK YOU FOR YOUR BUSINESS âœ¦</div>
                            <div>This is a computer generated invoice. No signature required.</div>
                            <div id="b-footerNote" style="margin-top:2px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QUOTATION -->
            <div id="view-quotation" class="view">
                <div class="card no-print">
                    <div style="font-size:15px; font-weight:800; margin-bottom:14px; display:flex; align-items:center; gap:8px;">
                        ðŸ“‹ Quotation Builder
                        <span style="font-size:10px; background:linear-gradient(135deg,#4f46e5,#6366f1); color:white; border-radius:20px; padding:2px 10px; font-weight:700;">MANAGER</span>
                    </div>

                    <!-- Theme Selector -->
                    <div style="margin-bottom:14px;">
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:8px;">ðŸŽ¨ Select Background Theme</label>
                        <div id="qtThemeGrid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:7px;">

                            <!-- ROW 1: Gradient themes -->
                            <div class="qt-theme-btn active-theme" data-theme="classic" onclick="selectQtTheme(this,'classic')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2.5px solid #4f46e5;box-shadow:0 0 0 2px rgba(79,70,229,0.2);">
                                <div style="height:36px;background:linear-gradient(135deg,#eef2ff,#c7d2fe,#818cf8);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#eef2ff;color:#3730a3;">Classic</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="royal" onclick="selectQtTheme(this,'royal')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#1a1a2e,#16213e,#533483);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#1a1a2e;color:#e2c97e;">Royal</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="emerald" onclick="selectQtTheme(this,'emerald')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#064e3b,#059669,#34d399);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#064e3b;color:#a7f3d0;">Emerald</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="crimson" onclick="selectQtTheme(this,'crimson')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#7f1d1d,#dc2626,#f87171);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#7f1d1d;color:#fecaca;">Crimson</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="ocean" onclick="selectQtTheme(this,'ocean')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#0c4a6e,#0284c7,#38bdf8);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#0c4a6e;color:#bae6fd;">Ocean</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="sunset" onclick="selectQtTheme(this,'sunset')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#7c2d12,#ea580c,#fbbf24);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#7c2d12;color:#fde68a;">Sunset</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="violet" onclick="selectQtTheme(this,'violet')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#2e1065,#7c3aed,#c4b5fd);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#2e1065;color:#ddd6fe;">Violet</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="gold" onclick="selectQtTheme(this,'gold')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#78350f,#d97706,#fcd34d);"></div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#78350f;color:#fef3c7;">Gold</div>
                            </div>

                            <!-- ROW 2: Abstract / Pattern themes -->
                            <div class="qt-theme-btn" data-theme="neon" onclick="selectQtTheme(this,'neon')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#0f0f23,#1a0533,#0d0d1a);position:relative;overflow:hidden;">
                                    <div style="position:absolute;top:4px;left:8px;width:18px;height:18px;background:rgba(139,92,246,0.6);border-radius:50%;filter:blur(5px);"></div>
                                    <div style="position:absolute;bottom:3px;right:6px;width:14px;height:14px;background:rgba(34,211,238,0.5);border-radius:50%;filter:blur(4px);"></div>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#0f0f23;color:#22d3ee;">Neon Glow</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="aurora" onclick="selectQtTheme(this,'aurora')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(160deg,#0d1b2a 0%,#1b4332 35%,#065f46 60%,#0c4a6e 100%);position:relative;overflow:hidden;">
                                    <div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(52,211,153,0.25),transparent);"></div>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#0d1b2a;color:#6ee7b7;">Aurora</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="mesh" onclick="selectQtTheme(this,'mesh')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:#f0f4ff;position:relative;overflow:hidden;">
                                    <svg style="position:absolute;inset:0;width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="mqg" width="8" height="8" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="1" fill="rgba(79,70,229,0.2)"/></pattern></defs><rect width="100%" height="100%" fill="url(#mqg)"/></svg>
                                    <div style="position:absolute;top:3px;left:4px;width:22px;height:22px;background:radial-gradient(circle,rgba(99,102,241,0.35),transparent);border-radius:50%;"></div>
                                    <div style="position:absolute;bottom:2px;right:5px;width:16px;height:16px;background:radial-gradient(circle,rgba(139,92,246,0.3),transparent);border-radius:50%;"></div>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#f0f4ff;color:#4338ca;">Mesh</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="geometric" onclick="selectQtTheme(this,'geometric')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:#1e293b;position:relative;overflow:hidden;">
                                    <svg style="position:absolute;inset:0;width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 30,0 0,30" fill="rgba(99,102,241,0.4)"/><polygon points="60,36 100,36 100,0" fill="rgba(139,92,246,0.3)"/><polygon points="30,20 55,36 5,36" fill="rgba(79,70,229,0.2)"/></svg>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#1e293b;color:#94a3b8;">Geometric</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="waves" onclick="selectQtTheme(this,'waves')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#0369a1,#0ea5e9);position:relative;overflow:hidden;">
                                    <svg style="position:absolute;bottom:-2px;left:0;width:100%;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0,10 C20,20 40,0 60,10 C80,20 100,0 100,10 L100,20 L0,20Z" fill="rgba(255,255,255,0.25)"/></svg>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#0369a1;color:#bae6fd;">Waves</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="circuit" onclick="selectQtTheme(this,'circuit')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:#0f172a;position:relative;overflow:hidden;">
                                    <svg style="position:absolute;inset:0;width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="10" x2="40" y2="10" stroke="rgba(34,197,94,0.5)" stroke-width="1"/><line x1="40" y1="10" x2="40" y2="25" stroke="rgba(34,197,94,0.5)" stroke-width="1"/><line x1="40" y1="25" x2="100" y2="25" stroke="rgba(34,197,94,0.5)" stroke-width="1"/><circle cx="40" cy="10" r="2" fill="rgba(34,197,94,0.7)"/><circle cx="70" cy="25" r="2" fill="rgba(34,197,94,0.7)"/><line x1="60" y1="0" x2="60" y2="15" stroke="rgba(34,211,238,0.4)" stroke-width="1"/><circle cx="60" cy="15" r="1.5" fill="rgba(34,211,238,0.6)"/></svg>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#0f172a;color:#22c55e;">Circuit</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="marble" onclick="selectQtTheme(this,'marble')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#f1f5f9,#e2e8f0,#f8fafc);position:relative;overflow:hidden;">
                                    <svg style="position:absolute;inset:0;width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg"><path d="M0,15 Q25,5 50,18 Q75,30 100,12" fill="none" stroke="rgba(148,163,184,0.5)" stroke-width="2"/><path d="M0,25 Q30,10 60,22 Q80,30 100,20" fill="none" stroke="rgba(203,213,225,0.6)" stroke-width="1.5"/></svg>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#f1f5f9;color:#475569;">Marble</div>
                            </div>
                            <div class="qt-theme-btn" data-theme="sakura" onclick="selectQtTheme(this,'sakura')" style="border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid var(--border);">
                                <div style="height:36px;background:linear-gradient(135deg,#fdf2f8,#fbcfe8,#f9a8d4);position:relative;overflow:hidden;">
                                    <svg style="position:absolute;inset:0;width:100%;height:100%;" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="15" cy="12" r="4" fill="rgba(244,114,182,0.3)"/>
                                        <circle cx="50" cy="8" r="3" fill="rgba(236,72,153,0.2)"/>
                                        <circle cx="80" cy="20" r="5" fill="rgba(244,114,182,0.25)"/>
                                        <circle cx="35" cy="28" r="3" fill="rgba(251,207,232,0.5)"/>
                                    </svg>
                                </div>
                                <div style="font-size:8.5px;font-weight:700;text-align:center;padding:3px 2px;background:#fdf2f8;color:#be185d;">Sakura</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quotation Details -->
                    <!-- Company Name (auto from brand settings) -->
                    <div style="margin-bottom:10px;">
                        <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">ðŸ¢ Organization / Company Name</label>
                        <input id="qt-companyName" class="input-field" placeholder="Your company name" style="margin-bottom:0;" oninput="renderQuotation()">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">ðŸª Client / Shop Name</label>
                            <input id="qt-clientName" class="input-field" list="qt-shopList" placeholder="Select or type client..." style="margin-bottom:0;" oninput="renderQuotation()">
                            <datalist id="qt-shopList"></datalist>
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Quotation No</label>
                            <input id="qt-quotNo" class="input-field" placeholder="QT-2024-001" style="margin-bottom:0;" oninput="renderQuotation()">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Valid Until</label>
                            <input id="qt-validDate" type="date" class="input-field" style="margin-bottom:0;" oninput="renderQuotation()">
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">ðŸ‘¤ Salesman</label>
                            <input id="qt-salesman" class="input-field" list="qt-salesmanList" placeholder="Sales rep name" style="margin-bottom:0;" oninput="renderQuotation()">
                            <datalist id="qt-salesmanList"></datalist>
                        </div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Custom Note / Terms</label>
                        <textarea id="qt-note" class="input-field" rows="2" placeholder="e.g. Prices valid for 30 days. GST extra as applicable." style="resize:none; margin-bottom:0;" oninput="renderQuotation()"></textarea>
                    </div>

                    <!-- Items Builder -->
                    <div style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ“¦ Add Products</div>
                    <div id="qtItemsList" style="margin-bottom:10px;"></div>
                    <button class="btn btn-outline" onclick="addQtItem()" style="margin-bottom:10px; font-size:13px; padding:10px;">+ Add Item</button>

                    <!-- Discount & Tax -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px;">
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Discount (%)</label>
                            <input id="qt-discount" type="number" min="0" max="100" class="input-field" placeholder="0" value="0" style="margin-bottom:0;" oninput="renderQuotation()">
                        </div>
                        <div>
                            <label style="font-size:11px; font-weight:600; color:#64748b; display:block; margin-bottom:4px;">Tax / GST (%)</label>
                            <input id="qt-tax" type="number" min="0" max="100" class="input-field" placeholder="0" value="0" style="margin-bottom:0;" oninput="renderQuotation()">
                        </div>
                    </div>

                    <!-- Action buttons â€” row 1 -->
                    <div style="display:grid; grid-template-columns:1fr 1fr 44px; gap:8px; align-items:stretch; margin-bottom:8px;">
                        <button class="btn" onclick="renderQuotation()" style="margin-bottom:0; padding:11px 8px; font-size:12px;">ðŸ‘ï¸ Preview</button>
                        <button class="btn btn-success" onclick="downloadQtPDF()" style="margin-bottom:0; padding:11px 8px; font-size:12px;">ðŸ’¾ Save PDF</button>
                        <button onclick="printQuotation()" style="height:100%; border:none; border-radius:12px; background:linear-gradient(135deg,#0369a1,#0284c7); color:white; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(3,105,161,0.3); transition:opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">ðŸ–¨ï¸</button>
                    </div>
                    <!-- Action buttons â€” row 2: Gmail Send + Track -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button onclick="sendQuotationViaGmail()" style="border:none; border-radius:12px; padding:12px 8px; font-size:13px; font-weight:700; font-family:'Poppins',sans-serif; cursor:pointer; background:linear-gradient(135deg,#ea4335,#fbbc04); color:white; box-shadow:0 4px 14px rgba(234,67,53,0.35); transition:transform 0.2s,box-shadow 0.2s; display:flex; align-items:center; justify-content:center; gap:6px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(234,67,53,0.45)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 14px rgba(234,67,53,0.35)'">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                            Send via Gmail
                        </button>
                        <button onclick="openQtTracker()" style="border:none; border-radius:12px; padding:12px 8px; font-size:13px; font-weight:700; font-family:'Poppins',sans-serif; cursor:pointer; background:linear-gradient(135deg,#7c3aed,#a78bfa); color:white; box-shadow:0 4px 14px rgba(124,58,237,0.35); transition:transform 0.2s,box-shadow 0.2s; display:flex; align-items:center; justify-content:center; gap:6px; position:relative;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(124,58,237,0.45)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 14px rgba(124,58,237,0.35)'">
                            ðŸ“Š Track Quotations
                            <span id="qt-pending-badge" style="display:none; position:absolute; top:-6px; right:-4px; background:#ef4444; color:white; font-size:10px; font-weight:900; border-radius:99px; padding:2px 7px; box-shadow:0 2px 6px rgba(239,68,68,0.5); animation: qtPulse 1.5s infinite;">0</span>
                        </button>
                    </div>
                </div>

                <!-- ===== QUOTATION TRACKER PANEL ===== -->
                <div id="qt-tracker-panel" style="display:none; margin-top:0;">
                    <div class="card" style="padding:0; overflow:hidden;">
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg,#7c3aed,#a78bfa); padding:16px 18px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:15px; font-weight:800; color:white; display:flex; align-items:center; gap:8px;">
                                    ðŸ“Š Quotation Tracker
                                </div>
                                <div style="font-size:11px; color:rgba(255,255,255,0.8); margin-top:2px;">All saved quotations & their status</div>
                            </div>
                            <button onclick="closeQtTracker()" style="background:rgba(255,255,255,0.2); border:none; color:white; border-radius:8px; width:32px; height:32px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center;">âœ•</button>
                        </div>
                        <!-- Stats row -->
                        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:0; border-bottom:1px solid var(--border);">
                            <div style="padding:14px 10px; text-align:center; border-right:1px solid var(--border);">
                                <div id="qt-stat-total" style="font-size:22px; font-weight:900; color:var(--primary);">0</div>
                                <div style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Total</div>
                            </div>
                            <div style="padding:14px 10px; text-align:center; border-right:1px solid var(--border);">
                                <div id="qt-stat-pending" style="font-size:22px; font-weight:900; color:#f59e0b;">0</div>
                                <div style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Pending</div>
                            </div>
                            <div style="padding:14px 10px; text-align:center;">
                                <div id="qt-stat-sent" style="font-size:22px; font-weight:900; color:#10b981;">0</div>
                                <div style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Sent</div>
                            </div>
                        </div>
                        <!-- Filter tabs -->
                        <div style="display:flex; gap:0; border-bottom:1px solid var(--border); background:var(--bg);">
                            <button id="qt-tab-all" onclick="filterQtTracker('all')" style="flex:1; padding:10px 6px; border:none; background:var(--primary); color:white; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.2s;">All</button>
                            <button id="qt-tab-pending" onclick="filterQtTracker('pending')" style="flex:1; padding:10px 6px; border:none; background:transparent; color:#f59e0b; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.2s; border-left:1px solid var(--border);">ðŸ• Pending</button>
                            <button id="qt-tab-sent" onclick="filterQtTracker('sent')" style="flex:1; padding:10px 6px; border:none; background:transparent; color:#10b981; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.2s; border-left:1px solid var(--border);">âœ… Sent</button>
                            <button id="qt-tab-accepted" onclick="filterQtTracker('accepted')" style="flex:1; padding:10px 6px; border:none; background:transparent; color:#6366f1; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.2s; border-left:1px solid var(--border);">ðŸŽ‰ Accepted</button>
                        </div>
                        <!-- List -->
                        <div id="qt-tracker-list" style="max-height:420px; overflow-y:auto; padding:12px 14px;">
                            <div style="text-align:center; color:#94a3b8; font-size:13px; padding:24px;">No quotations saved yet.</div>
                        </div>
                        <!-- Save current quotation button -->
                        <div style="padding:12px 14px; border-top:1px solid var(--border); background:var(--bg);">
                            <button onclick="saveCurrentQuotationToTracker()" class="btn" style="margin-bottom:0; font-size:13px; padding:11px;">ðŸ’¾ Save Current Quotation to Tracker</button>
                        </div>
                    </div>
                </div>

                <!-- Quotation Preview -->
                <div id="qt-preview-section" style="display:none; margin-top:0;">
                    <div id="qt-print-zone"></div>
                </div>
            </div>

            <!-- STOCK -->
            <div id="view-stock" class="view">
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <div>
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Inventory Status</h3>
                        <div style="font-size:14px; font-weight:700; color:var(--primary); margin-top:4px;">Total Value: <span id="stockTotalValue">â‚¹ 0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <input type="text" id="stockSearch" onkeyup="filterStock()" placeholder="ðŸ” Search item..." class="input-field" style="margin-bottom:6px; padding:8px 12px; min-width:180px;">
                        <div>
                            <button onclick="exportAnyTable('stockDataArea','Inventory_Stock_Report')" class="btn-outline" style="padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; font-family:inherit;">ðŸ“„ PDF</button>
                            <button onclick="exportDataExcel(stockDataArray,'Inventory_Stock_Report')" class="btn-success" style="border:none; color:white; padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; margin-left:5px; font-family:inherit;">ðŸ“¥ Excel</button>
                        </div>
                    </div>
                </div>
                <div class="card table-wrapper" id="stockDataArea">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Selling Price (â‚¹)</th>
                                <th class="mgr-only-col">Purchase Price (â‚¹)</th>
                                <th>Disc (%)</th>
                                <th class="mgr-action no-print" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SALES -->
            <div id="view-sales" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Sales Ledger</h3>
                    <div>
                        <button onclick="exportAnyTable('salesDataArea','Sales_Ledger_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">ðŸ“„ PDF</button>
                        <button onclick="exportDataExcel(salesDataArray,'Sales_Ledger_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">ðŸ“¥ Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="salesDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date & Time</th><th>Party/Shop</th><th>Items Sold</th><th>Total (â‚¹)</th><th>Salesman</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PURCHASE -->
            <div id="view-purchase" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Purchase History</h3>
                    <div>
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)" style="display:none;">
                        <button onclick="document.getElementById('importExcelFile').click()" class="btn-outline mgr-action" style="padding:5px 10px; display:none; font-family:inherit;">ðŸ“¤ Import</button>
                        <button onclick="exportAnyTable('purchaseDataArea','Purchase_History_Report')" class="btn-outline" style="padding:5px 10px; margin-left:5px; font-family:inherit;">ðŸ“„ PDF</button>
                        <button onclick="exportDataExcel(purchaseDataArray,'Purchase_History_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">ðŸ“¥ Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="purchaseDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Product</th><th>Added Qty</th><th>Selling Price (â‚¹)</th><th class="mgr-only-col">Cost Price (â‚¹)</th><th>Dealer/Info</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="purchaseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="view-reports" class="view">
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ“ˆ Advanced Report Filter</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">ðŸ“… Quick Date</div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="applyDatePreset('today', this)">Today</button>
                                <button class="preset-btn" onclick="applyDatePreset('yesterday', this)">Yesterday</button>
                                <button class="preset-btn" onclick="applyDatePreset('week', this)">This Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastweek', this)">Last Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('month', this)">This Month</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastmonth', this)">Last Month</button>
                            </div>
                        </div>
                        <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">ðŸŽ¯ Filters</div>
                        <div class="report-filter-bar">
                            <input type="date" id="repStartDate" onchange="clearPresets()" title="Start Date">
                            <input type="date" id="repEndDate" onchange="clearPresets()" title="End Date">
                        </div>
                        <div class="report-filter-bar">
                            <select id="repShop"><option value="all">All Shops</option></select>
                            <select id="repArea"><option value="all">All Areas</option></select>
                            <select id="repItem"><option value="all">All Items</option></select>
                            <select id="repSalesman"><option value="all">All Salesmen</option></select>
                        </div>
                        <div class="report-filter-bar">
                            <input type="number" id="repMinAmount" placeholder="Min â‚¹" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            <input type="number" id="repMaxAmount" placeholder="Max â‚¹" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:4px;">
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">ðŸ“Š Sort By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="sortOptions">
                                    <div class="sort-option active-sort" onclick="setSortOption('date-desc', this)" style="font-size:11px; padding:7px 8px;">ðŸ“… Newest</div>
                                    <div class="sort-option" onclick="setSortOption('date-asc', this)" style="font-size:11px; padding:7px 8px;">ðŸ“… Oldest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-desc', this)" style="font-size:11px; padding:7px 8px;">ðŸ’° Highest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-asc', this)" style="font-size:11px; padding:7px 8px;">ðŸ’° Lowest</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">ðŸ—‚ï¸ Group By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="groupOptions">
                                    <div class="sort-option active-sort" onclick="setGroupOption('none', this)" style="font-size:11px; padding:7px 8px;">ðŸš« None</div>
                                    <div class="sort-option" onclick="setGroupOption('shop', this)" style="font-size:11px; padding:7px 8px;">ðŸª Shop</div>
                                    <div class="sort-option" onclick="setGroupOption('salesman', this)" style="font-size:11px; padding:7px 8px;">ðŸ‘¤ Salesman</div>
                                    <div class="sort-option" onclick="setGroupOption('date', this)" style="font-size:11px; padding:7px 8px;">ðŸ“… Date</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:14px;">
                            <button class="btn btn-success" onclick="generateCustomReport()" style="margin-bottom:0; flex:2;">ðŸ” Generate</button>
                            <button class="btn btn-outline" onclick="resetReportFilters()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ’³ Shop Payment History Report</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px; margin-bottom:12px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Filter by Shop</div>
                            <div class="report-filter-bar">
                                <select id="payRepShopSel"><option value="all">All Shops</option></select>
                                <input type="date" id="payRepStart" title="From date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                                <input type="date" id="payRepEnd" title="To date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            </div>
                            <button class="btn btn-success" onclick="generatePaymentReport()" style="margin-bottom:0; margin-top:4px;">ðŸ“Š Generate Payment Report</button>
                        </div>
                        <div id="payRepResultArea" style="display:none; margin-top:8px;">
                            <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Billed</div><div class="rsm-val" style="color:var(--primary);" id="payRepTotalBill">â‚¹ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Paid</div><div class="rsm-val" style="color:var(--success);" id="payRepTotalPaid">â‚¹ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Remaining Due</div><div class="rsm-val" style="color:var(--danger);" id="payRepRemaining">â‚¹ 0.00</div></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Payment Details <span id="payRepCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('payRepDataArea','Payment_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(paymentReportArray,'Payment_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="payRepDataArea" style="margin-bottom:0;">
                                <table class="data-table" id="payRepTable">
                                    <thead><tr><th>Date</th><th>Shop</th><th>Amount Paid (â‚¹)</th><th>Note</th><th>Recorded By</th></tr></thead>
                                    <tbody id="payRepTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== PRODUCT-WISE SALES REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header open" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ“¦ Product-wise Sales Report</div>
                        <span class="ch-arrow" style="transform:rotate(180deg);">â–¼</span>
                    </div>
                    <div class="collapsible-body open">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">ðŸ“… Date Range</div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="pwApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="pwApplyPreset('yesterday',this)">Yesterday</button>
                                <button class="preset-btn" onclick="pwApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="pwApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="pwApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="pwApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="pwStartDate" title="From Date" onchange="pwClearPresets()">
                                <input type="date" id="pwEndDate" title="To Date" onchange="pwClearPresets()">
                            </div>
                            <div class="report-filter-bar">
                                <select id="pwShopFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Shops</option>
                                </select>
                                <select id="pwAreaFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Areas</option>
                                </select>
                                <select id="pwSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateProductWiseReport()" style="margin-bottom:0; flex:2;">ðŸ“Š Generate Report</button>
                                <button class="btn btn-outline" onclick="resetProductWiseReport()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                            </div>
                        </div>
                        <div id="pwResultArea" style="display:none; margin-top:16px;">
                            <!-- Summary Stats -->
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Products Sold</div><div class="rsm-val" style="color:var(--primary);" id="pwTotalProducts">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Qty</div><div class="rsm-val" style="color:var(--success);" id="pwTotalQty">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--warning);" id="pwTotalRevenue">â‚¹ 0</div></div>
                            </div>
                            <!-- Chart -->
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">ðŸ“Š Top 10 Products by Revenue</div>
                                <div style="position:relative; height:260px;"><canvas id="pwBarChart"></canvas></div>
                            </div>
                            <!-- Pie chart + Top 3 -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ¥§ Revenue Share</div>
                                    <div style="position:relative; height:180px;"><canvas id="pwPieChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ† Top Sellers</div>
                                    <div id="pwTopThree"></div>
                                </div>
                            </div>
                            <!-- Table -->
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Product Details <span id="pwTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('pwTableArea','Product_Sales_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(pwDataArray,'Product_Sales_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="pwTableArea" style="margin-bottom:0;">
                                <table class="data-table" id="pwMainTable">
                                    <thead>
                                        <tr>
                                            <th onclick="pwSortTable('rank')" style="cursor:pointer;" title="Sort by Rank">#</th>
                                            <th onclick="pwSortTable('name')" style="cursor:pointer;" title="Sort by Name">Product â†•</th>
                                            <th onclick="pwSortTable('qty')" style="cursor:pointer;" title="Sort by Qty">Qty Sold â†•</th>
                                            <th onclick="pwSortTable('revenue')" style="cursor:pointer;" title="Sort by Revenue">Revenue â†•</th>
                                            <th onclick="pwSortTable('orders')" style="cursor:pointer;" title="Sort by Orders">Orders â†•</th>
                                            <th>Avg/Order</th>
                                            <th>Share %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pwTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SHOP-WISE SALES REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸª Shop-wise Sales Report</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="swApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="swApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="swApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="swApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="swApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="swStartDate" onchange="swClearPresets()">
                                <input type="date" id="swEndDate" onchange="swClearPresets()">
                            </div>
                            <div class="report-filter-bar">
                                <select id="swSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                                <select id="swAreaFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Areas</option>
                                </select>
                                <select id="swSortBy" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="revenue">Sort: Revenue â†“</option>
                                    <option value="orders">Sort: Orders â†“</option>
                                    <option value="avg">Sort: Avg Order â†“</option>
                                    <option value="name">Sort: Name A-Z</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateShopWiseReport()" style="margin-bottom:0; flex:2;">ðŸ“Š Generate Report</button>
                                <button class="btn btn-outline" onclick="resetShopWiseReport()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                            </div>
                        </div>
                        <div id="swResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Active Shops</div><div class="rsm-val" style="color:var(--primary);" id="swTotalShops">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Orders</div><div class="rsm-val" style="color:var(--warning);" id="swTotalOrders">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--success);" id="swTotalRevenue">â‚¹ 0</div></div>
                            </div>
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">ðŸ“Š Top 10 Shops by Revenue</div>
                                <div style="position:relative; height:260px;"><canvas id="swBarChart"></canvas></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Shop Details <span id="swTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('swTableArea','Shop_Sales_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(swDataArray,'Shop_Sales_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="swTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>#</th><th>Shop Name</th><th>Orders</th><th>Revenue (â‚¹)</th><th>Avg/Order</th><th>Share %</th></tr></thead>
                                    <tbody id="swTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SALESMAN PERFORMANCE REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ‘¤ Salesman Performance Report</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="slApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="slApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="slApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="slApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="slApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="slStartDate" onchange="slClearPresets()">
                                <input type="date" id="slEndDate" onchange="slClearPresets()">
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateSalesmanReport()" style="margin-bottom:0; flex:2;">ðŸ“Š Generate Report</button>
                                <button class="btn btn-outline" onclick="resetSalesmanReport()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                            </div>
                        </div>
                        <div id="slResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Salesmen</div><div class="rsm-val" style="color:var(--primary);" id="slTotalSalesmen">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Orders</div><div class="rsm-val" style="color:var(--warning);" id="slTotalOrders">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--success);" id="slTotalRevenue">â‚¹ 0</div></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ’° Revenue</div>
                                    <div style="position:relative; height:180px;"><canvas id="slBarChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ“¦ Orders</div>
                                    <div style="position:relative; height:180px;"><canvas id="slOrderChart"></canvas></div>
                                </div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Salesman Details <span id="slTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('slTableArea','Salesman_Performance_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(slDataArray,'Salesman_Performance_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="slTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Rank</th><th>Salesman</th><th>Orders</th><th>Revenue (â‚¹)</th><th>Avg/Order</th><th>Unique Shops</th><th>Share %</th></tr></thead>
                                    <tbody id="slTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SALES TREND REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ“… Sales Trend Report</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">ðŸ“ Grouping</div>
                            <div class="toggle-box" style="margin-bottom:12px;">
                                <label><input type="radio" name="trendGroup" value="daily" checked onchange=""> ðŸ“… Daily</label>
                                <label style="border-left:1px solid var(--border);"><input type="radio" name="trendGroup" value="weekly" onchange=""> ðŸ“† Weekly</label>
                                <label style="border-left:1px solid var(--border);"><input type="radio" name="trendGroup" value="monthly" onchange=""> ðŸ—“ï¸ Monthly</label>
                            </div>
                            <div class="report-filter-bar">
                                <input type="date" id="trStartDate">
                                <input type="date" id="trEndDate">
                            </div>
                            <div class="report-filter-bar">
                                <select id="trShopFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Shops</option>
                                </select>
                                <select id="trSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateTrendReport()" style="margin-bottom:0; flex:2;">ðŸ“ˆ Generate Trend</button>
                                <button class="btn btn-outline" onclick="resetTrendReport()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                            </div>
                        </div>
                        <div id="trResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Peak Period</div><div class="rsm-val" style="color:var(--primary); font-size:12px;" id="trPeakPeriod">â€”</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Best Sales</div><div class="rsm-val" style="color:var(--success);" id="trPeakRevenue">â‚¹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Avg/Period</div><div class="rsm-val" style="color:var(--warning);" id="trAvgRevenue">â‚¹ 0</div></div>
                            </div>
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">ðŸ“ˆ Sales Trend</div>
                                <div style="position:relative; height:280px;"><canvas id="trLineChart"></canvas></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Trend Data <span id="trTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('trTableArea','Sales_Trend_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(trDataArray,'Sales_Trend_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="trTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Period</th><th>Orders</th><th>Revenue (â‚¹)</th><th>Qty Sold</th><th>vs Prev %</th></tr></thead>
                                    <tbody id="trTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== PROFIT & MARGIN REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">ðŸ’° Profit & Margin Report</div>
                        <span class="ch-arrow">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:10px; padding:10px 12px; font-size:12px; color:#92400e; margin-bottom:12px;">
                                âš ï¸ Profit calculation needs <b>Cost Price</b> set for each product in Manager Panel â†’ Add/Refill Product.
                            </div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="pmApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="pmApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="pmApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="pmApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="pmApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="pmStartDate" onchange="pmClearPresets()">
                                <input type="date" id="pmEndDate" onchange="pmClearPresets()">
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateProfitReport()" style="margin-bottom:0; flex:2;">ðŸ’° Generate Profit Report</button>
                                <button class="btn btn-outline" onclick="resetProfitReport()" style="margin-bottom:0; flex:1;">â†º Reset</button>
                            </div>
                        </div>
                        <div id="pmResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--primary);" id="pmRevenue">â‚¹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Cost</div><div class="rsm-val" style="color:var(--danger);" id="pmCost">â‚¹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Net Profit</div><div class="rsm-val" id="pmNetProfit">â‚¹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Margin %</div><div class="rsm-val" id="pmMargin">0%</div></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ’¹ Revenue vs Cost</div>
                                    <div style="position:relative; height:180px;"><canvas id="pmBarChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">ðŸ† Highest Margin Products</div>
                                    <div id="pmTopMargin"></div>
                                </div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Product Profit Details <span id="pmTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('pmTableArea','Profit_Margin_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">ðŸ“„ PDF</button>
                                    <button onclick="exportDataExcel(pmDataArray,'Profit_Margin_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">ðŸ“¥ Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="pmTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Product</th><th>Qty Sold</th><th>Revenue (â‚¹)</th><th>Cost (â‚¹)</th><th>Profit (â‚¹)</th><th>Margin %</th></tr></thead>
                                    <tbody id="pmTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reportResultArea" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap;">
                        <div class="report-stat-mini"><div class="rsm-lbl">Total Sales</div><div class="rsm-val" style="color:var(--success);" id="repTotalAmount">â‚¹ 0.00</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Items Sold</div><div class="rsm-val" style="color:var(--primary);" id="repTotalQty">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Orders</div><div class="rsm-val" style="color:var(--warning);" id="repOrderCount">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Avg Order</div><div class="rsm-val" style="color:var(--secondary);" id="repAvgOrder">â‚¹ 0.00</div></div>
                    </div>
                    <div id="reportChartWrapper" style="display:none; margin-bottom:14px;">
                        <button type="button" class="collapse-btn" onclick="toggleCollapse('reportChartCard')">ðŸ“Š Show / Hide Report Chart</button>
                        <div class="card chart-container" id="reportChartCard" style="display:none; margin-bottom:0; margin-top:10px; height:280px;">
                            <canvas id="reportChart"></canvas>
                        </div>
                    </div>
                    <div class="flex-between" style="margin-bottom:10px;">
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Report Data <span id="repDataCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                        <div>
                            <button onclick="exportAnyTable('repDataArea','Custom_Filtered_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">ðŸ“„ PDF</button>
                            <button onclick="exportDataExcel(customReportArray,'Custom_Filtered_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">ðŸ“¥ Excel</button>
                        </div>
                    </div>
                    <div class="card table-wrapper" id="repDataArea">
                        <table class="data-table" id="repMainTable">
                            <thead id="repTableHead"><tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (â‚¹)</th><th>Salesman</th></tr></thead>
                            <tbody id="repTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="view-admin" class="view">

                <!-- Admin Panel Customize Button -->
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button onclick="toggleAdminEditMode()" id="adminCustomizeBtn"
                        style="display:flex; align-items:center; gap:6px; background:var(--primary-light); border:1.5px solid rgba(99,102,241,0.3); color:var(--primary); border-radius:10px; padding:7px 14px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; transition:all 0.2s;">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
                        Customize Panel
                    </button>
                </div>

                <!-- Admin Panel Drag Edit Bar -->
                <div class="admin-panel-edit-bar" id="adminPanelEditBar">
                    <div class="edit-hint">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
                        Drag cards to reorder the panel
                    </div>
                    <button onclick="toggleAdminEditMode()" id="adminEditDoneBtn" style="background:linear-gradient(135deg,var(--primary),#6366f1); color:white; border:none; border-radius:8px; padding:5px 14px; font-size:11px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">âœ… Done</button>
                </div>

                <div class="admin-panel-area" id="adminPanelArea">

                <!-- ========== COLLAPSIBLE CARD: Backup & Restore ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-backup-card" style="border:1.5px solid rgba(16,185,129,0.35);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-backup')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="9" cy="7" r="1.5" fill="currentColor" stroke="none"/><circle cx="15" cy="7" r="1.5" fill="currentColor" stroke="none"/><circle cx="9" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="15" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="9" cy="17" r="1.5" fill="currentColor" stroke="none"/><circle cx="15" cy="17" r="1.5" fill="currentColor" stroke="none"/></svg>
                            </span>
                            ðŸ’¾ Backup &amp; Restore
                        </span>
                        <span class="collapse-arrow" id="arrow-col-backup">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-backup" style="display:none;">
                        <div class="collapse-body-inner">

                            <!-- Info note -->
                            <div style="background:rgba(16,185,129,0.07); border:1.5px solid rgba(16,185,129,0.2); border-radius:12px; padding:12px 14px; margin-bottom:16px; font-size:12px; color:#065f46; line-height:1.6;">
                                <div style="font-weight:700; font-size:13px; margin-bottom:4px;">â„¹ï¸ How it works</div>
                                <b>Backup:</b> Downloads all app data (shops, orders, products, payments, visits, etc.) as a <b>.json</b> file to your device.<br>
                                <b>Restore:</b> Upload a previously saved backup file to fully restore all data into Firestore.
                            </div>

                            <!-- BACKUP SECTION -->
                            <div style="font-size:11px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">ðŸ“¤ Create Backup</div>
                            <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:14px; margin-bottom:16px;">
                                <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px; line-height:1.5;">
                                    Backs up: <b>Shops Â· Areas Â· Products Â· Orders Â· Purchases Â· Due Entries Â· Returns Â· Shop Notes Â· Visits Â· Users</b>
                                </div>
                                <div id="backupStatusMsg" style="display:none; font-size:12px; font-weight:600; color:var(--primary); margin-bottom:10px; text-align:center;"></div>
                                <div id="backupProgressWrap" style="display:none; margin-bottom:12px;">
                                    <div style="background:var(--border); border-radius:99px; height:8px; overflow:hidden;">
                                        <div id="backupProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#10b981,#6366f1); border-radius:99px; transition:width 0.4s ease;"></div>
                                    </div>
                                    <div id="backupProgressLabel" style="font-size:11px; color:#94a3b8; margin-top:5px; text-align:center;"></div>
                                </div>
                                <button id="backupBtn" class="btn btn-success" onclick="runBackup()" style="margin-bottom:0; background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                                    ðŸ’¾ Download Backup Now
                                </button>
                            </div>

                            <!-- RESTORE SECTION -->
                            <div style="font-size:11px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">ðŸ“¥ Restore from Backup</div>
                            <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:14px;">
                                <div style="background:rgba(244,63,94,0.07); border:1.5px solid rgba(244,63,94,0.2); border-radius:10px; padding:10px 12px; margin-bottom:12px; font-size:11px; color:#be123c; font-weight:600; line-height:1.5;">
                                    âš ï¸ <b>Warning:</b> Restoring will <b>overwrite</b> existing data in all collections. This cannot be undone. Make a fresh backup first.
                                </div>
                                <label style="display:flex; align-items:center; gap:10px; background:var(--card); border:2px dashed var(--border); border-radius:12px; padding:14px; cursor:pointer; transition:border-color 0.2s; margin-bottom:12px;"
                                    id="restoreDropZone"
                                    onmouseover="this.style.borderColor='var(--primary)'"
                                    onmouseout="this.style.borderColor='var(--border)'">
                                    <span style="font-size:26px;">ðŸ“‚</span>
                                    <div>
                                        <div style="font-size:13px; font-weight:700; color:var(--text);">Select Backup File</div>
                                        <div id="restoreFileName" style="font-size:11px; color:#94a3b8; margin-top:2px;">No file selected (.json)</div>
                                    </div>
                                    <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="onRestoreFileSelected(this)">
                                </label>
                                <div id="restoreStatusMsg" style="display:none; font-size:12px; font-weight:600; color:var(--primary); margin-bottom:10px; text-align:center;"></div>
                                <div id="restoreProgressWrap" style="display:none; margin-bottom:12px;">
                                    <div style="background:var(--border); border-radius:99px; height:8px; overflow:hidden;">
                                        <div id="restoreProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#6366f1,#10b981); border-radius:99px; transition:width 0.4s ease;"></div>
                                    </div>
                                    <div id="restoreProgressLabel" style="font-size:11px; color:#94a3b8; margin-top:5px; text-align:center;"></div>
                                </div>
                                <button id="restoreBtn" class="btn" onclick="runRestore()" style="margin-bottom:0; background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 15px rgba(244,63,94,0.3);" disabled>
                                    ðŸ“¥ Restore Data
                                </button>
                            </div>

                            <!-- â•â•â• MONTH RESET SECTION â•â•â• -->
                            <div style="margin-top:20px;">
                                <div style="font-size:11px; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">ðŸ—‘ï¸ Monthly Data Reset</div>
                                <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:14px;">

                                    <!-- Info box -->
                                    <div style="background:rgba(99,102,241,0.07); border:1.5px solid rgba(99,102,241,0.18); border-radius:10px; padding:11px 13px; margin-bottom:14px; font-size:12px; color:var(--text); line-height:1.7;">
                                        <div style="font-weight:700; font-size:12px; color:var(--primary); margin-bottom:5px;">â„¹ï¸ What happens on reset:</div>
                                        âœ… <b>Selected month's orders</b> â€” permanently deleted<br>
                                        âœ… <b>Stock</b> â€” automatically restored (each deleted order returns its qty back to stock)<br>
                                        âœ… <b>Purchase history</b> â€” untouched<br>
                                        âœ… <b>Due / payment entries</b> â€” untouched<br>
                                        âœ… <b>Returns, visits, notes</b> â€” untouched<br>
                                        <span style="color:#f43f5e; font-weight:700;">âš ï¸ Always take a Backup before resetting.</span>
                                    </div>

                                    <!-- Month + Year picker -->
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                                        <div>
                                            <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ“… Month</label>
                                            <select id="resetMonth" class="input-field" style="margin-bottom:0;">
                                                <option value="0">January</option>
                                                <option value="1">February</option>
                                                <option value="2">March</option>
                                                <option value="3">April</option>
                                                <option value="4">May</option>
                                                <option value="5">June</option>
                                                <option value="6">July</option>
                                                <option value="7">August</option>
                                                <option value="8">September</option>
                                                <option value="9">October</option>
                                                <option value="10">November</option>
                                                <option value="11">December</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ“† Year</label>
                                            <select id="resetYear" class="input-field" style="margin-bottom:0;" id="resetYear"></select>
                                        </div>
                                    </div>

                                    <!-- Preview button -->
                                    <button class="btn btn-outline" onclick="previewMonthReset()" style="margin-bottom:10px;">
                                        ðŸ” Preview â€” Check Orders
                                    </button>

                                    <!-- Preview result box -->
                                    <div id="resetPreviewBox" style="display:none; background:var(--card); border:1.5px solid var(--border); border-radius:10px; padding:12px; margin-bottom:12px; font-size:12px; line-height:1.8;"></div>

                                    <!-- Progress -->
                                    <div id="resetProgressWrap" style="display:none; margin-bottom:12px;">
                                        <div style="background:var(--border); border-radius:99px; height:8px; overflow:hidden;">
                                            <div id="resetProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#f43f5e,#f59e0b); border-radius:99px; transition:width 0.35s ease;"></div>
                                        </div>
                                        <div id="resetProgressLabel" style="font-size:11px; color:#94a3b8; margin-top:5px; text-align:center;"></div>
                                    </div>

                                    <!-- Reset button -->
                                    <button id="resetBtn" class="btn" onclick="runMonthReset()"
                                        style="margin-bottom:0; background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 15px rgba(245,158,11,0.3);" disabled>
                                        ðŸ—‘ï¸ Reset Selected Month
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Brand / Invoice Settings ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-brand-card" style="border:1.5px solid rgba(99,102,241,0.3);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-brand')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸŽ¨ Bill / Invoice Settings
                        </span>
                        <span class="collapse-arrow" id="arrow-col-brand">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-brand" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Set the Company Name and Logo that will appear on all invoices.</p>

                        <!-- Company Name -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">ðŸ¢ Company / Brand Name</label>
                        <input type="text" id="brandNameInput" class="input-field" placeholder="e.g. My Company Ltd." value="Order With Me">

                        <!-- Logo upload -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">ðŸ–¼ï¸ Brand Logo (PNG / JPG)</label>
                        <div id="logoDropZone" onclick="document.getElementById('logoFileInput').click()"
                            style="border:2px dashed rgba(99,102,241,0.4); border-radius:14px; padding:20px; text-align:center; cursor:pointer; background:var(--bg); transition:border-color 0.2s, background 0.2s; margin-bottom:12px;"
                            ondragover="event.preventDefault(); this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'"
                            ondragleave="this.style.borderColor='rgba(99,102,241,0.4)'; this.style.background='var(--bg)'"
                            ondrop="handleLogoDrop(event)">
                            <div id="logoPreviewArea">
                                <div style="font-size:28px; margin-bottom:6px;">ðŸ–¼ï¸</div>
                                <div style="font-size:13px; font-weight:600; color:#64748b;">Click or drag logo here</div>
                                <div style="font-size:11px; color:#94a3b8; margin-top:3px;">PNG, JPG, SVG â€” max 2MB</div>
                            </div>
                        </div>
                        <input type="file" id="logoFileInput" accept="image/*" style="display:none;" onchange="handleLogoFile(this.files[0])">

                        <!-- Current logo preview -->
                        <div id="currentLogoPreview" style="display:none; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; display:flex; align-items:center; gap:12px;">
                            <img id="currentLogoImg" src="" style="max-height:50px; max-width:130px; object-fit:contain; border-radius:6px;">
                            <div style="flex:1;">
                                <div style="font-size:12px; font-weight:700; color:var(--text);">Logo set âœ…</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Will appear at the top of every bill</div>
                            </div>
                            <button onclick="removeLogo()" style="background:rgba(244,63,94,0.1); color:var(--danger); border:1px solid rgba(244,63,94,0.3); border-radius:8px; padding:5px 10px; font-size:11px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">ðŸ—‘ï¸ Remove</button>
                        </div>

                        <!-- Footer note -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">ðŸ“ Bill Footer Note (optional)</label>
                        <input type="text" id="brandFooterInput" class="input-field" placeholder="e.g. GST No: 27XXXXX | Returns within 7 days">

                        <button class="btn btn-success" onclick="saveBrandSettings()" style="margin-bottom:0; background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 15px rgba(16,185,129,0.3);">ðŸ’¾ Save Invoice Settings</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Offline Sync ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-offline-card" style="border:1.5px solid rgba(245,158,11,0.3);" id="offlineSyncCardWrap">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-offline')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ“µ Offline Sync Queue <span id="offlineBadgeMgr" style="background:#f59e0b; color:white; border-radius:20px; padding:1px 9px; font-size:11px; margin-left:6px;"></span>
                        </span>
                        <span class="collapse-arrow" id="arrow-col-offline">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-offline" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">Orders placed while offline are stored here. Connect to the internet and sync manually.</p>
                        <div id="offlineQueueList"><div style="color:#64748b; font-size:13px;">No pending orders.</div></div>
                        <button class="btn btn-outline" onclick="manualSync()" style="margin-top:12px; margin-bottom:0;">ðŸ”„ Sync Now</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 1: Daily Password ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-daily-card">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-daily')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ” Daily Registration Password
                        </span>
                        <span class="collapse-arrow" id="arrow-col-daily">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-daily" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">A new password is generated every day.</p>
                        <div id="passLockedView">
                            <div class="pass-locked-msg"><span class="lock-icon">ðŸ”’</span>Enter Master password to view today's password</div>
                            <div class="master-unlock">
                                <input type="password" id="masterPassInput" class="input-field" placeholder="Master Password..." onkeydown="if(event.key==='Enter') unlockDailyPass()">
                                <button class="btn btn-outline" onclick="unlockDailyPass()" style="width:auto;">Unlock ðŸ”“</button>
                            </div>
                        </div>
                        <div id="passUnlockedView" style="display:none;">
                            <div class="pass-display" id="dailyPassDisplay">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
                            <div class="pass-validity">âœ… Valid for today only &nbsp;|&nbsp; ðŸ“… <span id="passValidDate"></span></div>
                            <button class="btn btn-outline" onclick="copyDailyPass()" style="margin-top:12px; margin-bottom:0;">ðŸ“‹ Copy Password</button>
                            <button class="btn" onclick="lockDailyPass()" style="margin-top:8px; margin-bottom:0; background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 15px rgba(244,63,94,0.3); font-size:12px; padding:10px;">ðŸ”’ Lock Again</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Area Management ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-area-card" style="border:1.5px solid rgba(245,158,11,0.35);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-area')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ—ºï¸ Manage Areas / Zones
                        </span>
                        <span class="collapse-arrow" id="arrow-col-area">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-area" style="display:none;">
                        <div class="collapse-body-inner">
                            <p style="font-size:11px; color:#64748b; margin:0 0 14px 0;">Create areas here. When adding or editing a shop, a dropdown will appear from this list.</p>

                            <!-- Add Area Input -->
                            <div style="display:flex; gap:8px; margin-bottom:14px;">
                                <input type="text" id="newAreaInput" class="input-field"
                                    placeholder="New Area name (e.g. North, City Center)"
                                    style="margin-bottom:0; flex:1;"
                                    onkeydown="if(event.key==='Enter') addArea()">
                                <button onclick="addArea()" style="
                                    background:linear-gradient(135deg,#f59e0b,#d97706);
                                    color:white; border:none; border-radius:12px;
                                    padding:11px 18px; font-weight:700; font-size:13px;
                                    font-family:'Poppins',sans-serif; cursor:pointer;
                                    white-space:nowrap; box-shadow:0 4px 12px rgba(245,158,11,0.3);
                                    transition:transform 0.15s, box-shadow 0.15s;"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 18px rgba(245,158,11,0.4)'"
                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'">
                                    ï¼‹ Add
                                </button>
                            </div>

                            <!-- Area List -->
                            <div id="areaListContainer">
                                <div style="text-align:center; color:#94a3b8; font-size:13px; padding:14px;">Loading areas...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 2: Add/Manage Shop ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-shop-card">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-shop')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸª Add / Manage Shop
                        </span>
                        <span class="collapse-arrow" id="arrow-col-shop">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-shop" style="display:none;">
                        <input type="text" id="shopName" class="input-field" placeholder="Shop Name">
                        <input type="tel" id="shopPhone" class="input-field" placeholder="Phone Number">
                        <input type="text" id="shopAddr" class="input-field" placeholder="Address">
                        <div style="margin-bottom:12px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">ðŸ—ºï¸ Area / Zone</label>
                            <select id="shopArea" class="input-field" style="margin-bottom:0;">
                                <option value="">-- Select Area --</option>
                            </select>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">ðŸ‘¤ Shop Created By (Salesman)</label>
                            <select id="shopCreatedBy" class="input-field" style="margin-bottom:0;">
                                <option value="">-- Select Salesman --</option>
                            </select>
                            <div style="font-size:11px; color:#94a3b8; margin-top:4px;">This salesman created the shop â€” used for incentive calculation.</div>
                        </div>
                        <button class="btn btn-outline" onclick="addShop()">Save Shop</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Shop List ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-shoplist-card" style="border:1.5px solid rgba(16,185,129,0.3);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-shoplist')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ“‹ Shop List <span id="shopListCountBadge" style="background:var(--success); color:white; border-radius:20px; padding:1px 9px; font-size:11px; margin-left:6px;"></span>
                        </span>
                        <span class="collapse-arrow" id="arrow-col-shoplist">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-shoplist" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">All registered shops. Manager can edit the Shop Maker (Creator) name.</p>
                        <input type="text" id="shopListSearch" class="input-field" placeholder="ðŸ” Search shop name..." oninput="renderShopList()" style="margin-bottom:10px;">
                        <div id="shopListContainer">
                            <div style="text-align:center; color:#64748b; font-size:13px; padding:16px;">Loading shops...</div>
                        </div>
                    </div>
                </div>

                <!-- Edit Shop Full Modal -->
                <div id="editShopMakerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:5000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px);">
                    <div style="background:var(--card); border-radius:22px; padding:24px; width:100%; max-width:400px; box-shadow:0 24px 64px rgba(0,0,0,0.28); border:1px solid var(--border); max-height:90vh; overflow-y:auto;">
                        <!-- Header -->
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;">
                            <div>
                                <div style="font-size:17px; font-weight:800; color:var(--text);">âœï¸ Edit Shop</div>
                                <div id="editShopOrigName" style="font-size:12px; color:#64748b; margin-top:2px;"></div>
                            </div>
                            <button onclick="closeEditShopMaker()" style="background:var(--bg); border:1px solid var(--border); border-radius:10px; width:32px; height:32px; font-size:16px; cursor:pointer; color:var(--text); display:flex; align-items:center; justify-content:center;">âœ•</button>
                        </div>

                        <input type="hidden" id="editShopMakerShopId">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸª Shop Name</label>
                        <input type="text" id="editShopNameInput" class="input-field" placeholder="Shop name...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ“ž Phone Number</label>
                        <input type="tel" id="editShopPhoneInput" class="input-field" placeholder="Phone number...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ“ Address</label>
                        <input type="text" id="editShopAddrInput" class="input-field" placeholder="Address...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ—ºï¸ Area / Zone</label>
                        <select id="editShopAreaInput" class="input-field">
                            <option value="">-- Select Area --</option>
                        </select>

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">ðŸ‘¤ Shop Maker / Creator</label>
                        <input type="text" id="editShopMakerInput" class="input-field" placeholder="Creator name..." list="editShopMakerList">
                        <datalist id="editShopMakerList"></datalist>

                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button class="btn btn-success" onclick="saveShopFull()" style="margin-bottom:0; flex:2;">ðŸ’¾ Save Changes</button>
                            <button class="btn btn-outline" onclick="closeEditShopMaker()" style="margin-bottom:0; flex:1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 3: Add/Refill Product ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-product-card">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-product')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ“¦ Add / Refill Product
                        </span>
                        <span class="collapse-arrow" id="arrow-col-product">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-product" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">This will automatically record in Purchase History.</p>
                        <input type="text" id="prodName" class="input-field" placeholder="Product Name" list="adminProductList">
                        <datalist id="adminProductList"></datalist>
                        <div class="flex-between">
                            <input type="number" id="prodStock" class="input-field" placeholder="New Stock (+)">
                            <input type="number" id="prodPrice" class="input-field" placeholder="Price (â‚¹)">
                        </div>
                        <input type="text" id="purchaseInfo" class="input-field" placeholder="Dealer/Bill Info">
                        <input type="number" id="prodCostPrice" class="input-field" placeholder="Cost Price (â‚¹)">
                        <button class="btn btn-outline" onclick="addProduct()">Save & Log Purchase</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 4: User Management ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-users-card" style="border:1.5px solid rgba(99,102,241,0.25);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-users')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ‘¥ User Management
                        </span>
                        <span class="collapse-arrow" id="arrow-col-users">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-users" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Manage user accounts â€” reset passwords, view credentials, or delete accounts.</p>
                        <div id="userListContainer">
                            <div style="text-align:center; color:#64748b; font-size:13px; padding:12px;">Loading users...</div>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 5: Delete Shop / Product ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-delete-card" style="border:1.5px solid rgba(244,63,94,0.25);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-delete')" style="color:var(--danger);">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ—‘ï¸ Delete Shop / Product
                        </span>
                        <span class="collapse-arrow" id="arrow-col-delete">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-delete" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">Careful: This action cannot be undone.</p>
                        <div class="flex-between">
                            <select id="delShopSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Shop to Delete --</option></select>
                            <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteShop()">Delete</button>
                        </div>
                        <div class="flex-between" style="margin-top:14px;">
                            <select id="delItemSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Item to Delete --</option></select>
                            <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteProductFromAdmin()">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 6: Incentive Calculation ========== -->
                <div class="collapse-card admin-draggable" data-admin-id="col-incentive-card" style="border:1.5px solid rgba(245,158,11,0.35);">
                    <div class="collapse-header" onclick="handleAdminHeaderClick(event,'col-incentive-calc')">
                        <span style="display:flex;align-items:center;gap:6px;">
                            <span class="admin-drag-handle" title="Drag to reorder" onclick="event.stopPropagation()"><svg width="13" height="13" viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="1.5" fill="currentColor"/><circle cx="15" cy="7" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="17" r="1.5" fill="currentColor"/><circle cx="15" cy="17" r="1.5" fill="currentColor"/></svg></span>
                            ðŸ† Salesman Incentive Calculator
                        </span>
                        <span class="collapse-arrow" id="arrow-col-incentive-calc">â–¼</span>
                    </div>
                    <div class="collapse-body" id="col-incentive-calc" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Select a date range to view total incentive for each salesman.</p>

                        <!-- â”€â”€ Inline Rate Editor â”€â”€ -->
                        <div style="background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.04)); border:1.5px solid rgba(245,158,11,0.3); border-radius:14px; padding:14px; margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="font-size:12px; font-weight:800; color:#92400e; text-transform:uppercase; letter-spacing:0.5px;">âš™ï¸ Incentive Rates</div>
                                <button onclick="incSaveRatesInline()" id="incSaveRateBtn"
                                    style="background:linear-gradient(135deg,#f59e0b,#d97706); color:white; border:none; border-radius:8px;
                                           padding:5px 12px; font-size:11px; font-weight:700; cursor:pointer;
                                           font-family:'Poppins',sans-serif; transition:opacity 0.2s;"
                                    onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                                    ðŸ’¾ Save Rates
                                </button>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <!-- Shop Creator Rate -->
                                <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.25); border-radius:12px; padding:12px;">
                                    <div style="font-size:10px; font-weight:700; color:#065f46; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">ðŸª Shop Creator</div>
                                    <div style="font-size:11px; color:#64748b; margin-bottom:8px; line-height:1.4;">Applied on every billing of the shop</div>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <input type="number" id="incCalcCreatorPct"
                                            class="input-field"
                                            style="margin:0; flex:1; text-align:center; font-weight:800; font-size:20px;
                                                   color:var(--success); padding:8px; border-color:rgba(16,185,129,0.4);"
                                            min="0" max="100" step="0.1" value="1"
                                            oninput="incPreviewRates()">
                                        <span style="font-size:18px; font-weight:800; color:var(--success);">%</span>
                                    </div>
                                </div>
                                <!-- Order Taker Rate -->
                                <div style="background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:12px;">
                                    <div style="font-size:10px; font-weight:700; color:#3730a3; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">ðŸ“¦ Order Taker</div>
                                    <div style="font-size:11px; color:#64748b; margin-bottom:8px; line-height:1.4;">Applied on every order amount</div>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <input type="number" id="incCalcOrderPct"
                                            class="input-field"
                                            style="margin:0; flex:1; text-align:center; font-weight:800; font-size:20px;
                                                   color:var(--primary); padding:8px; border-color:rgba(99,102,241,0.4);"
                                            min="0" max="100" step="0.1" value="0.5"
                                            oninput="incPreviewRates()">
                                        <span style="font-size:18px; font-weight:800; color:var(--primary);">%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Live preview line -->
                            <div id="incRatePreviewLine" style="margin-top:10px; font-size:11px; color:#92400e; text-align:center; font-weight:600;"></div>
                        </div>

                        <!-- â”€â”€ Filters â”€â”€ -->
                        <div class="date-preset-grid">
                            <button class="preset-btn" onclick="incApplyPreset('week',this)">This Week</button>
                            <button class="preset-btn active-preset" onclick="incApplyPreset('month',this)">This Month</button>
                            <button class="preset-btn" onclick="incApplyPreset('lastmonth',this)">Last Month</button>
                            <button class="preset-btn" onclick="incApplyPreset('all',this)">All Time</button>
                        </div>
                        <div class="report-filter-bar" style="margin-top:8px;">
                            <input type="date" id="incStartDate" onchange="incClearPresets()">
                            <input type="date" id="incEndDate" onchange="incClearPresets()">
                        </div>
                        <div class="report-filter-bar">
                            <select id="incSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                <option value="all">All Salesmen</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn btn-success" onclick="calculateIncentive()"
                                style="margin-bottom:0; flex:2; background:linear-gradient(135deg,#f59e0b,#d97706);
                                       box-shadow:0 4px 15px rgba(245,158,11,0.3);">
                                ðŸ§® Calculate Incentive
                            </button>
                            <button class="btn btn-outline" onclick="exportDataExcel(incExportArray,'Incentive_Report')"
                                style="margin-bottom:0; flex:1;">ðŸ“¥ Excel</button>
                        </div>

                        <!-- â”€â”€ Results â”€â”€ -->
                        <div id="incResultArea" style="display:none; margin-top:16px;">
                            <div id="incRateBanner" style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.35); border-radius:10px; padding:10px 14px; font-size:12px; color:#92400e; margin-bottom:14px;"></div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--primary);" id="incTotalRevenue">â‚¹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Incentive</div><div class="rsm-val" style="color:var(--warning);" id="incTotalPayout">â‚¹ 0</div></div>
                            </div>
                            <div id="incCardsArea"></div>
                        </div>
                    </div>
                </div>

                <!-- Show Password Modal -->
                <div id="showPassModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
                    <div class="card" style="width:90%; max-width:320px; text-align:center; padding:28px; margin:0;">
                        <div style="font-size:28px; margin-bottom:8px;">ðŸ‘ï¸</div>
                        <div style="font-weight:800; font-size:16px; margin-bottom:4px;" id="showPassModalName">User</div>
                        <div style="font-size:12px; color:#64748b; margin-bottom:14px;">Current Password</div>
                        <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:12px; padding:14px; font-size:18px; font-weight:800; letter-spacing:2px; color:var(--primary); word-break:break-all;" id="showPassModalPass">â€”</div>
                        <button class="btn btn-outline" onclick="closeShowPassModal()" style="margin-top:14px; margin-bottom:0;">Close</button>
                    </div>
                </div>

                <!-- Reset Password Modal -->
                <div id="resetPassModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
                    <div class="card" style="width:90%; max-width:340px; text-align:center; padding:28px; margin:0;">
                        <div style="font-size:28px; margin-bottom:8px;">ðŸ”‘</div>
                        <div style="font-weight:800; font-size:16px; margin-bottom:4px;" id="resetModalTitle">Password Reset</div>
                        <div style="font-size:12px; color:#64748b; margin-bottom:18px;" id="resetModalSub">Enter new password</div>
                        <input type="password" id="newPassInput" class="input-field" placeholder="New Password (min 6 chars)" onkeydown="if(event.key==='Enter') confirmPasswordReset()">
                        <input type="password" id="confirmPassInput" class="input-field" placeholder="Confirm Password" onkeydown="if(event.key==='Enter') confirmPasswordReset()">
                        <div style="display:flex; gap:10px; margin-top:4px;">
                            <button class="btn btn-outline" onclick="closeResetModal()" style="flex:1; margin-bottom:0;">Cancel</button>
                            <button class="btn btn-success" onclick="confirmPasswordReset()" id="btnConfirmReset" style="flex:1; margin-bottom:0;">âœ… Reset</button>
                        </div>
                    </div>
                </div>

                </div><!-- end adminPanelArea -->
            </div>

            <!-- DUE / CREDIT VIEW -->
            <div id="view-due" class="view">
                <div class="card mgr-due-add" style="display:none; border:1.5px solid rgba(16,185,129,0.3);">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">ðŸ’³ Record Payment</div>
                    <p style="font-size:11px; color:#64748b; margin-top:0; margin-bottom:14px;">Selecting a shop will automatically show the total bill and balance.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="dueShopSel" class="input-field" onchange="onDueShopChange()" style="margin-top:6px;"><option value="">-- Select Shop --</option></select>
                    <div id="dueShopBillSummary" style="display:none; background:var(--bg); border-radius:14px; padding:16px; margin-bottom:14px; border:1px solid var(--border);">
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">ðŸ“¦ Total Orders Amount</span><span id="dueShopTotalBill" style="font-weight:700; color:var(--text);">â‚¹ 0.00</span></div>
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">âœ… Total Paid</span><span id="dueShopTotalPaid" style="font-weight:700; color:var(--success);">â‚¹ 0.00</span></div>
                        <div class="due-progress-wrap"><div id="dueShopProgressBar" class="due-progress-bar" style="width:0%; background:var(--danger);"></div></div>
                        <div class="due-total-row"><span>ðŸ”´ Remaining Due</span><span id="dueShopRemaining" style="color:var(--danger); font-size:18px;">â‚¹ 0.00</span></div>
                    </div>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Payment Amount (â‚¹)</label>
                    <input type="number" id="duePayAmt" class="input-field" placeholder="How much did they pay?" style="margin-top:6px;">
                    <input type="text" id="dueNote" class="input-field" placeholder="Note (optional)">
                    <button class="btn btn-success" onclick="saveDueEntry()" style="margin-bottom:0;">ðŸ’° Save Payment</button>
                </div>
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">ðŸ’³ Due / Credit Tracker</h3>
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#64748b;">Total Remaining Due</div>
                            <div id="totalDueAmt" style="font-size:20px; font-weight:800; color:var(--danger);">â‚¹ 0.00</div>
                        </div>
                        <button onclick="exportDuePDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap;">ðŸ“„ All Shops PDF</button>
                        <button onclick="exportDuePerShopPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid #10b981; background:transparent; color:#10b981; font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; margin-left:6px;">ðŸ“„ Per Shop PDF</button>
                    </div>
                </div>
                <div id="dueListArea"><div style="text-align:center; padding:40px; color:#64748b;">Loading...</div></div>
                <div id="due-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- RETURNS â€” MANAGER ONLY -->
            <div id="view-returns" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">â†©ï¸ Process Return / Refund</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Select an order, then choose which items to return. Stock will be restored automatically.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Select Original Order</label>
                    <select id="returnOrderSel" class="input-field" onchange="loadReturnItems()" style="margin-top:6px;"><option value="">-- Select Order --</option></select>
                    <div id="returnItemsArea" style="display:none; margin-top:10px;">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Select Items to Return</div>
                        <div id="returnItemsList"></div>
                        <input type="text" id="returnReason" class="input-field" placeholder="Return reason (optional)" style="margin-top:10px;">
                        <button class="btn" style="background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 15px rgba(245,158,11,0.3); margin-top:4px;" onclick="processReturn()">â†©ï¸ Process Return</button>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Return History</h3>
                    <button onclick="exportReturnsPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">ðŸ“„ PDF</button>
                </div>
                <div id="returnHistoryList"><div style="text-align:center; padding:20px; color:#64748b;">No returns yet.</div></div>
                <div id="returns-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SALESMAN PERFORMANCE -->
            <div id="view-salesman-perf" class="view">
                <div class="flex-between" style="margin-bottom:6px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">ðŸ… Salesman Performance</h3>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="preset-btn active-preset" onclick="setPerfPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPerfPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPerfPeriod('week',this)">This Week</button>
                        <button class="preset-btn" onclick="setPerfPeriod('today',this)">Today</button>
                    </div>
                </div>
                <div id="perfSummaryCards" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;"></div>
                <div id="perfLeaderboard"></div>
                <div id="perfChartWrapper" style="display:none; margin-top:14px;">
                    <div class="card">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Comparison Chart</div>
                        <div style="position:relative; height:220px;"><canvas id="perfChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- P&L -->
            <div id="view-pnl" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">ðŸ“Š Profit &amp; Loss Statement</h3>
                </div>
                <div class="card" style="padding:14px; margin-bottom:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="preset-btn active-preset" onclick="setPnlPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPnlPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('lastmonth',this)">Last Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('week',this)">This Week</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="date" id="pnlStart" class="input-field" style="margin-bottom:0;">
                        <input type="date" id="pnlEnd" class="input-field" style="margin-bottom:0;">
                    </div>
                    <button class="btn btn-success" onclick="generatePnl()" style="margin-top:10px; margin-bottom:0;">Calculate P&amp;L</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                    <div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">ðŸ’°</span><div class="dc-lbl">Total Revenue</div><div class="dc-val" id="pnlRevenue">â‚¹ 0.00</div></div>
                    <div class="dash-card dc-alert" style="cursor:default;"><span class="dc-icon">ðŸ“‰</span><div class="dc-lbl">Total Cost</div><div class="dc-val" id="pnlCost">â‚¹ 0.00</div></div>
                    <div class="dash-card dc-orders" style="cursor:default; grid-column:1/-1;"><span class="dc-icon">ðŸ†</span><div class="dc-lbl">Net Profit / Loss</div><div class="dc-val" id="pnlNet">â‚¹ 0.00</div></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; font-size:14px; margin-bottom:14px; color:var(--text);">Detailed Breakdown</div>
                    <div class="pnl-row"><span>ðŸ“¦ Total Items Sold (Qty)</span><span id="pnlQty" style="font-weight:700;">0</span></div>
                    <div class="pnl-row"><span>ðŸ§¾ Revenue from Sales</span><span id="pnlRevDetail" style="color:var(--success); font-weight:700;">â‚¹ 0.00</span></div>
                    <div class="pnl-row"><span>ðŸ“‰ Cost of Goods Sold</span><span id="pnlCostDetail" style="color:var(--danger); font-weight:700;">â‚¹ 0.00</span></div>
                    <div class="pnl-row"><span>â†©ï¸ Returns Deduction</span><span id="pnlReturnsDetail" style="color:var(--warning); font-weight:700;">- â‚¹ 0.00</span></div>
                    <div class="pnl-row"><span>ðŸ“Š Gross Margin %</span><span id="pnlMargin" style="font-weight:700;">0%</span></div>
                    <div class="pnl-total-row"><span>ðŸ† Net Profit / Loss</span><span id="pnlNetDetail" style="color:var(--primary);">â‚¹ 0.00</span></div>
                </div>
                <div class="card" style="margin-top:0;">
                    <div style="font-weight:700; font-size:14px; margin-bottom:12px;">Top Items by Profit</div>
                    <div id="pnlTopItems"></div>
                </div>
            </div>

            <!-- SHOP VISITS -->
            <div id="view-visits" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:12px;">ðŸ“ Log Shop Visit</div>
                    <select id="visitShopSel" class="input-field"><option value="">-- Select Shop Visited --</option></select>
                    <input type="text" id="visitNote" class="input-field" placeholder="Notes (e.g., new order placed, shop closed...)">
                    <button class="btn btn-success" onclick="logVisit()" style="margin-bottom:0;">ðŸ“ Log Visit</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <button class="preset-btn active-preset" onclick="setVisitFilter('all',this)">All Visits</button>
                        <button class="preset-btn" onclick="setVisitFilter('today',this)">Today</button>
                        <button class="preset-btn" onclick="setVisitFilter('week',this)">This Week</button>
                        <select id="visitSalesmanFilter" class="input-field" onchange="renderVisits()" style="margin-bottom:0; flex:1; padding:7px 10px; min-width:120px;"><option value="all">All Salesmen</option></select>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Visit Log <span id="visitCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="exportVisitsPDF()" style="padding:5px 10px; border-radius:8px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">ðŸ“„ PDF</button>
                        <button onclick="exportDataExcel(visitExportArray,'Shop_Visit_Log')" class="btn-success" style="padding:5px 10px; border:none; color:white; font-family:inherit; cursor:pointer; border-radius:8px; font-size:12px;">ðŸ“¥ Excel</button>
                    </div>
                </div>
                <div id="visitListArea"><div style="text-align:center; padding:20px; color:#64748b;">No visits logged yet.</div></div>
                <div id="visits-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SHOP NOTES -->
            <div id="view-shop-notes" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">ðŸ“ Add Shop Note / Remark</div>
                    <p style="font-size:11px; color:#64748b; margin:0 0 12px;">Notes are visible to the whole team.</p>
                    <select id="noteShopSel" class="input-field" style="margin-bottom:10px;"><option value="">-- Select Shop --</option></select>
                    <select id="noteTag" class="input-field" style="margin-bottom:10px;">
                        <option value="general">ðŸ“Œ General Remark</option>
                        <option value="payment">ðŸ’° Payment Reminder</option>
                        <option value="closed">ðŸš« Shop Closed Info</option>
                        <option value="complaint">âš ï¸ Complaint / Issue</option>
                        <option value="preference">â­ Customer Preference</option>
                    </select>
                    <textarea id="noteText" class="input-field" placeholder="Write your note here..." rows="3" style="resize:vertical; min-height:70px;"></textarea>
                    <button class="btn btn-success" onclick="saveShopNote()" style="margin-bottom:0;">ðŸ’¾ Save Note</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <select id="noteFilterShop" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;"><option value="all">All Shops</option></select>
                        <select id="noteFilterTag" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;">
                            <option value="all">All Types</option>
                            <option value="general">ðŸ“Œ General</option>
                            <option value="payment">ðŸ’° Payment</option>
                            <option value="closed">ðŸš« Closed Info</option>
                            <option value="complaint">âš ï¸ Complaint</option>
                            <option value="preference">â­ Preference</option>
                        </select>
                    </div>
                    <div id="shopNotesArea"><div style="text-align:center; padding:20px; color:#64748b;">No notes yet.</div></div>
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="view-attendance" class="view">

                <!-- â”€â”€ Take Today's Attendance â”€â”€ -->
                <div class="collapse-card" style="border:1.5px solid rgba(16,185,129,0.35);">
                    <div class="collapse-header" onclick="toggleCollapse('att-take')">
                        <span style="display:flex;align-items:center;gap:8px;">
                            ðŸ—“ï¸ <span>Take Attendance</span>
                            <span id="attTodayBadge" style="background:var(--success);color:white;border-radius:20px;padding:1px 9px;font-size:11px;"></span>
                        </span>
                        <span class="collapse-arrow" id="arrow-att-take">â–¼</span>
                    </div>
                    <div class="collapse-body" id="att-take" style="display:none;">
                        <p style="font-size:11px;color:#64748b;margin:0 0 12px;">Mark attendance for all salesmen. Changes are saved directly to Firestore.</p>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
                            <div id="attDateLabel" style="font-size:13px;font-weight:700;color:var(--primary);"></div>
                            <input type="date" id="attDatePicker" class="input-field" style="margin:0;width:auto;padding:8px 12px;font-size:12px;" onchange="loadAttendanceForDate()">
                        </div>
                        <div id="attSalesmanGrid" style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
                            <div style="text-align:center;color:#64748b;font-size:13px;padding:16px;">Loading salesmen...</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-success" onclick="saveAttendance()" style="margin-bottom:0;flex:2;background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 4px 15px rgba(16,185,129,0.3);">ðŸ’¾ Save Attendance</button>
                            <button class="btn btn-outline" onclick="attMarkAll('present')" style="margin-bottom:0;flex:1;font-size:12px;">âœ… All Present</button>
                            <button class="btn btn-outline" onclick="attMarkAll('absent')" style="margin-bottom:0;flex:1;font-size:12px;border-color:var(--danger);color:var(--danger);">âŒ All Absent</button>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ Attendance Report â”€â”€ -->
                <div class="collapse-card" style="border:1.5px solid rgba(99,102,241,0.3);">
                    <div class="collapse-header" onclick="toggleCollapse('att-report')">
                        <span>ðŸ“Š Attendance Report</span>
                        <span class="collapse-arrow" id="arrow-att-report">â–¼</span>
                    </div>
                    <div class="collapse-body" id="att-report" style="display:none;">
                        <!-- Filters -->
                        <div class="date-preset-grid" style="margin-top:10px;">
                            <button class="preset-btn" onclick="attReportPreset('week',this)">This Week</button>
                            <button class="preset-btn active-preset" onclick="attReportPreset('month',this)">This Month</button>
                            <button class="preset-btn" onclick="attReportPreset('lastmonth',this)">Last Month</button>
                            <button class="preset-btn" onclick="attReportPreset('all',this)">All Time</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
                            <input type="date" id="attRepStart" class="input-field" style="margin:0;flex:1;min-width:130px;" onchange="clearAttPresets()">
                            <input type="date" id="attRepEnd"   class="input-field" style="margin:0;flex:1;min-width:130px;" onchange="clearAttPresets()">
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                            <select id="attRepSalesman" class="input-field" style="margin:0;flex:1;">
                                <option value="all">All Salesmen</option>
                            </select>
                            <button class="btn btn-success" onclick="generateAttReport()" style="margin:0;flex:1;background:linear-gradient(135deg,#6366f1,#4f46e5);box-shadow:0 4px 14px rgba(99,102,241,0.3);">
                                ðŸ“Š Generate Report
                            </button>
                        </div>

                        <!-- Stats summary -->
                        <div id="attRepStats" style="display:none;margin-top:16px;">
                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Working Days</div><div class="rsm-val" style="color:var(--primary);" id="attStatDays">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Present</div><div class="rsm-val" style="color:var(--success);" id="attStatPresent">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Absent</div><div class="rsm-val" style="color:var(--danger);" id="attStatAbsent">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Avg Attendance</div><div class="rsm-val" style="color:var(--warning);" id="attStatAvg">0%</div></div>
                            </div>

                            <!-- Charts -->
                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-bar')">
                                    <span>ðŸ“Š Salesman-wise Bar Chart</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-bar">â–¼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-bar" style="display:none;">
                                    <div class="chart-container" style="height:260px;margin-top:12px;">
                                        <canvas id="attBarChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-pie')">
                                    <span>ðŸ© Overall Present vs Absent</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-pie">â–¼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-pie" style="display:none;">
                                    <div class="chart-container" style="height:240px;margin-top:12px;">
                                        <canvas id="attPieChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-trend')">
                                    <span>ðŸ“ˆ Daily Trend (Line Chart)</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-trend">â–¼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-trend" style="display:none;">
                                    <div class="chart-container" style="height:240px;margin-top:12px;">
                                        <canvas id="attLineChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Per-salesman table -->
                            <div class="collapse-card">
                                <div class="collapse-header" onclick="toggleCollapse('att-table')">
                                    <span>ðŸ“‹ Detailed Table</span>
                                    <span class="collapse-arrow" id="arrow-att-table">â–¼</span>
                                </div>
                                <div class="collapse-body" id="att-table" style="display:none;">
                                    <div style="display:flex;gap:8px;margin-bottom:10px;margin-top:8px;">
                                        <button class="btn btn-outline" onclick="exportAttExcel()" style="margin:0;flex:1;font-size:12px;">ðŸ“¥ Excel</button>
                                        <button class="btn btn-outline" onclick="exportAttPDF()" style="margin:0;flex:1;font-size:12px;">ðŸ“„ PDF</button>
                                    </div>
                                    <div class="table-wrapper">
                                        <table class="data-table" id="attDetailTable">
                                            <thead>
                                                <tr>
                                                    <th>Salesman</th>
                                                    <th>Present</th>
                                                    <th>Absent</th>
                                                    <th>Half Day</th>
                                                    <th>Leave</th>
                                                    <th>Total Days</th>
                                                    <th>Attendance %</th>
                                                </tr>
                                            </thead>
                                            <tbody id="attDetailBody"></tbody>
                                        </table>
                                    </div>
                                    <!-- Daily breakdown -->
                                    <div id="attDailyBreakdown" style="margin-top:14px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDRm8zdyHdYmaXm5o34GTV3uYkrMPfVfGI",
            authDomain: "order-with-me-636dd.firebaseapp.com",
            projectId: "order-with-me-636dd",
            storageBucket: "order-with-me-636dd.firebasestorage.app",
            messagingSenderId: "437851738821",
            appId: "1:437851738821:web:d923816bfd764793db96ac"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let userData = {}, cart = [], historyData = [];
        let globalShops = {};
        let globalAreas = []; // Firestore areas collection cache
        let stockDataArray = [], salesDataArray = [], purchaseDataArray = [], customReportArray = [], paymentReportArray = [];
        let productsMap = {};
        let dashSalesChartInstance = null, dashItemChartInstance = null, reportChartInstance = null, perfChartInstance = null;
        let currentSortOption = 'date-desc';
        let currentGroupOption = 'none';
        let allVisitsData = [], visitFilterPeriod = 'all', visitExportArray = [];
        let allDueData = {}, allReturnsData = [];
        let perfPeriod = 'all', pnlPeriod = 'all';
        let menuEditMode = false;
        let dragSrcEl = null;
        let dragSrcIdx = -1;

        // ===== UNDO SYSTEM =====
        let undoStack = [];  // {type, data, execute}
        let undoTimer = null;
        let undoRingTimer = null;
        const UNDO_DURATION = 5000;

        function pushUndo(label, undoFn) {
            clearUndoTimer();
            undoStack.push({ label, undoFn });
            const msgEl = document.getElementById('undo-msg');
            msgEl.innerHTML = `<span class="undo-label">Deleted</span>${label}`;
            const bar = document.getElementById('undo-bar');
            bar.classList.add('visible');
            const ring = document.getElementById('undo-ring');
            ring.style.transition = 'none';
            ring.style.strokeDashoffset = '0';
            requestAnimationFrame(() => {
                ring.style.transition = `stroke-dashoffset ${UNDO_DURATION}ms linear`;
                ring.style.strokeDashoffset = '72';
            });
            undoTimer = setTimeout(() => {
                dismissUndo();
            }, UNDO_DURATION);
        }

        function clearUndoTimer() {
            if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
        }

        function dismissUndo() {
            clearUndoTimer();
            undoStack = [];
            document.getElementById('undo-bar').classList.remove('visible');
        }

        async function executeUndo() {
            clearUndoTimer();
            document.getElementById('undo-bar').classList.remove('visible');
            if (!undoStack.length) return;
            const item = undoStack.pop();
            try {
                await item.undoFn();
                toast('â†© ' + item.label + ' â€” Undone!', 'success');
            } catch(e) {
                toast('Undo failed: ' + e.message, 'error');
            }
            undoStack = [];
        }

        // ===== MENU CONFIGURATION =====
        // FIX: Returns is now manager-only
        const DEFAULT_MENU_ITEMS = [
            { id: 'dashboard', label: 'ðŸ“Š Dashboard', view: 'dashboard', roles: ['salesman','manager'], always: true },
            { id: 'order', label: 'ðŸ›’ Order Panel', view: 'order', roles: ['salesman','manager'], always: true },
            { id: 'history', label: 'ðŸ“œ All Orders', view: 'history', roles: ['salesman','manager'], always: true },
            { id: 'billing', label: 'ðŸ§¾ Billing & Invoice', view: 'billing', roles: ['manager'] },
            { id: 'quotation', label: 'ðŸ“‹ Quotation Builder', view: 'quotation', roles: ['manager'] },
            { id: 'sep1', type: 'separator', label: 'Business Ledgers' },
            { id: 'stock', label: 'ðŸ“¦ Current Stock', view: 'stock', roles: ['salesman','manager'], always: true },
            { id: 'sales', label: 'ðŸ’° Sales Ledger', view: 'sales', roles: ['manager'] },
            { id: 'purchase', label: 'ðŸ“‰ Purchase History', view: 'purchase', roles: ['manager'] },
            { id: 'reports', label: 'ðŸ“ˆ Custom Reports', view: 'reports', roles: ['manager'] },
            { id: 'due', label: 'ðŸ’³ Due / Credit', view: 'due', roles: ['manager'] },
            { id: 'returns', label: 'â†©ï¸ Returns', view: 'returns', roles: ['manager'] },  // FIXED: manager only
            { id: 'salesman-perf', label: 'ðŸ… Salesman Performance', view: 'salesman-perf', roles: ['manager'] },
            { id: 'pnl', label: 'ðŸ“Š P&L Statement', view: 'pnl', roles: ['manager'] },
            { id: 'visits', label: 'ðŸ“ Shop Visits', view: 'visits', roles: ['salesman','manager'], always: true },
            { id: 'shop-notes', label: 'ðŸ“ Shop Notes', view: 'shop-notes', roles: ['salesman','manager'], always: true },
            { id: 'attendance', label: 'ðŸ—“ï¸ Attendance', view: 'attendance', roles: ['manager'], },
            { id: 'sep2', type: 'separator', label: '' },
            { id: 'admin', label: 'âš™ï¸ Manager Panel', view: 'admin', roles: ['manager'], special: true },
        ];
        let menuConfig = null;

        // ===== QUICK ACCESS â€” Feature Usage Tracking =====
        const USAGE_KEY = 'owm_feature_usage_';
        const QUICK_ACCESS_MENU = [
            { id:'order',         label:'ðŸ›’ New Order',        icon:'ðŸ›’' },
            { id:'history',       label:'ðŸ“‹ History',           icon:'ðŸ“‹' },
            { id:'billing',       label:'ðŸ§¾ Billing',           icon:'ðŸ§¾' },
            { id:'stock',         label:'ðŸ“¦ Stock',             icon:'ðŸ“¦' },
            { id:'reports',       label:'ðŸ“Š Reports',           icon:'ðŸ“Š' },
            { id:'due',           label:'ðŸ’³ Due/Credit',        icon:'ðŸ’³' },
            { id:'returns',       label:'â†©ï¸ Returns',           icon:'â†©ï¸' },
            { id:'salesman-perf', label:'ðŸ… Performance',       icon:'ðŸ…' },
            { id:'pnl',           label:'ðŸ“ˆ P&L',               icon:'ðŸ“ˆ' },
            { id:'visits',        label:'ðŸ“ Shop Visits',       icon:'ðŸ“' },
            { id:'admin',         label:'âš™ï¸ Manager Panel',     icon:'âš™ï¸' },
            { id:'shops',         label:'ðŸª Shops',             icon:'ðŸª' },
            { id:'dashboard',     label:'ðŸ  Dashboard',         icon:'ðŸ ' },
        ];

        function _usageKey() {
            return USAGE_KEY + (userData.user || 'default');
        }

        function trackUsage(viewId) {
            if (!viewId || viewId === 'dashboard') return;
            try {
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};
                counts[viewId] = (counts[viewId] || 0) + 1;
                localStorage.setItem(_usageKey(), JSON.stringify(counts));
                // Only re-render if dashboard is currently visible
                const dash = document.getElementById('view-dashboard');
                if (dash && dash.classList.contains('active')) renderQuickAccess();
            } catch(e) {}
        }

        function renderQuickAccess() {
            const el = document.getElementById('dashQuickAccess');
            if (!el) return;
            try {
                const role = userData.role || 'salesman';
                const managerOnly = ['reports','salesman-perf','pnl','admin','shops'];
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};

                // All menu items allowed for this user role (exclude dashboard itself)
                const available = QUICK_ACCESS_MENU.filter(m => {
                    if (m.id === 'dashboard') return false;
                    return role === 'manager' || !managerOnly.includes(m.id);
                });

                // Sort by usage count desc; preserve order for zero-count ties
                const sorted = [...available].sort((a, b) => (counts[b.id] || 0) - (counts[a.id] || 0));
                const top4 = sorted.slice(0, 4);
                const hasUsage = available.some(m => (counts[m.id] || 0) > 0);
                const maxCount = hasUsage ? (counts[top4[0]?.id] || 0) : 0;

                el.innerHTML = top4.map((meta, i) => {
                    const count = counts[meta.id] || 0;
                    const isHot = hasUsage && i === 0 && count > 0;
                    const label = meta.label.replace(meta.icon, '').trim();
                    return `<button class="qa-btn" onclick="switchView('${meta.id}')" title="${label}">
                        ${isHot ? '<span class="qa-badge">ðŸ”¥</span>' : ''}
                        <span class="qa-btn-icon">${meta.icon}</span>
                        <span class="qa-btn-label">${label}</span>
                        <span class="qa-btn-count">${count > 0 ? count + ' uses' : 'tap to use'}</span>
                    </button>`;
                }).join('');

                if (!hasUsage) {
                    el.innerHTML += `<div style="font-size:10px;color:#94a3b8;text-align:center;
                        grid-column:1/-1;margin-top:2px;padding:3px 0;">
                        Updates automatically as you use the app âœ¨</div>`;
                }
            } catch(e) {
                el.innerHTML = '<div style="color:#94a3b8;font-size:12px;text-align:center;grid-column:1/-1;padding:12px;">No data yet</div>';
            }
        }



        function getMenuConfig() {
            try {
                const saved = localStorage.getItem('owm_menu_order_' + (userData.user||'default'));
                if (saved) {
                    const arr = JSON.parse(saved);
                    const existingIds = arr.map(i => i.id);
                    DEFAULT_MENU_ITEMS.forEach(def => {
                        if (!existingIds.includes(def.id)) arr.push(def);
                    });
                    // Sync roles from DEFAULT in case they changed
                    arr.forEach(item => {
                        const def = DEFAULT_MENU_ITEMS.find(d => d.id === item.id);
                        if (def) item.roles = def.roles;
                    });
                    return arr;
                }
            } catch(e) {}
            return JSON.parse(JSON.stringify(DEFAULT_MENU_ITEMS));
        }

        function saveMenuConfig(config) {
            try {
                localStorage.setItem('owm_menu_order_' + (userData.user||'default'), JSON.stringify(config));
            } catch(e) {}
        }

        // ===== DRAG & DROP STATE =====
        let _dragListenersAttached = false;

        function _attachNavDragListeners() {
            // Called ONCE. The nav element never changes after this.
            const nav = document.getElementById('sidebarNavArea');
            if (!nav) return;

            nav.addEventListener('dragstart', function(e) {
                // Try from target first, then walk up
                let item = _draggableParent(e.target);
                // Fallback: if target itself has itemId (direct drag on the element)
                if (!item && e.target && e.target.dataset && e.target.dataset.itemId) item = e.target;
                if (!item) { e.preventDefault(); return; }
                dragSrcEl = item;
                dragSrcIdx = Array.from(nav.children).indexOf(item);
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setData('text/plain', item.dataset.itemId || ''); } catch(_) {}
                setTimeout(() => { if(dragSrcEl) dragSrcEl.classList.add('dragging'); }, 0);
            });

            nav.addEventListener('dragover', function(e) {
                e.preventDefault();
                const item = _draggableParent(e.target);
                if (!item || item === dragSrcEl) return;
                nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                item.classList.add('drag-over');
            });

            nav.addEventListener('dragleave', function(e) {
                if (!nav.contains(e.relatedTarget)) {
                    nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                }
            });

            nav.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dst = _draggableParent(e.target);
                if (!dragSrcEl || !dst || dragSrcEl === dst) { _clearDragState(); return; }
                const srcId = dragSrcEl.dataset.itemId;
                const dstId = dst.dataset.itemId;
                if (!srcId || !dstId || srcId === dstId) { _clearDragState(); return; }
                const si = menuConfig.findIndex(x => x.id === srcId);
                const di = menuConfig.findIndex(x => x.id === dstId);
                if (si === -1 || di === -1) { _clearDragState(); return; }
                const [moved] = menuConfig.splice(si, 1);
                menuConfig.splice(di, 0, moved);
                saveMenuConfig(menuConfig);
                _clearDragState();
                renderSidebar();
                toast('âœ… Menu reordered!', 'success');
            });

            nav.addEventListener('dragend', function(e) {
                _clearDragState();
            });

            _dragListenersAttached = true;
        }

        function _draggableParent(el) {
            // Walk up DOM to find draggable menu item
            while (el && el !== document.body) {
                if (el.dataset && el.dataset.itemId &&
                    (el.classList.contains('menu-item') || el.classList.contains('menu-section-label'))) {
                    return el;
                }
                el = el.parentElement;
            }
            return null;
        }

        function _clearDragState() {
            document.querySelectorAll('#sidebarNavArea .drag-over, #sidebarNavArea .dragging')
                .forEach(el => el.classList.remove('drag-over', 'dragging'));
            dragSrcEl = null;
        }

        function renderSidebar() {
            if (!menuConfig) menuConfig = getMenuConfig();
            const nav = document.getElementById('sidebarNavArea');
            nav.innerHTML = '';
            const role = userData.role || 'salesman';
            const currentView = document.querySelector('.view.active')?.id?.replace('view-', '') || '';

            menuConfig.forEach((item) => {
                if (item.type === 'separator') {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'menu-section-label';
                    labelDiv.dataset.itemId = item.id;
                    if (menuEditMode) labelDiv.setAttribute('draggable', 'true');
                    const handle = document.createElement('span');
                    handle.className = 'drag-handle';
                    handle.textContent = 'â ¿';
                    labelDiv.appendChild(handle);
                    labelDiv.appendChild(document.createTextNode(item.label));
                    nav.appendChild(labelDiv);
                    const hr = document.createElement('hr');
                    hr.className = 'menu-hr';
                    nav.appendChild(hr);
                    return;
                }
                if (!item.roles || !item.roles.includes(role)) return;
                const isActive = currentView === item.view;
                const div = document.createElement('div');
                div.className = 'menu-item' + (isActive ? ' active-menu' : '');
                div.dataset.itemId = item.id;
                div.dataset.view = item.view || '';
                if (menuEditMode) div.setAttribute('draggable', 'true');
                if (item.special) div.style.cssText = 'margin-top:4px;border:1px dashed rgba(99,102,241,0.35);';
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = 'â ¿';
                div.appendChild(handle);
                const lbl = document.createElement('span');
                lbl.style.flex = '1';
                lbl.textContent = item.label;
                div.appendChild(lbl);
                if (!menuEditMode) {
                    div.addEventListener('click', () => switchView(item.view));
                }
                nav.appendChild(div);
            });

            // Attach drag listeners once, on first render
            if (!_dragListenersAttached) _attachNavDragListeners();
        }

        function toggleMenuEditMode() {
            menuEditMode = !menuEditMode;
            const btn = document.getElementById('menuEditBtn');
            const hint = document.getElementById('menuEditHint');
            document.body.classList.toggle('menu-edit-mode', menuEditMode);
            if (menuEditMode) {
                btn.textContent = 'âœ… Done';
                btn.classList.add('active-edit');
                hint.style.display = 'block';
            } else {
                btn.textContent = 'âœï¸ Customize';
                btn.classList.remove('active-edit');
                hint.style.display = 'none';
                saveMenuConfig(menuConfig);
                toast('âœ… Menu order saved!', 'success');
            }
            renderSidebar();
        }

        // ===== ADMIN PANEL DRAG & DROP =====
        let adminEditMode = false;
        let adminDragSrc = null;
        const ADMIN_ORDER_KEY = 'owm_admin_panel_order_';

        function _adminOrderKey() {
            return ADMIN_ORDER_KEY + (userData.user || 'default');
        }

        function saveAdminOrder() {
            try {
                const area = document.getElementById('adminPanelArea');
                if (!area) return;
                const cards = Array.from(area.querySelectorAll('.admin-draggable'));
                const order = cards.map(c => c.dataset.adminId);
                localStorage.setItem(_adminOrderKey(), JSON.stringify(order));
            } catch(e) {}
        }

        function restoreAdminOrder() {
            try {
                const saved = localStorage.getItem(_adminOrderKey());
                if (!saved) return;
                const order = JSON.parse(saved);
                const area = document.getElementById('adminPanelArea');
                if (!area) return;
                const cards = {};
                area.querySelectorAll('.admin-draggable').forEach(c => { cards[c.dataset.adminId] = c; });
                // Move modals (non-draggable) to end temporarily
                const others = Array.from(area.children).filter(c => !c.classList.contains('admin-draggable'));
                order.forEach(id => { if (cards[id]) area.appendChild(cards[id]); });
                others.forEach(el => area.appendChild(el));
            } catch(e) {}
        }

        function handleAdminHeaderClick(e, colId) {
            if (adminEditMode) return; // No expand in edit mode
            toggleCollapse(colId);
        }

        function toggleAdminEditMode() {
            adminEditMode = !adminEditMode;
            const bar = document.getElementById('adminPanelEditBar');
            const btn = document.getElementById('adminCustomizeBtn');
            const area = document.getElementById('adminPanelArea');
            document.body.classList.toggle('admin-edit-mode', adminEditMode);

            // Set/unset draggable on all cards
            if (area) {
                area.querySelectorAll('.admin-draggable').forEach(card => {
                    if (adminEditMode) card.setAttribute('draggable', 'true');
                    else card.removeAttribute('draggable');
                });
            }

            if (adminEditMode) {
                bar.classList.add('visible');
                if (btn) {
                    btn.style.background = 'linear-gradient(135deg,var(--primary),#6366f1)';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Done Editing';
                }
                _attachAdminDragListeners();
            } else {
                bar.classList.remove('visible');
                if (btn) {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.border = '';
                    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg> Customize Panel';
                }
                saveAdminOrder();
                toast('âœ… Panel order saved!', 'success');
            }
        }

        let _adminDragListenersAttached = false;
        function _attachAdminDragListeners() {
            if (_adminDragListenersAttached) return;
            const area = document.getElementById('adminPanelArea');
            if (!area) return;

            area.addEventListener('dragstart', function(e) {
                let card = e.target;
                while (card && card !== area) {
                    if (card.classList && card.classList.contains('admin-draggable')) break;
                    card = card.parentElement;
                }
                if (!card || !card.classList.contains('admin-draggable')) { e.preventDefault(); return; }
                adminDragSrc = card;
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setData('text/plain', card.dataset.adminId); } catch(_) {}
                setTimeout(() => { if (adminDragSrc) adminDragSrc.classList.add('admin-dragging'); }, 0);
            });

            area.addEventListener('dragover', function(e) {
                e.preventDefault();
                let card = e.target;
                while (card && card !== area) {
                    if (card.classList && card.classList.contains('admin-draggable')) break;
                    card = card.parentElement;
                }
                if (!card || !card.classList.contains('admin-draggable') || card === adminDragSrc) return;
                area.querySelectorAll('.admin-drag-over').forEach(el => el.classList.remove('admin-drag-over'));
                card.classList.add('admin-drag-over');
            });

            area.addEventListener('dragleave', function(e) {
                if (!area.contains(e.relatedTarget)) {
                    area.querySelectorAll('.admin-drag-over').forEach(el => el.classList.remove('admin-drag-over'));
                }
            });

            area.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                let dst = e.target;
                while (dst && dst !== area) {
                    if (dst.classList && dst.classList.contains('admin-draggable')) break;
                    dst = dst.parentElement;
                }
                if (!adminDragSrc || !dst || !dst.classList.contains('admin-draggable') || adminDragSrc === dst) {
                    _clearAdminDrag(); return;
                }
                // Insert src before dst
                area.insertBefore(adminDragSrc, dst);
                _clearAdminDrag();
                toast('âœ… Cards reordered!', 'success');
            });

            area.addEventListener('dragend', _clearAdminDrag);

            // Make draggable when edit mode
            _adminDragListenersAttached = true;
        }

        function _clearAdminDrag() {
            document.querySelectorAll('#adminPanelArea .admin-drag-over, #adminPanelArea .admin-dragging')
                .forEach(el => el.classList.remove('admin-drag-over', 'admin-dragging'));
            adminDragSrc = null;
        }

        // ===== COLLAPSIBLE =====
        function toggleCollapsible(header) {
            header.classList.toggle('open');
            const body = header.nextElementSibling;
            body.classList.toggle('open');
        }

        // ===== TOAST =====
        function toast(msg, type="normal") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.borderLeftColor = type==='error' ? '#f43f5e' : '#10b981';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const isNone = el.style.display === 'none' || el.style.display === '';
            el.style.display = isNone ? (id === 'managerChartsArea' ? 'grid' : 'block') : 'none';
        }

        // ===== CLOCK =====
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
            const dateStr = now.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
            const el = document.getElementById('realTimeClock');
            if(el) el.innerHTML = `<div style="font-weight:700; font-size:14px;">${timeStr}</div><div style="font-size:10px; opacity:0.75;">${dateStr}</div>`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ===== THEME =====
        let userManualTheme = null;
        function applyTheme(isDark) {
            const themeToggle = document.getElementById('themeToggleCheckbox');
            const themeBtn = document.getElementById('themeToggleBtn');
            const authIcon = document.getElementById('authThemeIcon');
            const authLabel = document.getElementById('authThemeLabel');
            if (isDark) {
                document.body.classList.add('dark-mode');
                if(themeToggle) themeToggle.checked = true;
                if(themeBtn) themeBtn.innerHTML = 'â˜€ï¸ Light';
                if(authIcon) authIcon.textContent = 'â˜€ï¸';
                if(authLabel) authLabel.textContent = 'Light';
            } else {
                document.body.classList.remove('dark-mode');
                if(themeToggle) themeToggle.checked = false;
                if(themeBtn) themeBtn.innerHTML = 'ðŸŒ™ Dark';
                if(authIcon) authIcon.textContent = 'ðŸŒ™';
                if(authLabel) authLabel.textContent = 'Dark';
            }
        }
        function applySystemTheme() {
            if (userManualTheme !== null) return;
            applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
        }
        function toggleThemeManually() {
            const cb = document.getElementById('themeToggleCheckbox');
            cb.checked = !cb.checked;
            userManualTheme = cb.checked;
            applyTheme(userManualTheme);
        }
        applySystemTheme();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => { if(userManualTheme===null) applyTheme(e.matches); });

        // ===== DAILY PASSWORD =====
        function generateDailyPassword() {
            const now = new Date();
            const seed = now.getFullYear() * 10000 + (now.getMonth()+1) * 100 + now.getDate();
            const mixed = seed ^ (0x4144 ^ 0x1234) ^ 0xAB7F;
            const pool = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
            let pass = '', state = mixed;
            for (let i = 0; i < 8; i++) {
                state = ((state * 1103515245 + 12345) & 0x7FFFFFFF);
                pass += pool[state % pool.length];
            }
            return pass.substring(0,4) + '-' + pass.substring(4,8);
        }
        function checkMasterPassword(input) {
            let h = 0;
            for (let i = 0; i < input.length; i++) h = ((h << 5) - h + input.charCodeAt(i)) | 0;
            return h === -500839080;
        }
        function unlockDailyPass() {
            const masterInput = document.getElementById('masterPassInput').value;
            if (!checkMasterPassword(masterInput)) { toast("âŒ Incorrect master password!", "error"); document.getElementById('masterPassInput').value=''; return; }
            document.getElementById('masterPassInput').value='';
            const daily = generateDailyPassword();
            const today = new Date().toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            document.getElementById('dailyPassDisplay').innerText = daily;
            document.getElementById('passValidDate').innerText = today;
            document.getElementById('passLockedView').style.display = 'none';
            document.getElementById('passUnlockedView').style.display = 'block';
        }
        function lockDailyPass() {
            document.getElementById('dailyPassDisplay').innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            document.getElementById('passUnlockedView').style.display = 'none';
            document.getElementById('passLockedView').style.display = 'block';
        }
        function copyDailyPass() {
            const pass = document.getElementById('dailyPassDisplay').innerText;
            if(navigator.clipboard) navigator.clipboard.writeText(pass).then(() => toast("âœ… Password copied!", "success"));
            else { const el=document.createElement('textarea'); el.value=pass; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); toast("âœ… Password copied!", "success"); }
        }

        // ===== AUTH =====
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    userData = doc.data() || {};
                    document.getElementById('sideName').innerText = userData.name || "User";
                    document.getElementById('dashWelcomeName').innerText = userData.name || "User";
                    document.getElementById('sideRole').innerText = userData.role || "Role";
                    // Set avatar initial
                    const avatarEl = document.getElementById('sideAvatar');
                    if (avatarEl) avatarEl.textContent = (userData.name || 'U').charAt(0).toUpperCase();
                    userData.uid = user.uid;
                    // Load profile picture if exists
                    setTimeout(() => updateSidebarAvatar(), 100);
                    const isMgr = (userData.role === 'manager');
                    // Set role class on body for CSS-based hiding
                    document.body.classList.remove('role-salesman', 'role-manager');
                    document.body.classList.add(isMgr ? 'role-manager' : 'role-salesman');
                    document.getElementById('managerChartsWrapper').style.display = isMgr ? 'block' : 'none';
                    document.querySelectorAll('.mgr-action').forEach(el => el.style.display = isMgr ? 'inline-block' : 'none');
                    document.querySelectorAll('.mgr-due-add').forEach(el => el.style.display = isMgr ? 'block' : 'none');
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'block';
                    renderSidebar();
                    switchView('dashboard');
                    loadData();
                    userData.uid = user.uid;
                    checkPendingReset(user.uid);
                    updateOnlineStatus();
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function loginUser() {
            const user = document.getElementById('loginUsername').value.toLowerCase().trim().replace(/\s/g,'');
            const pass = document.getElementById('loginPassword').value;
            if(!user||!pass) return toast("Enter username and password","error");
            const btn = document.getElementById('btnLogin');
            btn.innerText="Processing..."; btn.disabled=true;
            try {
                await Promise.race([
                    auth.signInWithEmailAndPassword(user+"@erp.com", pass),
                    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout")), 10000))
                ]);
                toast("Login Successful!","success");
            } catch(e) {
                let msg = e.message;
                if(e.code==='auth/user-not-found') msg="âŒ Username not found. Please check and try again.";
                else if(e.code==='auth/wrong-password') msg="âŒ Incorrect password. Please try again.";
                else if(e.code==='auth/invalid-credential') msg="âŒ Incorrect username or password.";
                else if(e.code==='auth/invalid-email') msg="âŒ Invalid username format.";
                else if(e.code==='auth/too-many-requests') msg="âš ï¸ Too many failed attempts. Please wait a moment and try again.";
                else if(e.code==='auth/network-request-failed') msg="ðŸ“¶ No internet connection. Check your network.";
                else if(e.message==='Timeout') msg="â±ï¸ Request timed out. Check your connection.";
                else msg="âŒ Login failed. Please check your credentials.";
                toast(msg,"error");
            } finally { btn.innerText="Login"; btn.disabled=false; }
        }

        async function registerUser() {
            const name=document.getElementById('regName').value.trim();
            const user=document.getElementById('regUser').value.toLowerCase().trim().replace(/\s/g,'');
            const pass=document.getElementById('regPass').value;
            const role=document.getElementById('regRole').value;
            const pin=document.getElementById('pinBox').value;
            if(!(pin===generateDailyPassword()||checkMasterPassword(pin))) return toast("âŒ Invalid registration password!","error");
            if(!name||!user||pass.length<6) return toast("Please fill all details correctly","error");
            document.getElementById('btnReg').innerText="Processing...";
            try {
                const cred = await auth.createUserWithEmailAndPassword(user+"@erp.com", pass);
                await db.collection("users").doc(cred.user.uid).set({ name, user, role });
                toast("Account Created!","success");
            } catch(e) { toast(e.message,"error"); document.getElementById('btnReg').innerText="Create Account"; }
        }

        function logoutApp() {
            menuConfig = null;
            auth.signOut().then(() => {
                toast("Logged Out", "success");
                document.body.classList.remove('role-salesman', 'role-manager');
                historyData = []; allDueData = {}; allReturnsData = []; allVisitsData = [];
                globalShops = {}; productsMap = {};
            });
        }
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
            document.body.style.overflow = document.getElementById('sidebar').classList.contains('active') ? 'hidden' : '';
        }
        function toggleAuthView(v) {
            document.getElementById('login-box').style.display = v=='login'?'block':'none';
            document.getElementById('reg-box').style.display = v=='reg'?'block':'none';
        }
        function toggleAuthTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            userManualTheme = isDark;
            const icon = document.getElementById('authThemeIcon');
            const label = document.getElementById('authThemeLabel');
            if (isDark) {
                if(icon) icon.textContent = 'â˜€ï¸';
                if(label) label.textContent = 'Light';
            } else {
                if(icon) icon.textContent = 'ðŸŒ™';
                if(label) label.textContent = 'Dark';
            }
            // Sync with app theme toggle if present
            const appCb = document.getElementById('themeToggleCheckbox');
            if(appCb) appCb.checked = isDark;
        }
        function filterStock() {
            const searchEl = document.getElementById("stockSearch");
            if (!searchEl) return;
            const input = searchEl.value.toUpperCase();
            Array.from(document.getElementById("stockTableBody").getElementsByTagName("tr")).forEach(tr => {
                const td = tr.getElementsByTagName("td")[0];
                if(td) tr.style.display = td.textContent.toUpperCase().includes(input) ? "" : "none";
            });
        }

        // ===== LOAD DATA =====
        function loadData() {
            db.collection("shops").orderBy("name").onSnapshot(snap => {
                const sel=document.getElementById('orderShop');
                const repShop=document.getElementById('repShop');
                const payRepShop=document.getElementById('payRepShopSel');
                const delShop=document.getElementById('delShopSelect');
                sel.innerHTML='<option value="">-- Select Shop --</option>';
                repShop.innerHTML='<option value="all">All Shops</option>';
                if(payRepShop) payRepShop.innerHTML='<option value="all">All Shops</option>';
                if(delShop) delShop.innerHTML='<option value="">-- Select Shop to Delete --</option>';
                globalShops={};
                snap.forEach(doc => {
                    const d=doc.data(); globalShops[doc.id]=d;
                    const sv=doc.id.replace(/"/g,'&quot;');
                    sel.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    repShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(payRepShop) payRepShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(delShop) delShop.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                });
                if(Object.keys(allDueData).length>0 || historyData.length>0) renderDueList();
                // Populate visitShopSel
                const visitSel = document.getElementById('visitShopSel');
                if (visitSel) {
                    visitSel.innerHTML = '<option value="">-- Select Shop Visited --</option>';
                    snap.forEach(doc => {
                        const d = doc.data();
                        visitSel.innerHTML += `<option value="${doc.id}">${d.name || doc.id}</option>`;
                    });
                }
                // Refresh note selects if already populated
                populateNoteShopSelects();
                // Update manager panel shop list
                updateShopListFromGlobal();
                // Refresh area dropdowns (area counts may have changed if shop areas differ)
                renderAreaList();
                populateAreaDropdowns();
            });

            db.collection("products").onSnapshot(snap => {
                const orderDatalist=document.getElementById('orderItemDatalist');
                const repItem=document.getElementById('repItem');
                const delItem=document.getElementById('delItemSelect');
                const adminDatalist=document.getElementById('adminProductList');
                const stockBody=document.getElementById('stockTableBody');
                stockBody.innerHTML=''; stockDataArray=[]; productsMap={};
                let totalStockValue=0, datalistHtml='', lowStockCount=0, lowStockHtml='';
                repItem.innerHTML='<option value="all">All Items</option>';
                if(delItem) delItem.innerHTML='<option value="">-- Select Item to Delete --</option>';
                snap.forEach(doc => {
                    const d=doc.data();
                    const price=d.price||0, stock=d.stock||0, discount=d.discount||0, costPrice=d.costPrice||0;
                    totalStockValue+=(stock*price);
                    productsMap[doc.id]={price,stock,discount,costPrice};
                    const sv=doc.id.replace(/"/g,'&quot;');
                    datalistHtml+=`<option value="${sv}">`;
                    repItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    if(delItem) delItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    const si=doc.id.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editProduct('${si}',${stock},${price},${discount},${costPrice})" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">âœï¸</button>
                        <button onclick="deleteProduct('${si}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">ðŸ—‘ï¸</button>
                    </td>`:'';
                    let discFormat=discount>0?`<b style="color:var(--primary)">${discount}%</b>`:`0%`;
                    let cpDisplay=costPrice>0?`â‚¹${costPrice.toFixed(2)}`:`<span style="color:#94a3b8;">â€”</span>`;
                    stockBody.innerHTML+=`<tr>
                        <td><b>${doc.id}</b></td>
                        <td style="${stock<=5?'color:#f43f5e;font-weight:700;':''}">${stock}</td>
                        <td>â‚¹${price.toFixed(2)}</td>
                        <td class="mgr-only-col">${cpDisplay}</td>
                        <td>${discFormat}</td>
                        ${actionBtn}
                    </tr>`;
                    stockDataArray.push(userData.role==='manager' ? {"Product":doc.id,"Stock":stock,"Selling Price":price,"Purchase Price":costPrice,"Discount (%)":discount} : {"Product":doc.id,"Stock":stock,"Selling Price":price,"Discount (%)":discount});
                    if(stock<=5){lowStockCount++;lowStockHtml+=`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>${doc.id}</span><span style="color:#f43f5e;font-weight:700;">${stock} left</span></div>`;}
                });
                orderDatalist.innerHTML=datalistHtml;
                if(adminDatalist) adminDatalist.innerHTML=datalistHtml;
                document.getElementById('stockTotalValue').innerText=`â‚¹ ${totalStockValue.toFixed(2)}`;
                document.getElementById('dashLowStockCount').innerText=lowStockCount;
                document.getElementById('dashLowStockList').innerHTML=lowStockCount>0?lowStockHtml:`<div style="padding:10px;color:var(--success);font-weight:700;">âœ… All items are well stocked!</div>`;
                filterStock();
            });

            db.collection("purchases").orderBy("time","desc").limit(100).onSnapshot(snap => {
                const pBody=document.getElementById('purchaseTableBody');
                pBody.innerHTML=''; purchaseDataArray=[];
                snap.forEach(doc => {
                    const d=doc.data();
                    const timeStr=d.time?d.time.toDate().toLocaleDateString():'N/A';
                    const sdi=doc.id.replace(/'/g,"\\'");
                    const sin=d.item.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let sd=d.dealer?d.dealer.replace(/'/g,"\\'").replace(/"/g,'&quot;'):'';
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editPurchase('${sdi}','${sin}',${d.addedStock},${d.price||0},${d.costPrice||0},'${sd}')" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">âœï¸</button>
                        <button onclick="deletePurchaseRecord('${sdi}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">ðŸ—‘ï¸</button>
                    </td>`:'';
                    pBody.innerHTML+=`<tr><td>${timeStr}</td><td><b>${d.item}</b></td><td style="color:var(--primary);">+${d.addedStock}</td><td>â‚¹${(d.price||0).toFixed(2)}</td><td class="mgr-only-col" style="color:var(--danger);">â‚¹${(d.costPrice||0).toFixed(2)}</td><td>${d.dealer||'N/A'}</td>${actionBtn}</tr>`;
                    purchaseDataArray.push(userData.role==='manager' ? {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Cost Price":d.costPrice||0,"Dealer":d.dealer||''} : {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Dealer":d.dealer||''});
                });
            });

            db.collection("orders").orderBy("time","desc").onSnapshot(snap => {
                const list=document.getElementById('historyList');
                const salesBody=document.getElementById('salesTableBody');
                const billSel=document.getElementById('billingSelect');
                const repSalesman=document.getElementById('repSalesman');
                list.innerHTML=""; salesBody.innerHTML="";
                billSel.innerHTML='<option value="">-- Choose an Order --</option>';
                historyData=[]; salesDataArray=[];
                let totalS=0, totalO=0, shopMap={}, todayS=0;
                const today=new Date().setHours(0,0,0,0);
                let salesmenSet=new Set();
                let last7DaysMap={}, topItemsMap={};
                for(let i=6;i>=0;i--){let dt=new Date();dt.setDate(dt.getDate()-i);last7DaysMap[dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})]=0;}
                let idx=0;
                snap.forEach(doc => {
                    const d=doc.data(); d.orderId=doc.id; historyData.push(d);
                    salesmenSet.add(d.salesman);
                    let oTime=d.time?d.time.toDate():new Date();
                    const timeS=oTime.toLocaleString();
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    if(userData.role==='manager'){
                        let dk=oTime.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
                        if(d.deliveryStatus==='delivered' && last7DaysMap[dk]!==undefined) last7DaysMap[dk]+=d.total;
                        if(d.deliveryStatus==='delivered') d.items.forEach(item=>{topItemsMap[item.id]=(topItemsMap[item.id]||0)+item.qty;});
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        totalO++;
                        if(d.deliveryStatus==='delivered') {
                            totalS+=d.total;
                            if(oTime.getTime()>=today) todayS+=d.total;
                            shopMap[d.shopName]=(shopMap[d.shopName]||0)+d.total;
                        }
                    }
                    billSel.innerHTML+=`<option value="${idx}">${d.shopName} (â‚¹${d.total.toFixed(0)})</option>`;
                    let actionBtn="", billBtn="";
                    if(userData.role==='manager'){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                        billBtn=`<button onclick="document.getElementById('billingSelect').value='${idx}';renderA5Bill();switchView('billing');" class="btn-outline" style="padding:2px 8px;font-size:12px;">Bill</button>`;
                    } else if(d.salesman===userData.name){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        const isPending = !d.deliveryStatus || d.deliveryStatus === 'pending';
                        const statusBadge = isPending
                            ? `<span style="background:rgba(245,158,11,0.15);color:#b45309;border:1px solid rgba(245,158,11,0.4);border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;">ðŸšš Pending Delivery</span>`
                            : `<span style="background:rgba(16,185,129,0.13);color:#065f46;border:1px solid rgba(16,185,129,0.35);border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;">âœ… Delivered</span>`;
                        const deliverBtn = isPending
                            ? `<button onclick="openDeliveryConfirm(${idx})" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;margin-left:5px;">ðŸšš Deliver</button>`
                            : '';
                        const amountRow = isPending
                            ? `<b style="font-size:16px;color:var(--warning);">â‚¹ ${d.total.toFixed(2)}</b>`
                            : `<div>
                                <b style="font-size:16px;color:var(--success);">â‚¹ ${d.total.toFixed(2)}</b>
                                ${d.orderedTotal && d.orderedTotal !== d.total ? `<span style="font-size:11px;color:#94a3b8;margin-left:6px;text-decoration:line-through;">â‚¹${d.orderedTotal.toFixed(2)}</span>` : ''}
                               </div>`;
                        list.innerHTML+=`<div class="card" style="border-left:3px solid ${isPending?'#f59e0b':'#10b981'};">
                            <div class="flex-between">
                                <b style="color:var(--primary);font-size:15px;">${d.shopName}</b>
                                <small style="color:#64748b;">${timeS}</small>
                            </div>
                            <div style="margin:5px 0;">${statusBadge}</div>
                            <div style="font-size:13px;margin:6px 0;color:var(--text);">${itemsText}</div>
                            <div style="font-size:11px;margin-bottom:6px;color:#64748b;">ðŸ‘¤ ${d.salesman}</div>
                            <div class="flex-between">
                                ${amountRow}
                                <div>${billBtn}${deliverBtn}${actionBtn}</div>
                            </div>
                        </div>`;
                    }
                    let salesActionBtn=(userData.role==='manager')?`<td class="no-print"><button onclick="deleteOrder(${idx})" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">ðŸ—‘ï¸</button></td>`:'';
                    salesBody.innerHTML+=`<tr><td>${timeS}</td><td>${d.shopName}</td><td>${itemsText}</td><td>â‚¹${d.total.toFixed(2)}</td><td>${d.salesman}</td>${salesActionBtn}</tr>`;
                    salesDataArray.push({"Date":timeS,"Shop":d.shopName,"Total":d.total});
                    idx++;
                });
                document.getElementById('dashTodaySales').innerText=`â‚¹ ${todayS.toFixed(2)}`;
                document.getElementById('dashTotalSales').innerText=`â‚¹ ${totalS.toFixed(2)}`;
                document.getElementById('dashTotalOrders').innerText=totalO;
                renderQuickAccess();
                if(repSalesman){repSalesman.innerHTML='<option value="all">All Salesmen</option>';salesmenSet.forEach(s=>repSalesman.innerHTML+=`<option value="${s}">${s}</option>`);}
                if(userData.role==='manager') updateDashboardCharts(last7DaysMap,topItemsMap);
                renderDueList();
                renderQuickAccess();
            });

            db.collection("shop_notes").orderBy("time","desc").limit(500).onSnapshot(snap => {
                allShopNotes = [];
                snap.forEach(doc => { const d = doc.data(); d.docId = doc.id; allShopNotes.push(d); });
                if (document.getElementById('view-shop-notes')?.classList.contains('active')) renderShopNotes();
            });

            db.collection("due_entries").orderBy("time","desc").onSnapshot(snap => {
                allDueData={};
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id;
                    if(!allDueData[d.shopName]) allDueData[d.shopName]=[];
                    allDueData[d.shopName].push(d);
                });
                renderDueList();
            });

            db.collection("returns").orderBy("time","desc").limit(100).onSnapshot(snap => {
                allReturnsData=[];
                const rList=document.getElementById('returnHistoryList');
                rList.innerHTML='';
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id; allReturnsData.push(d);
                    const timeS=d.time?d.time.toDate().toLocaleString():'';
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    const safeDocId = d.docId.replace(/'/g,"\\'");
                    // FIX: Only managers can edit/delete returns
                    const canEdit = (userData.role === 'manager');
                    const editDeleteBtns = canEdit ? `
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            <button class="action-btn action-btn-edit" onclick="editReturn('${safeDocId}')">âœï¸ Edit Note</button>
                            <button class="action-btn action-btn-delete" onclick="deleteReturn('${safeDocId}',${d.refundAmt||0})">ðŸ—‘ï¸ Delete</button>
                        </div>` : '';
                    rList.innerHTML+=`<div class="card" style="margin-bottom:10px;" data-return-id="${d.docId}">
                        <div class="flex-between"><b style="color:var(--warning);">â†©ï¸ ${d.shopName}</b><small style="color:#64748b;">${timeS}</small></div>
                        <div style="font-size:13px;margin:6px 0;">${itemsText}</div>
                        <div style="font-size:11px;color:#64748b;">ðŸ‘¤ ${d.salesman} ${d.reason?'| Reason: '+d.reason:''}</div>
                        <div style="margin-top:6px;font-weight:700;color:var(--warning);">Refund: â‚¹ ${(d.refundAmt||0).toFixed(2)}</div>
                        ${editDeleteBtns}
                    </div>`;
                });
                if(!snap.size) rList.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No returns yet.</div>';
            });

            db.collection("visits").orderBy("time","desc").limit(300).onSnapshot(snap => {
                allVisitsData=[];
                const salesmenSet=new Set(['all']);
                snap.forEach(doc => { const d=doc.data(); d.docId=doc.id; allVisitsData.push(d); salesmenSet.add(d.salesman); });
                const vsf=document.getElementById('visitSalesmanFilter');
                const curVal=vsf.value;
                vsf.innerHTML='<option value="all">All Salesmen</option>';
                salesmenSet.forEach(s=>{ if(s!=='all') vsf.innerHTML+=`<option value="${s}">${s}</option>`; });
                vsf.value=curVal;
                renderVisits();
            });

            // After all data loaded, populate incentive & shop selects
            setTimeout(() => {
                populateIncSalesmanFilter();
                populateShopCreatedBySelect();
            }, 1500);

            // ===== AREAS REALTIME LISTENER =====
            db.collection("areas").orderBy("name").onSnapshot(snap => {
                globalAreas = [];
                snap.forEach(doc => globalAreas.push({ id: doc.id, name: doc.data().name || doc.id }));
                renderAreaList();
                populateAreaDropdowns();
            });
        }

        // ===== AREA MANAGEMENT =====

        function populateAreaDropdowns() {
            // Populate all area dropdowns/selects throughout the app
            const selects = [
                { id: 'shopArea', current: null },
                { id: 'editShopAreaInput', current: null },
                { id: 'swAreaFilter', current: null },
                { id: 'pwAreaFilter', current: null },
                { id: 'repArea', current: null },
            ];
            selects.forEach(({ id }) => {
                const el = document.getElementById(id);
                if (!el) return;
                const cur = el.value;
                const isFilter = ['swAreaFilter','pwAreaFilter','repArea'].includes(id);
                el.innerHTML = isFilter
                    ? '<option value="all">All Areas</option>'
                    : '<option value="">-- Select Area --</option>';
                globalAreas.forEach(a => {
                    el.innerHTML += `<option value="${a.name}">${a.name}</option>`;
                });
                // Restore previous selection if still valid
                if (cur && [...el.options].some(o => o.value === cur)) el.value = cur;
            });
        }

        function renderAreaList() {
            const container = document.getElementById('areaListContainer');
            if (!container) return;

            if (!globalAreas.length) {
                container.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#94a3b8;">
                        <div style="font-size:32px; margin-bottom:8px;">ðŸ—ºï¸</div>
                        <div style="font-size:13px;">No areas found. Add a new area above.</div>
                    </div>`;
                return;
            }

            container.innerHTML = globalAreas.map((a, i) => {
                // Count shops in this area
                const shopCount = Object.values(globalShops).filter(s => s.area === a.name).length;
                return `
                <div style="
                    display:flex; align-items:center; justify-content:space-between;
                    background:var(--bg); border:1.5px solid var(--border);
                    border-radius:12px; padding:11px 14px; margin-bottom:8px;
                    transition:box-shadow 0.2s;"
                    onmouseover="this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.boxShadow='none'">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="
                            background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));
                            border:1px solid rgba(245,158,11,0.3);
                            border-radius:8px; width:32px; height:32px;
                            display:flex; align-items:center; justify-content:center;
                            font-size:15px; flex-shrink:0;">ðŸ—ºï¸</div>
                        <div>
                            <div style="font-weight:700; font-size:14px; color:var(--text);">${a.name}</div>
                            <div style="font-size:11px; color:#94a3b8; margin-top:1px;">
                                ${shopCount > 0
                                    ? `<span style="color:#b45309; font-weight:600;">ðŸª ${shopCount} shop${shopCount > 1 ? 's' : ''}</span>`
                                    : `<span>No shops yet</span>`}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <button onclick="editAreaPrompt('${a.id}','${a.name.replace(/'/g,"\\\'")}')"
                            style="background:var(--primary-light); color:var(--primary); border:1px solid rgba(99,102,241,0.2);
                            border-radius:8px; padding:6px 10px; font-size:11px; font-weight:700;
                            cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(99,102,241,0.18)'"
                            onmouseout="this.style.background='var(--primary-light)'">âœï¸ Edit</button>
                        <button onclick="deleteArea('${a.id}','${a.name.replace(/'/g,"\\\'")}')"
                            style="background:rgba(244,63,94,0.08); color:#f43f5e; border:1px solid rgba(244,63,94,0.18);
                            border-radius:8px; padding:6px 10px; font-size:11px; font-weight:700;
                            cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(244,63,94,0.15)'"
                            onmouseout="this.style.background='rgba(244,63,94,0.08)'">ðŸ—‘ï¸</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function addArea() {
            const input = document.getElementById('newAreaInput');
            const name = (input?.value || '').trim();
            if (!name) return toast('Please enter an area name', 'error');

            // Check duplicate
            if (globalAreas.some(a => a.name.toLowerCase() === name.toLowerCase())) {
                return toast(`"${name}" area already exists!`, 'error');
            }

            try {
                const docId = name.replace(/[^a-zA-Z0-9_\u0980-\u09FF\s]/g, '').replace(/\s+/g, '_').toLowerCase();
                await db.collection('areas').doc(docId).set({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                if (input) input.value = '';
                toast(`âœ… Area "${name}" added!`, 'success');
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        async function editAreaPrompt(areaId, oldName) {
            const newName = prompt(`âœï¸ Rename area:\n(current: "${oldName}")`, oldName);
            if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
            const trimmed = newName.trim();

            if (globalAreas.some(a => a.name.toLowerCase() === trimmed.toLowerCase() && a.id !== areaId)) {
                return toast(`"${trimmed}" area already exists!`, 'error');
            }

            try {
                await db.collection('areas').doc(areaId).update({ name: trimmed });
                // Also update all shops that have this area
                const batch = db.batch();
                Object.entries(globalShops).forEach(([id, d]) => {
                    if (d.area === oldName) {
                        batch.update(db.collection('shops').doc(id), { area: trimmed });
                    }
                });
                await batch.commit();
                toast(`âœ… Area renamed to "${trimmed}"!`, 'success');
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        async function deleteArea(areaId, areaName) {
            const shopCount = Object.values(globalShops).filter(s => s.area === areaName).length;
            const msg = shopCount > 0
                ? `âš ï¸ "${areaName}" area has ${shopCount} shop${shopCount>1?'s':''}!\nDeleting it will clear the area from those shops.\n\nAre you sure?`
                : `Delete "${areaName}" area?`;

            if (!confirm(msg)) return;

            try {
                // Save affected shops for undo
                const affectedShops = Object.entries(globalShops)
                    .filter(([id,d]) => d.area === areaName)
                    .map(([id,d]) => id);

                await db.collection('areas').doc(areaId).delete();
                // Clear area from shops
                if (shopCount > 0) {
                    const batch = db.batch();
                    affectedShops.forEach(id => {
                        batch.update(db.collection('shops').doc(id), { area: '' });
                    });
                    await batch.commit();
                }
                toast(`ðŸ—‘ï¸ Area "${areaName}" deleted!`, 'success');

                pushUndo(`Area "${areaName}" deleted`, async () => {
                    await db.collection('areas').doc(areaId).set({ name: areaName, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    if (affectedShops.length) {
                        const batch = db.batch();
                        affectedShops.forEach(id => batch.update(db.collection('shops').doc(id), { area: areaName }));
                        await batch.commit();
                    }
                });
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        // ===== CHARTS =====
        function updateDashboardCharts(salesMap, itemsMap) {
            const salesCtx=document.getElementById('dashSalesChart').getContext('2d');
            if(dashSalesChartInstance) dashSalesChartInstance.destroy();
            dashSalesChartInstance=new Chart(salesCtx,{type:'line',data:{labels:Object.keys(salesMap),datasets:[{label:'Sales (â‚¹)',data:Object.values(salesMap),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',fill:true,tension:0.4,pointBackgroundColor:'#6366f1',pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
            const sortedItems=Object.entries(itemsMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const itemCtx=document.getElementById('dashItemChart').getContext('2d');
            if(dashItemChartInstance) dashItemChartInstance.destroy();
            dashItemChartInstance=new Chart(itemCtx,{type:'doughnut',data:{labels:sortedItems.map(i=>i[0]),datasets:[{data:sortedItems.map(i=>i[1]),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10}}}}}});
        }

        function updateReportChart(groupMap) {
            const ctx=document.getElementById('reportChart').getContext('2d');
            if(reportChartInstance) reportChartInstance.destroy();
            const labels=Object.keys(groupMap), values=Object.values(groupMap);
            reportChartInstance=new Chart(ctx,{type:labels.length<=6?'bar':'line',data:{labels,datasets:[{label:'Sales (â‚¹)',data:values,backgroundColor:'rgba(16,185,129,0.7)',borderColor:'#10b981',borderRadius:6,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
        }

        // ===== REPORT HELPERS =====
        function applyDatePreset(preset, btn) {
            document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const today=new Date(); let start, end;
            if(preset==='today'){start=end=today;}
            else if(preset==='yesterday'){const yd=new Date(today);yd.setDate(yd.getDate()-1);start=end=yd;}
            else if(preset==='week'){start=new Date(today);start.setDate(today.getDate()-today.getDay());end=today;}
            else if(preset==='lastweek'){end=new Date(today);end.setDate(today.getDate()-today.getDay()-1);start=new Date(end);start.setDate(end.getDate()-6);}
            else if(preset==='month'){start=new Date(today.getFullYear(),today.getMonth(),1);end=today;}
            else if(preset==='lastmonth'){start=new Date(today.getFullYear(),today.getMonth()-1,1);end=new Date(today.getFullYear(),today.getMonth(),0);}
            document.getElementById('repStartDate').value=start.toISOString().split('T')[0];
            document.getElementById('repEndDate').value=end.toISOString().split('T')[0];
        }
        function clearPresets(){document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));}
        function setSortOption(opt,el){currentSortOption=opt;document.querySelectorAll('#sortOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function setGroupOption(opt,el){currentGroupOption=opt;document.querySelectorAll('#groupOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function resetReportFilters(){
            ['repStartDate','repEndDate','repMinAmount','repMaxAmount'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('repShop').value='all'; document.getElementById('repItem').value='all'; document.getElementById('repSalesman').value='all';
            const repAreaEl = document.getElementById('repArea'); if(repAreaEl) repAreaEl.value='all';
            clearPresets(); currentSortOption='date-desc'; currentGroupOption='none';
            document.querySelectorAll('#sortOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.querySelectorAll('#groupOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.getElementById('reportResultArea').style.display='none';
            toast("Filters reset!","success");
        }

        function generateCustomReport() {
            const sVal=document.getElementById('repStartDate').value, eVal=document.getElementById('repEndDate').value;
            const start=sVal?new Date(sVal).setHours(0,0,0,0):null, end=eVal?new Date(eVal).setHours(23,59,59,999):null;
            const shop=document.getElementById('repShop').value, item=document.getElementById('repItem').value;
            const salesmanFilter=document.getElementById('repSalesman').value;
            const areaFilter = (document.getElementById('repArea')?.value) || 'all';
            const minAmt=parseFloat(document.getElementById('repMinAmount').value)||0;
            const maxAmt=parseFloat(document.getElementById('repMaxAmount').value)||Infinity;
            // Build set of shops in selected area
            const shopsInArea = areaFilter !== 'all' ? new Set(
                Object.entries(globalShops)
                    .filter(([id,d]) => (d.area||'') === areaFilter)
                    .map(([id,d]) => d.name || id)
            ) : null;
            customReportArray=[]; let tAmt=0,tQty=0,orderCount=0; let grouped={};
            historyData.forEach(d => {
                let oTime=d.time?d.time.toDate().getTime():0;
                if(start&&oTime<start) return; if(end&&oTime>end) return;
                if(shop!=='all'&&d.shopName!==shop) return;
                if(salesmanFilter!=='all'&&d.salesman!==salesmanFilter) return;
                if(shopsInArea && !shopsInArea.has(d.shopName)) return;
                let filtered=(item==='all')?d.items:d.items.filter(i=>i.id===item);
                if(!filtered.length) return;
                let rowAmt=filtered.reduce((s,i)=>s+i.total,0);
                if(rowAmt<minAmt||rowAmt>maxAmt) return;
                let rowQty=filtered.reduce((s,i)=>s+i.qty,0);
                tAmt+=rowAmt; tQty+=rowQty; orderCount++;
                let dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
                let itemStr=filtered.map(i=>`${i.id}(${i.qty})`).join(', ');
                customReportArray.push({Date:dateStr,Shop:d.shopName,Items:itemStr,"Amount (â‚¹)":rowAmt,Salesman:d.salesman,_time:oTime});
                let gKey=currentGroupOption==='shop'?d.shopName:currentGroupOption==='salesman'?d.salesman:dateStr;
                grouped[gKey]=(grouped[gKey]||0)+rowAmt;
            });
            customReportArray.sort((a,b)=>{
                if(currentSortOption==='date-desc') return b._time-a._time;
                if(currentSortOption==='date-asc') return a._time-b._time;
                if(currentSortOption==='amount-desc') return b['Amount (â‚¹)']-a['Amount (â‚¹)'];
                return a['Amount (â‚¹)']-b['Amount (â‚¹)'];
            });
            const tbody=document.getElementById('repTableBody'), thead=document.getElementById('repTableHead');
            tbody.innerHTML='';
            if(currentGroupOption!=='none'){
                let groupedRows={};
                customReportArray.forEach(row=>{
                    let gKey=currentGroupOption==='shop'?row.Shop:currentGroupOption==='salesman'?row.Salesman:row.Date;
                    if(!groupedRows[gKey]) groupedRows[gKey]={rows:[],total:0};
                    groupedRows[gKey].rows.push(row); groupedRows[gKey].total+=row['Amount (â‚¹)'];
                });
                let groupLabel=currentGroupOption==='shop'?'ðŸª Shop':currentGroupOption==='salesman'?'ðŸ‘¤ Salesman':'ðŸ“… Date';
                thead.innerHTML=`<tr><th>${groupLabel}</th><th>Orders</th><th>Total (â‚¹)</th><th>% of Total</th></tr>`;
                Object.entries(groupedRows).forEach(([key,data])=>{
                    let pct=tAmt>0?((data.total/tAmt)*100).toFixed(1):'0.0';
                    tbody.innerHTML+=`<tr><td><b>${key}</b></td><td>${data.rows.length}</td><td style="color:var(--success);font-weight:700;">â‚¹${data.total.toFixed(2)}</td><td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;">${pct}%</span></td></tr>`;
                });
            } else {
                thead.innerHTML=`<tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (â‚¹)</th><th>Salesman</th></tr>`;
                customReportArray.forEach(row=>{tbody.innerHTML+=`<tr><td>${row.Date}</td><td>${row.Shop}</td><td style="max-width:200px;white-space:normal;">${row.Items}</td><td style="color:var(--success);font-weight:700;">â‚¹${row['Amount (â‚¹)'].toFixed(2)}</td><td>${row.Salesman}</td></tr>`;});
            }
            document.getElementById('repTotalAmount').innerText=`â‚¹ ${tAmt.toFixed(2)}`;
            document.getElementById('repTotalQty').innerText=tQty;
            document.getElementById('repOrderCount').innerText=orderCount;
            document.getElementById('repAvgOrder').innerText=orderCount>0?`â‚¹ ${(tAmt/orderCount).toFixed(2)}`:'â‚¹ 0.00';
            document.getElementById('repDataCount').innerText=`(${orderCount} records)`;
            if(customReportArray.length>0){
                document.getElementById('reportResultArea').style.display='block';
                document.getElementById('reportChartWrapper').style.display='block';
                document.getElementById('reportChartCard').style.display='block';
                updateReportChart(grouped);
            } else { toast("No data found!","error"); document.getElementById('reportResultArea').style.display='none'; }
        }

        // ===== PAYMENT REPORT =====
        function generatePaymentReport() {
            const shopFilter = document.getElementById('payRepShopSel').value;
            const startVal = document.getElementById('payRepStart').value;
            const endVal = document.getElementById('payRepEnd').value;
            const startMs = startVal ? new Date(startVal).setHours(0,0,0,0) : 0;
            const endMs = endVal ? new Date(endVal).setHours(23,59,59,999) : Infinity;
            paymentReportArray = [];
            let totalBillFiltered = 0, totalPaidFiltered = 0;
            Object.entries(allDueData).forEach(([shopName, entries]) => {
                if (shopFilter !== 'all' && shopName !== shopFilter) return;
                entries.forEach(e => {
                    const eMs = e.time ? e.time.toDate().getTime() : 0;
                    if (eMs < startMs || eMs > endMs) return;
                    const dateStr = e.time ? e.time.toDate().toLocaleDateString('en-GB') : 'â€”';
                    paymentReportArray.push({
                        Date: dateStr,
                        Shop: shopName,
                        "Amount Paid (â‚¹)": e.payment || 0,
                        Note: e.note || 'â€”',
                        Salesman: e.salesman || 'â€”',
                        _time: eMs
                    });
                    totalPaidFiltered += (e.payment || 0);
                });
            });
            historyData.forEach(d => {
                if (shopFilter !== 'all' && d.shopName !== shopFilter) return;
                totalBillFiltered += d.total;
            });
            paymentReportArray.sort((a,b) => b._time - a._time);
            const tbody = document.getElementById('payRepTableBody');
            tbody.innerHTML = '';
            paymentReportArray.forEach(row => {
                tbody.innerHTML += `<tr>
                    <td>${row.Date}</td>
                    <td><b>${row.Shop}</b></td>
                    <td style="color:var(--success);font-weight:700;">â‚¹${(row['Amount Paid (â‚¹)']).toFixed(2)}</td>
                    <td style="color:#64748b;">${row.Note}</td>
                    <td>${row.Salesman}</td>
                </tr>`;
            });
            const remaining = totalBillFiltered - totalPaidFiltered;
            document.getElementById('payRepTotalBill').innerText = `â‚¹ ${totalBillFiltered.toFixed(2)}`;
            document.getElementById('payRepTotalPaid').innerText = `â‚¹ ${totalPaidFiltered.toFixed(2)}`;
            document.getElementById('payRepRemaining').innerText = `â‚¹ ${Math.max(0, remaining).toFixed(2)}`;
            document.getElementById('payRepCount').innerText = `(${paymentReportArray.length} payments)`;
            if (paymentReportArray.length > 0) {
                document.getElementById('payRepResultArea').style.display = 'block';
            } else {
                document.getElementById('payRepResultArea').style.display = 'none';
                toast("No payment records found!", "error");
            }
        }

        // ===== EXCEL IMPORT =====
        function getExcelVal(row,keys){
            for(let k of keys) if(row[k]!==undefined&&row[k]!==null&&row[k]!=="") return row[k];
            const rowKeys=Object.keys(row);
            for(let k of keys){const match=rowKeys.find(rk=>rk.trim().toLowerCase()===k.trim().toLowerCase());if(match&&row[match]!==undefined&&row[match]!==null&&row[match]!=="") return row[match];}
            return null;
        }
        async function handleExcelImport(event) {
            const file=event.target.files[0]; if(!file) return;
            const reader=new FileReader();
            reader.onload=async function(e){
                try{
                    const data=new Uint8Array(e.target.result);
                    const workbook=XLSX.read(data,{type:'array'});
                    const json=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(!json.length) return toast("Excel file is empty!","error");
                    let successCount=0,errorCount=0;
                    for(let row of json){
                        let pName=getExcelVal(row,['Product','product','Product Name','Item','item']);
                        let qty=parseInt(getExcelVal(row,['Qty','Added Qty','Quantity','qty']));
                        let price=parseFloat(getExcelVal(row,['Price','price','Base Price','Selling Price']));
                        let costPrice=parseFloat(getExcelVal(row,['Cost Price','cost price','CostPrice','Buy Price','Purchase Price'])||0);
                        let dealer=getExcelVal(row,['Dealer','Dealer info','dealer'])||'';
                        let discount=parseFloat(getExcelVal(row,['Discount','discount','Disc'])||0);
                        if(!pName||isNaN(qty)||qty<=0){errorCount++;continue;}
                        let safeName=pName.toString().trim().replace(/\//g,'-');
                        const ref=db.collection("products").doc(safeName);
                        const doc=await ref.get();
                        let finalS=doc.exists?(doc.data().stock||0)+qty:qty;
                        let finalP=isNaN(price)?(doc.exists?doc.data().price||0:0):price;
                        let finalCP=(!isNaN(costPrice)&&costPrice>0)?costPrice:(doc.exists?doc.data().costPrice||0:0);
                        let finalD=isNaN(discount)?(doc.exists?doc.data().discount||0:0):discount;
                        await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
                        await db.collection("purchases").add({item:safeName,addedStock:qty,price:finalP,costPrice:finalCP,dealer:dealer.toString(),time:firebase.firestore.FieldValue.serverTimestamp()});
                        successCount++;
                    }
                    if(successCount>0) toast(`Import done! ${successCount} items. (Errors: ${errorCount})`,"success");
                    else toast("Failed to import. Check headers.","error");
                }catch(err){toast("Error parsing Excel.","error");}
                event.target.value="";
            };
            reader.readAsArrayBuffer(file);
        }

        // ===== CART =====
        function togglePriceMode() {
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            document.getElementById('manualPriceContainer').style.display=mode==='manual'?'block':'none';
            if(mode!=='manual') document.getElementById('manualPriceInput').value="";
            const dc=document.getElementById('itemDiscContainer');
            if(dc) dc.style.display=mode==='auto'?'block':'none';
        }
        function updateDiscPreview() {
            const pId=document.getElementById('orderItemInput').value;
            if(!productsMap[pId]) return;
            const base=productsMap[pId].price;
            const disc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
            document.getElementById('discPricePreview').innerText=disc>0?`â†’ â‚¹${(base-(base*disc/100)).toFixed(2)}`:'';
        }
        function showPriceInfo() {
            const val=document.getElementById('orderItemInput').value;
            const box=document.getElementById('priceHighlightBox');
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            const dc=document.getElementById('itemDiscContainer');
            if(productsMap[val]){
                const p=productsMap[val];
                const disc=p.price-(p.price*(p.discount/100));
                box.innerHTML=p.discount>0?`ðŸ›’ Stock: <b>${p.stock}</b> &nbsp;|&nbsp; âœ¨ Price: <b>â‚¹${p.price.toFixed(2)}</b><br><small style="color:var(--danger);">ðŸ’¡ Default ${p.discount}% disc = â‚¹${disc.toFixed(2)}</small>`:`ðŸ›’ Stock: <b>${p.stock}</b> &nbsp;|&nbsp; âœ¨ Price: <b>â‚¹${p.price.toFixed(2)}</b>`;
                box.style.display='block';
                if(dc&&mode==='auto'){dc.style.display='block';updateDiscPreview();}
            } else { box.style.display='none'; if(dc) dc.style.display='none'; }
        }
        function addToCart() {
            const pId=document.getElementById('orderItemInput').value;
            const qty=parseInt(document.getElementById('orderQty').value);
            if(!pId||!qty||qty<=0) return toast("Invalid Qty or Item not found","error");
            if(!productsMap[pId]) return toast("Please select a valid item from the list","error");
            const pData=productsMap[pId];
            let finalUnitPrice=0;
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            if(mode==='manual'){
                const mPrice=parseFloat(document.getElementById('manualPriceInput').value);
                if(isNaN(mPrice)||mPrice<0) return toast("Please enter a valid manual price","error");
                finalUnitPrice=mPrice;
            } else {
                const extraDisc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
                finalUnitPrice=pData.price-(pData.price*extraDisc/100);
            }
            const existing=cart.find(i=>i.id===pId);
            const totalQty=(existing?existing.qty:0)+qty;
            if(totalQty>pData.stock) return toast("Stock Limit! Only "+pData.stock+" left.","error");
            if(existing){existing.qty+=qty;existing.price=finalUnitPrice;existing.total=existing.qty*finalUnitPrice;}
            else cart.push({id:pId,qty,price:finalUnitPrice,total:qty*finalUnitPrice});
            renderCart();
            document.getElementById('orderItemInput').value="";
            document.getElementById('orderQty').value="";
            if(mode==='manual') document.getElementById('manualPriceInput').value="";
            if(document.getElementById('itemDiscInput')) document.getElementById('itemDiscInput').value="";
            if(document.getElementById('discPricePreview')) document.getElementById('discPricePreview').innerText="";
            if(document.getElementById('itemDiscContainer')) document.getElementById('itemDiscContainer').style.display='none';
            showPriceInfo();
        }
        function undoCart(){if(cart.length>0){cart.pop();renderCart();}}
        function renderCart() {
            const list=document.getElementById('cartList');
            list.innerHTML=""; let grand=0;
            cart.forEach((item,i)=>{
                grand+=item.total;
                list.innerHTML+=`<div class="flex-between" style="font-size:14px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);">
                    <span><b>${item.id}</b> <span style="color:#64748b;">(x${item.qty}) @ â‚¹${item.price.toFixed(2)}</span></span>
                    <span style="font-weight:700;">â‚¹${item.total.toFixed(2)} <span onclick="cart.splice(${i},1);renderCart();" style="color:#f43f5e;cursor:pointer;margin-left:8px;">âœ–</span></span>
                </div>`;
            });
            document.getElementById('cartTotal').innerText="â‚¹ "+grand.toFixed(2);
            document.getElementById('cartCard').style.display=cart.length?'block':'none';
        }
        async function placeFinalOrder() {
            const shop=document.getElementById('orderShop').value;
            if(!shop||!cart.length) return toast("Empty Shop/Cart","error");
            const btn = document.getElementById('btnPlace');
            btn.innerText="Processing..."; btn.disabled=true;
            const orderObj = {
                shopName: shop, items: [...cart],
                total: cart.reduce((s,i)=>s+i.total,0),
                salesman: userData.name,
                localTime: new Date().toISOString()
            };
            // ---- OFFLINE: queue and show WA modal ----
            if (!isOnline) {
                const q = getOfflineQueue();
                q.push(orderObj);
                saveOfflineQueue(q);
                updateOfflineBadge();
                toast("ðŸ“µ Saved offline â€” will sync when online", "success");
                cart=[]; renderCart();
                btn.innerText="Place Final Order"; btn.disabled=false;
                openWAModal(orderObj);
                return;
            }
            // ---- ONLINE: normal flow ----
            try {
                for(let i of cart){
                    const ref=db.collection("products").doc(i.id);
                    await db.runTransaction(async t=>{const doc=await t.get(ref);t.update(ref,{stock:doc.data().stock-i.qty});});
                }
                await db.collection("orders").add({
                    shopName:orderObj.shopName, items:orderObj.items,
                    total:orderObj.total, salesman:orderObj.salesman,
                    time:firebase.firestore.FieldValue.serverTimestamp(),
                    deliveryStatus: 'pending'
                });
                cart=[]; renderCart();
                btn.innerText="Place Final Order"; btn.disabled=false;
                openWAModal(orderObj);
            } catch(e) {
                toast(e.message,"error");
                btn.innerText="Place Final Order"; btn.disabled=false;
            }
        }
        // Helper: for each item in a sale, delete matching purchase qty from purchases collection (FIFO - oldest first)
        async function deletePurchasesForSaleItems(items) {
            // Build a map: itemName -> totalQtyToDelete
            const qtyMap = {};
            for (const item of items) {
                const name = item.id;
                qtyMap[name] = (qtyMap[name] || 0) + item.qty;
            }

            for (const [itemName, totalQty] of Object.entries(qtyMap)) {
                let remaining = totalQty;

                // Get purchase docs for this item (no orderBy to avoid index error)
                const snap = await db.collection("purchases")
                    .where("item", "==", itemName)
                    .get();

                // Sort client-side: oldest first (ascending by time)
                const docs = snap.docs.sort((a, b) => {
                    const tA = a.data().time ? a.data().time.toMillis() : 0;
                    const tB = b.data().time ? b.data().time.toMillis() : 0;
                    return tA - tB;
                });

                for (const doc of docs) {
                    if (remaining <= 0) break;
                    const d = doc.data();
                    const docQty = d.addedStock || 0;

                    if (docQty <= remaining) {
                        // Delete entire document
                        await db.collection("purchases").doc(doc.id).delete();
                        remaining -= docQty;
                    } else {
                        // Reduce quantity partially
                        await db.collection("purchases").doc(doc.id).update({
                            addedStock: docQty - remaining
                        });
                        remaining = 0;
                    }
                }
                // If remaining > 0, no more purchases to deduct â€” that's okay
            }
        }

        async function deleteOrder(idx) {
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                // Save full order data before deletion for undo
                const orderSnap = await db.collection("orders").doc(d.orderId).get();
                const orderData = orderSnap.exists ? orderSnap.data() : null;

                // Save purchase entries deleted for undo
                const deletedPurchases = [];
                for(const item of d.items){
                    const snap=await db.collection("purchases").where("item","==",item.id).get();
                    snap.docs.forEach(doc=>deletedPurchases.push({id:doc.id,data:doc.data()}));
                }

                await deletePurchasesForSaleItems(d.items);
                await db.collection("orders").doc(d.orderId).delete();
                toast("ðŸ—‘ï¸ Order deleted","success");

                const orderId = d.orderId;
                pushUndo(`Order #${orderId.substring(0,6).toUpperCase()} deleted`, async () => {
                    // Restore order
                    if(orderData) await db.collection("orders").doc(orderId).set(orderData);
                    // Restore stock (reverse the purchase deletions)
                    for(const item of d.items){
                        const ref=db.collection("products").doc(item.id);
                        await db.runTransaction(async t=>{
                            const pDoc=await t.get(ref);
                            if(pDoc.exists) t.update(ref,{stock:pDoc.data().stock+item.qty});
                        });
                    }
                });
            }catch(e){toast("Error: "+e.message,"error");}
        }
        async function editOrder(idx) {
            if(!confirm("Edit: This will move items back to cart and delete the order. Proceed?")) return;
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                for(let item of d.items){const ref=db.collection("products").doc(item.id);await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:pDoc.data().stock+item.qty});});}
                await db.collection("orders").doc(d.orderId).delete();
                cart=[...d.items];
                const sel=document.getElementById('orderShop');
                for(let i=0;i<sel.options.length;i++){if(sel.options[i].value===d.shopName){sel.selectedIndex=i;break;}}
                renderCart(); switchView('order');
                toast("Order moved to cart!","success");
            }catch(e){toast("Error: "+e.message,"error");}
        }

        // ===== MANAGER CRUD =====
        async function addShop() {
            const n=document.getElementById('shopName').value.trim();
            if(!n) return toast("Shop name required","error");
            const createdBy = document.getElementById('shopCreatedBy').value || '';
            const area = document.getElementById('shopArea').value.trim();
            await db.collection("shops").doc(n.replace(/\//g,'-')).set({
                name: n.replace(/\//g,'-'),
                phone: document.getElementById('shopPhone').value,
                addr: document.getElementById('shopAddr').value,
                area: area,
                createdBy: createdBy,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            },{merge:true});
            toast("Shop Saved!","success");
            document.getElementById('shopName').value="";
            document.getElementById('shopPhone').value="";
            document.getElementById('shopAddr').value="";
            document.getElementById('shopArea').value="";
            document.getElementById('shopCreatedBy').value="";
        }
        async function addProduct() {
            let n=document.getElementById('prodName').value.trim();
            const s=parseInt(document.getElementById('prodStock').value);
            const p=parseFloat(document.getElementById('prodPrice').value);
            const cp=parseFloat(document.getElementById('prodCostPrice').value);
            if(!n||isNaN(s)) return toast("Name and valid stock required","error");
            if(n.includes('/')) n=n.replace(/\//g,'-');
            const ref=db.collection("products").doc(n);
            const doc=await ref.get();
            let finalS=doc.exists?doc.data().stock+s:s;
            let finalP=isNaN(p)?(doc.exists?doc.data().price:0):p;
            let finalCP=isNaN(cp)?(doc.exists?doc.data().costPrice||0:0):cp;
            let finalD=doc.exists?(doc.data().discount||0):0;
            await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
            if(s>0) await db.collection("purchases").add({item:n,addedStock:s,price:finalP,costPrice:finalCP,dealer:document.getElementById('purchaseInfo').value,time:firebase.firestore.FieldValue.serverTimestamp()});
            toast("Stock Updated!","success");
            document.getElementById('prodName').value=""; document.getElementById('prodStock').value=""; document.getElementById('prodPrice').value=""; document.getElementById('prodCostPrice').value=""; document.getElementById('purchaseInfo').value="";
        }
        async function editProduct(id, oldStock, oldPrice, oldDisc, oldCostPrice) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nStock=prompt(`Edit Stock for "${id}":`,oldStock); if(nStock===null) return;
            let nPrice=prompt(`Edit Selling Price for "${id}" (â‚¹):`,oldPrice); if(nPrice===null) return;
            let nCostPrice=prompt(`Edit Purchase/Cost Price for "${id}" (â‚¹):`,oldCostPrice); if(nCostPrice===null) return;
            let nDisc=prompt(`Edit Discount % for "${id}":`,oldDisc); if(nDisc===null) return;
            try{
                await db.collection("products").doc(id).update({
                    stock:parseInt(nStock),
                    price:parseFloat(nPrice),
                    costPrice:parseFloat(nCostPrice)||0,
                    discount:parseFloat(nDisc)||0
                });
                toast("Product updated!","success");
            }catch(e){toast(e.message,"error");}
        }
        async function editPurchase(docId,item,oldQty,oldPrice,oldCostPrice,oldDealer) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nQty=prompt(`Edit Qty for ${item}:`,oldQty); if(nQty===null) return;
            let nPrice=prompt(`Edit Selling Price (â‚¹):`,oldPrice); if(nPrice===null) return;
            let nCP=prompt(`Edit Cost Price (â‚¹):`,oldCostPrice); if(nCP===null) return;
            let nDealer=prompt(`Edit Dealer:`,oldDealer); if(nDealer===null) return;
            try{await db.collection("purchases").doc(docId).update({addedStock:parseInt(nQty),price:parseFloat(nPrice),costPrice:parseFloat(nCP)||0,dealer:nDealer});toast("Updated!","success");}catch(e){toast(e.message,"error");}
        }
        async function deleteProduct(id) {
            try{
                const snap = await db.collection("products").doc(id).get();
                if(!snap.exists) return toast("Product not found","error");
                const data = snap.data();
                await db.collection("products").doc(id).delete();
                toast("ðŸ—‘ï¸ Product deleted","success");
                pushUndo(`"${id}" deleted`, async () => {
                    await db.collection("products").doc(id).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deletePurchaseRecord(id) {
            try{
                const purchDoc=await db.collection("purchases").doc(id).get();
                if(!purchDoc.exists) return toast("Record not found","error");
                const pData=purchDoc.data();
                const itemName=pData.item, addedQty=pData.addedStock||0;
                if(itemName&&addedQty>0){
                    const prodRef=db.collection("products").doc(itemName);
                    await db.runTransaction(async t=>{
                        const prodDoc=await t.get(prodRef);
                        if(prodDoc.exists) t.update(prodRef,{stock:Math.max(0,(prodDoc.data().stock||0)-addedQty)});
                    });
                }
                await db.collection("purchases").doc(id).delete();
                toast(`ðŸ—‘ï¸ Purchase record deleted â€” stock reduced by ${addedQty}`,"success");
                pushUndo("Purchase record deleted", async () => {
                    await db.collection("purchases").doc(id).set(pData);
                    if(itemName && addedQty>0){
                        const prodRef=db.collection("products").doc(itemName);
                        await db.runTransaction(async t=>{
                            const prodDoc=await t.get(prodRef);
                            if(prodDoc.exists) t.update(prodRef,{stock:(prodDoc.data().stock||0)+addedQty});
                        });
                    }
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deleteShop() {
            const shopId=document.getElementById('delShopSelect').value;
            if(!shopId) return toast("Select a shop","error");
            try{
                const snap = await db.collection("shops").doc(shopId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("shops").doc(shopId).delete();
                toast("ðŸ—‘ï¸ Shop deleted","success");
                document.getElementById('delShopSelect').value="";
                pushUndo(`Shop "${shopId}" deleted`, async () => {
                    if(data) await db.collection("shops").doc(shopId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        // ===== SHOP LIST (MANAGER PANEL) =====
        let allShopsArray = [];

        function renderShopList() {
            const search = (document.getElementById('shopListSearch')?.value || '').toLowerCase();
            const container = document.getElementById('shopListContainer');
            if (!container) return;

            const filtered = allShopsArray.filter(s =>
                s.name.toLowerCase().includes(search) ||
                (s.phone || '').includes(search) ||
                (s.addr || '').toLowerCase().includes(search) ||
                (s.area || '').toLowerCase().includes(search) ||
                (s.createdBy || '').toLowerCase().includes(search)
            );

            if (!filtered.length) {
                container.innerHTML = `<div style="text-align:center; color:#64748b; font-size:13px; padding:16px;">No shops found.</div>`;
                return;
            }

            container.innerHTML = filtered.map((s, idx) => {
                const creator = s.createdBy || '';
                const phone = s.phone || '';
                const addr = s.addr || '';
                const area = s.area || '';
                // encode for data attribute
                const encoded = encodeURIComponent(JSON.stringify({id:s.id, name:s.name, phone, addr, area, createdBy:creator}));
                return `
                <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:16px; padding:14px 16px; margin-bottom:10px; transition:box-shadow 0.2s;" onmouseover="this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.boxShadow='none'">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:800; font-size:15px; color:var(--text); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
                                <span style="background:var(--primary-light); color:var(--primary); border-radius:8px; padding:2px 7px; font-size:11px; font-weight:700;">#${idx+1}</span>
                                ðŸª ${s.name}
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
                                ${phone ? `<span style="background:rgba(16,185,129,0.1); color:#065f46; border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">ðŸ“ž ${phone}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">ðŸ“ž No phone</span>`}
                                ${area ? `<span style="background:rgba(245,158,11,0.1); color:#b45309; border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">ðŸ—ºï¸ ${area}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">ðŸ—ºï¸ No area</span>`}
                                ${creator ? `<span style="background:rgba(99,102,241,0.1); color:var(--primary); border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">ðŸ‘¤ ${creator}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">ðŸ‘¤ No maker</span>`}
                            </div>
                            ${addr ? `<div style="font-size:11px; color:#64748b; margin-top:6px; display:flex; align-items:flex-start; gap:4px;"><span>ðŸ“</span><span>${addr}</span></div>` : `<div style="font-size:11px; color:#94a3b8; margin-top:6px;">ðŸ“ No address</div>`}
                        </div>
                        <button onclick='openEditShopFull(${JSON.stringify({id:s.id, name:s.name, phone:phone, addr:addr, area:area, createdBy:creator})})'
                            style="background:linear-gradient(135deg,var(--primary),#6366f1); color:white; border:none; border-radius:10px; padding:8px 14px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; flex-shrink:0; box-shadow:0 4px 12px rgba(79,70,229,0.3); transition:transform 0.15s, box-shadow 0.15s;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 18px rgba(79,70,229,0.4)'"
                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(79,70,229,0.3)'">
                            âœï¸ Edit
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateShopListFromGlobal() {
            allShopsArray = Object.entries(globalShops).map(([id, d]) => ({
                id, name: d.name || id, phone: d.phone || '', addr: d.addr || '', area: d.area || '', createdBy: d.createdBy || ''
            })).sort((a, b) => a.name.localeCompare(b.name));

            const badge = document.getElementById('shopListCountBadge');
            if (badge) badge.textContent = allShopsArray.length;

            // Populate datalist for edit modal
            const dl = document.getElementById('editShopMakerList');
            if (dl) {
                const salesmen = [...new Set(allShopsArray.map(s => s.createdBy).filter(Boolean))];
                // also add users from globalShops createdBy
                dl.innerHTML = salesmen.map(n => `<option value="${n}">`).join('');
            }

            renderShopList();
        }

        function openEditShopFull(shopObj) {
            document.getElementById('editShopMakerShopId').value = shopObj.id;
            document.getElementById('editShopOrigName').textContent = `ID: ${shopObj.id}`;
            document.getElementById('editShopNameInput').value = shopObj.name || '';
            document.getElementById('editShopPhoneInput').value = shopObj.phone || '';
            document.getElementById('editShopAddrInput').value = shopObj.addr || '';
            document.getElementById('editShopMakerInput').value = shopObj.createdBy || '';

            // Populate area select from globalAreas
            const areaEl = document.getElementById('editShopAreaInput');
            if (areaEl) {
                const curArea = shopObj.area || '';
                areaEl.innerHTML = '<option value="">-- Select Area --</option>';
                globalAreas.forEach(a => {
                    areaEl.innerHTML += `<option value="${a.name}"${a.name === curArea ? ' selected' : ''}>${a.name}</option>`;
                });
                areaEl.value = curArea;
            }

            const modal = document.getElementById('editShopMakerModal');
            modal.style.display = 'flex';
            // Populate datalist with salesman names
            if (window.db) {
                db.collection('users').get().then(snap => {
                    const names = snap.docs.map(d => d.data().name || d.id).filter(Boolean);
                    const dl = document.getElementById('editShopMakerList');
                    if (dl) dl.innerHTML = names.map(n => `<option value="${n}">`).join('');
                });
            }
        }

        // keep old name as alias for any residual calls
        function openEditShopMaker(shopId, shopName, currentMaker) {
            openEditShopFull({ id: shopId, name: shopName, phone: '', addr: '', createdBy: currentMaker === 'â€”' ? '' : currentMaker });
        }

        function closeEditShopMaker() {
            document.getElementById('editShopMakerModal').style.display = 'none';
        }

        async function saveShopFull() {
            const shopId = document.getElementById('editShopMakerShopId').value;
            const newName = document.getElementById('editShopNameInput').value.trim();
            const newPhone = document.getElementById('editShopPhoneInput').value.trim();
            const newAddr = document.getElementById('editShopAddrInput').value.trim();
            const newArea = document.getElementById('editShopAreaInput').value.trim();
            const newMaker = document.getElementById('editShopMakerInput').value.trim();

            if (!shopId) return toast('Shop ID missing', 'error');
            if (!newName) return toast('Shop name is required', 'error');

            try {
                const updateData = {
                    name: newName,
                    phone: newPhone,
                    addr: newAddr,
                    area: newArea,
                    createdBy: newMaker
                };

                // If name changed and it's used as doc ID, we need special handling
                if (newName !== shopId) {
                    // Just update fields; doc ID stays same
                    await db.collection('shops').doc(shopId).update(updateData);
                } else {
                    await db.collection('shops').doc(shopId).update(updateData);
                }

                toast('âœ… Shop updated successfully!', 'success');
                closeEditShopMaker();
            } catch (e) {
                toast(e.message, 'error');
            }
        }

        // keep old save as alias
        async function saveShopMaker() { await saveShopFull(); }

        // =============================================
        // ===== BACKUP & RESTORE SYSTEM =====
        // =============================================

        // Collections to backup (order matters for restore)
        const BACKUP_COLLECTIONS = [
            'areas', 'shops', 'products', 'orders',
            'purchases', 'due_entries', 'returns',
            'shop_notes', 'visits', 'users'
        ];

        let _restoreFileData = null;

        // ---- BACKUP ----
        async function runBackup() {
            const btn = document.getElementById('backupBtn');
            const statusMsg = document.getElementById('backupStatusMsg');
            const progressWrap = document.getElementById('backupProgressWrap');
            const progressBar = document.getElementById('backupProgressBar');
            const progressLabel = document.getElementById('backupProgressLabel');

            btn.disabled = true;
            btn.textContent = 'â³ Backing up...';
            statusMsg.style.display = 'block';
            progressWrap.style.display = 'block';

            const backup = {
                version: 1,
                createdAt: new Date().toISOString(),
                appName: 'Order With Me ERP',
                collections: {}
            };

            try {
                for (let i = 0; i < BACKUP_COLLECTIONS.length; i++) {
                    const col = BACKUP_COLLECTIONS[i];
                    const pct = Math.round((i / BACKUP_COLLECTIONS.length) * 90);
                    progressBar.style.width = pct + '%';
                    progressLabel.textContent = `Reading: ${col} (${i + 1}/${BACKUP_COLLECTIONS.length})...`;
                    statusMsg.textContent = `ðŸ“¦ Fetching ${col}...`;

                    try {
                        const snap = await db.collection(col).get();
                        backup.collections[col] = {};
                        snap.forEach(doc => {
                            // Convert Firestore Timestamps to serializable format
                            backup.collections[col][doc.id] = _serializeDoc(doc.data());
                        });
                    } catch (e) {
                        // Collection may not exist yet â€” skip
                        backup.collections[col] = {};
                    }
                }

                progressBar.style.width = '100%';
                progressLabel.textContent = 'Generating file...';
                statusMsg.textContent = 'ðŸ’¾ Preparing download...';

                // Build filename with timestamp
                const now = new Date();
                const ts = now.getFullYear() + '-' +
                    String(now.getMonth() + 1).padStart(2, '0') + '-' +
                    String(now.getDate()).padStart(2, '0') + '_' +
                    String(now.getHours()).padStart(2, '0') + '-' +
                    String(now.getMinutes()).padStart(2, '0');
                const filename = `OWM_Backup_${ts}.json`;

                // Download
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 5000);

                // Count total docs
                const totalDocs = Object.values(backup.collections).reduce((s, c) => s + Object.keys(c).length, 0);
                progressLabel.textContent = `âœ… Done! ${totalDocs} records saved to ${filename}`;
                statusMsg.textContent = `âœ… Backup complete â€” ${totalDocs} records`;
                statusMsg.style.color = '#10b981';
                btn.textContent = 'âœ… Backup Downloaded!';
                toast(`âœ… Backup saved: ${filename}`, 'success');

                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'ðŸ’¾ Download Backup Now';
                    statusMsg.style.display = 'none';
                    progressWrap.style.display = 'none';
                    progressBar.style.width = '0%';
                    statusMsg.style.color = 'var(--primary)';
                }, 4000);

            } catch (e) {
                statusMsg.textContent = 'âŒ Backup failed: ' + e.message;
                statusMsg.style.color = '#f43f5e';
                btn.disabled = false;
                btn.textContent = 'ðŸ’¾ Download Backup Now';
                toast('Backup failed: ' + e.message, 'error');
            }
        }

        function _serializeDoc(data) {
            if (!data || typeof data !== 'object') return data;
            const result = {};
            for (const [k, v] of Object.entries(data)) {
                if (v && typeof v === 'object' && typeof v.toDate === 'function') {
                    // Firestore Timestamp
                    result[k] = { __type: 'timestamp', value: v.toDate().toISOString() };
                } else if (v instanceof Array) {
                    result[k] = v.map(item => (item && typeof item === 'object') ? _serializeDoc(item) : item);
                } else if (v && typeof v === 'object' && v.constructor === Object) {
                    result[k] = _serializeDoc(v);
                } else {
                    result[k] = v;
                }
            }
            return result;
        }

        // ---- RESTORE ----
        function onRestoreFileSelected(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('restoreFileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    _restoreFileData = JSON.parse(e.target.result);
                    if (!_restoreFileData.collections || !_restoreFileData.version) {
                        throw new Error('Invalid backup file format.');
                    }
                    const totalDocs = Object.values(_restoreFileData.collections).reduce((s, c) => s + Object.keys(c).length, 0);
                    document.getElementById('restoreFileName').textContent =
                        `${file.name} â€” ${totalDocs} records, backed up on ${_restoreFileData.createdAt ? new Date(_restoreFileData.createdAt).toLocaleString() : 'unknown date'}`;
                    document.getElementById('restoreFileName').style.color = '#10b981';
                    document.getElementById('restoreBtn').disabled = false;
                } catch (err) {
                    _restoreFileData = null;
                    document.getElementById('restoreFileName').textContent = 'âŒ Invalid file: ' + err.message;
                    document.getElementById('restoreFileName').style.color = '#f43f5e';
                    document.getElementById('restoreBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        async function runRestore() {
            if (!_restoreFileData) return toast('Please select a valid backup file first.', 'error');

            const confirmed = confirm(
                'âš ï¸ RESTORE WARNING\n\n' +
                'This will OVERWRITE all existing data in Firestore with the backup file.\n\n' +
                'Backed up on: ' + (_restoreFileData.createdAt ? new Date(_restoreFileData.createdAt).toLocaleString() : 'unknown') + '\n\n' +
                'Are you absolutely sure? This cannot be undone.'
            );
            if (!confirmed) return;

            const btn = document.getElementById('restoreBtn');
            const statusMsg = document.getElementById('restoreStatusMsg');
            const progressWrap = document.getElementById('restoreProgressWrap');
            const progressBar = document.getElementById('restoreProgressBar');
            const progressLabel = document.getElementById('restoreProgressLabel');

            btn.disabled = true;
            btn.textContent = 'â³ Restoring...';
            statusMsg.style.display = 'block';
            statusMsg.style.color = 'var(--primary)';
            progressWrap.style.display = 'block';

            try {
                const collections = _restoreFileData.collections;
                const colNames = Object.keys(collections);
                let totalWritten = 0;

                for (let i = 0; i < colNames.length; i++) {
                    const col = colNames[i];
                    const docs = collections[col];
                    const docIds = Object.keys(docs);
                    const pct = Math.round((i / colNames.length) * 95);
                    progressBar.style.width = pct + '%';
                    statusMsg.textContent = `ðŸ“¥ Restoring: ${col} (${docIds.length} records)...`;
                    progressLabel.textContent = `Collection ${i + 1}/${colNames.length}: ${col}`;

                    // Write in batches of 400 (Firestore batch limit is 500)
                    const BATCH_SIZE = 400;
                    for (let j = 0; j < docIds.length; j += BATCH_SIZE) {
                        const batch = db.batch();
                        const chunk = docIds.slice(j, j + BATCH_SIZE);
                        chunk.forEach(docId => {
                            const data = _deserializeDoc(docs[docId]);
                            batch.set(db.collection(col).doc(docId), data);
                        });
                        await batch.commit();
                        totalWritten += chunk.length;
                    }
                }

                progressBar.style.width = '100%';
                progressLabel.textContent = `âœ… Restore complete â€” ${totalWritten} records written`;
                statusMsg.textContent = `âœ… Restore successful! ${totalWritten} records restored.`;
                statusMsg.style.color = '#10b981';
                btn.textContent = 'âœ… Restored!';
                toast(`âœ… Restore complete â€” ${totalWritten} records written. Refresh the page.`, 'success');

                // Reset file input
                setTimeout(() => {
                    document.getElementById('restoreFileInput').value = '';
                    document.getElementById('restoreFileName').textContent = 'No file selected (.json)';
                    document.getElementById('restoreFileName').style.color = '#94a3b8';
                    _restoreFileData = null;
                    btn.disabled = true;
                    btn.textContent = 'ðŸ“¥ Restore Data';
                    statusMsg.style.display = 'none';
                    progressWrap.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 5000);

            } catch (e) {
                statusMsg.textContent = 'âŒ Restore failed: ' + e.message;
                statusMsg.style.color = '#f43f5e';
                progressLabel.textContent = 'Error occurred. Please try again.';
                btn.disabled = false;
                btn.textContent = 'ðŸ“¥ Restore Data';
                toast('Restore failed: ' + e.message, 'error');
            }
        }

        function _deserializeDoc(data) {
            if (!data || typeof data !== 'object') return data;
            if (data.__type === 'timestamp') {
                return firebase.firestore.Timestamp.fromDate(new Date(data.value));
            }
            const result = {};
            for (const [k, v] of Object.entries(data)) {
                if (v && typeof v === 'object' && v.__type === 'timestamp') {
                    result[k] = firebase.firestore.Timestamp.fromDate(new Date(v.value));
                } else if (Array.isArray(v)) {
                    result[k] = v.map(item => (item && typeof item === 'object') ? _deserializeDoc(item) : item);
                } else if (v && typeof v === 'object' && v.constructor === Object) {
                    result[k] = _deserializeDoc(v);
                } else {
                    result[k] = v;
                }
            }
            return result;
        }

        // =============================================
        // ===== MONTHLY DATA RESET SYSTEM =====
        // =============================================

        // Populate year dropdown on page load
        (function initResetYearDropdown() {
            const yearSel = document.getElementById('resetYear');
            if (!yearSel) return;
            const currentYear = new Date().getFullYear();
            // Show current year and past 3 years
            for (let y = currentYear; y >= currentYear - 3; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSel.appendChild(opt);
            }
            // Default: last month
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            document.getElementById('resetMonth').value = lastMonth.getMonth();
            yearSel.value = lastMonth.getFullYear();
        })();

        // Returns all orders in the selected month from historyData
        function _getOrdersInMonth(month, year) {
            return historyData.filter(d => {
                if (!d.time) return false;
                const date = d.time.toDate();
                return date.getMonth() === month && date.getFullYear() === year;
            });
        }

        async function previewMonthReset() {
            const month = parseInt(document.getElementById('resetMonth').value);
            const year  = parseInt(document.getElementById('resetYear').value);
            const monthName = new Date(year, month, 1).toLocaleString('default', { month: 'long' });

            const previewBox = document.getElementById('resetPreviewBox');
            const resetBtn   = document.getElementById('resetBtn');
            previewBox.style.display = 'block';
            previewBox.innerHTML = '<span style="color:#94a3b8;">â³ Scanning orders...</span>';

            // Fetch fresh from Firestore (not just historyData cache)
            const startDate = new Date(year, month, 1);
            const endDate   = new Date(year, month + 1, 0, 23, 59, 59);

            try {
                const snap = await db.collection('orders')
                    .where('time', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                    .where('time', '<=', firebase.firestore.Timestamp.fromDate(endDate))
                    .get();

                const orders = [];
                snap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                if (orders.length === 0) {
                    previewBox.innerHTML = `
                        <div style="color:#94a3b8; text-align:center; padding:8px;">
                            ðŸ“­ No orders found for <b>${monthName} ${year}</b>.
                        </div>`;
                    resetBtn.disabled = true;
                    return;
                }

                // Calculate totals
                const totalRevenue = orders.reduce((s, o) => s + (o.total || 0), 0);
                const shopSet      = new Set(orders.map(o => o.shopName).filter(Boolean));
                const itemMap      = {};
                orders.forEach(o => {
                    (o.items || []).forEach(i => {
                        itemMap[i.id] = (itemMap[i.id] || 0) + i.qty;
                    });
                });
                const totalItems = Object.values(itemMap).reduce((s, q) => s + q, 0);

                previewBox.innerHTML = `
                    <div style="font-weight:800; font-size:13px; color:var(--text); margin-bottom:10px;">
                        ðŸ“Š Preview â€” <span style="color:var(--primary);">${monthName} ${year}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                        <div style="background:rgba(244,63,94,0.08); border:1px solid rgba(244,63,94,0.2); border-radius:10px; padding:10px; text-align:center;">
                            <div style="font-size:22px; font-weight:900; color:#f43f5e;">${orders.length}</div>
                            <div style="font-size:11px; color:#64748b; font-weight:600;">Orders to Delete</div>
                        </div>
                        <div style="background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.2); border-radius:10px; padding:10px; text-align:center;">
                            <div style="font-size:22px; font-weight:900; color:var(--primary);">â‚¹${totalRevenue.toFixed(0)}</div>
                            <div style="font-size:11px; color:#64748b; font-weight:600;">Total Revenue</div>
                        </div>
                        <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2); border-radius:10px; padding:10px; text-align:center;">
                            <div style="font-size:22px; font-weight:900; color:#10b981;">${shopSet.size}</div>
                            <div style="font-size:11px; color:#64748b; font-weight:600;">Unique Shops</div>
                        </div>
                        <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.2); border-radius:10px; padding:10px; text-align:center;">
                            <div style="font-size:22px; font-weight:900; color:#f59e0b;">${totalItems}</div>
                            <div style="font-size:11px; color:#64748b; font-weight:600;">Total Qty Sold</div>
                        </div>
                    </div>
                    <div style="font-size:11px; color:#64748b; border-top:1px solid var(--border); padding-top:8px; margin-top:4px;">
                        ðŸ”„ <b>${Object.keys(itemMap).length} products</b> will have their stock restored after reset.
                    </div>
                    <div style="font-size:11px; color:#10b981; font-weight:700; margin-top:5px;">
                        âœ… Due entries, returns, visits & notes will NOT be affected.
                    </div>`;

                // Store orders on the button for use in runMonthReset
                resetBtn._monthOrders = orders;
                resetBtn._monthLabel  = `${monthName} ${year}`;
                resetBtn.disabled = false;

            } catch(e) {
                previewBox.innerHTML = `<span style="color:#f43f5e;">âŒ Error: ${e.message}</span>`;
                resetBtn.disabled = true;
            }
        }

        async function runMonthReset() {
            const btn          = document.getElementById('resetBtn');
            const orders       = btn._monthOrders;
            const monthLabel   = btn._monthLabel || 'selected month';

            if (!orders || orders.length === 0) return toast('Run Preview first.', 'error');

            // Step 1 â€” double confirm
            const c1 = confirm(
                `âš ï¸  MONTH RESET â€” ${monthLabel}\n\n` +
                `You are about to permanently delete ${orders.length} orders.\n` +
                `Stock will be automatically restored for each deleted order.\n\n` +
                `Due entries, returns and purchases will NOT be touched.\n\n` +
                `Have you taken a backup? Press OK to continue.`
            );
            if (!c1) return;

            const c2 = confirm(
                `ðŸ”´ FINAL CONFIRMATION\n\n` +
                `Delete all ${orders.length} orders from ${monthLabel}?\n\nThis CANNOT be undone.`
            );
            if (!c2) return;

            // Setup UI
            const progressWrap  = document.getElementById('resetProgressWrap');
            const progressBar   = document.getElementById('resetProgressBar');
            const progressLabel = document.getElementById('resetProgressLabel');
            const previewBox    = document.getElementById('resetPreviewBox');

            btn.disabled = true;
            btn.textContent = 'â³ Resetting...';
            progressWrap.style.display = 'block';

            let deleted = 0;
            const errors = [];

            try {
                for (let i = 0; i < orders.length; i++) {
                    const order = orders[i];
                    const pct = Math.round(((i + 1) / orders.length) * 100);
                    progressBar.style.width = pct + '%';
                    progressLabel.textContent = `Deleting order ${i + 1} of ${orders.length}  (${pct}%)`;

                    try {
                        // 1. Delete matching purchase entries for this order's items (stock stays same)
                        await deletePurchasesForSaleItems(order.items || []);

                        // 2. Delete the order document
                        await db.collection('orders').doc(order.id).delete();
                        deleted++;

                    } catch (orderErr) {
                        errors.push(`Order ${order.id}: ${orderErr.message}`);
                    }
                }

                // Done
                progressBar.style.width = '100%';
                progressLabel.textContent = `âœ… Complete â€” ${deleted} orders deleted, purchase records updated`;

                previewBox.innerHTML = `
                    <div style="text-align:center; padding:10px;">
                        <div style="font-size:32px; margin-bottom:8px;">âœ…</div>
                        <div style="font-weight:800; font-size:15px; color:var(--success); margin-bottom:6px;">Reset Complete!</div>
                        <div style="font-size:13px; color:var(--text); margin-bottom:4px;">
                            <b>${deleted}</b> orders from <b>${monthLabel}</b> deleted.
                        </div>
                        <div style="font-size:12px; color:#64748b;">
                            ðŸ“¦ Purchase records updated â€” stock unchanged.
                        </div>
                        ${errors.length ? `<div style="font-size:11px; color:#f43f5e; margin-top:8px;">âš ï¸ ${errors.length} error(s) occurred.</div>` : ''}
                    </div>`;

                toast(`âœ… Reset complete â€” ${deleted} orders deleted, purchase records updated.`, 'success');

                // Reset button state after 5 sec
                setTimeout(() => {
                    btn.textContent = 'ðŸ—‘ï¸ Reset Selected Month';
                    btn.disabled = true;
                    btn._monthOrders = null;
                    progressWrap.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 5000);

            } catch(e) {
                progressLabel.textContent = 'âŒ Reset failed: ' + e.message;
                btn.disabled = false;
                btn.textContent = 'ðŸ—‘ï¸ Reset Selected Month';
                toast('Reset failed: ' + e.message, 'error');
            }
        }


        let dcCurrentIdx = -1;

        function openDeliveryConfirm(idx) {
            const d = historyData[idx];
            if (!d) return;
            dcCurrentIdx = idx;

            // Shop & order info
            const timeS = d.time ? d.time.toDate().toLocaleString() : '';
            document.getElementById('dcShopInfo').innerHTML =
                `ðŸª <b>${d.shopName}</b> &nbsp;Â·&nbsp; ðŸ“… ${timeS} &nbsp;Â·&nbsp; ðŸ‘¤ ${d.salesman}`;

            // Ordered total
            document.getElementById('dcOrderedTotal').textContent = 'â‚¹ ' + d.total.toFixed(2);

            // Build item rows
            const container = document.getElementById('dcItemsContainer');
            container.innerHTML = d.items.map((item, i) => {
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                return `
                <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:12px 14px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="font-weight:700; font-size:13px; color:var(--text); flex:1;">${item.id}</div>
                        <div style="font-size:11px; color:#64748b;">â‚¹${unitPrice.toFixed(2)}/unit</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:11px; color:#94a3b8; min-width:80px;">
                            Ordered: <b style="color:var(--text);">${item.qty}</b>
                        </div>
                        <div style="flex:1; display:flex; align-items:center; gap:6px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; white-space:nowrap;">Actual:</label>
                            <input type="number" id="dcQty_${i}" value="${item.qty}" min="0" max="${item.qty * 5}"
                                class="input-field"
                                style="margin:0; text-align:center; font-weight:800; font-size:15px; color:var(--success); padding:8px; border-color:rgba(16,185,129,0.4);"
                                oninput="dcUpdateTotal()">
                        </div>
                        <div id="dcItemTotal_${i}" style="font-size:13px; font-weight:700; color:var(--primary); min-width:70px; text-align:right;">
                            â‚¹${item.total.toFixed(2)}
                        </div>
                    </div>
                </div>`;
            }).join('');

            dcUpdateTotal();
            document.getElementById('deliveryConfirmModal').style.display = 'flex';
        }

        function dcUpdateTotal() {
            const d = historyData[dcCurrentIdx];
            if (!d) return;
            let deliveredTotal = 0;
            d.items.forEach((item, i) => {
                const inp = document.getElementById(`dcQty_${i}`);
                if (!inp) return;
                const actualQty = Math.max(0, parseFloat(inp.value) || 0);
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                const lineTotal = actualQty * unitPrice;
                deliveredTotal += lineTotal;
                const el = document.getElementById(`dcItemTotal_${i}`);
                if (el) el.textContent = 'â‚¹' + lineTotal.toFixed(2);
            });
            document.getElementById('dcDeliveredTotal').textContent = 'â‚¹ ' + deliveredTotal.toFixed(2);
        }

        async function confirmDelivery() {
            const d = historyData[dcCurrentIdx];
            if (!d || !d.orderId) return toast('Order not found', 'error');

            const deliveredItems = d.items.map((item, i) => {
                const inp = document.getElementById(`dcQty_${i}`);
                const actualQty = Math.max(0, parseFloat(inp?.value) || 0);
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                return {
                    ...item,
                    orderedQty: item.qty,
                    qty: actualQty,
                    total: parseFloat((actualQty * unitPrice).toFixed(2)),
                    price: unitPrice
                };
            });

            const deliveredTotal = deliveredItems.reduce((s, it) => s + it.total, 0);

            // Stock adjustment: return the difference for items not fully taken
            try {
                for (const item of deliveredItems) {
                    const diff = item.orderedQty - item.qty; // qty NOT delivered = return to stock
                    if (diff > 0) {
                        const ref = db.collection('products').doc(item.id);
                        await db.runTransaction(async t => {
                            const doc = await t.get(ref);
                            if (doc.exists) t.update(ref, { stock: (doc.data().stock || 0) + diff });
                        });
                    }
                }

                await db.collection('orders').doc(d.orderId).update({
                    items: deliveredItems,
                    total: parseFloat(deliveredTotal.toFixed(2)),
                    deliveryStatus: 'delivered',
                    deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    orderedTotal: d.total
                });

                toast('âœ… Delivery confirmed!', 'success');
                closeDeliveryConfirm();
            } catch (e) {
                toast(e.message, 'error');
            }
        }

        function closeDeliveryConfirm() {
            document.getElementById('deliveryConfirmModal').style.display = 'none';
            dcCurrentIdx = -1;
        }

        // ===== ATTENDANCE SYSTEM =====
        let attCurrentDate = '';
        let attSalesmenList = [];
        let attCurrentData = {};   // { uid: status }
        let attBarChart, attPieChart, attLineChart;
        let attExportArray = [];

        function todayISO() {
            const d = new Date();
            return d.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        function initAttendanceView() {
            // Set today's date in picker
            const picker = document.getElementById('attDatePicker');
            if (!picker.value) picker.value = todayISO();
            updateAttDateLabel(picker.value);
            loadSalesmenForAtt();
            loadAttendanceForDate();
            populateAttSalesmanFilter();
            setAttReportDefaultDates();
        }

        function updateAttDateLabel(dateStr) {
            attCurrentDate = dateStr;
            const d = new Date(dateStr + 'T00:00:00');
            const label = d.toLocaleDateString('en-IN', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
            const el = document.getElementById('attDateLabel');
            if (el) el.textContent = 'ðŸ“… ' + label;
        }

        function loadSalesmenForAtt() {
            db.collection('users').get().then(snap => {
                attSalesmenList = snap.docs
                    .map(d => ({ uid: d.id, name: d.data().name || d.id, role: d.data().role || 'salesman' }))
                    .filter(u => u.role !== 'manager')
                    .sort((a,b) => a.name.localeCompare(b.name));
                renderAttGrid();
                populateAttSalesmanFilter();
            });
        }

        function renderAttGrid() {
            const grid = document.getElementById('attSalesmanGrid');
            if (!grid) return;
            if (!attSalesmenList.length) {
                grid.innerHTML = `<div style="text-align:center;color:#64748b;font-size:13px;padding:16px;">No salesmen found.</div>`;
                return;
            }
            grid.innerHTML = attSalesmenList.map(u => {
                const initials = u.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
                const cur = attCurrentData[u.uid] || 'present';
                return `
                <div class="att-salesman-row" id="attRow_${u.uid}">
                    <div class="att-avatar">${initials}</div>
                    <div style="flex:1; min-width:0;">
                        <div class="att-name">${u.name}</div>
                        <div class="att-status-btns" style="margin-top:6px;">
                            <button class="att-status-btn ${cur==='present'?'selected-present':''}" onclick="setAttStatus('${u.uid}','present',this)">âœ… Present</button>
                            <button class="att-status-btn ${cur==='absent'?'selected-absent':''}"  onclick="setAttStatus('${u.uid}','absent',this)">âŒ Absent</button>
                            <button class="att-status-btn ${cur==='halfday'?'selected-halfday':''}" onclick="setAttStatus('${u.uid}','halfday',this)">ðŸŒ— Half Day</button>
                            <button class="att-status-btn ${cur==='leave'?'selected-leave':''}"   onclick="setAttStatus('${u.uid}','leave',this)">ðŸ–ï¸ Leave</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function setAttStatus(uid, status, btn) {
            attCurrentData[uid] = status;
            // Update button styles in this row
            const row = document.getElementById('attRow_' + uid);
            if (!row) return;
            row.querySelectorAll('.att-status-btn').forEach(b => {
                b.classList.remove('selected-present','selected-absent','selected-halfday','selected-leave');
            });
            btn.classList.add('selected-' + status);
        }

        function attMarkAll(status) {
            attSalesmenList.forEach(u => {
                attCurrentData[u.uid] = status;
            });
            renderAttGrid();
        }

        async function loadAttendanceForDate() {
            const dateStr = document.getElementById('attDatePicker').value;
            if (!dateStr) return;
            updateAttDateLabel(dateStr);
            attCurrentData = {};
            try {
                const snap = await db.collection('attendance').doc(dateStr).get();
                if (snap.exists) {
                    const data = snap.data().records || {};
                    attCurrentData = data;
                    const badge = document.getElementById('attTodayBadge');
                    if (badge) badge.textContent = 'âœ… Saved';
                } else {
                    // Default all present
                    attSalesmenList.forEach(u => { attCurrentData[u.uid] = 'present'; });
                    const badge = document.getElementById('attTodayBadge');
                    if (badge) badge.textContent = '';
                }
                renderAttGrid();
            } catch(e) {
                attSalesmenList.forEach(u => { attCurrentData[u.uid] = 'present'; });
                renderAttGrid();
            }
        }

        async function saveAttendance() {
            const dateStr = document.getElementById('attDatePicker').value;
            if (!dateStr) return toast('Select a date first', 'error');
            if (!attSalesmenList.length) return toast('No salesmen found', 'error');
            const records = {};
            attSalesmenList.forEach(u => {
                records[u.uid] = attCurrentData[u.uid] || 'present';
            });
            try {
                await db.collection('attendance').doc(dateStr).set({
                    date: dateStr,
                    records,
                    savedBy: userData.name,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const badge = document.getElementById('attTodayBadge');
                if (badge) badge.textContent = 'âœ… Saved';
                toast('âœ… Attendance saved for ' + dateStr, 'success');
            } catch(e) { toast(e.message, 'error'); }
        }

        function populateAttSalesmanFilter() {
            const sel = document.getElementById('attRepSalesman');
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="all">All Salesmen</option>';
            attSalesmenList.forEach(u => {
                sel.innerHTML += `<option value="${u.uid}">${u.name}</option>`;
            });
            if (cur) sel.value = cur;
        }

        function setAttReportDefaultDates() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('attRepStart').value = firstDay.toISOString().split('T')[0];
            document.getElementById('attRepEnd').value   = now.toISOString().split('T')[0];
        }

        function attReportPreset(period, btn) {
            document.querySelectorAll('#att-report .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const now = new Date();
            let start, end = now.toISOString().split('T')[0];
            if (period === 'week') {
                const day = now.getDay() || 7;
                start = new Date(now); start.setDate(now.getDate() - day + 1);
                start = start.toISOString().split('T')[0];
            } else if (period === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            } else if (period === 'lastmonth') {
                start = new Date(now.getFullYear(), now.getMonth()-1, 1).toISOString().split('T')[0];
                end   = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
            } else {
                start = '2020-01-01';
            }
            document.getElementById('attRepStart').value = start;
            document.getElementById('attRepEnd').value   = end;
        }

        function clearAttPresets() {
            document.querySelectorAll('#att-report .preset-btn').forEach(b=>b.classList.remove('active-preset'));
        }

        async function generateAttReport() {
            const startStr = document.getElementById('attRepStart').value;
            const endStr   = document.getElementById('attRepEnd').value;
            const selSm    = document.getElementById('attRepSalesman').value;
            if (!startStr || !endStr) return toast('Select date range', 'error');

            toast('Generating report...', 'success');

            try {
                const snap = await db.collection('attendance')
                    .where('date', '>=', startStr)
                    .where('date', '<=', endStr)
                    .orderBy('date', 'asc')
                    .get();

                if (snap.empty) { toast('No attendance data found for this period', 'error'); return; }

                // Build date list
                const dates = snap.docs.map(d => d.data().date);
                const totalDays = dates.length;

                // Aggregate per salesman
                const smMap = {}; // { uid: { name, present, absent, halfday, leave } }
                const dailyPresent = {}; // { date: count }

                snap.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.date;
                    const records = data.records || {};
                    dailyPresent[date] = 0;
                    Object.entries(records).forEach(([uid, status]) => {
                        if (selSm !== 'all' && uid !== selSm) return;
                        if (!smMap[uid]) {
                            const sm = attSalesmenList.find(u => u.uid === uid);
                            smMap[uid] = { name: sm ? sm.name : uid, present:0, absent:0, halfday:0, leave:0 };
                        }
                        smMap[uid][status] = (smMap[uid][status] || 0) + 1;
                        if (status === 'present' || status === 'halfday') dailyPresent[date]++;
                    });
                });

                if (!Object.keys(smMap).length) { toast('No data for selected salesman', 'error'); return; }

                // Stats
                const smArr = Object.entries(smMap).map(([uid, v]) => ({ uid, ...v }));
                const totalPresent = smArr.reduce((s,r) => s+r.present+r.halfday, 0);
                const totalAbsent  = smArr.reduce((s,r) => s+r.absent, 0);
                const totalCells   = smArr.reduce((s,r) => s+r.present+r.absent+r.halfday+r.leave, 0);
                const avgPct = totalCells > 0 ? ((totalPresent / totalCells) * 100).toFixed(1) : 0;

                document.getElementById('attStatDays').textContent    = totalDays;
                document.getElementById('attStatPresent').textContent = totalPresent;
                document.getElementById('attStatAbsent').textContent  = totalAbsent;
                document.getElementById('attStatAvg').textContent     = avgPct + '%';
                document.getElementById('attRepStats').style.display  = 'block';

                // â”€â”€ Bar Chart â”€â”€
                const barCtx = document.getElementById('attBarChart').getContext('2d');
                if (attBarChart) attBarChart.destroy();
                attBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: smArr.map(r => r.name),
                        datasets: [
                            { label: 'Present',  data: smArr.map(r=>r.present),  backgroundColor: '#10b981', borderRadius: 6 },
                            { label: 'Half Day', data: smArr.map(r=>r.halfday),  backgroundColor: '#f59e0b', borderRadius: 6 },
                            { label: 'Absent',   data: smArr.map(r=>r.absent),   backgroundColor: '#f43f5e', borderRadius: 6 },
                            { label: 'Leave',    data: smArr.map(r=>r.leave),    backgroundColor: '#6366f1', borderRadius: 6 },
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position:'top', labels:{font:{size:11}} } },
                        scales: {
                            x: { stacked: true, ticks:{font:{size:10}} },
                            y: { stacked: true, beginAtZero: true, ticks:{stepSize:1} }
                        }
                    }
                });

                // â”€â”€ Pie Chart â”€â”€
                const pieCtx = document.getElementById('attPieChart').getContext('2d');
                if (attPieChart) attPieChart.destroy();
                attPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'Half Day', 'Absent', 'Leave'],
                        datasets: [{ data: [
                            smArr.reduce((s,r)=>s+r.present,0),
                            smArr.reduce((s,r)=>s+r.halfday,0),
                            smArr.reduce((s,r)=>s+r.absent,0),
                            smArr.reduce((s,r)=>s+r.leave,0)
                        ], backgroundColor: ['#10b981','#f59e0b','#f43f5e','#6366f1'], borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{position:'bottom', labels:{font:{size:11}}} } }
                });

                // â”€â”€ Line Chart (daily present count) â”€â”€
                const lineCtx = document.getElementById('attLineChart').getContext('2d');
                if (attLineChart) attLineChart.destroy();
                attLineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{ label: 'Present (incl. half day)', data: dates.map(d=>dailyPresent[d]||0),
                            borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)',
                            fill: true, tension: 0.35, pointRadius: 4, pointBackgroundColor: '#6366f1' }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend:{ display:false } },
                        scales: { y:{ beginAtZero:true, ticks:{stepSize:1} }, x:{ ticks:{font:{size:9}, maxTicksLimit:12} } }
                    }
                });

                // â”€â”€ Detail Table â”€â”€
                const tbody = document.getElementById('attDetailBody');
                tbody.innerHTML = '';
                attExportArray = [];
                smArr.forEach(r => {
                    const total = r.present + r.absent + r.halfday + r.leave;
                    const pct = total > 0 ? ((r.present + r.halfday) / total * 100).toFixed(1) : 0;
                    const color = pct >= 90 ? '#10b981' : pct >= 75 ? '#f59e0b' : '#f43f5e';
                    tbody.innerHTML += `<tr>
                        <td style="font-weight:700;">${r.name}</td>
                        <td style="color:#10b981;font-weight:700;">${r.present}</td>
                        <td style="color:#f43f5e;font-weight:700;">${r.absent}</td>
                        <td style="color:#f59e0b;font-weight:700;">${r.halfday}</td>
                        <td style="color:#6366f1;font-weight:700;">${r.leave}</td>
                        <td>${total}</td>
                        <td>
                            <span style="font-weight:800;color:${color};">${pct}%</span>
                            <div class="att-pct-bar"><div class="att-pct-bar-fill" style="width:${pct}%;background:${color};"></div></div>
                        </td>
                    </tr>`;
                    attExportArray.push({ Salesman:r.name, Present:r.present, Absent:r.absent, 'Half Day':r.halfday, Leave:r.leave, 'Total Days':total, 'Attendance %': pct+'%' });
                });

                // â”€â”€ Daily breakdown per salesman â”€â”€
                const breakdown = document.getElementById('attDailyBreakdown');
                breakdown.innerHTML = `<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px;">ðŸ“… Daily Breakdown</div>`;
                smArr.forEach(r => {
                    if (selSm !== 'all' && r.uid !== selSm) return;
                    let cells = '';
                    snap.docs.forEach(doc => {
                        const recs = doc.data().records || {};
                        const status = recs[r.uid] || 'â€“';
                        const emoji = {present:'âœ…',absent:'âŒ',halfday:'ðŸŒ—',leave:'ðŸ–ï¸'}[status] || 'â€“';
                        const bg = {present:'rgba(16,185,129,0.1)',absent:'rgba(244,63,94,0.08)',halfday:'rgba(245,158,11,0.1)',leave:'rgba(99,102,241,0.08)'}[status]||'var(--bg)';
                        cells += `<div style="background:${bg};border-radius:6px;padding:4px 6px;font-size:10px;text-align:center;min-width:44px;">
                            <div style="font-size:13px;">${emoji}</div>
                            <div style="color:#64748b;font-size:9px;">${doc.data().date.slice(5)}</div>
                        </div>`;
                    });
                    breakdown.innerHTML += `
                    <div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:8px;">
                        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">${r.name}</div>
                        <div style="display:flex;flex-wrap:wrap;gap:5px;">${cells}</div>
                    </div>`;
                });

                toast('âœ… Report generated!', 'success');
            } catch(e) { toast(e.message, 'error'); console.error(e); }
        }

        function exportAttExcel() {
            if (!attExportArray.length) return toast('Generate report first', 'error');
            exportDataExcel(attExportArray, 'Attendance_Report');
        }

        function exportAttPDF() {
            if (!attExportArray.length) return toast('Generate report first', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');
            toast('Generating PDF...');
            const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(30,41,59);
            doc.text('Attendance Report', 14, 14);
            doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(100,116,139);
            doc.text('Generated: ' + today, pageW - 14, 14, {align:'right'});
            doc.autoTable({
                head: [['Salesman','Present','Absent','Half Day','Leave','Total Days','Attendance %']],
                body: attExportArray.map(r => [r.Salesman, r.Present, r.Absent, r['Half Day'], r.Leave, r['Total Days'], r['Attendance %']]),
                startY: 20, margin:{left:10,right:10},
                styles:{font:'helvetica',fontSize:10,cellPadding:4,overflow:'linebreak',lineColor:[203,213,225],lineWidth:0.3,textColor:[26,26,46],valign:'middle',minCellHeight:8},
                headStyles:{fillColor:[241,245,249],textColor:[26,26,46],fontStyle:'bold',fontSize:9,lineColor:[26,26,46],lineWidth:0.5},
                alternateRowStyles:{fillColor:[248,250,252]},
                didDrawPage:(data)=>{ doc.setFontSize(8); doc.setTextColor(148,163,184); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'}); },
                showHead:'everyPage'
            });
            doc.save('Attendance_Report_' + today.replace(/ /g,'_') + '.pdf');
            toast('âœ… PDF saved!', 'success');
        }

        // ===== OFFLINE MODE =====
        const OFFLINE_QUEUE_KEY = 'owm_offline_queue';
        let isOnline = navigator.onLine;
        let lastPlacedOrder = null;

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const bar = document.getElementById('offlineBar');
            if (bar) {
                bar.style.display = isOnline ? 'none' : 'block';
                updateOfflineBadge();
            }
            const appScreen = document.getElementById('app-screen');
            if (appScreen) appScreen.style.paddingTop = (!isOnline) ? '40px' : '';
            if (isOnline) syncOfflineQueue();
        }

        function getOfflineQueue() {
            try { return JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]'); }
            catch(e) { return []; }
        }

        function saveOfflineQueue(q) {
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(q));
        }

        function updateOfflineBadge() {
            const q = getOfflineQueue();
            const el = document.getElementById('offlinePendingCount');
            if (el) el.textContent = q.length > 0 ? `${q.length} order${q.length>1?'s':''} pending sync` : '';
        }

        async function syncOfflineQueue() {
            const q = getOfflineQueue();
            if (!q.length) return;
            let synced = 0;
            const remaining = [];
            for (const item of q) {
                try {
                    // Deduct stock
                    for (let i of item.items) {
                        const ref = db.collection('products').doc(i.id);
                        await db.runTransaction(async t => {
                            const doc = await t.get(ref);
                            if (doc.exists) t.update(ref, { stock: Math.max(0, doc.data().stock - i.qty) });
                        });
                    }
                    // Save order (without serverTimestamp since we store local time)
                    await db.collection('orders').add({
                        shopName: item.shopName, items: item.items, total: item.total,
                        salesman: item.salesman, time: firebase.firestore.Timestamp.fromDate(new Date(item.localTime)),
                        syncedFromOffline: true
                    });
                    synced++;
                } catch(e) {
                    remaining.push(item); // keep failed ones
                }
            }
            saveOfflineQueue(remaining);
            updateOfflineBadge();
            if (synced > 0) toast(`âœ… ${synced} offline order${synced>1?'s':''} synced!`, 'success');
        }

        window.addEventListener('online',  updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // ===== WHATSAPP INVOICE =====
        function openWAModal(orderObj) {
            lastPlacedOrder = orderObj;
            // Build summary
            const total = orderObj.total.toFixed(2);
            const itemCount = orderObj.items.length;
            document.getElementById('waSummaryText').innerHTML =
                `<b>${orderObj.shopName}</b> &nbsp;Â·&nbsp; ${itemCount} item${itemCount>1?'s':''} &nbsp;Â·&nbsp; <b>â‚¹${total}</b>`;
            // Auto-fill shop phone
            const shopData = globalShops[orderObj.shopName];
            const phone = shopData && shopData.phone ? shopData.phone.replace(/[^0-9]/g,'').slice(-10) : '';
            document.getElementById('waPhoneInput').value = phone;
            const hint = document.getElementById('waSavedPhoneHint');
            if (hint) hint.style.display = phone ? 'block' : 'none';
            const modal = document.getElementById('waModal');
            modal.style.display = 'flex';
        }

        function closeWAModal() {
            document.getElementById('waModal').style.display = 'none';
            lastPlacedOrder = null;
            switchView('history');
        }

        function sendWAInvoice() {
            if (!lastPlacedOrder) return;
            const d = lastPlacedOrder;
            const rawPhone = document.getElementById('waPhoneInput').value.replace(/[^0-9]/g,'');
            const dateStr = new Date().toLocaleDateString('en-GB');
            let msg = `ðŸ›’ *Order With Me â€” Invoice*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸª *Shop:* ${d.shopName}\nðŸ“… *Date:* ${dateStr}\nðŸ‘¤ *Sales Rep:* ${d.salesman}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            d.items.forEach((item, i) => {
                msg += `${i+1}. ${item.id}\n   ${item.qty} Ã— â‚¹${item.price.toFixed(2)} = â‚¹${item.total.toFixed(2)}\n`;
            });
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’° *Grand Total: â‚¹${d.total.toFixed(2)}*\n\n_Thank you for your business!_ ðŸ™`;
            const phone = rawPhone.length >= 10 ? '91' + rawPhone.slice(-10) : '';
            const url = phone
                ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
            closeWAModal();
        }

        // ===== CARD STATE MEMORY =====
        const CARD_STATE_KEY = 'owm_card_states_';
        function _cardStateKey() { return CARD_STATE_KEY + (userData.user || 'default'); }

        function loadCardStates() {
            try { return JSON.parse(localStorage.getItem(_cardStateKey()) || '{}'); } catch(e) { return {}; }
        }
        function saveCardState(id, isOpen) {
            try {
                const states = loadCardStates();
                states[id] = isOpen;
                localStorage.setItem(_cardStateKey(), JSON.stringify(states));
            } catch(e) {}
        }

        // ===== COLLAPSIBLE ADMIN PANEL (with state memory) =====
        function toggleCollapse(id) {
            const body  = document.getElementById(id);
            const arrow = document.getElementById('arrow-' + id);
            const isOpen = body.style.display !== 'none' && body.style.display !== '';
            body.style.display = isOpen ? 'none' : 'block';
            if (arrow) arrow.classList.toggle('open', !isOpen);
            saveCardState(id, !isOpen);
            // Lazy-load triggers
            if (id === 'col-users'   && !isOpen) loadUserList();
            if (id === 'col-offline' && !isOpen) renderOfflineQueueList();
        }

        // Restore saved card states for admin panel
        function restoreAdminCardStates() {
            const states = loadCardStates();
            const cardIds = ['col-offline','col-daily','col-shop','col-product',
                             'col-users','col-delete','col-incentive-calc'];
            cardIds.forEach(id => {
                const body  = document.getElementById(id);
                const arrow = document.getElementById('arrow-' + id);
                if (!body) return;
                // Default: all closed. Only open if explicitly saved as true.
                const shouldOpen = states[id] === true;
                body.style.display = shouldOpen ? 'block' : 'none';
                if (arrow) arrow.classList.toggle('open', shouldOpen);
            });
            // Lazy-load for cards that are open on restore
            if (states['col-users']   === true) loadUserList();
            if (states['col-offline'] === true) renderOfflineQueueList();
        }

        // ===== USER MANAGEMENT =====
        let resetTargetUid = null;
        let resetTargetName = null;

        async function loadUserList() {
            const container = document.getElementById('userListContainer');
            if (!container) return;
            try {
                const snap = await db.collection('users').orderBy('name').get();
                if (snap.empty) {
                    container.innerHTML = '<div style="text-align:center; color:#64748b; font-size:13px; padding:12px;">No users found.</div>';
                    return;
                }
                let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const roleColor = d.role === 'manager' ? '#6366f1' : '#10b981';
                    const roleLabel = d.role === 'manager' ? 'âš™ï¸ Manager' : 'ðŸ‘¤ Salesman';
                    const isMe = userData && userData.uid === doc.id;
                    html += `<div style="display:flex; align-items:center; justify-content:space-between; background:var(--bg); border-radius:12px; padding:12px 14px; border:1px solid var(--border);">
                        <div>
                            <div style="font-weight:700; font-size:14px;">${d.name || d.user}${isMe ? ' <span style="font-size:10px; color:#6366f1;">(You)</span>' : ''}</div>
                            <div style="font-size:11px; color:#64748b; margin-top:2px;">@${d.user} &nbsp;Â·&nbsp; <span style="color:${roleColor}; font-weight:600;">${roleLabel}</span></div>
                        </div>
                        <div style="display:flex; gap:7px; flex-wrap:wrap; margin-top:8px;">
                            <button onclick="openResetModal('${doc.id}', '${(d.name||d.user).replace(/'/g,"\\\'")}')"
                                style="padding:6px 11px; border-radius:9px; border:1.5px solid #6366f1; background:transparent; color:#6366f1; font-weight:700; font-size:11px; cursor:pointer; font-family:'Poppins',sans-serif;">
                                ðŸ”‘ Reset Password
                            </button>
                            <button onclick="showUserPassword('${doc.id}', '${(d.name||d.user).replace(/'/g,"\\\'")}')"
                                style="padding:6px 11px; border-radius:9px; border:1.5px solid #f59e0b; background:transparent; color:#d97706; font-weight:700; font-size:11px; cursor:pointer; font-family:'Poppins',sans-serif;">
                                ðŸ‘ï¸ Show Password
                            </button>
                            ${!isMe ? `<button onclick="confirmDeleteUser('${doc.id}', '${(d.name||d.user).replace(/'/g,"\\\'")}')"
                                style="padding:6px 11px; border-radius:9px; border:1.5px solid #f43f5e; background:transparent; color:#f43f5e; font-weight:700; font-size:11px; cursor:pointer; font-family:'Poppins',sans-serif;">
                                ðŸ—‘ï¸ Delete Account
                            </button>` : ''}
                        </div>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = '<div style="text-align:center; color:#e11d48; font-size:13px; padding:12px;">Failed to load users.</div>';
            }
        }

        function openResetModal(uid, name) {
            resetTargetUid = uid;
            resetTargetName = name;
            document.getElementById('resetModalTitle').innerText = name + ' â€” Password Reset';
            document.getElementById('resetModalSub').innerText = name + ' â€” Enter a new password';
            document.getElementById('newPassInput').value = '';
            document.getElementById('confirmPassInput').value = '';
            const modal = document.getElementById('resetPassModal');
            modal.style.display = 'flex';
        }

        function closeResetModal() {
            document.getElementById('resetPassModal').style.display = 'none';
            resetTargetUid = null;
            resetTargetName = null;
        }

        // ===== SHOW USER PASSWORD =====
        async function showUserPassword(uid, name) {
            try {
                const doc = await db.collection('users').doc(uid).get();
                if (!doc.exists) return toast('âŒ User not found.', 'error');
                const d = doc.data();
                const pass = d.password || d.pass || '(not stored)';
                document.getElementById('showPassModalName').innerText = name;
                document.getElementById('showPassModalPass').innerText = pass;
                document.getElementById('showPassModal').style.display = 'flex';
            } catch(e) {
                toast('âŒ Failed: ' + e.message, 'error');
            }
        }

        function closeShowPassModal() {
            document.getElementById('showPassModal').style.display = 'none';
        }

        // ===== DELETE USER ACCOUNT =====
        function confirmDeleteUser(uid, name) {
            if (!confirm(`âš ï¸ Are you sure you want to DELETE "${name}"?\n\nThis action cannot be undone!`)) return;
            deleteUserAccount(uid, name);
        }

        async function deleteUserAccount(uid, name) {
            try {
                // Save user data for undo
                const userSnap = await db.collection('users').doc(uid).get();
                const userData2 = userSnap.exists ? userSnap.data() : null;
                let pendingResetData = null;
                try {
                    const prSnap = await db.collection('pending_resets').doc(uid).get();
                    if(prSnap.exists) pendingResetData = prSnap.data();
                } catch(e){}

                await db.collection('users').doc(uid).delete();
                try { await db.collection('pending_resets').doc(uid).delete(); } catch(e) {}
                toast(`âœ… Account "${name}" deleted successfully.`, 'success');
                loadUserList();

                pushUndo(`User "${name}" deleted`, async () => {
                    if(userData2) await db.collection('users').doc(uid).set(userData2);
                    if(pendingResetData) await db.collection('pending_resets').doc(uid).set(pendingResetData);
                    loadUserList();
                });
            } catch(e) {
                toast('âŒ Delete failed: ' + e.message, 'error');
            }
        }

        // ===== PROFILE PICTURE =====
        function openProfilePicModal() {
            document.getElementById('profilePicInput').click();
        }

        function handleProfilePicChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) return toast('âŒ Please select an image file.', 'error');
            if (file.size > 2 * 1024 * 1024) return toast('âŒ Image must be under 2MB.', 'error');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                try {
                    await db.collection('users').doc(userData.uid).update({ profilePic: base64 });
                    userData.profilePic = base64;
                    updateSidebarAvatar();
                    toast('âœ… Profile picture updated!', 'success');
                } catch(err) {
                    toast('âŒ Failed to save: ' + err.message, 'error');
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function updateSidebarAvatar() {
            const avatarEl = document.getElementById('sideAvatar');
            if (!avatarEl) return;
            const overlay = document.getElementById('avatarOverlay');
            if (userData && userData.profilePic) {
                avatarEl.style.backgroundImage = `url(${userData.profilePic})`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                // Keep only the overlay div
                if (overlay) {
                    avatarEl.innerHTML = '';
                    avatarEl.appendChild(overlay);
                } else {
                    avatarEl.innerHTML = '<div id="avatarOverlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;font-size:14px;border-radius:50%;opacity:0;transition:opacity 0.2s;">ðŸ“·</div>';
                }
                avatarEl.style.color = 'transparent';
            } else {
                avatarEl.style.backgroundImage = '';
                const initial = (userData && userData.name) ? userData.name.charAt(0).toUpperCase() : 'U';
                if (overlay) {
                    avatarEl.innerHTML = '';
                    const textNode = document.createTextNode(initial);
                    avatarEl.appendChild(textNode);
                    avatarEl.appendChild(overlay);
                } else {
                    avatarEl.innerHTML = initial + '<div id="avatarOverlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;font-size:14px;border-radius:50%;opacity:0;transition:opacity 0.2s;">ðŸ“·</div>';
                }
                avatarEl.style.color = 'white';
            }
        }

        async function confirmPasswordReset() {
            const newPass = document.getElementById('newPassInput').value;
            const confirmPass = document.getElementById('confirmPassInput').value;
            if (!newPass || newPass.length < 6) return toast('âŒ Password must be at least 6 characters.', 'error');
            if (newPass !== confirmPass) return toast('âŒ Passwords do not match!', 'error');

            const btn = document.getElementById('btnConfirmReset');
            btn.innerText = 'Processing...'; btn.disabled = true;

            try {
                // Save reset request to Firestore
                await db.collection('pending_resets').doc(resetTargetUid).set({
                    newPassword: newPass,
                    resetBy: userData.user,
                    resetAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                toast(`âœ… ${resetTargetName}'s password reset request saved. The new password will apply on next login.`, 'success');
                closeResetModal();
            } catch(e) {
                toast('âŒ Reset failed: ' + e.message, 'error');
            } finally { btn.innerText = 'âœ… Reset'; btn.disabled = false; }
        }

        async function checkPendingReset(uid) {
            try {
                const doc = await db.collection('pending_resets').doc(uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    const user = auth.currentUser;
                    if (user) {
                        await user.updatePassword(data.newPassword);
                        await db.collection('pending_resets').doc(uid).delete();
                        toast('ðŸ”‘ Your password has been reset by an Admin.', 'success');
                    }
                }
            } catch(e) { /* silent */ }
        }

        async function deleteProductFromAdmin() {
            const itemId=document.getElementById('delItemSelect').value;
            if(!itemId) return toast("Select an item","error");
            try{
                const snap = await db.collection("products").doc(itemId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("products").doc(itemId).delete();
                toast("ðŸ—‘ï¸ Item deleted","success");
                document.getElementById('delItemSelect').value="";
                pushUndo(`"${itemId}" deleted`, async () => {
                    if(data) await db.collection("products").doc(itemId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }

        // ===== BILLING =====
        // ===== BRAND / INVOICE SETTINGS =====
        let brandSettings = JSON.parse(localStorage.getItem('owm_brand') || '{}');

        function applyBrandSettings() {
            // Company name on bill
            const nameEl = document.getElementById('b-companyName');
            if (nameEl) nameEl.textContent = brandSettings.name || 'Order With Me';
            // Logo on bill
            const logoWrap = document.getElementById('b-logoWrap');
            const logoImg  = document.getElementById('b-logoImg');
            if (logoWrap && logoImg) {
                if (brandSettings.logo) {
                    logoImg.src = brandSettings.logo;
                    logoWrap.style.display = 'block';
                } else {
                    logoWrap.style.display = 'none';
                }
            }
            // Footer note
            const fn = document.getElementById('b-footerNote');
            if (fn) fn.textContent = brandSettings.footerNote || '';
            // Populate inputs if visible
            const ni = document.getElementById('brandNameInput');
            if (ni && !ni.value) ni.value = brandSettings.name || 'Order With Me';
            const fi = document.getElementById('brandFooterInput');
            if (fi && !fi.value) fi.value = brandSettings.footerNote || '';
            // Show current logo preview in manager panel
            const cp = document.getElementById('currentLogoPreview');
            const ci = document.getElementById('currentLogoImg');
            if (cp && ci) {
                if (brandSettings.logo) { ci.src = brandSettings.logo; cp.style.display = 'flex'; }
                else { cp.style.display = 'none'; }
            }
        }

        function handleLogoFile(file) {
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return toast('Logo too large (max 2MB)', 'error');
            const reader = new FileReader();
            reader.onload = e => {
                brandSettings.logo = e.target.result;
                // Show preview in drop zone
                document.getElementById('logoPreviewArea').innerHTML = `
                    <img src="${e.target.result}" style="max-height:60px; max-width:180px; object-fit:contain; border-radius:8px; margin-bottom:4px;">
                    <div style="font-size:11px; font-weight:700; color:var(--success);">âœ… Logo selected</div>`;
                applyBrandSettings();
            };
            reader.readAsDataURL(file);
        }

        function handleLogoDrop(e) {
            e.preventDefault();
            document.getElementById('logoDropZone').style.borderColor = 'rgba(99,102,241,0.4)';
            document.getElementById('logoDropZone').style.background = 'var(--bg)';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleLogoFile(file);
        }

        function removeLogo() {
            brandSettings.logo = '';
            document.getElementById('logoPreviewArea').innerHTML = `
                <div style="font-size:28px; margin-bottom:6px;">ðŸ–¼ï¸</div>
                <div style="font-size:13px; font-weight:600; color:#64748b;">Click or drag logo here</div>
                <div style="font-size:11px; color:#94a3b8; margin-top:3px;">PNG, JPG, SVG â€” max 2MB</div>`;
            applyBrandSettings();
            toast('Logo removed', 'success');
        }

        function saveBrandSettings() {
            brandSettings.name = document.getElementById('brandNameInput').value.trim() || 'Order With Me';
            brandSettings.footerNote = document.getElementById('brandFooterInput').value.trim();
            localStorage.setItem('owm_brand', JSON.stringify(brandSettings));
            applyBrandSettings();
            toast('âœ… Invoice settings saved!', 'success');
        }

        // Call on load
        setTimeout(applyBrandSettings, 800);

        function renderA5Bill() {
            const idxStr = document.getElementById('billingSelect').value;
            if (idxStr === '') { document.getElementById('bill-preview-section').style.display = 'none'; return; }
            const d = historyData[parseInt(idxStr)];
            if (!d) return;

            const shopData = globalShops[d.shopName] || {};

            // Apply brand settings
            applyBrandSettings();

            // Header info
            document.getElementById('b-shopName').textContent = d.shopName;
            document.getElementById('b-shopPhone').textContent = shopData.phone ? 'ðŸ“ž ' + shopData.phone : '';
            document.getElementById('b-shopAddr').textContent  = shopData.addr  ? 'ðŸ“ ' + shopData.addr  : '';
            document.getElementById('b-date').textContent      = d.time ? d.time.toDate().toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'}) : '';
            document.getElementById('b-salesman').textContent  = d.salesman || '';
            document.getElementById('b-orderId').textContent   = '#' + (d.orderId || '').substring(0, 8).toUpperCase();

            // Items table â€” each item on its own line with Rate, Qty, Amount columns
            let rows = '';
            let subTotal = 0;
            d.items.forEach((item, sl) => {
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                const lineTotal = item.total || (unitPrice * item.qty);
                subTotal += lineTotal;
                rows += `
                <tr>
                    <td class="col-sl">${sl + 1}</td>
                    <td class="col-desc">
                        <span class="prod-name">${item.id}</span>
                    </td>
                    <td class="col-rate">${unitPrice.toFixed(2)}</td>
                    <td class="col-qty">${item.qty}</td>
                    <td class="col-amt">${lineTotal.toFixed(2)}</td>
                </tr>`;
            });
            document.getElementById('b-itemsBody').innerHTML = rows;

            // Totals
            document.getElementById('b-subTotal').textContent  = subTotal.toFixed(2);
            document.getElementById('b-grandTotal').textContent = d.total.toFixed(2);

            // Hide discount row (can be enhanced later)
            document.getElementById('b-discountRow').style.display = 'none';

            document.getElementById('bill-preview-section').style.display = 'block';
        }
        function openPrintSizeModal() {
            document.getElementById('printSizeModal').style.display = 'flex';
        }
        function openBillSizePDFModal() {
            document.getElementById('billPDFSizeModal').style.display = 'flex';
        }

        function doPrint(size) {
            document.getElementById('printSizeModal').style.display = 'none';
            // Inject @page rule dynamically
            let styleEl = document.getElementById('print-page-style');
            if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = 'print-page-style'; document.head.appendChild(styleEl); }
            const sizeMap = { A4: 'A4', A5: 'A5', A6: '105mm 148mm' };
            styleEl.textContent = `@page { size: ${sizeMap[size] || '105mm 148mm'}; margin: 8mm; }`;
            setTimeout(() => window.print(), 120);
        }

        function downloadBillPDF(size) {
            document.getElementById('billPDFSizeModal').style.display = 'none';
            toast('Generating PDF...');
            const sizeMap = { A4: 'a4', A5: 'a5', A6: [105, 148] };
            const fmt = sizeMap[size] || [105, 148];
            const orderId = document.getElementById('b-orderId').innerText || 'Invoice';
            const zone = document.getElementById('a5-print-zone');

            // Force all rows to not break mid-row before render
            zone.querySelectorAll('tr, td, th').forEach(el => {
                el.style.pageBreakInside = 'avoid';
                el.style.breakInside = 'avoid';
            });

            html2pdf().set({
                margin:        [5, 5, 5, 5],
                filename:      'Invoice_' + orderId + '_' + size + '.pdf',
                image:         { type: 'jpeg', quality: 1.0 },
                html2canvas:   { scale: 3, useCORS: true, backgroundColor: '#ffffff', logging: false, letterRendering: true },
                jsPDF:         { unit: 'mm', format: fmt, orientation: 'portrait' },
                pagebreak:     { mode: 'avoid-all', avoid: ['tr','td','th','.bill-totals-block','.bill-sign-row','.bill-footer'] }
            }).from(zone).save().then(() => {
                toast('âœ… Invoice PDF saved!', 'success');
            });
        }

        // Legacy alias kept for any remaining calls
        function downloadA5PDF() { downloadBillPDF('A5'); }

        function exportAnyTable(tableId, reportName) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');

            const tableEl = document.getElementById(tableId);
            if (!tableEl) return toast('Table not found', 'error');

            // Find the actual <table> inside the container (or IS the table)
            const tbl = tableEl.tagName === 'TABLE' ? tableEl : tableEl.querySelector('table');
            if (!tbl) return toast('No table found inside element', 'error');

            toast('Generating PDF...');

            // Collect headers
            const headers = [];
            tbl.querySelectorAll('thead tr th').forEach(th => {
                if (th.classList.contains('no-print') || th.style.display === 'none') return;
                headers.push(th.innerText.trim());
            });

            // Collect rows
            const rows = [];
            tbl.querySelectorAll('tbody tr').forEach(tr => {
                if (tr.style.display === 'none') return;
                const row = [];
                tr.querySelectorAll('td').forEach((td, i) => {
                    if (td.classList.contains('no-print') || td.style.display === 'none') return;
                    row.push(td.innerText.trim().replace(/\n+/g, ' '));
                });
                if (row.length) rows.push(row);
            });

            if (!rows.length) return toast('No data rows to export', 'error');

            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'landscape' });
            const pageW = doc.internal.pageSize.getWidth();

            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(30, 41, 59);
            doc.text(reportName.replace(/_/g, ' '), 14, 14);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            doc.text('Generated: ' + new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'}), pageW - 14, 14, { align: 'right' });

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 20,
                margin: { left: 10, right: 10 },
                styles: {
                    font: 'helvetica',
                    fontSize: 9,
                    cellPadding: 4,
                    overflow: 'linebreak',
                    lineColor: [203, 213, 225],
                    lineWidth: 0.3,
                    textColor: [26, 26, 46],
                    valign: 'middle',
                    halign: 'left',
                    minCellHeight: 8
                },
                headStyles: {
                    fillColor: [241, 245, 249],
                    textColor: [26, 26, 46],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                    halign: 'left',
                    lineColor: [26, 26, 46],
                    lineWidth: 0.5
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                columnStyles: {
                    0: { cellWidth: 'auto' }
                },
                didDrawPage: (data) => {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(148, 163, 184);
                    doc.text(
                        'Page ' + doc.internal.getCurrentPageInfo().pageNumber,
                        pageW / 2, doc.internal.pageSize.getHeight() - 6,
                        { align: 'center' }
                    );
                },
                tableWidth: 'auto',
                showHead: 'everyPage'
            });

            doc.save(reportName + '.pdf');
            toast('âœ… PDF saved!', 'success');
        }
        function exportDataExcel(arr,name) {
            if(!arr||!arr.length) return toast("No data to export","error");
            toast("Exporting Excel...");
            const ws=XLSX.utils.json_to_sheet(arr);
            const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
            XLSX.writeFile(wb,name+".xlsx");
        }

        // ===== WHATSAPP â€” FIX: Always ask who to send to =====
        function shareWhatsApp() {
            const idxStr=document.getElementById('billingSelect').value;
            if(!idxStr) return toast("Select an order first","error");
            const d=historyData[parseInt(idxStr)]; if(!d) return;
            const dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
            let msg=`ðŸ›’ *Order With Me â€” Invoice*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸª *Shop:* ${d.shopName}\nðŸ“… *Date:* ${dateStr}\nðŸ‘¤ *Sales Rep:* ${d.salesman}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            d.items.forEach((item,i)=>{msg+=`${i+1}. ${item.id}\n   ${item.qty} Ã— â‚¹${item.price.toFixed(2)} = â‚¹${item.total.toFixed(2)}\n`;});
            msg+=`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’° *Grand Total: â‚¹${d.total.toFixed(2)}*\n\n_Thank you for your business!_ ðŸ™`;
            const phone = prompt(
                `Send WhatsApp invoice to:\n\nEnter phone number with country code (e.g. 919876543210)\nLeave blank to open WhatsApp without a pre-filled number.`,
                ""
            );
            if (phone === null) return; // User cancelled
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const url = cleanPhone
                ? `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // ===== DUE / CREDIT =====
        function getShopDueStats(shopName) {
            let totalBill = 0;
            historyData.forEach(d => { if(d.shopName === shopName) totalBill += d.total; });
            let totalPaid = 0;
            const entries = allDueData[shopName] || [];
            entries.forEach(e => { totalPaid += (e.payment || 0); });
            const remaining = totalBill - totalPaid;
            return { totalBill, totalPaid, remaining };
        }

        function onDueShopChange() {
            const shop = document.getElementById('dueShopSel').value;
            const summary = document.getElementById('dueShopBillSummary');
            if(!shop) { summary.style.display='none'; return; }
            summary.style.display='block';
            refreshDueShopSummaryPanel(shop);
        }

        function refreshDueShopSummaryPanel(shop) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shop);
            const paidPct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 100;
            const barColor = remaining <= 0 ? 'var(--success)' : (paidPct > 60 ? 'var(--warning)' : 'var(--danger)');
            document.getElementById('dueShopTotalBill').innerText = `â‚¹ ${totalBill.toFixed(2)}`;
            document.getElementById('dueShopTotalPaid').innerText = `â‚¹ ${totalPaid.toFixed(2)}`;
            const progressBar = document.getElementById('dueShopProgressBar');
            progressBar.style.width = `${paidPct.toFixed(0)}%`;
            progressBar.style.background = barColor;
            const remEl = document.getElementById('dueShopRemaining');
            if(remaining <= 0) {
                remEl.innerText = 'âœ… Fully Paid!';
                remEl.style.color = 'var(--success)';
            } else {
                remEl.innerText = `â‚¹ ${remaining.toFixed(2)}`;
                remEl.style.color = 'var(--danger)';
            }
        }

        function renderDueList() {
            const area = document.getElementById('dueListArea');
            const dueShopSel = document.getElementById('dueShopSel');
            if(!area) return;
            if(dueShopSel) {
                const curVal = dueShopSel.value;
                dueShopSel.innerHTML = '<option value="">-- Select Shop --</option>';
                Object.keys(globalShops).forEach(k => {
                    dueShopSel.innerHTML += `<option value="${k}">${globalShops[k].name || k}</option>`;
                });
                dueShopSel.value = curVal;
                if(curVal) refreshDueShopSummaryPanel(curVal);
            }

            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allShops[d.shopName].totalBill += d.total;
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });

            area.innerHTML = '';
            let grandTotalDue = 0;
            let allCardsHTML = '';

            if(!Object.keys(allShops).length) {
                area.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No orders or due entries found.</div>';
                document.getElementById('totalDueAmt').innerText = 'â‚¹ 0.00';
                return;
            }

            const sorted = Object.entries(allShops).sort((a,b) => {
                const dueA = a[1].totalBill - a[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                const dueB = b[1].totalBill - b[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                return dueB - dueA;
            });

            let shopCardIndex = 0;
            sorted.forEach(([shopName, data]) => {
                if(data.totalBill === 0 && data.payments.length === 0) return;

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if(!isCleared) grandTotalDue += remaining;

                const paidPct = data.totalBill > 0 ? Math.min(100, (data.totalPaid / data.totalBill) * 100) : 100;
                const barColor = isCleared ? '#10b981' : (paidPct > 60 ? '#f59e0b' : '#f43f5e');
                const borderColor = isCleared ? 'rgba(16,185,129,0.4)' : 'rgba(244,63,94,0.4)';
                const cardId = 'dsc_' + (shopCardIndex++);

                const payRows = data.payments.map(e => {
                    const ts = e.time ? e.time.toDate().toLocaleDateString('en-GB') : '';
                    const safeDocId = e.docId ? e.docId.replace(/'/g,"\\'") : '';
                    const canManage = (userData.role === 'manager');
                    const actionBtns = canManage && safeDocId ? `
                        <div style="display:flex;gap:4px;margin-left:8px;flex-shrink:0;">
                            <button class="action-btn action-btn-edit" onclick="editDueEntry('${safeDocId}',${e.payment||0},'${(e.note||'').replace(/'/g,"\\'")}')" title="Edit">âœï¸</button>
                            <button class="action-btn action-btn-delete" onclick="deleteDueEntry('${safeDocId}','${shopName.replace(/'/g,"\\'")}',${e.payment||0})" title="Delete">ðŸ—‘ï¸</button>
                        </div>` : '';
                    return `<div class="payment-row" style="align-items:flex-start;">
                        <div style="flex:1;">
                            <span style="color:var(--success); font-size:13px;">ðŸ’° ${ts}</span>
                            ${e.note ? `<span style="color:#94a3b8; font-size:11px; margin-left:4px;">(${e.note})</span>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">
                            <span style="color:var(--success); font-weight:700; font-size:13px;">- â‚¹${(e.payment||0).toFixed(2)}</span>
                            ${actionBtns}
                        </div>
                    </div>`;
                }).join('');

                const safeShopName = shopName.replace(/'/g, "\\'");
                const safeShopNameJson = JSON.stringify(shopName);

                allCardsHTML += `
                <div class="due-shop-card" style="border-left:4px solid ${borderColor}; padding:0; overflow:hidden;">
                    <!-- Card top bar: left=clickable collapse, right=PDF button (separate, no stopPropagation needed) -->
                    <div style="display:flex;align-items:stretch;background:var(--card);">
                        <div onclick="toggleDueCard('${cardId}')"
                            style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;
                                   padding:14px 12px 14px 16px;cursor:pointer;user-select:none;">
                            <span style="font-size:18px;flex-shrink:0;">${isCleared ? 'âœ…' : 'ðŸ”´'}</span>
                            <div style="min-width:0;flex:1;">
                                <div style="font-size:15px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ðŸª ${shopName}</div>
                                <div style="font-size:11px;color:#94a3b8;margin-top:1px;">${data.payments.length} payment(s) Â· ${paidPct.toFixed(0)}% paid</div>
                            </div>
                            <span class="due-badge ${isCleared?'cleared':'has-due'}" style="font-size:11px;padding:3px 10px;flex-shrink:0;">
                                ${isCleared ? 'Cleared' : 'â‚¹'+remaining.toFixed(2)}
                            </span>
                            <span id="${cardId}_arrow" style="color:#94a3b8;font-size:14px;transition:transform 0.25s;display:inline-block;flex-shrink:0;">â–¼</span>
                        </div>
                        <div style="display:flex;align-items:center;padding:0 12px;border-left:1px solid var(--border);flex-shrink:0;">
                            <button data-pdf-shop="${shopName}"
                                style="background:transparent;border:1.5px solid var(--primary);color:var(--primary);
                                       border-radius:8px;padding:6px 11px;font-size:11px;font-weight:700;cursor:pointer;
                                       font-family:'Poppins',sans-serif;white-space:nowrap;line-height:1.2;">ðŸ“„ PDF</button>
                        </div>
                    </div>
                    <div id="${cardId}" style="display:none;padding:14px 16px;border-top:1px solid var(--border);">
                        <div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:12px;">
                            <div class="due-stat-row"><span style="color:#64748b;">ðŸ“¦ Total Orders (Billed)</span><span style="font-weight:700;color:var(--text);">â‚¹ ${data.totalBill.toFixed(2)}</span></div>
                            <div class="due-stat-row"><span style="color:#64748b;">âœ… Total Paid</span><span style="font-weight:700;color:var(--success);">â‚¹ ${data.totalPaid.toFixed(2)}</span></div>
                            <div class="due-progress-wrap"><div class="due-progress-bar" style="width:${paidPct.toFixed(0)}%;background:${barColor};"></div></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#94a3b8;margin-bottom:8px;">
                                <span>${paidPct.toFixed(0)}% paid</span>
                                <span>${isCleared ? 'âœ… Complete' : (100-paidPct).toFixed(0)+'% remaining'}</span>
                            </div>
                            <div class="due-total-row">
                                <span style="font-size:14px;">${isCleared ? 'âœ… Fully Paid' : 'ðŸ”´ Remaining Due'}</span>
                                <span style="color:${isCleared?'var(--success)':'var(--danger)'};font-size:18px;">${isCleared ? 'â‚¹ 0.00' : 'â‚¹ '+remaining.toFixed(2)}</span>
                            </div>
                        </div>
                        ${data.payments.length > 0 ? `
                        <div style="margin-bottom:10px;">
                            <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Payment History</div>
                            ${payRows}
                        </div>` : `<div style="font-size:12px;color:#94a3b8;padding:6px 0;margin-bottom:10px;">No payments recorded yet.</div>`}
                        ${userData.role==='manager' && !isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-success" style="margin-bottom:0;padding:11px;font-size:13px;">
                            ðŸ’° Collect Due Payment (â‚¹${remaining.toFixed(2)})
                        </button>` : ''}
                        ${userData.role==='manager' && isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-outline" style="margin-bottom:0;padding:11px;font-size:12px;">
                            + Record More Payment
                        </button>` : ''}
                    </div>
                </div>`;
            });

            area.innerHTML = allCardsHTML;
            // Attach PDF button listeners after DOM is built (avoids onclick escaping issues)
            area.querySelectorAll('[data-pdf-shop]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const shopName = this.getAttribute('data-pdf-shop');
                    exportSingleShopDuePDF(shopName);
                });
            });
            document.getElementById('totalDueAmt').innerText = `â‚¹ ${grandTotalDue.toFixed(2)}`;
        }

        function toggleDueCard(cardId) {
            const body = document.getElementById(cardId);
            const arrow = document.getElementById(cardId + '_arrow');
            if (!body) return;
            const isOpen = body.style.display !== 'none';
            body.style.display = isOpen ? 'none' : 'block';
            if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
        }
        async function saveDueEntry() {
            const shop = document.getElementById('dueShopSel').value;
            const payment = parseFloat(document.getElementById('duePayAmt').value) || 0;
            const note = document.getElementById('dueNote').value.trim();
            if(!shop) return toast("Please select a shop","error");
            if(!payment || payment <= 0) return toast("Please enter a valid payment amount","error");
            const { remaining } = getShopDueStats(shop);
            if(remaining > 0 && payment > remaining) {
                if(!confirm(`âš ï¸ Payment (â‚¹${payment.toFixed(2)}) exceeds the remaining due (â‚¹${remaining.toFixed(2)}). Continue?`)) return;
            }
            try {
                await db.collection("due_entries").add({
                    shopName: shop, credit: 0, payment, note,
                    salesman: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast(`âœ… â‚¹${payment.toFixed(2)} payment saved!`, "success");
                document.getElementById('duePayAmt').value = '';
                document.getElementById('dueNote').value = '';
                refreshDueShopSummaryPanel(shop);
            } catch(e) { toast(e.message, "error"); }
        }

        async function editDueEntry(docId, oldPayment, oldNote) {
            const newAmt = prompt(`Edit payment amount (â‚¹):`, oldPayment);
            if(newAmt === null) return;
            const newNote = prompt(`Edit note:`, oldNote);
            if(newNote === null) return;
            const amt = parseFloat(newAmt);
            if(isNaN(amt) || amt <= 0) return toast("Invalid amount","error");
            try {
                await db.collection("due_entries").doc(docId).update({ payment: amt, note: newNote });
                toast("âœ… Payment entry updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteDueEntry(docId, shopName, paymentAmt) {
            try {
                const snap = await db.collection("due_entries").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("due_entries").doc(docId).delete();
                toast("ðŸ—‘ï¸ Payment entry deleted","success");
                pushUndo(`Payment â‚¹${paymentAmt.toFixed(2)} deleted`, async () => {
                    if(data) await db.collection("due_entries").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function quickRecordPayment(shopName) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shopName);
            const amt = prompt(
                `ðŸ’° ${shopName}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                `ðŸ“¦ Total Bill:    â‚¹${totalBill.toFixed(2)}\n` +
                `âœ… Already Paid:  â‚¹${totalPaid.toFixed(2)}\n` +
                `ðŸ”´ Remaining:     â‚¹${Math.max(0,remaining).toFixed(2)}\n` +
                `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nHow much did they pay?`
            );
            if(!amt || isNaN(parseFloat(amt)) || parseFloat(amt) <= 0) return;
            const note = prompt("Note (optional):") || '';
            db.collection("due_entries").add({
                shopName, credit:0, payment:parseFloat(amt), note,
                salesman: userData.name,
                time: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => toast(`âœ… â‚¹${parseFloat(amt).toFixed(2)} payment recorded!`, "success"))
              .catch(e => toast(e.message, "error"));
        }

        // ===== HELPERS: Build allShops data for PDFs =====
        function buildAllShopsData() {
            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allShops[d.shopName].totalBill += d.total;
                allShops[d.shopName].orders.push(d);
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });
            return allShops;
        }

        // ===== PDF EXPORT: DUE â€” Summary (all shops on one PDF) =====
        function exportDuePDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No due data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Report_' + today.replace(/ /g, '-') + '.pdf';

            // Header bar
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16); doc.setFont('helvetica', 'bold');
            doc.text('ORDER WITH ME', 14, 11);
            doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            doc.text('Due / Credit Report', 14, 18);
            doc.text('Generated: ' + today, pw - 14, 18, { align: 'right' });

            // Table
            let grandDue = 0;
            const tableBody = [];
            sorted.forEach(([shopName, data]) => {
                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if (!isCleared) grandDue += remaining;
                tableBody.push([
                    shopName,
                    'Rs.' + data.totalBill.toFixed(2),
                    'Rs.' + data.totalPaid.toFixed(2),
                    'Rs.' + Math.max(0, remaining).toFixed(2),
                    isCleared ? 'Cleared' : 'Pending'
                ]);
            });

            doc.autoTable({
                startY: 35,
                head: [['Shop Name', 'Total Bill', 'Total Paid', 'Remaining Due', 'Status']],
                body: tableBody,
                foot: [['', '', 'Grand Total Due:', 'Rs.' + grandDue.toFixed(2), '']],
                headStyles: { fillColor: [241, 245, 249], textColor: [30, 41, 59], fontStyle: 'bold', halign: 'left' },
                footStyles: { fillColor: [241, 245, 249], textColor: [225, 29, 72], fontStyle: 'bold' },
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    1: { halign: 'right' },
                    2: { halign: 'right', textColor: [16, 185, 129] },
                    3: { halign: 'right', fontStyle: 'bold' },
                    4: { halign: 'center' }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                    if (data.section === 'body' && data.column.index === 4) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                },
                margin: { left: 14, right: 14 },
                styles: { fontSize: 9, cellPadding: 4 },
                alternateRowStyles: { fillColor: [248, 250, 252] }
            });

            // Footer note
            const finalY = doc.lastAutoTable.finalY + 6;
            doc.setFontSize(8); doc.setTextColor(148, 163, 184); doc.setFont('helvetica', 'normal');
            doc.text('Generated by Order With Me ERP', pw - 14, finalY, { align: 'right' });

            doc.save(fileName);
            toast("âœ… PDF saved!", "success");
        }


        // ===== PDF EXPORT: DUE â€” Separate page per shop =====
        function exportDuePerShopPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Per_Shop_' + today.replace(/ /g, '-') + '.pdf';

            sorted.forEach(([shopName, data], idx) => {
                if (idx > 0) doc.addPage();

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const statusColor = isCleared ? [16, 185, 129] : [225, 29, 72];
                const shopInfo = globalShops[shopName] || {};

                // Header bar
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER WITH ME', 14, 9);
                doc.setFontSize(15); doc.setFont('helvetica', 'bold');
                doc.text(shopName, 14, 20);
                doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                doc.text('Generated: ' + today, pw - 14, 9, { align: 'right' });
                const statusLabel = isCleared ? 'CLEARED' : 'PENDING';
                doc.setTextColor(...statusColor);
                // White bg pill for status
                doc.setFillColor(255,255,255);
                doc.roundedRect(pw - 55, 13, 41, 12, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text(statusLabel, pw - 34.5, 18, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), pw - 34.5, 23, { align: 'center' });

                let y = 35;

                // Shop info
                if (shopInfo.phone || shopInfo.addr) {
                    doc.setTextColor(100, 116, 139); doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                    if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                    if (shopInfo.addr) { doc.text('Addr: ' + shopInfo.addr, 14, y); y += 5; }
                }

                // Summary boxes
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    { label: 'TOTAL BILLED', val: 'Rs.' + data.totalBill.toFixed(2), bg: [240, 244, 255], color: [79, 70, 229] },
                    { label: 'TOTAL PAID', val: 'Rs.' + data.totalPaid.toFixed(2), bg: [240, 255, 248], color: [16, 185, 129] },
                    { label: 'REMAINING DUE', val: 'Rs.' + Math.max(0, remaining).toFixed(2), bg: isCleared ? [240, 255, 248] : [255, 240, 240], color: statusColor }
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(...b.bg);
                    doc.roundedRect(bx, y, boxW, 16, 3, 3, 'F');
                    doc.setTextColor(100, 116, 139); doc.setFontSize(7); doc.setFont('helvetica', 'bold');
                    doc.text(b.label, bx + boxW / 2, y + 5, { align: 'center' });
                    doc.setTextColor(...b.color); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
                    doc.text(b.val, bx + boxW / 2, y + 12, { align: 'center' });
                });
                y += 22;

                // Orders table
                doc.setTextColor(79, 70, 229); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderBody = [];
                if (data.orders && data.orders.length) {
                    [...data.orders].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(o => {
                        const date = o.time ? o.time.toDate().toLocaleDateString('en-GB') : 'â€”';
                        const items = (o.items || []).map(it => it.id + ' x' + it.qty).join(', ');
                        orderBody.push([date, items || 'â€”', 'Rs.' + (o.total||0).toFixed(2), o.salesman || 'â€”']);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Items', 'Amount', 'By']],
                    body: orderBody.length ? orderBody : [['â€”', 'No orders', 'â€”', 'â€”']],
                    foot: [['', 'Total Billed:', 'Rs.' + data.totalBill.toFixed(2), '']],
                    headStyles: { fillColor: [240, 244, 255], textColor: [79, 70, 229], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 244, 255], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold' }, 3: { halign: 'center' } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                });
                y = doc.lastAutoTable.finalY + 6;

                // Payments table
                doc.setTextColor(16, 185, 129); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payBody = [];
                if (data.payments && data.payments.length) {
                    [...data.payments].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(p => {
                        const date = p.time ? p.time.toDate().toLocaleDateString('en-GB') : 'â€”';
                        payBody.push([date, p.note || 'â€”', 'Rs.' + (p.payment||0).toFixed(2)]);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Note', 'Paid']],
                    body: payBody.length ? payBody : [['â€”', 'No payments recorded', 'â€”']],
                    foot: [['', 'Total Paid:', 'Rs.' + data.totalPaid.toFixed(2)]],
                    headStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold', textColor: [16, 185, 129] } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 255, 252] }
                });

                // Page footer
                const ph = doc.internal.pageSize.getHeight();
                doc.setDrawColor(226, 232, 240); doc.setLineWidth(0.3);
                doc.line(14, ph - 10, pw - 14, ph - 10);
                doc.setTextColor(148, 163, 184); doc.setFontSize(7); doc.setFont('helvetica', 'normal');
                doc.text('Order With Me ERP', 14, ph - 6);
                doc.text('Page ' + (idx + 1) + ' of ' + sorted.length, pw - 14, ph - 6, { align: 'right' });
            });

            doc.save(fileName);
            toast("âœ… PDF saved!", "success");
        }


        // ===== PDF EXPORT: SINGLE SHOP DUE STATEMENT (jsPDF direct) =====
        function exportSingleShopDuePDF(shopName) {
            try {
                const { jsPDF } = window.jspdf;
                const allShops = buildAllShopsData();
                const data = allShops[shopName];
                if (!data) return toast("No data for this shop", "error");

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const shopInfo = globalShops[shopName] || {};
                const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});

                const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const pw = doc.internal.pageSize.getWidth();
                let y = 15;

                // â”€â”€ Header bar â”€â”€
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(16); doc.setFont('helvetica','bold');
                doc.text('ORDER WITH ME', 14, 11);
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.text('Shop Due Statement', 14, 18);
                doc.text(`Generated: ${today}`, pw - 14, 18, {align:'right'});
                y = 36;

                // â”€â”€ Shop info â”€â”€
                doc.setTextColor(26,26,46);
                doc.setFontSize(15); doc.setFont('helvetica','bold');
                doc.text(shopName, 14, y); y += 6;
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.setTextColor(100,116,139);
                if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                if (shopInfo.addr)  { doc.text('Address: ' + shopInfo.addr,  14, y); y += 5; }
                y += 2;

                // â”€â”€ Status badge (right side) â”€â”€
                const badgeX = pw - 55, badgeY = 34;
                doc.setFillColor(isCleared ? 220 : 254, isCleared ? 252 : 226, isCleared ? 231 : 226);
                doc.roundedRect(badgeX, badgeY, 48, 20, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica','bold');
                doc.setTextColor(isCleared ? 16 : 220, isCleared ? 185 : 38, isCleared ? 129 : 38);
                doc.text(isCleared ? 'CLEARED' : 'PENDING', badgeX + 24, badgeY + 7, {align:'center'});
                doc.setFontSize(13);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), badgeX + 24, badgeY + 16, {align:'center'});

                // â”€â”€ Summary boxes â”€â”€
                y += 4;
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    {label:'TOTAL BILLED', val:'Rs.'+data.totalBill.toFixed(2), r:66,g:99,b:235},
                    {label:'TOTAL PAID',   val:'Rs.'+data.totalPaid.toFixed(2),  r:16,g:185,b:129},
                    {label:'REMAINING',    val:'Rs.'+Math.max(0,remaining).toFixed(2), r:isCleared?16:244, g:isCleared?185:63, b:isCleared?129:94},
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(245, 247, 255);
                    doc.roundedRect(bx, y, boxW, 18, 2, 2, 'F');
                    doc.setFontSize(7); doc.setFont('helvetica','bold');
                    doc.setTextColor(100,116,139);
                    doc.text(b.label, bx + boxW/2, y + 6, {align:'center'});
                    doc.setFontSize(12); doc.setFont('helvetica','bold');
                    doc.setTextColor(b.r, b.g, b.b);
                    doc.text(b.val, bx + boxW/2, y + 14, {align:'center'});
                });
                y += 24;

                // â”€â”€ Orders table â”€â”€
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(79, 70, 229);
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderRows = (data.orders||[])
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(o => [
                        o.time ? o.time.toDate().toLocaleDateString('en-GB') : 'â€”',
                        (o.items||[]).map(it => it.id + ' x' + it.qty).join(', ') || 'â€”',
                        'Rs.' + (o.total||0).toFixed(2),
                        o.salesman || 'â€”'
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Items','Amount','Salesman']],
                    body: orderRows.length ? orderRows : [['No orders found','','','']],
                    foot: [['','Total Bill:', 'Rs.'+data.totalBill.toFixed(2),'']],
                    theme: 'grid',
                    headStyles: {fillColor:[79,70,229], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[224,231,255], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}, 0:{cellWidth:25}, 3:{cellWidth:25}},
                    alternateRowStyles: {fillColor:[248,250,255]},
                    margin: {left:14, right:14},
                });
                y = doc.lastAutoTable.finalY + 8;

                // â”€â”€ Payments table â”€â”€
                if (y > 250) { doc.addPage(); y = 15; }
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(16, 185, 129);
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payRows = [...(data.payments||[])]
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(p => [
                        p.time ? p.time.toDate().toLocaleDateString('en-GB') : 'â€”',
                        p.note || 'â€”',
                        'Rs.' + (p.payment||0).toFixed(2)
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Note','Amount Paid']],
                    body: payRows.length ? payRows : [['No payments recorded','','']],
                    foot: [['','Total Paid:', 'Rs.'+data.totalPaid.toFixed(2)]],
                    theme: 'grid',
                    headStyles: {fillColor:[16,185,129], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[209,250,229], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}},
                    alternateRowStyles: {fillColor:[240,255,248]},
                    margin: {left:14, right:14},
                });

                const safeFilename = shopName.replace(/[^a-zA-Z0-9]/g,'_');
                doc.save(`Due_Statement_${safeFilename}_${today.replace(/ /g,'_')}.pdf`);
                toast("âœ… PDF saved!", "success");

            } catch(e) {
                console.error("PDF error:", e);
                toast("PDF error: " + e.message, "error");
            }
        }

        // ===== RETURNS =====        // ===== RETURNS =====
        function loadReturnItems() {
            const idx=document.getElementById('returnOrderSel').value;
            const area=document.getElementById('returnItemsArea');
            const list=document.getElementById('returnItemsList');
            if(!idx){area.style.display='none';return;}
            const d=historyData[parseInt(idx)]; if(!d) return;
            list.innerHTML='';
            d.items.forEach((item,i)=>{
                list.innerHTML+=`<div class="return-item-row">
                    <input type="checkbox" id="ret_chk_${i}" value="${i}" style="width:18px;height:18px;cursor:pointer;accent-color:var(--primary);">
                    <label for="ret_chk_${i}" style="flex:1;cursor:pointer;"><b>${item.id}</b> <span style="color:#64748b;">Ã— ${item.qty} @ â‚¹${item.price.toFixed(2)}</span></label>
                    <input type="number" id="ret_qty_${i}" class="input-field" placeholder="Qty" min="1" max="${item.qty}" value="${item.qty}" style="width:70px;margin-bottom:0;padding:8px 10px;">
                </div>`;
            });
            area.style.display='block';
        }
        async function processReturn() {
            const idx=document.getElementById('returnOrderSel').value;
            if(!idx) return toast("Select an order","error");
            const d=historyData[parseInt(idx)];
            const reason=document.getElementById('returnReason').value.trim();
            let returnItems=[], refundAmt=0;
            d.items.forEach((item,i)=>{
                const chk=document.getElementById(`ret_chk_${i}`);
                if(chk&&chk.checked){
                    const qty=parseInt(document.getElementById(`ret_qty_${i}`).value)||0;
                    if(qty>0&&qty<=item.qty){returnItems.push({...item,qty});refundAmt+=qty*item.price;}
                }
            });
            if(!returnItems.length) return toast("Select at least one item","error");
            if(!confirm(`Process return for ${returnItems.length} item(s)? Refund: â‚¹${refundAmt.toFixed(2)}. Stock will be restored.`)) return;
            try{
                for(let item of returnItems){
                    const ref=db.collection("products").doc(item.id);
                    await db.runTransaction(async t=>{const pDoc=await t.get(ref);if(pDoc.exists) t.update(ref,{stock:pDoc.data().stock+item.qty});});
                }
                // Save return doc first, then link the due_entry back to it
                const returnRef = await db.collection("returns").add({orderId:d.orderId,shopName:d.shopName,items:returnItems,refundAmt,reason,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                if(refundAmt>0){
                    const dueRef = await db.collection("due_entries").add({shopName:d.shopName,credit:0,payment:refundAmt,note:`Auto: Return refund (${reason||'return'})`,salesman:userData.name,isReturnEntry:true,returnDocId:returnRef.id,time:firebase.firestore.FieldValue.serverTimestamp()});
                    // Link the due entry ID back into the return document
                    await returnRef.update({dueEntryId: dueRef.id});
                }
                toast(`Return processed! Refund: â‚¹${refundAmt.toFixed(2)}`,"success");
                document.getElementById('returnOrderSel').value='';
                document.getElementById('returnItemsArea').style.display='none';
                document.getElementById('returnReason').value='';
            }catch(e){toast(e.message,"error");}
        }
        function populateReturnOrderSel() {
            const sel=document.getElementById('returnOrderSel');
            if(!sel) return;
            sel.innerHTML='<option value="">-- Select Order --</option>';
            historyData.forEach((d,i)=>{
                const ts=d.time?d.time.toDate().toLocaleDateString():'';
                sel.innerHTML+=`<option value="${i}">${d.shopName} â€” ${ts} (â‚¹${d.total.toFixed(0)})</option>`;
            });
        }

        async function editReturn(docId) {
            const ret = allReturnsData.find(r => r.docId === docId);
            if(!ret) return toast("Record not found","error");
            const newReason = prompt(`Edit return reason:`, ret.reason || '');
            if(newReason === null) return;
            try {
                await db.collection("returns").doc(docId).update({ reason: newReason });
                toast("âœ… Return reason updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteReturn(docId, refundAmt) {
            if(!confirm(`Delete this return? The â‚¹${refundAmt.toFixed(2)} refund payment will also be reversed from the due/payment ledger.`)) return;
            try {
                const snap = await db.collection("returns").doc(docId).get();
                if(!snap.exists) return toast("Return not found","error");
                const data = snap.data();

                // 1. Delete the linked due_entry (auto refund payment)
                let savedDueData = null;
                let savedDueId = data.dueEntryId || null;
                if(savedDueId) {
                    const dueSnap = await db.collection("due_entries").doc(savedDueId).get();
                    if(dueSnap.exists) {
                        savedDueData = dueSnap.data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                } else {
                    // Fallback: search by returnDocId field for older records
                    const q = await db.collection("due_entries")
                        .where("returnDocId","==",docId)
                        .limit(1).get();
                    if(!q.empty) {
                        savedDueId = q.docs[0].id;
                        savedDueData = q.docs[0].data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                }

                // 2. Reverse stock (deduct back what was restored on return)
                if(data.items && data.items.length) {
                    for(let item of data.items) {
                        const ref = db.collection("products").doc(item.id);
                        await db.runTransaction(async t => {
                            const pDoc = await t.get(ref);
                            if(pDoc.exists) {
                                const newStock = Math.max(0, pDoc.data().stock - item.qty);
                                t.update(ref, {stock: newStock});
                            }
                        });
                    }
                }

                // 3. Delete the return document itself
                await db.collection("returns").doc(docId).delete();
                toast("ðŸ—‘ï¸ Return deleted & payment reversed","success");

                // 4. Undo support
                pushUndo(`Return â‚¹${refundAmt.toFixed(2)} deleted`, async () => {
                    // Restore return doc
                    await db.collection("returns").doc(docId).set(data);
                    // Restore due entry
                    if(savedDueId && savedDueData) {
                        await db.collection("due_entries").doc(savedDueId).set(savedDueData);
                        await db.collection("returns").doc(docId).update({dueEntryId: savedDueId});
                    }
                    // Re-restore stock
                    if(data.items && data.items.length) {
                        for(let item of data.items) {
                            const ref = db.collection("products").doc(item.id);
                            await db.runTransaction(async t => {
                                const pDoc = await t.get(ref);
                                if(pDoc.exists) t.update(ref, {stock: pDoc.data().stock + item.qty});
                            });
                        }
                    }
                });
            } catch(e) { toast(e.message,"error"); }
        }

        // ===== PDF EXPORT: RETURNS =====
        function exportReturnsPDF() {
            if (!allReturnsData.length) return toast('No returns to export', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');
            toast('Generating PDF...');
            const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            const totalRefund = allReturnsData.reduce((s,r)=>s+(r.refundAmt||0), 0);

            doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(30,41,59);
            doc.text('Returns History Report', 14, 14);
            doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(100,116,139);
            doc.text('Generated: ' + today + '  |  Total Refund: Rs.' + totalRefund.toFixed(2), pageW-14, 14, {align:'right'});

            doc.autoTable({
                head: [['Date','Shop','Items','Salesman','Reason','Refund (Rs.)']],
                body: allReturnsData.map(r => [
                    r.time ? r.time.toDate().toLocaleDateString('en-GB') : 'N/A',
                    r.shopName, r.items.map(i=>`${i.id}(${i.qty})`).join(', '),
                    r.salesman, r.reason||'â€”', (r.refundAmt||0).toFixed(2)
                ]),
                startY:20, margin:{left:10,right:10},
                styles:{font:'helvetica',fontSize:9,cellPadding:4,overflow:'linebreak',lineColor:[203,213,225],lineWidth:0.3,textColor:[26,26,46],valign:'middle',minCellHeight:8},
                headStyles:{fillColor:[241,245,249],textColor:[26,26,46],fontStyle:'bold',fontSize:8.5,lineColor:[26,26,46],lineWidth:0.5},
                alternateRowStyles:{fillColor:[248,250,252]},
                columnStyles:{2:{cellWidth:'auto'},5:{halign:'right'}},
                foot:[['','','','','Total Refund:', totalRefund.toFixed(2)]],
                footStyles:{fillColor:[241,245,249],fontStyle:'bold',textColor:[26,26,46]},
                showHead:'everyPage',
                didDrawPage:(data)=>{ doc.setFontSize(8); doc.setTextColor(148,163,184); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'}); }
            });
            doc.save('Returns_Report_' + today.replace(/ /g,'_') + '.pdf');
            toast('âœ… PDF saved!', 'success');
        }

        // ===== SALESMAN PERFORMANCE =====
        function setPerfPeriod(period, btn) {
            document.querySelectorAll('#view-salesman-perf .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            perfPeriod=period;
            renderSalesmanPerf();
        }
        function renderSalesmanPerf() {
            const now=new Date(); let startMs=0;
            if(perfPeriod==='month'){startMs=new Date(now.getFullYear(),now.getMonth(),1).getTime();}
            else if(perfPeriod==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            else if(perfPeriod==='today'){startMs=new Date().setHours(0,0,0,0);}
            const perfMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(startMs&&oMs<startMs) return;
                if(!perfMap[d.salesman]) perfMap[d.salesman]={total:0,orders:0,shops:new Set(),items:0};
                perfMap[d.salesman].total+=d.total; perfMap[d.salesman].orders++;
                perfMap[d.salesman].shops.add(d.shopName);
                d.items.forEach(i=>perfMap[d.salesman].items+=i.qty);
            });
            const sorted=Object.entries(perfMap).sort((a,b)=>b[1].total-a[1].total);
            const maxTotal=sorted.length?sorted[0][1].total:1;
            const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const summaryEl=document.getElementById('perfSummaryCards');
            summaryEl.innerHTML='';
            if(sorted.length){summaryEl.innerHTML=`<div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">ðŸ†</span><div class="dc-lbl">Top Salesman</div><div class="dc-val" style="font-size:15px;">${sorted[0][0]}</div></div><div class="dash-card dc-total" style="cursor:default;"><span class="dc-icon">ðŸ’°</span><div class="dc-lbl">Best Revenue</div><div class="dc-val">â‚¹${(sorted[0][1].total/1000).toFixed(1)}k</div></div>`;}
            const lb=document.getElementById('perfLeaderboard');
            lb.innerHTML='';
            if(!sorted.length){lb.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No data for this period.</div>';return;}
            sorted.forEach(([name,stats],idx)=>{
                const pct=((stats.total/maxTotal)*100).toFixed(0);
                lb.innerHTML+=`<div class="perf-card"><div class="flex-between"><div style="display:flex;align-items:center;gap:8px;"><span class="perf-rank">${medals[idx]||'#'+(idx+1)}</span><div><div style="font-weight:700;font-size:15px;">${name}</div><div style="font-size:11px;color:#64748b;">${stats.orders} orders Â· ${stats.shops.size} shops Â· ${stats.items} items sold</div></div></div><div style="text-align:right;"><div style="font-weight:800;font-size:18px;color:var(--primary);">â‚¹${stats.total.toFixed(0)}</div><div style="font-size:11px;color:#64748b;">Avg â‚¹${(stats.total/stats.orders).toFixed(0)}/order</div></div></div><div class="perf-bar-wrap"><div class="perf-bar" style="width:${pct}%;"></div></div></div>`;
            });
            const cw=document.getElementById('perfChartWrapper');
            cw.style.display=sorted.length>1?'block':'none';
            if(sorted.length>1){
                const ctx=document.getElementById('perfChart').getContext('2d');
                if(perfChartInstance) perfChartInstance.destroy();
                perfChartInstance=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0]),datasets:[{label:'Sales (â‚¹)',data:sorted.map(s=>s[1].total),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee'],borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            }
        }

        // ===== P&L =====
        function setPnlPeriod(period, btn) {
            document.querySelectorAll('#view-pnl .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            pnlPeriod=period;
            const now=new Date(); let start, end;
            if(period==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);end=now;}
            else if(period==='lastmonth'){start=new Date(now.getFullYear(),now.getMonth()-1,1);end=new Date(now.getFullYear(),now.getMonth(),0);}
            else if(period==='week'){start=new Date(now);start.setDate(now.getDate()-now.getDay());start.setHours(0,0,0,0);end=now;}
            else{start=null;end=null;}
            document.getElementById('pnlStart').value=start?start.toISOString().split('T')[0]:'';
            document.getElementById('pnlEnd').value=end?end.toISOString().split('T')[0]:'';
        }
        function generatePnl() {
            const sVal=document.getElementById('pnlStart').value, eVal=document.getElementById('pnlEnd').value;
            const startMs=sVal?new Date(sVal).setHours(0,0,0,0):0, endMs=eVal?new Date(eVal).setHours(23,59,59,999):Infinity;
            let revenue=0,cost=0,totalQty=0; const itemProfitMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(oMs<startMs||oMs>endMs) return;
                revenue+=d.total;
                d.items.forEach(item=>{
                    totalQty+=item.qty;
                    const purchasePrice=productsMap[item.id]?.costPrice||productsMap[item.id]?.price||0;
                    const itemCost=purchasePrice*item.qty;
                    cost+=itemCost;
                    if(!itemProfitMap[item.id]) itemProfitMap[item.id]={profit:0,qty:0,revenue:0};
                    itemProfitMap[item.id].profit+=item.total-itemCost;
                    itemProfitMap[item.id].qty+=item.qty;
                    itemProfitMap[item.id].revenue+=item.total;
                });
            });
            let returnsDeduction=0;
            allReturnsData.forEach(r=>{const oMs=r.time?r.time.toDate().getTime():0;if(oMs>=startMs&&oMs<=endMs) returnsDeduction+=r.refundAmt||0;});
            const netProfit=revenue-cost-returnsDeduction;
            const margin=revenue>0?((netProfit/revenue)*100).toFixed(1):0;
            const profitColor=netProfit>=0?'var(--success)':'var(--danger)';
            const pp=netProfit>=0?'+':'';
            document.getElementById('pnlRevenue').innerText=`â‚¹ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCost').innerText=`â‚¹ ${cost.toFixed(2)}`;
            document.getElementById('pnlNet').innerText=`${pp}â‚¹ ${netProfit.toFixed(2)}`; document.getElementById('pnlNet').style.color=profitColor;
            document.getElementById('pnlQty').innerText=totalQty;
            document.getElementById('pnlRevDetail').innerText=`â‚¹ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCostDetail').innerText=`â‚¹ ${cost.toFixed(2)}`;
            document.getElementById('pnlReturnsDetail').innerText=`- â‚¹ ${returnsDeduction.toFixed(2)}`;
            document.getElementById('pnlMargin').innerText=`${margin}%`; document.getElementById('pnlMargin').style.color=parseFloat(margin)>=0?'var(--success)':'var(--danger)';
            document.getElementById('pnlNetDetail').innerText=`${pp}â‚¹ ${netProfit.toFixed(2)}`; document.getElementById('pnlNetDetail').style.color=profitColor;
            const topItems=Object.entries(itemProfitMap).sort((a,b)=>b[1].profit-a[1].profit).slice(0,8);
            const topEl=document.getElementById('pnlTopItems'); topEl.innerHTML='';
            topItems.forEach(([name,stats])=>{
                const pc=stats.profit>=0?'var(--success)':'var(--danger)';
                topEl.innerHTML+=`<div class="pnl-row"><div><b>${name}</b><div style="font-size:11px;color:#94a3b8;">Qty: ${stats.qty} | Rev: â‚¹${stats.revenue.toFixed(0)}</div></div><span style="font-weight:700;color:${pc};">${stats.profit>=0?'+':''}â‚¹${stats.profit.toFixed(2)}</span></div>`;
            });
            if(!topItems.length) topEl.innerHTML='<div style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">No data</div>';
            toast("P&L generated!","success");
        }

        // ===== VISITS =====
        let visitPeriodFilter2='all';
        function setVisitFilter(period, btn) {
            document.querySelectorAll('#view-visits .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            visitPeriodFilter2=period;
            renderVisits();
        }
        async function logVisit() {
            const shop=document.getElementById('visitShopSel').value;
            const note=document.getElementById('visitNote').value.trim();
            if(!shop) return toast("Select a shop","error");
            try{
                await db.collection("visits").add({shopName:shop,note,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                toast("Visit logged!","success"); document.getElementById('visitNote').value='';
            }catch(e){toast(e.message,"error");}
        }

        async function deleteVisit(docId) {
            try {
                const snap = await db.collection("visits").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("visits").doc(docId).delete();
                toast("ðŸ—‘ï¸ Visit deleted","success");
                pushUndo("Visit record deleted", async () => {
                    if(data) await db.collection("visits").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function renderVisits() {
            const area=document.getElementById('visitListArea');
            const salesmanF=document.getElementById('visitSalesmanFilter')?.value||'all';
            const now=new Date(); let startMs=0;
            if(visitPeriodFilter2==='today') startMs=new Date().setHours(0,0,0,0);
            else if(visitPeriodFilter2==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            const vss=document.getElementById('visitShopSel');
            if(vss){vss.innerHTML='<option value="">-- Select Shop Visited --</option>';Object.keys(globalShops).forEach(k=>vss.innerHTML+=`<option value="${k}">${globalShops[k].name||k}</option>`);}
            let filtered=allVisitsData.filter(v=>{
                const vMs=v.time?v.time.toDate().getTime():0;
                if(startMs&&vMs<startMs) return false;
                if(salesmanF!=='all'&&v.salesman!==salesmanF) return false;
                if(userData.role!=='manager'&&v.salesman!==userData.name) return false;
                return true;
            });
            visitExportArray=filtered.map(v=>({Date:v.time?v.time.toDate().toLocaleString():'',Shop:v.shopName,Salesman:v.salesman,Note:v.note||''}));
            document.getElementById('visitCount').innerText=`(${filtered.length})`;
            area.innerHTML='';
            if(!filtered.length){area.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No visits found.</div>';return;}
            filtered.forEach(v=>{
                const ts=v.time?v.time.toDate().toLocaleString():'';
                const safeDocId = v.docId ? v.docId.replace(/'/g,"\\'") : '';
                const canDelete = (userData.role==='manager' || v.salesman===userData.name);
                area.innerHTML+=`<div class="visit-card">
                    <div class="flex-between">
                        <div class="vc-shop">ðŸª ${v.shopName}</div>
                        ${canDelete && safeDocId ? `<button class="action-btn action-btn-delete" onclick="deleteVisit('${safeDocId}')">ðŸ—‘ï¸</button>` : ''}
                    </div>
                    <div class="vc-meta">ðŸ‘¤ ${v.salesman} &nbsp;|&nbsp; ðŸ• ${ts}</div>
                    ${v.note?`<div style="margin-top:6px;font-size:13px;color:var(--text);">${v.note}</div>`:''}
                </div>`;
            });
        }

        // ===== PDF EXPORT: VISITS =====
        function exportVisitsPDF() {
            if (!visitExportArray.length) return toast('No visits to export', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');

            toast('Generating PDF...');
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(30, 41, 59);
            doc.text('Shop Visit Log', 14, 14);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            doc.text('Generated: ' + today + '  |  Total: ' + visitExportArray.length + ' visits', pageW - 14, 14, { align:'right' });

            doc.autoTable({
                head: [['Date & Time', 'Shop', 'Salesman', 'Notes']],
                body: visitExportArray.map(v => [v.Date || '', v.Shop || '', v.Salesman || '', v.Note || 'â€”']),
                startY: 20,
                margin: { left: 10, right: 10 },
                styles: { font:'helvetica', fontSize:9, cellPadding:4, overflow:'linebreak', lineColor:[203,213,225], lineWidth:0.3, textColor:[26,26,46], valign:'middle', minCellHeight:8 },
                headStyles: { fillColor:[241,245,249], textColor:[26,26,46], fontStyle:'bold', fontSize:8.5, lineColor:[26,26,46], lineWidth:0.5 },
                alternateRowStyles: { fillColor:[248,250,252] },
                columnStyles: { 0:{cellWidth:38}, 1:{cellWidth:50}, 2:{cellWidth:38}, 3:{cellWidth:'auto'} },
                didDrawPage: (data) => {
                    doc.setFontSize(8); doc.setTextColor(148,163,184);
                    doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'});
                },
                showHead: 'everyPage'
            });
            doc.save('Shop_Visits_' + today.replace(/ /g,'_') + '.pdf');
            toast('âœ… PDF saved!', 'success');
        }

        // ===== SHOP NOTES / REMARKS =====
        let allShopNotes = [];
        const NOTE_TAG_LABELS = {
            general: 'ðŸ“Œ General', payment: 'ðŸ’° Payment',
            closed: 'ðŸš« Closed Info', complaint: 'âš ï¸ Complaint', preference: 'â­ Preference'
        };

        async function saveShopNote() {
            const shop = document.getElementById('noteShopSel').value;
            const text = document.getElementById('noteText').value.trim();
            const tag  = document.getElementById('noteTag').value;
            if (!shop) return toast('Please select a shop', 'error');
            if (!text) return toast('Please write a note', 'error');
            try {
                await db.collection('shop_notes').add({
                    shopName: shop, text, tag,
                    author: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast('âœ… Note saved!', 'success');
                document.getElementById('noteText').value = '';
            } catch(e) { toast(e.message, 'error'); }
        }

        async function deleteShopNote(docId) {
            try {
                const snap = await db.collection('shop_notes').doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection('shop_notes').doc(docId).delete();
                toast('ðŸ—‘ï¸ Note deleted', 'success');
                pushUndo('Shop note deleted', async () => {
                    if(data) await db.collection('shop_notes').doc(docId).set(data);
                });
            } catch(e) { toast(e.message, 'error'); }
        }

        function renderShopNotes() {
            const area = document.getElementById('shopNotesArea');
            if (!area) return;
            const shopF = (document.getElementById('noteFilterShop')?.value) || 'all';
            const tagF  = (document.getElementById('noteFilterTag')?.value) || 'all';

            let filtered = allShopNotes.filter(n => {
                if (shopF !== 'all' && n.shopName !== shopF) return false;
                if (tagF  !== 'all' && n.tag !== tagF) return false;
                return true;
            });

            if (!filtered.length) {
                area.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">No notes found.</div>';
                return;
            }

            // Group by shop
            const byShop = {};
            filtered.forEach(n => {
                if (!byShop[n.shopName]) byShop[n.shopName] = [];
                byShop[n.shopName].push(n);
            });

            area.innerHTML = Object.entries(byShop).map(([shopName, notes]) => `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; font-weight:800; color:var(--primary); margin-bottom:6px;
                                text-transform:uppercase; letter-spacing:0.5px;">
                        ðŸª ${shopName}
                        <span class="shop-note-badge">${notes.length} note${notes.length>1?'s':''}</span>
                    </div>
                    ${notes.map(n => {
                        const ts = n.time ? n.time.toDate().toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : 'â€”';
                        const canDel = userData.role === 'manager' || n.author === userData.name;
                        return `<div class="shop-note-card">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                                <div style="flex:1;">
                                    <span style="font-size:10px; font-weight:700; background:rgba(245,158,11,0.2);
                                           color:#b45309; border-radius:20px; padding:1px 8px;">
                                        ${NOTE_TAG_LABELS[n.tag] || n.tag}
                                    </span>
                                    <div class="note-text" style="margin-top:6px;">${n.text}</div>
                                    <div class="note-meta">ðŸ‘¤ ${n.author} Â· ðŸ• ${ts}</div>
                                </div>
                                ${canDel ? `<button onclick="deleteShopNote('${n.docId}')"
                                    style="background:none; border:none; cursor:pointer; font-size:14px;
                                           color:#94a3b8; padding:2px 4px; flex-shrink:0;"
                                    title="Delete">ðŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>`).join('');
        }

        function populateNoteShopSelects() {
            const sel = document.getElementById('noteShopSel');
            const filterSel = document.getElementById('noteFilterShop');
            if (!sel) return;
            const shops = Object.keys(globalShops).sort();
            sel.innerHTML = '<option value="">-- Select Shop --</option>' +
                shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            if (filterSel) {
                filterSel.innerHTML = '<option value="all">All Shops</option>' +
                    shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            }
        }

        // ===== ORDER PANEL â€” DUE ALERT =====
        function showOrderDueAlert(shopName) {
            const el = document.getElementById('orderDueAlert');
            if (!el) return;
            if (!shopName) { el.style.display = 'none'; el.innerHTML = ''; return; }

            const { totalBill, totalPaid } = getShopDueStats(shopName);
            const remaining = totalBill - totalPaid;

            if (remaining <= 0) {
                // Cleared â€” show green tick briefly
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px 14px;
                                background:rgba(16,185,129,0.1); border:1.5px solid rgba(16,185,129,0.3);
                                border-radius:12px; font-size:13px;">
                        <span style="font-size:18px;">âœ…</span>
                        <div>
                            <div style="font-weight:700; color:#065f46;">No Pending Due</div>
                            <div style="font-size:11px; color:#047857;">This shop has cleared all payments</div>
                        </div>
                    </div>`;
            } else {
                const pct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 0;
                const isHigh = remaining > 5000;
                const borderCol = isHigh ? 'rgba(244,63,94,0.5)' : 'rgba(245,158,11,0.5)';
                const bgCol    = isHigh ? 'rgba(244,63,94,0.08)' : 'rgba(245,158,11,0.08)';
                const textCol  = isHigh ? '#be123c' : '#92400e';
                const icon     = isHigh ? 'ðŸ”´' : 'ðŸŸ¡';
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="padding:12px 14px; background:${bgCol}; border:1.5px solid ${borderCol};
                                border-radius:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-size:18px;">${icon}</span>
                                <div>
                                    <div style="font-weight:800; font-size:13px; color:${textCol};">Pending Due Alert</div>
                                    <div style="font-size:10px; color:#64748b;">Collect payment before placing order</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px; font-weight:900; color:${textCol};">â‚¹${remaining.toFixed(2)}</div>
                                <div style="font-size:10px; color:#64748b;">remaining</div>
                            </div>
                        </div>
                        <div style="background:rgba(0,0,0,0.06); border-radius:99px; height:6px; overflow:hidden; margin-bottom:6px;">
                            <div style="width:${pct.toFixed(0)}%; height:100%; border-radius:99px;
                                        background:${isHigh ? '#f43f5e' : '#f59e0b'}; transition:width 0.5s;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:#64748b;">
                            <span>Total Billed: â‚¹${totalBill.toFixed(2)}</span>
                            <span>Paid: â‚¹${totalPaid.toFixed(2)} (${pct.toFixed(0)}%)</span>
                        </div>
                    </div>`;
            }
        }

        // ===== SWITCH VIEW =====
        function updateBottomNav(view) {
            const map = { dashboard:'dashboard', order:'order', history:'history', stock:'stock' };
            document.querySelectorAll('.bn-item').forEach(b => b.classList.remove('bn-active'));
            const key = Object.keys(map).find(k => k === view);
            if (key) { const el = document.getElementById('bn-' + key); if(el) el.classList.add('bn-active'); }
        }

        function switchView(v) {
            document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
            const viewEl = document.getElementById('view-'+v);
            if(viewEl) viewEl.classList.add('active');
            document.getElementById('pageTitle').innerText=v==='admin'?'MANAGER PANEL':v.toUpperCase().replace(/-/g,' ');
            updateBottomNav(v);
            trackUsage(v);
            renderSidebar();
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow='';
            if(v==='order') {
                const al=document.getElementById('orderDueAlert');
                if(al){al.style.display='none';al.innerHTML='';}
                // If shop already selected (e.g. redirected from edit), show alert
                const os = document.getElementById('orderShop');
                if(os && os.value) showOrderDueAlert(os.value);
            }
            if(v==='salesman-perf') renderSalesmanPerf();
            if(v==='visits') renderVisits();
            if(v==='due') renderDueList();
            if(v==='returns') populateReturnOrderSel();
            if(v==='dashboard') renderQuickAccess();
            if(v==='shop-notes') { populateNoteShopSelects(); renderShopNotes(); }
            if(v==='attendance') { initAttendanceView(); }
            if(v==='reports') pwPopulateFilters();
            if(v==='quotation') {
                // Auto-fill salesman from logged-in user
                document.getElementById('qt-salesman').value = document.getElementById('qt-salesman').value || (userData ? userData.name : '');

                // Auto-fill company name from brand settings
                const qtCompanyEl = document.getElementById('qt-companyName');
                if (qtCompanyEl && !qtCompanyEl.value) {
                    qtCompanyEl.value = (typeof brandSettings !== 'undefined' && brandSettings.name) ? brandSettings.name : 'Order With Me';
                }

                // Populate shop/client datalist from globalShops
                const shopDl = document.getElementById('qt-shopList');
                if (shopDl) {
                    shopDl.innerHTML = Object.values(globalShops).map(s => `<option value="${s.name || s.id}">`).join('');
                }

                // Populate salesman datalist from users/salesmen in shops
                const smDl = document.getElementById('qt-salesmanList');
                if (smDl) {
                    const smSet = new Set();
                    if (userData && userData.name) smSet.add(userData.name);
                    historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
                    Object.values(globalShops).forEach(s => { if(s.createdBy) smSet.add(s.createdBy); });
                    smDl.innerHTML = [...smSet].map(n => `<option value="${n}">`).join('');
                }

                // Refresh product datalists in existing item rows
                document.querySelectorAll('#qtItemsList .qt-item-row').forEach(row => {
                    const dl = row.querySelector('datalist');
                    if (dl) {
                        dl.innerHTML = Object.keys(productsMap).map(p => `<option value="${p}">`).join('');
                    }
                });

                if (!document.getElementById('qt-quotNo').value) {
                    document.getElementById('qt-quotNo').value = 'QT-' + Date.now().toString().slice(-6);
                }
                const today = new Date(); today.setDate(today.getDate()+30);
                if (!document.getElementById('qt-validDate').value) {
                    document.getElementById('qt-validDate').value = today.toISOString().split('T')[0];
                }
                if (document.querySelectorAll('#qtItemsList .qt-item-row').length === 0) addQtItem();
                else renderQuotation();
            }
            if(v==='admin') {
                document.getElementById('pageTitle').innerText = 'MANAGER PANEL';
                initIncentiveSettingsUI();
                populateIncSalesmanFilter();
                populateShopCreatedBySelect();
                restoreAdminCardStates();
                restoreAdminOrder();
            }
        }

        function pwPopulateFilters() {
            const shopSel = document.getElementById('pwShopFilter');
            if (!shopSel) return;
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id, d]) => {
                shopSel.innerHTML += `<option value="${id}">${d.name || id}</option>`;
            });
            shopSel.value = curShop;
            const smSel = document.getElementById('pwSalesmanFilter');
            if (!smSel) return;
            const curSm = smSel.value;
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => smSel.innerHTML += `<option value="${s}">${s}</option>`);
            smSel.value = curSm;

            // Populate salesman filters for other new reports
            ['swSalesmanFilter','slTableBody','trSalesmanFilter'].forEach(id => {
                const el = document.getElementById(id);
                if (!el || el.tagName !== 'SELECT') return;
                const cur = el.value;
                el.innerHTML = '<option value="all">All Salesmen</option>';
                smSet.forEach(s => el.innerHTML += `<option value="${s}">${s}</option>`);
                el.value = cur;
            });
            // Trend report shop filter
            const trShopSel = document.getElementById('trShopFilter');
            if (trShopSel) {
                const cur = trShopSel.value;
                trShopSel.innerHTML = '<option value="all">All Shops</option>';
                Object.entries(globalShops).forEach(([id,d]) => trShopSel.innerHTML+=`<option value="${id}">${d.name||id}</option>`);
                trShopSel.value = cur;
            }
        }

        function renderOfflineQueueList() {
            const q = getOfflineQueue();
            const el = document.getElementById('offlineQueueList');
            const badge = document.getElementById('offlineBadgeMgr');
            if (!el) return;
            if (badge) badge.textContent = q.length > 0 ? q.length : '';
            if (!q.length) {
                el.innerHTML = '<div style="color:#10b981; font-size:13px; font-weight:600;">âœ… No pending orders.</div>';
                return;
            }
            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            q.forEach((item, i) => {
                const t = new Date(item.localTime).toLocaleString('en-GB');
                html += `<div style="background:var(--bg); border-radius:12px; padding:12px; border:1px solid var(--border);">
                    <div style="font-weight:700; font-size:13px;">ðŸª ${item.shopName}</div>
                    <div style="font-size:11px; color:#64748b; margin-top:2px;">ðŸ“… ${t} &nbsp;Â·&nbsp; ${item.items.length} items &nbsp;Â·&nbsp; <b>â‚¹${item.total.toFixed(2)}</b></div>
                </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        }

        // ===== HELPER: date preset for new reports =====
        function _applyDatePresetTo(preset, startId, endId, gridEl) {
            if (gridEl) gridEl.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            const today = new Date();
            let start = null, end = null;
            if (preset==='today')     { start = end = new Date(today); }
            else if (preset==='week') { start = new Date(today); start.setDate(today.getDate()-today.getDay()); end = new Date(today); }
            else if (preset==='month'){ start = new Date(today.getFullYear(),today.getMonth(),1); end = new Date(today); }
            else if (preset==='lastmonth'){ start = new Date(today.getFullYear(),today.getMonth()-1,1); end = new Date(today.getFullYear(),today.getMonth(),0); }
            else if (preset==='all')  { document.getElementById(startId).value=''; document.getElementById(endId).value=''; return; }
            if (start) document.getElementById(startId).value = start.toISOString().split('T')[0];
            if (end)   document.getElementById(endId).value   = end.toISOString().split('T')[0];
        }
        function _filterHistory(startId, endId) {
            const sVal=document.getElementById(startId).value, eVal=document.getElementById(endId).value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            return historyData.filter(d => {
                const ms = d.time ? d.time.toDate().getTime() : 0;
                return ms >= startMs && ms <= endMs;
            });
        }
        function _destroyChart(instance) { if (instance) { try { instance.destroy(); } catch(e){} } return null; }

        // ===== SHOP-WISE REPORT =====
        let swDataArray = [], swBarChartInst = null;
        function swApplyPreset(p,btn){ _applyDatePresetTo(p,'swStartDate','swEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function swClearPresets(){ document.getElementById('swStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetShopWiseReport(){ document.getElementById('swStartDate').value=''; document.getElementById('swEndDate').value=''; document.getElementById('swResultArea').style.display='none'; }

        function generateShopWiseReport() {
            const salesmanF = document.getElementById('swSalesmanFilter').value;
            const areaF = document.getElementById('swAreaFilter').value;

            // Populate salesman select
            const smSel = document.getElementById('swSalesmanFilter');
            const cur = smSel.value;
            const smSet = new Set(); historyData.forEach(d=>smSet.add(d.salesman));
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s=>{ if(s) smSel.innerHTML+=`<option value="${s}">${s}</option>`; });
            smSel.value = cur;

            // Filter history by date + salesman
            let rows = _filterHistory('swStartDate','swEndDate').filter(d=>salesmanF==='all'||d.salesman===salesmanF);

            // Filter by area: find shops in the selected area
            if (areaF !== 'all') {
                const shopsInArea = new Set(
                    Object.entries(globalShops)
                        .filter(([id,d]) => (d.area||'')=== areaF)
                        .map(([id,d]) => d.name || id)
                );
                rows = rows.filter(d => shopsInArea.has(d.shopName));
            }

            if (!rows.length) { toast('No data found!','error'); return; }

            const shopMap = {};
            rows.forEach(d => {
                if (!shopMap[d.shopName]) shopMap[d.shopName] = { revenue:0, orders:0 };
                shopMap[d.shopName].revenue += d.total;
                shopMap[d.shopName].orders  += 1;
            });
            const sortBy = document.getElementById('swSortBy').value;
            swDataArray = Object.entries(shopMap).map(([name,v])=>({
                Shop: name,
                Area: (Object.values(globalShops).find(s=>(s.name||'')=== name)||{}).area || 'â€”',
                Orders: v.orders,
                'Revenue (â‚¹)': parseFloat(v.revenue.toFixed(2)),
                'Avg/Order (â‚¹)': parseFloat((v.revenue/v.orders).toFixed(2)),
                _rev: v.revenue, _ord: v.orders
            }));
            const totalRev = swDataArray.reduce((s,r)=>s+r._rev,0);
            swDataArray.forEach(r=>r['Share (%)']=totalRev>0?parseFloat(((r._rev/totalRev)*100).toFixed(1)):0);
            if (sortBy==='revenue') swDataArray.sort((a,b)=>b._rev-a._rev);
            else if (sortBy==='orders') swDataArray.sort((a,b)=>b._ord-a._ord);
            else if (sortBy==='avg')    swDataArray.sort((a,b)=>b['Avg/Order (â‚¹)']-a['Avg/Order (â‚¹)']);
            else swDataArray.sort((a,b)=>a.Shop.localeCompare(b.Shop));

            document.getElementById('swTotalShops').innerText   = swDataArray.length;
            document.getElementById('swTotalOrders').innerText  = swDataArray.reduce((s,r)=>s+r.Orders,0);
            document.getElementById('swTotalRevenue').innerText = 'â‚¹ '+totalRev.toFixed(2);
            document.getElementById('swTableCount').innerText   = `(${swDataArray.length} shops${areaF!=='all'?' Â· '+areaF:''})`;

            // Table
            const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            document.getElementById('swTableBody').innerHTML = swDataArray.map((r,i)=>`<tr>
                <td style="font-weight:800; text-align:center;">${medals[i]||'#'+(i+1)}</td>
                <td>
                    <div style="font-weight:700;">${r.Shop}</div>
                    ${r.Area && r.Area!=='â€”' ? `<div style="font-size:10px; color:#b45309; background:rgba(245,158,11,0.1); border-radius:6px; padding:1px 6px; display:inline-block; margin-top:3px;">ðŸ—ºï¸ ${r.Area}</div>` : ''}
                    <div style="background:var(--border);border-radius:99px;height:4px;margin-top:4px;overflow:hidden;">
                        <div style="width:${r['Share (%)'].toFixed(0)}%;height:100%;background:linear-gradient(90deg,var(--primary),#6366f1);border-radius:99px;"></div>
                    </div>
                </td>
                <td style="color:#64748b;">${r.Orders}</td>
                <td style="color:var(--success);font-weight:800;">â‚¹${r['Revenue (â‚¹)'].toFixed(2)}</td>
                <td style="color:#64748b;">â‚¹${r['Avg/Order (â‚¹)'].toFixed(2)}</td>
                <td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Share (%)'].toFixed(1)}%</span></td>
            </tr>`).join('');

            // Chart (top 10)
            const top10 = swDataArray.slice(0,10);
            const colors=['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16'];
            swBarChartInst = _destroyChart(swBarChartInst);
            swBarChartInst = new Chart(document.getElementById('swBarChart').getContext('2d'),{
                type:'bar',
                data:{ labels:top10.map(r=>r.Shop.length>12?r.Shop.substring(0,10)+'â€¦':r.Shop), datasets:[{label:'Revenue (â‚¹)',data:top10.map(r=>r._rev),backgroundColor:colors,borderRadius:8,borderSkipped:false}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'â‚¹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:10}}}}}
            });
            document.getElementById('swResultArea').style.display='block';
            toast('âœ… Shop report generated!','success');
        }

        // ===== SALESMAN PERFORMANCE REPORT =====
        let slDataArray=[], slBarChartInst=null, slOrderChartInst=null;
        function slApplyPreset(p,btn){ _applyDatePresetTo(p,'slStartDate','slEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function slClearPresets(){ document.getElementById('slStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetSalesmanReport(){ document.getElementById('slStartDate').value=''; document.getElementById('slEndDate').value=''; document.getElementById('slResultArea').style.display='none'; }

        function generateSalesmanReport() {
            const rows = _filterHistory('slStartDate','slEndDate');
            if (!rows.length) { toast('No data found!','error'); return; }

            const smMap = {};
            rows.forEach(d => {
                const s = d.salesman || 'Unknown';
                if (!smMap[s]) smMap[s] = { revenue:0, orders:0, shops:new Set() };
                smMap[s].revenue += d.total;
                smMap[s].orders  += 1;
                smMap[s].shops.add(d.shopName);
            });
            const totalRev = Object.values(smMap).reduce((s,v)=>s+v.revenue,0);
            slDataArray = Object.entries(smMap).map(([name,v])=>({
                Salesman: name, Orders: v.orders,
                'Revenue (â‚¹)': parseFloat(v.revenue.toFixed(2)),
                'Avg/Order (â‚¹)': parseFloat((v.revenue/v.orders).toFixed(2)),
                'Unique Shops': v.shops.size,
                'Share (%)': totalRev>0 ? parseFloat(((v.revenue/totalRev)*100).toFixed(1)) : 0,
                _rev: v.revenue, _ord: v.orders
            })).sort((a,b)=>b._rev-a._rev);

            document.getElementById('slTotalSalesmen').innerText  = slDataArray.length;
            document.getElementById('slTotalOrders').innerText    = slDataArray.reduce((s,r)=>s+r.Orders,0);
            document.getElementById('slTotalRevenue').innerText   = 'â‚¹ '+totalRev.toFixed(2);
            document.getElementById('slTableCount').innerText     = `(${slDataArray.length} salesmen)`;

            const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const colors=['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee'];
            document.getElementById('slTableBody').innerHTML = slDataArray.map((r,i)=>`<tr>
                <td style="font-weight:800;font-size:16px;text-align:center;">${medals[i]||'#'+(i+1)}</td>
                <td style="font-weight:700;">${r.Salesman}</td>
                <td>${r.Orders}</td>
                <td style="color:var(--success);font-weight:800;">â‚¹${r['Revenue (â‚¹)'].toFixed(2)}</td>
                <td style="color:#64748b;">â‚¹${r['Avg/Order (â‚¹)'].toFixed(2)}</td>
                <td>${r['Unique Shops']}</td>
                <td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Share (%)'].toFixed(1)}%</span></td>
            </tr>`).join('');

            slBarChartInst = _destroyChart(slBarChartInst);
            slBarChartInst = new Chart(document.getElementById('slBarChart').getContext('2d'),{
                type:'bar', data:{labels:slDataArray.map(r=>r.Salesman),datasets:[{label:'Revenue',data:slDataArray.map(r=>r._rev),backgroundColor:colors,borderRadius:6}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'â‚¹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}}}}
            });
            slOrderChartInst = _destroyChart(slOrderChartInst);
            slOrderChartInst = new Chart(document.getElementById('slOrderChart').getContext('2d'),{
                type:'doughnut', data:{labels:slDataArray.map(r=>r.Salesman),datasets:[{data:slDataArray.map(r=>r._ord),backgroundColor:colors,borderWidth:2}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},boxWidth:10}}}}
            });
            document.getElementById('slResultArea').style.display='block';
            toast('âœ… Salesman report generated!','success');
        }

        // ===== SALES TREND REPORT =====
        let trDataArray=[], trLineChartInst=null;
        function resetTrendReport(){ document.getElementById('trStartDate').value=''; document.getElementById('trEndDate').value=''; document.getElementById('trResultArea').style.display='none'; }

        function generateTrendReport() {
            const groupBy = document.querySelector('input[name="trendGroup"]:checked').value;
            const shopF   = document.getElementById('trShopFilter').value;
            const salesmanF = document.getElementById('trSalesmanFilter').value;

            // Populate filters
            const shopSel = document.getElementById('trShopFilter');
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id,d])=>shopSel.innerHTML+=`<option value="${id}">${d.name||id}</option>`);
            shopSel.value = curShop;
            const smSel = document.getElementById('trSalesmanFilter');
            const curSm = smSel.value;
            const smSet=new Set(); historyData.forEach(d=>smSet.add(d.salesman));
            smSel.innerHTML='<option value="all">All Salesmen</option>';
            smSet.forEach(s=>{ if(s) smSel.innerHTML+=`<option value="${s}">${s}</option>`; });
            smSel.value = curSm;

            const rows = _filterHistory('trStartDate','trEndDate')
                .filter(d=>(shopF==='all'||d.shopName===shopF)&&(salesmanF==='all'||d.salesman===salesmanF));
            if (!rows.length) { toast('No data found!','error'); return; }

            const buckets = {};
            rows.forEach(d => {
                const dt = d.time ? d.time.toDate() : new Date();
                let key;
                if (groupBy==='daily')        key = dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
                else if (groupBy==='weekly')  { const wStart=new Date(dt); wStart.setDate(dt.getDate()-dt.getDay()); key='W/'+wStart.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
                else                           key = dt.toLocaleDateString('en-GB',{month:'short',year:'numeric'});
                if (!buckets[key]) buckets[key]={revenue:0,orders:0,qty:0,_ts:dt.getTime()};
                buckets[key].revenue += d.total;
                buckets[key].orders  += 1;
                buckets[key].qty     += d.items.reduce((s,i)=>s+i.qty,0);
            });

            const sorted = Object.entries(buckets).sort((a,b)=>a[1]._ts-b[1]._ts);
            const totalRev = sorted.reduce((s,[,v])=>s+v.revenue,0);
            const avgRev   = sorted.length ? totalRev/sorted.length : 0;
            const peakEntry= sorted.reduce((max,cur)=>cur[1].revenue>max[1].revenue?cur:max, sorted[0]);

            document.getElementById('trPeakPeriod').innerText  = peakEntry[0];
            document.getElementById('trPeakRevenue').innerText = 'â‚¹ '+peakEntry[1].revenue.toFixed(2);
            document.getElementById('trAvgRevenue').innerText  = 'â‚¹ '+avgRev.toFixed(2);
            document.getElementById('trTableCount').innerText  = `(${sorted.length} periods)`;

            trDataArray = sorted.map(([period,v],i)=>({
                Period:period, Orders:v.orders, 'Revenue (â‚¹)':parseFloat(v.revenue.toFixed(2)),
                'Qty Sold':v.qty,
                'vs Prev %': i>0?parseFloat((((v.revenue-sorted[i-1][1].revenue)/sorted[i-1][1].revenue)*100).toFixed(1)):0
            }));

            document.getElementById('trTableBody').innerHTML = trDataArray.map((r,i)=>{
                const chg = r['vs Prev %'];
                const chgHtml = i===0?'â€”':`<span style="color:${chg>=0?'var(--success)':'var(--danger)'};font-weight:700;">${chg>=0?'â–²':'â–¼'}${Math.abs(chg)}%</span>`;
                return `<tr>
                    <td style="font-weight:700;">${r.Period}</td>
                    <td>${r.Orders}</td>
                    <td style="color:var(--success);font-weight:700;">â‚¹${r['Revenue (â‚¹)'].toFixed(2)}</td>
                    <td>${r['Qty Sold']}</td>
                    <td>${chgHtml}</td>
                </tr>`;
            }).join('');

            trLineChartInst = _destroyChart(trLineChartInst);
            trLineChartInst = new Chart(document.getElementById('trLineChart').getContext('2d'),{
                type: sorted.length<=10?'bar':'line',
                data:{ labels:sorted.map(([k])=>k), datasets:[
                    {label:'Revenue (â‚¹)',data:sorted.map(([,v])=>v.revenue),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',fill:true,tension:0.4,borderWidth:2,pointRadius:4,borderRadius:6,borderSkipped:false}
                ]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'â‚¹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:10},maxRotation:45}}}}
            });
            document.getElementById('trResultArea').style.display='block';
            toast('âœ… Trend report generated!','success');
        }

        // ===== PROFIT & MARGIN REPORT =====
        let pmDataArray=[], pmBarChartInst=null;
        function pmApplyPreset(p,btn){ _applyDatePresetTo(p,'pmStartDate','pmEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function pmClearPresets(){ document.getElementById('pmStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetProfitReport(){ document.getElementById('pmStartDate').value=''; document.getElementById('pmEndDate').value=''; document.getElementById('pmResultArea').style.display='none'; }

        function generateProfitReport() {
            const rows = _filterHistory('pmStartDate','pmEndDate');
            if (!rows.length) { toast('No data found!','error'); return; }

            const productMap = {};
            rows.forEach(d => {
                d.items.forEach(item => {
                    const cp = (productsMap[item.id]||{}).costPrice || 0;
                    if (!productMap[item.id]) productMap[item.id] = { qty:0, revenue:0, cost:0, costKnown: cp>0 };
                    productMap[item.id].qty     += item.qty;
                    productMap[item.id].revenue += (item.total || item.qty*(item.price||0));
                    productMap[item.id].cost    += item.qty * cp;
                    if (cp>0) productMap[item.id].costKnown = true;
                });
            });

            let totalRev=0, totalCost=0;
            pmDataArray = Object.entries(productMap).map(([name,v])=>{
                const profit = v.revenue - v.cost;
                const margin = v.revenue>0 ? (profit/v.revenue)*100 : 0;
                totalRev  += v.revenue;
                totalCost += v.cost;
                return { Product:name, 'Qty Sold':v.qty,
                    'Revenue (â‚¹)':parseFloat(v.revenue.toFixed(2)),
                    'Cost (â‚¹)':parseFloat(v.cost.toFixed(2)),
                    'Profit (â‚¹)':parseFloat(profit.toFixed(2)),
                    'Margin (%)':parseFloat(margin.toFixed(1)),
                    _rev:v.revenue, _profit:profit, _margin:margin, _costKnown:v.costKnown };
            }).sort((a,b)=>b._profit-a._profit);

            const netProfit = totalRev - totalCost;
            const netMargin = totalRev>0 ? (netProfit/totalRev)*100 : 0;

            document.getElementById('pmRevenue').innerText  = 'â‚¹ '+totalRev.toFixed(2);
            document.getElementById('pmCost').innerText     = 'â‚¹ '+totalCost.toFixed(2);
            document.getElementById('pmNetProfit').innerText= 'â‚¹ '+netProfit.toFixed(2);
            document.getElementById('pmNetProfit').style.color = netProfit>=0?'var(--success)':'var(--danger)';
            document.getElementById('pmMargin').innerText   = netMargin.toFixed(1)+'%';
            document.getElementById('pmMargin').style.color = netMargin>=0?'var(--success)':'var(--danger)';
            document.getElementById('pmTableCount').innerText=`(${pmDataArray.length} products)`;

            document.getElementById('pmTableBody').innerHTML = pmDataArray.map(r=>{
                const profitColor = r['Profit (â‚¹)']>=0?'var(--success)':'var(--danger)';
                const marginColor = r['Margin (%)']>=20?'var(--success)':r['Margin (%)']>=10?'var(--warning)':'var(--danger)';
                const noCost = !r._costKnown ? `<span style="font-size:10px;color:#94a3b8;" title="Cost price not set">âš ï¸</span>` : '';
                return `<tr>
                    <td style="font-weight:700;">${r.Product} ${noCost}</td>
                    <td>${r['Qty Sold']}</td>
                    <td style="color:var(--primary);">â‚¹${r['Revenue (â‚¹)'].toFixed(2)}</td>
                    <td style="color:var(--danger);">â‚¹${r['Cost (â‚¹)'].toFixed(2)}</td>
                    <td style="color:${profitColor};font-weight:800;">â‚¹${r['Profit (â‚¹)'].toFixed(2)}</td>
                    <td><span style="background:rgba(16,185,129,0.1);color:${marginColor};padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Margin (%)'].toFixed(1)}%</span></td>
                </tr>`;
            }).join('');

            // Top margin products (with cost known)
            const topMargin = pmDataArray.filter(r=>r._costKnown&&r._rev>0).sort((a,b)=>b._margin-a._margin).slice(0,3);
            const gradients=['rgba(16,185,129,0.1)','rgba(99,102,241,0.08)','rgba(245,158,11,0.08)'];
            document.getElementById('pmTopMargin').innerHTML = topMargin.length ? topMargin.map((r,i)=>`
                <div style="background:${gradients[i]};border-radius:10px;padding:10px 12px;margin-bottom:8px;">
                    <div style="font-weight:700;font-size:12px;">${r.Product}</div>
                    <div style="font-size:11px;color:#64748b;margin-top:3px;">
                        <span style="color:var(--success);font-weight:700;">${r['Margin (%)'].toFixed(1)}% margin</span>
                        &nbsp;Â·&nbsp; Profit â‚¹${r['Profit (â‚¹)'].toFixed(0)}
                    </div>
                </div>`).join('') : '<div style="color:#94a3b8;font-size:12px;padding:10px;">Set cost prices to see margin leaders</div>';

            // Bar chart: revenue vs cost vs profit
            const top8 = pmDataArray.slice(0,8);
            pmBarChartInst = _destroyChart(pmBarChartInst);
            pmBarChartInst = new Chart(document.getElementById('pmBarChart').getContext('2d'),{
                type:'bar',
                data:{ labels:top8.map(r=>r.Product.length>10?r.Product.substring(0,8)+'â€¦':r.Product),
                    datasets:[
                        {label:'Revenue',data:top8.map(r=>r._rev),backgroundColor:'rgba(99,102,241,0.7)',borderRadius:4},
                        {label:'Cost',data:top8.map(r=>r['Cost (â‚¹)']),backgroundColor:'rgba(244,63,94,0.6)',borderRadius:4},
                        {label:'Profit',data:top8.map(r=>r._profit),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4}
                    ]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},boxWidth:10}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'â‚¹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:9}}}}}
            });
            document.getElementById('pmResultArea').style.display='block';
            toast('âœ… Profit report generated!','success');
        }

        // ===== INCENTIVE RATES (localStorage) =====
        const INC_RATES_KEY = 'owm_incentive_rates';

        function loadIncentiveRates() {
            try {
                const saved = JSON.parse(localStorage.getItem(INC_RATES_KEY) || '{}');
                return {
                    shopCreator: saved.shopCreator !== undefined ? saved.shopCreator : 1.0,
                    orderTaker:  saved.orderTaker  !== undefined ? saved.orderTaker  : 0.5
                };
            } catch(e) { return { shopCreator: 1.0, orderTaker: 0.5 }; }
        }

        function saveIncentiveRates() {
            const sc = parseFloat(document.getElementById('incShopCreatorPct').value);
            const ot = parseFloat(document.getElementById('incOrderTakerPct').value);
            if (isNaN(sc) || isNaN(ot) || sc < 0 || ot < 0) return toast('Invalid rates!', 'error');
            localStorage.setItem(INC_RATES_KEY, JSON.stringify({ shopCreator: sc, orderTaker: ot }));
            const el = document.getElementById('incCurrentRates');
            el.style.display = 'block';
            document.getElementById('incCurrentRatesText').innerHTML =
                `âœ… Saved â€” Shop Creator: <b>${sc}%</b> &nbsp;|&nbsp; Order Taker: <b>${ot}%</b>`;
            toast(`âœ… Rates saved! Shop Creator: ${sc}% | Order Taker: ${ot}%`, 'success');
        }

        function initIncentiveSettingsUI() {
            const rates = loadIncentiveRates();
            // Sync the separate Settings card inputs (if present)
            const sc = document.getElementById('incShopCreatorPct');
            const ot = document.getElementById('incOrderTakerPct');
            if (sc) sc.value = rates.shopCreator;
            if (ot) ot.value  = rates.orderTaker;
            // Sync the inline Calculator inputs
            const cc = document.getElementById('incCalcCreatorPct');
            const co = document.getElementById('incCalcOrderPct');
            if (cc) cc.value = rates.shopCreator;
            if (co) co.value  = rates.orderTaker;
            // Show current rates note in Settings card
            const el = document.getElementById('incCurrentRates');
            if (el) {
                el.style.display = 'block';
                document.getElementById('incCurrentRatesText').innerHTML =
                    `Current rates â€” Shop Creator: <b>${rates.shopCreator}%</b> &nbsp;|&nbsp; Order Taker: <b>${rates.orderTaker}%</b>`;
            }
            incPreviewRates();
        }

        function incPreviewRates() {
            const cc = document.getElementById('incCalcCreatorPct');
            const co = document.getElementById('incCalcOrderPct');
            const pl = document.getElementById('incRatePreviewLine');
            if (!cc || !co || !pl) return;
            const sc = parseFloat(cc.value) || 0;
            const ot = parseFloat(co.value) || 0;
            pl.innerHTML = `Example: â‚¹10,000 billing â†’ Creator earns <b>â‚¹${(10000*sc/100).toFixed(0)}</b> &nbsp;|&nbsp; Order Taker earns <b>â‚¹${(10000*ot/100).toFixed(0)}</b>`;
        }

        function incSaveRatesInline() {
            const sc = parseFloat(document.getElementById('incCalcCreatorPct').value);
            const ot = parseFloat(document.getElementById('incCalcOrderPct').value);
            if (isNaN(sc) || isNaN(ot) || sc < 0 || ot < 0) return toast('Invalid rates!', 'error');
            localStorage.setItem(INC_RATES_KEY, JSON.stringify({ shopCreator: sc, orderTaker: ot }));
            // Also sync the separate Settings card if open
            const sc2 = document.getElementById('incShopCreatorPct');
            const ot2 = document.getElementById('incOrderTakerPct');
            if (sc2) sc2.value = sc;
            if (ot2) ot2.value  = ot;
            const btn = document.getElementById('incSaveRateBtn');
            if (btn) { btn.textContent = 'âœ… Saved!'; setTimeout(() => btn.textContent = 'ðŸ’¾ Save Rates', 2000); }
            toast(`âœ… Rates saved! Shop Creator: ${sc}% | Order Taker: ${ot}%`, 'success');
        }

        function populateShopCreatedBySelect() {
            const sel = document.getElementById('shopCreatedBy');
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="">-- Select Salesman --</option>';
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            // Also add from users if available
            smSet.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (cur) sel.value = cur;
        }

        // ===== INCENTIVE CALCULATOR =====
        let incExportArray = [];

        function incApplyPreset(p, btn) {
            btn.closest('.date-preset-grid').querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            _applyDatePresetTo(p, 'incStartDate', 'incEndDate', null);
        }
        function incClearPresets() {
            const body = document.getElementById('incStartDate').closest('.collapse-body');
            if (body) body.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
        }

        function populateIncSalesmanFilter() {
            const sel = document.getElementById('incSalesmanFilter');
            if (!sel) return;
            const cur = sel.value;
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            sel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (cur) sel.value = cur;
        }

        function calculateIncentive() {
            // Read rates from inline inputs (most up-to-date values)
            const creatorPctEl = document.getElementById('incCalcCreatorPct');
            const orderPctEl   = document.getElementById('incCalcOrderPct');
            const rates = {
                shopCreator: creatorPctEl ? (parseFloat(creatorPctEl.value) || 0) : loadIncentiveRates().shopCreator,
                orderTaker:  orderPctEl   ? (parseFloat(orderPctEl.value)   || 0) : loadIncentiveRates().orderTaker
            };
            const sVal = document.getElementById('incStartDate').value;
            const eVal = document.getElementById('incEndDate').value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            const salesmanF = document.getElementById('incSalesmanFilter').value;

            // Filter orders by date
            const orders = historyData.filter(d => {
                const ms = d.time ? d.time.toDate().getTime() : 0;
                return ms >= startMs && ms <= endMs;
            });

            if (!orders.length) { toast('No orders found for selected period!', 'error'); return; }

            // Build salesman map: { name: { orderTakerRev, creatorRev, orders, createdShops } }
            const smMap = {};
            const ensureSm = name => {
                if (!smMap[name]) smMap[name] = { orderTakerRev: 0, creatorRev: 0, orders: 0, createdShops: new Set() };
            };

            orders.forEach(d => {
                const taker = d.salesman || 'Unknown';
                ensureSm(taker);
                smMap[taker].orderTakerRev += d.total;
                smMap[taker].orders += 1;

                // Check who created this shop
                const shopData = globalShops[d.shopName] || globalShops[Object.keys(globalShops).find(k => globalShops[k].name === d.shopName)] || null;
                const creator = shopData ? (shopData.createdBy || '') : '';
                if (creator && creator !== taker) {
                    ensureSm(creator);
                    smMap[creator].creatorRev += d.total;
                    smMap[creator].createdShops.add(d.shopName);
                } else if (creator && creator === taker) {
                    // same person took order & created shop â€” both incentives apply
                    smMap[taker].creatorRev += d.total;
                    smMap[taker].createdShops.add(d.shopName);
                }
            });

            // Build results
            const results = Object.entries(smMap)
                .filter(([name]) => salesmanF === 'all' || name === salesmanF)
                .map(([name, v]) => {
                    const creatorInc  = (v.creatorRev  * rates.shopCreator) / 100;
                    const orderInc    = (v.orderTakerRev * rates.orderTaker)  / 100;
                    const totalInc    = creatorInc + orderInc;
                    return { name, ...v, creatorInc, orderInc, totalInc };
                })
                .sort((a, b) => b.totalInc - a.totalInc);

            if (!results.length) { toast('No data for selected salesman!', 'error'); return; }

            const totalRev = results.reduce((s,r) => s + r.orderTakerRev, 0);
            const totalPayout = results.reduce((s,r) => s + r.totalInc, 0);

            document.getElementById('incTotalRevenue').innerText = 'â‚¹ ' + totalRev.toFixed(2);
            document.getElementById('incTotalPayout').innerText  = 'â‚¹ ' + totalPayout.toFixed(2);
            document.getElementById('incRateBanner').innerHTML   =
                `ðŸ“Œ Applied Rates â€” Shop Creator: <b>${rates.shopCreator}%</b> of shop's billing &nbsp;|&nbsp; Order Taker: <b>${rates.orderTaker}%</b> of order amount`;

            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const colors = ['rgba(99,102,241,0.08)','rgba(16,185,129,0.07)','rgba(245,158,11,0.07)'];
            const borderColors = ['rgba(99,102,241,0.3)','rgba(16,185,129,0.25)','rgba(245,158,11,0.25)'];

            document.getElementById('incCardsArea').innerHTML = results.map((r, i) => {
                const medal = medals[i] || `#${i+1}`;
                const bg     = colors[Math.min(i,2)];
                const border = borderColors[Math.min(i,2)];
                const hasCreator = r.creatorRev > 0;
                const hasOrder   = r.orderTakerRev > 0;
                return `<div style="background:${bg}; border:1.5px solid ${border}; border-radius:16px; padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:22px;">${medal}</span>
                            <div>
                                <div style="font-weight:800; font-size:15px;">${r.name}</div>
                                <div style="font-size:11px; color:#64748b;">${r.orders} orders &nbsp;Â·&nbsp; ${r.createdShops.size} shops created</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#64748b; font-weight:600;">TOTAL INCENTIVE</div>
                            <div style="font-size:22px; font-weight:900; color:var(--warning);">â‚¹${r.totalInc.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="border-top:1px solid var(--border); padding-top:12px; display:flex; flex-direction:column; gap:8px;">
                        ${hasOrder ? `<div style="display:flex; justify-content:space-between; align-items:center; background:rgba(99,102,241,0.07); border-radius:10px; padding:10px 12px;">
                            <div>
                                <div style="font-size:12px; font-weight:700; color:var(--primary);">ðŸ“¦ Order Taker Incentive</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Revenue: â‚¹${r.orderTakerRev.toFixed(2)} Ã— ${rates.orderTaker}%</div>
                            </div>
                            <div style="font-size:16px; font-weight:800; color:var(--primary);">â‚¹${r.orderInc.toFixed(2)}</div>
                        </div>` : ''}
                        ${hasCreator ? `<div style="display:flex; justify-content:space-between; align-items:center; background:rgba(16,185,129,0.07); border-radius:10px; padding:10px 12px;">
                            <div>
                                <div style="font-size:12px; font-weight:700; color:var(--success);">ðŸª Shop Creator Incentive</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Shop billing: â‚¹${r.creatorRev.toFixed(2)} Ã— ${rates.shopCreator}%</div>
                                <div style="font-size:10px; color:#94a3b8; margin-top:1px;">Shops: ${[...r.createdShops].join(', ')}</div>
                            </div>
                            <div style="font-size:16px; font-weight:800; color:var(--success);">â‚¹${r.creatorInc.toFixed(2)}</div>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');

            // Build export array
            incExportArray = results.map(r => ({
                'Salesman': r.name,
                'Orders': r.orders,
                'Shops Created': r.createdShops.size,
                'Order Revenue (â‚¹)': parseFloat(r.orderTakerRev.toFixed(2)),
                'Shop Billing (â‚¹)': parseFloat(r.creatorRev.toFixed(2)),
                [`Order Incentive (${rates.orderTaker}%) (â‚¹)`]: parseFloat(r.orderInc.toFixed(2)),
                [`Creator Incentive (${rates.shopCreator}%) (â‚¹)`]: parseFloat(r.creatorInc.toFixed(2)),
                'Total Incentive (â‚¹)': parseFloat(r.totalInc.toFixed(2))
            }));

            document.getElementById('incResultArea').style.display = 'block';
            toast(`âœ… Incentive calculated for ${results.length} salesman!`, 'success');
        }

        async function manualSync() {
            if (!isOnline) return toast('ðŸ“µ Still offline. Please connect to the internet.', 'error');
            await syncOfflineQueue();
            renderOfflineQueueList();
        }

        // ===== PRODUCT-WISE SALES REPORT =====
        let pwDataArray = [];
        let pwSortKey = 'revenue';
        let pwSortDir = -1; // -1 = desc, 1 = asc
        let pwBarChartInstance = null;
        let pwPieChartInstance = null;

        function pwApplyPreset(preset, btn) {
            document.querySelectorAll('.collapsible-section .date-preset-grid .preset-btn').forEach(b => {
                if (b.closest('#pwResultArea') === null) b.classList.remove('active-preset');
            });
            // target only the pw preset buttons
            btn.closest('.date-preset-grid').querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const today = new Date();
            let start = null, end = null;
            if (preset === 'today') { start = end = new Date(today); }
            else if (preset === 'yesterday') { const yd = new Date(today); yd.setDate(yd.getDate()-1); start = end = yd; }
            else if (preset === 'week') { start = new Date(today); start.setDate(today.getDate()-today.getDay()); end = new Date(today); }
            else if (preset === 'month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today); }
            else if (preset === 'lastmonth') { start = new Date(today.getFullYear(), today.getMonth()-1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
            else if (preset === 'all') { document.getElementById('pwStartDate').value = ''; document.getElementById('pwEndDate').value = ''; return; }
            if (start) document.getElementById('pwStartDate').value = start.toISOString().split('T')[0];
            if (end) document.getElementById('pwEndDate').value = end.toISOString().split('T')[0];
        }

        function pwClearPresets() {
            const grid = document.getElementById('pwStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn');
            grid.forEach(b => b.classList.remove('active-preset'));
        }

        function resetProductWiseReport() {
            document.getElementById('pwStartDate').value = '';
            document.getElementById('pwEndDate').value = '';
            document.getElementById('pwShopFilter').value = 'all';
            document.getElementById('pwSalesmanFilter').value = 'all';
            document.getElementById('pwAreaFilter').value = 'all';
            document.getElementById('pwResultArea').style.display = 'none';
            const grid = document.getElementById('pwStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn');
            grid.forEach((b,i) => { b.classList.remove('active-preset'); if(i===3) b.classList.add('active-preset'); });
            toast('Filters reset!', 'success');
        }

        function generateProductWiseReport() {
            const sVal = document.getElementById('pwStartDate').value;
            const eVal = document.getElementById('pwEndDate').value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            const shopF   = document.getElementById('pwShopFilter').value;
            const salesmanF = document.getElementById('pwSalesmanFilter').value;
            const areaF   = document.getElementById('pwAreaFilter').value;

            // Populate salesman filter dynamically
            const smSel = document.getElementById('pwSalesmanFilter');
            const curSm = smSel.value;
            const smSet = new Set();
            historyData.forEach(d => smSet.add(d.salesman));
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => { if(s) smSel.innerHTML += `<option value="${s}">${s}</option>`; });
            smSel.value = curSm;

            // Populate shop filter dynamically
            const shopSel = document.getElementById('pwShopFilter');
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id, d]) => {
                shopSel.innerHTML += `<option value="${id}">${d.name || id}</option>`;
            });
            shopSel.value = curShop;

            // Build set of shops in selected area
            const shopsInArea = areaF !== 'all' ? new Set(
                Object.entries(globalShops)
                    .filter(([id,d]) => (d.area||'') === areaF)
                    .map(([id,d]) => d.name || id)
            ) : null;

            // Aggregate
            const productMap = {}; // { name: { qty, revenue, orders } }
            let totalRevenue = 0;

            historyData.forEach(d => {
                const oMs = d.time ? d.time.toDate().getTime() : 0;
                if (oMs < startMs || oMs > endMs) return;
                if (shopF !== 'all' && d.shopName !== shopF) return;
                if (salesmanF !== 'all' && d.salesman !== salesmanF) return;
                if (shopsInArea && !shopsInArea.has(d.shopName)) return;

                d.items.forEach(item => {
                    if (!productMap[item.id]) productMap[item.id] = { qty: 0, revenue: 0, orders: 0 };
                    productMap[item.id].qty += item.qty;
                    productMap[item.id].revenue += (item.total || (item.qty * item.price) || 0);
                    productMap[item.id].orders += 1;
                    totalRevenue += (item.total || 0);
                });
            });

            if (!Object.keys(productMap).length) {
                toast('No data found for selected filters!', 'error');
                document.getElementById('pwResultArea').style.display = 'none';
                return;
            }

            // Build sorted array
            pwDataArray = Object.entries(productMap).map(([name, v]) => ({
                Product: name,
                'Qty Sold': v.qty,
                'Revenue (â‚¹)': parseFloat(v.revenue.toFixed(2)),
                'Orders': v.orders,
                'Avg Per Order (â‚¹)': v.orders > 0 ? parseFloat((v.revenue / v.orders).toFixed(2)) : 0,
                'Share (%)': totalRevenue > 0 ? parseFloat(((v.revenue / totalRevenue) * 100).toFixed(1)) : 0,
                _revenue: v.revenue,
                _qty: v.qty,
                _orders: v.orders
            }));

            pwDataArray.sort((a, b) => pwSortDir * (b._revenue - a._revenue));

            // Stats
            document.getElementById('pwTotalProducts').innerText = pwDataArray.length;
            document.getElementById('pwTotalQty').innerText = pwDataArray.reduce((s,r) => s + r['Qty Sold'], 0);
            document.getElementById('pwTotalRevenue').innerText = 'â‚¹ ' + totalRevenue.toFixed(2);
            document.getElementById('pwTableCount').innerText = `(${pwDataArray.length} products)`;

            pwRenderTable();
            pwRenderCharts(totalRevenue);
            pwRenderTopThree();

            document.getElementById('pwResultArea').style.display = 'block';
            toast('âœ… Product report generated!', 'success');
        }

        function pwRenderTable() {
            const tbody = document.getElementById('pwTableBody');
            tbody.innerHTML = '';
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const sortedByRevenue = [...pwDataArray].sort((a,b) => b._revenue - a._revenue);
            const totalRev = pwDataArray.reduce((s,r) => s + r._revenue, 0);

            pwDataArray.forEach((row, i) => {
                const rank = sortedByRevenue.findIndex(r => r.Product === row.Product) + 1;
                const medal = medals[rank-1] || `#${rank}`;
                const barWidth = totalRev > 0 ? Math.max(4, (row._revenue / totalRev) * 100).toFixed(0) : 0;
                const isTop = rank <= 3;
                tbody.innerHTML += `<tr style="${isTop ? 'background:rgba(99,102,241,0.04);' : ''}">
                    <td style="font-weight:800; font-size:15px; text-align:center;">${medal}</td>
                    <td>
                        <div style="font-weight:700;">${row.Product}</div>
                        <div style="background:var(--border); border-radius:99px; height:4px; margin-top:5px; overflow:hidden;">
                            <div style="width:${barWidth}%; height:100%; border-radius:99px; background:linear-gradient(90deg,var(--primary),#6366f1); transition:width 0.6s;"></div>
                        </div>
                    </td>
                    <td style="color:var(--primary); font-weight:700;">${row['Qty Sold']}</td>
                    <td style="color:var(--success); font-weight:800;">â‚¹${row['Revenue (â‚¹)'].toFixed(2)}</td>
                    <td style="color:#64748b;">${row.Orders}</td>
                    <td style="color:#64748b;">â‚¹${row['Avg Per Order (â‚¹)'].toFixed(2)}</td>
                    <td><span style="background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:20px; font-weight:700; font-size:11px;">${row['Share (%)'].toFixed(1)}%</span></td>
                </tr>`;
            });
        }

        function pwRenderCharts(totalRevenue) {
            const top10 = [...pwDataArray].sort((a,b) => b._revenue - a._revenue).slice(0, 10);
            const colors = ['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16'];

            // Bar chart
            const barCtx = document.getElementById('pwBarChart').getContext('2d');
            if (pwBarChartInstance) pwBarChartInstance.destroy();
            pwBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: top10.map(r => r.Product.length > 14 ? r.Product.substring(0,12)+'â€¦' : r.Product),
                    datasets: [{
                        label: 'Revenue (â‚¹)',
                        data: top10.map(r => r._revenue),
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => 'â‚¹' + (v>=1000 ? (v/1000).toFixed(1)+'k' : v) } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });

            // Pie chart (top 5 + others)
            const top5 = top10.slice(0, 5);
            const othersRev = pwDataArray.slice(5).reduce((s,r) => s + r._revenue, 0);
            const pieLabels = top5.map(r => r.Product.length > 12 ? r.Product.substring(0,10)+'â€¦' : r.Product);
            const pieData   = top5.map(r => r._revenue);
            if (othersRev > 0) { pieLabels.push('Others'); pieData.push(othersRev); }

            const pieCtx = document.getElementById('pwPieChart').getContext('2d');
            if (pwPieChartInstance) pwPieChartInstance.destroy();
            pwPieChartInstance = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: pieLabels,
                    datasets: [{ data: pieData, backgroundColor: [...colors, '#94a3b8'], borderWidth: 2 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 9 }, boxWidth: 10 } } }
                }
            });
        }

        function pwRenderTopThree() {
            const top3 = [...pwDataArray].sort((a,b) => b._revenue - a._revenue).slice(0, 3);
            const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
            const bgColors = ['rgba(99,102,241,0.1)','rgba(16,185,129,0.08)','rgba(245,158,11,0.08)'];
            const borderColors = ['rgba(99,102,241,0.3)','rgba(16,185,129,0.25)','rgba(245,158,11,0.25)'];
            document.getElementById('pwTopThree').innerHTML = top3.map((r, i) => `
                <div style="background:${bgColors[i]}; border:1px solid ${borderColors[i]}; border-radius:12px; padding:10px 12px; margin-bottom:8px;">
                    <div style="font-size:18px; display:inline;">${medals[i]}</div>
                    <span style="font-weight:700; font-size:13px; margin-left:4px;">${r.Product}</span>
                    <div style="font-size:11px; color:#64748b; margin-top:4px;">
                        <span style="color:var(--success); font-weight:700;">â‚¹${r['Revenue (â‚¹)'].toFixed(0)}</span>
                        &nbsp;Â·&nbsp; ${r['Qty Sold']} units
                        &nbsp;Â·&nbsp; ${r.Orders} orders
                    </div>
                </div>`).join('');
        }

        function pwSortTable(key) {
            const keyMap = { rank:'_revenue', name:'Product', qty:'_qty', revenue:'_revenue', orders:'_orders' };
            const realKey = keyMap[key] || '_revenue';
            if (pwSortKey === realKey) pwSortDir *= -1; else { pwSortKey = realKey; pwSortDir = -1; }
            if (realKey === 'Product') {
                pwDataArray.sort((a,b) => pwSortDir * a.Product.localeCompare(b.Product));
            } else {
                pwDataArray.sort((a,b) => pwSortDir * (b[realKey] - a[realKey]));
            }
            pwRenderTable();
        }

        // ========= QUOTATION BUILDER =========
        let qtCurrentTheme = 'classic';
        let qtItemCount = 0;

        // Each theme has: headerBg (CSS background), headerColor, accentColor, grandColor,
        // accentLight, borderColor, badgeBg, badgeColor, headerSvg (optional SVG overlay)
        const QT_THEMES = {
            classic: {
                headerBg: 'linear-gradient(135deg, #eef2ff 0%, #c7d2fe 60%, #818cf8 100%)',
                headerColor: '#1e1b4b', accentColor: '#4f46e5', accentLight: 'rgba(79,70,229,0.06)',
                borderColor: '#c7d2fe', badgeBg: '#eef2ff', badgeColor: '#3730a3',
                grandColor: '#3730a3', tableHead: '#eef2ff', tableHeadColor: '#1e1b4b', headerSvg: ''
            },
            royal: {
                headerBg: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 60%, #533483 100%)',
                headerColor: '#f5e6a3', accentColor: '#e2c97e', accentLight: 'rgba(226,201,126,0.07)',
                borderColor: '#3d3167', badgeBg: '#2d2250', badgeColor: '#e2c97e',
                grandColor: '#533483', tableHead: '#1a1a2e', tableHeadColor: '#e2c97e',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;opacity:0.12;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 60,0 0,60" fill="#e2c97e"/><polygon points="100%,100% 100%,60% 60%,100%" fill="#e2c97e"/></svg>`
            },
            emerald: {
                headerBg: 'linear-gradient(135deg, #064e3b 0%, #059669 70%, #34d399 100%)',
                headerColor: '#ffffff', accentColor: '#10b981', accentLight: 'rgba(16,185,129,0.07)',
                borderColor: '#a7f3d0', badgeBg: '#ecfdf5', badgeColor: '#065f46',
                grandColor: '#065f46', tableHead: '#ecfdf5', tableHeadColor: '#065f46',
                headerSvg: `<svg style="position:absolute;bottom:0;left:0;width:100%;height:40px;opacity:0.2;pointer-events:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 40" preserveAspectRatio="none"><path d="M0,30 Q50,10 100,25 Q150,40 200,15 L200,40 L0,40Z" fill="white"/></svg>`
            },
            crimson: {
                headerBg: 'linear-gradient(135deg, #7f1d1d 0%, #dc2626 70%, #f87171 100%)',
                headerColor: '#fff1f2', accentColor: '#ef4444', accentLight: 'rgba(239,68,68,0.06)',
                borderColor: '#fecaca', badgeBg: '#fff1f2', badgeColor: '#991b1b',
                grandColor: '#991b1b', tableHead: '#fff1f2', tableHeadColor: '#7f1d1d',
                headerSvg: `<svg style="position:absolute;top:0;right:0;width:80px;height:80px;opacity:0.15;pointer-events:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80"><circle cx="80" cy="0" r="60" fill="white"/></svg>`
            },
            ocean: {
                headerBg: 'linear-gradient(135deg, #0c4a6e 0%, #0284c7 60%, #38bdf8 100%)',
                headerColor: '#ffffff', accentColor: '#0ea5e9', accentLight: 'rgba(14,165,233,0.07)',
                borderColor: '#bae6fd', badgeBg: '#f0f9ff', badgeColor: '#0369a1',
                grandColor: '#0369a1', tableHead: '#f0f9ff', tableHeadColor: '#0c4a6e',
                headerSvg: `<svg style="position:absolute;bottom:0;left:0;width:100%;height:35px;pointer-events:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 35" preserveAspectRatio="none"><path d="M0,20 Q40,5 80,18 Q120,30 160,15 Q180,8 200,20 L200,35 L0,35Z" fill="rgba(255,255,255,0.15)"/><path d="M0,28 Q50,18 100,25 Q150,32 200,22 L200,35 L0,35Z" fill="rgba(255,255,255,0.1)"/></svg>`
            },
            sunset: {
                headerBg: 'linear-gradient(135deg, #7c2d12 0%, #ea580c 50%, #fbbf24 100%)',
                headerColor: '#fff7ed', accentColor: '#f97316', accentLight: 'rgba(249,115,22,0.07)',
                borderColor: '#fed7aa', badgeBg: '#fff7ed', badgeColor: '#c2410c',
                grandColor: '#c2410c', tableHead: '#fff7ed', tableHeadColor: '#7c2d12',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;opacity:0.12;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><circle cx="0" cy="100%" r="90" fill="white"/><circle cx="100%" cy="0" r="70" fill="white"/></svg>`
            },
            violet: {
                headerBg: 'linear-gradient(135deg, #2e1065 0%, #7c3aed 60%, #c4b5fd 100%)',
                headerColor: '#faf5ff', accentColor: '#7c3aed', accentLight: 'rgba(124,58,237,0.07)',
                borderColor: '#ddd6fe', badgeBg: '#f5f3ff', badgeColor: '#6d28d9',
                grandColor: '#6d28d9', tableHead: '#f5f3ff', tableHeadColor: '#4c1d95',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;opacity:0.1;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><polygon points="100%,0 100%,100% 40%,0" fill="white"/></svg>`
            },
            gold: {
                headerBg: 'linear-gradient(135deg, #78350f 0%, #d97706 60%, #fcd34d 100%)',
                headerColor: '#fffbeb', accentColor: '#d97706', accentLight: 'rgba(217,119,6,0.07)',
                borderColor: '#fde68a', badgeBg: '#fffbeb', badgeColor: '#b45309',
                grandColor: '#b45309', tableHead: '#fffbeb', tableHeadColor: '#78350f',
                headerSvg: `<svg style="position:absolute;bottom:0;right:0;width:70px;height:70px;opacity:0.18;pointer-events:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70"><polygon points="70,0 70,70 0,70" fill="white"/></svg>`
            },
            // Abstract themes
            neon: {
                headerBg: 'radial-gradient(ellipse at 20% 50%, #3b0764 0%, #0f0f23 50%, #0a1628 100%)',
                headerColor: '#e0f2fe', accentColor: '#22d3ee', accentLight: 'rgba(34,211,238,0.07)',
                borderColor: '#0e7490', badgeBg: '#0a1628', badgeColor: '#22d3ee',
                grandColor: '#7c3aed', tableHead: '#0f0f23', tableHeadColor: '#22d3ee',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><circle cx="25%" cy="60%" r="50" fill="rgba(139,92,246,0.3)" filter="url(#b1)"/><circle cx="75%" cy="40%" r="40" fill="rgba(34,211,238,0.25)" filter="url(#b1)"/><defs><filter id="b1"><feGaussianBlur stdDeviation="15"/></filter></defs></svg>`
            },
            aurora: {
                headerBg: 'linear-gradient(160deg, #0d1b2a 0%, #1b4332 40%, #065f46 70%, #0c4a6e 100%)',
                headerColor: '#ecfdf5', accentColor: '#34d399', accentLight: 'rgba(52,211,153,0.07)',
                borderColor: '#6ee7b7', badgeBg: '#0d1b2a', badgeColor: '#34d399',
                grandColor: '#059669', tableHead: '#0d1b2a', tableHeadColor: '#34d399',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><path d="M0,40 Q50,15 100%,35 L100%,0 L0,0Z" fill="rgba(52,211,153,0.12)"/><path d="M0,60 Q60,30 100%,55 L100%,0 L0,0Z" fill="rgba(34,211,238,0.08)"/></svg>`
            },
            mesh: {
                headerBg: 'linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%)',
                headerColor: '#1e1b4b', accentColor: '#4f46e5', accentLight: 'rgba(79,70,229,0.06)',
                borderColor: '#c7d2fe', badgeBg: '#eef2ff', badgeColor: '#3730a3',
                grandColor: '#3730a3', tableHead: '#eef2ff', tableHeadColor: '#1e1b4b',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="dotpat" width="14" height="14" patternUnits="userSpaceOnUse"><circle cx="7" cy="7" r="1.5" fill="rgba(79,70,229,0.18)"/></pattern></defs><rect width="100%" height="100%" fill="url(#dotpat)"/><circle cx="30%" cy="50%" r="60" fill="rgba(99,102,241,0.1)"/><circle cx="80%" cy="30%" r="45" fill="rgba(139,92,246,0.08)"/></svg>`
            },
            geometric: {
                headerBg: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)',
                headerColor: '#f1f5f9', accentColor: '#6366f1', accentLight: 'rgba(99,102,241,0.07)',
                borderColor: '#475569', badgeBg: '#1e293b', badgeColor: '#818cf8',
                grandColor: '#4f46e5', tableHead: '#f8fafc', tableHeadColor: '#1e293b',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:0.5;" xmlns="http://www.w3.org/2000/svg"><polygon points="0,0 80,0 0,80" fill="rgba(99,102,241,0.35)"/><polygon points="100%,100% 100%,40% 40%,100%" fill="rgba(139,92,246,0.25)"/><polygon points="50%,0 100%,0 100%,50%" fill="rgba(79,70,229,0.15)"/><line x1="0" y1="0" x2="100%" y2="100%" stroke="rgba(148,163,184,0.15)" stroke-width="1"/><line x1="100%" y1="0" x2="0" y2="100%" stroke="rgba(148,163,184,0.1)" stroke-width="1"/></svg>`
            },
            waves: {
                headerBg: 'linear-gradient(180deg, #0369a1 0%, #0284c7 60%, #38bdf8 100%)',
                headerColor: '#ffffff', accentColor: '#0ea5e9', accentLight: 'rgba(14,165,233,0.07)',
                borderColor: '#7dd3fc', badgeBg: '#f0f9ff', badgeColor: '#0369a1',
                grandColor: '#0369a1', tableHead: '#f0f9ff', tableHeadColor: '#0c4a6e',
                headerSvg: `<svg style="position:absolute;bottom:0;left:0;width:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 45" preserveAspectRatio="none"><path d="M0,20 C40,35 80,5 120,20 C160,35 200,5 240,20 C270,30 285,18 300,22 L300,45 L0,45Z" fill="rgba(255,255,255,0.2)"/><path d="M0,30 C50,20 100,38 150,28 C200,18 250,36 300,26 L300,45 L0,45Z" fill="rgba(255,255,255,0.12)"/></svg>`
            },
            circuit: {
                headerBg: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
                headerColor: '#86efac', accentColor: '#22c55e', accentLight: 'rgba(34,197,94,0.07)',
                borderColor: '#166534', badgeBg: '#0f172a', badgeColor: '#4ade80',
                grandColor: '#16a34a', tableHead: '#0f172a', tableHeadColor: '#86efac',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="25%" x2="55%" y2="25%" stroke="rgba(34,197,94,0.4)" stroke-width="1.5"/><line x1="55%" y1="25%" x2="55%" y2="75%" stroke="rgba(34,197,94,0.4)" stroke-width="1.5"/><line x1="55%" y1="75%" x2="100%" y2="75%" stroke="rgba(34,197,94,0.4)" stroke-width="1.5"/><circle cx="55%" cy="25%" r="4" fill="rgba(34,197,94,0.7)"/><circle cx="55%" cy="75%" r="4" fill="rgba(34,197,94,0.7)"/><line x1="20%" y1="0" x2="20%" y2="55%" stroke="rgba(34,211,238,0.3)" stroke-width="1"/><circle cx="20%" cy="55%" r="3" fill="rgba(34,211,238,0.6)"/><line x1="80%" y1="100%" x2="80%" y2="45%" stroke="rgba(34,211,238,0.3)" stroke-width="1"/><circle cx="80%" cy="45%" r="3" fill="rgba(34,211,238,0.6)"/></svg>`
            },
            marble: {
                headerBg: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%)',
                headerColor: '#1e293b', accentColor: '#475569', accentLight: 'rgba(71,85,105,0.05)',
                borderColor: '#cbd5e1', badgeBg: '#f1f5f9', badgeColor: '#475569',
                grandColor: '#334155', tableHead: '#f8fafc', tableHeadColor: '#1e293b',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><path d="M0,30 Q30,10 60,28 Q90,45 130,22 Q160,8 200,25 L200,0 L0,0Z" fill="rgba(148,163,184,0.15)"/><path d="M0,55 Q40,35 80,50 Q120,65 160,42 Q180,33 200,48 L200,0 L0,0Z" fill="rgba(203,213,225,0.2)"/><path d="M0,70 Q50,50 100,65 Q140,75 200,60 L200,0 L0,0Z" fill="rgba(226,232,240,0.15)"/></svg>`
            },
            sakura: {
                headerBg: 'linear-gradient(135deg, #fdf2f8 0%, #fbcfe8 60%, #f9a8d4 100%)',
                headerColor: '#831843', accentColor: '#ec4899', accentLight: 'rgba(236,72,153,0.06)',
                borderColor: '#f9a8d4', badgeBg: '#fdf2f8', badgeColor: '#be185d',
                grandColor: '#be185d', tableHead: '#fdf2f8', tableHeadColor: '#831843',
                headerSvg: `<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;" xmlns="http://www.w3.org/2000/svg"><circle cx="12%" cy="55%" r="22" fill="rgba(244,114,182,0.2)"/><circle cx="35%" cy="20%" r="16" fill="rgba(236,72,153,0.15)"/><circle cx="62%" cy="65%" r="28" fill="rgba(244,114,182,0.15)"/><circle cx="85%" cy="30%" r="18" fill="rgba(249,168,212,0.25)"/><circle cx="50%" cy="45%" r="12" fill="rgba(251,207,232,0.3)"/></svg>`
            }
        };

        function selectQtTheme(el, theme) {
            document.querySelectorAll('.qt-theme-btn').forEach(b => {
                b.classList.remove('active-theme');
                b.style.border = '2px solid var(--border)';
                b.style.boxShadow = 'none';
            });
            el.classList.add('active-theme');
            el.style.border = '2.5px solid #4f46e5';
            el.style.boxShadow = '0 0 0 2px rgba(79,70,229,0.2)';
            qtCurrentTheme = theme;
            renderQuotation();
        }

        function addQtItem() {
            const id = 'qt-item-' + (++qtItemCount);
            const dlId = id + '-dl';
            const container = document.getElementById('qtItemsList');
            const row = document.createElement('div');
            row.className = 'qt-item-row';
            row.id = id;
            row.innerHTML = `
                <input class="input-field qt-item-name" list="${dlId}" placeholder="Product name" oninput="qtItemNameInput(this)" onchange="qtItemNameSelect(this)">
                <datalist id="${dlId}">${Object.keys(productsMap).map(p => `<option value="${p}">`).join('')}</datalist>
                <input class="input-field qt-item-qty" type="number" min="1" value="1" placeholder="Qty" oninput="renderQuotation()">
                <input class="input-field qt-item-rate" type="number" min="0" value="" placeholder="Rate â‚¹" oninput="renderQuotation()">
                <button class="qt-item-del" onclick="removeQtItem('${id}')">âœ•</button>`;
            container.appendChild(row);
            renderQuotation();
        }

        // Auto-fill rate when a known product is selected
        function qtItemNameInput(el) {
            renderQuotation();
        }
        function qtItemNameSelect(el) {
            const name = el.value.trim();
            if (productsMap[name]) {
                const row = el.closest('.qt-item-row');
                if (row) {
                    const rateInput = row.querySelector('.qt-item-rate');
                    if (rateInput && (!rateInput.value || rateInput.value == '0')) {
                        rateInput.value = productsMap[name].price || '';
                    }
                }
            }
            renderQuotation();
        }

        function removeQtItem(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
            renderQuotation();
        }

        function getQtItems() {
            const rows = document.querySelectorAll('#qtItemsList .qt-item-row');
            const items = [];
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const qty  = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                if (name) items.push({ name, qty, rate, total: qty * rate });
            });
            return items;
        }

        function renderQuotation() {
            const clientName = document.getElementById('qt-clientName').value || 'Client Name';
            const quotNo     = document.getElementById('qt-quotNo').value || ('QT-' + Date.now().toString().slice(-6));
            const validDate  = document.getElementById('qt-validDate').value;
            const salesman   = document.getElementById('qt-salesman').value || (typeof userData !== 'undefined' && userData ? userData.name : '');
            const note       = document.getElementById('qt-note').value;
            const discPct    = parseFloat(document.getElementById('qt-discount').value) || 0;
            const taxPct     = parseFloat(document.getElementById('qt-tax').value) || 0;
            const items      = getQtItems();
            const t          = QT_THEMES[qtCurrentTheme] || QT_THEMES.classic;
            const companyName = (document.getElementById('qt-companyName') && document.getElementById('qt-companyName').value.trim())
                ? document.getElementById('qt-companyName').value.trim()
                : ((typeof appSettings !== 'undefined' && appSettings && appSettings.companyName) ? appSettings.companyName : ((typeof brandSettings !== 'undefined' && brandSettings && brandSettings.name) ? brandSettings.name : 'Order With Me'));

            let subTotal = items.reduce((s, i) => s + i.total, 0);
            const discAmt   = subTotal * (discPct / 100);
            const afterDisc = subTotal - discAmt;
            const taxAmt    = afterDisc * (taxPct / 100);
            const grandTotal = afterDisc + taxAmt;

            const today    = new Date().toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
            const validStr = validDate ? new Date(validDate).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : '--';

            // Items rows â€” all inline styles so html2canvas captures correctly
            let itemRows = '';
            if (!items.length) {
                itemRows = `<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:20px;font-size:12px;">No items added yet</td></tr>`;
            } else {
                items.forEach((item, sl) => {
                    const evenBg = (sl % 2 === 1) ? 'background:#f8faff;' : 'background:#ffffff;';
                    itemRows += `<tr>
                        <td style="${evenBg}text-align:center;color:#94a3b8;font-size:10px;width:28px;padding:9px 6px;border:1px solid #e2e8f0;">${sl+1}</td>
                        <td style="${evenBg}font-weight:700;font-size:12px;color:#1a1a2e;padding:9px 10px;border:1px solid #e2e8f0;">${item.name}</td>
                        <td style="${evenBg}text-align:right;white-space:nowrap;color:#1a1a2e;padding:9px 10px;border:1px solid #e2e8f0;">${item.rate.toFixed(2)}</td>
                        <td style="${evenBg}text-align:center;font-weight:700;color:#1a1a2e;padding:9px 10px;border:1px solid #e2e8f0;">${item.qty}</td>
                        <td style="${evenBg}text-align:right;font-weight:800;color:#1a1a2e;white-space:nowrap;padding:9px 10px;border:1px solid #e2e8f0;">${item.total.toFixed(2)}</td>
                    </tr>`;
                });
            }

            let extraRows = '';
            if (discPct > 0) extraRows += `<div style="display:flex;justify-content:flex-end;gap:16px;padding:2px 0;font-size:11px;"><span style="color:#64748b;">Discount (${discPct}%)</span><span style="font-weight:700;color:#ef4444;min-width:90px;text-align:right;">- â‚¹${discAmt.toFixed(2)}</span></div>`;
            if (taxPct  > 0) extraRows += `<div style="display:flex;justify-content:flex-end;gap:16px;padding:2px 0;font-size:11px;"><span style="color:#64748b;">Tax / GST (${taxPct}%)</span><span style="font-weight:700;color:#047857;min-width:90px;text-align:right;">+ â‚¹${taxAmt.toFixed(2)}</span></div>`;

            const noteHtml = note
                ? `<div style="margin:0;padding:10px 20px;background:${t.accentLight};border-top:1px dashed ${t.borderColor};font-size:10px;color:#475569;line-height:1.7;font-family:Arial,sans-serif;"><strong style="color:${t.accentColor};">ðŸ“ Terms & Notes:</strong><br>${note.replace(/\n/g,'<br>')}</div>`
                : '';

            const validBadge = validDate
                ? `<span style="display:inline-block;padding:2px 9px;border-radius:20px;font-size:8.5px;font-weight:800;letter-spacing:0.8px;text-transform:uppercase;background:${t.badgeBg};color:${t.badgeColor};margin-top:4px;">Valid till ${validStr}</span>`
                : '';

            // Full document as inline-styled HTML for reliable PDF/print rendering
            const html = `
            <div id="qt-doc-inner" style="max-width:560px;margin:0 auto;font-family:Arial,sans-serif;border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.14);border:1px solid ${t.borderColor};background:#ffffff;">

                <!-- HEADER with abstract SVG overlay -->
                <div style="background:${t.headerBg};color:${t.headerColor};padding:10px 18px 9px;position:relative;overflow:hidden;">
                    ${t.headerSvg || ''}
                    <div style="position:relative;z-index:1;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-size:16px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:${t.headerColor};margin:0 0 1px;">${companyName}</div>
                            <div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;opacity:0.7;color:${t.headerColor};">PRICE QUOTATION</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:13px;font-weight:900;letter-spacing:1px;color:${t.accentColor};background:rgba(255,255,255,0.18);padding:2px 8px;border-radius:8px;">${quotNo}</div>
                            <div style="font-size:8.5px;opacity:0.75;margin-top:3px;color:${t.headerColor};">${today}</div>
                            <div style="margin-top:3px;">${validBadge}</div>
                        </div>
                    </div>
                </div>

                <!-- INFO STRIP -->
                <div style="display:flex;justify-content:space-between;padding:7px 16px;background:#f8faff;border-bottom:1px solid #e2e8f0;font-size:10.5px;gap:10px;">
                    <div>
                        <div style="font-size:8px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">Prepared For</div>
                        <div style="font-size:12px;font-weight:800;color:#1a1a2e;">${clientName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:9.5px;color:#64748b;">Sales Rep: <strong style="color:#1a1a2e;">${salesman}</strong></div>
                        <div style="font-size:9.5px;color:#64748b;margin-top:1px;">Date: <strong style="color:#1a1a2e;">${today}</strong></div>
                    </div>
                </div>

                <!-- ITEMS TABLE â€” all inline -->
                <table style="width:100%;border-collapse:collapse;font-size:11px;margin:0;">
                    <thead>
                        <tr style="background:${t.tableHead};">
                            <th style="padding:7px 6px;font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;border:1px solid #cbd5e1;color:${t.tableHeadColor};width:28px;text-align:center;">Sl</th>
                            <th style="padding:7px 9px;font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;border:1px solid #cbd5e1;color:${t.tableHeadColor};text-align:left;">Description</th>
                            <th style="padding:7px 9px;font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;border:1px solid #cbd5e1;color:${t.tableHeadColor};text-align:right;">Rate (â‚¹)</th>
                            <th style="padding:7px 9px;font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;border:1px solid #cbd5e1;color:${t.tableHeadColor};text-align:center;">Qty</th>
                            <th style="padding:7px 9px;font-size:8.5px;font-weight:800;text-transform:uppercase;letter-spacing:0.8px;border:1px solid #cbd5e1;color:${t.tableHeadColor};text-align:right;">Amount (â‚¹)</th>
                        </tr>
                    </thead>
                    <tbody>${itemRows}</tbody>
                </table>

                <!-- TOTALS -->
                <div style="padding:8px 14px 10px;border-top:2px solid #1a1a2e;background:#fff;">
                    <div style="display:flex;justify-content:flex-end;gap:16px;padding:2px 0;font-size:11px;">
                        <span style="color:#64748b;">Sub Total</span>
                        <span style="font-weight:700;color:#1a1a2e;min-width:90px;text-align:right;">â‚¹${subTotal.toFixed(2)}</span>
                    </div>
                    ${extraRows}
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding-top:6px;border-top:1.5px dashed #c7d2e0;">
                        <span style="font-size:12px;font-weight:800;color:#1a1a2e;text-transform:uppercase;letter-spacing:0.5px;">Grand Total</span>
                        <span style="font-size:18px;font-weight:900;color:${t.grandColor};">â‚¹ ${grandTotal.toFixed(2)}</span>
                    </div>
                </div>

                ${noteHtml}

                <!-- SIGNATURE ROW -->
                <div style="display:flex;justify-content:space-between;padding:10px 16px 8px;font-size:9.5px;color:#64748b;">
                    <div style="text-align:center;min-width:90px;">
                        <div style="border-top:1px solid #c7d2e0;padding-top:3px;margin-top:22px;">Client Signature</div>
                    </div>
                    <div style="text-align:center;min-width:90px;">
                        <div style="border-top:1px solid #c7d2e0;padding-top:3px;margin-top:22px;">Authorised Signatory</div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div style="background:${t.accentLight || '#f8faff'};border-top:1px solid ${t.borderColor};padding:7px 16px;text-align:center;font-size:9px;color:#94a3b8;letter-spacing:0.3px;">
                    <div style="font-size:10px;font-weight:700;color:${t.grandColor};margin-bottom:2px;letter-spacing:1px;">âœ¦ THANK YOU FOR YOUR ENQUIRY âœ¦</div>
                    <div>This is a computer generated quotation. Subject to final confirmation.</div>
                    <div style="margin-top:1px;color:${t.accentColor};font-weight:700;font-size:8.5px;">Powered by Order With Me ERP</div>
                </div>
            </div>`;

            document.getElementById('qt-print-zone').innerHTML = html;
            document.getElementById('qt-preview-section').style.display = 'block';
        }

        function printQuotation() {
            renderQuotation();
            const styleEl = document.getElementById('print-page-style') || (() => { const s = document.createElement('style'); s.id='print-page-style'; document.head.appendChild(s); return s; })();
            styleEl.textContent = `@page { size: A5; margin: 6mm; } @media print { body > *:not(#qt-print-zone) { display:none !important; } #qt-print-zone { display:block !important; } }`;
            setTimeout(() => window.print(), 150);
        }

        function downloadQtPDF() {
            renderQuotation();
            const zone = document.getElementById('qt-doc-inner');
            if (!zone) { if(typeof toast!=='undefined') toast('Please preview first!','error'); return; }
            if(typeof toast!=='undefined') toast('â³ Generating PDF...');

            // Temporarily remove box shadow & border-radius for cleaner PDF capture
            const origShadow = zone.style.boxShadow;
            const origRadius = zone.style.borderRadius;
            zone.style.boxShadow = 'none';
            zone.style.borderRadius = '0';

            const quotNo = document.getElementById('qt-quotNo').value || 'Quotation';

            html2pdf().set({
                margin: 0,
                filename: 'Quotation_' + quotNo + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2.5,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    letterRendering: true,
                    allowTaint: true,
                    scrollX: 0, scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' },
                pagebreak: { mode: 'avoid-all' }
            }).from(zone).save().then(() => {
                zone.style.boxShadow = origShadow;
                zone.style.borderRadius = origRadius;
                if(typeof toast!=='undefined') toast('âœ… Quotation PDF saved!','success');
            }).catch(() => {
                zone.style.boxShadow = origShadow;
                zone.style.borderRadius = origRadius;
                if(typeof toast!=='undefined') toast('âŒ PDF failed. Try again.','error');
            });
        }


        // ========= GMAIL SEND QUOTATION =========
        function sendQuotationViaGmail() {
            renderQuotation();
            const zone = document.getElementById('qt-doc-inner');
            if (!zone) { toast('Please Preview the quotation first!', 'error'); return; }

            const clientName = document.getElementById('qt-clientName').value.trim() || 'Client';
            const quotNo     = document.getElementById('qt-quotNo').value.trim()     || 'Quotation';
            const companyName= (document.getElementById('qt-companyName')?.value.trim()) ||
                               (typeof brandSettings !== 'undefined' && brandSettings.name) || 'Order With Me';
            const validDate  = document.getElementById('qt-validDate').value;
            const salesman   = document.getElementById('qt-salesman').value.trim()   || '';
            const items      = getQtItems();
            const grandTotalEl = zone.querySelector('[style*="font-size:20px"]');

            // Build subject
            const subject = encodeURIComponent(`Price Quotation ${quotNo} from ${companyName} â€” ${clientName}`);

            // Build body text
            let itemLines = items.map((it, i) =>
                `  ${i+1}. ${it.name} â€” Qty: ${it.qty} Ã— â‚¹${it.rate} = â‚¹${it.total.toFixed(2)}`
            ).join('\n');

            const discPct = parseFloat(document.getElementById('qt-discount').value) || 0;
            const taxPct  = parseFloat(document.getElementById('qt-tax').value) || 0;
            const subTotal = items.reduce((s,i) => s + i.total, 0);
            const discAmt  = subTotal * (discPct / 100);
            const taxAmt   = (subTotal - discAmt) * (taxPct / 100);
            const grand    = subTotal - discAmt + taxAmt;

            const validStr = validDate ? new Date(validDate).toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) : '';

            const body = encodeURIComponent(
`Dear ${clientName},

Please find below the price quotation (${quotNo}) from ${companyName}.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“‹ PRICE QUOTATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Quotation No : ${quotNo}
Date         : ${new Date().toLocaleDateString('en-IN')}
${validStr ? `Valid Until  : ${validStr}` : ''}
Sales Rep    : ${salesman}

ITEMS:
${itemLines}

Sub Total    : â‚¹${subTotal.toFixed(2)}${discPct > 0 ? `\nDiscount (${discPct}%) : -â‚¹${discAmt.toFixed(2)}` : ''}${taxPct > 0 ? `\nGST/Tax (${taxPct}%)  : +â‚¹${taxAmt.toFixed(2)}` : ''}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
GRAND TOTAL  : â‚¹${grand.toFixed(2)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“Ž Please find the detailed PDF quotation attached.
Kindly confirm your acceptance at the earliest.

Thank you for your enquiry!

Best regards,
${salesman || companyName}
${companyName}

Powered by Order With Me ERP`);

            // Open Gmail compose with pre-filled subject & body
            // Note: Gmail mailto link â€” user must manually attach the PDF
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`;

            // First generate + download the PDF, then open Gmail
            toast('â³ Generating PDF â€” then Gmail will open...', 'success');

            const origShadow = zone.style.boxShadow;
            const origRadius = zone.style.borderRadius;
            zone.style.boxShadow = 'none';
            zone.style.borderRadius = '0';

            html2pdf().set({
                margin: 0,
                filename: `Quotation_${quotNo}_${clientName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2.5, useCORS: true, backgroundColor: '#ffffff', logging: false, scrollX: 0, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' },
                pagebreak: { mode: 'avoid-all' }
            }).from(zone).save().then(() => {
                zone.style.boxShadow = origShadow;
                zone.style.borderRadius = origRadius;
                toast('âœ… PDF saved! Opening Gmail compose...', 'success');
                setTimeout(() => {
                    window.open(gmailUrl, '_blank');
                    // Show instruction toast
                    setTimeout(() => toast('ðŸ“Ž Please attach the downloaded PDF in Gmail', 'success'), 1200);
                }, 600);
            }).catch(() => {
                zone.style.boxShadow = origShadow;
                zone.style.borderRadius = origRadius;
                // Still open Gmail even if PDF fails
                window.open(gmailUrl, '_blank');
                toast('âš ï¸ PDF failed â€” Gmail opened anyway', 'error');
            });
        }

        // ========= QUOTATION TRACKER =========
        const QT_TRACKER_KEY = 'owm_qt_tracker_' + (typeof userData !== 'undefined' && userData?.user ? userData.user : 'default');
        let qtTrackerFilter = 'all';

        function getQtTrackerData() {
            try { return JSON.parse(localStorage.getItem('owm_qt_tracker') || '[]'); } catch(e) { return []; }
        }
        function saveQtTrackerData(arr) {
            localStorage.setItem('owm_qt_tracker', JSON.stringify(arr));
        }

        function saveCurrentQuotationToTracker() {
            renderQuotation();
            const clientName  = document.getElementById('qt-clientName').value.trim();
            const quotNo      = document.getElementById('qt-quotNo').value.trim() || ('QT-' + Date.now().toString().slice(-6));
            const companyName = document.getElementById('qt-companyName')?.value.trim() || (typeof brandSettings !== 'undefined' && brandSettings.name) || 'Order With Me';
            const salesman    = document.getElementById('qt-salesman').value.trim();
            const validDate   = document.getElementById('qt-validDate').value;
            const items       = getQtItems();
            const discPct     = parseFloat(document.getElementById('qt-discount').value) || 0;
            const taxPct      = parseFloat(document.getElementById('qt-tax').value) || 0;
            const subTotal    = items.reduce((s, i) => s + i.total, 0);
            const discAmt     = subTotal * (discPct / 100);
            const taxAmt      = (subTotal - discAmt) * (taxPct / 100);
            const grand       = subTotal - discAmt + taxAmt;

            if (!clientName) { toast('Please enter client name first!', 'error'); return; }
            if (!items.length) { toast('Please add at least one item!', 'error'); return; }

            const arr = getQtTrackerData();

            // Check duplicate quotNo
            const dupIdx = arr.findIndex(q => q.quotNo === quotNo);
            if (dupIdx !== -1) {
                if (!confirm(`Quotation "${quotNo}" already exists. Update it?`)) return;
                arr[dupIdx] = { ...arr[dupIdx], clientName, companyName, salesman, validDate, items, grand, discPct, taxPct, updatedAt: Date.now() };
                saveQtTrackerData(arr);
                toast('âœ… Quotation updated in tracker!', 'success');
            } else {
                arr.unshift({
                    id: Date.now(),
                    quotNo, clientName, companyName, salesman, validDate,
                    items, grand, discPct, taxPct,
                    status: 'pending',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });
                saveQtTrackerData(arr);
                toast('âœ… Quotation saved to tracker!', 'success');
            }

            renderQtTrackerList();
            updateQtPendingBadge();
        }

        function updateQtStatus(id, newStatus) {
            const arr = getQtTrackerData();
            const idx = arr.findIndex(q => q.id === id);
            if (idx !== -1) {
                arr[idx].status = newStatus;
                arr[idx].updatedAt = Date.now();
                saveQtTrackerData(arr);
            }
            renderQtTrackerList();
            updateQtPendingBadge();
            toast(`Status updated to "${newStatus}"`, 'success');
        }

        function deleteQtEntry(id) {
            const arr = getQtTrackerData();
            const entry = arr.find(q => q.id === id);
            if (!entry) return;
            const newArr = arr.filter(q => q.id !== id);
            saveQtTrackerData(newArr);
            renderQtTrackerList();
            updateQtPendingBadge();
            toast('ðŸ—‘ï¸ Quotation removed from tracker', 'success');
            pushUndo(`Quotation "${entry.quotNo}" deleted`, () => {
                const cur = getQtTrackerData();
                cur.unshift(entry);
                saveQtTrackerData(cur);
                renderQtTrackerList();
                updateQtPendingBadge();
            });
        }

        function updateQtPendingBadge() {
            const arr = getQtTrackerData();
            const pending = arr.filter(q => q.status === 'pending').length;
            const badge = document.getElementById('qt-pending-badge');
            if (badge) {
                badge.textContent = pending;
                badge.style.display = pending > 0 ? 'block' : 'none';
            }
        }

        function filterQtTracker(filter) {
            qtTrackerFilter = filter;
            // Update tab styles
            ['all','pending','sent','accepted'].forEach(f => {
                const btn = document.getElementById('qt-tab-' + f);
                if (btn) {
                    if (f === filter) {
                        const colors = { all: 'var(--primary)', pending: '#f59e0b', sent: '#10b981', accepted: '#6366f1' };
                        btn.style.background = colors[f];
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'transparent';
                        const textColors = { all: 'var(--text)', pending: '#f59e0b', sent: '#10b981', accepted: '#6366f1' };
                        btn.style.color = textColors[f];
                    }
                }
            });
            renderQtTrackerList();
        }

        function renderQtTrackerList() {
            const arr = getQtTrackerData();
            const filtered = qtTrackerFilter === 'all' ? arr : arr.filter(q => q.status === qtTrackerFilter);

            // Update stats
            document.getElementById('qt-stat-total').textContent   = arr.length;
            document.getElementById('qt-stat-pending').textContent = arr.filter(q => q.status === 'pending').length;
            document.getElementById('qt-stat-sent').textContent    = arr.filter(q => q.status === 'sent' || q.status === 'accepted').length;

            const listEl = document.getElementById('qt-tracker-list');
            if (!filtered.length) {
                listEl.innerHTML = `<div style="text-align:center; color:#94a3b8; font-size:13px; padding:24px;">No ${qtTrackerFilter === 'all' ? '' : qtTrackerFilter + ' '}quotations found.</div>`;
                return;
            }

            const statusLabels = { pending: 'ðŸ• Pending', sent: 'âœ… Sent', accepted: 'ðŸŽ‰ Accepted', rejected: 'âŒ Rejected' };
            const statusNext   = { pending: ['sent','accepted','rejected'], sent: ['accepted','rejected'], accepted: ['rejected'], rejected: ['pending'] };

            listEl.innerHTML = filtered.map(q => {
                const date = new Date(q.createdAt).toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'});
                const validStr = q.validDate ? new Date(q.validDate).toLocaleDateString('en-IN', {day:'2-digit', month:'short'}) : '';
                const isExpired = q.validDate && new Date(q.validDate) < new Date() && q.status === 'pending';

                const nextBtns = (statusNext[q.status] || []).map(ns => {
                    const btnColors = { sent:'#10b981', accepted:'#6366f1', rejected:'#ef4444', pending:'#f59e0b' };
                    return `<button onclick="updateQtStatus(${q.id},'${ns}')" style="border:none; border-radius:8px; padding:5px 10px; font-size:10px; font-weight:700; cursor:pointer; background:${btnColors[ns]}20; color:${btnColors[ns]}; font-family:'Poppins',sans-serif; transition:background 0.2s;" onmouseover="this.style.background='${btnColors[ns]}35'" onmouseout="this.style.background='${btnColors[ns]}20'">â†’ ${ns.charAt(0).toUpperCase()+ns.slice(1)}</button>`;
                }).join('');

                return `<div class="qt-tracker-item" style="${isExpired ? 'border-color:rgba(244,63,94,0.4);' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:8px;">
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:800; font-size:14px; color:var(--text);">${q.quotNo}</div>
                            <div style="font-size:12px; color:#64748b; margin-top:2px;">ðŸª ${q.clientName} Â· ðŸ‘¤ ${q.salesman || 'â€”'}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                            <span class="qt-status-badge qt-status-${q.status}">${statusLabels[q.status] || q.status}</span>
                            ${isExpired ? `<span style="font-size:9px; color:#ef4444; font-weight:700;">âš ï¸ EXPIRED</span>` : ''}
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:6px;">
                        <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                            <span style="font-size:11px; color:#64748b;">ðŸ“… ${date}</span>
                            ${validStr ? `<span style="font-size:11px; color:#64748b;">Â· Valid: ${validStr}</span>` : ''}
                            <span style="font-size:12px; font-weight:800; color:var(--success);">â‚¹ ${q.grand.toFixed(2)}</span>
                        </div>
                        <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                            ${nextBtns}
                            <button onclick="deleteQtEntry(${q.id})" style="border:none; background:rgba(244,63,94,0.1); color:#ef4444; border-radius:8px; padding:5px 8px; font-size:12px; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='rgba(244,63,94,0.2)'" onmouseout="this.style.background='rgba(244,63,94,0.1)'">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openQtTracker() {
            const panel = document.getElementById('qt-tracker-panel');
            if (panel) {
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            filterQtTracker('all');
            updateQtPendingBadge();
        }

        function closeQtTracker() {
            const panel = document.getElementById('qt-tracker-panel');
            if (panel) panel.style.display = 'none';
        }

        // Initialize badge on load
        setTimeout(updateQtPendingBadge, 1000);


        // ============================================================
        //  NOTIFICATION ENGINE
        // ============================================================
        const NOTIF_KEY = 'owm_notifications_v2';
        let notifFilter = 'all';
        let _prevOrderCount = null;
        let _prevDeliveredSet = new Set();
        let _prevQtCount = null;

        /* ---- Storage helpers ---- */
        function getNotifs() {
            try { return JSON.parse(localStorage.getItem(NOTIF_KEY) || '[]'); } catch(e) { return []; }
        }
        function saveNotifs(arr) {
            // Keep max 120 notifications
            const trimmed = arr.slice(0, 120);
            localStorage.setItem(NOTIF_KEY, JSON.stringify(trimmed));
        }

        /* ---- Create a notification ---- */
        function addNotif({ type, title, body, icon, tag, autoRead = false }) {
            const notifs = getNotifs();
            const newN = {
                id: Date.now() + Math.random().toString(36).slice(2,6),
                type, title, body, icon, tag,
                time: Date.now(),
                read: autoRead
            };
            notifs.unshift(newN);
            saveNotifs(notifs);
            renderNotifList();
            updateNotifBadge();
            if (!autoRead) {
                showNotifToast(icon, title);
                shakeBell();
            }
        }

        /* ---- Bell shake animation ---- */
        function shakeBell() {
            const btn = document.getElementById('notifBellBtn');
            if (!btn) return;
            btn.classList.add('shake');
            btn.addEventListener('animationend', () => btn.classList.remove('shake'), { once: true });
        }

        /* ---- Mini toast ---- */
        let _toastTimer;
        function showNotifToast(icon, text) {
            const toast = document.getElementById('notifToast');
            const iconEl = document.getElementById('notifToastIcon');
            const textEl = document.getElementById('notifToastText');
            if (!toast) return;
            iconEl.textContent = icon;
            textEl.textContent = text;
            toast.classList.add('show');
            clearTimeout(_toastTimer);
            _toastTimer = setTimeout(() => toast.classList.remove('show'), 3500);
        }

        /* ---- Badge ---- */
        function updateNotifBadge() {
            const notifs = getNotifs();
            const unread = notifs.filter(n => !n.read).length;
            const badge = document.getElementById('notifBadge');
            const countEl = document.getElementById('notifPanelCount');
            if (!badge) return;
            if (unread > 0) {
                badge.textContent = unread > 99 ? '99+' : unread;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            if (countEl) countEl.textContent = notifs.length;
        }

        /* ---- Panel open/close ---- */
        function toggleNotifPanel() {
            const panel = document.getElementById('notifPanel');
            const backdrop = document.getElementById('notifBackdrop');
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                closeNotifPanel();
            } else {
                renderNotifList();
                panel.classList.add('open');
                backdrop.classList.add('open');
            }
        }
        function closeNotifPanel() {
            document.getElementById('notifPanel').classList.remove('open');
            document.getElementById('notifBackdrop').classList.remove('open');
        }

        /* ---- Filter ---- */
        function filterNotifs(f, el) {
            notifFilter = f;
            document.querySelectorAll('.notif-filter-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            renderNotifList();
        }

        /* ---- Mark all read ---- */
        function markAllNotifsRead() {
            const notifs = getNotifs().map(n => ({ ...n, read: true }));
            saveNotifs(notifs);
            renderNotifList();
            updateNotifBadge();
        }

        /* ---- Clear all ---- */
        function clearAllNotifs() {
            if (!confirm('Clear all notifications?')) return;
            saveNotifs([]);
            renderNotifList();
            updateNotifBadge();
        }

        /* ---- Mark single read on click ---- */
        function readNotif(id, targetView) {
            const notifs = getNotifs().map(n => n.id === id ? { ...n, read: true } : n);
            saveNotifs(notifs);
            renderNotifList();
            updateNotifBadge();
            if (targetView) {
                closeNotifPanel();
                setTimeout(() => {
                    if (typeof switchView === 'function') switchView(targetView);
                }, 250);
            }
        }

        /* ---- Time formatter ---- */
        function notifTimeStr(ts) {
            const diff = Date.now() - ts;
            const mins = Math.floor(diff / 60000);
            const hrs  = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (mins < 1)   return 'Just now';
            if (mins < 60)  return `${mins}m ago`;
            if (hrs < 24)   return `${hrs}h ago`;
            if (days === 1) return 'Yesterday';
            return new Date(ts).toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
        }

        /* ---- Date group label ---- */
        function notifDateGroup(ts) {
            const d = new Date(ts);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today - 86400000);
            const itemDay = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            if (itemDay.getTime() === today.getTime()) return 'Today';
            if (itemDay.getTime() === yesterday.getTime()) return 'Yesterday';
            return d.toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' });
        }

        /* ---- Render list ---- */
        function renderNotifList() {
            const listEl = document.getElementById('notifList');
            if (!listEl) return;
            let notifs = getNotifs();
            if (notifFilter !== 'all') {
                notifs = notifs.filter(n => n.type === notifFilter);
            }
            if (notifs.length === 0) {
                listEl.innerHTML = `
                    <div class="notif-empty">
                        <div class="notif-empty-icon">${notifFilter === 'all' ? 'ðŸ””' : notifFilter === 'delivery' ? 'ðŸšš' : notifFilter === 'payment' ? 'ðŸ’°' : notifFilter === 'quotation' ? 'ðŸ“‹' : notifFilter === 'stock' ? 'ðŸ“¦' : notifFilter === 'due' ? 'âš ï¸' : 'ðŸ“Œ'}</div>
                        <div class="notif-empty-text">No ${notifFilter === 'all' ? '' : notifFilter + ' '}notifications</div>
                        <div class="notif-empty-sub">Activity updates will appear here</div>
                    </div>`;
                return;
            }
            let html = '';
            let lastGroup = '';
            notifs.forEach(n => {
                const group = notifDateGroup(n.time);
                if (group !== lastGroup) {
                    html += `<div class="notif-date-label">${group}</div>`;
                    lastGroup = group;
                }
                const unreadClass = n.read ? '' : 'unread';
                const viewMap = { order:'history', delivery:'history', payment:'history', quotation:'quotation', stock:'stock', due:'history' };
                const target = viewMap[n.type] || '';
                html += `
                <div class="notif-item ${unreadClass}" onclick="readNotif('${n.id}','${target}')">
                    <div class="notif-icon-wrap ${n.type}">${n.icon}</div>
                    <div class="notif-content">
                        <div class="notif-title">${n.title}</div>
                        <div class="notif-body">${n.body}</div>
                        <div>
                            <span class="notif-tag tag-${n.type}">${n.tag}</span>
                            <span class="notif-time">${notifTimeStr(n.time)}</span>
                        </div>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html;
        }

        /* ----  WATCHERS: fire notifications based on live data changes ---- */

        /* Order watcher â€” called from inside onSnapshot */
        function notifWatchOrders(snapDocs) {
            if (_prevOrderCount === null) { _prevOrderCount = snapDocs.length; return; }
            if (snapDocs.length > _prevOrderCount) {
                const newest = snapDocs[0];
                if (newest) {
                    addNotif({
                        type: 'order', icon: 'ðŸ“¦',
                        tag: 'New Order',
                        title: `New order from ${newest.shopName || 'Unknown'}`,
                        body: `â‚¹${(newest.total||0).toFixed(2)} â€¢ ${newest.items ? newest.items.length : 0} item(s) â€¢ by ${newest.salesman || 'â€”'}`
                    });
                }
            }
            _prevOrderCount = snapDocs.length;
        }

        /* Delivery watcher */
        function notifWatchDelivery(snapDocs) {
            const deliveredNow = new Set(
                snapDocs.filter(d => d.deliveryStatus === 'delivered').map(d => d.orderId)
            );
            if (_prevDeliveredSet.size === 0 && deliveredNow.size > 0) {
                _prevDeliveredSet = deliveredNow; return;
            }
            deliveredNow.forEach(id => {
                if (!_prevDeliveredSet.has(id)) {
                    const doc = snapDocs.find(d => d.orderId === id);
                    if (doc) {
                        addNotif({
                            type: 'delivery', icon: 'âœ…',
                            tag: 'Delivered',
                            title: `Order delivered to ${doc.shopName || 'shop'}`,
                            body: `â‚¹${(doc.total||0).toFixed(2)} marked as delivered`
                        });
                    }
                }
            });
            _prevDeliveredSet = deliveredNow;
        }

        /* Quotation watcher */
        function notifWatchQuotations() {
            try {
                const arr = JSON.parse(localStorage.getItem('owm_qt_tracker') || '[]');
                if (_prevQtCount === null) { _prevQtCount = arr.length; return; }
                if (arr.length > _prevQtCount) {
                    const newest = arr[0];
                    if (newest) {
                        addNotif({
                            type: 'quotation', icon: 'ðŸ“‹',
                            tag: 'Quotation Saved',
                            title: `Quotation ${newest.quotNo || ''} saved`,
                            body: `Client: ${newest.clientName || 'â€”'} â€¢ â‚¹${(newest.grand||0).toFixed(2)} â€¢ Status: ${newest.status || 'pending'}`
                        });
                    }
                }
                // Check status changes
                arr.forEach(q => {
                    const prev = _notifQtStatusCache[q.quotNo];
                    if (prev && prev !== q.status) {
                        const statusEmoji = { accepted:'ðŸŽ‰', rejected:'âŒ', sent:'ðŸ“¤', pending:'â³' };
                        addNotif({
                            type: 'quotation', icon: statusEmoji[q.status] || 'ðŸ“‹',
                            tag: 'Quotation ' + (q.status || '').toUpperCase(),
                            title: `Quotation ${q.quotNo} is now ${q.status}`,
                            body: `Client: ${q.clientName || 'â€”'} â€¢ â‚¹${(q.grand||0).toFixed(2)}`
                        });
                    }
                    _notifQtStatusCache[q.quotNo] = q.status;
                });
                _prevQtCount = arr.length;
            } catch(e) {}
        }
        const _notifQtStatusCache = {};

        /* Due payment watcher â€” scans historyData for pending orders older than 3 days */
        let _lastDueCheck = 0;
        function notifCheckDuePayments() {
            if (Date.now() - _lastDueCheck < 300000) return; // check every 5 min
            _lastDueCheck = Date.now();
            if (typeof historyData === 'undefined' || !historyData.length) return;
            const threeDaysAgo = Date.now() - 3 * 86400000;
            const pendingOld = historyData.filter(d => {
                const t = d.time ? d.time.toDate().getTime() : 0;
                return (!d.deliveryStatus || d.deliveryStatus === 'pending') && t < threeDaysAgo;
            });
            if (pendingOld.length > 0) {
                addNotif({
                    type: 'due', icon: 'âš ï¸',
                    tag: 'Pending Delivery',
                    title: `${pendingOld.length} order(s) pending delivery >3 days`,
                    body: `Shops: ${[...new Set(pendingOld.map(d=>d.shopName))].slice(0,3).join(', ')}${pendingOld.length>3?' + more...':''}`,
                    autoRead: false
                });
            }
        }

        /* Stock low watcher */
        let _lastStockCheck = 0;
        let _notifLowStockSent = new Set();
        function notifCheckLowStock() {
            if (Date.now() - _lastStockCheck < 600000) return; // every 10 min
            _lastStockCheck = Date.now();
            if (typeof stockData === 'undefined') return;
            const low = stockData.filter(s => (s.qty || 0) <= 5 && !_notifLowStockSent.has(s.id));
            low.forEach(s => {
                _notifLowStockSent.add(s.id);
                addNotif({
                    type: 'stock', icon: 'ðŸ“‰',
                    tag: 'Low Stock',
                    title: `Low stock: ${s.id}`,
                    body: `Only ${s.qty} units remaining â€” consider restocking`
                });
            });
        }

        /* Hook into existing onSnapshot â€” patch historyData loading */
        const _origRenderNotifFromSnap = function(docsArray) {
            notifWatchOrders(docsArray);
            notifWatchDelivery(docsArray);
            notifCheckDuePayments();
            notifCheckLowStock();
        };

        /* Poll every 30s to catch quotation changes & stock */
        setInterval(() => {
            notifWatchQuotations();
            notifCheckLowStock();
            notifCheckDuePayments();
        }, 30000);

        /* Patch the existing onSnapshot to also call notif watchers */
        (function patchSnapshotListener() {
            const origDb = typeof db !== 'undefined' ? db : null;
            if (!origDb) { setTimeout(patchSnapshotListener, 1500); return; }
            // Intercept historyData pushes
            const checkInterval = setInterval(() => {
                if (typeof historyData !== 'undefined' && historyData.length > 0) {
                    _origRenderNotifFromSnap(historyData);
                    clearInterval(checkInterval);
                }
            }, 2000);
        })();

        /* Watch for delivery status changes via MutationObserver on historyList */
        (function watchDeliveryMutations() {
            const target = document.getElementById('historyList');
            if (!target) { setTimeout(watchDeliveryMutations, 2000); return; }
            const obs = new MutationObserver(() => {
                if (typeof historyData !== 'undefined') {
                    notifWatchDelivery(historyData);
                    notifCheckDuePayments();
                }
            });
            obs.observe(target, { childList: true, subtree: false });
        })();

        /* Watch quotation saves via localStorage events */
        window.addEventListener('storage', (e) => {
            if (e.key === 'owm_qt_tracker') notifWatchQuotations();
        });

        /* Seed a welcome notification on first load */
        (function seedWelcome() {
            const notifs = getNotifs();
            const hasWelcome = notifs.some(n => n.type === 'system' && n.title.startsWith('Welcome'));
            if (!hasWelcome) {
                setTimeout(() => {
                    addNotif({
                        type: 'system', icon: 'ðŸ‘‹',
                        tag: 'System',
                        title: 'Welcome to Order With Me!',
                        body: 'Notification centre is active. Order, delivery, payment & quotation alerts will appear here.',
                        autoRead: true
                    });
                }, 2000);
            }
        })();

        /* Initial badge render */
        setTimeout(() => {
            updateNotifBadge();
            renderNotifList();
        }, 500);

    </script>

    <!-- ===== SETTINGS PANEL LOGIC ===== -->
    <script>
        // Background presets
        const BG_PRESETS = {
            default:   { light: 'linear-gradient(135deg,#e8ecf8 0%,#eef0fb 30%,#f0f4ff 60%,#e6eaf6 100%)', dark: 'linear-gradient(135deg,#090b14 0%,#0d0f1c 40%,#0f1220 70%,#0b0d18 100%)' },
            midnight:  { light: 'linear-gradient(135deg,#1e1b4b,#312e81,#1e1b4b)', dark: 'linear-gradient(135deg,#0a0a1a,#1a1a3e,#0a0a1a)' },
            aurora:    { light: 'linear-gradient(135deg,#ecfdf5,#d1fae5,#cffafe)', dark: 'linear-gradient(135deg,#064e3b,#0c4a6e,#3b0764)' },
            sunset:    { light: 'linear-gradient(135deg,#fff7ed,#fde8d0,#fef3c7)', dark: 'linear-gradient(135deg,#7c2d12,#9a3412,#78350f)' },
            ocean:     { light: 'linear-gradient(135deg,#f0f9ff,#e0f2fe,#cffafe)', dark: 'linear-gradient(135deg,#0c4a6e,#0369a1,#075985)' },
            rose:      { light: 'linear-gradient(135deg,#fff1f2,#ffe4e6,#fce7f3)', dark: 'linear-gradient(135deg,#4c0519,#881337,#9f1239)' },
            forest:    { light: 'linear-gradient(135deg,#f0fdf4,#dcfce7,#d1fae5)', dark: 'linear-gradient(135deg,#052e16,#14532d,#166534)' },
            galaxy:    { light: 'linear-gradient(135deg,#f5f3ff,#ede9fe,#e0e7ff)', dark: 'radial-gradient(ellipse at 30% 60%,#3b0764,#0f172a,#1e1b4b)' },
            cotton:    { light: 'linear-gradient(135deg,#fdf2f8,#fbcfe8,#fce7f3)', dark: 'linear-gradient(135deg,#500724,#831843,#9d174d)' },
            lemon:     { light: 'linear-gradient(135deg,#fefce8,#fef9c3,#fef08a)', dark: 'linear-gradient(135deg,#713f12,#854d0e,#78350f)' },
            mesh:      { light: 'conic-gradient(from 90deg at 40% 50%,#c7d2fe,#bae6fd,#a7f3d0,#c7d2fe)', dark: 'conic-gradient(from 90deg at 40% 50%,#1e1b4b,#0c4a6e,#064e3b,#1e1b4b)' },
            charcoal:  { light: 'linear-gradient(135deg,#f8fafc,#f1f5f9,#e2e8f0)', dark: 'linear-gradient(135deg,#111827,#1f2937,#374151)' },
        };

        let _settingsOpen = false;
        let _currentBgPreset = localStorage.getItem('owm_bg_preset') || 'default';
        let _animBgEnabled = localStorage.getItem('owm_anim_bg') !== 'false';
        let _currentScale = localStorage.getItem('owm_ui_scale') || 'normal';
        let _currentAccent = JSON.parse(localStorage.getItem('owm_accent') || 'null');

        // Apply saved settings on load
        (function applyStoredSettings() {
            setTimeout(() => {
                if (_currentBgPreset !== 'default') {
                    _applyBgPreset(_currentBgPreset);
                }
                if (_currentScale !== 'normal') _applyUiScale(_currentScale);
                if (_currentAccent) _applyAccent(_currentAccent[0], _currentAccent[1]);
            }, 400);
        })();

        function toggleSettingsPanel() {
            _settingsOpen = !_settingsOpen;
            const panel = document.getElementById('settingsPanel');
            const backdrop = document.getElementById('settingsBackdrop');
            const btn = document.getElementById('settingsBtnHeader');
            if (_settingsOpen) {
                backdrop.classList.add('active');
                panel.style.display = 'flex';
                requestAnimationFrame(() => panel.classList.add('active'));
                btn.classList.add('active');
                _syncSettingsUI();
            } else {
                closeSettingsPanel();
            }
        }

        function closeSettingsPanel() {
            _settingsOpen = false;
            const panel = document.getElementById('settingsPanel');
            const backdrop = document.getElementById('settingsBackdrop');
            const btn = document.getElementById('settingsBtnHeader');
            panel.classList.remove('active');
            backdrop.classList.remove('active');
            btn.classList.remove('active');
            setTimeout(() => { if (!panel.classList.contains('active')) panel.style.display = 'none'; }, 300);
        }

        function _syncSettingsUI() {
            // Sync dark mode toggle
            const isDark = document.body.classList.contains('dark-mode');
            const tog = document.getElementById('settingsDarkToggle');
            if (tog) tog.checked = isDark;
            const icon = document.getElementById('settingsThemeIcon');
            const lbl = document.getElementById('settingsThemeLabel');
            if (icon) icon.textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
            if (lbl) lbl.textContent = isDark ? 'Dark Mode' : 'Light Mode';
            // Sync bg preset
            document.querySelectorAll('.bg-preset-btn').forEach(b => {
                b.classList.toggle('active-bg', b.dataset.bg === _currentBgPreset);
            });
            // Sync anim bg
            const animTog = document.getElementById('settingsAnimBg');
            if (animTog) animTog.checked = _animBgEnabled;
            // Sync scale
            ['small','normal','large'].forEach(s => {
                const el = document.getElementById('scale' + s.charAt(0).toUpperCase() + s.slice(1));
                if (el) {
                    const isActive = s === _currentScale;
                    el.style.borderColor = isActive ? 'var(--primary)' : 'var(--border)';
                    el.style.background = isActive ? 'var(--primary-light)' : 'var(--bg)';
                    el.style.color = isActive ? 'var(--primary)' : 'var(--text)';
                }
            });
        }

        function settingsToggleTheme(chk) {
            const isDark = chk.checked;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('owm_dark_mode', isDark ? '1' : '0');
            // Also sync sidebar button
            const sideBtn = document.getElementById('themeToggleBtn');
            if (sideBtn) sideBtn.textContent = isDark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
            const icon = document.getElementById('settingsThemeIcon');
            const lbl = document.getElementById('settingsThemeLabel');
            if (icon) icon.textContent = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
            if (lbl) lbl.textContent = isDark ? 'Dark Mode' : 'Light Mode';
            // Reapply bg preset after mode change (dark/light variant)
            if (_currentBgPreset !== 'default') _applyBgPreset(_currentBgPreset);
        }

        function _applyBgPreset(name) {
            const preset = BG_PRESETS[name] || BG_PRESETS.default;
            const isDark = document.body.classList.contains('dark-mode');
            if (name === 'default') {
                document.body.classList.remove('custom-bg', 'anim-bg');
                document.body.style.removeProperty('background');
            } else {
                const bg = isDark ? preset.dark : preset.light;
                // Use a stylesheet rule injected into <head> so it wins over !important via specificity
                let styleTag = document.getElementById('owm-bg-override');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'owm-bg-override';
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = `body.custom-bg { background: ${bg} !important; background-size: 400% 400% !important; }`;
                document.body.classList.add('custom-bg');
                if (_animBgEnabled) {
                    document.body.classList.add('anim-bg');
                } else {
                    document.body.classList.remove('anim-bg');
                }
            }
        }

        function setBgPreset(el, name) {
            _currentBgPreset = name;
            localStorage.setItem('owm_bg_preset', name);
            document.querySelectorAll('.bg-preset-btn').forEach(b => b.classList.remove('active-bg'));
            el.classList.add('active-bg');
            _applyBgPreset(name);
        }

        function toggleAnimatedBg(chk) {
            _animBgEnabled = chk.checked;
            localStorage.setItem('owm_anim_bg', _animBgEnabled ? 'true' : 'false');
            if (_animBgEnabled) {
                document.body.classList.add('anim-bg');
            } else {
                document.body.classList.remove('anim-bg');
            }
        }

        function _applyAccent(primary, secondary) {
            document.documentElement.style.setProperty('--primary', primary);
            document.documentElement.style.setProperty('--secondary', secondary);
            document.documentElement.style.setProperty('--primary-light', hexToRgba(primary, 0.12));
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function setAccentColor(el, primary, secondary) {
            document.querySelectorAll('.accent-dot').forEach(d => d.classList.remove('active-accent'));
            el.classList.add('active-accent');
            _applyAccent(primary, secondary);
            localStorage.setItem('owm_accent', JSON.stringify([primary, secondary]));
            _currentAccent = [primary, secondary];
        }

        function _applyUiScale(scale) {
            const sizes = { small: '13px', normal: '14px', large: '15px' };
            document.body.style.fontSize = sizes[scale] || '14px';
        }

        function setUiScale(scale) {
            _currentScale = scale;
            localStorage.setItem('owm_ui_scale', scale);
            _applyUiScale(scale);
            _syncSettingsUI();
        }

        function resetAllSettings() {
            _currentBgPreset = 'default';
            _animBgEnabled = true;
            _currentScale = 'normal';
            _currentAccent = null;
            localStorage.removeItem('owm_bg_preset');
            localStorage.removeItem('owm_anim_bg');
            localStorage.removeItem('owm_ui_scale');
            localStorage.removeItem('owm_accent');
            document.body.classList.remove('custom-bg', 'anim-bg');
            const styleTag = document.getElementById('owm-bg-override');
            if (styleTag) styleTag.textContent = '';
            document.body.style.removeProperty('background');
            document.body.style.fontSize = '';
            document.documentElement.style.removeProperty('--primary');
            document.documentElement.style.removeProperty('--secondary');
            document.documentElement.style.removeProperty('--primary-light');
            _syncSettingsUI();
            document.querySelectorAll('.accent-dot').forEach((d,i) => d.classList.toggle('active-accent', i===0));
            if (typeof toast === 'function') toast('âœ… Settings reset to defaults!', 'success');
        }

        // Add bg animation keyframe dynamically
        (function addBgKeyframe() {
            const style = document.createElement('style');
            style.textContent = `@keyframes bgShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }`;
            document.head.appendChild(style);
        })();
    </script>
</body>
</html>
