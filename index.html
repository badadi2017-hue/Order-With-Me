<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order With Me - ERP</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #6366f1;
            --primary-light: rgba(99,102,241,0.12);
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --success: #10b981;
            --danger: #f43f5e;
            --border: #e2e8f0;
            --warning: #f59e0b;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(79,70,229,0.12);
            --auth-bg-start: #f8faff;
            --auth-bg-end: #e8ecf8;
            --auth-card-bg: #ffffff;
            --auth-card-border: rgba(79,70,229,0.18);
            --auth-card-shadow: 0 20px 60px rgba(79,70,229,0.12);
            --auth-input-bg: rgba(79,70,229,0.05);
            --auth-input-border: rgba(79,70,229,0.18);
            --auth-input-color: #1e293b;
            --auth-title-color: #1e293b;
            --auth-sub-color: #64748b;
            --auth-brand-start: #4f46e5;
            --auth-brand-end: #06b6d4;
            --auth-select-option-bg: #ffffff;
        }
        body.dark-mode {
            --bg: #0f1117;
            --card: #1a2035;
            --text: #e2e8f0;
            --border: #2d3748;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --auth-bg-start: #0f1117;
            --auth-bg-end: #1a1f35;
            --auth-card-bg: #1a2035;
            --auth-card-border: rgba(99,102,241,0.25);
            --auth-card-shadow: 0 20px 60px rgba(0,0,0,0.5);
            --auth-input-bg: rgba(255,255,255,0.06);
            --auth-input-border: rgba(255,255,255,0.1);
            --auth-input-color: #e2e8f0;
            --auth-title-color: #e2e8f0;
            --auth-sub-color: #64748b;
            --auth-brand-start: #6366f1;
            --auth-brand-end: #22d3ee;
            --auth-select-option-bg: #1a2035;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            padding-bottom: 30px;
        }
        .card {
            background: var(--card);
            border-radius: 18px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            border: 1px solid var(--border);
            overflow: visible;
            transition: box-shadow 0.3s;
        }
        .input-field {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            background: var(--card);
            color: var(--text);
            outline: none;
            transition: border-color 0.25s, box-shadow 0.25s;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
        }
        .input-field::placeholder { color: #94a3b8; }
        .btn {
            width: 100%;
            padding: 13px 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            font-weight: 700;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(79,70,229,0.3);
            letter-spacing: 0.3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79,70,229,0.35); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .btn-success:hover { box-shadow: 0 8px 20px rgba(16,185,129,0.4); }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            box-shadow: none;
        }
        .btn-outline:hover { background: var(--primary-light); box-shadow: none; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        #auth-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--auth-bg-start) 0%, var(--auth-bg-end) 50%, var(--auth-bg-start) 100%);
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow: hidden;
            transition: background 0.4s ease;
        }
        #auth-screen::before {
            content: '';
            position: absolute;
            top: -100px; right: -100px;
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(99,102,241,0.12) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #auth-screen::after {
            content: '';
            position: absolute;
            bottom: -80px; left: -80px;
            width: 320px; height: 320px;
            background: radial-gradient(circle, rgba(16,185,129,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #login-box, #reg-box {
            background: var(--auth-card-bg) !important;
            border: 1px solid var(--auth-card-border) !important;
            box-shadow: var(--auth-card-shadow) !important;
            position: relative;
            z-index: 1;
            transition: background 0.4s, border 0.4s, box-shadow 0.4s;
        }
        .auth-brand {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            transition: all 0.4s;
        }
        .auth-brand-sub { color: var(--auth-sub-color); font-size: 13px; margin-bottom: 22px; transition: color 0.4s; }
        .auth-title-text { color: var(--auth-title-color) !important; transition: color 0.4s; }
        #login-box .input-field, #reg-box .input-field {
            background: var(--auth-input-bg);
            border-color: var(--auth-input-border);
            color: var(--auth-input-color);
            transition: background 0.4s, border-color 0.4s, color 0.4s;
        }
        #login-box .input-field:focus, #reg-box .input-field:focus {
            border-color: #6366f1;
            background: rgba(99,102,241,0.1);
        }
        #login-box .input-field::placeholder, #reg-box .input-field::placeholder { color: var(--auth-sub-color); }
        #login-box select.input-field option, #reg-box select.input-field option {
            background: var(--auth-select-option-bg);
            color: var(--auth-input-color);
        }
        .auth-link-text { color: var(--auth-sub-color); font-size: 13px; }
        .auth-link-highlight { color: #6366f1; font-weight: 700; cursor: pointer; }
        #app-screen { display: none; }
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes heartBeat {
            0%   { transform: scale(1); }
            14%  { transform: scale(1.3); }
            28%  { transform: scale(1); }
            42%  { transform: scale(1.25); }
            70%  { transform: scale(1); }
            100% { transform: scale(1); }
        }
        .header {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            padding: 14px 20px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(79,70,229,0.3);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar {
            position: fixed; top: 0; left: -300px; width: 270px; height: 100vh;
            background: var(--card);
            box-shadow: 8px 0 30px rgba(0,0,0,0.15);
            transition: left 0.35s cubic-bezier(0.4,0,0.2,1);
            z-index: 1000; padding: 0; box-sizing: border-box;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            display: none; z-index: 999;
            backdrop-filter: blur(3px);
        }
        .overlay.active { display: block; }

        .sidebar-header {
            padding: 18px 16px 12px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: linear-gradient(135deg, rgba(79,70,229,0.07), rgba(99,102,241,0.03));
            flex-shrink: 0;
        }
        .sidebar-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .sidebar-edit-btn {
            background: var(--primary-light);
            border: 1px solid rgba(99,102,241,0.3);
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 9px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s, transform 0.15s;
            white-space: nowrap;
        }
        .sidebar-edit-btn:hover { background: rgba(99,102,241,0.2); transform: scale(1.03); }
        .sidebar-edit-btn.active-edit { background: var(--primary); color: white; border-color: var(--primary); }

        .sidebar-nav-area {
            padding: 12px 14px;
            flex: 1;
        }

        .menu-item {
            padding: 11px 14px; border-radius: 12px;
            font-size: 14px; cursor: pointer; margin-bottom: 4px;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s, transform 0.15s, color 0.2s;
            color: var(--text);
            user-select: none;
        }
        .menu-item:hover { background: var(--primary-light); transform: translateX(4px); }
        .menu-item.active-menu {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            box-shadow: 0 4px 12px rgba(79,70,229,0.25);
        }
        .menu-item.active-menu:hover { transform: none; }

        .menu-item.dragging {
            opacity: 0.5;
            background: var(--primary-light) !important;
            border: 2px dashed var(--primary);
            transform: scale(0.97);
        }
        .menu-item.drag-over {
            border-top: 2px solid var(--primary);
            margin-top: -2px;
        }
        .drag-handle {
            display: none;
            cursor: grab;
            color: #94a3b8;
            font-size: 14px;
            padding: 0 6px 0 0;
            flex-shrink: 0;
        }
        .drag-handle:active { cursor: grabbing; }
        body.menu-edit-mode .drag-handle { display: inline; }
        body.menu-edit-mode .menu-item { cursor: grab; }
        body.menu-edit-mode .menu-item:hover { transform: none; }
        body.menu-edit-mode .menu-item.active-menu:hover { transform: none; }
        /* CRITICAL: Prevent child spans from intercepting drag events */
        body.menu-edit-mode .drag-handle { pointer-events: auto !important; cursor: grab !important; }
        body.menu-edit-mode .menu-item { cursor: grab !important; }
        body.menu-edit-mode .menu-item:active { cursor: grabbing !important; }
        body.menu-edit-mode .menu-item * { pointer-events: none; }
        body.menu-edit-mode .menu-section-label * { pointer-events: none; }
        .menu-item.dragging { opacity: 0.4; }
        .menu-item.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }
        .menu-section-label.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }

        .menu-section-label {
            font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
            margin-bottom: 6px; margin-left: 4px; margin-top: 4px;
            color: #94a3b8; text-transform: uppercase;
            display: flex; align-items: center; gap: 6px;
        }
        .menu-section-label .drag-handle { display: none; }
        body.menu-edit-mode .menu-section-label .drag-handle { display: inline; }
        .menu-hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }
        .qa-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 10px 6px; border-radius: 12px; border: 1.5px solid var(--border);
            background: var(--bg); cursor: pointer; transition: all 0.2s; text-align: center;
            font-family: 'Poppins', sans-serif; color: var(--text); position: relative; overflow: hidden;
        }
        .qa-btn:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79,70,229,0.15); }
        .qa-btn:active { transform: translateY(0); }
        .qa-btn-icon { font-size: 20px; line-height: 1; }
        .qa-btn-label { font-size: 10px; font-weight: 700; color: var(--text); line-height: 1.2; }
        .qa-btn-count { font-size: 9px; color: #94a3b8; font-weight: 600; }
        .qa-badge { position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; font-size: 8px; font-weight: 800; padding: 1px 5px; border-radius: 99px; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 15px; }
        .dash-card {
            border-radius: 14px; padding: 10px 12px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid transparent;
        }
        .dash-card:hover { transform: translateY(-3px); }
        .dc-today { background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-color: #a7f3d0; }
        .dc-today .dc-val { color: #065f46; }
        .dc-today .dc-lbl { color: #047857; }
        .dc-total { background: linear-gradient(135deg, #eef2ff, #e0e7ff); border-color: #c7d2fe; }
        .dc-total .dc-val { color: #3730a3; }
        .dc-total .dc-lbl { color: #4338ca; }
        .dc-orders { background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-color: #bae6fd; }
        .dc-orders .dc-val { color: #0c4a6e; }
        .dc-orders .dc-lbl { color: #0369a1; }
        .dc-alert { background: linear-gradient(135deg, #fff1f2, #ffe4e6); border-color: #fecdd3; }
        .dc-alert .dc-val { color: #9f1239; }
        .dc-alert .dc-lbl { color: #be123c; }
        body.dark-mode .dc-today { background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); border-color: rgba(16,185,129,0.2); }
        body.dark-mode .dc-today .dc-val { color: #34d399; }
        body.dark-mode .dc-today .dc-lbl { color: #6ee7b7; }
        body.dark-mode .dc-total { background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(99,102,241,0.05)); border-color: rgba(99,102,241,0.2); }
        body.dark-mode .dc-total .dc-val { color: #818cf8; }
        body.dark-mode .dc-total .dc-lbl { color: #a5b4fc; }
        body.dark-mode .dc-orders { background: linear-gradient(135deg, rgba(34,211,238,0.12), rgba(34,211,238,0.04)); border-color: rgba(34,211,238,0.2); }
        body.dark-mode .dc-orders .dc-val { color: #22d3ee; }
        body.dark-mode .dc-orders .dc-lbl { color: #67e8f9; }
        body.dark-mode .dc-alert { background: linear-gradient(135deg, rgba(244,63,94,0.15), rgba(244,63,94,0.05)); border-color: rgba(244,63,94,0.2); }
        body.dark-mode .dc-alert .dc-val { color: #fb7185; }
        body.dark-mode .dc-alert .dc-lbl { color: #fda4af; }
        .dc-icon { font-size: 16px; margin-bottom: 3px; display: block; }
        .dc-lbl { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .dc-val { font-size: 15px; font-weight: 800; margin-top: 2px; line-height: 1.1; }
        .card-success { border-left: 3px solid var(--success); }
        /* Manager-only columns: hidden for salesman role */
        body.role-salesman .mgr-only-col { display: none !important; }
        /* Shop Notes */
        .shop-note-card { background: rgba(245,158,11,0.07); border:1.5px solid rgba(245,158,11,0.25); border-radius:14px; padding:12px 14px; margin-bottom:8px; }
        .shop-note-card .note-meta { font-size:10px; color:#94a3b8; margin-top:4px; }
        .shop-note-card .note-text { font-size:13px; color:var(--text); font-weight:500; line-height:1.5; }
        .shop-note-badge { display:inline-block; font-size:10px; font-weight:700; background:rgba(245,158,11,0.15); color:#b45309; border-radius:20px; padding:2px 8px; margin-left:6px; vertical-align:middle; }
        .card-warning  { border-left: 3px solid var(--warning); }
        .card-danger   { border-left: 3px solid var(--danger); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 10px; }

        .collapsible-section {
            border: 1.5px solid var(--border);
            border-radius: 16px;
            margin-bottom: 14px;
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow);
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            background: var(--card);
            user-select: none;
            transition: background 0.2s;
        }
        .collapsible-header:hover { background: var(--primary-light); }
        .collapsible-header .ch-title {
            font-size: 15px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
        }
        .collapsible-header .ch-arrow {
            font-size: 12px; color: #94a3b8;
            transition: transform 0.3s;
        }
        .collapsible-header.open .ch-arrow { transform: rotate(180deg); }
        .collapsible-body {
            display: none;
            padding: 0 20px 18px;
            border-top: 1px solid var(--border);
            animation: fadeUp 0.25s ease;
        }
        .collapsible-body.open { display: block; }

        .collapse-btn {
            background: var(--primary-light);
            color: var(--primary);
            cursor: pointer; padding: 11px 16px; width: 100%;
            border: 1px dashed var(--primary);
            text-align: center; outline: none;
            font-size: 13px; font-weight: 700;
            border-radius: 12px; margin-bottom: 14px;
            transition: background 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .collapse-btn:hover { background: rgba(79,70,229,0.18); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; min-width: 600px; }
        .data-table th {
            background: var(--primary-light);
            padding: 12px 14px;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
            white-space: nowrap;
            font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
        }
        .data-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--primary-light); }
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); padding: 13px 22px;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 3000; display: none;
            border-left: 4px solid var(--primary);
            font-weight: 600; font-size: 14px; color: var(--text);
        }

        /* ===== UNDO SNACKBAR ===== */
        #undo-bar {
            position: fixed; bottom: 24px; left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #1e293b; color: white;
            padding: 13px 18px; border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.35);
            z-index: 4000; display: flex; align-items: center; gap: 14px;
            font-size: 13px; font-weight: 600;
            transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
            white-space: nowrap; max-width: 90vw;
        }
        #undo-bar.visible { transform: translateX(-50%) translateY(0); }
        #undo-bar .undo-msg { flex: 1; opacity: 0.9; }
        #undo-bar .undo-timer-ring {
            width: 28px; height: 28px; flex-shrink: 0;
            position: relative;
        }
        #undo-bar .undo-timer-ring svg { transform: rotate(-90deg); }
        #undo-bar .undo-timer-ring circle {
            fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 2.5;
        }
        #undo-bar .undo-timer-ring .ring-progress {
            stroke: #10b981; stroke-dasharray: 72; stroke-dashoffset: 0;
            transition: stroke-dashoffset linear;
            stroke-linecap: round;
        }
        #undo-bar .undo-btn {
            background: #10b981; color: white; border: none;
            padding: 7px 14px; border-radius: 9px; font-size: 12px;
            font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif;
            flex-shrink: 0; transition: background 0.2s, transform 0.15s;
        }
        #undo-bar .undo-btn:hover { background: #059669; transform: scale(1.05); }
        #undo-bar .undo-dismiss {
            background: none; border: none; color: rgba(255,255,255,0.5);
            font-size: 16px; cursor: pointer; padding: 2px 4px; line-height: 1;
            flex-shrink: 0;
        }
        body.dark-mode #undo-bar { background: #334155; }
        .highlight-box {
            display: none;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 12px 14px; border-radius: 12px;
            font-size: 13px; margin-bottom: 12px;
            font-weight: 600; line-height: 1.6;
        }
        body.dark-mode .highlight-box {
            background: rgba(34,211,238,0.08);
            border-color: rgba(34,211,238,0.25);
            color: #22d3ee;
        }
        .toggle-box {
            display: flex; background: var(--bg);
            border-radius: 12px; margin-bottom: 12px;
            border: 1.5px solid var(--border); overflow: hidden;
        }
        .toggle-box label {
            flex: 1; text-align: center; padding: 10px 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: background 0.25s, color 0.25s; color: var(--text);
        }
        .toggle-box label:has(input:checked) {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
        }
        .toggle-box input { display: none; }
        .bill-container {
            background: white; color: #1a1a2e;
            max-width: 500px; margin: 0 auto; padding: 28px;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border: 1px solid #e2e8f0; position: relative;
        }
        .bill-header { text-align: center; border-bottom: 2px solid #4f46e5; padding-bottom: 15px; margin-bottom: 15px; }
        .bill-header h1 { margin: 0; color: #4f46e5; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
        .bill-meta { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 20px; }
        .bill-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
        .bill-table th { background: #f8faff; padding: 8px 10px; text-align: left; border-bottom: 2px solid #1a1a2e; font-weight: 700; }
        .bill-table td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
        .bill-total { text-align: right; font-size: 16px; font-weight: 800; border-top: 2px solid #1a1a2e; padding-top: 10px; color: #4f46e5; }
        .daily-pass-card {
            border: 1.5px solid rgba(99,102,241,0.3) !important;
            background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02)) !important;
        }
        .pass-display {
            background: var(--bg);
            border: 2px dashed rgba(99,102,241,0.35);
            border-radius: 12px;
            padding: 20px; text-align: center; margin: 12px 0;
            letter-spacing: 8px; font-size: 24px; font-weight: 700;
            color: var(--primary); font-family: 'Courier New', monospace;
        }
        .pass-validity { font-size: 11px; color: #64748b; text-align: center; margin-top: 6px; }
        .master-unlock { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .master-unlock input { flex: 1; margin-bottom: 0 !important; }
        .master-unlock button { width: auto; margin-bottom: 0 !important; padding: 12px 16px; white-space: nowrap; flex-shrink: 0; }
        .pass-locked-msg { text-align: center; padding: 16px; color: #64748b; font-size: 13px; }
        .pass-locked-msg .lock-icon { font-size: 32px; display: block; margin-bottom: 8px; }

        .report-filter-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .report-filter-bar select, .report-filter-bar input[type="date"] {
            flex: 1; min-width: 120px;
            padding: 9px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            background: var(--card);
            color: var(--text);
            outline: none;
        }
        .report-filter-bar select:focus, .report-filter-bar input[type="date"]:focus {
            border-color: var(--primary);
        }

        .date-preset-grid {
            display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .preset-btn {
            padding: 7px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .preset-btn:hover, .preset-btn.active-preset {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .sort-toggle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .sort-option {
            padding: 9px 10px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
        }
        .sort-option:hover, .sort-option.active-sort {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            border-color: var(--primary);
        }
        .report-stat-mini {
            background: var(--bg);
            border-radius: 12px;
            padding: 12px 14px;
            flex: 1;
            border: 1px solid var(--border);
        }
        .report-stat-mini .rsm-lbl { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; }
        .report-stat-mini .rsm-val { font-size: 16px; font-weight: 800; margin-top: 2px; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }
        .due-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .due-badge.has-due { background: rgba(244,63,94,0.12); color: #f43f5e; }
        .due-badge.cleared { background: rgba(16,185,129,0.12); color: #10b981; }
        .payment-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px;
        }
        .payment-row:last-child { border-bottom: none; }
        .return-item-row {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 0; border-bottom: 1px solid var(--border);
        }
        .visit-card {
            border-left: 3px solid var(--primary);
            padding: 12px 14px; border-radius: 12px;
            background: var(--bg); margin-bottom: 10px;
            font-size: 13px;
        }
        .visit-card .vc-shop { font-weight: 700; font-size: 14px; color: var(--primary); }
        .visit-card .vc-meta { color: #64748b; font-size: 11px; margin-top: 3px; }
        .perf-card {
            border-radius: 14px; padding: 16px;
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.02));
            border: 1px solid rgba(99,102,241,0.15); margin-bottom: 12px;
        }
        .perf-rank { font-size: 22px; font-weight: 800; margin-right: 8px; }
        .perf-bar-wrap { background: var(--border); border-radius: 99px; height: 8px; margin-top: 8px; }
        .perf-bar { background: linear-gradient(90deg, var(--primary), #6366f1); border-radius: 99px; height: 8px; transition: width 0.6s ease; }
        .pnl-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px;
        }
        .pnl-row:last-child { border-bottom: none; }
        .pnl-total-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; font-size: 16px; font-weight: 800;
            border-top: 2px solid var(--primary); margin-top: 8px;
        }
        .item-disc-badge {
            background: rgba(245,158,11,0.15); color: var(--warning);
            font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px;
            border: 1px solid rgba(245,158,11,0.3);
        }
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
            box-shadow: 0 4px 15px rgba(37,211,102,0.3);
        }
        .btn-whatsapp:hover { box-shadow: 0 8px 20px rgba(37,211,102,0.4); }

        .due-shop-card {
            border-radius: 16px; padding: 18px; margin-bottom: 14px;
            border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); transition: box-shadow 0.3s;
        }
        .due-progress-wrap { background: var(--border); border-radius: 99px; height: 10px; margin: 10px 0 6px; overflow: hidden; }
        .due-progress-bar { height: 10px; border-radius: 99px; transition: width 0.6s ease; }
        .due-stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; padding: 6px 0; }
        .due-total-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 800; padding: 10px 0 0; border-top: 2px solid var(--border); margin-top: 6px; }

        .due-payment-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        .due-payment-table th { background: rgba(16,185,129,0.1); padding: 8px 10px; border-bottom: 2px solid rgba(16,185,129,0.3); color: #10b981; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .due-payment-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .due-payment-table tr:last-child td { border-bottom: none; }
        .due-payment-table tr:hover td { background: rgba(16,185,129,0.05); }

        .action-btn {
            border: none; background: none; cursor: pointer;
            padding: 3px 7px; border-radius: 6px;
            font-size: 12px; font-family: 'Poppins', sans-serif;
            font-weight: 600; transition: background 0.2s;
        }
        .action-btn-edit { color: var(--warning); border: 1px solid rgba(245,158,11,0.35); }
        .action-btn-edit:hover { background: rgba(245,158,11,0.12); }
        .action-btn-delete { color: var(--danger); border: 1px solid rgba(244,63,94,0.35); }
        .action-btn-delete:hover { background: rgba(244,63,94,0.12); }

        #due-pdf-zone, #returns-pdf-zone, #visits-pdf-zone { background: white; color: #1a1a2e; }

        .sidebar-bottom {
            padding: 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        @media print {
            body * { visibility: hidden; background: white !important; }
            #a5-print-zone, #a5-print-zone * { visibility: visible; }
            #a5-print-zone { position: absolute; left: 0; top: 0; width: 100%; max-width: 148mm; margin: 0; padding: 0; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ===== UNDO SNACKBAR ===== -->
    <div id="undo-bar">
        <span class="undo-msg" id="undo-msg">Deleted</span>
        <div class="undo-timer-ring">
            <svg width="28" height="28" viewBox="0 0 28 28">
                <circle cx="14" cy="14" r="11.5"/>
                <circle class="ring-progress" id="undo-ring" cx="14" cy="14" r="11.5" stroke-dasharray="72" stroke-dashoffset="0"/>
            </svg>
        </div>
        <button class="undo-btn" onclick="executeUndo()">‚Ü© Undo</button>
        <button class="undo-dismiss" onclick="dismissUndo()">‚úï</button>
    </div>

    <!-- ===== AUTH SCREEN ===== -->
    <div id="auth-screen">
        <!-- Theme Toggle -->
        <button id="authThemeToggle" onclick="toggleAuthTheme()" title="Toggle theme" style="
            position: absolute; top: 18px; right: 18px; z-index: 10;
            background: var(--auth-card-bg); border: 1.5px solid var(--auth-card-border);
            border-radius: 50px; padding: 8px 16px; cursor: pointer;
            font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600;
            color: var(--auth-title-color); display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 12px rgba(79,70,229,0.12); transition: all 0.3s ease;
        ">
            <span id="authThemeIcon">üåô</span>
            <span id="authThemeLabel">Dark</span>
        </button>

        <div id="login-box" class="card" style="width:100%; max-width:380px; text-align:center; padding:32px 28px;">
            <div style="font-size:38px; margin-bottom:8px;">üõí</div>
            <div class="auth-brand">Order With Me</div>
            <div class="auth-brand-sub">Business ERP ‚Äî Sign in to continue</div>
            <input type="text" id="loginUsername" class="input-field" placeholder="Username" onkeydown="if(event.key==='Enter') loginUser()">
            <input type="password" id="loginPassword" class="input-field" placeholder="Password" onkeydown="if(event.key==='Enter') loginUser()">
            <button class="btn btn-success" onclick="loginUser()" id="btnLogin">Login</button>
            <p class="auth-link-text">No account? <span class="auth-link-highlight" onclick="toggleAuthView('reg')">Register here</span></p>
        </div>
        <div id="reg-box" class="card" style="width:100%; max-width:380px; display:none; padding:28px;">
            <div style="font-size:20px; font-weight:800; text-align:center; margin-bottom:18px;" class="auth-title-text">Create Account</div>
            <input type="text" id="regName" class="input-field" placeholder="Full Name">
            <input type="text" id="regUser" class="input-field" placeholder="Unique Username">
            <input type="password" id="regPass" class="input-field" placeholder="Password (min 6 chars)">
            <select id="regRole" class="input-field">
                <option value="salesman">Salesman</option>
                <option value="manager">Manager</option>
            </select>
            <input type="password" id="pinBox" class="input-field" placeholder="Registration Password">
            <button class="btn" onclick="registerUser()" id="btnReg">Create Account</button>
            <p class="auth-link-text" style="text-align:center;">Have account? <span class="auth-link-highlight" onclick="toggleAuthView('login')">Login here</span></p>
        </div>

        <!-- Credit -->
        <div style="
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            text-align: center; z-index: 2; white-space: nowrap;
        ">
            <span style="
                font-family: 'Poppins', sans-serif;
                font-size: 13px;
                font-weight: 600;
                background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                opacity: 0.75;
                letter-spacing: 0.5px;
            ">Made With <span style="display:inline-block; animation: heartBeat 1.2s ease-in-out infinite; -webkit-text-fill-color: #f43f5e;">‚ù§Ô∏è</span> By Aditya</span>
        </div>
    </div>

    <div id="app-screen">
        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

        <!-- ===== SIDEBAR ===== -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-top">
                    <div>
                        <h3 id="sideName" style="margin:0; padding-right:0; font-size:17px; font-weight:700;">User</h3>
                        <p id="sideRole" style="font-size:11px; color:var(--primary); font-weight:700; text-transform:uppercase; letter-spacing:1px; margin:4px 0 0; background:var(--primary-light); display:inline-block; padding:3px 10px; border-radius:20px;">Role</p>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <button onclick="logoutApp()"
                                style="padding:3px 10px; border:none; border-radius:20px;
                                       background:linear-gradient(135deg,#f43f5e,#e11d48);
                                       color:white; font-weight:700; font-size:11px; cursor:pointer;
                                       font-family:'Poppins',sans-serif; box-shadow:0 2px 6px rgba(244,63,94,0.3);
                                       transition:opacity 0.2s, transform 0.15s;"
                                onmouseover="this.style.opacity='0.85';this.style.transform='scale(1.05)'"
                                onmouseout="this.style.opacity='1';this.style.transform=''">
                                Logout
                            </button>
                            <span style="font-size:11px; font-weight:700; color:var(--primary); background:var(--primary-light); padding:3px 8px; border-radius:20px; border:1px solid rgba(99,102,241,0.2);">V2.5.3</span>
                        </div>
                        <button class="sidebar-edit-btn" id="menuEditBtn" onclick="toggleMenuEditMode()">Edit</button>
                    </div>
                </div>
                <div id="menuEditHint" style="display:none; font-size:11px; color:#64748b; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:8px; padding:6px 10px; margin-top:6px;">
                    üñ±Ô∏è Drag items to reorder. Click ‚úÖ Done when finished.
                </div>
            </div>

            <div class="sidebar-nav-area" id="sidebarNavArea">
                <!-- Menu items rendered dynamically -->
            </div>

            <div class="sidebar-bottom">
                <button onclick="toggleThemeManually()" id="themeToggleBtn"
                    style="width:100%; padding:8px 6px; border:1.5px solid var(--border); border-radius:10px;
                           background:var(--bg); color:var(--text); font-weight:700; font-size:11px;
                           cursor:pointer; font-family:'Poppins',sans-serif; letter-spacing:0.3px;
                           transition:background 0.2s, transform 0.15s;"
                    onmouseover="this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.transform=''">
                    üåô Dark
                </button>
                <input type="checkbox" id="themeToggleCheckbox" onchange="toggleThemeManually()" style="display:none;">
                <div style="text-align:center; font-size:12px; font-weight:600; color:#64748b; margin-top:12px;">Made With ‚ù§Ô∏è By Aditya</div>
            </div>
        </div>

        <div class="header no-print">
            <div style="display:flex; align-items:center; gap:15px;">
                <span onclick="toggleMenu()" style="font-size:24px; cursor:pointer; user-select:none;">‚ò∞</span>
                <h3 id="pageTitle" style="margin:0; font-size:16px; font-weight:700; letter-spacing:1px;">DASHBOARD</h3>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="switchView('dashboard')" title="Home / Dashboard"
                    style="background:var(--primary-light); border:none; border-radius:10px; width:34px; height:34px;
                           font-size:17px; cursor:pointer; display:flex; align-items:center; justify-content:center;
                           transition:background 0.2s, transform 0.15s; flex-shrink:0;"
                    onmouseover="this.style.background='var(--primary)';this.style.transform='scale(1.1)'"
                    onmouseout="this.style.background='var(--primary-light)';this.style.transform=''">üè†</button>
                <div id="realTimeClock" style="text-align:right; line-height:1.3;"></div>
            </div>
        </div>

        <div style="padding:20px;">

            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view active">
                <div style="background:linear-gradient(135deg,rgba(79,70,229,0.12),rgba(99,102,241,0.06)); border:1px solid rgba(99,102,241,0.2); border-radius:18px; padding:18px 20px; margin-bottom:15px;">
                    <div style="font-size:18px; font-weight:800; color:var(--text);">Welcome back, <span id="dashWelcomeName">User</span>! üëã</div>
                    <div style="font-size:12px; color:#64748b; margin-top:2px;">Here's your business snapshot</div>
                </div>
                <div class="dash-grid">
                    <div class="dash-card dc-today"><span class="dc-icon">üìÖ</span><div class="dc-lbl">Today's Sales</div><div class="dc-val" id="dashTodaySales">‚Çπ 0.00</div></div>
                    <div class="dash-card dc-total"><span class="dc-icon">üí∞</span><div class="dc-lbl">Total Sales</div><div class="dc-val" id="dashTotalSales">‚Çπ 0.00</div></div>
                    <div class="dash-card dc-orders"><span class="dc-icon">üì¶</span><div class="dc-lbl">Total Orders</div><div class="dc-val" id="dashTotalOrders">0</div></div>
                    <div class="dash-card dc-alert"><span class="dc-icon">‚ö†Ô∏è</span><div class="dc-lbl">Low Stock</div><div class="dc-val" id="dashLowStockCount">0</div></div>
                </div>
                <div id="managerChartsWrapper" style="display:none;">
                    <button type="button" class="collapse-btn" onclick="toggleCollapse('managerChartsArea')">üìä Show / Hide Dashboard Charts</button>
                    <div class="dash-grid" id="managerChartsArea" style="display:none;">
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">üìà Last 7 Days Sales Trend</div>
                            <div class="chart-container"><canvas id="dashSalesChart"></canvas></div>
                        </div>
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">üì¶ Top 5 Selling Items</div>
                            <div class="chart-container"><canvas id="dashItemChart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--primary); padding-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--primary);">‚ö° Quick Access</div>
                        <div style="font-size:9px; color:#94a3b8; font-weight:500; font-style:italic;">updates with your usage</div>
                    </div>
                    <div id="dashQuickAccess" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <div style="text-align:center; padding:14px 8px; background:var(--bg); border-radius:12px; color:#94a3b8; font-size:12px; grid-column:1/-1;">Navigate the app to build your shortcut list</div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--danger);">
                    <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--danger); margin-bottom:10px;">‚ö†Ô∏è Refill Alert ‚Äî Stock ‚â§ 5</div>
                    <div id="dashLowStockList" style="font-size:13px; color:#64748b; max-height:150px; overflow-y:auto;">Loading...</div>
                </div>
            </div>

            <!-- ORDER PANEL -->
            <div id="view-order" class="view">
                <div class="card">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="orderShop" class="input-field" style="margin-bottom:8px; margin-top:8px;" onchange="showOrderDueAlert(this.value)"><option value="">-- Select Shop --</option></select>
                    <div id="orderDueAlert" style="display:none;"></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">Search & Add Items</div>
                    <input type="text" id="orderItemInput" list="orderItemDatalist" class="input-field" placeholder="üîç Type item name to search..." oninput="showPriceInfo()" autocomplete="off">
                    <datalist id="orderItemDatalist"></datalist>
                    <div class="toggle-box">
                        <label><input type="radio" name="priceMode" value="auto" checked onchange="togglePriceMode()"> ü§ñ Auto Price</label>
                        <label style="border-left:1px solid var(--border);"><input type="radio" name="priceMode" value="manual" onchange="togglePriceMode()"> ‚úçÔ∏è Manual Price</label>
                    </div>
                    <div id="priceHighlightBox" class="highlight-box"></div>
                    <div id="manualPriceContainer" style="display:none;">
                        <input type="number" id="manualPriceInput" class="input-field" placeholder="Enter manual/discounted price (‚Çπ)">
                    </div>
                    <div id="itemDiscContainer" style="display:none;">
                        <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:6px; letter-spacing:0.5px;">Extra Discount on this Item</div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                            <input type="number" id="itemDiscInput" class="input-field" placeholder="Discount %" min="0" max="100" style="margin-bottom:0; flex:1;" oninput="updateDiscPreview()">
                            <span id="discPricePreview" style="font-size:13px; font-weight:700; color:var(--success); white-space:nowrap;"></span>
                        </div>
                    </div>
                    <div class="flex-between">
                        <input type="number" id="orderQty" class="input-field" placeholder="Qty" style="margin-bottom:0; flex:1;">
                        <button class="btn btn-outline" onclick="addToCart()" style="margin-bottom:0; width:70px; margin-left:10px;">Add</button>
                        <button class="btn btn-outline" onclick="undoCart()" style="margin-bottom:0; width:75px; margin-left:10px; border-color:var(--warning); color:var(--warning);">Undo</button>
                    </div>
                </div>
                <div class="card" id="cartCard" style="display:none;">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">üõí Cart Items</div>
                    <div id="cartList"></div>
                    <div class="flex-between" style="margin-top:15px; font-weight:700; font-size:15px;">
                        <span>Total:</span><span id="cartTotal" style="color:var(--primary); font-size:20px;">‚Çπ 0.00</span>
                    </div>
                    <button class="btn btn-success" onclick="placeFinalOrder()" id="btnPlace" style="margin-top:15px;">Place Final Order</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="view-history" class="view">
                <div id="historyList"><div style="text-align:center; padding:20px; color:#64748b;">Loading...</div></div>
            </div>

            <!-- BILLING -->
            <div id="view-billing" class="view">
                <div class="card no-print">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Order to Generate Bill</label>
                    <select id="billingSelect" class="input-field" onchange="renderA5Bill()" style="margin-top:8px;"><option value="">-- Choose an Order --</option></select>
                </div>
                <div id="bill-preview-section" style="display:none;">
                    <div class="flex-between no-print" style="margin-bottom:15px;">
                        <button class="btn btn-outline" onclick="window.print()" style="margin-bottom:0; flex:1;">üñ®Ô∏è Print</button>
                        <button class="btn btn-success" onclick="downloadA5PDF()" style="margin-bottom:0; flex:1; margin-left:10px;">üíæ Save PDF</button>
                        <button class="btn btn-whatsapp" onclick="shareWhatsApp()" style="margin-bottom:0; flex:1; margin-left:10px;">üí¨ WhatsApp</button>
                    </div>
                    <div id="a5-print-zone" class="bill-container">
                        <div class="bill-header">
                            <h1>Order With Me</h1>
                            <p style="margin:4px 0 0; color:#64748b; font-size:12px;">Official Retail Invoice</p>
                        </div>
                        <div class="bill-meta">
                            <div><strong>Billed To:</strong><br><span id="b-shopName">Shop Name</span><br><span id="b-shopPhone" style="color:#64748b;">Phone</span></div>
                            <div style="text-align:right;"><strong>Date:</strong> <span id="b-date">DD/MM/YYYY</span><br><strong>Sales Rep:</strong> <span id="b-salesman">Name</span><br><strong>Bill No:</strong> <span id="b-orderId">#0000</span></div>
                        </div>
                        <table class="bill-table">
                            <thead><tr><th style="width:10%;">Sl</th><th style="width:50%;">Description</th><th style="width:15%;">Qty</th><th style="width:25%; text-align:right;">Amount</th></tr></thead>
                            <tbody id="b-itemsBody"></tbody>
                        </table>
                        <div class="bill-total">Grand Total: ‚Çπ <span id="b-grandTotal">0.00</span></div>
                        <div style="margin-top:16px; font-size:11px; color:#64748b; text-align:center;">
                            <p style="margin:2px 0;">Computer generated invoice. No signature required.</p>
                            <p style="margin:2px 0;">Thank you for your business!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STOCK -->
            <div id="view-stock" class="view">
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <div>
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Inventory Status</h3>
                        <div style="font-size:14px; font-weight:700; color:var(--primary); margin-top:4px;">Total Value: <span id="stockTotalValue">‚Çπ 0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <input type="text" id="stockSearch" onkeyup="filterStock()" placeholder="üîç Search item..." class="input-field" style="margin-bottom:6px; padding:8px 12px; min-width:180px;">
                        <div>
                            <button onclick="exportAnyTable('stockDataArea','Inventory_Stock_Report')" class="btn-outline" style="padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; font-family:inherit;">üìÑ PDF</button>
                            <button onclick="exportDataExcel(stockDataArray,'Inventory_Stock_Report')" class="btn-success" style="border:none; color:white; padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; margin-left:5px; font-family:inherit;">üì• Excel</button>
                        </div>
                    </div>
                </div>
                <div class="card table-wrapper" id="stockDataArea">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Selling Price (‚Çπ)</th>
                                <th class="mgr-only-col">Purchase Price (‚Çπ)</th>
                                <th>Disc (%)</th>
                                <th class="mgr-action no-print" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SALES -->
            <div id="view-sales" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Sales Ledger</h3>
                    <div>
                        <button onclick="exportAnyTable('salesDataArea','Sales_Ledger_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">üìÑ PDF</button>
                        <button onclick="exportDataExcel(salesDataArray,'Sales_Ledger_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">üì• Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="salesDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date & Time</th><th>Party/Shop</th><th>Items Sold</th><th>Total (‚Çπ)</th><th>Salesman</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PURCHASE -->
            <div id="view-purchase" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Purchase History</h3>
                    <div>
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)" style="display:none;">
                        <button onclick="document.getElementById('importExcelFile').click()" class="btn-outline mgr-action" style="padding:5px 10px; display:none; font-family:inherit;">üì§ Import</button>
                        <button onclick="exportAnyTable('purchaseDataArea','Purchase_History_Report')" class="btn-outline" style="padding:5px 10px; margin-left:5px; font-family:inherit;">üìÑ PDF</button>
                        <button onclick="exportDataExcel(purchaseDataArray,'Purchase_History_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">üì• Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="purchaseDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Product</th><th>Added Qty</th><th>Selling Price (‚Çπ)</th><th class="mgr-only-col">Cost Price (‚Çπ)</th><th>Dealer/Info</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="purchaseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="view-reports" class="view">
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">üìà Advanced Report Filter</div>
                        <span class="ch-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">üìÖ Quick Date</div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="applyDatePreset('today', this)">Today</button>
                                <button class="preset-btn" onclick="applyDatePreset('yesterday', this)">Yesterday</button>
                                <button class="preset-btn" onclick="applyDatePreset('week', this)">This Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastweek', this)">Last Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('month', this)">This Month</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastmonth', this)">Last Month</button>
                            </div>
                        </div>
                        <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">üéØ Filters</div>
                        <div class="report-filter-bar">
                            <input type="date" id="repStartDate" onchange="clearPresets()" title="Start Date">
                            <input type="date" id="repEndDate" onchange="clearPresets()" title="End Date">
                        </div>
                        <div class="report-filter-bar">
                            <select id="repShop"><option value="all">All Shops</option></select>
                            <select id="repItem"><option value="all">All Items</option></select>
                            <select id="repSalesman"><option value="all">All Salesmen</option></select>
                        </div>
                        <div class="report-filter-bar">
                            <input type="number" id="repMinAmount" placeholder="Min ‚Çπ" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            <input type="number" id="repMaxAmount" placeholder="Max ‚Çπ" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:4px;">
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">üìä Sort By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="sortOptions">
                                    <div class="sort-option active-sort" onclick="setSortOption('date-desc', this)" style="font-size:11px; padding:7px 8px;">üìÖ Newest</div>
                                    <div class="sort-option" onclick="setSortOption('date-asc', this)" style="font-size:11px; padding:7px 8px;">üìÖ Oldest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-desc', this)" style="font-size:11px; padding:7px 8px;">üí∞ Highest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-asc', this)" style="font-size:11px; padding:7px 8px;">üí∞ Lowest</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">üóÇÔ∏è Group By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="groupOptions">
                                    <div class="sort-option active-sort" onclick="setGroupOption('none', this)" style="font-size:11px; padding:7px 8px;">üö´ None</div>
                                    <div class="sort-option" onclick="setGroupOption('shop', this)" style="font-size:11px; padding:7px 8px;">üè™ Shop</div>
                                    <div class="sort-option" onclick="setGroupOption('salesman', this)" style="font-size:11px; padding:7px 8px;">üë§ Salesman</div>
                                    <div class="sort-option" onclick="setGroupOption('date', this)" style="font-size:11px; padding:7px 8px;">üìÖ Date</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:14px;">
                            <button class="btn btn-success" onclick="generateCustomReport()" style="margin-bottom:0; flex:2;">üîç Generate</button>
                            <button class="btn btn-outline" onclick="resetReportFilters()" style="margin-bottom:0; flex:1;">‚Ü∫ Reset</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">üí≥ Shop Payment History Report</div>
                        <span class="ch-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px; margin-bottom:12px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Filter by Shop</div>
                            <div class="report-filter-bar">
                                <select id="payRepShopSel"><option value="all">All Shops</option></select>
                                <input type="date" id="payRepStart" title="From date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                                <input type="date" id="payRepEnd" title="To date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            </div>
                            <button class="btn btn-success" onclick="generatePaymentReport()" style="margin-bottom:0; margin-top:4px;">üìä Generate Payment Report</button>
                        </div>
                        <div id="payRepResultArea" style="display:none; margin-top:8px;">
                            <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Billed</div><div class="rsm-val" style="color:var(--primary);" id="payRepTotalBill">‚Çπ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Paid</div><div class="rsm-val" style="color:var(--success);" id="payRepTotalPaid">‚Çπ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Remaining Due</div><div class="rsm-val" style="color:var(--danger);" id="payRepRemaining">‚Çπ 0.00</div></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Payment Details <span id="payRepCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('payRepDataArea','Payment_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">üìÑ PDF</button>
                                    <button onclick="exportDataExcel(paymentReportArray,'Payment_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">üì• Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="payRepDataArea" style="margin-bottom:0;">
                                <table class="data-table" id="payRepTable">
                                    <thead><tr><th>Date</th><th>Shop</th><th>Amount Paid (‚Çπ)</th><th>Note</th><th>Recorded By</th></tr></thead>
                                    <tbody id="payRepTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reportResultArea" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap;">
                        <div class="report-stat-mini"><div class="rsm-lbl">Total Sales</div><div class="rsm-val" style="color:var(--success);" id="repTotalAmount">‚Çπ 0.00</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Items Sold</div><div class="rsm-val" style="color:var(--primary);" id="repTotalQty">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Orders</div><div class="rsm-val" style="color:var(--warning);" id="repOrderCount">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Avg Order</div><div class="rsm-val" style="color:var(--secondary);" id="repAvgOrder">‚Çπ 0.00</div></div>
                    </div>
                    <div id="reportChartWrapper" style="display:none; margin-bottom:14px;">
                        <button type="button" class="collapse-btn" onclick="toggleCollapse('reportChartCard')">üìä Show / Hide Report Chart</button>
                        <div class="card chart-container" id="reportChartCard" style="display:none; margin-bottom:0; margin-top:10px; height:280px;">
                            <canvas id="reportChart"></canvas>
                        </div>
                    </div>
                    <div class="flex-between" style="margin-bottom:10px;">
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Report Data <span id="repDataCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                        <div>
                            <button onclick="exportAnyTable('repDataArea','Custom_Filtered_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">üìÑ PDF</button>
                            <button onclick="exportDataExcel(customReportArray,'Custom_Filtered_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">üì• Excel</button>
                        </div>
                    </div>
                    <div class="card table-wrapper" id="repDataArea">
                        <table class="data-table" id="repMainTable">
                            <thead id="repTableHead"><tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (‚Çπ)</th><th>Salesman</th></tr></thead>
                            <tbody id="repTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="view-admin" class="view">
                <div class="card daily-pass-card">
                    <div style="font-weight:700; margin-bottom:4px; font-size:15px;">üîê Daily Registration Password</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">A new password is generated every day.</p>
                    <div id="passLockedView">
                        <div class="pass-locked-msg"><span class="lock-icon">üîí</span>Enter Master password to view today's password</div>
                        <div class="master-unlock">
                            <input type="password" id="masterPassInput" class="input-field" placeholder="Master Password..." onkeydown="if(event.key==='Enter') unlockDailyPass()">
                            <button class="btn btn-outline" onclick="unlockDailyPass()" style="width:auto;">Unlock üîì</button>
                        </div>
                    </div>
                    <div id="passUnlockedView" style="display:none;">
                        <div class="pass-display" id="dailyPassDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        <div class="pass-validity">‚úÖ Valid for today only &nbsp;|&nbsp; üìÖ <span id="passValidDate"></span></div>
                        <button class="btn btn-outline" onclick="copyDailyPass()" style="margin-top:12px; margin-bottom:0;">üìã Copy Password</button>
                        <button class="btn" onclick="lockDailyPass()" style="margin-top:8px; margin-bottom:0; background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 15px rgba(244,63,94,0.3); font-size:12px; padding:10px;">üîí Lock Again</button>
                    </div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">Add/Manage Shop</div>
                    <input type="text" id="shopName" class="input-field" placeholder="Shop Name">
                    <input type="tel" id="shopPhone" class="input-field" placeholder="Phone Number">
                    <input type="text" id="shopAddr" class="input-field" placeholder="Address">
                    <button class="btn btn-outline" onclick="addShop()">Save Shop</button>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:4px; font-size:15px;">Add/Refill Product</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:12px;">This will automatically record in Purchase History.</p>
                    <input type="text" id="prodName" class="input-field" placeholder="Product Name" list="adminProductList">
                    <datalist id="adminProductList"></datalist>
                    <div class="flex-between">
                        <input type="number" id="prodStock" class="input-field" placeholder="New Stock (+)">
                        <input type="number" id="prodPrice" class="input-field" placeholder="Price (‚Çπ)">
                    </div>
                    <input type="text" id="purchaseInfo" class="input-field" placeholder="Dealer/Bill Info">
                    <input type="number" id="prodCostPrice" class="input-field" placeholder="Cost Price (‚Çπ)">
                    <button class="btn btn-outline" onclick="addProduct()">Save & Log Purchase</button>
                </div>
                <div class="card" style="border:1.5px solid rgba(244,63,94,0.3);">
                    <div style="font-weight:700; margin-bottom:8px; color:var(--danger); font-size:15px;">Delete Shop / Product</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">Careful: This action cannot be undone.</p>
                    <div class="flex-between">
                        <select id="delShopSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Shop to Delete --</option></select>
                        <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteShop()">Delete</button>
                    </div>
                    <div class="flex-between" style="margin-top:14px;">
                        <select id="delItemSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Item to Delete --</option></select>
                        <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteProductFromAdmin()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- DUE / CREDIT VIEW -->
            <div id="view-due" class="view">
                <div class="card mgr-due-add" style="display:none; border:1.5px solid rgba(16,185,129,0.3);">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">üí≥ Record Payment</div>
                    <p style="font-size:11px; color:#64748b; margin-top:0; margin-bottom:14px;">Selecting a shop will automatically show the total bill and balance.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="dueShopSel" class="input-field" onchange="onDueShopChange()" style="margin-top:6px;"><option value="">-- Select Shop --</option></select>
                    <div id="dueShopBillSummary" style="display:none; background:var(--bg); border-radius:14px; padding:16px; margin-bottom:14px; border:1px solid var(--border);">
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">üì¶ Total Orders Amount</span><span id="dueShopTotalBill" style="font-weight:700; color:var(--text);">‚Çπ 0.00</span></div>
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">‚úÖ Total Paid</span><span id="dueShopTotalPaid" style="font-weight:700; color:var(--success);">‚Çπ 0.00</span></div>
                        <div class="due-progress-wrap"><div id="dueShopProgressBar" class="due-progress-bar" style="width:0%; background:var(--danger);"></div></div>
                        <div class="due-total-row"><span>üî¥ Remaining Due</span><span id="dueShopRemaining" style="color:var(--danger); font-size:18px;">‚Çπ 0.00</span></div>
                    </div>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Payment Amount (‚Çπ)</label>
                    <input type="number" id="duePayAmt" class="input-field" placeholder="How much did they pay?" style="margin-top:6px;">
                    <input type="text" id="dueNote" class="input-field" placeholder="Note (optional)">
                    <button class="btn btn-success" onclick="saveDueEntry()" style="margin-bottom:0;">üí∞ Save Payment</button>
                </div>
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">üí≥ Due / Credit Tracker</h3>
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#64748b;">Total Remaining Due</div>
                            <div id="totalDueAmt" style="font-size:20px; font-weight:800; color:var(--danger);">‚Çπ 0.00</div>
                        </div>
                        <button onclick="exportDuePDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap;">üìÑ All Shops PDF</button>
                        <button onclick="exportDuePerShopPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid #10b981; background:transparent; color:#10b981; font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; margin-left:6px;">üìÑ Per Shop PDF</button>
                    </div>
                </div>
                <div id="dueListArea"><div style="text-align:center; padding:40px; color:#64748b;">Loading...</div></div>
                <div id="due-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- RETURNS ‚Äî MANAGER ONLY -->
            <div id="view-returns" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">‚Ü©Ô∏è Process Return / Refund</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Select an order, then choose which items to return. Stock will be restored automatically.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Select Original Order</label>
                    <select id="returnOrderSel" class="input-field" onchange="loadReturnItems()" style="margin-top:6px;"><option value="">-- Select Order --</option></select>
                    <div id="returnItemsArea" style="display:none; margin-top:10px;">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Select Items to Return</div>
                        <div id="returnItemsList"></div>
                        <input type="text" id="returnReason" class="input-field" placeholder="Return reason (optional)" style="margin-top:10px;">
                        <button class="btn" style="background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 15px rgba(245,158,11,0.3); margin-top:4px;" onclick="processReturn()">‚Ü©Ô∏è Process Return</button>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Return History</h3>
                    <button onclick="exportReturnsPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">üìÑ PDF</button>
                </div>
                <div id="returnHistoryList"><div style="text-align:center; padding:20px; color:#64748b;">No returns yet.</div></div>
                <div id="returns-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SALESMAN PERFORMANCE -->
            <div id="view-salesman-perf" class="view">
                <div class="flex-between" style="margin-bottom:6px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">üèÖ Salesman Performance</h3>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="preset-btn active-preset" onclick="setPerfPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPerfPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPerfPeriod('week',this)">This Week</button>
                        <button class="preset-btn" onclick="setPerfPeriod('today',this)">Today</button>
                    </div>
                </div>
                <div id="perfSummaryCards" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;"></div>
                <div id="perfLeaderboard"></div>
                <div id="perfChartWrapper" style="display:none; margin-top:14px;">
                    <div class="card">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Comparison Chart</div>
                        <div style="position:relative; height:220px;"><canvas id="perfChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- P&L -->
            <div id="view-pnl" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">üìä Profit &amp; Loss Statement</h3>
                </div>
                <div class="card" style="padding:14px; margin-bottom:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="preset-btn active-preset" onclick="setPnlPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPnlPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('lastmonth',this)">Last Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('week',this)">This Week</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="date" id="pnlStart" class="input-field" style="margin-bottom:0;">
                        <input type="date" id="pnlEnd" class="input-field" style="margin-bottom:0;">
                    </div>
                    <button class="btn btn-success" onclick="generatePnl()" style="margin-top:10px; margin-bottom:0;">Calculate P&amp;L</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                    <div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">üí∞</span><div class="dc-lbl">Total Revenue</div><div class="dc-val" id="pnlRevenue">‚Çπ 0.00</div></div>
                    <div class="dash-card dc-alert" style="cursor:default;"><span class="dc-icon">üìâ</span><div class="dc-lbl">Total Cost</div><div class="dc-val" id="pnlCost">‚Çπ 0.00</div></div>
                    <div class="dash-card dc-orders" style="cursor:default; grid-column:1/-1;"><span class="dc-icon">üèÜ</span><div class="dc-lbl">Net Profit / Loss</div><div class="dc-val" id="pnlNet">‚Çπ 0.00</div></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; font-size:14px; margin-bottom:14px; color:var(--text);">Detailed Breakdown</div>
                    <div class="pnl-row"><span>üì¶ Total Items Sold (Qty)</span><span id="pnlQty" style="font-weight:700;">0</span></div>
                    <div class="pnl-row"><span>üßæ Revenue from Sales</span><span id="pnlRevDetail" style="color:var(--success); font-weight:700;">‚Çπ 0.00</span></div>
                    <div class="pnl-row"><span>üìâ Cost of Goods Sold</span><span id="pnlCostDetail" style="color:var(--danger); font-weight:700;">‚Çπ 0.00</span></div>
                    <div class="pnl-row"><span>‚Ü©Ô∏è Returns Deduction</span><span id="pnlReturnsDetail" style="color:var(--warning); font-weight:700;">- ‚Çπ 0.00</span></div>
                    <div class="pnl-row"><span>üìä Gross Margin %</span><span id="pnlMargin" style="font-weight:700;">0%</span></div>
                    <div class="pnl-total-row"><span>üèÜ Net Profit / Loss</span><span id="pnlNetDetail" style="color:var(--primary);">‚Çπ 0.00</span></div>
                </div>
                <div class="card" style="margin-top:0;">
                    <div style="font-weight:700; font-size:14px; margin-bottom:12px;">Top Items by Profit</div>
                    <div id="pnlTopItems"></div>
                </div>
            </div>

            <!-- SHOP VISITS -->
            <div id="view-visits" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:12px;">üìç Log Shop Visit</div>
                    <select id="visitShopSel" class="input-field"><option value="">-- Select Shop Visited --</option></select>
                    <input type="text" id="visitNote" class="input-field" placeholder="Notes (e.g., new order placed, shop closed...)">
                    <button class="btn btn-success" onclick="logVisit()" style="margin-bottom:0;">üìç Log Visit</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <button class="preset-btn active-preset" onclick="setVisitFilter('all',this)">All Visits</button>
                        <button class="preset-btn" onclick="setVisitFilter('today',this)">Today</button>
                        <button class="preset-btn" onclick="setVisitFilter('week',this)">This Week</button>
                        <select id="visitSalesmanFilter" class="input-field" onchange="renderVisits()" style="margin-bottom:0; flex:1; padding:7px 10px; min-width:120px;"><option value="all">All Salesmen</option></select>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Visit Log <span id="visitCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="exportVisitsPDF()" style="padding:5px 10px; border-radius:8px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">üìÑ PDF</button>
                        <button onclick="exportDataExcel(visitExportArray,'Shop_Visit_Log')" class="btn-success" style="padding:5px 10px; border:none; color:white; font-family:inherit; cursor:pointer; border-radius:8px; font-size:12px;">üì• Excel</button>
                    </div>
                </div>
                <div id="visitListArea"><div style="text-align:center; padding:20px; color:#64748b;">No visits logged yet.</div></div>
                <div id="visits-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SHOP NOTES -->
            <div id="view-shop-notes" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">üìù Add Shop Note / Remark</div>
                    <p style="font-size:11px; color:#64748b; margin:0 0 12px;">Notes are visible to the whole team.</p>
                    <select id="noteShopSel" class="input-field" style="margin-bottom:10px;"><option value="">-- Select Shop --</option></select>
                    <select id="noteTag" class="input-field" style="margin-bottom:10px;">
                        <option value="general">üìå General Remark</option>
                        <option value="payment">üí∞ Payment Reminder</option>
                        <option value="closed">üö´ Shop Closed Info</option>
                        <option value="complaint">‚ö†Ô∏è Complaint / Issue</option>
                        <option value="preference">‚≠ê Customer Preference</option>
                    </select>
                    <textarea id="noteText" class="input-field" placeholder="Write your note here..." rows="3" style="resize:vertical; min-height:70px;"></textarea>
                    <button class="btn btn-success" onclick="saveShopNote()" style="margin-bottom:0;">üíæ Save Note</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <select id="noteFilterShop" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;"><option value="all">All Shops</option></select>
                        <select id="noteFilterTag" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;">
                            <option value="all">All Types</option>
                            <option value="general">üìå General</option>
                            <option value="payment">üí∞ Payment</option>
                            <option value="closed">üö´ Closed Info</option>
                            <option value="complaint">‚ö†Ô∏è Complaint</option>
                            <option value="preference">‚≠ê Preference</option>
                        </select>
                    </div>
                    <div id="shopNotesArea"><div style="text-align:center; padding:20px; color:#64748b;">No notes yet.</div></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDRm8zdyHdYmaXm5o34GTV3uYkrMPfVfGI",
            authDomain: "order-with-me-636dd.firebaseapp.com",
            projectId: "order-with-me-636dd",
            storageBucket: "order-with-me-636dd.firebasestorage.app",
            messagingSenderId: "437851738821",
            appId: "1:437851738821:web:d923816bfd764793db96ac"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let userData = {}, cart = [], historyData = [];
        let globalShops = {};
        let stockDataArray = [], salesDataArray = [], purchaseDataArray = [], customReportArray = [], paymentReportArray = [];
        let productsMap = {};
        let dashSalesChartInstance = null, dashItemChartInstance = null, reportChartInstance = null, perfChartInstance = null;
        let currentSortOption = 'date-desc';
        let currentGroupOption = 'none';
        let allVisitsData = [], visitFilterPeriod = 'all', visitExportArray = [];
        let allDueData = {}, allReturnsData = [];
        let perfPeriod = 'all', pnlPeriod = 'all';
        let menuEditMode = false;
        let dragSrcEl = null;
        let dragSrcIdx = -1;

        // ===== UNDO SYSTEM =====
        let undoStack = [];  // {type, data, execute}
        let undoTimer = null;
        let undoRingTimer = null;
        const UNDO_DURATION = 5000;

        function pushUndo(label, undoFn) {
            clearUndoTimer();
            undoStack.push({ label, undoFn });
            document.getElementById('undo-msg').textContent = label;
            const bar = document.getElementById('undo-bar');
            bar.classList.add('visible');
            const ring = document.getElementById('undo-ring');
            ring.style.transition = 'none';
            ring.style.strokeDashoffset = '0';
            requestAnimationFrame(() => {
                ring.style.transition = `stroke-dashoffset ${UNDO_DURATION}ms linear`;
                ring.style.strokeDashoffset = '72';
            });
            undoTimer = setTimeout(() => {
                dismissUndo();
            }, UNDO_DURATION);
        }

        function clearUndoTimer() {
            if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
        }

        function dismissUndo() {
            clearUndoTimer();
            undoStack = [];
            document.getElementById('undo-bar').classList.remove('visible');
        }

        async function executeUndo() {
            clearUndoTimer();
            document.getElementById('undo-bar').classList.remove('visible');
            if (!undoStack.length) return;
            const item = undoStack.pop();
            try {
                await item.undoFn();
                toast('‚Ü© ' + item.label + ' ‚Äî Undone!', 'success');
            } catch(e) {
                toast('Undo failed: ' + e.message, 'error');
            }
            undoStack = [];
        }

        // ===== MENU CONFIGURATION =====
        // FIX: Returns is now manager-only
        const DEFAULT_MENU_ITEMS = [
            { id: 'dashboard', label: 'üìä Dashboard', view: 'dashboard', roles: ['salesman','manager'], always: true },
            { id: 'order', label: 'üõí Order Panel', view: 'order', roles: ['salesman','manager'], always: true },
            { id: 'history', label: 'üìú All Orders', view: 'history', roles: ['salesman','manager'], always: true },
            { id: 'billing', label: 'üßæ Billing & Invoice', view: 'billing', roles: ['manager'] },
            { id: 'sep1', type: 'separator', label: 'Business Ledgers' },
            { id: 'stock', label: 'üì¶ Current Stock', view: 'stock', roles: ['salesman','manager'], always: true },
            { id: 'sales', label: 'üí∞ Sales Ledger', view: 'sales', roles: ['manager'] },
            { id: 'purchase', label: 'üìâ Purchase History', view: 'purchase', roles: ['manager'] },
            { id: 'reports', label: 'üìà Custom Reports', view: 'reports', roles: ['manager'] },
            { id: 'due', label: 'üí≥ Due / Credit', view: 'due', roles: ['manager'] },
            { id: 'returns', label: '‚Ü©Ô∏è Returns', view: 'returns', roles: ['manager'] },  // FIXED: manager only
            { id: 'salesman-perf', label: 'üèÖ Salesman Performance', view: 'salesman-perf', roles: ['manager'] },
            { id: 'pnl', label: 'üìä P&L Statement', view: 'pnl', roles: ['manager'] },
            { id: 'visits', label: 'üìç Shop Visits', view: 'visits', roles: ['salesman','manager'], always: true },
            { id: 'shop-notes', label: 'üìù Shop Notes', view: 'shop-notes', roles: ['salesman','manager'], always: true },
            { id: 'sep2', type: 'separator', label: '' },
            { id: 'admin', label: '‚öôÔ∏è Manager Panel', view: 'admin', roles: ['manager'], special: true },
        ];
        let menuConfig = null;

        // ===== QUICK ACCESS ‚Äî Feature Usage Tracking =====
        const USAGE_KEY = 'owm_feature_usage_';
        const QUICK_ACCESS_MENU = [
            { id:'order',         label:'üõí New Order',        icon:'üõí' },
            { id:'history',       label:'üìã History',           icon:'üìã' },
            { id:'billing',       label:'üßæ Billing',           icon:'üßæ' },
            { id:'stock',         label:'üì¶ Stock',             icon:'üì¶' },
            { id:'reports',       label:'üìä Reports',           icon:'üìä' },
            { id:'due',           label:'üí≥ Due/Credit',        icon:'üí≥' },
            { id:'returns',       label:'‚Ü©Ô∏è Returns',           icon:'‚Ü©Ô∏è' },
            { id:'salesman-perf', label:'üèÖ Performance',       icon:'üèÖ' },
            { id:'pnl',           label:'üìà P&L',               icon:'üìà' },
            { id:'visits',        label:'üìç Shop Visits',       icon:'üìç' },
            { id:'admin',         label:'‚öôÔ∏è Manager Panel',     icon:'‚öôÔ∏è' },
            { id:'shops',         label:'üè™ Shops',             icon:'üè™' },
            { id:'dashboard',     label:'üè† Dashboard',         icon:'üè†' },
        ];

        function _usageKey() {
            return USAGE_KEY + (userData.user || 'default');
        }

        function trackUsage(viewId) {
            if (!viewId || viewId === 'dashboard') return;
            try {
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};
                counts[viewId] = (counts[viewId] || 0) + 1;
                localStorage.setItem(_usageKey(), JSON.stringify(counts));
                // Only re-render if dashboard is currently visible
                const dash = document.getElementById('view-dashboard');
                if (dash && dash.classList.contains('active')) renderQuickAccess();
            } catch(e) {}
        }

        function renderQuickAccess() {
            const el = document.getElementById('dashQuickAccess');
            if (!el) return;
            try {
                const role = userData.role || 'salesman';
                const managerOnly = ['reports','salesman-perf','pnl','admin','shops'];
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};

                // All menu items allowed for this user role (exclude dashboard itself)
                const available = QUICK_ACCESS_MENU.filter(m => {
                    if (m.id === 'dashboard') return false;
                    return role === 'manager' || !managerOnly.includes(m.id);
                });

                // Sort by usage count desc; preserve order for zero-count ties
                const sorted = [...available].sort((a, b) => (counts[b.id] || 0) - (counts[a.id] || 0));
                const top4 = sorted.slice(0, 4);
                const hasUsage = available.some(m => (counts[m.id] || 0) > 0);
                const maxCount = hasUsage ? (counts[top4[0]?.id] || 0) : 0;

                el.innerHTML = top4.map((meta, i) => {
                    const count = counts[meta.id] || 0;
                    const isHot = hasUsage && i === 0 && count > 0;
                    const label = meta.label.replace(meta.icon, '').trim();
                    return `<button class="qa-btn" onclick="switchView('${meta.id}')" title="${label}">
                        ${isHot ? '<span class="qa-badge">üî•</span>' : ''}
                        <span class="qa-btn-icon">${meta.icon}</span>
                        <span class="qa-btn-label">${label}</span>
                        <span class="qa-btn-count">${count > 0 ? count + ' uses' : 'tap to use'}</span>
                    </button>`;
                }).join('');

                if (!hasUsage) {
                    el.innerHTML += `<div style="font-size:10px;color:#94a3b8;text-align:center;
                        grid-column:1/-1;margin-top:2px;padding:3px 0;">
                        Updates automatically as you use the app ‚ú®</div>`;
                }
            } catch(e) {
                el.innerHTML = '<div style="color:#94a3b8;font-size:12px;text-align:center;grid-column:1/-1;padding:12px;">No data yet</div>';
            }
        }



        function getMenuConfig() {
            try {
                const saved = localStorage.getItem('owm_menu_order_' + (userData.user||'default'));
                if (saved) {
                    const arr = JSON.parse(saved);
                    const existingIds = arr.map(i => i.id);
                    DEFAULT_MENU_ITEMS.forEach(def => {
                        if (!existingIds.includes(def.id)) arr.push(def);
                    });
                    // Sync roles from DEFAULT in case they changed
                    arr.forEach(item => {
                        const def = DEFAULT_MENU_ITEMS.find(d => d.id === item.id);
                        if (def) item.roles = def.roles;
                    });
                    return arr;
                }
            } catch(e) {}
            return JSON.parse(JSON.stringify(DEFAULT_MENU_ITEMS));
        }

        function saveMenuConfig(config) {
            try {
                localStorage.setItem('owm_menu_order_' + (userData.user||'default'), JSON.stringify(config));
            } catch(e) {}
        }

        // ===== DRAG & DROP STATE =====
        let _dragListenersAttached = false;

        function _attachNavDragListeners() {
            // Called ONCE. The nav element never changes after this.
            const nav = document.getElementById('sidebarNavArea');
            if (!nav) return;

            nav.addEventListener('dragstart', function(e) {
                // Try from target first, then walk up
                let item = _draggableParent(e.target);
                // Fallback: if target itself has itemId (direct drag on the element)
                if (!item && e.target && e.target.dataset && e.target.dataset.itemId) item = e.target;
                if (!item) { e.preventDefault(); return; }
                dragSrcEl = item;
                dragSrcIdx = Array.from(nav.children).indexOf(item);
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setData('text/plain', item.dataset.itemId || ''); } catch(_) {}
                setTimeout(() => { if(dragSrcEl) dragSrcEl.classList.add('dragging'); }, 0);
            });

            nav.addEventListener('dragover', function(e) {
                e.preventDefault();
                const item = _draggableParent(e.target);
                if (!item || item === dragSrcEl) return;
                nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                item.classList.add('drag-over');
            });

            nav.addEventListener('dragleave', function(e) {
                if (!nav.contains(e.relatedTarget)) {
                    nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                }
            });

            nav.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dst = _draggableParent(e.target);
                if (!dragSrcEl || !dst || dragSrcEl === dst) { _clearDragState(); return; }
                const srcId = dragSrcEl.dataset.itemId;
                const dstId = dst.dataset.itemId;
                if (!srcId || !dstId || srcId === dstId) { _clearDragState(); return; }
                const si = menuConfig.findIndex(x => x.id === srcId);
                const di = menuConfig.findIndex(x => x.id === dstId);
                if (si === -1 || di === -1) { _clearDragState(); return; }
                const [moved] = menuConfig.splice(si, 1);
                menuConfig.splice(di, 0, moved);
                saveMenuConfig(menuConfig);
                _clearDragState();
                renderSidebar();
                toast('‚úÖ Menu reordered!', 'success');
            });

            nav.addEventListener('dragend', function(e) {
                _clearDragState();
            });

            _dragListenersAttached = true;
        }

        function _draggableParent(el) {
            // Walk up DOM to find draggable menu item
            while (el && el !== document.body) {
                if (el.dataset && el.dataset.itemId &&
                    (el.classList.contains('menu-item') || el.classList.contains('menu-section-label'))) {
                    return el;
                }
                el = el.parentElement;
            }
            return null;
        }

        function _clearDragState() {
            document.querySelectorAll('#sidebarNavArea .drag-over, #sidebarNavArea .dragging')
                .forEach(el => el.classList.remove('drag-over', 'dragging'));
            dragSrcEl = null;
        }

        function renderSidebar() {
            if (!menuConfig) menuConfig = getMenuConfig();
            const nav = document.getElementById('sidebarNavArea');
            nav.innerHTML = '';
            const role = userData.role || 'salesman';
            const currentView = document.querySelector('.view.active')?.id?.replace('view-', '') || '';

            menuConfig.forEach((item) => {
                if (item.type === 'separator') {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'menu-section-label';
                    labelDiv.dataset.itemId = item.id;
                    if (menuEditMode) labelDiv.setAttribute('draggable', 'true');
                    const handle = document.createElement('span');
                    handle.className = 'drag-handle';
                    handle.textContent = '‚†ø';
                    labelDiv.appendChild(handle);
                    labelDiv.appendChild(document.createTextNode(item.label));
                    nav.appendChild(labelDiv);
                    const hr = document.createElement('hr');
                    hr.className = 'menu-hr';
                    nav.appendChild(hr);
                    return;
                }
                if (!item.roles || !item.roles.includes(role)) return;
                const isActive = currentView === item.view;
                const div = document.createElement('div');
                div.className = 'menu-item' + (isActive ? ' active-menu' : '');
                div.dataset.itemId = item.id;
                div.dataset.view = item.view || '';
                if (menuEditMode) div.setAttribute('draggable', 'true');
                if (item.special) div.style.cssText = 'margin-top:4px;border:1px dashed rgba(99,102,241,0.35);';
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '‚†ø';
                div.appendChild(handle);
                const lbl = document.createElement('span');
                lbl.style.flex = '1';
                lbl.textContent = item.label;
                div.appendChild(lbl);
                if (!menuEditMode) {
                    div.addEventListener('click', () => switchView(item.view));
                }
                nav.appendChild(div);
            });

            // Attach drag listeners once, on first render
            if (!_dragListenersAttached) _attachNavDragListeners();
        }

        function toggleMenuEditMode() {
            menuEditMode = !menuEditMode;
            const btn = document.getElementById('menuEditBtn');
            const hint = document.getElementById('menuEditHint');
            document.body.classList.toggle('menu-edit-mode', menuEditMode);
            if (menuEditMode) {
                btn.textContent = '‚úÖ Done';
                btn.classList.add('active-edit');
                hint.style.display = 'block';
            } else {
                btn.textContent = '‚úèÔ∏è Customize';
                btn.classList.remove('active-edit');
                hint.style.display = 'none';
                saveMenuConfig(menuConfig);
                toast('‚úÖ Menu order saved!', 'success');
            }
            renderSidebar();
        }

        // ===== COLLAPSIBLE =====
        function toggleCollapsible(header) {
            header.classList.toggle('open');
            const body = header.nextElementSibling;
            body.classList.toggle('open');
        }

        // ===== TOAST =====
        function toast(msg, type="normal") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.borderLeftColor = type==='error' ? '#f43f5e' : '#10b981';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === "none" ? (id === 'managerChartsArea' ? "grid" : "block") : "none";
        }

        // ===== CLOCK =====
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
            const dateStr = now.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
            const el = document.getElementById('realTimeClock');
            if(el) el.innerHTML = `<div style="font-weight:700; font-size:14px;">${timeStr}</div><div style="font-size:10px; opacity:0.75;">${dateStr}</div>`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ===== THEME =====
        let userManualTheme = null;
        function applyTheme(isDark) {
            const themeToggle = document.getElementById('themeToggleCheckbox');
            const themeBtn = document.getElementById('themeToggleBtn');
            const authIcon = document.getElementById('authThemeIcon');
            const authLabel = document.getElementById('authThemeLabel');
            if (isDark) {
                document.body.classList.add('dark-mode');
                if(themeToggle) themeToggle.checked = true;
                if(themeBtn) themeBtn.innerHTML = '‚òÄÔ∏è Light';
                if(authIcon) authIcon.textContent = '‚òÄÔ∏è';
                if(authLabel) authLabel.textContent = 'Light';
            } else {
                document.body.classList.remove('dark-mode');
                if(themeToggle) themeToggle.checked = false;
                if(themeBtn) themeBtn.innerHTML = 'üåô Dark';
                if(authIcon) authIcon.textContent = 'üåô';
                if(authLabel) authLabel.textContent = 'Dark';
            }
        }
        function applySystemTheme() {
            if (userManualTheme !== null) return;
            applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
        }
        function toggleThemeManually() {
            const cb = document.getElementById('themeToggleCheckbox');
            cb.checked = !cb.checked;
            userManualTheme = cb.checked;
            applyTheme(userManualTheme);
        }
        applySystemTheme();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => { if(userManualTheme===null) applyTheme(e.matches); });

        // ===== DAILY PASSWORD =====
        function generateDailyPassword() {
            const now = new Date();
            const seed = now.getFullYear() * 10000 + (now.getMonth()+1) * 100 + now.getDate();
            const mixed = seed ^ (0x4144 ^ 0x1234) ^ 0xAB7F;
            const pool = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
            let pass = '', state = mixed;
            for (let i = 0; i < 8; i++) {
                state = ((state * 1103515245 + 12345) & 0x7FFFFFFF);
                pass += pool[state % pool.length];
            }
            return pass.substring(0,4) + '-' + pass.substring(4,8);
        }
        function checkMasterPassword(input) {
            let h = 0;
            for (let i = 0; i < input.length; i++) h = ((h << 5) - h + input.charCodeAt(i)) | 0;
            return h === -500839080;
        }
        function unlockDailyPass() {
            const masterInput = document.getElementById('masterPassInput').value;
            if (!checkMasterPassword(masterInput)) { toast("‚ùå Incorrect master password!", "error"); document.getElementById('masterPassInput').value=''; return; }
            document.getElementById('masterPassInput').value='';
            const daily = generateDailyPassword();
            const today = new Date().toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            document.getElementById('dailyPassDisplay').innerText = daily;
            document.getElementById('passValidDate').innerText = today;
            document.getElementById('passLockedView').style.display = 'none';
            document.getElementById('passUnlockedView').style.display = 'block';
        }
        function lockDailyPass() {
            document.getElementById('dailyPassDisplay').innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            document.getElementById('passUnlockedView').style.display = 'none';
            document.getElementById('passLockedView').style.display = 'block';
        }
        function copyDailyPass() {
            const pass = document.getElementById('dailyPassDisplay').innerText;
            if(navigator.clipboard) navigator.clipboard.writeText(pass).then(() => toast("‚úÖ Password copied!", "success"));
            else { const el=document.createElement('textarea'); el.value=pass; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); toast("‚úÖ Password copied!", "success"); }
        }

        // ===== AUTH =====
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    userData = doc.data() || {};
                    document.getElementById('sideName').innerText = userData.name || "User";
                    document.getElementById('dashWelcomeName').innerText = userData.name || "User";
                    document.getElementById('sideRole').innerText = userData.role || "Role";
                    const isMgr = (userData.role === 'manager');
                    // Set role class on body for CSS-based hiding
                    document.body.classList.remove('role-salesman', 'role-manager');
                    document.body.classList.add(isMgr ? 'role-manager' : 'role-salesman');
                    document.getElementById('managerChartsWrapper').style.display = isMgr ? 'block' : 'none';
                    document.querySelectorAll('.mgr-action').forEach(el => el.style.display = isMgr ? 'inline-block' : 'none');
                    document.querySelectorAll('.mgr-due-add').forEach(el => el.style.display = isMgr ? 'block' : 'none');
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'block';
                    renderSidebar();
                    switchView('dashboard');
                    loadData();
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function loginUser() {
            const user = document.getElementById('loginUsername').value.toLowerCase().trim().replace(/\s/g,'');
            const pass = document.getElementById('loginPassword').value;
            if(!user||!pass) return toast("Enter username and password","error");
            const btn = document.getElementById('btnLogin');
            btn.innerText="Processing..."; btn.disabled=true;
            try {
                await Promise.race([
                    auth.signInWithEmailAndPassword(user+"@erp.com", pass),
                    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout")), 10000))
                ]);
                toast("Login Successful!","success");
            } catch(e) {
                let msg = e.message;
                if(e.code==='auth/user-not-found') msg="‚ùå Username not found. Please check and try again.";
                else if(e.code==='auth/wrong-password') msg="‚ùå Incorrect password. Please try again.";
                else if(e.code==='auth/invalid-credential') msg="‚ùå Incorrect username or password.";
                else if(e.code==='auth/invalid-email') msg="‚ùå Invalid username format.";
                else if(e.code==='auth/too-many-requests') msg="‚ö†Ô∏è Too many failed attempts. Please wait a moment and try again.";
                else if(e.code==='auth/network-request-failed') msg="üì∂ No internet connection. Check your network.";
                else if(e.message==='Timeout') msg="‚è±Ô∏è Request timed out. Check your connection.";
                else msg="‚ùå Login failed. Please check your credentials.";
                toast(msg,"error");
            } finally { btn.innerText="Login"; btn.disabled=false; }
        }

        async function registerUser() {
            const name=document.getElementById('regName').value.trim();
            const user=document.getElementById('regUser').value.toLowerCase().trim().replace(/\s/g,'');
            const pass=document.getElementById('regPass').value;
            const role=document.getElementById('regRole').value;
            const pin=document.getElementById('pinBox').value;
            if(!(pin===generateDailyPassword()||checkMasterPassword(pin))) return toast("‚ùå Invalid registration password!","error");
            if(!name||!user||pass.length<6) return toast("Please fill all details correctly","error");
            document.getElementById('btnReg').innerText="Processing...";
            try {
                const cred = await auth.createUserWithEmailAndPassword(user+"@erp.com", pass);
                await db.collection("users").doc(cred.user.uid).set({ name, user, role });
                toast("Account Created!","success");
            } catch(e) { toast(e.message,"error"); document.getElementById('btnReg').innerText="Create Account"; }
        }

        function logoutApp() {
            menuConfig = null;
            auth.signOut().then(() => {
                toast("Logged Out", "success");
                document.body.classList.remove('role-salesman', 'role-manager');
                historyData = []; allDueData = {}; allReturnsData = []; allVisitsData = [];
                globalShops = {}; productsMap = {};
            });
        }
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
            document.body.style.overflow = document.getElementById('sidebar').classList.contains('active') ? 'hidden' : '';
        }
        function toggleAuthView(v) {
            document.getElementById('login-box').style.display = v=='login'?'block':'none';
            document.getElementById('reg-box').style.display = v=='reg'?'block':'none';
        }
        function toggleAuthTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            userManualTheme = isDark;
            const icon = document.getElementById('authThemeIcon');
            const label = document.getElementById('authThemeLabel');
            if (isDark) {
                if(icon) icon.textContent = '‚òÄÔ∏è';
                if(label) label.textContent = 'Light';
            } else {
                if(icon) icon.textContent = 'üåô';
                if(label) label.textContent = 'Dark';
            }
            // Sync with app theme toggle if present
            const appCb = document.getElementById('themeToggleCheckbox');
            if(appCb) appCb.checked = isDark;
        }
        function filterStock() {
            const searchEl = document.getElementById("stockSearch");
            if (!searchEl) return;
            const input = searchEl.value.toUpperCase();
            Array.from(document.getElementById("stockTableBody").getElementsByTagName("tr")).forEach(tr => {
                const td = tr.getElementsByTagName("td")[0];
                if(td) tr.style.display = td.textContent.toUpperCase().includes(input) ? "" : "none";
            });
        }

        // ===== LOAD DATA =====
        function loadData() {
            db.collection("shops").orderBy("name").onSnapshot(snap => {
                const sel=document.getElementById('orderShop');
                const repShop=document.getElementById('repShop');
                const payRepShop=document.getElementById('payRepShopSel');
                const delShop=document.getElementById('delShopSelect');
                sel.innerHTML='<option value="">-- Select Shop --</option>';
                repShop.innerHTML='<option value="all">All Shops</option>';
                if(payRepShop) payRepShop.innerHTML='<option value="all">All Shops</option>';
                if(delShop) delShop.innerHTML='<option value="">-- Select Shop to Delete --</option>';
                globalShops={};
                snap.forEach(doc => {
                    const d=doc.data(); globalShops[doc.id]=d;
                    const sv=doc.id.replace(/"/g,'&quot;');
                    sel.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    repShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(payRepShop) payRepShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(delShop) delShop.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                });
                if(Object.keys(allDueData).length>0 || historyData.length>0) renderDueList();
                // Populate visitShopSel
                const visitSel = document.getElementById('visitShopSel');
                if (visitSel) {
                    visitSel.innerHTML = '<option value="">-- Select Shop Visited --</option>';
                    snap.forEach(doc => {
                        const d = doc.data();
                        visitSel.innerHTML += `<option value="${doc.id}">${d.name || doc.id}</option>`;
                    });
                }
                // Refresh note selects if already populated
                populateNoteShopSelects();
            });

            db.collection("products").onSnapshot(snap => {
                const orderDatalist=document.getElementById('orderItemDatalist');
                const repItem=document.getElementById('repItem');
                const delItem=document.getElementById('delItemSelect');
                const adminDatalist=document.getElementById('adminProductList');
                const stockBody=document.getElementById('stockTableBody');
                stockBody.innerHTML=''; stockDataArray=[]; productsMap={};
                let totalStockValue=0, datalistHtml='', lowStockCount=0, lowStockHtml='';
                repItem.innerHTML='<option value="all">All Items</option>';
                if(delItem) delItem.innerHTML='<option value="">-- Select Item to Delete --</option>';
                snap.forEach(doc => {
                    const d=doc.data();
                    const price=d.price||0, stock=d.stock||0, discount=d.discount||0, costPrice=d.costPrice||0;
                    totalStockValue+=(stock*price);
                    productsMap[doc.id]={price,stock,discount,costPrice};
                    const sv=doc.id.replace(/"/g,'&quot;');
                    datalistHtml+=`<option value="${sv}">`;
                    repItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    if(delItem) delItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    const si=doc.id.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editProduct('${si}',${stock},${price},${discount},${costPrice})" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">‚úèÔ∏è</button>
                        <button onclick="deleteProduct('${si}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">üóëÔ∏è</button>
                    </td>`:'';
                    let discFormat=discount>0?`<b style="color:var(--primary)">${discount}%</b>`:`0%`;
                    let cpDisplay=costPrice>0?`‚Çπ${costPrice.toFixed(2)}`:`<span style="color:#94a3b8;">‚Äî</span>`;
                    stockBody.innerHTML+=`<tr>
                        <td><b>${doc.id}</b></td>
                        <td style="${stock<=5?'color:#f43f5e;font-weight:700;':''}">${stock}</td>
                        <td>‚Çπ${price.toFixed(2)}</td>
                        <td class="mgr-only-col">${cpDisplay}</td>
                        <td>${discFormat}</td>
                        ${actionBtn}
                    </tr>`;
                    stockDataArray.push(userData.role==='manager' ? {"Product":doc.id,"Stock":stock,"Selling Price":price,"Purchase Price":costPrice,"Discount (%)":discount} : {"Product":doc.id,"Stock":stock,"Selling Price":price,"Discount (%)":discount});
                    if(stock<=5){lowStockCount++;lowStockHtml+=`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>${doc.id}</span><span style="color:#f43f5e;font-weight:700;">${stock} left</span></div>`;}
                });
                orderDatalist.innerHTML=datalistHtml;
                if(adminDatalist) adminDatalist.innerHTML=datalistHtml;
                document.getElementById('stockTotalValue').innerText=`‚Çπ ${totalStockValue.toFixed(2)}`;
                document.getElementById('dashLowStockCount').innerText=lowStockCount;
                document.getElementById('dashLowStockList').innerHTML=lowStockCount>0?lowStockHtml:`<div style="padding:10px;color:var(--success);font-weight:700;">‚úÖ All items are well stocked!</div>`;
                filterStock();
            });

            db.collection("purchases").orderBy("time","desc").limit(100).onSnapshot(snap => {
                const pBody=document.getElementById('purchaseTableBody');
                pBody.innerHTML=''; purchaseDataArray=[];
                snap.forEach(doc => {
                    const d=doc.data();
                    const timeStr=d.time?d.time.toDate().toLocaleDateString():'N/A';
                    const sdi=doc.id.replace(/'/g,"\\'");
                    const sin=d.item.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let sd=d.dealer?d.dealer.replace(/'/g,"\\'").replace(/"/g,'&quot;'):'';
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editPurchase('${sdi}','${sin}',${d.addedStock},${d.price||0},${d.costPrice||0},'${sd}')" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">‚úèÔ∏è</button>
                        <button onclick="deletePurchaseRecord('${sdi}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">üóëÔ∏è</button>
                    </td>`:'';
                    pBody.innerHTML+=`<tr><td>${timeStr}</td><td><b>${d.item}</b></td><td style="color:var(--primary);">+${d.addedStock}</td><td>‚Çπ${(d.price||0).toFixed(2)}</td><td class="mgr-only-col" style="color:var(--danger);">‚Çπ${(d.costPrice||0).toFixed(2)}</td><td>${d.dealer||'N/A'}</td>${actionBtn}</tr>`;
                    purchaseDataArray.push(userData.role==='manager' ? {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Cost Price":d.costPrice||0,"Dealer":d.dealer||''} : {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Dealer":d.dealer||''});
                });
            });

            db.collection("orders").orderBy("time","desc").onSnapshot(snap => {
                const list=document.getElementById('historyList');
                const salesBody=document.getElementById('salesTableBody');
                const billSel=document.getElementById('billingSelect');
                const repSalesman=document.getElementById('repSalesman');
                list.innerHTML=""; salesBody.innerHTML="";
                billSel.innerHTML='<option value="">-- Choose an Order --</option>';
                historyData=[]; salesDataArray=[];
                let totalS=0, totalO=0, shopMap={}, todayS=0;
                const today=new Date().setHours(0,0,0,0);
                let salesmenSet=new Set();
                let last7DaysMap={}, topItemsMap={};
                for(let i=6;i>=0;i--){let dt=new Date();dt.setDate(dt.getDate()-i);last7DaysMap[dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})]=0;}
                let idx=0;
                snap.forEach(doc => {
                    const d=doc.data(); d.orderId=doc.id; historyData.push(d);
                    salesmenSet.add(d.salesman);
                    let oTime=d.time?d.time.toDate():new Date();
                    const timeS=oTime.toLocaleString();
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    if(userData.role==='manager'){
                        let dk=oTime.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
                        if(last7DaysMap[dk]!==undefined) last7DaysMap[dk]+=d.total;
                        d.items.forEach(item=>{topItemsMap[item.id]=(topItemsMap[item.id]||0)+item.qty;});
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        totalO++; totalS+=d.total;
                        if(oTime.getTime()>=today) todayS+=d.total;
                        shopMap[d.shopName]=(shopMap[d.shopName]||0)+d.total;
                    }
                    billSel.innerHTML+=`<option value="${idx}">${d.shopName} (‚Çπ${d.total.toFixed(0)})</option>`;
                    let actionBtn="", billBtn="";
                    if(userData.role==='manager'){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                        billBtn=`<button onclick="document.getElementById('billingSelect').value='${idx}';renderA5Bill();switchView('billing');" class="btn-outline" style="padding:2px 8px;font-size:12px;">Bill</button>`;
                    } else if(d.salesman===userData.name){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        list.innerHTML+=`<div class="card">
                            <div class="flex-between"><b style="color:var(--primary);font-size:15px;">${d.shopName}</b><small style="color:#64748b;">${timeS}</small></div>
                            <div style="font-size:13px;margin:6px 0;color:var(--text);">${itemsText}</div>
                            <div style="font-size:11px;margin-bottom:6px;color:#64748b;">üë§ ${d.salesman}</div>
                            <div class="flex-between"><b style="font-size:16px;color:var(--primary);">‚Çπ ${d.total.toFixed(2)}</b><div>${billBtn}${actionBtn}</div></div>
                        </div>`;
                    }
                    let salesActionBtn=(userData.role==='manager')?`<td class="no-print"><button onclick="deleteOrder(${idx})" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">üóëÔ∏è</button></td>`:'';
                    salesBody.innerHTML+=`<tr><td>${timeS}</td><td>${d.shopName}</td><td>${itemsText}</td><td>‚Çπ${d.total.toFixed(2)}</td><td>${d.salesman}</td>${salesActionBtn}</tr>`;
                    salesDataArray.push({"Date":timeS,"Shop":d.shopName,"Total":d.total});
                    idx++;
                });
                document.getElementById('dashTodaySales').innerText=`‚Çπ ${todayS.toFixed(2)}`;
                document.getElementById('dashTotalSales').innerText=`‚Çπ ${totalS.toFixed(2)}`;
                document.getElementById('dashTotalOrders').innerText=totalO;
                renderQuickAccess();
                if(repSalesman){repSalesman.innerHTML='<option value="all">All Salesmen</option>';salesmenSet.forEach(s=>repSalesman.innerHTML+=`<option value="${s}">${s}</option>`);}
                if(userData.role==='manager') updateDashboardCharts(last7DaysMap,topItemsMap);
                renderDueList();
                renderQuickAccess();
            });

            db.collection("shop_notes").orderBy("time","desc").limit(500).onSnapshot(snap => {
                allShopNotes = [];
                snap.forEach(doc => { const d = doc.data(); d.docId = doc.id; allShopNotes.push(d); });
                if (document.getElementById('view-shop-notes')?.classList.contains('active')) renderShopNotes();
            });

            db.collection("due_entries").orderBy("time","desc").onSnapshot(snap => {
                allDueData={};
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id;
                    if(!allDueData[d.shopName]) allDueData[d.shopName]=[];
                    allDueData[d.shopName].push(d);
                });
                renderDueList();
            });

            db.collection("returns").orderBy("time","desc").limit(100).onSnapshot(snap => {
                allReturnsData=[];
                const rList=document.getElementById('returnHistoryList');
                rList.innerHTML='';
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id; allReturnsData.push(d);
                    const timeS=d.time?d.time.toDate().toLocaleString():'';
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    const safeDocId = d.docId.replace(/'/g,"\\'");
                    // FIX: Only managers can edit/delete returns
                    const canEdit = (userData.role === 'manager');
                    const editDeleteBtns = canEdit ? `
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            <button class="action-btn action-btn-edit" onclick="editReturn('${safeDocId}')">‚úèÔ∏è Edit Note</button>
                            <button class="action-btn action-btn-delete" onclick="deleteReturn('${safeDocId}',${d.refundAmt||0})">üóëÔ∏è Delete</button>
                        </div>` : '';
                    rList.innerHTML+=`<div class="card" style="margin-bottom:10px;" data-return-id="${d.docId}">
                        <div class="flex-between"><b style="color:var(--warning);">‚Ü©Ô∏è ${d.shopName}</b><small style="color:#64748b;">${timeS}</small></div>
                        <div style="font-size:13px;margin:6px 0;">${itemsText}</div>
                        <div style="font-size:11px;color:#64748b;">üë§ ${d.salesman} ${d.reason?'| Reason: '+d.reason:''}</div>
                        <div style="margin-top:6px;font-weight:700;color:var(--warning);">Refund: ‚Çπ ${(d.refundAmt||0).toFixed(2)}</div>
                        ${editDeleteBtns}
                    </div>`;
                });
                if(!snap.size) rList.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No returns yet.</div>';
            });

            db.collection("visits").orderBy("time","desc").limit(300).onSnapshot(snap => {
                allVisitsData=[];
                const salesmenSet=new Set(['all']);
                snap.forEach(doc => { const d=doc.data(); d.docId=doc.id; allVisitsData.push(d); salesmenSet.add(d.salesman); });
                const vsf=document.getElementById('visitSalesmanFilter');
                const curVal=vsf.value;
                vsf.innerHTML='<option value="all">All Salesmen</option>';
                salesmenSet.forEach(s=>{ if(s!=='all') vsf.innerHTML+=`<option value="${s}">${s}</option>`; });
                vsf.value=curVal;
                renderVisits();
            });
        }

        // ===== CHARTS =====
        function updateDashboardCharts(salesMap, itemsMap) {
            const salesCtx=document.getElementById('dashSalesChart').getContext('2d');
            if(dashSalesChartInstance) dashSalesChartInstance.destroy();
            dashSalesChartInstance=new Chart(salesCtx,{type:'line',data:{labels:Object.keys(salesMap),datasets:[{label:'Sales (‚Çπ)',data:Object.values(salesMap),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',fill:true,tension:0.4,pointBackgroundColor:'#6366f1',pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
            const sortedItems=Object.entries(itemsMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const itemCtx=document.getElementById('dashItemChart').getContext('2d');
            if(dashItemChartInstance) dashItemChartInstance.destroy();
            dashItemChartInstance=new Chart(itemCtx,{type:'doughnut',data:{labels:sortedItems.map(i=>i[0]),datasets:[{data:sortedItems.map(i=>i[1]),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10}}}}}});
        }

        function updateReportChart(groupMap) {
            const ctx=document.getElementById('reportChart').getContext('2d');
            if(reportChartInstance) reportChartInstance.destroy();
            const labels=Object.keys(groupMap), values=Object.values(groupMap);
            reportChartInstance=new Chart(ctx,{type:labels.length<=6?'bar':'line',data:{labels,datasets:[{label:'Sales (‚Çπ)',data:values,backgroundColor:'rgba(16,185,129,0.7)',borderColor:'#10b981',borderRadius:6,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
        }

        // ===== REPORT HELPERS =====
        function applyDatePreset(preset, btn) {
            document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const today=new Date(); let start, end;
            if(preset==='today'){start=end=today;}
            else if(preset==='yesterday'){const yd=new Date(today);yd.setDate(yd.getDate()-1);start=end=yd;}
            else if(preset==='week'){start=new Date(today);start.setDate(today.getDate()-today.getDay());end=today;}
            else if(preset==='lastweek'){end=new Date(today);end.setDate(today.getDate()-today.getDay()-1);start=new Date(end);start.setDate(end.getDate()-6);}
            else if(preset==='month'){start=new Date(today.getFullYear(),today.getMonth(),1);end=today;}
            else if(preset==='lastmonth'){start=new Date(today.getFullYear(),today.getMonth()-1,1);end=new Date(today.getFullYear(),today.getMonth(),0);}
            document.getElementById('repStartDate').value=start.toISOString().split('T')[0];
            document.getElementById('repEndDate').value=end.toISOString().split('T')[0];
        }
        function clearPresets(){document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));}
        function setSortOption(opt,el){currentSortOption=opt;document.querySelectorAll('#sortOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function setGroupOption(opt,el){currentGroupOption=opt;document.querySelectorAll('#groupOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function resetReportFilters(){
            ['repStartDate','repEndDate','repMinAmount','repMaxAmount'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('repShop').value='all'; document.getElementById('repItem').value='all'; document.getElementById('repSalesman').value='all';
            clearPresets(); currentSortOption='date-desc'; currentGroupOption='none';
            document.querySelectorAll('#sortOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.querySelectorAll('#groupOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.getElementById('reportResultArea').style.display='none';
            toast("Filters reset!","success");
        }

        function generateCustomReport() {
            const sVal=document.getElementById('repStartDate').value, eVal=document.getElementById('repEndDate').value;
            const start=sVal?new Date(sVal).setHours(0,0,0,0):null, end=eVal?new Date(eVal).setHours(23,59,59,999):null;
            const shop=document.getElementById('repShop').value, item=document.getElementById('repItem').value;
            const salesmanFilter=document.getElementById('repSalesman').value;
            const minAmt=parseFloat(document.getElementById('repMinAmount').value)||0;
            const maxAmt=parseFloat(document.getElementById('repMaxAmount').value)||Infinity;
            customReportArray=[]; let tAmt=0,tQty=0,orderCount=0; let grouped={};
            historyData.forEach(d => {
                let oTime=d.time?d.time.toDate().getTime():0;
                if(start&&oTime<start) return; if(end&&oTime>end) return;
                if(shop!=='all'&&d.shopName!==shop) return;
                if(salesmanFilter!=='all'&&d.salesman!==salesmanFilter) return;
                let filtered=(item==='all')?d.items:d.items.filter(i=>i.id===item);
                if(!filtered.length) return;
                let rowAmt=filtered.reduce((s,i)=>s+i.total,0);
                if(rowAmt<minAmt||rowAmt>maxAmt) return;
                let rowQty=filtered.reduce((s,i)=>s+i.qty,0);
                tAmt+=rowAmt; tQty+=rowQty; orderCount++;
                let dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
                let itemStr=filtered.map(i=>`${i.id}(${i.qty})`).join(', ');
                customReportArray.push({Date:dateStr,Shop:d.shopName,Items:itemStr,"Amount (‚Çπ)":rowAmt,Salesman:d.salesman,_time:oTime});
                let gKey=currentGroupOption==='shop'?d.shopName:currentGroupOption==='salesman'?d.salesman:dateStr;
                grouped[gKey]=(grouped[gKey]||0)+rowAmt;
            });
            customReportArray.sort((a,b)=>{
                if(currentSortOption==='date-desc') return b._time-a._time;
                if(currentSortOption==='date-asc') return a._time-b._time;
                if(currentSortOption==='amount-desc') return b['Amount (‚Çπ)']-a['Amount (‚Çπ)'];
                return a['Amount (‚Çπ)']-b['Amount (‚Çπ)'];
            });
            const tbody=document.getElementById('repTableBody'), thead=document.getElementById('repTableHead');
            tbody.innerHTML='';
            if(currentGroupOption!=='none'){
                let groupedRows={};
                customReportArray.forEach(row=>{
                    let gKey=currentGroupOption==='shop'?row.Shop:currentGroupOption==='salesman'?row.Salesman:row.Date;
                    if(!groupedRows[gKey]) groupedRows[gKey]={rows:[],total:0};
                    groupedRows[gKey].rows.push(row); groupedRows[gKey].total+=row['Amount (‚Çπ)'];
                });
                let groupLabel=currentGroupOption==='shop'?'üè™ Shop':currentGroupOption==='salesman'?'üë§ Salesman':'üìÖ Date';
                thead.innerHTML=`<tr><th>${groupLabel}</th><th>Orders</th><th>Total (‚Çπ)</th><th>% of Total</th></tr>`;
                Object.entries(groupedRows).forEach(([key,data])=>{
                    let pct=tAmt>0?((data.total/tAmt)*100).toFixed(1):'0.0';
                    tbody.innerHTML+=`<tr><td><b>${key}</b></td><td>${data.rows.length}</td><td style="color:var(--success);font-weight:700;">‚Çπ${data.total.toFixed(2)}</td><td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;">${pct}%</span></td></tr>`;
                });
            } else {
                thead.innerHTML=`<tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (‚Çπ)</th><th>Salesman</th></tr>`;
                customReportArray.forEach(row=>{tbody.innerHTML+=`<tr><td>${row.Date}</td><td>${row.Shop}</td><td style="max-width:200px;white-space:normal;">${row.Items}</td><td style="color:var(--success);font-weight:700;">‚Çπ${row['Amount (‚Çπ)'].toFixed(2)}</td><td>${row.Salesman}</td></tr>`;});
            }
            document.getElementById('repTotalAmount').innerText=`‚Çπ ${tAmt.toFixed(2)}`;
            document.getElementById('repTotalQty').innerText=tQty;
            document.getElementById('repOrderCount').innerText=orderCount;
            document.getElementById('repAvgOrder').innerText=orderCount>0?`‚Çπ ${(tAmt/orderCount).toFixed(2)}`:'‚Çπ 0.00';
            document.getElementById('repDataCount').innerText=`(${orderCount} records)`;
            if(customReportArray.length>0){
                document.getElementById('reportResultArea').style.display='block';
                document.getElementById('reportChartWrapper').style.display='block';
                document.getElementById('reportChartCard').style.display='block';
                updateReportChart(grouped);
            } else { toast("No data found!","error"); document.getElementById('reportResultArea').style.display='none'; }
        }

        // ===== PAYMENT REPORT =====
        function generatePaymentReport() {
            const shopFilter = document.getElementById('payRepShopSel').value;
            const startVal = document.getElementById('payRepStart').value;
            const endVal = document.getElementById('payRepEnd').value;
            const startMs = startVal ? new Date(startVal).setHours(0,0,0,0) : 0;
            const endMs = endVal ? new Date(endVal).setHours(23,59,59,999) : Infinity;
            paymentReportArray = [];
            let totalBillFiltered = 0, totalPaidFiltered = 0;
            Object.entries(allDueData).forEach(([shopName, entries]) => {
                if (shopFilter !== 'all' && shopName !== shopFilter) return;
                entries.forEach(e => {
                    const eMs = e.time ? e.time.toDate().getTime() : 0;
                    if (eMs < startMs || eMs > endMs) return;
                    const dateStr = e.time ? e.time.toDate().toLocaleDateString('en-GB') : '‚Äî';
                    paymentReportArray.push({
                        Date: dateStr,
                        Shop: shopName,
                        "Amount Paid (‚Çπ)": e.payment || 0,
                        Note: e.note || '‚Äî',
                        Salesman: e.salesman || '‚Äî',
                        _time: eMs
                    });
                    totalPaidFiltered += (e.payment || 0);
                });
            });
            historyData.forEach(d => {
                if (shopFilter !== 'all' && d.shopName !== shopFilter) return;
                totalBillFiltered += d.total;
            });
            paymentReportArray.sort((a,b) => b._time - a._time);
            const tbody = document.getElementById('payRepTableBody');
            tbody.innerHTML = '';
            paymentReportArray.forEach(row => {
                tbody.innerHTML += `<tr>
                    <td>${row.Date}</td>
                    <td><b>${row.Shop}</b></td>
                    <td style="color:var(--success);font-weight:700;">‚Çπ${(row['Amount Paid (‚Çπ)']).toFixed(2)}</td>
                    <td style="color:#64748b;">${row.Note}</td>
                    <td>${row.Salesman}</td>
                </tr>`;
            });
            const remaining = totalBillFiltered - totalPaidFiltered;
            document.getElementById('payRepTotalBill').innerText = `‚Çπ ${totalBillFiltered.toFixed(2)}`;
            document.getElementById('payRepTotalPaid').innerText = `‚Çπ ${totalPaidFiltered.toFixed(2)}`;
            document.getElementById('payRepRemaining').innerText = `‚Çπ ${Math.max(0, remaining).toFixed(2)}`;
            document.getElementById('payRepCount').innerText = `(${paymentReportArray.length} payments)`;
            if (paymentReportArray.length > 0) {
                document.getElementById('payRepResultArea').style.display = 'block';
            } else {
                document.getElementById('payRepResultArea').style.display = 'none';
                toast("No payment records found!", "error");
            }
        }

        // ===== EXCEL IMPORT =====
        function getExcelVal(row,keys){
            for(let k of keys) if(row[k]!==undefined&&row[k]!==null&&row[k]!=="") return row[k];
            const rowKeys=Object.keys(row);
            for(let k of keys){const match=rowKeys.find(rk=>rk.trim().toLowerCase()===k.trim().toLowerCase());if(match&&row[match]!==undefined&&row[match]!==null&&row[match]!=="") return row[match];}
            return null;
        }
        async function handleExcelImport(event) {
            const file=event.target.files[0]; if(!file) return;
            const reader=new FileReader();
            reader.onload=async function(e){
                try{
                    const data=new Uint8Array(e.target.result);
                    const workbook=XLSX.read(data,{type:'array'});
                    const json=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(!json.length) return toast("Excel file is empty!","error");
                    let successCount=0,errorCount=0;
                    for(let row of json){
                        let pName=getExcelVal(row,['Product','product','Product Name','Item','item']);
                        let qty=parseInt(getExcelVal(row,['Qty','Added Qty','Quantity','qty']));
                        let price=parseFloat(getExcelVal(row,['Price','price','Base Price','Selling Price']));
                        let costPrice=parseFloat(getExcelVal(row,['Cost Price','cost price','CostPrice','Buy Price','Purchase Price'])||0);
                        let dealer=getExcelVal(row,['Dealer','Dealer info','dealer'])||'';
                        let discount=parseFloat(getExcelVal(row,['Discount','discount','Disc'])||0);
                        if(!pName||isNaN(qty)||qty<=0){errorCount++;continue;}
                        let safeName=pName.toString().trim().replace(/\//g,'-');
                        const ref=db.collection("products").doc(safeName);
                        const doc=await ref.get();
                        let finalS=doc.exists?(doc.data().stock||0)+qty:qty;
                        let finalP=isNaN(price)?(doc.exists?doc.data().price||0:0):price;
                        let finalCP=(!isNaN(costPrice)&&costPrice>0)?costPrice:(doc.exists?doc.data().costPrice||0:0);
                        let finalD=isNaN(discount)?(doc.exists?doc.data().discount||0:0):discount;
                        await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
                        await db.collection("purchases").add({item:safeName,addedStock:qty,price:finalP,costPrice:finalCP,dealer:dealer.toString(),time:firebase.firestore.FieldValue.serverTimestamp()});
                        successCount++;
                    }
                    if(successCount>0) toast(`Import done! ${successCount} items. (Errors: ${errorCount})`,"success");
                    else toast("Failed to import. Check headers.","error");
                }catch(err){toast("Error parsing Excel.","error");}
                event.target.value="";
            };
            reader.readAsArrayBuffer(file);
        }

        // ===== CART =====
        function togglePriceMode() {
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            document.getElementById('manualPriceContainer').style.display=mode==='manual'?'block':'none';
            if(mode!=='manual') document.getElementById('manualPriceInput').value="";
            const dc=document.getElementById('itemDiscContainer');
            if(dc) dc.style.display=mode==='auto'?'block':'none';
        }
        function updateDiscPreview() {
            const pId=document.getElementById('orderItemInput').value;
            if(!productsMap[pId]) return;
            const base=productsMap[pId].price;
            const disc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
            document.getElementById('discPricePreview').innerText=disc>0?`‚Üí ‚Çπ${(base-(base*disc/100)).toFixed(2)}`:'';
        }
        function showPriceInfo() {
            const val=document.getElementById('orderItemInput').value;
            const box=document.getElementById('priceHighlightBox');
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            const dc=document.getElementById('itemDiscContainer');
            if(productsMap[val]){
                const p=productsMap[val];
                const disc=p.price-(p.price*(p.discount/100));
                box.innerHTML=p.discount>0?`üõí Stock: <b>${p.stock}</b> &nbsp;|&nbsp; ‚ú® Price: <b>‚Çπ${p.price.toFixed(2)}</b><br><small style="color:var(--danger);">üí° Default ${p.discount}% disc = ‚Çπ${disc.toFixed(2)}</small>`:`üõí Stock: <b>${p.stock}</b> &nbsp;|&nbsp; ‚ú® Price: <b>‚Çπ${p.price.toFixed(2)}</b>`;
                box.style.display='block';
                if(dc&&mode==='auto'){dc.style.display='block';updateDiscPreview();}
            } else { box.style.display='none'; if(dc) dc.style.display='none'; }
        }
        function addToCart() {
            const pId=document.getElementById('orderItemInput').value;
            const qty=parseInt(document.getElementById('orderQty').value);
            if(!pId||!qty||qty<=0) return toast("Invalid Qty or Item not found","error");
            if(!productsMap[pId]) return toast("Please select a valid item from the list","error");
            const pData=productsMap[pId];
            let finalUnitPrice=0;
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            if(mode==='manual'){
                const mPrice=parseFloat(document.getElementById('manualPriceInput').value);
                if(isNaN(mPrice)||mPrice<0) return toast("Please enter a valid manual price","error");
                finalUnitPrice=mPrice;
            } else {
                const extraDisc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
                finalUnitPrice=pData.price-(pData.price*extraDisc/100);
            }
            const existing=cart.find(i=>i.id===pId);
            const totalQty=(existing?existing.qty:0)+qty;
            if(totalQty>pData.stock) return toast("Stock Limit! Only "+pData.stock+" left.","error");
            if(existing){existing.qty+=qty;existing.price=finalUnitPrice;existing.total=existing.qty*finalUnitPrice;}
            else cart.push({id:pId,qty,price:finalUnitPrice,total:qty*finalUnitPrice});
            renderCart();
            document.getElementById('orderItemInput').value="";
            document.getElementById('orderQty').value="";
            if(mode==='manual') document.getElementById('manualPriceInput').value="";
            if(document.getElementById('itemDiscInput')) document.getElementById('itemDiscInput').value="";
            if(document.getElementById('discPricePreview')) document.getElementById('discPricePreview').innerText="";
            if(document.getElementById('itemDiscContainer')) document.getElementById('itemDiscContainer').style.display='none';
            showPriceInfo();
        }
        function undoCart(){if(cart.length>0){cart.pop();renderCart();}}
        function renderCart() {
            const list=document.getElementById('cartList');
            list.innerHTML=""; let grand=0;
            cart.forEach((item,i)=>{
                grand+=item.total;
                list.innerHTML+=`<div class="flex-between" style="font-size:14px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);">
                    <span><b>${item.id}</b> <span style="color:#64748b;">(x${item.qty}) @ ‚Çπ${item.price.toFixed(2)}</span></span>
                    <span style="font-weight:700;">‚Çπ${item.total.toFixed(2)} <span onclick="cart.splice(${i},1);renderCart();" style="color:#f43f5e;cursor:pointer;margin-left:8px;">‚úñ</span></span>
                </div>`;
            });
            document.getElementById('cartTotal').innerText="‚Çπ "+grand.toFixed(2);
            document.getElementById('cartCard').style.display=cart.length?'block':'none';
        }
        async function placeFinalOrder() {
            const shop=document.getElementById('orderShop').value;
            if(!shop||!cart.length) return toast("Empty Shop/Cart","error");
            document.getElementById('btnPlace').innerText="Processing...";
            const orderObj={shopName:shop,items:cart,total:cart.reduce((s,i)=>s+i.total,0),salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()};
            try{
                for(let i of cart){const ref=db.collection("products").doc(i.id);await db.runTransaction(async t=>{const doc=await t.get(ref);t.update(ref,{stock:doc.data().stock-i.qty});});}
                await db.collection("orders").add(orderObj);
                toast("Order Placed!","success"); cart=[]; renderCart(); switchView('history');
            }catch(e){toast(e.message,"error");}
            document.getElementById('btnPlace').innerText="Place Final Order";
        }
        async function deleteOrder(idx) {
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                // Save snapshot for undo
                const orderSnap = JSON.parse(JSON.stringify(d));
                for(let item of d.items){const ref=db.collection("products").doc(item.id);await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:pDoc.data().stock+item.qty});});}
                await db.collection("orders").doc(d.orderId).delete();
                toast("üóëÔ∏è Order deleted ‚Äî stock returned","success");
                pushUndo("Order deleted", async () => {
                    // Re-add order and deduct stock
                    const newRef = await db.collection("orders").add({
                        shopName: orderSnap.shopName, items: orderSnap.items,
                        total: orderSnap.total, salesman: orderSnap.salesman,
                        time: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    for(let item of orderSnap.items){
                        const ref=db.collection("products").doc(item.id);
                        await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:Math.max(0,pDoc.data().stock-item.qty)});});
                    }
                });
            }catch(e){toast("Error: "+e.message,"error");}
        }
        async function editOrder(idx) {
            if(!confirm("Edit: This will move items back to cart and delete the order. Proceed?")) return;
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                for(let item of d.items){const ref=db.collection("products").doc(item.id);await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:pDoc.data().stock+item.qty});});}
                await db.collection("orders").doc(d.orderId).delete();
                cart=[...d.items];
                const sel=document.getElementById('orderShop');
                for(let i=0;i<sel.options.length;i++){if(sel.options[i].value===d.shopName){sel.selectedIndex=i;break;}}
                renderCart(); switchView('order');
                toast("Order moved to cart!","success");
            }catch(e){toast("Error: "+e.message,"error");}
        }

        // ===== MANAGER CRUD =====
        async function addShop() {
            const n=document.getElementById('shopName').value.trim();
            if(!n) return toast("Shop name required","error");
            await db.collection("shops").doc(n.replace(/\//g,'-')).set({name:n.replace(/\//g,'-'),phone:document.getElementById('shopPhone').value,addr:document.getElementById('shopAddr').value},{merge:true});
            toast("Shop Saved!","success");
            document.getElementById('shopName').value=""; document.getElementById('shopPhone').value=""; document.getElementById('shopAddr').value="";
        }
        async function addProduct() {
            let n=document.getElementById('prodName').value.trim();
            const s=parseInt(document.getElementById('prodStock').value);
            const p=parseFloat(document.getElementById('prodPrice').value);
            const cp=parseFloat(document.getElementById('prodCostPrice').value);
            if(!n||isNaN(s)) return toast("Name and valid stock required","error");
            if(n.includes('/')) n=n.replace(/\//g,'-');
            const ref=db.collection("products").doc(n);
            const doc=await ref.get();
            let finalS=doc.exists?doc.data().stock+s:s;
            let finalP=isNaN(p)?(doc.exists?doc.data().price:0):p;
            let finalCP=isNaN(cp)?(doc.exists?doc.data().costPrice||0:0):cp;
            let finalD=doc.exists?(doc.data().discount||0):0;
            await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
            if(s>0) await db.collection("purchases").add({item:n,addedStock:s,price:finalP,costPrice:finalCP,dealer:document.getElementById('purchaseInfo').value,time:firebase.firestore.FieldValue.serverTimestamp()});
            toast("Stock Updated!","success");
            document.getElementById('prodName').value=""; document.getElementById('prodStock').value=""; document.getElementById('prodPrice').value=""; document.getElementById('prodCostPrice').value=""; document.getElementById('purchaseInfo').value="";
        }
        async function editProduct(id, oldStock, oldPrice, oldDisc, oldCostPrice) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nStock=prompt(`Edit Stock for "${id}":`,oldStock); if(nStock===null) return;
            let nPrice=prompt(`Edit Selling Price for "${id}" (‚Çπ):`,oldPrice); if(nPrice===null) return;
            let nCostPrice=prompt(`Edit Purchase/Cost Price for "${id}" (‚Çπ):`,oldCostPrice); if(nCostPrice===null) return;
            let nDisc=prompt(`Edit Discount % for "${id}":`,oldDisc); if(nDisc===null) return;
            try{
                await db.collection("products").doc(id).update({
                    stock:parseInt(nStock),
                    price:parseFloat(nPrice),
                    costPrice:parseFloat(nCostPrice)||0,
                    discount:parseFloat(nDisc)||0
                });
                toast("Product updated!","success");
            }catch(e){toast(e.message,"error");}
        }
        async function editPurchase(docId,item,oldQty,oldPrice,oldCostPrice,oldDealer) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nQty=prompt(`Edit Qty for ${item}:`,oldQty); if(nQty===null) return;
            let nPrice=prompt(`Edit Selling Price (‚Çπ):`,oldPrice); if(nPrice===null) return;
            let nCP=prompt(`Edit Cost Price (‚Çπ):`,oldCostPrice); if(nCP===null) return;
            let nDealer=prompt(`Edit Dealer:`,oldDealer); if(nDealer===null) return;
            try{await db.collection("purchases").doc(docId).update({addedStock:parseInt(nQty),price:parseFloat(nPrice),costPrice:parseFloat(nCP)||0,dealer:nDealer});toast("Updated!","success");}catch(e){toast(e.message,"error");}
        }
        async function deleteProduct(id) {
            try{
                const snap = await db.collection("products").doc(id).get();
                if(!snap.exists) return toast("Product not found","error");
                const data = snap.data();
                await db.collection("products").doc(id).delete();
                toast("üóëÔ∏è Product deleted","success");
                pushUndo(`"${id}" deleted`, async () => {
                    await db.collection("products").doc(id).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deletePurchaseRecord(id) {
            try{
                const purchDoc=await db.collection("purchases").doc(id).get();
                if(!purchDoc.exists) return toast("Record not found","error");
                const pData=purchDoc.data();
                const itemName=pData.item, addedQty=pData.addedStock||0;
                if(itemName&&addedQty>0){
                    const prodRef=db.collection("products").doc(itemName);
                    await db.runTransaction(async t=>{
                        const prodDoc=await t.get(prodRef);
                        if(prodDoc.exists) t.update(prodRef,{stock:Math.max(0,(prodDoc.data().stock||0)-addedQty)});
                    });
                }
                await db.collection("purchases").doc(id).delete();
                toast(`üóëÔ∏è Purchase record deleted ‚Äî stock reduced by ${addedQty}`,"success");
                pushUndo("Purchase record deleted", async () => {
                    await db.collection("purchases").doc(id).set(pData);
                    if(itemName && addedQty>0){
                        const prodRef=db.collection("products").doc(itemName);
                        await db.runTransaction(async t=>{
                            const prodDoc=await t.get(prodRef);
                            if(prodDoc.exists) t.update(prodRef,{stock:(prodDoc.data().stock||0)+addedQty});
                        });
                    }
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deleteShop() {
            const shopId=document.getElementById('delShopSelect').value;
            if(!shopId) return toast("Select a shop","error");
            try{
                const snap = await db.collection("shops").doc(shopId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("shops").doc(shopId).delete();
                toast("üóëÔ∏è Shop deleted","success");
                document.getElementById('delShopSelect').value="";
                pushUndo(`Shop "${shopId}" deleted`, async () => {
                    if(data) await db.collection("shops").doc(shopId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deleteProductFromAdmin() {
            const itemId=document.getElementById('delItemSelect').value;
            if(!itemId) return toast("Select an item","error");
            try{
                const snap = await db.collection("products").doc(itemId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("products").doc(itemId).delete();
                toast("üóëÔ∏è Item deleted","success");
                document.getElementById('delItemSelect').value="";
                pushUndo(`"${itemId}" deleted`, async () => {
                    if(data) await db.collection("products").doc(itemId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }

        // ===== BILLING =====
        function renderA5Bill() {
            const idxStr=document.getElementById('billingSelect').value;
            if(idxStr===""){document.getElementById('bill-preview-section').style.display='none';return;}
            const d=historyData[parseInt(idxStr)]; if(!d) return;
            let shopPhone=globalShops[d.shopName]?globalShops[d.shopName].phone:'N/A';
            document.getElementById('b-shopName').innerText=d.shopName;
            document.getElementById('b-shopPhone').innerText="Ph: "+shopPhone;
            document.getElementById('b-date').innerText=d.time?d.time.toDate().toLocaleDateString():'';
            document.getElementById('b-salesman').innerText=d.salesman;
            document.getElementById('b-orderId').innerText="#"+d.orderId.substring(0,6).toUpperCase();
            let rows="";
            d.items.forEach((i,sl)=>{rows+=`<tr><td>${sl+1}</td><td>${i.id}<br><small>@ ‚Çπ${i.price.toFixed(2)}</small></td><td>${i.qty}</td><td style="text-align:right;">‚Çπ${i.total.toFixed(2)}</td></tr>`;});
            document.getElementById('b-itemsBody').innerHTML=rows;
            document.getElementById('b-grandTotal').innerText=d.total.toFixed(2);
            document.getElementById('bill-preview-section').style.display='block';
        }
        function downloadA5PDF() {
            toast("Generating PDF...");
            html2pdf().set({margin:0.2,filename:'Invoice_'+document.getElementById('b-orderId').innerText+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},jsPDF:{unit:'in',format:'a5',orientation:'portrait'}}).from(document.getElementById('a5-print-zone')).save();
        }
        function exportAnyTable(id,name) {
            toast("Generating PDF...");
            const el=document.getElementById(id);
            const origOverflow=el.style.overflowX; el.style.overflowX='visible';
            const noPrint=el.querySelectorAll('.no-print'); noPrint.forEach(e=>e.style.display='none');
            html2pdf().set({margin:0.3,filename:name+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},jsPDF:{unit:'in',format:'a4',orientation:'landscape'}}).from(el).save().then(()=>{el.style.overflowX=origOverflow;noPrint.forEach(e=>e.style.display='');});
        }
        function exportDataExcel(arr,name) {
            if(!arr||!arr.length) return toast("No data to export","error");
            toast("Exporting Excel...");
            const ws=XLSX.utils.json_to_sheet(arr);
            const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
            XLSX.writeFile(wb,name+".xlsx");
        }

        // ===== WHATSAPP ‚Äî FIX: Always ask who to send to =====
        function shareWhatsApp() {
            const idxStr=document.getElementById('billingSelect').value;
            if(!idxStr) return toast("Select an order first","error");
            const d=historyData[parseInt(idxStr)]; if(!d) return;
            const dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
            let msg=`üõí *Order With Me ‚Äî Invoice*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüè™ *Shop:* ${d.shopName}\nüìÖ *Date:* ${dateStr}\nüë§ *Sales Rep:* ${d.salesman}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            d.items.forEach((item,i)=>{msg+=`${i+1}. ${item.id}\n   ${item.qty} √ó ‚Çπ${item.price.toFixed(2)} = ‚Çπ${item.total.toFixed(2)}\n`;});
            msg+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ *Grand Total: ‚Çπ${d.total.toFixed(2)}*\n\n_Thank you for your business!_ üôè`;
            const phone = prompt(
                `Send WhatsApp invoice to:\n\nEnter phone number with country code (e.g. 919876543210)\nLeave blank to open WhatsApp without a pre-filled number.`,
                ""
            );
            if (phone === null) return; // User cancelled
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const url = cleanPhone
                ? `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // ===== DUE / CREDIT =====
        function getShopDueStats(shopName) {
            let totalBill = 0;
            historyData.forEach(d => { if(d.shopName === shopName) totalBill += d.total; });
            let totalPaid = 0;
            const entries = allDueData[shopName] || [];
            entries.forEach(e => { totalPaid += (e.payment || 0); });
            const remaining = totalBill - totalPaid;
            return { totalBill, totalPaid, remaining };
        }

        function onDueShopChange() {
            const shop = document.getElementById('dueShopSel').value;
            const summary = document.getElementById('dueShopBillSummary');
            if(!shop) { summary.style.display='none'; return; }
            summary.style.display='block';
            refreshDueShopSummaryPanel(shop);
        }

        function refreshDueShopSummaryPanel(shop) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shop);
            const paidPct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 100;
            const barColor = remaining <= 0 ? 'var(--success)' : (paidPct > 60 ? 'var(--warning)' : 'var(--danger)');
            document.getElementById('dueShopTotalBill').innerText = `‚Çπ ${totalBill.toFixed(2)}`;
            document.getElementById('dueShopTotalPaid').innerText = `‚Çπ ${totalPaid.toFixed(2)}`;
            const progressBar = document.getElementById('dueShopProgressBar');
            progressBar.style.width = `${paidPct.toFixed(0)}%`;
            progressBar.style.background = barColor;
            const remEl = document.getElementById('dueShopRemaining');
            if(remaining <= 0) {
                remEl.innerText = '‚úÖ Fully Paid!';
                remEl.style.color = 'var(--success)';
            } else {
                remEl.innerText = `‚Çπ ${remaining.toFixed(2)}`;
                remEl.style.color = 'var(--danger)';
            }
        }

        function renderDueList() {
            const area = document.getElementById('dueListArea');
            const dueShopSel = document.getElementById('dueShopSel');
            if(!area) return;
            if(dueShopSel) {
                const curVal = dueShopSel.value;
                dueShopSel.innerHTML = '<option value="">-- Select Shop --</option>';
                Object.keys(globalShops).forEach(k => {
                    dueShopSel.innerHTML += `<option value="${k}">${globalShops[k].name || k}</option>`;
                });
                dueShopSel.value = curVal;
                if(curVal) refreshDueShopSummaryPanel(curVal);
            }

            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allShops[d.shopName].totalBill += d.total;
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });

            area.innerHTML = '';
            let grandTotalDue = 0;
            let allCardsHTML = '';

            if(!Object.keys(allShops).length) {
                area.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No orders or due entries found.</div>';
                document.getElementById('totalDueAmt').innerText = '‚Çπ 0.00';
                return;
            }

            const sorted = Object.entries(allShops).sort((a,b) => {
                const dueA = a[1].totalBill - a[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                const dueB = b[1].totalBill - b[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                return dueB - dueA;
            });

            let shopCardIndex = 0;
            sorted.forEach(([shopName, data]) => {
                if(data.totalBill === 0 && data.payments.length === 0) return;

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if(!isCleared) grandTotalDue += remaining;

                const paidPct = data.totalBill > 0 ? Math.min(100, (data.totalPaid / data.totalBill) * 100) : 100;
                const barColor = isCleared ? '#10b981' : (paidPct > 60 ? '#f59e0b' : '#f43f5e');
                const borderColor = isCleared ? 'rgba(16,185,129,0.4)' : 'rgba(244,63,94,0.4)';
                const cardId = 'dsc_' + (shopCardIndex++);

                const payRows = data.payments.map(e => {
                    const ts = e.time ? e.time.toDate().toLocaleDateString('en-GB') : '';
                    const safeDocId = e.docId ? e.docId.replace(/'/g,"\\'") : '';
                    const canManage = (userData.role === 'manager');
                    const actionBtns = canManage && safeDocId ? `
                        <div style="display:flex;gap:4px;margin-left:8px;flex-shrink:0;">
                            <button class="action-btn action-btn-edit" onclick="editDueEntry('${safeDocId}',${e.payment||0},'${(e.note||'').replace(/'/g,"\\'")}')" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn action-btn-delete" onclick="deleteDueEntry('${safeDocId}','${shopName.replace(/'/g,"\\'")}',${e.payment||0})" title="Delete">üóëÔ∏è</button>
                        </div>` : '';
                    return `<div class="payment-row" style="align-items:flex-start;">
                        <div style="flex:1;">
                            <span style="color:var(--success); font-size:13px;">üí∞ ${ts}</span>
                            ${e.note ? `<span style="color:#94a3b8; font-size:11px; margin-left:4px;">(${e.note})</span>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">
                            <span style="color:var(--success); font-weight:700; font-size:13px;">- ‚Çπ${(e.payment||0).toFixed(2)}</span>
                            ${actionBtns}
                        </div>
                    </div>`;
                }).join('');

                const safeShopName = shopName.replace(/'/g, "\\'");
                const safeShopNameJson = JSON.stringify(shopName);

                allCardsHTML += `
                <div class="due-shop-card" style="border-left:4px solid ${borderColor}; padding:0; overflow:hidden;">
                    <!-- Card top bar: left=clickable collapse, right=PDF button (separate, no stopPropagation needed) -->
                    <div style="display:flex;align-items:stretch;background:var(--card);">
                        <div onclick="toggleDueCard('${cardId}')"
                            style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;
                                   padding:14px 12px 14px 16px;cursor:pointer;user-select:none;">
                            <span style="font-size:18px;flex-shrink:0;">${isCleared ? '‚úÖ' : 'üî¥'}</span>
                            <div style="min-width:0;flex:1;">
                                <div style="font-size:15px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">üè™ ${shopName}</div>
                                <div style="font-size:11px;color:#94a3b8;margin-top:1px;">${data.payments.length} payment(s) ¬∑ ${paidPct.toFixed(0)}% paid</div>
                            </div>
                            <span class="due-badge ${isCleared?'cleared':'has-due'}" style="font-size:11px;padding:3px 10px;flex-shrink:0;">
                                ${isCleared ? 'Cleared' : '‚Çπ'+remaining.toFixed(2)}
                            </span>
                            <span id="${cardId}_arrow" style="color:#94a3b8;font-size:14px;transition:transform 0.25s;display:inline-block;flex-shrink:0;">‚ñº</span>
                        </div>
                        <div style="display:flex;align-items:center;padding:0 12px;border-left:1px solid var(--border);flex-shrink:0;">
                            <button data-pdf-shop="${shopName}"
                                style="background:transparent;border:1.5px solid var(--primary);color:var(--primary);
                                       border-radius:8px;padding:6px 11px;font-size:11px;font-weight:700;cursor:pointer;
                                       font-family:'Poppins',sans-serif;white-space:nowrap;line-height:1.2;">üìÑ PDF</button>
                        </div>
                    </div>
                    <div id="${cardId}" style="display:none;padding:14px 16px;border-top:1px solid var(--border);">
                        <div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:12px;">
                            <div class="due-stat-row"><span style="color:#64748b;">üì¶ Total Orders (Billed)</span><span style="font-weight:700;color:var(--text);">‚Çπ ${data.totalBill.toFixed(2)}</span></div>
                            <div class="due-stat-row"><span style="color:#64748b;">‚úÖ Total Paid</span><span style="font-weight:700;color:var(--success);">‚Çπ ${data.totalPaid.toFixed(2)}</span></div>
                            <div class="due-progress-wrap"><div class="due-progress-bar" style="width:${paidPct.toFixed(0)}%;background:${barColor};"></div></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#94a3b8;margin-bottom:8px;">
                                <span>${paidPct.toFixed(0)}% paid</span>
                                <span>${isCleared ? '‚úÖ Complete' : (100-paidPct).toFixed(0)+'% remaining'}</span>
                            </div>
                            <div class="due-total-row">
                                <span style="font-size:14px;">${isCleared ? '‚úÖ Fully Paid' : 'üî¥ Remaining Due'}</span>
                                <span style="color:${isCleared?'var(--success)':'var(--danger)'};font-size:18px;">${isCleared ? '‚Çπ 0.00' : '‚Çπ '+remaining.toFixed(2)}</span>
                            </div>
                        </div>
                        ${data.payments.length > 0 ? `
                        <div style="margin-bottom:10px;">
                            <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Payment History</div>
                            ${payRows}
                        </div>` : `<div style="font-size:12px;color:#94a3b8;padding:6px 0;margin-bottom:10px;">No payments recorded yet.</div>`}
                        ${userData.role==='manager' && !isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-success" style="margin-bottom:0;padding:11px;font-size:13px;">
                            üí∞ Collect Due Payment (‚Çπ${remaining.toFixed(2)})
                        </button>` : ''}
                        ${userData.role==='manager' && isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-outline" style="margin-bottom:0;padding:11px;font-size:12px;">
                            + Record More Payment
                        </button>` : ''}
                    </div>
                </div>`;
            });

            area.innerHTML = allCardsHTML;
            // Attach PDF button listeners after DOM is built (avoids onclick escaping issues)
            area.querySelectorAll('[data-pdf-shop]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const shopName = this.getAttribute('data-pdf-shop');
                    exportSingleShopDuePDF(shopName);
                });
            });
            document.getElementById('totalDueAmt').innerText = `‚Çπ ${grandTotalDue.toFixed(2)}`;
        }

        function toggleDueCard(cardId) {
            const body = document.getElementById(cardId);
            const arrow = document.getElementById(cardId + '_arrow');
            if (!body) return;
            const isOpen = body.style.display !== 'none';
            body.style.display = isOpen ? 'none' : 'block';
            if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
        }
        async function saveDueEntry() {
            const shop = document.getElementById('dueShopSel').value;
            const payment = parseFloat(document.getElementById('duePayAmt').value) || 0;
            const note = document.getElementById('dueNote').value.trim();
            if(!shop) return toast("Please select a shop","error");
            if(!payment || payment <= 0) return toast("Please enter a valid payment amount","error");
            const { remaining } = getShopDueStats(shop);
            if(remaining > 0 && payment > remaining) {
                if(!confirm(`‚ö†Ô∏è Payment (‚Çπ${payment.toFixed(2)}) exceeds the remaining due (‚Çπ${remaining.toFixed(2)}). Continue?`)) return;
            }
            try {
                await db.collection("due_entries").add({
                    shopName: shop, credit: 0, payment, note,
                    salesman: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast(`‚úÖ ‚Çπ${payment.toFixed(2)} payment saved!`, "success");
                document.getElementById('duePayAmt').value = '';
                document.getElementById('dueNote').value = '';
                refreshDueShopSummaryPanel(shop);
            } catch(e) { toast(e.message, "error"); }
        }

        async function editDueEntry(docId, oldPayment, oldNote) {
            const newAmt = prompt(`Edit payment amount (‚Çπ):`, oldPayment);
            if(newAmt === null) return;
            const newNote = prompt(`Edit note:`, oldNote);
            if(newNote === null) return;
            const amt = parseFloat(newAmt);
            if(isNaN(amt) || amt <= 0) return toast("Invalid amount","error");
            try {
                await db.collection("due_entries").doc(docId).update({ payment: amt, note: newNote });
                toast("‚úÖ Payment entry updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteDueEntry(docId, shopName, paymentAmt) {
            try {
                const snap = await db.collection("due_entries").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("due_entries").doc(docId).delete();
                toast("üóëÔ∏è Payment entry deleted","success");
                pushUndo(`Payment ‚Çπ${paymentAmt.toFixed(2)} deleted`, async () => {
                    if(data) await db.collection("due_entries").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function quickRecordPayment(shopName) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shopName);
            const amt = prompt(
                `üí∞ ${shopName}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üì¶ Total Bill:    ‚Çπ${totalBill.toFixed(2)}\n` +
                `‚úÖ Already Paid:  ‚Çπ${totalPaid.toFixed(2)}\n` +
                `üî¥ Remaining:     ‚Çπ${Math.max(0,remaining).toFixed(2)}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nHow much did they pay?`
            );
            if(!amt || isNaN(parseFloat(amt)) || parseFloat(amt) <= 0) return;
            const note = prompt("Note (optional):") || '';
            db.collection("due_entries").add({
                shopName, credit:0, payment:parseFloat(amt), note,
                salesman: userData.name,
                time: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => toast(`‚úÖ ‚Çπ${parseFloat(amt).toFixed(2)} payment recorded!`, "success"))
              .catch(e => toast(e.message, "error"));
        }

        // ===== HELPERS: Build allShops data for PDFs =====
        function buildAllShopsData() {
            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allShops[d.shopName].totalBill += d.total;
                allShops[d.shopName].orders.push(d);
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });
            return allShops;
        }

        // ===== PDF EXPORT: DUE ‚Äî Summary (all shops on one PDF) =====
        function exportDuePDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No due data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Report_' + today.replace(/ /g, '-') + '.pdf';

            // Header bar
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16); doc.setFont('helvetica', 'bold');
            doc.text('ORDER WITH ME', 14, 11);
            doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            doc.text('Due / Credit Report', 14, 18);
            doc.text('Generated: ' + today, pw - 14, 18, { align: 'right' });

            // Table
            let grandDue = 0;
            const tableBody = [];
            sorted.forEach(([shopName, data]) => {
                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if (!isCleared) grandDue += remaining;
                tableBody.push([
                    shopName,
                    'Rs.' + data.totalBill.toFixed(2),
                    'Rs.' + data.totalPaid.toFixed(2),
                    'Rs.' + Math.max(0, remaining).toFixed(2),
                    isCleared ? 'Cleared' : 'Pending'
                ]);
            });

            doc.autoTable({
                startY: 35,
                head: [['Shop Name', 'Total Bill', 'Total Paid', 'Remaining Due', 'Status']],
                body: tableBody,
                foot: [['', '', 'Grand Total Due:', 'Rs.' + grandDue.toFixed(2), '']],
                headStyles: { fillColor: [241, 245, 249], textColor: [30, 41, 59], fontStyle: 'bold', halign: 'left' },
                footStyles: { fillColor: [241, 245, 249], textColor: [225, 29, 72], fontStyle: 'bold' },
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    1: { halign: 'right' },
                    2: { halign: 'right', textColor: [16, 185, 129] },
                    3: { halign: 'right', fontStyle: 'bold' },
                    4: { halign: 'center' }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                    if (data.section === 'body' && data.column.index === 4) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                },
                margin: { left: 14, right: 14 },
                styles: { fontSize: 9, cellPadding: 4 },
                alternateRowStyles: { fillColor: [248, 250, 252] }
            });

            // Footer note
            const finalY = doc.lastAutoTable.finalY + 6;
            doc.setFontSize(8); doc.setTextColor(148, 163, 184); doc.setFont('helvetica', 'normal');
            doc.text('Generated by Order With Me ERP', pw - 14, finalY, { align: 'right' });

            doc.save(fileName);
            toast("‚úÖ PDF saved!", "success");
        }


        // ===== PDF EXPORT: DUE ‚Äî Separate page per shop =====
        function exportDuePerShopPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Per_Shop_' + today.replace(/ /g, '-') + '.pdf';

            sorted.forEach(([shopName, data], idx) => {
                if (idx > 0) doc.addPage();

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const statusColor = isCleared ? [16, 185, 129] : [225, 29, 72];
                const shopInfo = globalShops[shopName] || {};

                // Header bar
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER WITH ME', 14, 9);
                doc.setFontSize(15); doc.setFont('helvetica', 'bold');
                doc.text(shopName, 14, 20);
                doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                doc.text('Generated: ' + today, pw - 14, 9, { align: 'right' });
                const statusLabel = isCleared ? 'CLEARED' : 'PENDING';
                doc.setTextColor(...statusColor);
                // White bg pill for status
                doc.setFillColor(255,255,255);
                doc.roundedRect(pw - 55, 13, 41, 12, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text(statusLabel, pw - 34.5, 18, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), pw - 34.5, 23, { align: 'center' });

                let y = 35;

                // Shop info
                if (shopInfo.phone || shopInfo.addr) {
                    doc.setTextColor(100, 116, 139); doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                    if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                    if (shopInfo.addr) { doc.text('Addr: ' + shopInfo.addr, 14, y); y += 5; }
                }

                // Summary boxes
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    { label: 'TOTAL BILLED', val: 'Rs.' + data.totalBill.toFixed(2), bg: [240, 244, 255], color: [79, 70, 229] },
                    { label: 'TOTAL PAID', val: 'Rs.' + data.totalPaid.toFixed(2), bg: [240, 255, 248], color: [16, 185, 129] },
                    { label: 'REMAINING DUE', val: 'Rs.' + Math.max(0, remaining).toFixed(2), bg: isCleared ? [240, 255, 248] : [255, 240, 240], color: statusColor }
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(...b.bg);
                    doc.roundedRect(bx, y, boxW, 16, 3, 3, 'F');
                    doc.setTextColor(100, 116, 139); doc.setFontSize(7); doc.setFont('helvetica', 'bold');
                    doc.text(b.label, bx + boxW / 2, y + 5, { align: 'center' });
                    doc.setTextColor(...b.color); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
                    doc.text(b.val, bx + boxW / 2, y + 12, { align: 'center' });
                });
                y += 22;

                // Orders table
                doc.setTextColor(79, 70, 229); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderBody = [];
                if (data.orders && data.orders.length) {
                    [...data.orders].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(o => {
                        const date = o.time ? o.time.toDate().toLocaleDateString('en-GB') : '‚Äî';
                        const items = (o.items || []).map(it => it.id + ' x' + it.qty).join(', ');
                        orderBody.push([date, items || '‚Äî', 'Rs.' + (o.total||0).toFixed(2), o.salesman || '‚Äî']);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Items', 'Amount', 'By']],
                    body: orderBody.length ? orderBody : [['‚Äî', 'No orders', '‚Äî', '‚Äî']],
                    foot: [['', 'Total Billed:', 'Rs.' + data.totalBill.toFixed(2), '']],
                    headStyles: { fillColor: [240, 244, 255], textColor: [79, 70, 229], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 244, 255], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold' }, 3: { halign: 'center' } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                });
                y = doc.lastAutoTable.finalY + 6;

                // Payments table
                doc.setTextColor(16, 185, 129); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payBody = [];
                if (data.payments && data.payments.length) {
                    [...data.payments].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(p => {
                        const date = p.time ? p.time.toDate().toLocaleDateString('en-GB') : '‚Äî';
                        payBody.push([date, p.note || '‚Äî', 'Rs.' + (p.payment||0).toFixed(2)]);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Note', 'Paid']],
                    body: payBody.length ? payBody : [['‚Äî', 'No payments recorded', '‚Äî']],
                    foot: [['', 'Total Paid:', 'Rs.' + data.totalPaid.toFixed(2)]],
                    headStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold', textColor: [16, 185, 129] } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 255, 252] }
                });

                // Page footer
                const ph = doc.internal.pageSize.getHeight();
                doc.setDrawColor(226, 232, 240); doc.setLineWidth(0.3);
                doc.line(14, ph - 10, pw - 14, ph - 10);
                doc.setTextColor(148, 163, 184); doc.setFontSize(7); doc.setFont('helvetica', 'normal');
                doc.text('Order With Me ERP', 14, ph - 6);
                doc.text('Page ' + (idx + 1) + ' of ' + sorted.length, pw - 14, ph - 6, { align: 'right' });
            });

            doc.save(fileName);
            toast("‚úÖ PDF saved!", "success");
        }


        // ===== PDF EXPORT: SINGLE SHOP DUE STATEMENT (jsPDF direct) =====
        function exportSingleShopDuePDF(shopName) {
            try {
                const { jsPDF } = window.jspdf;
                const allShops = buildAllShopsData();
                const data = allShops[shopName];
                if (!data) return toast("No data for this shop", "error");

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const shopInfo = globalShops[shopName] || {};
                const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});

                const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const pw = doc.internal.pageSize.getWidth();
                let y = 15;

                // ‚îÄ‚îÄ Header bar ‚îÄ‚îÄ
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(16); doc.setFont('helvetica','bold');
                doc.text('ORDER WITH ME', 14, 11);
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.text('Shop Due Statement', 14, 18);
                doc.text(`Generated: ${today}`, pw - 14, 18, {align:'right'});
                y = 36;

                // ‚îÄ‚îÄ Shop info ‚îÄ‚îÄ
                doc.setTextColor(26,26,46);
                doc.setFontSize(15); doc.setFont('helvetica','bold');
                doc.text(shopName, 14, y); y += 6;
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.setTextColor(100,116,139);
                if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                if (shopInfo.addr)  { doc.text('Address: ' + shopInfo.addr,  14, y); y += 5; }
                y += 2;

                // ‚îÄ‚îÄ Status badge (right side) ‚îÄ‚îÄ
                const badgeX = pw - 55, badgeY = 34;
                doc.setFillColor(isCleared ? 220 : 254, isCleared ? 252 : 226, isCleared ? 231 : 226);
                doc.roundedRect(badgeX, badgeY, 48, 20, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica','bold');
                doc.setTextColor(isCleared ? 16 : 220, isCleared ? 185 : 38, isCleared ? 129 : 38);
                doc.text(isCleared ? 'CLEARED' : 'PENDING', badgeX + 24, badgeY + 7, {align:'center'});
                doc.setFontSize(13);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), badgeX + 24, badgeY + 16, {align:'center'});

                // ‚îÄ‚îÄ Summary boxes ‚îÄ‚îÄ
                y += 4;
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    {label:'TOTAL BILLED', val:'Rs.'+data.totalBill.toFixed(2), r:66,g:99,b:235},
                    {label:'TOTAL PAID',   val:'Rs.'+data.totalPaid.toFixed(2),  r:16,g:185,b:129},
                    {label:'REMAINING',    val:'Rs.'+Math.max(0,remaining).toFixed(2), r:isCleared?16:244, g:isCleared?185:63, b:isCleared?129:94},
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(245, 247, 255);
                    doc.roundedRect(bx, y, boxW, 18, 2, 2, 'F');
                    doc.setFontSize(7); doc.setFont('helvetica','bold');
                    doc.setTextColor(100,116,139);
                    doc.text(b.label, bx + boxW/2, y + 6, {align:'center'});
                    doc.setFontSize(12); doc.setFont('helvetica','bold');
                    doc.setTextColor(b.r, b.g, b.b);
                    doc.text(b.val, bx + boxW/2, y + 14, {align:'center'});
                });
                y += 24;

                // ‚îÄ‚îÄ Orders table ‚îÄ‚îÄ
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(79, 70, 229);
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderRows = (data.orders||[])
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(o => [
                        o.time ? o.time.toDate().toLocaleDateString('en-GB') : '‚Äî',
                        (o.items||[]).map(it => it.id + ' x' + it.qty).join(', ') || '‚Äî',
                        'Rs.' + (o.total||0).toFixed(2),
                        o.salesman || '‚Äî'
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Items','Amount','Salesman']],
                    body: orderRows.length ? orderRows : [['No orders found','','','']],
                    foot: [['','Total Bill:', 'Rs.'+data.totalBill.toFixed(2),'']],
                    theme: 'grid',
                    headStyles: {fillColor:[79,70,229], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[224,231,255], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}, 0:{cellWidth:25}, 3:{cellWidth:25}},
                    alternateRowStyles: {fillColor:[248,250,255]},
                    margin: {left:14, right:14},
                });
                y = doc.lastAutoTable.finalY + 8;

                // ‚îÄ‚îÄ Payments table ‚îÄ‚îÄ
                if (y > 250) { doc.addPage(); y = 15; }
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(16, 185, 129);
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payRows = [...(data.payments||[])]
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(p => [
                        p.time ? p.time.toDate().toLocaleDateString('en-GB') : '‚Äî',
                        p.note || '‚Äî',
                        'Rs.' + (p.payment||0).toFixed(2)
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Note','Amount Paid']],
                    body: payRows.length ? payRows : [['No payments recorded','','']],
                    foot: [['','Total Paid:', 'Rs.'+data.totalPaid.toFixed(2)]],
                    theme: 'grid',
                    headStyles: {fillColor:[16,185,129], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[209,250,229], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}},
                    alternateRowStyles: {fillColor:[240,255,248]},
                    margin: {left:14, right:14},
                });

                const safeFilename = shopName.replace(/[^a-zA-Z0-9]/g,'_');
                doc.save(`Due_Statement_${safeFilename}_${today.replace(/ /g,'_')}.pdf`);
                toast("‚úÖ PDF saved!", "success");

            } catch(e) {
                console.error("PDF error:", e);
                toast("PDF error: " + e.message, "error");
            }
        }

        // ===== RETURNS =====        // ===== RETURNS =====
        function loadReturnItems() {
            const idx=document.getElementById('returnOrderSel').value;
            const area=document.getElementById('returnItemsArea');
            const list=document.getElementById('returnItemsList');
            if(!idx){area.style.display='none';return;}
            const d=historyData[parseInt(idx)]; if(!d) return;
            list.innerHTML='';
            d.items.forEach((item,i)=>{
                list.innerHTML+=`<div class="return-item-row">
                    <input type="checkbox" id="ret_chk_${i}" value="${i}" style="width:18px;height:18px;cursor:pointer;accent-color:var(--primary);">
                    <label for="ret_chk_${i}" style="flex:1;cursor:pointer;"><b>${item.id}</b> <span style="color:#64748b;">√ó ${item.qty} @ ‚Çπ${item.price.toFixed(2)}</span></label>
                    <input type="number" id="ret_qty_${i}" class="input-field" placeholder="Qty" min="1" max="${item.qty}" value="${item.qty}" style="width:70px;margin-bottom:0;padding:8px 10px;">
                </div>`;
            });
            area.style.display='block';
        }
        async function processReturn() {
            const idx=document.getElementById('returnOrderSel').value;
            if(!idx) return toast("Select an order","error");
            const d=historyData[parseInt(idx)];
            const reason=document.getElementById('returnReason').value.trim();
            let returnItems=[], refundAmt=0;
            d.items.forEach((item,i)=>{
                const chk=document.getElementById(`ret_chk_${i}`);
                if(chk&&chk.checked){
                    const qty=parseInt(document.getElementById(`ret_qty_${i}`).value)||0;
                    if(qty>0&&qty<=item.qty){returnItems.push({...item,qty});refundAmt+=qty*item.price;}
                }
            });
            if(!returnItems.length) return toast("Select at least one item","error");
            if(!confirm(`Process return for ${returnItems.length} item(s)? Refund: ‚Çπ${refundAmt.toFixed(2)}. Stock will be restored.`)) return;
            try{
                for(let item of returnItems){
                    const ref=db.collection("products").doc(item.id);
                    await db.runTransaction(async t=>{const pDoc=await t.get(ref);if(pDoc.exists) t.update(ref,{stock:pDoc.data().stock+item.qty});});
                }
                // Save return doc first, then link the due_entry back to it
                const returnRef = await db.collection("returns").add({orderId:d.orderId,shopName:d.shopName,items:returnItems,refundAmt,reason,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                if(refundAmt>0){
                    const dueRef = await db.collection("due_entries").add({shopName:d.shopName,credit:0,payment:refundAmt,note:`Auto: Return refund (${reason||'return'})`,salesman:userData.name,isReturnEntry:true,returnDocId:returnRef.id,time:firebase.firestore.FieldValue.serverTimestamp()});
                    // Link the due entry ID back into the return document
                    await returnRef.update({dueEntryId: dueRef.id});
                }
                toast(`Return processed! Refund: ‚Çπ${refundAmt.toFixed(2)}`,"success");
                document.getElementById('returnOrderSel').value='';
                document.getElementById('returnItemsArea').style.display='none';
                document.getElementById('returnReason').value='';
            }catch(e){toast(e.message,"error");}
        }
        function populateReturnOrderSel() {
            const sel=document.getElementById('returnOrderSel');
            if(!sel) return;
            sel.innerHTML='<option value="">-- Select Order --</option>';
            historyData.forEach((d,i)=>{
                const ts=d.time?d.time.toDate().toLocaleDateString():'';
                sel.innerHTML+=`<option value="${i}">${d.shopName} ‚Äî ${ts} (‚Çπ${d.total.toFixed(0)})</option>`;
            });
        }

        async function editReturn(docId) {
            const ret = allReturnsData.find(r => r.docId === docId);
            if(!ret) return toast("Record not found","error");
            const newReason = prompt(`Edit return reason:`, ret.reason || '');
            if(newReason === null) return;
            try {
                await db.collection("returns").doc(docId).update({ reason: newReason });
                toast("‚úÖ Return reason updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteReturn(docId, refundAmt) {
            if(!confirm(`Delete this return? The ‚Çπ${refundAmt.toFixed(2)} refund payment will also be reversed from the due/payment ledger.`)) return;
            try {
                const snap = await db.collection("returns").doc(docId).get();
                if(!snap.exists) return toast("Return not found","error");
                const data = snap.data();

                // 1. Delete the linked due_entry (auto refund payment)
                let savedDueData = null;
                let savedDueId = data.dueEntryId || null;
                if(savedDueId) {
                    const dueSnap = await db.collection("due_entries").doc(savedDueId).get();
                    if(dueSnap.exists) {
                        savedDueData = dueSnap.data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                } else {
                    // Fallback: search by returnDocId field for older records
                    const q = await db.collection("due_entries")
                        .where("returnDocId","==",docId)
                        .limit(1).get();
                    if(!q.empty) {
                        savedDueId = q.docs[0].id;
                        savedDueData = q.docs[0].data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                }

                // 2. Reverse stock (deduct back what was restored on return)
                if(data.items && data.items.length) {
                    for(let item of data.items) {
                        const ref = db.collection("products").doc(item.id);
                        await db.runTransaction(async t => {
                            const pDoc = await t.get(ref);
                            if(pDoc.exists) {
                                const newStock = Math.max(0, pDoc.data().stock - item.qty);
                                t.update(ref, {stock: newStock});
                            }
                        });
                    }
                }

                // 3. Delete the return document itself
                await db.collection("returns").doc(docId).delete();
                toast("üóëÔ∏è Return deleted & payment reversed","success");

                // 4. Undo support
                pushUndo(`Return ‚Çπ${refundAmt.toFixed(2)} deleted`, async () => {
                    // Restore return doc
                    await db.collection("returns").doc(docId).set(data);
                    // Restore due entry
                    if(savedDueId && savedDueData) {
                        await db.collection("due_entries").doc(savedDueId).set(savedDueData);
                        await db.collection("returns").doc(docId).update({dueEntryId: savedDueId});
                    }
                    // Re-restore stock
                    if(data.items && data.items.length) {
                        for(let item of data.items) {
                            const ref = db.collection("products").doc(item.id);
                            await db.runTransaction(async t => {
                                const pDoc = await t.get(ref);
                                if(pDoc.exists) t.update(ref, {stock: pDoc.data().stock + item.qty});
                            });
                        }
                    }
                });
            } catch(e) { toast(e.message,"error"); }
        }

        // ===== PDF EXPORT: RETURNS =====
        function exportReturnsPDF() {
            if(!allReturnsData.length) return toast("No returns to export","error");
            const pdfZone = document.getElementById('returns-pdf-zone');
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            let totalRefund = allReturnsData.reduce((s,r)=>s+(r.refundAmt||0), 0);

            let html = `<div style="font-family:Arial,sans-serif;padding:20px;background:white;color:#1a1a2e;">
                <div style="text-align:center;border-bottom:2px solid #4f46e5;padding-bottom:12px;margin-bottom:16px;">
                    <h2 style="margin:0;color:#4f46e5;font-size:20px;letter-spacing:2px;">ORDER WITH ME</h2>
                    <p style="margin:4px 0 0;font-size:12px;color:#64748b;">Returns History Report ‚Äî Generated: ${today}</p>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:20px;">
                <thead><tr style="background:#fff7ed;">
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Date</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Shop</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Items</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Salesman</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Reason</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:right;">Refund</th>
                </tr></thead><tbody>`;

            allReturnsData.forEach(r => {
                const ts = r.time ? r.time.toDate().toLocaleDateString('en-GB') : 'N/A';
                const items = r.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                html += `<tr>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${ts}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;font-weight:700;">${r.shopName}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${items}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${r.salesman}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${r.reason||'‚Äî'}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;text-align:right;color:#f59e0b;font-weight:700;">‚Çπ${(r.refundAmt||0).toFixed(2)}</td>
                </tr>`;
            });

            html += `</tbody><tfoot><tr style="background:#fff7ed;font-weight:800;">
                <td colspan="5" style="padding:10px;border:1px solid #e2e8f0;text-align:right;">Total Refund Amount:</td>
                <td style="padding:10px;border:1px solid #e2e8f0;text-align:right;color:#f59e0b;font-size:14px;">‚Çπ${totalRefund.toFixed(2)}</td>
            </tr></tfoot></table></div>`;

            toast("Generating PDF...");
            const _td3 = document.createElement('div');
            _td3.style.cssText = 'position:fixed;left:-9999px;top:0;width:1060px;background:white;';
            _td3.innerHTML = html;
            document.body.appendChild(_td3);
            html2pdf().set({
                margin:0.4,filename:`Returns_Report_${today.replace(/ /g,'_')}.pdf`,
                image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},
                jsPDF:{unit:'in',format:'a4',orientation:'landscape'}
            }).from(_td3).save().then(() => {
                document.body.removeChild(_td3);
                toast("‚úÖ PDF saved!", "success");
            }).catch(e => { document.body.removeChild(_td3); toast("PDF error: "+e.message,"error"); });
        }

        // ===== SALESMAN PERFORMANCE =====
        function setPerfPeriod(period, btn) {
            document.querySelectorAll('#view-salesman-perf .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            perfPeriod=period;
            renderSalesmanPerf();
        }
        function renderSalesmanPerf() {
            const now=new Date(); let startMs=0;
            if(perfPeriod==='month'){startMs=new Date(now.getFullYear(),now.getMonth(),1).getTime();}
            else if(perfPeriod==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            else if(perfPeriod==='today'){startMs=new Date().setHours(0,0,0,0);}
            const perfMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(startMs&&oMs<startMs) return;
                if(!perfMap[d.salesman]) perfMap[d.salesman]={total:0,orders:0,shops:new Set(),items:0};
                perfMap[d.salesman].total+=d.total; perfMap[d.salesman].orders++;
                perfMap[d.salesman].shops.add(d.shopName);
                d.items.forEach(i=>perfMap[d.salesman].items+=i.qty);
            });
            const sorted=Object.entries(perfMap).sort((a,b)=>b[1].total-a[1].total);
            const maxTotal=sorted.length?sorted[0][1].total:1;
            const medals=['ü•á','ü•à','ü•â'];
            const summaryEl=document.getElementById('perfSummaryCards');
            summaryEl.innerHTML='';
            if(sorted.length){summaryEl.innerHTML=`<div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">üèÜ</span><div class="dc-lbl">Top Salesman</div><div class="dc-val" style="font-size:15px;">${sorted[0][0]}</div></div><div class="dash-card dc-total" style="cursor:default;"><span class="dc-icon">üí∞</span><div class="dc-lbl">Best Revenue</div><div class="dc-val">‚Çπ${(sorted[0][1].total/1000).toFixed(1)}k</div></div>`;}
            const lb=document.getElementById('perfLeaderboard');
            lb.innerHTML='';
            if(!sorted.length){lb.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No data for this period.</div>';return;}
            sorted.forEach(([name,stats],idx)=>{
                const pct=((stats.total/maxTotal)*100).toFixed(0);
                lb.innerHTML+=`<div class="perf-card"><div class="flex-between"><div style="display:flex;align-items:center;gap:8px;"><span class="perf-rank">${medals[idx]||'#'+(idx+1)}</span><div><div style="font-weight:700;font-size:15px;">${name}</div><div style="font-size:11px;color:#64748b;">${stats.orders} orders ¬∑ ${stats.shops.size} shops ¬∑ ${stats.items} items sold</div></div></div><div style="text-align:right;"><div style="font-weight:800;font-size:18px;color:var(--primary);">‚Çπ${stats.total.toFixed(0)}</div><div style="font-size:11px;color:#64748b;">Avg ‚Çπ${(stats.total/stats.orders).toFixed(0)}/order</div></div></div><div class="perf-bar-wrap"><div class="perf-bar" style="width:${pct}%;"></div></div></div>`;
            });
            const cw=document.getElementById('perfChartWrapper');
            cw.style.display=sorted.length>1?'block':'none';
            if(sorted.length>1){
                const ctx=document.getElementById('perfChart').getContext('2d');
                if(perfChartInstance) perfChartInstance.destroy();
                perfChartInstance=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0]),datasets:[{label:'Sales (‚Çπ)',data:sorted.map(s=>s[1].total),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee'],borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            }
        }

        // ===== P&L =====
        function setPnlPeriod(period, btn) {
            document.querySelectorAll('#view-pnl .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            pnlPeriod=period;
            const now=new Date(); let start, end;
            if(period==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);end=now;}
            else if(period==='lastmonth'){start=new Date(now.getFullYear(),now.getMonth()-1,1);end=new Date(now.getFullYear(),now.getMonth(),0);}
            else if(period==='week'){start=new Date(now);start.setDate(now.getDate()-now.getDay());start.setHours(0,0,0,0);end=now;}
            else{start=null;end=null;}
            document.getElementById('pnlStart').value=start?start.toISOString().split('T')[0]:'';
            document.getElementById('pnlEnd').value=end?end.toISOString().split('T')[0]:'';
        }
        function generatePnl() {
            const sVal=document.getElementById('pnlStart').value, eVal=document.getElementById('pnlEnd').value;
            const startMs=sVal?new Date(sVal).setHours(0,0,0,0):0, endMs=eVal?new Date(eVal).setHours(23,59,59,999):Infinity;
            let revenue=0,cost=0,totalQty=0; const itemProfitMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(oMs<startMs||oMs>endMs) return;
                revenue+=d.total;
                d.items.forEach(item=>{
                    totalQty+=item.qty;
                    const purchasePrice=productsMap[item.id]?.costPrice||productsMap[item.id]?.price||0;
                    const itemCost=purchasePrice*item.qty;
                    cost+=itemCost;
                    if(!itemProfitMap[item.id]) itemProfitMap[item.id]={profit:0,qty:0,revenue:0};
                    itemProfitMap[item.id].profit+=item.total-itemCost;
                    itemProfitMap[item.id].qty+=item.qty;
                    itemProfitMap[item.id].revenue+=item.total;
                });
            });
            let returnsDeduction=0;
            allReturnsData.forEach(r=>{const oMs=r.time?r.time.toDate().getTime():0;if(oMs>=startMs&&oMs<=endMs) returnsDeduction+=r.refundAmt||0;});
            const netProfit=revenue-cost-returnsDeduction;
            const margin=revenue>0?((netProfit/revenue)*100).toFixed(1):0;
            const profitColor=netProfit>=0?'var(--success)':'var(--danger)';
            const pp=netProfit>=0?'+':'';
            document.getElementById('pnlRevenue').innerText=`‚Çπ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCost').innerText=`‚Çπ ${cost.toFixed(2)}`;
            document.getElementById('pnlNet').innerText=`${pp}‚Çπ ${netProfit.toFixed(2)}`; document.getElementById('pnlNet').style.color=profitColor;
            document.getElementById('pnlQty').innerText=totalQty;
            document.getElementById('pnlRevDetail').innerText=`‚Çπ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCostDetail').innerText=`‚Çπ ${cost.toFixed(2)}`;
            document.getElementById('pnlReturnsDetail').innerText=`- ‚Çπ ${returnsDeduction.toFixed(2)}`;
            document.getElementById('pnlMargin').innerText=`${margin}%`; document.getElementById('pnlMargin').style.color=parseFloat(margin)>=0?'var(--success)':'var(--danger)';
            document.getElementById('pnlNetDetail').innerText=`${pp}‚Çπ ${netProfit.toFixed(2)}`; document.getElementById('pnlNetDetail').style.color=profitColor;
            const topItems=Object.entries(itemProfitMap).sort((a,b)=>b[1].profit-a[1].profit).slice(0,8);
            const topEl=document.getElementById('pnlTopItems'); topEl.innerHTML='';
            topItems.forEach(([name,stats])=>{
                const pc=stats.profit>=0?'var(--success)':'var(--danger)';
                topEl.innerHTML+=`<div class="pnl-row"><div><b>${name}</b><div style="font-size:11px;color:#94a3b8;">Qty: ${stats.qty} | Rev: ‚Çπ${stats.revenue.toFixed(0)}</div></div><span style="font-weight:700;color:${pc};">${stats.profit>=0?'+':''}‚Çπ${stats.profit.toFixed(2)}</span></div>`;
            });
            if(!topItems.length) topEl.innerHTML='<div style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">No data</div>';
            toast("P&L generated!","success");
        }

        // ===== VISITS =====
        let visitPeriodFilter2='all';
        function setVisitFilter(period, btn) {
            document.querySelectorAll('#view-visits .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            visitPeriodFilter2=period;
            renderVisits();
        }
        async function logVisit() {
            const shop=document.getElementById('visitShopSel').value;
            const note=document.getElementById('visitNote').value.trim();
            if(!shop) return toast("Select a shop","error");
            try{
                await db.collection("visits").add({shopName:shop,note,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                toast("Visit logged!","success"); document.getElementById('visitNote').value='';
            }catch(e){toast(e.message,"error");}
        }

        async function deleteVisit(docId) {
            try {
                const snap = await db.collection("visits").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("visits").doc(docId).delete();
                toast("üóëÔ∏è Visit deleted","success");
                pushUndo("Visit record deleted", async () => {
                    if(data) await db.collection("visits").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function renderVisits() {
            const area=document.getElementById('visitListArea');
            const salesmanF=document.getElementById('visitSalesmanFilter')?.value||'all';
            const now=new Date(); let startMs=0;
            if(visitPeriodFilter2==='today') startMs=new Date().setHours(0,0,0,0);
            else if(visitPeriodFilter2==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            const vss=document.getElementById('visitShopSel');
            if(vss){vss.innerHTML='<option value="">-- Select Shop Visited --</option>';Object.keys(globalShops).forEach(k=>vss.innerHTML+=`<option value="${k}">${globalShops[k].name||k}</option>`);}
            let filtered=allVisitsData.filter(v=>{
                const vMs=v.time?v.time.toDate().getTime():0;
                if(startMs&&vMs<startMs) return false;
                if(salesmanF!=='all'&&v.salesman!==salesmanF) return false;
                if(userData.role!=='manager'&&v.salesman!==userData.name) return false;
                return true;
            });
            visitExportArray=filtered.map(v=>({Date:v.time?v.time.toDate().toLocaleString():'',Shop:v.shopName,Salesman:v.salesman,Note:v.note||''}));
            document.getElementById('visitCount').innerText=`(${filtered.length})`;
            area.innerHTML='';
            if(!filtered.length){area.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No visits found.</div>';return;}
            filtered.forEach(v=>{
                const ts=v.time?v.time.toDate().toLocaleString():'';
                const safeDocId = v.docId ? v.docId.replace(/'/g,"\\'") : '';
                const canDelete = (userData.role==='manager' || v.salesman===userData.name);
                area.innerHTML+=`<div class="visit-card">
                    <div class="flex-between">
                        <div class="vc-shop">üè™ ${v.shopName}</div>
                        ${canDelete && safeDocId ? `<button class="action-btn action-btn-delete" onclick="deleteVisit('${safeDocId}')">üóëÔ∏è</button>` : ''}
                    </div>
                    <div class="vc-meta">üë§ ${v.salesman} &nbsp;|&nbsp; üïê ${ts}</div>
                    ${v.note?`<div style="margin-top:6px;font-size:13px;color:var(--text);">${v.note}</div>`:''}
                </div>`;
            });
        }

        // ===== PDF EXPORT: VISITS =====
        function exportVisitsPDF() {
            if(!visitExportArray.length) return toast("No visits to export","error");
            const pdfZone = document.getElementById('visits-pdf-zone');
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});

            let html = `<div style="font-family:Arial,sans-serif;padding:20px;background:white;color:#1a1a2e;">
                <div style="text-align:center;border-bottom:2px solid #4f46e5;padding-bottom:12px;margin-bottom:16px;">
                    <h2 style="margin:0;color:#4f46e5;font-size:20px;letter-spacing:2px;">ORDER WITH ME</h2>
                    <p style="margin:4px 0 0;font-size:12px;color:#64748b;">Shop Visit Log ‚Äî Generated: ${today}</p>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                <thead><tr style="background:#f0f9ff;">
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Date & Time</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Shop</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Salesman</th>
                    <th style="padding:8px 10px;border:1px solid #e2e8f0;text-align:left;">Notes</th>
                </tr></thead><tbody>`;

            visitExportArray.forEach((v,i) => {
                const bg = i % 2 === 0 ? '' : 'background:#f8faff;';
                html += `<tr style="${bg}">
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${v.Date}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;font-weight:700;">${v.Shop}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${v.Salesman}</td>
                    <td style="padding:7px 10px;border:1px solid #e2e8f0;">${v.Note||'‚Äî'}</td>
                </tr>`;
            });

            html += `</tbody><tfoot><tr style="background:#f0f9ff;">
                <td colspan="4" style="padding:8px 10px;border:1px solid #e2e8f0;font-size:11px;color:#64748b;text-align:right;">
                    Total ${visitExportArray.length} visit(s) shown
                </td>
            </tr></tfoot></table></div>`;

            toast("Generating PDF...");
            const _td4 = document.createElement('div');
            _td4.style.cssText = 'position:fixed;left:-9999px;top:0;width:1060px;background:white;';
            _td4.innerHTML = html;
            document.body.appendChild(_td4);
            html2pdf().set({
                margin:0.4,filename:`Shop_Visits_${today.replace(/ /g,'_')}.pdf`,
                image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},
                jsPDF:{unit:'in',format:'a4',orientation:'landscape'}
            }).from(_td4).save().then(() => {
                document.body.removeChild(_td4);
                toast("‚úÖ PDF saved!", "success");
            }).catch(e => { document.body.removeChild(_td4); toast("PDF error: "+e.message,"error"); });
        }

        // ===== SHOP NOTES / REMARKS =====
        let allShopNotes = [];
        const NOTE_TAG_LABELS = {
            general: 'üìå General', payment: 'üí∞ Payment',
            closed: 'üö´ Closed Info', complaint: '‚ö†Ô∏è Complaint', preference: '‚≠ê Preference'
        };

        async function saveShopNote() {
            const shop = document.getElementById('noteShopSel').value;
            const text = document.getElementById('noteText').value.trim();
            const tag  = document.getElementById('noteTag').value;
            if (!shop) return toast('Please select a shop', 'error');
            if (!text) return toast('Please write a note', 'error');
            try {
                await db.collection('shop_notes').add({
                    shopName: shop, text, tag,
                    author: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast('‚úÖ Note saved!', 'success');
                document.getElementById('noteText').value = '';
            } catch(e) { toast(e.message, 'error'); }
        }

        async function deleteShopNote(docId) {
            if (!confirm('Delete this note?')) return;
            try {
                await db.collection('shop_notes').doc(docId).delete();
                toast('üóëÔ∏è Note deleted', 'success');
            } catch(e) { toast(e.message, 'error'); }
        }

        function renderShopNotes() {
            const area = document.getElementById('shopNotesArea');
            if (!area) return;
            const shopF = (document.getElementById('noteFilterShop')?.value) || 'all';
            const tagF  = (document.getElementById('noteFilterTag')?.value) || 'all';

            let filtered = allShopNotes.filter(n => {
                if (shopF !== 'all' && n.shopName !== shopF) return false;
                if (tagF  !== 'all' && n.tag !== tagF) return false;
                return true;
            });

            if (!filtered.length) {
                area.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">No notes found.</div>';
                return;
            }

            // Group by shop
            const byShop = {};
            filtered.forEach(n => {
                if (!byShop[n.shopName]) byShop[n.shopName] = [];
                byShop[n.shopName].push(n);
            });

            area.innerHTML = Object.entries(byShop).map(([shopName, notes]) => `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; font-weight:800; color:var(--primary); margin-bottom:6px;
                                text-transform:uppercase; letter-spacing:0.5px;">
                        üè™ ${shopName}
                        <span class="shop-note-badge">${notes.length} note${notes.length>1?'s':''}</span>
                    </div>
                    ${notes.map(n => {
                        const ts = n.time ? n.time.toDate().toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
                        const canDel = userData.role === 'manager' || n.author === userData.name;
                        return `<div class="shop-note-card">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                                <div style="flex:1;">
                                    <span style="font-size:10px; font-weight:700; background:rgba(245,158,11,0.2);
                                           color:#b45309; border-radius:20px; padding:1px 8px;">
                                        ${NOTE_TAG_LABELS[n.tag] || n.tag}
                                    </span>
                                    <div class="note-text" style="margin-top:6px;">${n.text}</div>
                                    <div class="note-meta">üë§ ${n.author} ¬∑ üïê ${ts}</div>
                                </div>
                                ${canDel ? `<button onclick="deleteShopNote('${n.docId}')"
                                    style="background:none; border:none; cursor:pointer; font-size:14px;
                                           color:#94a3b8; padding:2px 4px; flex-shrink:0;"
                                    title="Delete">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>`).join('');
        }

        function populateNoteShopSelects() {
            const sel = document.getElementById('noteShopSel');
            const filterSel = document.getElementById('noteFilterShop');
            if (!sel) return;
            const shops = Object.keys(globalShops).sort();
            sel.innerHTML = '<option value="">-- Select Shop --</option>' +
                shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            if (filterSel) {
                filterSel.innerHTML = '<option value="all">All Shops</option>' +
                    shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            }
        }

        // ===== ORDER PANEL ‚Äî DUE ALERT =====
        function showOrderDueAlert(shopName) {
            const el = document.getElementById('orderDueAlert');
            if (!el) return;
            if (!shopName) { el.style.display = 'none'; el.innerHTML = ''; return; }

            const { totalBill, totalPaid } = getShopDueStats(shopName);
            const remaining = totalBill - totalPaid;

            if (remaining <= 0) {
                // Cleared ‚Äî show green tick briefly
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px 14px;
                                background:rgba(16,185,129,0.1); border:1.5px solid rgba(16,185,129,0.3);
                                border-radius:12px; font-size:13px;">
                        <span style="font-size:18px;">‚úÖ</span>
                        <div>
                            <div style="font-weight:700; color:#065f46;">No Pending Due</div>
                            <div style="font-size:11px; color:#047857;">This shop has cleared all payments</div>
                        </div>
                    </div>`;
            } else {
                const pct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 0;
                const isHigh = remaining > 5000;
                const borderCol = isHigh ? 'rgba(244,63,94,0.5)' : 'rgba(245,158,11,0.5)';
                const bgCol    = isHigh ? 'rgba(244,63,94,0.08)' : 'rgba(245,158,11,0.08)';
                const textCol  = isHigh ? '#be123c' : '#92400e';
                const icon     = isHigh ? 'üî¥' : 'üü°';
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="padding:12px 14px; background:${bgCol}; border:1.5px solid ${borderCol};
                                border-radius:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-size:18px;">${icon}</span>
                                <div>
                                    <div style="font-weight:800; font-size:13px; color:${textCol};">Pending Due Alert</div>
                                    <div style="font-size:10px; color:#64748b;">Collect payment before placing order</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px; font-weight:900; color:${textCol};">‚Çπ${remaining.toFixed(2)}</div>
                                <div style="font-size:10px; color:#64748b;">remaining</div>
                            </div>
                        </div>
                        <div style="background:rgba(0,0,0,0.06); border-radius:99px; height:6px; overflow:hidden; margin-bottom:6px;">
                            <div style="width:${pct.toFixed(0)}%; height:100%; border-radius:99px;
                                        background:${isHigh ? '#f43f5e' : '#f59e0b'}; transition:width 0.5s;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:#64748b;">
                            <span>Total Billed: ‚Çπ${totalBill.toFixed(2)}</span>
                            <span>Paid: ‚Çπ${totalPaid.toFixed(2)} (${pct.toFixed(0)}%)</span>
                        </div>
                    </div>`;
            }
        }

        // ===== SWITCH VIEW =====
        function switchView(v) {
            document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
            const viewEl = document.getElementById('view-'+v);
            if(viewEl) viewEl.classList.add('active');
            document.getElementById('pageTitle').innerText=v.toUpperCase().replace(/-/g,' ');
            trackUsage(v);
            renderSidebar();
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow='';
            if(v==='order') {
                const al=document.getElementById('orderDueAlert');
                if(al){al.style.display='none';al.innerHTML='';}
                // If shop already selected (e.g. redirected from edit), show alert
                const os = document.getElementById('orderShop');
                if(os && os.value) showOrderDueAlert(os.value);
            }
            if(v==='salesman-perf') renderSalesmanPerf();
            if(v==='visits') renderVisits();
            if(v==='due') renderDueList();
            if(v==='returns') populateReturnOrderSel();
            if(v==='dashboard') renderQuickAccess();
            if(v==='shop-notes') { populateNoteShopSelects(); renderShopNotes(); }
        }
    </script>
</body>
</html>
