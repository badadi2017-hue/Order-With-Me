<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order With Me - ERP</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --secondary: #1e40af; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --success: #10b981; --danger: #ef4444; --border: #d1d5db; --warning: #f59e0b;}
        body.dark-mode { --bg: #111827; --card: #1f2937; --text: #f9fafb; --border: #374151; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); transition: 0.3s; padding-bottom: 30px;}
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden;}
        .input-field { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; font-family: inherit; background: var(--card); color: var(--text); outline: none; transition: 0.3s; }
        .input-field:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        /* Screens */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        #app-screen { display: none; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar & Header */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; background: var(--card); box-shadow: 5px 0 20px rgba(0,0,0,0.2); transition: 0.3s; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column;}
        .sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 999; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .menu-item { padding: 12px 15px; border-radius: 10px; font-size: 14px; cursor: pointer; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s;}
        .menu-item:hover { background: rgba(37, 99, 235, 0.1); }
        .menu-item.active-menu { background: var(--primary); color: white; }
        
        /* Dashboard Cards & Animations */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .dash-card { background: linear-gradient(145deg, var(--card), var(--bg)); border-left: 4px solid var(--primary); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-success { border-left-color: var(--success); }
        .card-warning { border-left-color: var(--warning); }
        .card-danger { border-left-color: var(--danger); }
        
        /* Tables */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; min-width: 600px; }
        .data-table th { background: rgba(37, 99, 235, 0.1); padding: 12px; border-bottom: 2px solid var(--border); color: var(--text); white-space: nowrap; }
        .data-table td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text); }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 15px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; display: none; border-left: 5px solid var(--primary); font-weight: bold;}

        /* Highight Box */
        .highlight-box { display: none; background: #e0f2fe; border: 1px solid #7dd3fc; color: #0369a1; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 12px; font-weight: bold; line-height: 1.5; }

        /* Custom Toggle Box */
        .toggle-box { display: flex; background: var(--bg); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border); overflow: hidden; }
        .toggle-box label { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.3s; color: var(--text); }
        .toggle-box label:has(input:checked) { background: var(--primary); color: white; }
        .toggle-box input { display: none; }

        /* A5 Billing Design */
        .bill-container { background: white; color: black; max-width: 500px; margin: 0 auto; padding: 25px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #ddd; position: relative;}
        .bill-header { text-align: center; border-bottom: 2px solid #2563eb; padding-bottom: 15px; margin-bottom: 15px; }
        .bill-header h1 { margin: 0; color: #2563eb; font-size: 24px; text-transform: uppercase; letter-spacing: 1px;}
        .bill-meta { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 20px; }
        .bill-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 20px; }
        .bill-table th { background: #f3f4f6; padding: 8px; text-align: left; border-bottom: 2px solid #000; }
        .bill-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .bill-total { text-align: right; font-size: 16px; font-weight: bold; border-top: 2px solid #000; padding-top: 10px; }
        
        @media print {
            body * { visibility: hidden; background: white; }
            #a5-print-zone, #a5-print-zone * { visibility: visible; }
            #a5-print-zone { position: absolute; left: 0; top: 0; width: 100%; max-width: 148mm; margin: 0; padding: 0; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <div id="auth-screen">
        <div id="login-box" class="card" style="width: 100%; max-width: 380px; text-align: center;">
            <h2 style="color: var(--primary); margin-bottom: 5px;">Order With Me</h2>
            <p>Login with username</p>
            <input type="text" id="loginUsername" class="input-field" placeholder="Username">
            <input type="password" id="loginPassword" class="input-field" placeholder="Password">
            <button class="btn btn-success" onclick="loginUser()" id="btnLogin">Login</button>
            <p style="font-size: 13px;">No account? <span style="color:var(--primary); font-weight:600; cursor:pointer;" onclick="toggleAuthView('reg')">Register here</span></p>
        </div>

        <div id="reg-box" class="card" style="width: 100%; max-width: 380px; display: none;">
            <h2 style="text-align: center; color: var(--primary);">New Account</h2>
            <input type="text" id="regName" class="input-field" placeholder="Full Name">
            <input type="text" id="regUser" class="input-field" placeholder="Unique Username">
            <input type="password" id="regPass" class="input-field" placeholder="Password (min 6 chars)">
            <select id="regRole" class="input-field" onchange="document.getElementById('pinBox').style.display = this.value=='manager'?'block':'none'">
                <option value="salesman">Salesman</option>
                <option value="manager">Manager</option>
            </select>
            <input type="password" id="pinBox" class="input-field" placeholder="Manager PIN (12345)" style="display:none;">
            <button class="btn" onclick="registerUser()" id="btnReg">Create Account</button>
            <p style="text-align: center; font-size: 13px;">Have account? <span style="color:var(--primary); font-weight:600; cursor:pointer;" onclick="toggleAuthView('login')">Login here</span></p>
        </div>
    </div>

    <div id="app-screen">
        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
        <div class="sidebar" id="sidebar">
            <span style="position: absolute; top: 20px; right: 20px; font-size: 12px; font-weight:bold; color: var(--primary); background: rgba(37, 99, 235, 0.1); padding: 4px 8px; border-radius: 6px;">V1.3.5</span>
            
            <div>
                <h3 id="sideName" style="margin-top:0; padding-right: 60px;">User</h3>
                <p id="sideRole" style="font-size:12px; color:gray; text-transform:uppercase; margin-bottom:20px;">Role</p>
                
                <div class="menu-item active-menu" id="m-dashboard" onclick="switchView('dashboard')">üìä Dashboard</div>
                <div class="menu-item" id="m-order" onclick="switchView('order')">üõí Order Panel</div>
                <div class="menu-item" id="m-history" onclick="switchView('history')">üìú Live History</div>
                <div class="menu-item" id="m-billing" onclick="switchView('billing')" style="display:none;">üßæ Billing & Invoice</div>
                
                <hr style="border:0; border-top:1px solid var(--border); margin:10px 0;">
                <div style="font-size:11px; font-weight:bold; margin-bottom:5px; color:gray;">BUSINESS LEDGERS</div>
                
                <div class="menu-item" id="m-stock" onclick="switchView('stock')">üì¶ Current Stock</div>
                <div class="menu-item" id="m-sales" onclick="switchView('sales')" style="display:none;">üí∞ Sales Ledger</div>
                <div class="menu-item" id="m-purchase" onclick="switchView('purchase')" style="display:none;">üìâ Purchase History</div>
                <div class="menu-item" id="m-reports" onclick="switchView('reports')" style="display:none;">üìà Custom Reports</div>
                
                <div class="menu-item" id="m-admin" onclick="switchView('admin')" style="display:none; margin-top:10px; border:1px dashed var(--primary);">‚öôÔ∏è Manager Panel</div>
                
                <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                <div class="menu-item" style="background:var(--bg)">
                    <span>Dark Mode</span>
                    <input type="checkbox" onchange="document.body.classList.toggle('dark-mode')">
                </div>
                <button class="btn" onclick="logoutApp()" style="margin-top:10px; background:var(--danger)">Logout</button>
            </div>
            
            <div style="margin-top: auto; padding-top: 20px; text-align: center; font-size: 13px; font-weight: 600; color: gray;">
                Made With ‚ù§Ô∏è By Aditya
            </div>
        </div>

        <div class="header no-print">
            <div style="display:flex; align-items:center; gap:15px;">
                <span onclick="toggleMenu()" style="font-size:24px; cursor:pointer;">‚ò∞</span>
                <h3 id="pageTitle" style="margin:0; font-size:18px;">DASHBOARD</h3>
            </div>
            <div id="realTimeClock" style="text-align: right; line-height: 1.2;"></div>
        </div>

        <div style="padding: 20px;">
            
            <div id="view-dashboard" class="view active">
                <h3 style="margin-top:0; margin-bottom:15px; color:var(--primary);">Welcome Back, <span id="dashWelcomeName">User</span>! üëã</h3>
                
                <div class="dash-grid">
                    <div class="dash-card card-success card" style="padding: 15px;">
                        <div style="font-size:12px; color:gray; display:flex; justify-content:space-between;"><span>Today's Sales</span> <span style="font-size:16px;">üìÖ</span></div>
                        <div style="font-size:22px; font-weight:bold; color:var(--success); margin-top:5px;" id="dashTodaySales">‚Çπ 0.00</div>
                    </div>
                    <div class="dash-card card" style="padding: 15px;">
                        <div style="font-size:12px; color:gray; display:flex; justify-content:space-between;"><span>Total Sales</span> <span style="font-size:16px;">üí∞</span></div>
                        <div style="font-size:22px; font-weight:bold; color:var(--primary); margin-top:5px;" id="dashTotalSales">‚Çπ 0.00</div>
                    </div>
                    <div class="dash-card card" style="padding: 15px;">
                        <div style="font-size:12px; color:gray; display:flex; justify-content:space-between;"><span>Total Orders</span> <span style="font-size:16px;">üì¶</span></div>
                        <div style="font-size:22px; font-weight:bold; color:var(--text); margin-top:5px;" id="dashTotalOrders">0</div>
                    </div>
                    <div class="dash-card card-danger card" style="padding: 15px;">
                        <div style="font-size:12px; color:gray; display:flex; justify-content:space-between;"><span>Low Stock Items</span> <span style="font-size:16px;">‚ö†Ô∏è</span></div>
                        <div style="font-size:22px; font-weight:bold; color:var(--danger); margin-top:5px;" id="dashLowStockCount">0</div>
                    </div>
                </div>

                <div class="card">
                    <div style="font-weight:bold; margin-bottom:5px; font-size:14px; color:gray;">üèÜ Top Shop (Highest Billed)</div>
                    <div id="dashTopShop" style="font-size: 18px; color: var(--secondary); font-weight: bold;">Loading...</div>
                    <div id="dashTopShopAmount" style="font-size: 13px; color: var(--success); font-weight:600; margin-top:2px;">‚Çπ 0.00</div>
                </div>

                <div class="card">
                    <div style="font-weight:bold; margin-bottom:10px; font-size:14px; color:var(--danger);">‚ö†Ô∏è Refill Alert (Stock ‚â§ 5)</div>
                    <div id="dashLowStockList" style="font-size: 13px; color: gray; max-height: 150px; overflow-y: auto;">
                        Loading...
                    </div>
                </div>
            </div>

            <div id="view-order" class="view">
                <div class="card">
                    <label style="font-size: 12px; font-weight: bold;">Select Shop</label>
                    <select id="orderShop" class="input-field" style="margin-bottom:0;"><option value="">-- Select Shop --</option></select>
                </div>
                <div class="card">
                    <div style="font-weight:bold; margin-bottom:10px;">Search & Add Items</div>
                    
                    <input type="text" id="orderItemInput" list="orderItemDatalist" class="input-field" placeholder="üîç Type item name to search..." oninput="showPriceInfo()" autocomplete="off">
                    <datalist id="orderItemDatalist"></datalist>
                    
                    <div class="toggle-box">
                        <label>
                            <input type="radio" name="priceMode" value="auto" checked onchange="togglePriceMode()"> ü§ñ Auto Price
                        </label>
                        <label style="border-left: 1px solid var(--border);">
                            <input type="radio" name="priceMode" value="manual" onchange="togglePriceMode()"> ‚úçÔ∏è Manual Price
                        </label>
                    </div>

                    <div id="priceHighlightBox" class="highlight-box"></div>
                    
                    <div id="manualPriceContainer" style="display: none;">
                        <input type="number" id="manualPriceInput" class="input-field" placeholder="Enter manual/discounted price (‚Çπ)">
                    </div>

                    <div class="flex-between">
                        <input type="number" id="orderQty" class="input-field" placeholder="Qty" style="margin-bottom:0; flex:1;">
                        <button class="btn btn-outline" onclick="addToCart()" style="margin-bottom:0; width:70px; margin-left:10px;">Add</button>
                        <button class="btn btn-outline" onclick="undoCart()" style="margin-bottom:0; width:75px; margin-left:10px; border-color:var(--warning); color:var(--warning);">Undo</button>
                    </div>
                </div>
                <div class="card" id="cartCard" style="display:none;">
                    <div style="font-weight:bold; margin-bottom:10px;">Cart Items</div>
                    <div id="cartList"></div>
                    <div class="flex-between" style="margin-top:15px; font-weight:bold;">
                        <span>Total:</span><span id="cartTotal" style="color:var(--primary); font-size:18px;">‚Çπ 0.00</span>
                    </div>
                    <button class="btn btn-success" onclick="placeFinalOrder()" id="btnPlace" style="margin-top:15px;" >Place Final Order</button>
                </div>
            </div>

            <div id="view-history" class="view">
                <div id="historyList"><div style="text-align:center; padding:20px;">Loading...</div></div>
            </div>

            <div id="view-billing" class="view">
                <div class="card no-print">
                    <label style="font-size: 12px; font-weight: bold;">Select Order to Generate Bill</label>
                    <select id="billingSelect" class="input-field" onchange="renderA5Bill()"><option value="">-- Choose an Order --</option></select>
                </div>
                <div id="bill-preview-section" style="display:none;">
                    <div class="flex-between no-print" style="margin-bottom: 15px;">
                        <button class="btn btn-outline" onclick="window.print()" style="margin-bottom:0; flex:1;">üñ®Ô∏è Print</button>
                        <button class="btn btn-success" onclick="downloadA5PDF()" style="margin-bottom:0; flex:1; margin-left:10px;">üíæ Save PDF</button>
                    </div>
                    <div id="a5-print-zone" class="bill-container">
                        <div class="bill-header">
                            <h1>Order With Me</h1>
                            <p>Official Retail Invoice</p>
                        </div>
                        <div class="bill-meta">
                            <div>
                                <strong>Billed To:</strong> <br>
                                <span id="b-shopName">Shop Name</span><br>
                                <span id="b-shopPhone" style="color:#666;">Phone</span>
                            </div>
                            <div style="text-align:right;">
                                <strong>Date:</strong> <span id="b-date">DD/MM/YYYY</span><br>
                                <strong>Sales Rep:</strong> <span id="b-salesman">Name</span><br>
                                <strong>Bill No:</strong> <span id="b-orderId">#0000</span>
                            </div>
                        </div>
                        <table class="bill-table">
                            <thead>
                                <tr><th style="width: 10%;">Sl</th><th style="width: 50%;">Description</th><th style="width: 15%;">Qty</th><th style="width: 25%; text-align:right;">Amount</th></tr>
                            </thead>
                            <tbody id="b-itemsBody"></tbody>
                        </table>
                        <div class="bill-total">
                            Grand Total: ‚Çπ <span id="b-grandTotal">0.00</span>
                        </div>
                        <div class="bill-footer">
                            <p>Computer generated invoice. No signature required.</p>
                            <p>Thank you for your business!</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-stock" class="view">
                <div class="flex-between" style="margin-bottom:10px; flex-wrap: wrap;">
                    <div>
                        <h3 style="margin:0; font-size:16px;">Inventory Status</h3>
                        <div style="font-size:14px; font-weight:bold; color:var(--primary); margin-top:5px;">
                            Total Value: <span id="stockTotalValue">‚Çπ 0.00</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <input type="text" id="stockSearch" onkeyup="filterStock()" placeholder="üîç Search item..." class="input-field" style="margin-bottom:5px; padding: 6px 10px; min-width: 180px;">
                        <div>
                            <button onclick="exportAnyTable('stockDataArea', 'Inventory_Stock_Report', 'pdf')" class="btn-outline" style="padding:4px 8px; border-radius:5px; cursor:pointer; font-size: 12px;">üìÑ PDF</button>
                            <button onclick="exportDataExcel(stockDataArray, 'Inventory_Stock_Report')" class="btn-success" style="border:none; color:white; padding:4px 8px; border-radius:5px; cursor:pointer; font-size: 12px; margin-left:5px;">üì• Excel</button>
                        </div>
                    </div>
                </div>
                <div class="card table-wrapper" id="stockDataArea">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Price (‚Çπ)</th>
                                <th>Disc (%)</th> 
                                <th class="mgr-action no-print" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-sales" class="view">
                <div class="flex-between" style="margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px;">Sales Ledger</h3>
                    <div>
                        <button onclick="exportAnyTable('salesDataArea', 'Sales_Ledger_Report', 'pdf')" class="btn-outline" style="padding:4px 8px;">üìÑ PDF</button>
                        <button onclick="exportDataExcel(salesDataArray, 'Sales_Ledger_Report')" class="btn-success" style="padding:4px 8px; border:none; color:white; margin-left:5px;">üì• Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="salesDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date & Time</th><th>Party/Shop</th><th>Items Sold</th><th>Total (‚Çπ)</th><th>Salesman</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-purchase" class="view">
                <div class="flex-between" style="margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px;">Purchase History</h3>
                    <div>
                        <input type="file" id="importExcelFile" accept=".xlsx, .xls" onchange="handleExcelImport(event)" style="display:none;">
                        <button onclick="document.getElementById('importExcelFile').click()" class="btn-outline mgr-action" style="padding:4px 8px; display:none;">üì§ Import Excel</button>
                        <button onclick="exportAnyTable('purchaseDataArea', 'Purchase_History_Report', 'pdf')" class="btn-outline" style="padding:4px 8px; margin-left:5px;">üìÑ PDF</button>
                        <button onclick="exportDataExcel(purchaseDataArray, 'Purchase_History_Report')" class="btn-success" style="padding:4px 8px; border:none; color:white; margin-left:5px;">üì• Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="purchaseDataArea">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Added Qty</th>
                                <th>Price (‚Çπ)</th>
                                <th>Dealer/Info</th>
                                <th class="mgr-action no-print" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reports" class="view">
                <div class="card no-print">
                    <h3 style="margin-top:0; color:var(--primary);">Advanced Report Filter</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 15px;">
                        <div><label style="font-size:12px; font-weight:bold;">Start Date</label><input type="date" id="repStartDate" class="input-field" style="margin-bottom: 0;"></div>
                        <div><label style="font-size:12px; font-weight:bold;">End Date</label><input type="date" id="repEndDate" class="input-field" style="margin-bottom: 0;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 15px;">
                        <div><label style="font-size:12px; font-weight:bold;">Select Shop</label><select id="repShop" class="input-field" style="margin-bottom: 0;"><option value="all">All Shops</option></select></div>
                        <div><label style="font-size:12px; font-weight:bold;">Select Item</label><select id="repItem" class="input-field" style="margin-bottom: 0;"><option value="all">All Items</option></select></div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:12px; font-weight:bold;">Select Salesman</label>
                        <select id="repSalesman" class="input-field" style="margin-bottom: 0;"><option value="all">All Salesmen</option></select>
                    </div>

                    <button class="btn btn-success" onclick="generateCustomReport()">üîç Generate Report</button>
                </div>

                <div id="reportResultArea" style="display:none;">
                    <div class="flex-between" style="margin-bottom:15px;">
                        <div class="card" style="flex:1; text-align:center; margin-bottom:0;">
                            <div style="font-size:11px; color:gray;">Filtered Sales</div>
                            <div style="font-size:18px; font-weight:bold; color:var(--success);" id="repTotalAmount">‚Çπ 0.00</div>
                        </div>
                        <div class="card" style="flex:1; text-align:center; margin-bottom:0; margin-left:10px;">
                            <div style="font-size:11px; color:gray;">Items Sold</div>
                            <div style="font-size:18px; font-weight:bold; color:var(--primary);" id="repTotalQty">0</div>
                        </div>
                    </div>
                    
                    <div class="flex-between" style="margin-bottom:10px;">
                        <h3 style="margin:0; font-size:16px;">Report Data</h3>
                        <div>
                            <button onclick="exportAnyTable('repDataArea', 'Custom_Filtered_Report', 'pdf')" class="btn-outline" style="padding:4px 8px;">üìÑ PDF</button>
                            <button onclick="exportDataExcel(customReportArray, 'Custom_Filtered_Report')" class="btn-success" style="padding:4px 8px; border:none; color:white; margin-left:5px;">üì• Excel</button>
                        </div>
                    </div>

                    <div class="card table-wrapper" id="repDataArea">
                        <table class="data-table">
                            <thead><tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (‚Çπ)</th><th>Salesman</th></tr></thead>
                            <tbody id="repTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="view">
                <div class="card">
                    <div style="font-weight:bold; margin-bottom:10px;">Add/Manage Shop</div>
                    <input type="text" id="shopName" class="input-field" placeholder="Shop Name">
                    <input type="tel" id="shopPhone" class="input-field" placeholder="Phone Number">
                    <input type="text" id="shopAddr" class="input-field" placeholder="Address">
                    <button class="btn btn-outline" onclick="addShop()">Save Shop</button>
                </div>
                
                <div class="card">
                    <div style="font-weight:bold; margin-bottom:5px;">Add/Refill Product</div>
                    <p style="font-size: 11px; color: gray; margin-bottom: 10px;">This will automatically record in Purchase History.</p>
                    <input type="text" id="prodName" class="input-field" placeholder="Product Name (e.g., Lays 10/-)" list="adminProductList">
                    <datalist id="adminProductList"></datalist>
                    <div class="flex-between">
                        <input type="number" id="prodStock" class="input-field" placeholder="New Stock (+)">
                        <input type="number" id="prodPrice" class="input-field" placeholder="Price (‚Çπ)">
                    </div>
                    <input type="text" id="purchaseInfo" class="input-field" placeholder="Dealer/Bill Info">
                    <button class="btn btn-outline" onclick="addProduct()">Save & Log Purchase</button>
                </div>

                <div class="card" style="border: 1px solid var(--danger);">
                    <div style="font-weight:bold; margin-bottom:10px; color:var(--danger);">Delete Shop / Product</div>
                    <p style="font-size: 11px; color: gray; margin-bottom: 10px; margin-top:0;">Careful: This action cannot be undone.</p>
                    <div class="flex-between">
                        <select id="delShopSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Shop to Delete --</option></select>
                        <button class="btn" style="background:var(--danger); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteShop()">Delete</button>
                    </div>
                    <div class="flex-between" style="margin-top:15px;">
                        <select id="delItemSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Item to Delete --</option></select>
                        <button class="btn" style="background:var(--danger); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteProductFromAdmin()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è Firebase Configuration ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSyDRm8zdyHdYmaXm5o34GTV3uYkrMPfVfGI",
            authDomain: "order-with-me-636dd.firebaseapp.com",
            projectId: "order-with-me-636dd",
            storageBucket: "order-with-me-636dd.firebasestorage.app",
            messagingSenderId: "437851738821",
            appId: "1:437851738821:web:d923816bfd764793db96ac"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let userData = {}, cart = [], historyData = [];
        let globalShops = {}; 
        let stockDataArray = [], salesDataArray = [], purchaseDataArray = [], customReportArray = [];
        let productsMap = {};

        function toast(msg, type="normal") {
            const t = document.getElementById('toast');
            t.innerText = msg; 
            t.style.borderLeftColor = type==='error'?'red':'green';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // ==========================================
        // REAL TIME CLOCK
        // ==========================================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const clockEl = document.getElementById('realTimeClock');
            if(clockEl) {
                clockEl.innerHTML = `<div style="font-weight:bold; font-size:15px; color:var(--bg);">${timeStr}</div><div style="font-size:10px; color:rgba(255,255,255,0.8);">${dateStr}</div>`;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ==========================================
        // AUTH & ROLE HANDLING
        // ==========================================
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    userData = doc.data() || {};
                    document.getElementById('sideName').innerText = userData.name || "User";
                    document.getElementById('dashWelcomeName').innerText = userData.name || "User";
                    document.getElementById('sideRole').innerText = userData.role || "Role";
                    
                    const isMgr = (userData.role === 'manager');
                    document.getElementById('m-admin').style.display = isMgr ? 'flex' : 'none';
                    document.getElementById('m-sales').style.display = isMgr ? 'flex' : 'none';
                    document.getElementById('m-purchase').style.display = isMgr ? 'flex' : 'none';
                    document.getElementById('m-reports').style.display = isMgr ? 'flex' : 'none';
                    document.getElementById('m-billing').style.display = isMgr ? 'flex' : 'none'; // Only manager can see billing menu
                    
                    document.querySelectorAll('.mgr-action').forEach(el => el.style.display = isMgr ? 'inline-block' : 'none');
                    
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'block';
                    switchView('dashboard');
                    loadData();
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function loginUser() {
            const user = document.getElementById('loginUsername').value.toLowerCase().trim().replace(/\s/g, '');
            const pass = document.getElementById('loginPassword').value;
            if(!user || !pass) return toast("Enter username and password", "error");
            try {
                await auth.signInWithEmailAndPassword(user+"@erp.com", pass);
                toast("Login Successful!", "success");
            } catch(e) { toast("Wrong password or user!", "error"); }
        }

        async function registerUser() {
            const name = document.getElementById('regName').value.trim();
            const user = document.getElementById('regUser').value.toLowerCase().trim().replace(/\s/g, '');
            const pass = document.getElementById('regPass').value;
            const role = document.getElementById('regRole').value;
            if(role=='manager' && document.getElementById('pinBox').value!='12345') return toast("Wrong Manager PIN", "error");
            try {
                const cred = await auth.createUserWithEmailAndPassword(user+"@erp.com", pass);
                await db.collection("users").doc(cred.user.uid).set({ name, user, role });
                toast("Account Created!", "success");
            } catch(e) { toast("Username taken or error!", "error"); }
        }

        function logoutApp() { auth.signOut().then(() => toast("Logged Out", "success")); }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function switchView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active-menu'));
            if(document.getElementById('m-'+v)) document.getElementById('m-'+v).classList.add('active-menu');
            document.getElementById('pageTitle').innerText = v.toUpperCase();
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleAuthView(v) {
            document.getElementById('login-box').style.display = v=='login'?'block':'none';
            document.getElementById('reg-box').style.display = v=='reg'?'block':'none';
        }

        // ==========================================
        // DATA LOADERS & SEARCH
        // ==========================================
        function filterStock() {
            let input = document.getElementById("stockSearch").value.toUpperCase();
            let trs = document.getElementById("stockTableBody").getElementsByTagName("tr");
            for (let i = 0; i < trs.length; i++) {
                let td = trs[i].getElementsByTagName("td")[0];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    trs[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }

        function loadData() {
            // Shops
            db.collection("shops").orderBy("name").onSnapshot(snap => {
                const sel = document.getElementById('orderShop');
                const repShop = document.getElementById('repShop');
                const delShop = document.getElementById('delShopSelect');
                
                sel.innerHTML = '<option value="">-- Select Shop --</option>';
                repShop.innerHTML = '<option value="all">All Shops</option>';
                if(delShop) delShop.innerHTML = '<option value="">-- Select Shop to Delete --</option>';
                
                globalShops = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    globalShops[doc.id] = d;
                    const safeVal = doc.id.replace(/"/g, '&quot;');
                    sel.innerHTML += `<option value="${safeVal}">${d.name}</option>`;
                    repShop.innerHTML += `<option value="${safeVal}">${d.name}</option>`;
                    if(delShop) delShop.innerHTML += `<option value="${safeVal}">${d.name}</option>`;
                });
            });

            // Products (Includes Low Stock Alert for Dashboard)
            db.collection("products").onSnapshot(snap => {
                const orderDatalist = document.getElementById('orderItemDatalist');
                const repItem = document.getElementById('repItem');
                const delItem = document.getElementById('delItemSelect');
                const adminDatalist = document.getElementById('adminProductList');
                const stockBody = document.getElementById('stockTableBody');
                
                stockBody.innerHTML = ''; stockDataArray = []; productsMap = {}; 
                let totalStockValue = 0; let datalistHtml = '';
                
                let lowStockCount = 0;
                let lowStockHtml = '';
                
                repItem.innerHTML = '<option value="all">All Items</option>';
                if(delItem) delItem.innerHTML = '<option value="">-- Select Item to Delete --</option>';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const price = d.price || 0;
                    const stock = d.stock || 0;
                    const discount = d.discount || 0;
                    totalStockValue += (stock * price);
                    
                    productsMap[doc.id] = { price: price, stock: stock, discount: discount };
                    const safeVal = doc.id.replace(/"/g, '&quot;');
                    
                    datalistHtml += `<option value="${safeVal}">`;
                    repItem.innerHTML += `<option value="${safeVal}">${doc.id}</option>`;
                    if(delItem) delItem.innerHTML += `<option value="${safeVal}">${doc.id}</option>`;
                    
                    const safeId = doc.id.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    
                    let actionBtn = (userData.role === 'manager') ? `<td class="no-print" style="white-space: nowrap;">
                        <button onclick="editProduct('${safeId}', ${stock}, ${price}, ${discount})" style="border:1px solid orange; color:orange; background:none; cursor:pointer; padding:2px 5px; border-radius:4px; margin-right:5px;">‚úèÔ∏è</button>
                        <button onclick="deleteProduct('${safeId}')" style="border:1px solid red; color:red; background:none; cursor:pointer; padding:2px 5px; border-radius:4px;">üóëÔ∏è</button>
                    </td>` : '';
                    
                    let discFormat = discount > 0 ? `<b style="color:var(--primary)">${discount}%</b>` : `0%`;
                    
                    stockBody.innerHTML += `<tr><td><b>${doc.id}</b></td><td style="${stock<=5?'color:red; font-weight:bold;':''}">${stock}</td><td>‚Çπ${price.toFixed(2)}</td><td>${discFormat}</td>${actionBtn}</tr>`;
                    stockDataArray.push({ "Product": doc.id, "Stock": stock, "Price": price, "Discount (%)": discount });
                    
                    if(stock <= 5) {
                        lowStockCount++;
                        lowStockHtml += `<div style="display:flex; justify-content:space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span>${doc.id}</span> <span style="color:red; font-weight:bold;">${stock} left</span>
                        </div>`;
                    }
                });
                
                orderDatalist.innerHTML = datalistHtml;
                if(adminDatalist) adminDatalist.innerHTML = datalistHtml;
                document.getElementById('stockTotalValue').innerText = `‚Çπ ${totalStockValue.toFixed(2)}`;
                
                document.getElementById('dashLowStockCount').innerText = lowStockCount;
                document.getElementById('dashLowStockList').innerHTML = lowStockCount > 0 ? lowStockHtml : `<div style="padding:10px; color:var(--success); font-weight:bold;">‚úÖ All items are well stocked!</div>`;
                
                filterStock(); 
            });

            // Purchase History
            db.collection("purchases").orderBy("time","desc").limit(100).onSnapshot(snap => {
                const pBody = document.getElementById('purchaseTableBody');
                pBody.innerHTML = ''; purchaseDataArray = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    const timeStr = d.time ? d.time.toDate().toLocaleDateString() : 'N/A';
                    const safeDocId = doc.id.replace(/'/g, "\\'");
                    const safeItemName = d.item.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    let safeDealer = d.dealer ? d.dealer.replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';
                    
                    let actionBtn = (userData.role === 'manager') ? `<td class="no-print" style="white-space: nowrap;">
                        <button onclick="editPurchase('${safeDocId}', '${safeItemName}', ${d.addedStock}, ${d.price||0}, '${safeDealer}')" style="border:1px solid orange; color:orange; background:none; cursor:pointer; padding:2px 5px; border-radius:4px; margin-right:5px;">‚úèÔ∏è</button>
                        <button onclick="deletePurchaseRecord('${safeDocId}')" style="border:1px solid red; color:red; background:none; cursor:pointer; padding:2px 5px; border-radius:4px;">üóëÔ∏è</button>
                    </td>` : '';
                    
                    pBody.innerHTML += `<tr><td>${timeStr}</td><td><b>${d.item}</b></td><td style="color:var(--primary);">+${d.addedStock}</td><td>‚Çπ${(d.price||0).toFixed(2)}</td><td>${d.dealer||'N/A'}</td>${actionBtn}</tr>`;
                    purchaseDataArray.push({ "Date": timeStr, "Item": d.item, "Qty": d.addedStock, "Price": d.price });
                });
            });

            // Orders, Dashboard & Live History
            db.collection("orders").orderBy("time","desc").onSnapshot(snap => {
                const list = document.getElementById('historyList');
                const salesBody = document.getElementById('salesTableBody');
                const billSel = document.getElementById('billingSelect');
                const repSalesman = document.getElementById('repSalesman');

                list.innerHTML = ""; salesBody.innerHTML = ""; 
                billSel.innerHTML = '<option value="">-- Choose an Order --</option>';
                historyData = []; salesDataArray = [];
                
                let totalS = 0, totalO = 0, shopMap = {};
                let todayS = 0;
                let today = new Date().setHours(0,0,0,0); 
                let salesmenSet = new Set();

                let idx = 0; 
                snap.forEach(doc => {
                    const d = doc.data(); 
                    d.orderId = doc.id; 
                    historyData.push(d);
                    salesmenSet.add(d.salesman);
                    
                    let oTime = d.time ? d.time.toDate().getTime() : 0;
                    const timeS = d.time ? d.time.toDate().toLocaleString() : 'N/A';
                    const itemsText = d.items.map(i => `${i.id}(${i.qty})`).join(', ');
                    
                    // Personalize Dashboard for Salesman OR Show All for Manager
                    if(userData.role === 'manager' || d.salesman === userData.name) {
                        totalO++; 
                        totalS += d.total;
                        if(oTime >= today) todayS += d.total;
                        shopMap[d.shopName] = (shopMap[d.shopName] || 0) + d.total;
                    }

                    // Populate Bill Dropdown (Only Manager needs this, but logic stays intact)
                    billSel.innerHTML += `<option value="${idx}">${d.shopName} (‚Çπ${d.total.toFixed(0)})</option>`;

                    // Live History Action Buttons Logic
                    let actionBtn = "";
                    let billBtn = "";
                    if (userData.role === 'manager') {
                        actionBtn = `<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px; border-color:var(--primary); color:var(--primary); margin-left:5px;">Edit</button>
                                     <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px; border-color:red; color:red; margin-left:5px;">Delete</button>`;
                        billBtn = `<button onclick="document.getElementById('billingSelect').value='${idx}'; renderA5Bill(); switchView('billing');" class="btn-outline" style="padding:2px 8px;">Bill</button>`;
                    } else if (d.salesman === userData.name) {
                        // Salesman can edit/delete their own, NO bill button
                        actionBtn = `<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px; border-color:var(--primary); color:var(--primary); margin-left:5px;">Edit</button>
                                     <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px; border-color:red; color:red; margin-left:5px;">Delete</button>`;
                    }

                    list.innerHTML += `<div class="card">
                        <div class="flex-between"><b style="color:var(--primary)">${d.shopName}</b><small>${timeS}</small></div>
                        <div style="font-size:13px; margin:5px 0;">${itemsText}</div>
                        <div style="font-size:11px; margin-bottom:5px; color:gray;">üë§ Salesman: ${d.salesman}</div>
                        <div class="flex-between"><b>‚Çπ ${d.total.toFixed(2)}</b>
                        <div>
                            ${billBtn}
                            ${actionBtn}
                        </div>
                        </div>
                    </div>`;

                    let salesActionBtn = (userData.role === 'manager') ? `<td class="no-print"><button onclick="deleteOrder(${idx})" style="border:1px solid red; color:red; background:none; cursor:pointer; padding:2px 5px; border-radius:4px;">üóëÔ∏è Delete</button></td>` : '';
                    salesBody.innerHTML += `<tr><td>${timeS}</td><td>${d.shopName}</td><td>${itemsText}</td><td>‚Çπ${d.total.toFixed(2)}</td><td>${d.salesman}</td>${salesActionBtn}</tr>`;
                    salesDataArray.push({ "Date": timeS, "Shop": d.shopName, "Total": d.total });
                    idx++; 
                });
                
                // Update Dashboard Numbers
                document.getElementById('dashTodaySales').innerText = `‚Çπ ${todayS.toFixed(2)}`;
                document.getElementById('dashTotalSales').innerText = `‚Çπ ${totalS.toFixed(2)}`;
                document.getElementById('dashTotalOrders').innerText = totalO;
                
                if(Object.keys(shopMap).length > 0) {
                    let topShop = Object.keys(shopMap).reduce((a, b) => shopMap[a] > shopMap[b] ? a : b);
                    document.getElementById('dashTopShop').innerText = topShop;
                    document.getElementById('dashTopShopAmount').innerText = `‚Çπ ${shopMap[topShop].toFixed(2)}`;
                } else {
                    document.getElementById('dashTopShop').innerText = "N/A";
                    document.getElementById('dashTopShopAmount').innerText = "‚Çπ 0.00";
                }

                // Populate Manager Report Salesman Dropdown
                if(repSalesman) {
                    repSalesman.innerHTML = '<option value="all">All Salesmen</option>';
                    salesmenSet.forEach(s => {
                        repSalesman.innerHTML += `<option value="${s}">${s}</option>`;
                    });
                }
            });
        }

        // ==========================================
        // EXCEL IMPORT LOGIC
        // ==========================================
        function getExcelVal(row, possibleKeys) {
            for(let key of possibleKeys) {
                if(row[key] !== undefined && row[key] !== null && row[key] !== "") return row[key];
            }
            return null;
        }

        async function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if(json.length === 0) return toast("Excel file is empty!", "error");

                    document.getElementById('toast').innerText = "Importing Data... Please wait.";
                    document.getElementById('toast').style.borderLeftColor = 'orange';
                    document.getElementById('toast').style.display = 'block';

                    let successCount = 0;
                    let errorCount = 0;

                    for (let row of json) {
                        let pName = getExcelVal(row, ['Product', 'product', 'Product Name', 'Item', 'item']);
                        let qtyRaw = getExcelVal(row, ['Qty', 'Added Qty', 'Quantity', 'added Quantity', 'qty']);
                        let priceRaw = getExcelVal(row, ['Price', 'price', 'Base Price']);
                        let dealer = getExcelVal(row, ['Dealer', 'Dealer info', 'Dealer Info', 'dealer']) || '';
                        let discountRaw = getExcelVal(row, ['Discount', 'Discounted price', 'discount', 'Disc']) || 0;

                        let qty = parseInt(qtyRaw);
                        let price = parseFloat(priceRaw);
                        let discount = parseFloat(discountRaw);

                        if (!pName || isNaN(qty) || qty <= 0) {
                            errorCount++;
                            continue; 
                        }

                        let safeName = pName.toString().trim();
                        if(safeName.includes('/')) safeName = safeName.replace(/\//g, '-');

                        const ref = db.collection("products").doc(safeName);
                        const doc = await ref.get();
                        
                        let finalS = doc.exists ? (doc.data().stock || 0) + qty : qty;
                        let finalP = isNaN(price) ? (doc.exists ? (doc.data().price||0) : 0) : price;
                        let finalD = isNaN(discount) ? (doc.exists ? (doc.data().discount||0) : 0) : discount;

                        await ref.set({ stock: finalS, price: finalP, discount: finalD }, {merge:true});
                        
                        await db.collection("purchases").add({ 
                            item: safeName, 
                            addedStock: qty, 
                            price: finalP, 
                            dealer: dealer.toString(), 
                            time: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                        successCount++;
                    }
                    
                    if(successCount > 0) {
                        toast(`Import Complete! Added: ${successCount} items. (Skipped/Errors: ${errorCount})`, "success");
                    } else {
                        toast(`Failed to import. Check Excel headers.`, "error");
                    }
                } catch(err) {
                    toast("Error parsing Excel file.", "error");
                    console.error(err);
                }
                event.target.value = ""; 
            };
            reader.readAsArrayBuffer(file);
        }

        // ==========================================
        // CART, CALCULATIONS & TOGGLE LOGIC
        // ==========================================
        function togglePriceMode() {
            const mode = document.querySelector('input[name="priceMode"]:checked').value;
            const container = document.getElementById('manualPriceContainer');
            if(mode === 'manual') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                document.getElementById('manualPriceInput').value = ""; 
            }
        }

        function showPriceInfo() {
            let val = document.getElementById('orderItemInput').value;
            let box = document.getElementById('priceHighlightBox');
            
            if(productsMap[val]) {
                let p = productsMap[val];
                let suggestedDiscPrice = p.price - (p.price * (p.discount/100));
                
                if(p.discount > 0) {
                    box.innerHTML = `üõí Stock: <b>${p.stock}</b> <br> ‚ú® Auto Price: <b>‚Çπ${p.price.toFixed(2)}</b> <br> <small style="color:red;">(Hint: ${p.discount}% discount price is ‚Çπ${suggestedDiscPrice.toFixed(2)})</small>`;
                } else {
                    box.innerHTML = `üõí Stock: <b>${p.stock}</b> <br> ‚ú® Auto Price: <b>‚Çπ${p.price.toFixed(2)}</b>`;
                }
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        }

        function addToCart() {
            const pId = document.getElementById('orderItemInput').value; 
            const qty = parseInt(document.getElementById('orderQty').value);
            
            if(!pId || !qty || qty <= 0) return toast("Invalid Qty or Item not found", "error");
            if(!productsMap[pId]) return toast("Please select a valid item from the list", "error");
            
            const pData = productsMap[pId];
            const stock = pData.stock;

            let finalUnitPrice = 0;
            const mode = document.querySelector('input[name="priceMode"]:checked').value;
            
            if(mode === 'manual') {
                const mPrice = parseFloat(document.getElementById('manualPriceInput').value);
                if(isNaN(mPrice) || mPrice < 0) return toast("Please enter a valid manual price", "error");
                finalUnitPrice = mPrice;
            } else {
                finalUnitPrice = pData.price;
            }
            
            const existing = cart.find(i => i.id === pId);
            const totalQty = (existing ? existing.qty : 0) + qty;
            
            if(totalQty > stock) return toast("Stock Limit! Only " + stock + " left.", "error");

            if(existing) { 
                existing.qty += qty; 
                existing.price = finalUnitPrice; 
                existing.total = existing.qty * finalUnitPrice; 
            } else { 
                cart.push({ id: pId, qty: qty, price: finalUnitPrice, total: qty * finalUnitPrice }); 
            }
            
            renderCart();
            document.getElementById('orderItemInput').value = "";
            document.getElementById('orderQty').value = "";
            if(mode === 'manual') document.getElementById('manualPriceInput').value = "";
            showPriceInfo(); 
        }

        function undoCart() { 
            if(cart.length > 0) { cart.pop(); renderCart(); } 
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = ""; let grand = 0;
            cart.forEach((item, i) => {
                grand += item.total;
                list.innerHTML += `<div class="flex-between" style="font-size:14px; margin-bottom:5px;">
                    <span>${item.id} (x${item.qty}) <small style="color:gray;">@ ‚Çπ${item.price.toFixed(2)}</small></span>
                    <span>‚Çπ${item.total.toFixed(2)} <span onclick="cart.splice(${i},1);renderCart();" style="color:red; cursor:pointer; margin-left:10px;">‚úñ</span></span>
                </div>`;
            });
            document.getElementById('cartTotal').innerText = "‚Çπ " + grand.toFixed(2);
            document.getElementById('cartCard').style.display = cart.length ? 'block' : 'none';
        }

        async function placeFinalOrder() {
            const shop = document.getElementById('orderShop').value;
            if(!shop || !cart.length) return toast("Empty Shop/Cart", "error");
            document.getElementById('btnPlace').innerText = "Processing...";
            const orderObj = { shopName: shop, items: cart, total: cart.reduce((s,i)=>s+i.total, 0), salesman: userData.name, time: firebase.firestore.FieldValue.serverTimestamp() };
            try {
                for(let i of cart) {
                    const ref = db.collection("products").doc(i.id);
                    await db.runTransaction(async t => {
                        const doc = await t.get(ref);
                        t.update(ref, { stock: doc.data().stock - i.qty });
                    });
                }
                await db.collection("orders").add(orderObj);
                toast("Order Placed!", "success"); cart = []; renderCart(); switchView('history');
            } catch(e) { toast(e.message, "error"); }
            document.getElementById('btnPlace').innerText = "Place Final Order";
        }

        async function deleteOrder(idx) {
            if(!confirm("Are you sure you want to completely delete this order? The stock will be returned automatically.")) return;
            let d = historyData[idx];
            if(!d || !d.orderId) return;
            try {
                for(let item of d.items) {
                    const ref = db.collection("products").doc(item.id);
                    await db.runTransaction(async (tr) => {
                        const pDoc = await tr.get(ref);
                        if(pDoc.exists) { tr.update(ref, { stock: pDoc.data().stock + item.qty }); }
                    });
                }
                await db.collection("orders").doc(d.orderId).delete();
                toast("Order deleted and stock returned!", "success");
            } catch(e) { toast("Error: " + e.message, "error"); }
        }

        async function editOrder(idx) {
            if(!confirm("Edit Order: This will move the items back to your cart and delete the original order. Proceed?")) return;
            let d = historyData[idx];
            if(!d || !d.orderId) return;
            try {
                for(let item of d.items) {
                    const ref = db.collection("products").doc(item.id);
                    await db.runTransaction(async (tr) => {
                        const pDoc = await tr.get(ref);
                        if(pDoc.exists) { tr.update(ref, { stock: pDoc.data().stock + item.qty }); }
                    });
                }
                await db.collection("orders").doc(d.orderId).delete();
                cart = [...d.items]; 
                const selectShopEl = document.getElementById('orderShop');
                for (let i = 0; i < selectShopEl.options.length; i++) {
                    if (selectShopEl.options[i].value === d.shopName) {
                        selectShopEl.selectedIndex = i; break;
                    }
                }
                renderCart(); switchView('order');
                toast("Order moved to cart! You can now edit and re-place it.", "success");
            } catch(e) { toast("Error: " + e.message, "error"); }
        }

        // ==========================================
        // MANAGER: ADD, EDIT & DELETE RECORDS
        // ==========================================
        async function addShop() {
            const n = document.getElementById('shopName').value.trim();
            if(!n) return toast("Shop name required", "error");
            const safeName = n.includes('/') ? n.replace(/\//g, '-') : n;
            await db.collection("shops").doc(safeName).set({ name: safeName, phone: document.getElementById('shopPhone').value, addr: document.getElementById('shopAddr').value }, {merge:true});
            toast("Shop Saved!", "success");
            document.getElementById('shopName').value=""; document.getElementById('shopPhone').value=""; document.getElementById('shopAddr').value="";
        }

        async function addProduct() {
            let n = document.getElementById('prodName').value.trim();
            const s = parseInt(document.getElementById('prodStock').value);
            const p = parseFloat(document.getElementById('prodPrice').value);
            if(!n || isNaN(s)) return toast("Name and valid stock required", "error");
            if(n.includes('/')) { n = n.replace(/\//g, '-'); toast("Note: Slashes (/) in name were replaced with hyphens (-)"); }
            const ref = db.collection("products").doc(n);
            const doc = await ref.get();
            let finalS = doc.exists ? doc.data().stock + s : s;
            let finalP = isNaN(p) ? (doc.exists?doc.data().price:0) : p;
            let finalD = doc.exists ? (doc.data().discount||0) : 0; 
            await ref.set({ stock: finalS, price: finalP, discount: finalD }, {merge:true});
            if(s > 0) {
                await db.collection("purchases").add({ item: n, addedStock: s, price: finalP, dealer: document.getElementById('purchaseInfo').value, time: firebase.firestore.FieldValue.serverTimestamp() });
            }
            toast("Stock Updated!", "success");
            document.getElementById('prodName').value=""; document.getElementById('prodStock').value=""; document.getElementById('prodPrice').value=""; document.getElementById('purchaseInfo').value="";
        }

        async function editProduct(id, oldStock, oldPrice, oldDisc) {
            let nStock = prompt(`Edit Stock for ${id}:`, oldStock);
            if (nStock === null) return;
            let nPrice = prompt(`Edit Base Price for ${id} (‚Çπ):`, oldPrice);
            if (nPrice === null) return;
            let nDisc = prompt(`Edit Discount Percentage (%) for ${id}:`, oldDisc);
            if (nDisc === null) return;
            try {
                await db.collection("products").doc(id).update({ stock: parseInt(nStock), price: parseFloat(nPrice), discount: parseFloat(nDisc) || 0 });
                toast("Inventory Updated!", "success");
            } catch(e) { toast(e.message, "error"); }
        }

        async function editPurchase(docId, item, oldQty, oldPrice, oldDealer) {
            let nQty = prompt(`Edit Purchase Qty for ${item}:`, oldQty);
            if (nQty === null) return;
            let nPrice = prompt(`Edit Purchase Price:`, oldPrice);
            if (nPrice === null) return;
            let nDealer = prompt(`Edit Dealer Info:`, oldDealer);
            if (nDealer === null) return;
            try {
                await db.collection("purchases").doc(docId).update({ addedStock: parseInt(nQty), price: parseFloat(nPrice), dealer: nDealer });
                toast("Purchase Log Updated!", "success");
            } catch(e) { toast(e.message, "error"); }
        }

        async function deleteProduct(id) {
            if(!confirm(`‚ö†Ô∏è Warning: Are you sure you want to completely delete "${id}" from items/stock?`)) return;
            try { await db.collection("products").doc(id).delete(); toast("Item completely deleted!", "success"); } catch(e) { toast(e.message, "error"); }
        }

        async function deletePurchaseRecord(id) {
            if(!confirm(`Delete this purchase record? Note: This will NOT reduce your inventory stock automatically.`)) return;
            try { await db.collection("purchases").doc(id).delete(); toast("Purchase record deleted!", "success"); } catch(e) { toast(e.message, "error"); }
        }

        async function deleteShop() {
            const shopId = document.getElementById('delShopSelect').value;
            if(!shopId) return toast("Select a shop to delete", "error");
            if(!confirm(`‚ö†Ô∏è Warning: Delete shop "${shopId}"?`)) return;
            try { await db.collection("shops").doc(shopId).delete(); toast("Shop deleted!", "success"); document.getElementById('delShopSelect').value = ""; } catch(e) { toast(e.message, "error"); }
        }

        async function deleteProductFromAdmin() {
            const itemId = document.getElementById('delItemSelect').value;
            if(!itemId) return toast("Select an item to delete", "error");
            if(!confirm(`‚ö†Ô∏è Warning: Delete item "${itemId}" completely from stock?`)) return;
            try { await db.collection("products").doc(itemId).delete(); toast("Item deleted!", "success"); document.getElementById('delItemSelect').value = ""; } catch(e) { toast(e.message, "error"); }
        }

        // ==========================================
        // CUSTOM REPORT LOGIC (Added Salesman Filter)
        // ==========================================
        function generateCustomReport() {
            const sVal = document.getElementById('repStartDate').value;
            const eVal = document.getElementById('repEndDate').value;
            const start = sVal ? new Date(sVal).setHours(0,0,0,0) : null;
            const end = eVal ? new Date(eVal).setHours(23,59,59,999) : null;
            const shop = document.getElementById('repShop').value;
            const item = document.getElementById('repItem').value;
            const salesmanFilter = document.getElementById('repSalesman').value; // NEW

            const tbody = document.getElementById('repTableBody');
            tbody.innerHTML = ''; customReportArray = [];
            let tAmt = 0, tQty = 0;

            historyData.forEach(d => {
                let oTime = d.time ? d.time.toDate().getTime() : 0;
                
                // Applying Filters
                if(start && oTime < start) return;
                if(end && oTime > end) return;
                if(shop !== 'all' && d.shopName !== shop) return;
                if(salesmanFilter !== 'all' && d.salesman !== salesmanFilter) return; // NEW FILTER
                
                let filtered = (item === 'all') ? d.items : d.items.filter(i => i.id === item);
                if(!filtered.length) return;

                let rowAmt = filtered.reduce((s,i) => s + i.total, 0);
                let rowQty = filtered.reduce((s,i) => s + i.qty, 0);
                tAmt += rowAmt; tQty += rowQty;

                let dateStr = d.time ? d.time.toDate().toLocaleDateString() : '';
                let itemStr = filtered.map(i=>`${i.id}(${i.qty})`).join(', ');

                tbody.innerHTML += `<tr><td>${dateStr}</td><td>${d.shopName}</td><td>${itemStr}</td><td>‚Çπ${rowAmt.toFixed(2)}</td><td>${d.salesman}</td></tr>`;
                customReportArray.push({ Date: dateStr, Shop: d.shopName, Items: itemStr, "Amount (‚Çπ)": rowAmt, "Salesman": d.salesman });
            });
            
            document.getElementById('repTotalAmount').innerText = `‚Çπ ${tAmt.toFixed(2)}`;
            document.getElementById('repTotalQty').innerText = tQty;
            document.getElementById('reportResultArea').style.display = 'block';
            
            if(customReportArray.length === 0) {
                toast("No data found for this filter!", "error");
                document.getElementById('reportResultArea').style.display = 'none';
            }
        }

        // ==========================================
        // BILLING & EXPORTS
        // ==========================================
        function renderA5Bill() {
            const idxStr = document.getElementById('billingSelect').value;
            if (idxStr === "") { document.getElementById('bill-preview-section').style.display = 'none'; return; }
            
            const idx = parseInt(idxStr);
            const d = historyData[idx];
            if(!d) return;
            
            let shopPhone = globalShops[d.shopName] ? globalShops[d.shopName].phone : 'N/A';
            
            document.getElementById('b-shopName').innerText = d.shopName;
            document.getElementById('b-shopPhone').innerText = "Ph: " + shopPhone;
            document.getElementById('b-date').innerText = d.time ? d.time.toDate().toLocaleDateString() : '';
            document.getElementById('b-salesman').innerText = d.salesman;
            document.getElementById('b-orderId').innerText = "#"+d.orderId.substring(0,6).toUpperCase();
            
            let rows = "";
            d.items.forEach((i, sl) => { 
                rows += `<tr><td>${sl+1}</td><td>${i.id}<br><small>@ ‚Çπ${i.price.toFixed(2)}</small></td><td>${i.qty}</td><td style="text-align:right;">‚Çπ${i.total.toFixed(2)}</td></tr>`; 
            });
            
            document.getElementById('b-itemsBody').innerHTML = rows;
            document.getElementById('b-grandTotal').innerText = d.total.toFixed(2);
            document.getElementById('bill-preview-section').style.display = 'block';
        }

        function downloadA5PDF() {
            const el = document.getElementById('a5-print-zone');
            toast("Generating PDF...");
            html2pdf().from(el).set({ margin:0.2, filename:'Invoice.pdf', jsPDF:{unit:'in', format:'a5', orientation:'portrait'} }).save();
        }

        function exportAnyTable(id, name) {
            const el = document.getElementById(id);
            toast("Generating PDF Report...");
            let headers = el.querySelectorAll('.print-header');
            headers.forEach(h => h.style.display = 'block');
            html2pdf().from(el).set({ margin:0.3, filename:name+'.pdf', jsPDF:{unit:'in', format:'a4', orientation:'landscape'} }).save().then(() => {
                headers.forEach(h => h.style.display = 'none');
            });
        }

        function exportDataExcel(arr, name) {
            if(!arr || arr.length === 0) return toast("No data to export", "error");
            toast("Exporting Excel...");
            const ws = XLSX.utils.json_to_sheet(arr);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, name+".xlsx");
        }
    </script>
</body>
</html>
