<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order With Me - ERP</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #6366f1;
            --primary-light: rgba(99,102,241,0.10);
            --bg: #f0f2f8;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #f43f5e;
            --border: #e2e8f0;
            --warning: #f59e0b;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(79,70,229,0.14);
            --radius: 16px;
            --radius-sm: 10px;
            --header-h: 60px;
            --bottom-nav-h: 64px;
            /* Auth */
            --auth-bg-start: #f0f2f8;
            --auth-bg-end: #e4e8f5;
            --auth-card-bg: #ffffff;
            --auth-card-border: rgba(79,70,229,0.15);
            --auth-card-shadow: 0 20px 60px rgba(79,70,229,0.12);
            --auth-input-bg: rgba(79,70,229,0.04);
            --auth-input-border: rgba(79,70,229,0.18);
            --auth-input-color: #1e293b;
            --auth-title-color: #1e293b;
            --auth-sub-color: #64748b;
            --auth-brand-start: #4f46e5;
            --auth-brand-end: #06b6d4;
            --auth-select-option-bg: #ffffff;
        }
        body.dark-mode {
            --primary: #6366f1;
            --secondary: #818cf8;
            --primary-light: rgba(99,102,241,0.15);
            --bg: #0d0f1a;
            --card: #151929;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --border: #1e2740;
            --shadow: 0 2px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.5);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --auth-bg-start: #0d0f1a;
            --auth-bg-end: #151929;
            --auth-card-bg: #151929;
            --auth-card-border: rgba(99,102,241,0.25);
            --auth-card-shadow: 0 20px 60px rgba(0,0,0,0.6);
            --auth-input-bg: rgba(255,255,255,0.05);
            --auth-input-border: rgba(255,255,255,0.08);
            --auth-input-color: #e2e8f0;
            --auth-title-color: #e2e8f0;
            --auth-sub-color: #64748b;
            --auth-brand-start: #6366f1;
            --auth-brand-end: #22d3ee;
            --auth-select-option-bg: #151929;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            padding-bottom: calc(var(--bottom-nav-h) + 20px);
        }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 14px;
            border: 1px solid var(--border);
            overflow: visible;
            transition: box-shadow 0.25s, transform 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-md); }
        /* ===== COLLAPSIBLE CARD ===== */
        .collapse-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        .collapse-card:hover { box-shadow: var(--shadow-md); }
        .collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 18px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            gap: 8px;
        }
        .collapse-header:hover { background: rgba(99,102,241,0.05); }
        .collapse-arrow {
            font-size: 11px;
            color: #94a3b8;
            transition: transform 0.25s ease;
            display: inline-block;
            flex-shrink: 0;
        }
        .collapse-arrow.open { transform: rotate(180deg); }
        .collapse-body {
            padding: 0 18px 16px 18px;
            border-top: 1px solid var(--border);
            animation: collapseIn 0.2s ease;
        }
        .collapse-body-inner { padding-top: 14px; }
        @keyframes collapseIn {
            from { opacity: 0; transform: translateY(-5px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .input-field {
            width: 100%;
            padding: 11px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
            background: var(--card);
        }
        .input-field::placeholder { color: #94a3b8; }
        .btn {
            width: 100%;
            padding: 13px 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            font-weight: 700;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(79,70,229,0.3);
            letter-spacing: 0.3px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79,70,229,0.35); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16,185,129,0.3);
        }
        .btn-success:hover { box-shadow: 0 8px 20px rgba(16,185,129,0.4); }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            box-shadow: none;
        }
        .btn-outline:hover { background: var(--primary-light); box-shadow: none; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        #auth-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, var(--auth-bg-start) 0%, var(--auth-bg-end) 50%, var(--auth-bg-start) 100%);
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; overflow: hidden;
            transition: background 0.4s ease;
        }
        #auth-screen::before {
            content: '';
            position: absolute;
            top: -100px; right: -100px;
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(99,102,241,0.12) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #auth-screen::after {
            content: '';
            position: absolute;
            bottom: -80px; left: -80px;
            width: 320px; height: 320px;
            background: radial-gradient(circle, rgba(16,185,129,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        #login-box, #reg-box {
            background: var(--auth-card-bg) !important;
            border: 1px solid var(--auth-card-border) !important;
            box-shadow: var(--auth-card-shadow) !important;
            position: relative;
            z-index: 1;
            transition: background 0.4s, border 0.4s, box-shadow 0.4s;
        }
        .auth-brand {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            transition: all 0.4s;
        }
        .auth-brand-sub { color: var(--auth-sub-color); font-size: 13px; margin-bottom: 22px; transition: color 0.4s; }
        .auth-title-text { color: var(--auth-title-color) !important; transition: color 0.4s; }
        #login-box .input-field, #reg-box .input-field {
            background: var(--auth-input-bg);
            border-color: var(--auth-input-border);
            color: var(--auth-input-color);
            transition: background 0.4s, border-color 0.4s, color 0.4s;
        }
        #login-box .input-field:focus, #reg-box .input-field:focus {
            border-color: #6366f1;
            background: rgba(99,102,241,0.1);
        }
        #login-box .input-field::placeholder, #reg-box .input-field::placeholder { color: var(--auth-sub-color); }
        #login-box select.input-field option, #reg-box select.input-field option {
            background: var(--auth-select-option-bg);
            color: var(--auth-input-color);
        }
        .auth-link-text { color: var(--auth-sub-color); font-size: 13px; }
        .auth-link-highlight { color: #6366f1; font-weight: 700; cursor: pointer; }
        #app-screen { display: none; }
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes heartBeat {
            0%   { transform: scale(1); }
            14%  { transform: scale(1.3); }
            28%  { transform: scale(1); }
            42%  { transform: scale(1.25); }
            70%  { transform: scale(1); }
            100% { transform: scale(1); }
        }
        .header {
            background: linear-gradient(135deg, #3730a3 0%, #4f46e5 50%, #6366f1 100%);
            color: white;
            padding: 0 18px;
            height: var(--header-h);
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 24px rgba(79,70,229,0.35);
            display: flex; align-items: center; justify-content: space-between;
        }
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
            box-shadow: 0 4px 24px rgba(0,0,0,0.5);
        }
        .sidebar {
            position: fixed; top: 0; left: -300px; width: 270px; height: 100vh;
            background: var(--card);
            box-shadow: 8px 0 30px rgba(0,0,0,0.15);
            transition: left 0.35s cubic-bezier(0.4,0,0.2,1);
            z-index: 1000; padding: 0; box-sizing: border-box;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .sidebar.active { left: 0; }
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            display: none; z-index: 999;
            backdrop-filter: blur(3px);
        }
        .overlay.active { display: block; }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: linear-gradient(135deg, rgba(79,70,229,0.09), rgba(99,102,241,0.04));
            flex-shrink: 0;
        }
        body.dark-mode .sidebar-header {
            background: linear-gradient(135deg, rgba(99,102,241,0.14), rgba(99,102,241,0.05));
        }
        .sidebar-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .sidebar-edit-btn {
            background: var(--primary-light);
            border: 1px solid rgba(99,102,241,0.3);
            color: var(--primary);
            border-radius: 8px;
            padding: 5px 9px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s, transform 0.15s;
            white-space: nowrap;
        }
        .sidebar-edit-btn:hover { background: rgba(99,102,241,0.2); transform: scale(1.03); }
        .sidebar-edit-btn.active-edit { background: var(--primary); color: white; border-color: var(--primary); }

        .sidebar-nav-area {
            padding: 12px 14px;
            flex: 1;
        }

        .menu-item {
            padding: 11px 14px; border-radius: 12px;
            font-size: 14px; cursor: pointer; margin-bottom: 4px;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s, transform 0.15s, color 0.2s;
            color: var(--text);
            user-select: none;
        }
        .menu-item:hover { background: var(--primary-light); transform: translateX(4px); }
        .menu-item.active-menu {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            box-shadow: 0 4px 12px rgba(79,70,229,0.25);
        }
        .menu-item.active-menu:hover { transform: none; }

        .menu-item.dragging {
            opacity: 0.5;
            background: var(--primary-light) !important;
            border: 2px dashed var(--primary);
            transform: scale(0.97);
        }
        .menu-item.drag-over {
            border-top: 2px solid var(--primary);
            margin-top: -2px;
        }
        .drag-handle {
            display: none;
            cursor: grab;
            color: #94a3b8;
            font-size: 14px;
            padding: 0 6px 0 0;
            flex-shrink: 0;
        }
        .drag-handle:active { cursor: grabbing; }
        body.menu-edit-mode .drag-handle { display: inline; }
        body.menu-edit-mode .menu-item { cursor: grab; }
        body.menu-edit-mode .menu-item:hover { transform: none; }
        body.menu-edit-mode .menu-item.active-menu:hover { transform: none; }
        /* CRITICAL: Prevent child spans from intercepting drag events */
        body.menu-edit-mode .drag-handle { pointer-events: auto !important; cursor: grab !important; }
        body.menu-edit-mode .menu-item { cursor: grab !important; }
        body.menu-edit-mode .menu-item:active { cursor: grabbing !important; }
        body.menu-edit-mode .menu-item * { pointer-events: none; }
        body.menu-edit-mode .menu-section-label * { pointer-events: none; }
        .menu-item.dragging { opacity: 0.4; }
        .menu-item.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }
        .menu-section-label.drag-over { outline: 2px dashed var(--primary); background: rgba(99,102,241,0.1); }

        .menu-section-label {
            font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
            margin-bottom: 6px; margin-left: 4px; margin-top: 4px;
            color: #94a3b8; text-transform: uppercase;
            display: flex; align-items: center; gap: 6px;
        }
        .menu-section-label .drag-handle { display: none; }
        body.menu-edit-mode .menu-section-label .drag-handle { display: inline; }
        .menu-hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }
        .qa-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 10px 6px; border-radius: 12px; border: 1.5px solid var(--border);
            background: var(--bg); cursor: pointer; transition: all 0.2s; text-align: center;
            font-family: 'Poppins', sans-serif; color: var(--text); position: relative; overflow: hidden;
        }
        .qa-btn:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79,70,229,0.15); }
        .qa-btn:active { transform: translateY(0); }
        .qa-btn-icon { font-size: 20px; line-height: 1; }
        .qa-btn-label { font-size: 10px; font-weight: 700; color: var(--text); line-height: 1.2; }
        .qa-btn-count { font-size: 9px; color: #94a3b8; font-weight: 600; }
        .qa-badge { position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; font-size: 8px; font-weight: 800; padding: 1px 5px; border-radius: 99px; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
        .dash-card {
            border-radius: 16px; padding: 14px 16px;
            transition: transform 0.25s, box-shadow 0.25s;
            border: 1px solid transparent;
            position: relative; overflow: hidden;
        }
        .dash-card::before {
            content: '';
            position: absolute; top: -20px; right: -20px;
            width: 80px; height: 80px; border-radius: 50%;
            opacity: 0.12;
        }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        .dc-today  { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #a7f3d0; }
        .dc-today::before { background: #10b981; }
        .dc-today .dc-val { color: #065f46; }
        .dc-today .dc-lbl { color: #047857; }
        .dc-today .dc-icon-bg { background: rgba(16,185,129,0.15); color: #10b981; }
        .dc-total  { background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-color: #c7d2fe; }
        .dc-total::before { background: #4f46e5; }
        .dc-total .dc-val { color: #3730a3; }
        .dc-total .dc-lbl { color: #4338ca; }
        .dc-total .dc-icon-bg { background: rgba(79,70,229,0.15); color: #4f46e5; }
        .dc-orders { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #bae6fd; }
        .dc-orders::before { background: #0284c7; }
        .dc-orders .dc-val { color: #0c4a6e; }
        .dc-orders .dc-lbl { color: #0369a1; }
        .dc-orders .dc-icon-bg { background: rgba(2,132,199,0.15); color: #0284c7; }
        .dc-alert  { background: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%); border-color: #fecdd3; }
        .dc-alert::before { background: #f43f5e; }
        .dc-alert .dc-val { color: #9f1239; }
        .dc-alert .dc-lbl { color: #be123c; }
        .dc-alert .dc-icon-bg { background: rgba(244,63,94,0.15); color: #f43f5e; }
        /* Dark mode */
        body.dark-mode .dc-today  { background: linear-gradient(135deg, rgba(16,185,129,0.18), rgba(16,185,129,0.06)); border-color: rgba(16,185,129,0.25); }
        body.dark-mode .dc-today .dc-val { color: #34d399; } body.dark-mode .dc-today .dc-lbl { color: #6ee7b7; }
        body.dark-mode .dc-total  { background: linear-gradient(135deg, rgba(99,102,241,0.18), rgba(99,102,241,0.06)); border-color: rgba(99,102,241,0.25); }
        body.dark-mode .dc-total .dc-val { color: #818cf8; } body.dark-mode .dc-total .dc-lbl { color: #a5b4fc; }
        body.dark-mode .dc-orders { background: linear-gradient(135deg, rgba(34,211,238,0.14), rgba(34,211,238,0.04)); border-color: rgba(34,211,238,0.2); }
        body.dark-mode .dc-orders .dc-val { color: #22d3ee; } body.dark-mode .dc-orders .dc-lbl { color: #67e8f9; }
        body.dark-mode .dc-alert  { background: linear-gradient(135deg, rgba(244,63,94,0.18), rgba(244,63,94,0.06)); border-color: rgba(244,63,94,0.25); }
        body.dark-mode .dc-alert .dc-val { color: #fb7185; } body.dark-mode .dc-alert .dc-lbl { color: #fda4af; }
        .dc-icon-bg { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 10px; }
        .dc-lbl { font-size: 10px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; margin-bottom: 2px; }
        .dc-val { font-size: 18px; font-weight: 900; line-height: 1.1; }
        .dc-icon { display: none; } /* replaced by dc-icon-bg */
        .card-success { border-left: 3px solid var(--success); }
        /* Manager-only columns: hidden for salesman role */
        body.role-salesman .mgr-only-col { display: none !important; }
        /* Shop Notes */
        .shop-note-card { background: rgba(245,158,11,0.07); border:1.5px solid rgba(245,158,11,0.25); border-radius:14px; padding:12px 14px; margin-bottom:8px; }
        .shop-note-card .note-meta { font-size:10px; color:#94a3b8; margin-top:4px; }
        .shop-note-card .note-text { font-size:13px; color:var(--text); font-weight:500; line-height:1.5; }
        .shop-note-badge { display:inline-block; font-size:10px; font-weight:700; background:rgba(245,158,11,0.15); color:#b45309; border-radius:20px; padding:2px 8px; margin-left:6px; vertical-align:middle; }
        .card-warning  { border-left: 3px solid var(--warning); }
        .card-danger   { border-left: 3px solid var(--danger); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 10px; }

        .collapsible-section {
            border: 1.5px solid var(--border);
            border-radius: 16px;
            margin-bottom: 14px;
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow);
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            background: var(--card);
            user-select: none;
            transition: background 0.2s;
        }
        .collapsible-header:hover { background: var(--primary-light); }
        .collapsible-header .ch-title {
            font-size: 15px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 8px;
        }
        .collapsible-header .ch-arrow {
            font-size: 12px; color: #94a3b8;
            transition: transform 0.3s;
        }
        .collapsible-header.open .ch-arrow { transform: rotate(180deg); }
        .collapsible-body {
            display: none;
            padding: 0 20px 18px;
            border-top: 1px solid var(--border);
            animation: fadeUp 0.25s ease;
        }
        .collapsible-body.open { display: block; }

        .collapse-btn {
            background: var(--primary-light);
            color: var(--primary);
            cursor: pointer; padding: 11px 16px; width: 100%;
            border: 1px dashed var(--primary);
            text-align: center; outline: none;
            font-size: 13px; font-weight: 700;
            border-radius: 12px; margin-bottom: 14px;
            transition: background 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .collapse-btn:hover { background: rgba(79,70,229,0.18); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; min-width: 600px; }
        .data-table th {
            background: var(--primary-light);
            padding: 12px 14px;
            border-bottom: 2px solid var(--border);
            color: var(--primary);
            white-space: nowrap;
            font-size: 11px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
        }
        .data-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--primary-light); }
        /* PDF page-break safety */
        .data-table tr  { page-break-inside: avoid; break-inside: avoid; }
        .data-table td,
        .data-table th  { page-break-inside: avoid; break-inside: avoid; }
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); padding: 13px 22px;
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 3000; display: none;
            border-left: 4px solid var(--primary);
            font-weight: 600; font-size: 14px; color: var(--text);
        }

        /* ===== UNDO SNACKBAR ===== */
        #undo-bar {
            position: fixed; bottom: calc(var(--bottom-nav-h) + 12px); left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: #1e293b; color: white;
            padding: 13px 18px; border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.35);
            z-index: 4000; display: flex; align-items: center; gap: 14px;
            font-size: 13px; font-weight: 600;
            transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), visibility 0s linear 0.35s;
            white-space: nowrap; max-width: 90vw;
            visibility: hidden; pointer-events: none;
        }
        #undo-bar.visible {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
            pointer-events: auto;
            transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), visibility 0s linear 0s;
        }
        #undo-bar .undo-msg { flex: 1; opacity: 0.9; }
        #undo-bar .undo-timer-ring {
            width: 28px; height: 28px; flex-shrink: 0;
            position: relative;
        }
        #undo-bar .undo-timer-ring svg { transform: rotate(-90deg); }
        #undo-bar .undo-timer-ring circle {
            fill: none; stroke: rgba(255,255,255,0.2); stroke-width: 2.5;
        }
        #undo-bar .undo-timer-ring .ring-progress {
            stroke: #10b981; stroke-dasharray: 72; stroke-dashoffset: 0;
            transition: stroke-dashoffset linear;
            stroke-linecap: round;
        }
        #undo-bar .undo-btn {
            background: #10b981; color: white; border: none;
            padding: 7px 14px; border-radius: 9px; font-size: 12px;
            font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif;
            flex-shrink: 0; transition: background 0.2s, transform 0.15s;
        }
        #undo-bar .undo-btn:hover { background: #059669; transform: scale(1.05); }
        #undo-bar .undo-dismiss {
            background: none; border: none; color: rgba(255,255,255,0.5);
            font-size: 16px; cursor: pointer; padding: 2px 4px; line-height: 1;
            flex-shrink: 0;
        }
        body.dark-mode #undo-bar { background: #334155; }
        .highlight-box {
            display: none;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 12px 14px; border-radius: 12px;
            font-size: 13px; margin-bottom: 12px;
            font-weight: 600; line-height: 1.6;
        }
        body.dark-mode .highlight-box {
            background: rgba(34,211,238,0.08);
            border-color: rgba(34,211,238,0.25);
            color: #22d3ee;
        }
        .toggle-box {
            display: flex; background: var(--bg);
            border-radius: 12px; margin-bottom: 12px;
            border: 1.5px solid var(--border); overflow: hidden;
        }
        .toggle-box label {
            flex: 1; text-align: center; padding: 10px 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: background 0.25s, color 0.25s; color: var(--text);
        }
        .toggle-box label:has(input:checked) {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
        }
        .toggle-box input { display: none; }
        /* ===== ATTENDANCE STYLES ===== */
        .att-salesman-row {
            background: var(--bg); border: 1.5px solid var(--border); border-radius: 14px;
            padding: 12px 14px; display: flex; align-items: center; gap: 12px;
            transition: border-color 0.2s;
        }
        .att-salesman-row .att-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white; font-size: 15px; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .att-salesman-row .att-name { font-weight: 700; font-size: 13px; flex: 1; }
        .att-status-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .att-status-btn {
            border: 1.5px solid var(--border); background: var(--card);
            border-radius: 8px; padding: 5px 10px; font-size: 11px; font-weight: 700;
            cursor: pointer; font-family: 'Poppins', sans-serif; color: #64748b;
            transition: all 0.15s; white-space: nowrap;
        }
        .att-status-btn.selected-present  { background: rgba(16,185,129,0.15); border-color: #10b981; color: #065f46; }
        .att-status-btn.selected-absent   { background: rgba(244,63,94,0.12);  border-color: #f43f5e; color: #9f1239; }
        .att-status-btn.selected-halfday  { background: rgba(245,158,11,0.12); border-color: #f59e0b; color: #92400e; }
        .att-status-btn.selected-leave    { background: rgba(99,102,241,0.12); border-color: #6366f1; color: #3730a3; }

        .att-pct-bar { height: 6px; border-radius: 99px; background: var(--border); overflow: hidden; margin-top: 4px; }
        .att-pct-bar-fill { height: 100%; border-radius: 99px; transition: width 0.6s; }

        /* ===== CLASSIC INVOICE BILL STYLES ===== */
        .bill-container {
            background: #ffffff; color: #1a1a2e;
            max-width: 520px; margin: 0 auto; padding: 0;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            border: 1px solid #e2e8f0; position: relative;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        /* Logo banner */
        .bill-logo-wrap {
            text-align: center;
            padding: 18px 24px 0 24px;
            background: #fff;
        }
        .bill-logo-wrap img {
            max-height: 72px; max-width: 220px;
            object-fit: contain; display: block; margin: 0 auto;
        }
        /* Header band — ink-friendly, no dark background */
        .bill-header {
            background: #ffffff;
            color: #1a1a2e;
            text-align: center;
            padding: 12px 20px 10px;
            border-bottom: 3px double #1a1a2e;
            margin-top: 10px;
        }
        .bill-header h1 {
            margin: 0; font-size: 20px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 3px; color: #1a1a2e;
        }
        .bill-header .bill-tagline {
            font-size: 10px; color: #64748b;
            letter-spacing: 1.5px; margin-top: 3px;
        }
        /* Invoice info strip */
        .bill-info-strip {
            display: flex; justify-content: space-between;
            padding: 12px 20px; background: #f8faff;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px; color: #1a1a2e; gap: 12px;
        }
        .bill-info-strip .billed-to { flex: 1; }
        .bill-info-strip .billed-to .label { font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
        .bill-info-strip .billed-to .shop-name { font-size: 14px; font-weight: 800; color: #1a1a2e; line-height: 1.2; }
        .bill-info-strip .billed-to .shop-detail { font-size: 10px; color: #64748b; margin-top: 2px; }
        .bill-info-strip .bill-meta-right { text-align: right; flex-shrink: 0; }
        .bill-info-strip .bill-meta-right .meta-row { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 2px; font-size: 10px; }
        .bill-info-strip .bill-meta-right .meta-row .key { color: #64748b; }
        .bill-info-strip .bill-meta-right .meta-row .val { font-weight: 700; color: #1a1a2e; }
        /* Table */
        .bill-table {
            width: 100%; border-collapse: collapse;
            font-size: 11.5px; margin: 0;
        }
        .bill-table thead tr {
            background: #f1f5f9; color: #1a1a2e;
            border-bottom: 2px solid #1a1a2e;
        }
        .bill-table thead th {
            padding: 9px 10px; font-size: 9.5px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.8px;
            white-space: nowrap; border: 1px solid #cbd5e1;
            color: #1a1a2e;
            page-break-inside: avoid; break-inside: avoid;
        }
        .bill-table thead th:last-child,
        .bill-table thead th.col-rate,
        .bill-table thead th.col-amt { text-align: right; }
        .bill-table thead th.col-qty { text-align: center; }
        .bill-table tbody tr { page-break-inside: avoid; break-inside: avoid; }
        .bill-table tbody tr:nth-child(even) td { background: #f8faff; }
        .bill-table tbody tr:nth-child(odd)  td { background: #ffffff; }
        .bill-table td {
            padding: 9px 10px; border: 1px solid #e2e8f0;
            color: #1a1a2e; vertical-align: middle;
            page-break-inside: avoid; break-inside: avoid;
        }
        .bill-table td.col-sl  { color: #94a3b8; font-size: 10px; text-align: center; width: 28px; }
        .bill-table td.col-desc .prod-name { font-weight: 700; font-size: 12px; }
        .bill-table td.col-rate { text-align: right; white-space: nowrap; }
        .bill-table td.col-qty  { text-align: center; font-weight: 700; }
        .bill-table td.col-amt  { text-align: right; font-weight: 700; white-space: nowrap; }
        /* Totals block */
        .bill-totals-block {
            padding: 10px 16px 12px;
            border-top: 2px solid #1a1a2e;
            background: #fff;
        }
        .bill-totals-block .totals-row {
            display: flex; justify-content: flex-end; align-items: center;
            gap: 20px; padding: 4px 0; font-size: 11.5px;
        }
        .bill-totals-block .totals-row .t-label { color: #64748b; }
        .bill-totals-block .totals-row .t-val   { font-weight: 700; color: #1a1a2e; min-width: 80px; text-align: right; }
        .bill-totals-block .grand-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px; padding-top: 8px;
            border-top: 1.5px dashed #c7d2e0;
        }
        .bill-totals-block .grand-row .g-label {
            font-size: 13px; font-weight: 800; color: #1a1a2e;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .bill-totals-block .grand-row .g-val {
            font-size: 20px; font-weight: 900; color: #1a1a2e;
        }
        /* Footer */
        .bill-footer {
            background: #f8faff; border-top: 1px solid #e2e8f0;
            padding: 10px 20px; text-align: center;
            font-size: 9.5px; color: #94a3b8; letter-spacing: 0.3px;
        }
        .bill-footer .thank-you {
            font-size: 11px; font-weight: 700; color: #2d3561;
            margin-bottom: 3px; letter-spacing: 1px;
        }
        /* Signature row */
        .bill-sign-row {
            display: flex; justify-content: space-between;
            padding: 14px 20px 10px; font-size: 10px; color: #64748b;
        }
        .bill-sign-row .sign-box {
            text-align: center; min-width: 100px;
        }
        .bill-sign-row .sign-box .sign-line {
            border-top: 1px solid #c7d2e0; padding-top: 4px; margin-top: 24px;
        }
        .daily-pass-card {
            border: 1.5px solid rgba(99,102,241,0.3) !important;
            background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02)) !important;
        }
        .pass-display {
            background: var(--bg);
            border: 2px dashed rgba(99,102,241,0.35);
            border-radius: 12px;
            padding: 20px; text-align: center; margin: 12px 0;
            letter-spacing: 8px; font-size: 24px; font-weight: 700;
            color: var(--primary); font-family: 'Courier New', monospace;
        }
        .pass-validity { font-size: 11px; color: #64748b; text-align: center; margin-top: 6px; }
        .master-unlock { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .master-unlock input { flex: 1; margin-bottom: 0 !important; }
        .master-unlock button { width: auto; margin-bottom: 0 !important; padding: 12px 16px; white-space: nowrap; flex-shrink: 0; }
        .pass-locked-msg { text-align: center; padding: 16px; color: #64748b; font-size: 13px; }
        .pass-locked-msg .lock-icon { font-size: 32px; display: block; margin-bottom: 8px; }

        .report-filter-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .report-filter-bar select, .report-filter-bar input[type="date"] {
            flex: 1; min-width: 120px;
            padding: 9px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            background: var(--card);
            color: var(--text);
            outline: none;
        }
        .report-filter-bar select:focus, .report-filter-bar input[type="date"]:focus {
            border-color: var(--primary);
        }

        .date-preset-grid {
            display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
        }
        .preset-btn {
            padding: 7px 12px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .preset-btn:hover, .preset-btn.active-preset {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .sort-toggle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .sort-option {
            padding: 9px 10px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
        }
        .sort-option:hover, .sort-option.active-sort {
            background: linear-gradient(135deg, var(--primary), #6366f1);
            color: white;
            border-color: var(--primary);
        }
        .report-stat-mini {
            background: var(--card);
            border-radius: 14px;
            padding: 14px 16px;
            flex: 1;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .report-stat-mini:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .report-stat-mini .rsm-lbl { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; }
        .report-stat-mini .rsm-val { font-size: 18px; font-weight: 900; margin-top: 3px; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }
        .due-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .due-badge.has-due { background: rgba(244,63,94,0.12); color: #f43f5e; }
        .due-badge.cleared { background: rgba(16,185,129,0.12); color: #10b981; }
        .payment-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px;
        }
        .payment-row:last-child { border-bottom: none; }
        .return-item-row {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 0; border-bottom: 1px solid var(--border);
        }
        .visit-card {
            border-left: 3px solid var(--primary);
            padding: 12px 14px; border-radius: 12px;
            background: var(--bg); margin-bottom: 10px;
            font-size: 13px;
        }
        .visit-card .vc-shop { font-weight: 700; font-size: 14px; color: var(--primary); }
        .visit-card .vc-meta { color: #64748b; font-size: 11px; margin-top: 3px; }
        .perf-card {
            border-radius: 14px; padding: 16px;
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.02));
            border: 1px solid rgba(99,102,241,0.15); margin-bottom: 12px;
        }
        .perf-rank { font-size: 22px; font-weight: 800; margin-right: 8px; }
        .perf-bar-wrap { background: var(--border); border-radius: 99px; height: 8px; margin-top: 8px; }
        .perf-bar { background: linear-gradient(90deg, var(--primary), #6366f1); border-radius: 99px; height: 8px; transition: width 0.6s ease; }
        .pnl-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px;
        }
        .pnl-row:last-child { border-bottom: none; }
        .pnl-total-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; font-size: 16px; font-weight: 800;
            border-top: 2px solid var(--primary); margin-top: 8px;
        }
        .item-disc-badge {
            background: rgba(245,158,11,0.15); color: var(--warning);
            font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px;
            border: 1px solid rgba(245,158,11,0.3);
        }
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
            box-shadow: 0 4px 15px rgba(37,211,102,0.3);
        }
        .btn-whatsapp:hover { box-shadow: 0 8px 20px rgba(37,211,102,0.4); }

        .due-shop-card {
            border-radius: 16px; padding: 18px; margin-bottom: 14px;
            border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); transition: box-shadow 0.3s;
        }
        .due-progress-wrap { background: var(--border); border-radius: 99px; height: 10px; margin: 10px 0 6px; overflow: hidden; }
        .due-progress-bar { height: 10px; border-radius: 99px; transition: width 0.6s ease; }
        .due-stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; padding: 6px 0; }
        .due-total-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 800; padding: 10px 0 0; border-top: 2px solid var(--border); margin-top: 6px; }

        .due-payment-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        .due-payment-table th { background: rgba(16,185,129,0.1); padding: 8px 10px; border-bottom: 2px solid rgba(16,185,129,0.3); color: #10b981; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .due-payment-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .due-payment-table tr:last-child td { border-bottom: none; }
        .due-payment-table tr:hover td { background: rgba(16,185,129,0.05); }

        .action-btn {
            border: none; background: none; cursor: pointer;
            padding: 3px 7px; border-radius: 6px;
            font-size: 12px; font-family: 'Poppins', sans-serif;
            font-weight: 600; transition: background 0.2s;
        }
        .action-btn-edit { color: var(--warning); border: 1px solid rgba(245,158,11,0.35); }
        .action-btn-edit:hover { background: rgba(245,158,11,0.12); }
        .action-btn-delete { color: var(--danger); border: 1px solid rgba(244,63,94,0.35); }
        .action-btn-delete:hover { background: rgba(244,63,94,0.12); }

        #due-pdf-zone, #returns-pdf-zone, #visits-pdf-zone { background: white; color: #1a1a2e; }

        .sidebar-bottom {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* ===== BOTTOM NAVIGATION BAR ===== */
        #bottomNav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-h);
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 200;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        .bn-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
            border: none;
            background: none;
            font-family: 'Poppins', sans-serif;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        .bn-item:active { background: var(--primary-light); }
        .bn-icon {
            font-size: 20px;
            line-height: 1;
            transition: transform 0.2s;
        }
        .bn-label {
            font-size: 9px;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            transition: color 0.2s;
        }
        .bn-item.bn-active .bn-icon { transform: translateY(-2px); }
        .bn-item.bn-active .bn-label { color: var(--primary); }
        .bn-item.bn-active::before {
            content: '';
            position: absolute;
            top: 0; left: 20%; right: 20%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 0 0 4px 4px;
        }
        .bn-badge {
            position: absolute;
            top: 6px; right: calc(50% - 18px);
            background: var(--danger);
            color: white;
            font-size: 8px; font-weight: 800;
            padding: 1px 5px;
            border-radius: 99px;
            min-width: 16px;
            text-align: center;
            border: 2px solid var(--card);
        }

        @media print {
            body * { visibility: hidden; background: white !important; }
            #a5-print-zone, #a5-print-zone * { visibility: visible; }
            #a5-print-zone {
                position: absolute; left: 0; top: 0;
                width: 100%; margin: 0; padding: 0;
                box-shadow: none; border: none;
                border-radius: 0;
            }
            .bill-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bill-table thead tr { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bill-table tbody tr:nth-child(even) td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        /* Dynamic @page rules injected by JS before print */
        #print-page-style { /* placeholder */ }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ===== UNDO SNACKBAR ===== -->
    <div id="undo-bar">
        <span class="undo-msg" id="undo-msg">Deleted</span>
        <div class="undo-timer-ring">
            <svg width="28" height="28" viewBox="0 0 28 28">
                <circle cx="14" cy="14" r="11.5"/>
                <circle class="ring-progress" id="undo-ring" cx="14" cy="14" r="11.5" stroke-dasharray="72" stroke-dashoffset="0"/>
            </svg>
        </div>
        <button class="undo-btn" onclick="executeUndo()">↩ Undo</button>
        <button class="undo-dismiss" onclick="dismissUndo()">✕</button>
    </div>

    <!-- ===== AUTH SCREEN ===== -->
    <div id="auth-screen">
        <!-- Theme Toggle -->
        <button id="authThemeToggle" onclick="toggleAuthTheme()" title="Toggle theme" style="
            position: absolute; top: 18px; right: 18px; z-index: 10;
            background: var(--auth-card-bg); border: 1.5px solid var(--auth-card-border);
            border-radius: 50px; padding: 8px 16px; cursor: pointer;
            font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600;
            color: var(--auth-title-color); display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 12px rgba(79,70,229,0.12); transition: all 0.3s ease;
        ">
            <span id="authThemeIcon">🌙</span>
            <span id="authThemeLabel">Dark</span>
        </button>

        <div id="login-box" class="card" style="width:100%; max-width:380px; text-align:center; padding:32px 28px;">
            <div style="font-size:38px; margin-bottom:8px;">🛒</div>
            <div class="auth-brand">Order With Me</div>
            <div class="auth-brand-sub">Business ERP — Sign in to continue</div>
            <input type="text" id="loginUsername" class="input-field" placeholder="Username" onkeydown="if(event.key==='Enter') loginUser()">
            <input type="password" id="loginPassword" class="input-field" placeholder="Password" onkeydown="if(event.key==='Enter') loginUser()">
            <button class="btn btn-success" onclick="loginUser()" id="btnLogin">Login</button>
            <p class="auth-link-text">No account? <span class="auth-link-highlight" onclick="toggleAuthView('reg')">Register here</span></p>
        </div>
        <div id="reg-box" class="card" style="width:100%; max-width:380px; display:none; padding:28px;">
            <div style="font-size:20px; font-weight:800; text-align:center; margin-bottom:18px;" class="auth-title-text">Create Account</div>
            <input type="text" id="regName" class="input-field" placeholder="Full Name">
            <input type="text" id="regUser" class="input-field" placeholder="Unique Username">
            <input type="password" id="regPass" class="input-field" placeholder="Password (min 6 chars)">
            <select id="regRole" class="input-field">
                <option value="salesman">Salesman</option>
                <option value="manager">Manager</option>
            </select>
            <input type="password" id="pinBox" class="input-field" placeholder="Registration Password">
            <button class="btn" onclick="registerUser()" id="btnReg">Create Account</button>
            <p class="auth-link-text" style="text-align:center;">Have account? <span class="auth-link-highlight" onclick="toggleAuthView('login')">Login here</span></p>
        </div>

        <!-- Credit -->
        <div style="
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            text-align: center; z-index: 2; white-space: nowrap;
        ">
            <span style="
                font-family: 'Poppins', sans-serif;
                font-size: 13px;
                font-weight: 600;
                background: linear-gradient(135deg, var(--auth-brand-start), var(--auth-brand-end));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                opacity: 0.75;
                letter-spacing: 0.5px;
            ">Made With <span style="display:inline-block; animation: heartBeat 1.2s ease-in-out infinite; -webkit-text-fill-color: #f43f5e;">❤️</span> By Aditya</span>
        </div>
    </div>

    <div id="app-screen">
        <!-- OFFLINE STATUS BAR -->
        <div id="offlineBar" style="display:none; position:fixed; top:0; left:0; right:0; z-index:10000; background:linear-gradient(135deg,#f59e0b,#d97706); color:white; text-align:center; padding:8px 16px; font-size:13px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            📵 Offline — Orders will be saved locally and synced when back online
            <span id="offlinePendingCount" style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; margin-left:8px; font-size:12px;"></span>
        </div>

        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

        <!-- ===== SIDEBAR ===== -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <div id="sideAvatar" style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#8b5cf6);color:white;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0;">U</div>
                    <div style="flex:1;min-width:0;">
                        <h3 id="sideName" style="margin:0;font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">User</h3>
                        <p id="sideRole" style="font-size:10px;color:white;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:3px 0 0;background:var(--primary);display:inline-block;padding:2px 9px;border-radius:20px;">Role</p>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;">
                        <button onclick="logoutApp()" style="padding:4px 11px;border:none;border-radius:20px;background:linear-gradient(135deg,#f43f5e,#e11d48);color:white;font-weight:700;font-size:11px;cursor:pointer;font-family:'Poppins',sans-serif;box-shadow:0 2px 8px rgba(244,63,94,0.3);">Logout</button>
                        <span style="font-size:10px;font-weight:700;color:var(--primary);background:var(--primary-light);padding:2px 8px;border-radius:20px;border:1px solid rgba(99,102,241,0.2);">V2.5.3</span>
                    </div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="sidebar-edit-btn" id="menuEditBtn" onclick="toggleMenuEditMode()">✏️ Edit Menu</button>
                </div>
                <div id="menuEditHint" style="display:none; font-size:11px; color:#64748b; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:8px; padding:6px 10px; margin-top:6px;">
                    🖱️ Drag items to reorder. Click ✅ Done when finished.
                </div>
            </div>

            <div class="sidebar-nav-area" id="sidebarNavArea">
                <!-- Menu items rendered dynamically -->
            </div>

            <div class="sidebar-bottom">
                <button onclick="toggleThemeManually()" id="themeToggleBtn"
                    style="width:100%; padding:8px 6px; border:1.5px solid var(--border); border-radius:10px;
                           background:var(--bg); color:var(--text); font-weight:700; font-size:11px;
                           cursor:pointer; font-family:'Poppins',sans-serif; letter-spacing:0.3px;
                           transition:background 0.2s, transform 0.15s;"
                    onmouseover="this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.transform=''">
                    🌙 Dark
                </button>
                <input type="checkbox" id="themeToggleCheckbox" onchange="toggleThemeManually()" style="display:none;">
                <div style="text-align:center; font-size:12px; font-weight:600; color:#64748b; margin-top:12px;">Made With ❤️ By Aditya</div>
            </div>
        </div>

        <div class="header no-print">
            <div style="display:flex; align-items:center; gap:14px;">
                <button onclick="toggleMenu()" style="background:rgba(255,255,255,0.15); border:none; border-radius:10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; color:white; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">☰</button>
                <h3 id="pageTitle" style="margin:0; font-size:15px; font-weight:700; letter-spacing:0.5px; color:white;">DASHBOARD</h3>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="realTimeClock" style="text-align:right; line-height:1.3;"></div>
            </div>
        </div>

        <!-- ===== BOTTOM NAVIGATION BAR ===== -->
        <nav id="bottomNav" class="no-print">
            <button class="bn-item bn-active" id="bn-dashboard" onclick="switchView('dashboard');updateBottomNav('dashboard')">
                <span class="bn-icon">🏠</span><span class="bn-label">Home</span>
            </button>
            <button class="bn-item" id="bn-order" onclick="switchView('order');updateBottomNav('order')">
                <span class="bn-icon">🛒</span><span class="bn-label">Order</span>
            </button>
            <button class="bn-item" id="bn-history" onclick="switchView('history');updateBottomNav('history')">
                <span class="bn-icon">📋</span><span class="bn-label">History</span>
            </button>
            <button class="bn-item" id="bn-stock" onclick="switchView('stock');updateBottomNav('stock')">
                <span class="bn-icon">📦</span><span class="bn-label">Stock</span>
            </button>
            <button class="bn-item" id="bn-more" onclick="toggleMenu()">
                <span class="bn-icon">⋯</span><span class="bn-label">More</span>
            </button>
        </nav>

        <div style="padding:16px 16px 0 16px;">

            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view active">

                <!-- Hero Welcome Banner -->
                <div style="background:linear-gradient(135deg,#4f46e5,#6366f1,#8b5cf6); border-radius:20px; padding:20px 22px; margin-bottom:16px; position:relative; overflow:hidden;">
                    <div style="position:absolute;top:-30px;right:-20px;width:120px;height:120px;background:rgba(255,255,255,0.08);border-radius:50%;"></div>
                    <div style="position:absolute;bottom:-40px;right:40px;width:90px;height:90px;background:rgba(255,255,255,0.05);border-radius:50%;"></div>
                    <div style="font-size:20px;font-weight:800;color:white;margin-bottom:2px;">Hello, <span id="dashWelcomeName">User</span> 👋</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.72);">Here's your business snapshot</div>
                </div>

                <div class="dash-grid">
                    <div class="dash-card dc-today">
                        <div class="dc-icon-bg">📅</div>
                        <div class="dc-lbl">Today's Sales</div>
                        <div class="dc-val" id="dashTodaySales">₹ 0.00</div>
                    </div>
                    <div class="dash-card dc-total">
                        <div class="dc-icon-bg">💰</div>
                        <div class="dc-lbl">Total Sales</div>
                        <div class="dc-val" id="dashTotalSales">₹ 0.00</div>
                    </div>
                    <div class="dash-card dc-orders">
                        <div class="dc-icon-bg">📦</div>
                        <div class="dc-lbl">Total Orders</div>
                        <div class="dc-val" id="dashTotalOrders">0</div>
                    </div>
                    <div class="dash-card dc-alert">
                        <div class="dc-icon-bg">⚠️</div>
                        <div class="dc-lbl">Low Stock</div>
                        <div class="dc-val" id="dashLowStockCount">0</div>
                    </div>
                </div>
                <div id="managerChartsWrapper" style="display:none;">
                    <button type="button" class="collapse-btn" onclick="toggleCollapse('managerChartsArea')">📊 Show / Hide Dashboard Charts</button>
                    <div class="dash-grid" id="managerChartsArea" style="display:none;">
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">📈 Last 7 Days Sales Trend</div>
                            <div class="chart-container"><canvas id="dashSalesChart"></canvas></div>
                        </div>
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:10px; font-size:12px; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">📦 Top 5 Selling Items</div>
                            <div class="chart-container"><canvas id="dashItemChart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--primary); padding-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--primary);">⚡ Quick Access</div>
                        <div style="font-size:9px; color:#94a3b8; font-weight:500; font-style:italic;">updates with your usage</div>
                    </div>
                    <div id="dashQuickAccess" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <div style="text-align:center; padding:14px 8px; background:var(--bg); border-radius:12px; color:#94a3b8; font-size:12px; grid-column:1/-1;">Navigate the app to build your shortcut list</div>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid var(--danger);">
                    <div style="font-size:11px; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; color:var(--danger); margin-bottom:10px;">⚠️ Refill Alert — Stock ≤ 5</div>
                    <div id="dashLowStockList" style="font-size:13px; color:#64748b; max-height:150px; overflow-y:auto;">Loading...</div>
                </div>
            </div>

            <!-- ORDER PANEL -->
            <div id="view-order" class="view">
                <div class="card">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="orderShop" class="input-field" style="margin-bottom:8px; margin-top:8px;" onchange="showOrderDueAlert(this.value)"><option value="">-- Select Shop --</option></select>
                    <div id="orderDueAlert" style="display:none;"></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">Search & Add Items</div>
                    <input type="text" id="orderItemInput" list="orderItemDatalist" class="input-field" placeholder="🔍 Type item name to search..." oninput="showPriceInfo()" autocomplete="off">
                    <datalist id="orderItemDatalist"></datalist>
                    <div class="toggle-box">
                        <label><input type="radio" name="priceMode" value="auto" checked onchange="togglePriceMode()"> 🤖 Auto Price</label>
                        <label style="border-left:1px solid var(--border);"><input type="radio" name="priceMode" value="manual" onchange="togglePriceMode()"> ✍️ Manual Price</label>
                    </div>
                    <div id="priceHighlightBox" class="highlight-box"></div>
                    <div id="manualPriceContainer" style="display:none;">
                        <input type="number" id="manualPriceInput" class="input-field" placeholder="Enter manual/discounted price (₹)">
                    </div>
                    <div id="itemDiscContainer" style="display:none;">
                        <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:6px; letter-spacing:0.5px;">Extra Discount on this Item</div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                            <input type="number" id="itemDiscInput" class="input-field" placeholder="Discount %" min="0" max="100" style="margin-bottom:0; flex:1;" oninput="updateDiscPreview()">
                            <span id="discPricePreview" style="font-size:13px; font-weight:700; color:var(--success); white-space:nowrap;"></span>
                        </div>
                    </div>
                    <div class="flex-between">
                        <input type="number" id="orderQty" class="input-field" placeholder="Qty" style="margin-bottom:0; flex:1;">
                        <button class="btn btn-outline" onclick="addToCart()" style="margin-bottom:0; width:70px; margin-left:10px;">Add</button>
                        <button class="btn btn-outline" onclick="undoCart()" style="margin-bottom:0; width:75px; margin-left:10px; border-color:var(--warning); color:var(--warning);">Undo</button>
                    </div>
                </div>
                <div class="card" id="cartCard" style="display:none;">
                    <div style="font-weight:700; margin-bottom:12px; font-size:15px;">🛒 Cart Items</div>
                    <div id="cartList"></div>
                    <div class="flex-between" style="margin-top:15px; font-weight:700; font-size:15px;">
                        <span>Total:</span><span id="cartTotal" style="color:var(--primary); font-size:20px;">₹ 0.00</span>
                    </div>
                    <button class="btn btn-success" onclick="placeFinalOrder()" id="btnPlace" style="margin-top:15px;">Place Final Order</button>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="view-history" class="view">
                <div id="historyList"><div style="text-align:center; padding:20px; color:#64748b;">Loading...</div></div>
            </div>

        <!-- ===== DELIVERY CONFIRM MODAL ===== -->
        <div id="deliveryConfirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:6000; align-items:center; justify-content:center; padding:16px; backdrop-filter:blur(4px);">
            <div style="background:var(--card); border-radius:22px; width:100%; max-width:420px; max-height:90vh; overflow-y:auto; box-shadow:0 24px 64px rgba(0,0,0,0.3); border:1px solid var(--border);">
                <!-- Header -->
                <div style="padding:20px 20px 0 20px; position:sticky; top:0; background:var(--card); z-index:2; border-bottom:1px solid var(--border); padding-bottom:14px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <div style="font-size:17px; font-weight:800; color:var(--text);">🚚 Delivery Confirmation</div>
                        <button onclick="closeDeliveryConfirm()" style="background:var(--bg); border:1px solid var(--border); border-radius:10px; width:32px; height:32px; font-size:16px; cursor:pointer; color:var(--text);">✕</button>
                    </div>
                    <div id="dcShopInfo" style="font-size:13px; color:#64748b;"></div>
                </div>
                <!-- Body -->
                <div style="padding:16px 20px;">
                    <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.3); border-radius:12px; padding:11px 14px; font-size:12px; color:#92400e; margin-bottom:14px; line-height:1.6;">
                        ⚠️ <b>Enter the quantity actually taken by the shop.</b> Set 0 if not taken. Total will update automatically.
                    </div>
                    <div id="dcItemsContainer"></div>
                    <!-- Summary -->
                    <div style="background:var(--primary-light); border-radius:14px; padding:14px; margin-top:8px; margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-size:13px; font-weight:700; color:var(--text);">Ordered Total</div>
                            <div id="dcOrderedTotal" style="font-size:14px; font-weight:800; color:#64748b;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
                            <div style="font-size:14px; font-weight:800; color:var(--text);">✅ Delivered Total</div>
                            <div id="dcDeliveredTotal" style="font-size:18px; font-weight:900; color:var(--success);"></div>
                        </div>
                    </div>
                    <!-- Buttons -->
                    <div style="display:flex; gap:10px;">
                        <button onclick="confirmDelivery()" class="btn btn-success" style="margin-bottom:0; flex:2; background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                            ✅ Confirm Delivery
                        </button>
                        <button onclick="closeDeliveryConfirm()" class="btn btn-outline" style="margin-bottom:0; flex:1;">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== WHATSAPP INVOICE MODAL ===== -->
        <div id="waModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:10001; align-items:center; justify-content:center; padding:16px;">
            <div class="card" style="width:100%; max-width:360px; margin:0; padding:24px; text-align:center;">
                <div style="font-size:36px; margin-bottom:8px;">✅</div>
                <div style="font-weight:800; font-size:17px; margin-bottom:4px;">Order Placed!</div>
                <div id="waSummaryText" style="font-size:13px; color:#64748b; margin-bottom:18px;"></div>
                <div style="background:var(--bg); border-radius:14px; padding:14px; margin-bottom:16px; text-align:left;">
                    <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">📲 Send WhatsApp Invoice</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span style="font-size:18px;">🇮🇳 +91</span>
                        <input type="tel" id="waPhoneInput" class="input-field" placeholder="Shop phone number" style="margin:0; flex:1;" maxlength="10">
                    </div>
                    <div id="waSavedPhoneHint" style="font-size:11px; color:#10b981; margin-top:6px; display:none;">✅ Saved number auto-filled</div>
                </div>
                <button class="btn" onclick="sendWAInvoice()" style="background:linear-gradient(135deg,#25d366,#128c7e); box-shadow:0 4px 15px rgba(37,211,102,0.35); margin-bottom:10px;">
                    💬 Send WhatsApp Invoice
                </button>
                <button class="btn btn-outline" onclick="closeWAModal()" style="margin-bottom:0; font-size:13px;">
                    Skip → Go to History
                </button>
            </div>
        </div>

            <div id="view-billing" class="view">
                <div class="card no-print">
                    <label style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Order to Generate Bill</label>
                    <select id="billingSelect" class="input-field" onchange="renderA5Bill()" style="margin-top:8px;"><option value="">-- Choose an Order --</option></select>
                </div>
                <div id="bill-preview-section" style="display:none;">
                    <div class="flex-between no-print" style="margin-bottom:15px;">
                        <button class="btn btn-outline" onclick="openPrintSizeModal()" style="margin-bottom:0; flex:1;">🖨️ Print</button>
                        <button class="btn btn-success" onclick="openBillSizePDFModal()" style="margin-bottom:0; flex:1; margin-left:10px;">💾 Save PDF</button>
                        <button class="btn btn-whatsapp" onclick="shareWhatsApp()" style="margin-bottom:0; flex:1; margin-left:10px;">💬 WhatsApp</button>
                    </div>

                    <!-- Print Size Modal -->
                    <div id="printSizeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
                         z-index:9999; align-items:center; justify-content:center; padding:20px;">
                        <div class="card" style="width:100%; max-width:320px; padding:24px; margin:0; text-align:center;">
                            <div style="font-size:28px; margin-bottom:8px;">🖨️</div>
                            <div style="font-weight:800; font-size:16px; margin-bottom:4px;">Select Print Size</div>
                            <div style="font-size:12px; color:#64748b; margin-bottom:20px;">Choose the paper size for printing</div>
                            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:18px;">
                                <button onclick="doPrint('A6')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--primary);
                                           background:linear-gradient(135deg,var(--primary),#6366f1); color:white;
                                           font-weight:800; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;">
                                    <span>📄 A6 <span style="font-size:11px; font-weight:500; opacity:0.85;">(105 × 148 mm)</span></span>
                                    <span style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; font-size:10px;">DEFAULT</span>
                                </button>
                                <button onclick="doPrint('A5')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s, background 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>📄 A5 <span style="font-size:11px; font-weight:500; color:#64748b;">(148 × 210 mm)</span></span>
                                </button>
                                <button onclick="doPrint('A4')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s, background 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>📄 A4 <span style="font-size:11px; font-weight:500; color:#64748b;">(210 × 297 mm)</span></span>
                                </button>
                            </div>
                            <button onclick="document.getElementById('printSizeModal').style.display='none'"
                                class="btn btn-outline" style="margin-bottom:0; font-size:13px;">Cancel</button>
                        </div>
                    </div>

                    <!-- Save PDF Size Modal -->
                    <div id="billPDFSizeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
                         z-index:9999; align-items:center; justify-content:center; padding:20px;">
                        <div class="card" style="width:100%; max-width:320px; padding:24px; margin:0; text-align:center;">
                            <div style="font-size:28px; margin-bottom:8px;">💾</div>
                            <div style="font-weight:800; font-size:16px; margin-bottom:4px;">Select PDF Size</div>
                            <div style="font-size:12px; color:#64748b; margin-bottom:20px;">Choose the page size for the saved PDF</div>
                            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:18px;">
                                <button onclick="downloadBillPDF('A6')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--primary);
                                           background:linear-gradient(135deg,var(--primary),#6366f1); color:white;
                                           font-weight:800; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;">
                                    <span>📄 A6 <span style="font-size:11px; font-weight:500; opacity:0.85;">(105 × 148 mm)</span></span>
                                    <span style="background:rgba(255,255,255,0.25); border-radius:20px; padding:2px 10px; font-size:10px;">DEFAULT</span>
                                </button>
                                <button onclick="downloadBillPDF('A5')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>📄 A5 <span style="font-size:11px; font-weight:500; color:#64748b;">(148 × 210 mm)</span></span>
                                </button>
                                <button onclick="downloadBillPDF('A4')"
                                    style="padding:14px; border-radius:12px; border:2px solid var(--border);
                                           background:var(--bg); color:var(--text);
                                           font-weight:700; font-size:14px; cursor:pointer; font-family:'Poppins',sans-serif;
                                           display:flex; align-items:center; justify-content:space-between;
                                           transition:border-color 0.2s;"
                                    onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-light)'"
                                    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)'">
                                    <span>📄 A4 <span style="font-size:11px; font-weight:500; color:#64748b;">(210 × 297 mm)</span></span>
                                </button>
                            </div>
                            <button onclick="document.getElementById('billPDFSizeModal').style.display='none'"
                                class="btn btn-outline" style="margin-bottom:0; font-size:13px;">Cancel</button>
                        </div>
                    </div>
                    <div id="a5-print-zone" class="bill-container">
                        <!-- Logo (shown only if set) -->
                        <div class="bill-logo-wrap" id="b-logoWrap" style="display:none;">
                            <img id="b-logoImg" src="" alt="Brand Logo">
                        </div>
                        <!-- Dark header band -->
                        <div class="bill-header">
                            <h1 id="b-companyName">Order With Me</h1>
                            <div class="bill-tagline">TAX INVOICE / RETAIL BILL</div>
                        </div>
                        <!-- Info strip -->
                        <div class="bill-info-strip">
                            <div class="billed-to">
                                <div class="label">Billed To</div>
                                <div class="shop-name" id="b-shopName">Shop Name</div>
                                <div class="shop-detail" id="b-shopPhone"></div>
                                <div class="shop-detail" id="b-shopAddr"></div>
                            </div>
                            <div class="bill-meta-right">
                                <div class="meta-row"><span class="key">Bill No</span><span class="val" id="b-orderId">#000000</span></div>
                                <div class="meta-row"><span class="key">Date</span><span class="val" id="b-date">--</span></div>
                                <div class="meta-row"><span class="key">Sales Rep</span><span class="val" id="b-salesman">--</span></div>
                            </div>
                        </div>
                        <!-- Items table -->
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th class="col-sl">Sl</th>
                                    <th class="col-desc">Item Description</th>
                                    <th class="col-rate">Rate (₹)</th>
                                    <th class="col-qty">Qty</th>
                                    <th class="col-amt">Amount (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="b-itemsBody"></tbody>
                        </table>
                        <!-- Totals block -->
                        <div class="bill-totals-block">
                            <div class="totals-row">
                                <span class="t-label">Sub Total</span>
                                <span class="t-val" id="b-subTotal">0.00</span>
                            </div>
                            <div class="totals-row" id="b-discountRow" style="display:none;">
                                <span class="t-label">Discount</span>
                                <span class="t-val" id="b-discount" style="color:#f43f5e;">- 0.00</span>
                            </div>
                            <div class="grand-row">
                                <span class="g-label">Grand Total</span>
                                <span class="g-val">₹ <span id="b-grandTotal">0.00</span></span>
                            </div>
                        </div>
                        <!-- Signature row -->
                        <div class="bill-sign-row">
                            <div class="sign-box">
                                <div class="sign-line">Customer Signature</div>
                            </div>
                            <div class="sign-box">
                                <div class="sign-line">Authorised Signatory</div>
                            </div>
                        </div>
                        <!-- Footer -->
                        <div class="bill-footer">
                            <div class="thank-you">✦ THANK YOU FOR YOUR BUSINESS ✦</div>
                            <div>This is a computer generated invoice. No signature required.</div>
                            <div id="b-footerNote" style="margin-top:2px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STOCK -->
            <div id="view-stock" class="view">
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <div>
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Inventory Status</h3>
                        <div style="font-size:14px; font-weight:700; color:var(--primary); margin-top:4px;">Total Value: <span id="stockTotalValue">₹ 0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <input type="text" id="stockSearch" onkeyup="filterStock()" placeholder="🔍 Search item..." class="input-field" style="margin-bottom:6px; padding:8px 12px; min-width:180px;">
                        <div>
                            <button onclick="exportAnyTable('stockDataArea','Inventory_Stock_Report')" class="btn-outline" style="padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; font-family:inherit;">📄 PDF</button>
                            <button onclick="exportDataExcel(stockDataArray,'Inventory_Stock_Report')" class="btn-success" style="border:none; color:white; padding:5px 10px; border-radius:8px; cursor:pointer; font-size:12px; margin-left:5px; font-family:inherit;">📥 Excel</button>
                        </div>
                    </div>
                </div>
                <div class="card table-wrapper" id="stockDataArea">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>Selling Price (₹)</th>
                                <th class="mgr-only-col">Purchase Price (₹)</th>
                                <th>Disc (%)</th>
                                <th class="mgr-action no-print" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SALES -->
            <div id="view-sales" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Sales Ledger</h3>
                    <div>
                        <button onclick="exportAnyTable('salesDataArea','Sales_Ledger_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">📄 PDF</button>
                        <button onclick="exportDataExcel(salesDataArray,'Sales_Ledger_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">📥 Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="salesDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date & Time</th><th>Party/Shop</th><th>Items Sold</th><th>Total (₹)</th><th>Salesman</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="salesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- PURCHASE -->
            <div id="view-purchase" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Purchase History</h3>
                    <div>
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)" style="display:none;">
                        <button onclick="document.getElementById('importExcelFile').click()" class="btn-outline mgr-action" style="padding:5px 10px; display:none; font-family:inherit;">📤 Import</button>
                        <button onclick="exportAnyTable('purchaseDataArea','Purchase_History_Report')" class="btn-outline" style="padding:5px 10px; margin-left:5px; font-family:inherit;">📄 PDF</button>
                        <button onclick="exportDataExcel(purchaseDataArray,'Purchase_History_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">📥 Excel</button>
                    </div>
                </div>
                <div class="card table-wrapper" id="purchaseDataArea">
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Product</th><th>Added Qty</th><th>Selling Price (₹)</th><th class="mgr-only-col">Cost Price (₹)</th><th>Dealer/Info</th><th class="mgr-action no-print" style="display:none;">Action</th></tr></thead>
                        <tbody id="purchaseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="view-reports" class="view">
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">📈 Advanced Report Filter</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">📅 Quick Date</div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="applyDatePreset('today', this)">Today</button>
                                <button class="preset-btn" onclick="applyDatePreset('yesterday', this)">Yesterday</button>
                                <button class="preset-btn" onclick="applyDatePreset('week', this)">This Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastweek', this)">Last Week</button>
                                <button class="preset-btn" onclick="applyDatePreset('month', this)">This Month</button>
                                <button class="preset-btn" onclick="applyDatePreset('lastmonth', this)">Last Month</button>
                            </div>
                        </div>
                        <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">🎯 Filters</div>
                        <div class="report-filter-bar">
                            <input type="date" id="repStartDate" onchange="clearPresets()" title="Start Date">
                            <input type="date" id="repEndDate" onchange="clearPresets()" title="End Date">
                        </div>
                        <div class="report-filter-bar">
                            <select id="repShop"><option value="all">All Shops</option></select>
                            <select id="repArea"><option value="all">All Areas</option></select>
                            <select id="repItem"><option value="all">All Items</option></select>
                            <select id="repSalesman"><option value="all">All Salesmen</option></select>
                        </div>
                        <div class="report-filter-bar">
                            <input type="number" id="repMinAmount" placeholder="Min ₹" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            <input type="number" id="repMaxAmount" placeholder="Max ₹" style="flex:1; min-width:80px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:4px;">
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">📊 Sort By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="sortOptions">
                                    <div class="sort-option active-sort" onclick="setSortOption('date-desc', this)" style="font-size:11px; padding:7px 8px;">📅 Newest</div>
                                    <div class="sort-option" onclick="setSortOption('date-asc', this)" style="font-size:11px; padding:7px 8px;">📅 Oldest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-desc', this)" style="font-size:11px; padding:7px 8px;">💰 Highest</div>
                                    <div class="sort-option" onclick="setSortOption('amount-asc', this)" style="font-size:11px; padding:7px 8px;">💰 Lowest</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">🗂️ Group By</div>
                                <div style="display:flex; flex-direction:column; gap:5px;" id="groupOptions">
                                    <div class="sort-option active-sort" onclick="setGroupOption('none', this)" style="font-size:11px; padding:7px 8px;">🚫 None</div>
                                    <div class="sort-option" onclick="setGroupOption('shop', this)" style="font-size:11px; padding:7px 8px;">🏪 Shop</div>
                                    <div class="sort-option" onclick="setGroupOption('salesman', this)" style="font-size:11px; padding:7px 8px;">👤 Salesman</div>
                                    <div class="sort-option" onclick="setGroupOption('date', this)" style="font-size:11px; padding:7px 8px;">📅 Date</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:14px;">
                            <button class="btn btn-success" onclick="generateCustomReport()" style="margin-bottom:0; flex:2;">🔍 Generate</button>
                            <button class="btn btn-outline" onclick="resetReportFilters()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">💳 Shop Payment History Report</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px; margin-bottom:12px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Filter by Shop</div>
                            <div class="report-filter-bar">
                                <select id="payRepShopSel"><option value="all">All Shops</option></select>
                                <input type="date" id="payRepStart" title="From date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                                <input type="date" id="payRepEnd" title="To date" style="flex:1; min-width:110px; padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'Poppins',sans-serif; font-size:12px; background:var(--card); color:var(--text); outline:none;">
                            </div>
                            <button class="btn btn-success" onclick="generatePaymentReport()" style="margin-bottom:0; margin-top:4px;">📊 Generate Payment Report</button>
                        </div>
                        <div id="payRepResultArea" style="display:none; margin-top:8px;">
                            <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Billed</div><div class="rsm-val" style="color:var(--primary);" id="payRepTotalBill">₹ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Paid</div><div class="rsm-val" style="color:var(--success);" id="payRepTotalPaid">₹ 0.00</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Remaining Due</div><div class="rsm-val" style="color:var(--danger);" id="payRepRemaining">₹ 0.00</div></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Payment Details <span id="payRepCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('payRepDataArea','Payment_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">📄 PDF</button>
                                    <button onclick="exportDataExcel(paymentReportArray,'Payment_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="payRepDataArea" style="margin-bottom:0;">
                                <table class="data-table" id="payRepTable">
                                    <thead><tr><th>Date</th><th>Shop</th><th>Amount Paid (₹)</th><th>Note</th><th>Recorded By</th></tr></thead>
                                    <tbody id="payRepTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== PRODUCT-WISE SALES REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header open" onclick="toggleCollapsible(this)">
                        <div class="ch-title">📦 Product-wise Sales Report</div>
                        <span class="ch-arrow" style="transform:rotate(180deg);">▼</span>
                    </div>
                    <div class="collapsible-body open">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">📅 Date Range</div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="pwApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="pwApplyPreset('yesterday',this)">Yesterday</button>
                                <button class="preset-btn" onclick="pwApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="pwApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="pwApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="pwApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="pwStartDate" title="From Date" onchange="pwClearPresets()">
                                <input type="date" id="pwEndDate" title="To Date" onchange="pwClearPresets()">
                            </div>
                            <div class="report-filter-bar">
                                <select id="pwShopFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Shops</option>
                                </select>
                                <select id="pwAreaFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Areas</option>
                                </select>
                                <select id="pwSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateProductWiseReport()" style="margin-bottom:0; flex:2;">📊 Generate Report</button>
                                <button class="btn btn-outline" onclick="resetProductWiseReport()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                            </div>
                        </div>
                        <div id="pwResultArea" style="display:none; margin-top:16px;">
                            <!-- Summary Stats -->
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Products Sold</div><div class="rsm-val" style="color:var(--primary);" id="pwTotalProducts">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Qty</div><div class="rsm-val" style="color:var(--success);" id="pwTotalQty">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--warning);" id="pwTotalRevenue">₹ 0</div></div>
                            </div>
                            <!-- Chart -->
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">📊 Top 10 Products by Revenue</div>
                                <div style="position:relative; height:260px;"><canvas id="pwBarChart"></canvas></div>
                            </div>
                            <!-- Pie chart + Top 3 -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">🥧 Revenue Share</div>
                                    <div style="position:relative; height:180px;"><canvas id="pwPieChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">🏆 Top Sellers</div>
                                    <div id="pwTopThree"></div>
                                </div>
                            </div>
                            <!-- Table -->
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Product Details <span id="pwTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('pwTableArea','Product_Sales_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">📄 PDF</button>
                                    <button onclick="exportDataExcel(pwDataArray,'Product_Sales_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="pwTableArea" style="margin-bottom:0;">
                                <table class="data-table" id="pwMainTable">
                                    <thead>
                                        <tr>
                                            <th onclick="pwSortTable('rank')" style="cursor:pointer;" title="Sort by Rank">#</th>
                                            <th onclick="pwSortTable('name')" style="cursor:pointer;" title="Sort by Name">Product ↕</th>
                                            <th onclick="pwSortTable('qty')" style="cursor:pointer;" title="Sort by Qty">Qty Sold ↕</th>
                                            <th onclick="pwSortTable('revenue')" style="cursor:pointer;" title="Sort by Revenue">Revenue ↕</th>
                                            <th onclick="pwSortTable('orders')" style="cursor:pointer;" title="Sort by Orders">Orders ↕</th>
                                            <th>Avg/Order</th>
                                            <th>Share %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pwTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SHOP-WISE SALES REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">🏪 Shop-wise Sales Report</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="swApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="swApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="swApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="swApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="swApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="swStartDate" onchange="swClearPresets()">
                                <input type="date" id="swEndDate" onchange="swClearPresets()">
                            </div>
                            <div class="report-filter-bar">
                                <select id="swSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                                <select id="swAreaFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Areas</option>
                                </select>
                                <select id="swSortBy" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="revenue">Sort: Revenue ↓</option>
                                    <option value="orders">Sort: Orders ↓</option>
                                    <option value="avg">Sort: Avg Order ↓</option>
                                    <option value="name">Sort: Name A-Z</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateShopWiseReport()" style="margin-bottom:0; flex:2;">📊 Generate Report</button>
                                <button class="btn btn-outline" onclick="resetShopWiseReport()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                            </div>
                        </div>
                        <div id="swResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Active Shops</div><div class="rsm-val" style="color:var(--primary);" id="swTotalShops">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Orders</div><div class="rsm-val" style="color:var(--warning);" id="swTotalOrders">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--success);" id="swTotalRevenue">₹ 0</div></div>
                            </div>
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">📊 Top 10 Shops by Revenue</div>
                                <div style="position:relative; height:260px;"><canvas id="swBarChart"></canvas></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Shop Details <span id="swTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('swTableArea','Shop_Sales_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">📄 PDF</button>
                                    <button onclick="exportDataExcel(swDataArray,'Shop_Sales_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="swTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>#</th><th>Shop Name</th><th>Orders</th><th>Revenue (₹)</th><th>Avg/Order</th><th>Share %</th></tr></thead>
                                    <tbody id="swTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SALESMAN PERFORMANCE REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">👤 Salesman Performance Report</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="slApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="slApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="slApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="slApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="slApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="slStartDate" onchange="slClearPresets()">
                                <input type="date" id="slEndDate" onchange="slClearPresets()">
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateSalesmanReport()" style="margin-bottom:0; flex:2;">📊 Generate Report</button>
                                <button class="btn btn-outline" onclick="resetSalesmanReport()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                            </div>
                        </div>
                        <div id="slResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Salesmen</div><div class="rsm-val" style="color:var(--primary);" id="slTotalSalesmen">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Orders</div><div class="rsm-val" style="color:var(--warning);" id="slTotalOrders">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--success);" id="slTotalRevenue">₹ 0</div></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">💰 Revenue</div>
                                    <div style="position:relative; height:180px;"><canvas id="slBarChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">📦 Orders</div>
                                    <div style="position:relative; height:180px;"><canvas id="slOrderChart"></canvas></div>
                                </div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Salesman Details <span id="slTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('slTableArea','Salesman_Performance_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">📄 PDF</button>
                                    <button onclick="exportDataExcel(slDataArray,'Salesman_Performance_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="slTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Rank</th><th>Salesman</th><th>Orders</th><th>Revenue (₹)</th><th>Avg/Order</th><th>Unique Shops</th><th>Share %</th></tr></thead>
                                    <tbody id="slTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== SALES TREND REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">📅 Sales Trend Report</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">📐 Grouping</div>
                            <div class="toggle-box" style="margin-bottom:12px;">
                                <label><input type="radio" name="trendGroup" value="daily" checked onchange=""> 📅 Daily</label>
                                <label style="border-left:1px solid var(--border);"><input type="radio" name="trendGroup" value="weekly" onchange=""> 📆 Weekly</label>
                                <label style="border-left:1px solid var(--border);"><input type="radio" name="trendGroup" value="monthly" onchange=""> 🗓️ Monthly</label>
                            </div>
                            <div class="report-filter-bar">
                                <input type="date" id="trStartDate">
                                <input type="date" id="trEndDate">
                            </div>
                            <div class="report-filter-bar">
                                <select id="trShopFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Shops</option>
                                </select>
                                <select id="trSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                    <option value="all">All Salesmen</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateTrendReport()" style="margin-bottom:0; flex:2;">📈 Generate Trend</button>
                                <button class="btn btn-outline" onclick="resetTrendReport()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                            </div>
                        </div>
                        <div id="trResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Peak Period</div><div class="rsm-val" style="color:var(--primary); font-size:12px;" id="trPeakPeriod">—</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Best Sales</div><div class="rsm-val" style="color:var(--success);" id="trPeakRevenue">₹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Avg/Period</div><div class="rsm-val" style="color:var(--warning);" id="trAvgRevenue">₹ 0</div></div>
                            </div>
                            <div class="card" style="margin-bottom:14px; padding:16px;">
                                <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">📈 Sales Trend</div>
                                <div style="position:relative; height:280px;"><canvas id="trLineChart"></canvas></div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Trend Data <span id="trTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('trTableArea','Sales_Trend_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">📄 PDF</button>
                                    <button onclick="exportDataExcel(trDataArray,'Sales_Trend_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="trTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Period</th><th>Orders</th><th>Revenue (₹)</th><th>Qty Sold</th><th>vs Prev %</th></tr></thead>
                                    <tbody id="trTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== PROFIT & MARGIN REPORT ===== -->
                <div class="collapsible-section no-print">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="ch-title">💰 Profit & Margin Report</div>
                        <span class="ch-arrow">▼</span>
                    </div>
                    <div class="collapsible-body">
                        <div style="margin-top:14px;">
                            <div style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:10px; padding:10px 12px; font-size:12px; color:#92400e; margin-bottom:12px;">
                                ⚠️ Profit calculation needs <b>Cost Price</b> set for each product in Manager Panel → Add/Refill Product.
                            </div>
                            <div class="date-preset-grid">
                                <button class="preset-btn" onclick="pmApplyPreset('today',this)">Today</button>
                                <button class="preset-btn" onclick="pmApplyPreset('week',this)">This Week</button>
                                <button class="preset-btn active-preset" onclick="pmApplyPreset('month',this)">This Month</button>
                                <button class="preset-btn" onclick="pmApplyPreset('lastmonth',this)">Last Month</button>
                                <button class="preset-btn" onclick="pmApplyPreset('all',this)">All Time</button>
                            </div>
                            <div class="report-filter-bar" style="margin-top:8px;">
                                <input type="date" id="pmStartDate" onchange="pmClearPresets()">
                                <input type="date" id="pmEndDate" onchange="pmClearPresets()">
                            </div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-success" onclick="generateProfitReport()" style="margin-bottom:0; flex:2;">💰 Generate Profit Report</button>
                                <button class="btn btn-outline" onclick="resetProfitReport()" style="margin-bottom:0; flex:1;">↺ Reset</button>
                            </div>
                        </div>
                        <div id="pmResultArea" style="display:none; margin-top:16px;">
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--primary);" id="pmRevenue">₹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Cost</div><div class="rsm-val" style="color:var(--danger);" id="pmCost">₹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Net Profit</div><div class="rsm-val" id="pmNetProfit">₹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Margin %</div><div class="rsm-val" id="pmMargin">0%</div></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">💹 Revenue vs Cost</div>
                                    <div style="position:relative; height:180px;"><canvas id="pmBarChart"></canvas></div>
                                </div>
                                <div class="card" style="padding:16px;">
                                    <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">🏆 Highest Margin Products</div>
                                    <div id="pmTopMargin"></div>
                                </div>
                            </div>
                            <div class="flex-between" style="margin-bottom:8px;">
                                <div style="font-size:14px; font-weight:700;">Product Profit Details <span id="pmTableCount" style="font-size:12px; color:#94a3b8; font-weight:500;"></span></div>
                                <div>
                                    <button onclick="exportAnyTable('pmTableArea','Profit_Margin_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit; font-size:12px;">📄 PDF</button>
                                    <button onclick="exportDataExcel(pmDataArray,'Profit_Margin_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit; font-size:12px; border-radius:8px; cursor:pointer;">📥 Excel</button>
                                </div>
                            </div>
                            <div class="card table-wrapper" id="pmTableArea" style="margin-bottom:0;">
                                <table class="data-table">
                                    <thead><tr><th>Product</th><th>Qty Sold</th><th>Revenue (₹)</th><th>Cost (₹)</th><th>Profit (₹)</th><th>Margin %</th></tr></thead>
                                    <tbody id="pmTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reportResultArea" style="display:none;">
                    <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap;">
                        <div class="report-stat-mini"><div class="rsm-lbl">Total Sales</div><div class="rsm-val" style="color:var(--success);" id="repTotalAmount">₹ 0.00</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Items Sold</div><div class="rsm-val" style="color:var(--primary);" id="repTotalQty">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Orders</div><div class="rsm-val" style="color:var(--warning);" id="repOrderCount">0</div></div>
                        <div class="report-stat-mini"><div class="rsm-lbl">Avg Order</div><div class="rsm-val" style="color:var(--secondary);" id="repAvgOrder">₹ 0.00</div></div>
                    </div>
                    <div id="reportChartWrapper" style="display:none; margin-bottom:14px;">
                        <button type="button" class="collapse-btn" onclick="toggleCollapse('reportChartCard')">📊 Show / Hide Report Chart</button>
                        <div class="card chart-container" id="reportChartCard" style="display:none; margin-bottom:0; margin-top:10px; height:280px;">
                            <canvas id="reportChart"></canvas>
                        </div>
                    </div>
                    <div class="flex-between" style="margin-bottom:10px;">
                        <h3 style="margin:0; font-size:16px; font-weight:700;">Report Data <span id="repDataCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                        <div>
                            <button onclick="exportAnyTable('repDataArea','Custom_Filtered_Report')" class="btn-outline" style="padding:5px 10px; font-family:inherit;">📄 PDF</button>
                            <button onclick="exportDataExcel(customReportArray,'Custom_Filtered_Report')" class="btn-success" style="padding:5px 10px; border:none; color:white; margin-left:5px; font-family:inherit;">📥 Excel</button>
                        </div>
                    </div>
                    <div class="card table-wrapper" id="repDataArea">
                        <table class="data-table" id="repMainTable">
                            <thead id="repTableHead"><tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (₹)</th><th>Salesman</th></tr></thead>
                            <tbody id="repTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="view-admin" class="view">

                <!-- ========== COLLAPSIBLE CARD: Brand / Invoice Settings ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(99,102,241,0.3);">
                    <div class="collapse-header" onclick="toggleCollapse('col-brand')">
                        <span>🎨 Bill / Invoice Settings</span>
                        <span class="collapse-arrow" id="arrow-col-brand">▼</span>
                    </div>
                    <div class="collapse-body" id="col-brand" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Set the Company Name and Logo that will appear on all invoices.</p>

                        <!-- Company Name -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">🏢 Company / Brand Name</label>
                        <input type="text" id="brandNameInput" class="input-field" placeholder="e.g. My Company Ltd." value="Order With Me">

                        <!-- Logo upload -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">🖼️ Brand Logo (PNG / JPG)</label>
                        <div id="logoDropZone" onclick="document.getElementById('logoFileInput').click()"
                            style="border:2px dashed rgba(99,102,241,0.4); border-radius:14px; padding:20px; text-align:center; cursor:pointer; background:var(--bg); transition:border-color 0.2s, background 0.2s; margin-bottom:12px;"
                            ondragover="event.preventDefault(); this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'"
                            ondragleave="this.style.borderColor='rgba(99,102,241,0.4)'; this.style.background='var(--bg)'"
                            ondrop="handleLogoDrop(event)">
                            <div id="logoPreviewArea">
                                <div style="font-size:28px; margin-bottom:6px;">🖼️</div>
                                <div style="font-size:13px; font-weight:600; color:#64748b;">Click or drag logo here</div>
                                <div style="font-size:11px; color:#94a3b8; margin-top:3px;">PNG, JPG, SVG — max 2MB</div>
                            </div>
                        </div>
                        <input type="file" id="logoFileInput" accept="image/*" style="display:none;" onchange="handleLogoFile(this.files[0])">

                        <!-- Current logo preview -->
                        <div id="currentLogoPreview" style="display:none; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; display:flex; align-items:center; gap:12px;">
                            <img id="currentLogoImg" src="" style="max-height:50px; max-width:130px; object-fit:contain; border-radius:6px;">
                            <div style="flex:1;">
                                <div style="font-size:12px; font-weight:700; color:var(--text);">Logo set ✅</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Will appear at the top of every bill</div>
                            </div>
                            <button onclick="removeLogo()" style="background:rgba(244,63,94,0.1); color:var(--danger); border:1px solid rgba(244,63,94,0.3); border-radius:8px; padding:5px 10px; font-size:11px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">🗑️ Remove</button>
                        </div>

                        <!-- Footer note -->
                        <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">📝 Bill Footer Note (optional)</label>
                        <input type="text" id="brandFooterInput" class="input-field" placeholder="e.g. GST No: 27XXXXX | Returns within 7 days">

                        <button class="btn btn-success" onclick="saveBrandSettings()" style="margin-bottom:0; background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 4px 15px rgba(16,185,129,0.3);">💾 Save Invoice Settings</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Offline Sync ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(245,158,11,0.3);" id="offlineSyncCardWrap">
                    <div class="collapse-header" onclick="toggleCollapse('col-offline')">
                        <span>📵 Offline Sync Queue <span id="offlineBadgeMgr" style="background:#f59e0b; color:white; border-radius:20px; padding:1px 9px; font-size:11px; margin-left:6px;"></span></span>
                        <span class="collapse-arrow" id="arrow-col-offline">▼</span>
                    </div>
                    <div class="collapse-body" id="col-offline" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">Orders placed while offline are stored here. Connect to the internet and sync manually.</p>
                        <div id="offlineQueueList"><div style="color:#64748b; font-size:13px;">No pending orders.</div></div>
                        <button class="btn btn-outline" onclick="manualSync()" style="margin-top:12px; margin-bottom:0;">🔄 Sync Now</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 1: Daily Password ========== -->
                <div class="collapse-card">
                    <div class="collapse-header" onclick="toggleCollapse('col-daily')">
                        <span>🔐 Daily Registration Password</span>
                        <span class="collapse-arrow" id="arrow-col-daily">▼</span>
                    </div>
                    <div class="collapse-body" id="col-daily" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">A new password is generated every day.</p>
                        <div id="passLockedView">
                            <div class="pass-locked-msg"><span class="lock-icon">🔒</span>Enter Master password to view today's password</div>
                            <div class="master-unlock">
                                <input type="password" id="masterPassInput" class="input-field" placeholder="Master Password..." onkeydown="if(event.key==='Enter') unlockDailyPass()">
                                <button class="btn btn-outline" onclick="unlockDailyPass()" style="width:auto;">Unlock 🔓</button>
                            </div>
                        </div>
                        <div id="passUnlockedView" style="display:none;">
                            <div class="pass-display" id="dailyPassDisplay">••••••••</div>
                            <div class="pass-validity">✅ Valid for today only &nbsp;|&nbsp; 📅 <span id="passValidDate"></span></div>
                            <button class="btn btn-outline" onclick="copyDailyPass()" style="margin-top:12px; margin-bottom:0;">📋 Copy Password</button>
                            <button class="btn" onclick="lockDailyPass()" style="margin-top:8px; margin-bottom:0; background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 15px rgba(244,63,94,0.3); font-size:12px; padding:10px;">🔒 Lock Again</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Area Management ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(245,158,11,0.35);">
                    <div class="collapse-header" onclick="toggleCollapse('col-area')">
                        <span>🗺️ Manage Areas / Zones</span>
                        <span class="collapse-arrow" id="arrow-col-area">▼</span>
                    </div>
                    <div class="collapse-body" id="col-area" style="display:none;">
                        <div class="collapse-body-inner">
                            <p style="font-size:11px; color:#64748b; margin:0 0 14px 0;">Create areas here. When adding or editing a shop, a dropdown will appear from this list.</p>

                            <!-- Add Area Input -->
                            <div style="display:flex; gap:8px; margin-bottom:14px;">
                                <input type="text" id="newAreaInput" class="input-field"
                                    placeholder="New Area name (e.g. North, City Center)"
                                    style="margin-bottom:0; flex:1;"
                                    onkeydown="if(event.key==='Enter') addArea()">
                                <button onclick="addArea()" style="
                                    background:linear-gradient(135deg,#f59e0b,#d97706);
                                    color:white; border:none; border-radius:12px;
                                    padding:11px 18px; font-weight:700; font-size:13px;
                                    font-family:'Poppins',sans-serif; cursor:pointer;
                                    white-space:nowrap; box-shadow:0 4px 12px rgba(245,158,11,0.3);
                                    transition:transform 0.15s, box-shadow 0.15s;"
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 18px rgba(245,158,11,0.4)'"
                                    onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'">
                                    ＋ Add
                                </button>
                            </div>

                            <!-- Area List -->
                            <div id="areaListContainer">
                                <div style="text-align:center; color:#94a3b8; font-size:13px; padding:14px;">Loading areas...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 2: Add/Manage Shop ========== -->
                <div class="collapse-card">
                    <div class="collapse-header" onclick="toggleCollapse('col-shop')">
                        <span>🏪 Add / Manage Shop</span>
                        <span class="collapse-arrow" id="arrow-col-shop">▼</span>
                    </div>
                    <div class="collapse-body" id="col-shop" style="display:none;">
                        <input type="text" id="shopName" class="input-field" placeholder="Shop Name">
                        <input type="tel" id="shopPhone" class="input-field" placeholder="Phone Number">
                        <input type="text" id="shopAddr" class="input-field" placeholder="Address">
                        <div style="margin-bottom:12px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">🗺️ Area / Zone</label>
                            <select id="shopArea" class="input-field" style="margin-bottom:0;">
                                <option value="">-- Select Area --</option>
                            </select>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:6px;">👤 Shop Created By (Salesman)</label>
                            <select id="shopCreatedBy" class="input-field" style="margin-bottom:0;">
                                <option value="">-- Select Salesman --</option>
                            </select>
                            <div style="font-size:11px; color:#94a3b8; margin-top:4px;">This salesman created the shop — used for incentive calculation.</div>
                        </div>
                        <button class="btn btn-outline" onclick="addShop()">Save Shop</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD: Shop List ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(16,185,129,0.3);">
                    <div class="collapse-header" onclick="toggleCollapse('col-shoplist')">
                        <span>📋 Shop List <span id="shopListCountBadge" style="background:var(--success); color:white; border-radius:20px; padding:1px 9px; font-size:11px; margin-left:6px;"></span></span>
                        <span class="collapse-arrow" id="arrow-col-shoplist">▼</span>
                    </div>
                    <div class="collapse-body" id="col-shoplist" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">All registered shops. Manager can edit the Shop Maker (Creator) name.</p>
                        <input type="text" id="shopListSearch" class="input-field" placeholder="🔍 Search shop name..." oninput="renderShopList()" style="margin-bottom:10px;">
                        <div id="shopListContainer">
                            <div style="text-align:center; color:#64748b; font-size:13px; padding:16px;">Loading shops...</div>
                        </div>
                    </div>
                </div>

                <!-- Edit Shop Full Modal -->
                <div id="editShopMakerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:5000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px);">
                    <div style="background:var(--card); border-radius:22px; padding:24px; width:100%; max-width:400px; box-shadow:0 24px 64px rgba(0,0,0,0.28); border:1px solid var(--border); max-height:90vh; overflow-y:auto;">
                        <!-- Header -->
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;">
                            <div>
                                <div style="font-size:17px; font-weight:800; color:var(--text);">✏️ Edit Shop</div>
                                <div id="editShopOrigName" style="font-size:12px; color:#64748b; margin-top:2px;"></div>
                            </div>
                            <button onclick="closeEditShopMaker()" style="background:var(--bg); border:1px solid var(--border); border-radius:10px; width:32px; height:32px; font-size:16px; cursor:pointer; color:var(--text); display:flex; align-items:center; justify-content:center;">✕</button>
                        </div>

                        <input type="hidden" id="editShopMakerShopId">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">🏪 Shop Name</label>
                        <input type="text" id="editShopNameInput" class="input-field" placeholder="Shop name...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">📞 Phone Number</label>
                        <input type="tel" id="editShopPhoneInput" class="input-field" placeholder="Phone number...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">📍 Address</label>
                        <input type="text" id="editShopAddrInput" class="input-field" placeholder="Address...">

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">🗺️ Area / Zone</label>
                        <select id="editShopAreaInput" class="input-field">
                            <option value="">-- Select Area --</option>
                        </select>

                        <label style="font-size:10px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; display:block; margin-bottom:5px;">👤 Shop Maker / Creator</label>
                        <input type="text" id="editShopMakerInput" class="input-field" placeholder="Creator name..." list="editShopMakerList">
                        <datalist id="editShopMakerList"></datalist>

                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button class="btn btn-success" onclick="saveShopFull()" style="margin-bottom:0; flex:2;">💾 Save Changes</button>
                            <button class="btn btn-outline" onclick="closeEditShopMaker()" style="margin-bottom:0; flex:1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 3: Add/Refill Product ========== -->
                <div class="collapse-card">
                    <div class="collapse-header" onclick="toggleCollapse('col-product')">
                        <span>📦 Add / Refill Product</span>
                        <span class="collapse-arrow" id="arrow-col-product">▼</span>
                    </div>
                    <div class="collapse-body" id="col-product" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">This will automatically record in Purchase History.</p>
                        <input type="text" id="prodName" class="input-field" placeholder="Product Name" list="adminProductList">
                        <datalist id="adminProductList"></datalist>
                        <div class="flex-between">
                            <input type="number" id="prodStock" class="input-field" placeholder="New Stock (+)">
                            <input type="number" id="prodPrice" class="input-field" placeholder="Price (₹)">
                        </div>
                        <input type="text" id="purchaseInfo" class="input-field" placeholder="Dealer/Bill Info">
                        <input type="number" id="prodCostPrice" class="input-field" placeholder="Cost Price (₹)">
                        <button class="btn btn-outline" onclick="addProduct()">Save & Log Purchase</button>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 4: User Management ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(99,102,241,0.25);">
                    <div class="collapse-header" onclick="toggleCollapse('col-users')">
                        <span>👥 User Management</span>
                        <span class="collapse-arrow" id="arrow-col-users">▼</span>
                    </div>
                    <div class="collapse-body" id="col-users" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Reset the password of any user.</p>
                        <div id="userListContainer">
                            <div style="text-align:center; color:#64748b; font-size:13px; padding:12px;">Loading users...</div>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 5: Delete Shop / Product ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(244,63,94,0.25);">
                    <div class="collapse-header" onclick="toggleCollapse('col-delete')" style="color:var(--danger);">
                        <span>🗑️ Delete Shop / Product</span>
                        <span class="collapse-arrow" id="arrow-col-delete">▼</span>
                    </div>
                    <div class="collapse-body" id="col-delete" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:12px; margin-top:0;">Careful: This action cannot be undone.</p>
                        <div class="flex-between">
                            <select id="delShopSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Shop to Delete --</option></select>
                            <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteShop()">Delete</button>
                        </div>
                        <div class="flex-between" style="margin-top:14px;">
                            <select id="delItemSelect" class="input-field" style="margin-bottom:0; flex:1;"><option value="">-- Select Item to Delete --</option></select>
                            <button class="btn" style="background:linear-gradient(135deg,#f43f5e,#e11d48); box-shadow:0 4px 12px rgba(244,63,94,0.3); width:auto; margin-bottom:0; margin-left:10px;" onclick="deleteProductFromAdmin()">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- ========== COLLAPSIBLE CARD 6: Incentive Calculation ========== -->
                <div class="collapse-card" style="border:1.5px solid rgba(245,158,11,0.35);">
                    <div class="collapse-header" onclick="toggleCollapse('col-incentive-calc')">
                        <span>🏆 Salesman Incentive Calculator</span>
                        <span class="collapse-arrow" id="arrow-col-incentive-calc">▼</span>
                    </div>
                    <div class="collapse-body" id="col-incentive-calc" style="display:none;">
                        <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Select a date range to view total incentive for each salesman.</p>

                        <!-- ── Inline Rate Editor ── -->
                        <div style="background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(245,158,11,0.04)); border:1.5px solid rgba(245,158,11,0.3); border-radius:14px; padding:14px; margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="font-size:12px; font-weight:800; color:#92400e; text-transform:uppercase; letter-spacing:0.5px;">⚙️ Incentive Rates</div>
                                <button onclick="incSaveRatesInline()" id="incSaveRateBtn"
                                    style="background:linear-gradient(135deg,#f59e0b,#d97706); color:white; border:none; border-radius:8px;
                                           padding:5px 12px; font-size:11px; font-weight:700; cursor:pointer;
                                           font-family:'Poppins',sans-serif; transition:opacity 0.2s;"
                                    onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                                    💾 Save Rates
                                </button>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <!-- Shop Creator Rate -->
                                <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.25); border-radius:12px; padding:12px;">
                                    <div style="font-size:10px; font-weight:700; color:#065f46; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">🏪 Shop Creator</div>
                                    <div style="font-size:11px; color:#64748b; margin-bottom:8px; line-height:1.4;">Applied on every billing of the shop</div>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <input type="number" id="incCalcCreatorPct"
                                            class="input-field"
                                            style="margin:0; flex:1; text-align:center; font-weight:800; font-size:20px;
                                                   color:var(--success); padding:8px; border-color:rgba(16,185,129,0.4);"
                                            min="0" max="100" step="0.1" value="1"
                                            oninput="incPreviewRates()">
                                        <span style="font-size:18px; font-weight:800; color:var(--success);">%</span>
                                    </div>
                                </div>
                                <!-- Order Taker Rate -->
                                <div style="background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:12px;">
                                    <div style="font-size:10px; font-weight:700; color:#3730a3; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">📦 Order Taker</div>
                                    <div style="font-size:11px; color:#64748b; margin-bottom:8px; line-height:1.4;">Applied on every order amount</div>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <input type="number" id="incCalcOrderPct"
                                            class="input-field"
                                            style="margin:0; flex:1; text-align:center; font-weight:800; font-size:20px;
                                                   color:var(--primary); padding:8px; border-color:rgba(99,102,241,0.4);"
                                            min="0" max="100" step="0.1" value="0.5"
                                            oninput="incPreviewRates()">
                                        <span style="font-size:18px; font-weight:800; color:var(--primary);">%</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Live preview line -->
                            <div id="incRatePreviewLine" style="margin-top:10px; font-size:11px; color:#92400e; text-align:center; font-weight:600;"></div>
                        </div>

                        <!-- ── Filters ── -->
                        <div class="date-preset-grid">
                            <button class="preset-btn" onclick="incApplyPreset('week',this)">This Week</button>
                            <button class="preset-btn active-preset" onclick="incApplyPreset('month',this)">This Month</button>
                            <button class="preset-btn" onclick="incApplyPreset('lastmonth',this)">Last Month</button>
                            <button class="preset-btn" onclick="incApplyPreset('all',this)">All Time</button>
                        </div>
                        <div class="report-filter-bar" style="margin-top:8px;">
                            <input type="date" id="incStartDate" onchange="incClearPresets()">
                            <input type="date" id="incEndDate" onchange="incClearPresets()">
                        </div>
                        <div class="report-filter-bar">
                            <select id="incSalesmanFilter" class="input-field" style="margin-bottom:0; font-size:12px; padding:9px 12px;">
                                <option value="all">All Salesmen</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn btn-success" onclick="calculateIncentive()"
                                style="margin-bottom:0; flex:2; background:linear-gradient(135deg,#f59e0b,#d97706);
                                       box-shadow:0 4px 15px rgba(245,158,11,0.3);">
                                🧮 Calculate Incentive
                            </button>
                            <button class="btn btn-outline" onclick="exportDataExcel(incExportArray,'Incentive_Report')"
                                style="margin-bottom:0; flex:1;">📥 Excel</button>
                        </div>

                        <!-- ── Results ── -->
                        <div id="incResultArea" style="display:none; margin-top:16px;">
                            <div id="incRateBanner" style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.35); border-radius:10px; padding:10px 14px; font-size:12px; color:#92400e; margin-bottom:14px;"></div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Revenue</div><div class="rsm-val" style="color:var(--primary);" id="incTotalRevenue">₹ 0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Incentive</div><div class="rsm-val" style="color:var(--warning);" id="incTotalPayout">₹ 0</div></div>
                            </div>
                            <div id="incCardsArea"></div>
                        </div>
                    </div>
                </div>

                <!-- Reset Password Modal -->
                <div id="resetPassModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
                    <div class="card" style="width:90%; max-width:340px; text-align:center; padding:28px; margin:0;">
                        <div style="font-size:28px; margin-bottom:8px;">🔑</div>
                        <div style="font-weight:800; font-size:16px; margin-bottom:4px;" id="resetModalTitle">Password Reset</div>
                        <div style="font-size:12px; color:#64748b; margin-bottom:18px;" id="resetModalSub">Enter new password</div>
                        <input type="password" id="newPassInput" class="input-field" placeholder="New Password (min 6 chars)" onkeydown="if(event.key==='Enter') confirmPasswordReset()">
                        <input type="password" id="confirmPassInput" class="input-field" placeholder="Confirm Password" onkeydown="if(event.key==='Enter') confirmPasswordReset()">
                        <div style="display:flex; gap:10px; margin-top:4px;">
                            <button class="btn btn-outline" onclick="closeResetModal()" style="flex:1; margin-bottom:0;">Cancel</button>
                            <button class="btn btn-success" onclick="confirmPasswordReset()" id="btnConfirmReset" style="flex:1; margin-bottom:0;">✅ Reset</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- DUE / CREDIT VIEW -->
            <div id="view-due" class="view">
                <div class="card mgr-due-add" style="display:none; border:1.5px solid rgba(16,185,129,0.3);">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">💳 Record Payment</div>
                    <p style="font-size:11px; color:#64748b; margin-top:0; margin-bottom:14px;">Selecting a shop will automatically show the total bill and balance.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Select Shop</label>
                    <select id="dueShopSel" class="input-field" onchange="onDueShopChange()" style="margin-top:6px;"><option value="">-- Select Shop --</option></select>
                    <div id="dueShopBillSummary" style="display:none; background:var(--bg); border-radius:14px; padding:16px; margin-bottom:14px; border:1px solid var(--border);">
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">📦 Total Orders Amount</span><span id="dueShopTotalBill" style="font-weight:700; color:var(--text);">₹ 0.00</span></div>
                        <div class="due-stat-row"><span style="color:#64748b; font-size:13px;">✅ Total Paid</span><span id="dueShopTotalPaid" style="font-weight:700; color:var(--success);">₹ 0.00</span></div>
                        <div class="due-progress-wrap"><div id="dueShopProgressBar" class="due-progress-bar" style="width:0%; background:var(--danger);"></div></div>
                        <div class="due-total-row"><span>🔴 Remaining Due</span><span id="dueShopRemaining" style="color:var(--danger); font-size:18px;">₹ 0.00</span></div>
                    </div>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px;">Payment Amount (₹)</label>
                    <input type="number" id="duePayAmt" class="input-field" placeholder="How much did they pay?" style="margin-top:6px;">
                    <input type="text" id="dueNote" class="input-field" placeholder="Note (optional)">
                    <button class="btn btn-success" onclick="saveDueEntry()" style="margin-bottom:0;">💰 Save Payment</button>
                </div>
                <div class="flex-between" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">💳 Due / Credit Tracker</h3>
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#64748b;">Total Remaining Due</div>
                            <div id="totalDueAmt" style="font-size:20px; font-weight:800; color:var(--danger);">₹ 0.00</div>
                        </div>
                        <button onclick="exportDuePDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap;">📄 All Shops PDF</button>
                        <button onclick="exportDuePerShopPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid #10b981; background:transparent; color:#10b981; font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; margin-left:6px;">📄 Per Shop PDF</button>
                    </div>
                </div>
                <div id="dueListArea"><div style="text-align:center; padding:40px; color:#64748b;">Loading...</div></div>
                <div id="due-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- RETURNS — MANAGER ONLY -->
            <div id="view-returns" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">↩️ Process Return / Refund</div>
                    <p style="font-size:11px; color:#64748b; margin-bottom:14px; margin-top:0;">Select an order, then choose which items to return. Stock will be restored automatically.</p>
                    <label style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase;">Select Original Order</label>
                    <select id="returnOrderSel" class="input-field" onchange="loadReturnItems()" style="margin-top:6px;"><option value="">-- Select Order --</option></select>
                    <div id="returnItemsArea" style="display:none; margin-top:10px;">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Select Items to Return</div>
                        <div id="returnItemsList"></div>
                        <input type="text" id="returnReason" class="input-field" placeholder="Return reason (optional)" style="margin-top:10px;">
                        <button class="btn" style="background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 15px rgba(245,158,11,0.3); margin-top:4px;" onclick="processReturn()">↩️ Process Return</button>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Return History</h3>
                    <button onclick="exportReturnsPDF()" style="padding:8px 14px; border-radius:10px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">📄 PDF</button>
                </div>
                <div id="returnHistoryList"><div style="text-align:center; padding:20px; color:#64748b;">No returns yet.</div></div>
                <div id="returns-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SALESMAN PERFORMANCE -->
            <div id="view-salesman-perf" class="view">
                <div class="flex-between" style="margin-bottom:6px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">🏅 Salesman Performance</h3>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="preset-btn active-preset" onclick="setPerfPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPerfPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPerfPeriod('week',this)">This Week</button>
                        <button class="preset-btn" onclick="setPerfPeriod('today',this)">Today</button>
                    </div>
                </div>
                <div id="perfSummaryCards" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;"></div>
                <div id="perfLeaderboard"></div>
                <div id="perfChartWrapper" style="display:none; margin-top:14px;">
                    <div class="card">
                        <div style="font-size:12px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;">Comparison Chart</div>
                        <div style="position:relative; height:220px;"><canvas id="perfChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- P&L -->
            <div id="view-pnl" class="view">
                <div class="flex-between" style="margin-bottom:12px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">📊 Profit &amp; Loss Statement</h3>
                </div>
                <div class="card" style="padding:14px; margin-bottom:14px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="preset-btn active-preset" onclick="setPnlPeriod('all',this)">All Time</button>
                        <button class="preset-btn" onclick="setPnlPeriod('month',this)">This Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('lastmonth',this)">Last Month</button>
                        <button class="preset-btn" onclick="setPnlPeriod('week',this)">This Week</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="date" id="pnlStart" class="input-field" style="margin-bottom:0;">
                        <input type="date" id="pnlEnd" class="input-field" style="margin-bottom:0;">
                    </div>
                    <button class="btn btn-success" onclick="generatePnl()" style="margin-top:10px; margin-bottom:0;">Calculate P&amp;L</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px;">
                    <div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">💰</span><div class="dc-lbl">Total Revenue</div><div class="dc-val" id="pnlRevenue">₹ 0.00</div></div>
                    <div class="dash-card dc-alert" style="cursor:default;"><span class="dc-icon">📉</span><div class="dc-lbl">Total Cost</div><div class="dc-val" id="pnlCost">₹ 0.00</div></div>
                    <div class="dash-card dc-orders" style="cursor:default; grid-column:1/-1;"><span class="dc-icon">🏆</span><div class="dc-lbl">Net Profit / Loss</div><div class="dc-val" id="pnlNet">₹ 0.00</div></div>
                </div>
                <div class="card">
                    <div style="font-weight:700; font-size:14px; margin-bottom:14px; color:var(--text);">Detailed Breakdown</div>
                    <div class="pnl-row"><span>📦 Total Items Sold (Qty)</span><span id="pnlQty" style="font-weight:700;">0</span></div>
                    <div class="pnl-row"><span>🧾 Revenue from Sales</span><span id="pnlRevDetail" style="color:var(--success); font-weight:700;">₹ 0.00</span></div>
                    <div class="pnl-row"><span>📉 Cost of Goods Sold</span><span id="pnlCostDetail" style="color:var(--danger); font-weight:700;">₹ 0.00</span></div>
                    <div class="pnl-row"><span>↩️ Returns Deduction</span><span id="pnlReturnsDetail" style="color:var(--warning); font-weight:700;">- ₹ 0.00</span></div>
                    <div class="pnl-row"><span>📊 Gross Margin %</span><span id="pnlMargin" style="font-weight:700;">0%</span></div>
                    <div class="pnl-total-row"><span>🏆 Net Profit / Loss</span><span id="pnlNetDetail" style="color:var(--primary);">₹ 0.00</span></div>
                </div>
                <div class="card" style="margin-top:0;">
                    <div style="font-weight:700; font-size:14px; margin-bottom:12px;">Top Items by Profit</div>
                    <div id="pnlTopItems"></div>
                </div>
            </div>

            <!-- SHOP VISITS -->
            <div id="view-visits" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:12px;">📍 Log Shop Visit</div>
                    <select id="visitShopSel" class="input-field"><option value="">-- Select Shop Visited --</option></select>
                    <input type="text" id="visitNote" class="input-field" placeholder="Notes (e.g., new order placed, shop closed...)">
                    <button class="btn btn-success" onclick="logVisit()" style="margin-bottom:0;">📍 Log Visit</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <button class="preset-btn active-preset" onclick="setVisitFilter('all',this)">All Visits</button>
                        <button class="preset-btn" onclick="setVisitFilter('today',this)">Today</button>
                        <button class="preset-btn" onclick="setVisitFilter('week',this)">This Week</button>
                        <select id="visitSalesmanFilter" class="input-field" onchange="renderVisits()" style="margin-bottom:0; flex:1; padding:7px 10px; min-width:120px;"><option value="all">All Salesmen</option></select>
                    </div>
                </div>
                <div class="flex-between" style="margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px; font-weight:700;">Visit Log <span id="visitCount" style="font-size:13px; color:#94a3b8; font-weight:600;"></span></h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="exportVisitsPDF()" style="padding:5px 10px; border-radius:8px; border:1.5px solid var(--primary); background:transparent; color:var(--primary); font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif;">📄 PDF</button>
                        <button onclick="exportDataExcel(visitExportArray,'Shop_Visit_Log')" class="btn-success" style="padding:5px 10px; border:none; color:white; font-family:inherit; cursor:pointer; border-radius:8px; font-size:12px;">📥 Excel</button>
                    </div>
                </div>
                <div id="visitListArea"><div style="text-align:center; padding:20px; color:#64748b;">No visits logged yet.</div></div>
                <div id="visits-pdf-zone" style="display:none; padding:20px; font-family:Arial,sans-serif; font-size:12px; color:#1a1a2e;"></div>
            </div>

            <!-- SHOP NOTES -->
            <div id="view-shop-notes" class="view">
                <div class="card">
                    <div style="font-weight:700; font-size:15px; margin-bottom:4px;">📝 Add Shop Note / Remark</div>
                    <p style="font-size:11px; color:#64748b; margin:0 0 12px;">Notes are visible to the whole team.</p>
                    <select id="noteShopSel" class="input-field" style="margin-bottom:10px;"><option value="">-- Select Shop --</option></select>
                    <select id="noteTag" class="input-field" style="margin-bottom:10px;">
                        <option value="general">📌 General Remark</option>
                        <option value="payment">💰 Payment Reminder</option>
                        <option value="closed">🚫 Shop Closed Info</option>
                        <option value="complaint">⚠️ Complaint / Issue</option>
                        <option value="preference">⭐ Customer Preference</option>
                    </select>
                    <textarea id="noteText" class="input-field" placeholder="Write your note here..." rows="3" style="resize:vertical; min-height:70px;"></textarea>
                    <button class="btn btn-success" onclick="saveShopNote()" style="margin-bottom:0;">💾 Save Note</button>
                </div>
                <div class="card" style="padding:14px;">
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
                        <span style="font-size:12px; font-weight:700; color:#94a3b8;">Filter:</span>
                        <select id="noteFilterShop" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;"><option value="all">All Shops</option></select>
                        <select id="noteFilterTag" class="input-field" onchange="renderShopNotes()" style="margin-bottom:0; flex:1; padding:7px 10px;">
                            <option value="all">All Types</option>
                            <option value="general">📌 General</option>
                            <option value="payment">💰 Payment</option>
                            <option value="closed">🚫 Closed Info</option>
                            <option value="complaint">⚠️ Complaint</option>
                            <option value="preference">⭐ Preference</option>
                        </select>
                    </div>
                    <div id="shopNotesArea"><div style="text-align:center; padding:20px; color:#64748b;">No notes yet.</div></div>
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="view-attendance" class="view">

                <!-- ── Take Today's Attendance ── -->
                <div class="collapse-card" style="border:1.5px solid rgba(16,185,129,0.35);">
                    <div class="collapse-header" onclick="toggleCollapse('att-take')">
                        <span style="display:flex;align-items:center;gap:8px;">
                            🗓️ <span>Take Attendance</span>
                            <span id="attTodayBadge" style="background:var(--success);color:white;border-radius:20px;padding:1px 9px;font-size:11px;"></span>
                        </span>
                        <span class="collapse-arrow" id="arrow-att-take">▼</span>
                    </div>
                    <div class="collapse-body" id="att-take" style="display:none;">
                        <p style="font-size:11px;color:#64748b;margin:0 0 12px;">Mark attendance for all salesmen. Changes are saved directly to Firestore.</p>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
                            <div id="attDateLabel" style="font-size:13px;font-weight:700;color:var(--primary);"></div>
                            <input type="date" id="attDatePicker" class="input-field" style="margin:0;width:auto;padding:8px 12px;font-size:12px;" onchange="loadAttendanceForDate()">
                        </div>
                        <div id="attSalesmanGrid" style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px;">
                            <div style="text-align:center;color:#64748b;font-size:13px;padding:16px;">Loading salesmen...</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-success" onclick="saveAttendance()" style="margin-bottom:0;flex:2;background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 4px 15px rgba(16,185,129,0.3);">💾 Save Attendance</button>
                            <button class="btn btn-outline" onclick="attMarkAll('present')" style="margin-bottom:0;flex:1;font-size:12px;">✅ All Present</button>
                            <button class="btn btn-outline" onclick="attMarkAll('absent')" style="margin-bottom:0;flex:1;font-size:12px;border-color:var(--danger);color:var(--danger);">❌ All Absent</button>
                        </div>
                    </div>
                </div>

                <!-- ── Attendance Report ── -->
                <div class="collapse-card" style="border:1.5px solid rgba(99,102,241,0.3);">
                    <div class="collapse-header" onclick="toggleCollapse('att-report')">
                        <span>📊 Attendance Report</span>
                        <span class="collapse-arrow" id="arrow-att-report">▼</span>
                    </div>
                    <div class="collapse-body" id="att-report" style="display:none;">
                        <!-- Filters -->
                        <div class="date-preset-grid" style="margin-top:10px;">
                            <button class="preset-btn" onclick="attReportPreset('week',this)">This Week</button>
                            <button class="preset-btn active-preset" onclick="attReportPreset('month',this)">This Month</button>
                            <button class="preset-btn" onclick="attReportPreset('lastmonth',this)">Last Month</button>
                            <button class="preset-btn" onclick="attReportPreset('all',this)">All Time</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
                            <input type="date" id="attRepStart" class="input-field" style="margin:0;flex:1;min-width:130px;" onchange="clearAttPresets()">
                            <input type="date" id="attRepEnd"   class="input-field" style="margin:0;flex:1;min-width:130px;" onchange="clearAttPresets()">
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                            <select id="attRepSalesman" class="input-field" style="margin:0;flex:1;">
                                <option value="all">All Salesmen</option>
                            </select>
                            <button class="btn btn-success" onclick="generateAttReport()" style="margin:0;flex:1;background:linear-gradient(135deg,#6366f1,#4f46e5);box-shadow:0 4px 14px rgba(99,102,241,0.3);">
                                📊 Generate Report
                            </button>
                        </div>

                        <!-- Stats summary -->
                        <div id="attRepStats" style="display:none;margin-top:16px;">
                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
                                <div class="report-stat-mini"><div class="rsm-lbl">Working Days</div><div class="rsm-val" style="color:var(--primary);" id="attStatDays">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Present</div><div class="rsm-val" style="color:var(--success);" id="attStatPresent">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Total Absent</div><div class="rsm-val" style="color:var(--danger);" id="attStatAbsent">0</div></div>
                                <div class="report-stat-mini"><div class="rsm-lbl">Avg Attendance</div><div class="rsm-val" style="color:var(--warning);" id="attStatAvg">0%</div></div>
                            </div>

                            <!-- Charts -->
                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-bar')">
                                    <span>📊 Salesman-wise Bar Chart</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-bar">▼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-bar" style="display:none;">
                                    <div class="chart-container" style="height:260px;margin-top:12px;">
                                        <canvas id="attBarChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-pie')">
                                    <span>🍩 Overall Present vs Absent</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-pie">▼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-pie" style="display:none;">
                                    <div class="chart-container" style="height:240px;margin-top:12px;">
                                        <canvas id="attPieChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="collapse-card" style="margin-bottom:12px;">
                                <div class="collapse-header" onclick="toggleCollapse('att-chart-trend')">
                                    <span>📈 Daily Trend (Line Chart)</span>
                                    <span class="collapse-arrow" id="arrow-att-chart-trend">▼</span>
                                </div>
                                <div class="collapse-body" id="att-chart-trend" style="display:none;">
                                    <div class="chart-container" style="height:240px;margin-top:12px;">
                                        <canvas id="attLineChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Per-salesman table -->
                            <div class="collapse-card">
                                <div class="collapse-header" onclick="toggleCollapse('att-table')">
                                    <span>📋 Detailed Table</span>
                                    <span class="collapse-arrow" id="arrow-att-table">▼</span>
                                </div>
                                <div class="collapse-body" id="att-table" style="display:none;">
                                    <div style="display:flex;gap:8px;margin-bottom:10px;margin-top:8px;">
                                        <button class="btn btn-outline" onclick="exportAttExcel()" style="margin:0;flex:1;font-size:12px;">📥 Excel</button>
                                        <button class="btn btn-outline" onclick="exportAttPDF()" style="margin:0;flex:1;font-size:12px;">📄 PDF</button>
                                    </div>
                                    <div class="table-wrapper">
                                        <table class="data-table" id="attDetailTable">
                                            <thead>
                                                <tr>
                                                    <th>Salesman</th>
                                                    <th>Present</th>
                                                    <th>Absent</th>
                                                    <th>Half Day</th>
                                                    <th>Leave</th>
                                                    <th>Total Days</th>
                                                    <th>Attendance %</th>
                                                </tr>
                                            </thead>
                                            <tbody id="attDetailBody"></tbody>
                                        </table>
                                    </div>
                                    <!-- Daily breakdown -->
                                    <div id="attDailyBreakdown" style="margin-top:14px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDRm8zdyHdYmaXm5o34GTV3uYkrMPfVfGI",
            authDomain: "order-with-me-636dd.firebaseapp.com",
            projectId: "order-with-me-636dd",
            storageBucket: "order-with-me-636dd.firebasestorage.app",
            messagingSenderId: "437851738821",
            appId: "1:437851738821:web:d923816bfd764793db96ac"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let userData = {}, cart = [], historyData = [];
        let globalShops = {};
        let globalAreas = []; // Firestore areas collection cache
        let stockDataArray = [], salesDataArray = [], purchaseDataArray = [], customReportArray = [], paymentReportArray = [];
        let productsMap = {};
        let dashSalesChartInstance = null, dashItemChartInstance = null, reportChartInstance = null, perfChartInstance = null;
        let currentSortOption = 'date-desc';
        let currentGroupOption = 'none';
        let allVisitsData = [], visitFilterPeriod = 'all', visitExportArray = [];
        let allDueData = {}, allReturnsData = [];
        let perfPeriod = 'all', pnlPeriod = 'all';
        let menuEditMode = false;
        let dragSrcEl = null;
        let dragSrcIdx = -1;

        // ===== UNDO SYSTEM =====
        let undoStack = [];  // {type, data, execute}
        let undoTimer = null;
        let undoRingTimer = null;
        const UNDO_DURATION = 5000;

        function pushUndo(label, undoFn) {
            clearUndoTimer();
            undoStack.push({ label, undoFn });
            document.getElementById('undo-msg').textContent = label;
            const bar = document.getElementById('undo-bar');
            bar.classList.add('visible');
            const ring = document.getElementById('undo-ring');
            ring.style.transition = 'none';
            ring.style.strokeDashoffset = '0';
            requestAnimationFrame(() => {
                ring.style.transition = `stroke-dashoffset ${UNDO_DURATION}ms linear`;
                ring.style.strokeDashoffset = '72';
            });
            undoTimer = setTimeout(() => {
                dismissUndo();
            }, UNDO_DURATION);
        }

        function clearUndoTimer() {
            if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
        }

        function dismissUndo() {
            clearUndoTimer();
            undoStack = [];
            document.getElementById('undo-bar').classList.remove('visible');
        }

        async function executeUndo() {
            clearUndoTimer();
            document.getElementById('undo-bar').classList.remove('visible');
            if (!undoStack.length) return;
            const item = undoStack.pop();
            try {
                await item.undoFn();
                toast('↩ ' + item.label + ' — Undone!', 'success');
            } catch(e) {
                toast('Undo failed: ' + e.message, 'error');
            }
            undoStack = [];
        }

        // ===== MENU CONFIGURATION =====
        // FIX: Returns is now manager-only
        const DEFAULT_MENU_ITEMS = [
            { id: 'dashboard', label: '📊 Dashboard', view: 'dashboard', roles: ['salesman','manager'], always: true },
            { id: 'order', label: '🛒 Order Panel', view: 'order', roles: ['salesman','manager'], always: true },
            { id: 'history', label: '📜 All Orders', view: 'history', roles: ['salesman','manager'], always: true },
            { id: 'billing', label: '🧾 Billing & Invoice', view: 'billing', roles: ['manager'] },
            { id: 'sep1', type: 'separator', label: 'Business Ledgers' },
            { id: 'stock', label: '📦 Current Stock', view: 'stock', roles: ['salesman','manager'], always: true },
            { id: 'sales', label: '💰 Sales Ledger', view: 'sales', roles: ['manager'] },
            { id: 'purchase', label: '📉 Purchase History', view: 'purchase', roles: ['manager'] },
            { id: 'reports', label: '📈 Custom Reports', view: 'reports', roles: ['manager'] },
            { id: 'due', label: '💳 Due / Credit', view: 'due', roles: ['manager'] },
            { id: 'returns', label: '↩️ Returns', view: 'returns', roles: ['manager'] },  // FIXED: manager only
            { id: 'salesman-perf', label: '🏅 Salesman Performance', view: 'salesman-perf', roles: ['manager'] },
            { id: 'pnl', label: '📊 P&L Statement', view: 'pnl', roles: ['manager'] },
            { id: 'visits', label: '📍 Shop Visits', view: 'visits', roles: ['salesman','manager'], always: true },
            { id: 'shop-notes', label: '📝 Shop Notes', view: 'shop-notes', roles: ['salesman','manager'], always: true },
            { id: 'attendance', label: '🗓️ Attendance', view: 'attendance', roles: ['manager'], },
            { id: 'sep2', type: 'separator', label: '' },
            { id: 'admin', label: '⚙️ Manager Panel', view: 'admin', roles: ['manager'], special: true },
        ];
        let menuConfig = null;

        // ===== QUICK ACCESS — Feature Usage Tracking =====
        const USAGE_KEY = 'owm_feature_usage_';
        const QUICK_ACCESS_MENU = [
            { id:'order',         label:'🛒 New Order',        icon:'🛒' },
            { id:'history',       label:'📋 History',           icon:'📋' },
            { id:'billing',       label:'🧾 Billing',           icon:'🧾' },
            { id:'stock',         label:'📦 Stock',             icon:'📦' },
            { id:'reports',       label:'📊 Reports',           icon:'📊' },
            { id:'due',           label:'💳 Due/Credit',        icon:'💳' },
            { id:'returns',       label:'↩️ Returns',           icon:'↩️' },
            { id:'salesman-perf', label:'🏅 Performance',       icon:'🏅' },
            { id:'pnl',           label:'📈 P&L',               icon:'📈' },
            { id:'visits',        label:'📍 Shop Visits',       icon:'📍' },
            { id:'admin',         label:'⚙️ Manager Panel',     icon:'⚙️' },
            { id:'shops',         label:'🏪 Shops',             icon:'🏪' },
            { id:'dashboard',     label:'🏠 Dashboard',         icon:'🏠' },
        ];

        function _usageKey() {
            return USAGE_KEY + (userData.user || 'default');
        }

        function trackUsage(viewId) {
            if (!viewId || viewId === 'dashboard') return;
            try {
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};
                counts[viewId] = (counts[viewId] || 0) + 1;
                localStorage.setItem(_usageKey(), JSON.stringify(counts));
                // Only re-render if dashboard is currently visible
                const dash = document.getElementById('view-dashboard');
                if (dash && dash.classList.contains('active')) renderQuickAccess();
            } catch(e) {}
        }

        function renderQuickAccess() {
            const el = document.getElementById('dashQuickAccess');
            if (!el) return;
            try {
                const role = userData.role || 'salesman';
                const managerOnly = ['reports','salesman-perf','pnl','admin','shops'];
                const raw = localStorage.getItem(_usageKey());
                const counts = raw ? JSON.parse(raw) : {};

                // All menu items allowed for this user role (exclude dashboard itself)
                const available = QUICK_ACCESS_MENU.filter(m => {
                    if (m.id === 'dashboard') return false;
                    return role === 'manager' || !managerOnly.includes(m.id);
                });

                // Sort by usage count desc; preserve order for zero-count ties
                const sorted = [...available].sort((a, b) => (counts[b.id] || 0) - (counts[a.id] || 0));
                const top4 = sorted.slice(0, 4);
                const hasUsage = available.some(m => (counts[m.id] || 0) > 0);
                const maxCount = hasUsage ? (counts[top4[0]?.id] || 0) : 0;

                el.innerHTML = top4.map((meta, i) => {
                    const count = counts[meta.id] || 0;
                    const isHot = hasUsage && i === 0 && count > 0;
                    const label = meta.label.replace(meta.icon, '').trim();
                    return `<button class="qa-btn" onclick="switchView('${meta.id}')" title="${label}">
                        ${isHot ? '<span class="qa-badge">🔥</span>' : ''}
                        <span class="qa-btn-icon">${meta.icon}</span>
                        <span class="qa-btn-label">${label}</span>
                        <span class="qa-btn-count">${count > 0 ? count + ' uses' : 'tap to use'}</span>
                    </button>`;
                }).join('');

                if (!hasUsage) {
                    el.innerHTML += `<div style="font-size:10px;color:#94a3b8;text-align:center;
                        grid-column:1/-1;margin-top:2px;padding:3px 0;">
                        Updates automatically as you use the app ✨</div>`;
                }
            } catch(e) {
                el.innerHTML = '<div style="color:#94a3b8;font-size:12px;text-align:center;grid-column:1/-1;padding:12px;">No data yet</div>';
            }
        }



        function getMenuConfig() {
            try {
                const saved = localStorage.getItem('owm_menu_order_' + (userData.user||'default'));
                if (saved) {
                    const arr = JSON.parse(saved);
                    const existingIds = arr.map(i => i.id);
                    DEFAULT_MENU_ITEMS.forEach(def => {
                        if (!existingIds.includes(def.id)) arr.push(def);
                    });
                    // Sync roles from DEFAULT in case they changed
                    arr.forEach(item => {
                        const def = DEFAULT_MENU_ITEMS.find(d => d.id === item.id);
                        if (def) item.roles = def.roles;
                    });
                    return arr;
                }
            } catch(e) {}
            return JSON.parse(JSON.stringify(DEFAULT_MENU_ITEMS));
        }

        function saveMenuConfig(config) {
            try {
                localStorage.setItem('owm_menu_order_' + (userData.user||'default'), JSON.stringify(config));
            } catch(e) {}
        }

        // ===== DRAG & DROP STATE =====
        let _dragListenersAttached = false;

        function _attachNavDragListeners() {
            // Called ONCE. The nav element never changes after this.
            const nav = document.getElementById('sidebarNavArea');
            if (!nav) return;

            nav.addEventListener('dragstart', function(e) {
                // Try from target first, then walk up
                let item = _draggableParent(e.target);
                // Fallback: if target itself has itemId (direct drag on the element)
                if (!item && e.target && e.target.dataset && e.target.dataset.itemId) item = e.target;
                if (!item) { e.preventDefault(); return; }
                dragSrcEl = item;
                dragSrcIdx = Array.from(nav.children).indexOf(item);
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setData('text/plain', item.dataset.itemId || ''); } catch(_) {}
                setTimeout(() => { if(dragSrcEl) dragSrcEl.classList.add('dragging'); }, 0);
            });

            nav.addEventListener('dragover', function(e) {
                e.preventDefault();
                const item = _draggableParent(e.target);
                if (!item || item === dragSrcEl) return;
                nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                item.classList.add('drag-over');
            });

            nav.addEventListener('dragleave', function(e) {
                if (!nav.contains(e.relatedTarget)) {
                    nav.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                }
            });

            nav.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dst = _draggableParent(e.target);
                if (!dragSrcEl || !dst || dragSrcEl === dst) { _clearDragState(); return; }
                const srcId = dragSrcEl.dataset.itemId;
                const dstId = dst.dataset.itemId;
                if (!srcId || !dstId || srcId === dstId) { _clearDragState(); return; }
                const si = menuConfig.findIndex(x => x.id === srcId);
                const di = menuConfig.findIndex(x => x.id === dstId);
                if (si === -1 || di === -1) { _clearDragState(); return; }
                const [moved] = menuConfig.splice(si, 1);
                menuConfig.splice(di, 0, moved);
                saveMenuConfig(menuConfig);
                _clearDragState();
                renderSidebar();
                toast('✅ Menu reordered!', 'success');
            });

            nav.addEventListener('dragend', function(e) {
                _clearDragState();
            });

            _dragListenersAttached = true;
        }

        function _draggableParent(el) {
            // Walk up DOM to find draggable menu item
            while (el && el !== document.body) {
                if (el.dataset && el.dataset.itemId &&
                    (el.classList.contains('menu-item') || el.classList.contains('menu-section-label'))) {
                    return el;
                }
                el = el.parentElement;
            }
            return null;
        }

        function _clearDragState() {
            document.querySelectorAll('#sidebarNavArea .drag-over, #sidebarNavArea .dragging')
                .forEach(el => el.classList.remove('drag-over', 'dragging'));
            dragSrcEl = null;
        }

        function renderSidebar() {
            if (!menuConfig) menuConfig = getMenuConfig();
            const nav = document.getElementById('sidebarNavArea');
            nav.innerHTML = '';
            const role = userData.role || 'salesman';
            const currentView = document.querySelector('.view.active')?.id?.replace('view-', '') || '';

            menuConfig.forEach((item) => {
                if (item.type === 'separator') {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'menu-section-label';
                    labelDiv.dataset.itemId = item.id;
                    if (menuEditMode) labelDiv.setAttribute('draggable', 'true');
                    const handle = document.createElement('span');
                    handle.className = 'drag-handle';
                    handle.textContent = '⠿';
                    labelDiv.appendChild(handle);
                    labelDiv.appendChild(document.createTextNode(item.label));
                    nav.appendChild(labelDiv);
                    const hr = document.createElement('hr');
                    hr.className = 'menu-hr';
                    nav.appendChild(hr);
                    return;
                }
                if (!item.roles || !item.roles.includes(role)) return;
                const isActive = currentView === item.view;
                const div = document.createElement('div');
                div.className = 'menu-item' + (isActive ? ' active-menu' : '');
                div.dataset.itemId = item.id;
                div.dataset.view = item.view || '';
                if (menuEditMode) div.setAttribute('draggable', 'true');
                if (item.special) div.style.cssText = 'margin-top:4px;border:1px dashed rgba(99,102,241,0.35);';
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '⠿';
                div.appendChild(handle);
                const lbl = document.createElement('span');
                lbl.style.flex = '1';
                lbl.textContent = item.label;
                div.appendChild(lbl);
                if (!menuEditMode) {
                    div.addEventListener('click', () => switchView(item.view));
                }
                nav.appendChild(div);
            });

            // Attach drag listeners once, on first render
            if (!_dragListenersAttached) _attachNavDragListeners();
        }

        function toggleMenuEditMode() {
            menuEditMode = !menuEditMode;
            const btn = document.getElementById('menuEditBtn');
            const hint = document.getElementById('menuEditHint');
            document.body.classList.toggle('menu-edit-mode', menuEditMode);
            if (menuEditMode) {
                btn.textContent = '✅ Done';
                btn.classList.add('active-edit');
                hint.style.display = 'block';
            } else {
                btn.textContent = '✏️ Customize';
                btn.classList.remove('active-edit');
                hint.style.display = 'none';
                saveMenuConfig(menuConfig);
                toast('✅ Menu order saved!', 'success');
            }
            renderSidebar();
        }

        // ===== COLLAPSIBLE =====
        function toggleCollapsible(header) {
            header.classList.toggle('open');
            const body = header.nextElementSibling;
            body.classList.toggle('open');
        }

        // ===== TOAST =====
        function toast(msg, type="normal") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.borderLeftColor = type==='error' ? '#f43f5e' : '#10b981';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function toggleCollapse(id) {
            const el = document.getElementById(id);
            const isNone = el.style.display === 'none' || el.style.display === '';
            el.style.display = isNone ? (id === 'managerChartsArea' ? 'grid' : 'block') : 'none';
        }

        // ===== CLOCK =====
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
            const dateStr = now.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
            const el = document.getElementById('realTimeClock');
            if(el) el.innerHTML = `<div style="font-weight:700; font-size:14px;">${timeStr}</div><div style="font-size:10px; opacity:0.75;">${dateStr}</div>`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ===== THEME =====
        let userManualTheme = null;
        function applyTheme(isDark) {
            const themeToggle = document.getElementById('themeToggleCheckbox');
            const themeBtn = document.getElementById('themeToggleBtn');
            const authIcon = document.getElementById('authThemeIcon');
            const authLabel = document.getElementById('authThemeLabel');
            if (isDark) {
                document.body.classList.add('dark-mode');
                if(themeToggle) themeToggle.checked = true;
                if(themeBtn) themeBtn.innerHTML = '☀️ Light';
                if(authIcon) authIcon.textContent = '☀️';
                if(authLabel) authLabel.textContent = 'Light';
            } else {
                document.body.classList.remove('dark-mode');
                if(themeToggle) themeToggle.checked = false;
                if(themeBtn) themeBtn.innerHTML = '🌙 Dark';
                if(authIcon) authIcon.textContent = '🌙';
                if(authLabel) authLabel.textContent = 'Dark';
            }
        }
        function applySystemTheme() {
            if (userManualTheme !== null) return;
            applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
        }
        function toggleThemeManually() {
            const cb = document.getElementById('themeToggleCheckbox');
            cb.checked = !cb.checked;
            userManualTheme = cb.checked;
            applyTheme(userManualTheme);
        }
        applySystemTheme();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => { if(userManualTheme===null) applyTheme(e.matches); });

        // ===== DAILY PASSWORD =====
        function generateDailyPassword() {
            const now = new Date();
            const seed = now.getFullYear() * 10000 + (now.getMonth()+1) * 100 + now.getDate();
            const mixed = seed ^ (0x4144 ^ 0x1234) ^ 0xAB7F;
            const pool = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghjkmnpqrstuvwxyz';
            let pass = '', state = mixed;
            for (let i = 0; i < 8; i++) {
                state = ((state * 1103515245 + 12345) & 0x7FFFFFFF);
                pass += pool[state % pool.length];
            }
            return pass.substring(0,4) + '-' + pass.substring(4,8);
        }
        function checkMasterPassword(input) {
            let h = 0;
            for (let i = 0; i < input.length; i++) h = ((h << 5) - h + input.charCodeAt(i)) | 0;
            return h === -500839080;
        }
        function unlockDailyPass() {
            const masterInput = document.getElementById('masterPassInput').value;
            if (!checkMasterPassword(masterInput)) { toast("❌ Incorrect master password!", "error"); document.getElementById('masterPassInput').value=''; return; }
            document.getElementById('masterPassInput').value='';
            const daily = generateDailyPassword();
            const today = new Date().toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            document.getElementById('dailyPassDisplay').innerText = daily;
            document.getElementById('passValidDate').innerText = today;
            document.getElementById('passLockedView').style.display = 'none';
            document.getElementById('passUnlockedView').style.display = 'block';
        }
        function lockDailyPass() {
            document.getElementById('dailyPassDisplay').innerText = '••••••••';
            document.getElementById('passUnlockedView').style.display = 'none';
            document.getElementById('passLockedView').style.display = 'block';
        }
        function copyDailyPass() {
            const pass = document.getElementById('dailyPassDisplay').innerText;
            if(navigator.clipboard) navigator.clipboard.writeText(pass).then(() => toast("✅ Password copied!", "success"));
            else { const el=document.createElement('textarea'); el.value=pass; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); toast("✅ Password copied!", "success"); }
        }

        // ===== AUTH =====
        auth.onAuthStateChanged(user => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    userData = doc.data() || {};
                    document.getElementById('sideName').innerText = userData.name || "User";
                    document.getElementById('dashWelcomeName').innerText = userData.name || "User";
                    document.getElementById('sideRole').innerText = userData.role || "Role";
                    // Set avatar initial
                    const avatarEl = document.getElementById('sideAvatar');
                    if (avatarEl) avatarEl.textContent = (userData.name || 'U').charAt(0).toUpperCase();
                    const isMgr = (userData.role === 'manager');
                    // Set role class on body for CSS-based hiding
                    document.body.classList.remove('role-salesman', 'role-manager');
                    document.body.classList.add(isMgr ? 'role-manager' : 'role-salesman');
                    document.getElementById('managerChartsWrapper').style.display = isMgr ? 'block' : 'none';
                    document.querySelectorAll('.mgr-action').forEach(el => el.style.display = isMgr ? 'inline-block' : 'none');
                    document.querySelectorAll('.mgr-due-add').forEach(el => el.style.display = isMgr ? 'block' : 'none');
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-screen').style.display = 'block';
                    renderSidebar();
                    switchView('dashboard');
                    loadData();
                    userData.uid = user.uid;
                    checkPendingReset(user.uid);
                    updateOnlineStatus();
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function loginUser() {
            const user = document.getElementById('loginUsername').value.toLowerCase().trim().replace(/\s/g,'');
            const pass = document.getElementById('loginPassword').value;
            if(!user||!pass) return toast("Enter username and password","error");
            const btn = document.getElementById('btnLogin');
            btn.innerText="Processing..."; btn.disabled=true;
            try {
                await Promise.race([
                    auth.signInWithEmailAndPassword(user+"@erp.com", pass),
                    new Promise((_,rej) => setTimeout(() => rej(new Error("Timeout")), 10000))
                ]);
                toast("Login Successful!","success");
            } catch(e) {
                let msg = e.message;
                if(e.code==='auth/user-not-found') msg="❌ Username not found. Please check and try again.";
                else if(e.code==='auth/wrong-password') msg="❌ Incorrect password. Please try again.";
                else if(e.code==='auth/invalid-credential') msg="❌ Incorrect username or password.";
                else if(e.code==='auth/invalid-email') msg="❌ Invalid username format.";
                else if(e.code==='auth/too-many-requests') msg="⚠️ Too many failed attempts. Please wait a moment and try again.";
                else if(e.code==='auth/network-request-failed') msg="📶 No internet connection. Check your network.";
                else if(e.message==='Timeout') msg="⏱️ Request timed out. Check your connection.";
                else msg="❌ Login failed. Please check your credentials.";
                toast(msg,"error");
            } finally { btn.innerText="Login"; btn.disabled=false; }
        }

        async function registerUser() {
            const name=document.getElementById('regName').value.trim();
            const user=document.getElementById('regUser').value.toLowerCase().trim().replace(/\s/g,'');
            const pass=document.getElementById('regPass').value;
            const role=document.getElementById('regRole').value;
            const pin=document.getElementById('pinBox').value;
            if(!(pin===generateDailyPassword()||checkMasterPassword(pin))) return toast("❌ Invalid registration password!","error");
            if(!name||!user||pass.length<6) return toast("Please fill all details correctly","error");
            document.getElementById('btnReg').innerText="Processing...";
            try {
                const cred = await auth.createUserWithEmailAndPassword(user+"@erp.com", pass);
                await db.collection("users").doc(cred.user.uid).set({ name, user, role });
                toast("Account Created!","success");
            } catch(e) { toast(e.message,"error"); document.getElementById('btnReg').innerText="Create Account"; }
        }

        function logoutApp() {
            menuConfig = null;
            auth.signOut().then(() => {
                toast("Logged Out", "success");
                document.body.classList.remove('role-salesman', 'role-manager');
                historyData = []; allDueData = {}; allReturnsData = []; allVisitsData = [];
                globalShops = {}; productsMap = {};
            });
        }
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
            document.body.style.overflow = document.getElementById('sidebar').classList.contains('active') ? 'hidden' : '';
        }
        function toggleAuthView(v) {
            document.getElementById('login-box').style.display = v=='login'?'block':'none';
            document.getElementById('reg-box').style.display = v=='reg'?'block':'none';
        }
        function toggleAuthTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            userManualTheme = isDark;
            const icon = document.getElementById('authThemeIcon');
            const label = document.getElementById('authThemeLabel');
            if (isDark) {
                if(icon) icon.textContent = '☀️';
                if(label) label.textContent = 'Light';
            } else {
                if(icon) icon.textContent = '🌙';
                if(label) label.textContent = 'Dark';
            }
            // Sync with app theme toggle if present
            const appCb = document.getElementById('themeToggleCheckbox');
            if(appCb) appCb.checked = isDark;
        }
        function filterStock() {
            const searchEl = document.getElementById("stockSearch");
            if (!searchEl) return;
            const input = searchEl.value.toUpperCase();
            Array.from(document.getElementById("stockTableBody").getElementsByTagName("tr")).forEach(tr => {
                const td = tr.getElementsByTagName("td")[0];
                if(td) tr.style.display = td.textContent.toUpperCase().includes(input) ? "" : "none";
            });
        }

        // ===== LOAD DATA =====
        function loadData() {
            db.collection("shops").orderBy("name").onSnapshot(snap => {
                const sel=document.getElementById('orderShop');
                const repShop=document.getElementById('repShop');
                const payRepShop=document.getElementById('payRepShopSel');
                const delShop=document.getElementById('delShopSelect');
                sel.innerHTML='<option value="">-- Select Shop --</option>';
                repShop.innerHTML='<option value="all">All Shops</option>';
                if(payRepShop) payRepShop.innerHTML='<option value="all">All Shops</option>';
                if(delShop) delShop.innerHTML='<option value="">-- Select Shop to Delete --</option>';
                globalShops={};
                snap.forEach(doc => {
                    const d=doc.data(); globalShops[doc.id]=d;
                    const sv=doc.id.replace(/"/g,'&quot;');
                    sel.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    repShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(payRepShop) payRepShop.innerHTML+=`<option value="${sv}">${d.name}</option>`;
                    if(delShop) delShop.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                });
                if(Object.keys(allDueData).length>0 || historyData.length>0) renderDueList();
                // Populate visitShopSel
                const visitSel = document.getElementById('visitShopSel');
                if (visitSel) {
                    visitSel.innerHTML = '<option value="">-- Select Shop Visited --</option>';
                    snap.forEach(doc => {
                        const d = doc.data();
                        visitSel.innerHTML += `<option value="${doc.id}">${d.name || doc.id}</option>`;
                    });
                }
                // Refresh note selects if already populated
                populateNoteShopSelects();
                // Update manager panel shop list
                updateShopListFromGlobal();
                // Refresh area dropdowns (area counts may have changed if shop areas differ)
                renderAreaList();
                populateAreaDropdowns();
            });

            db.collection("products").onSnapshot(snap => {
                const orderDatalist=document.getElementById('orderItemDatalist');
                const repItem=document.getElementById('repItem');
                const delItem=document.getElementById('delItemSelect');
                const adminDatalist=document.getElementById('adminProductList');
                const stockBody=document.getElementById('stockTableBody');
                stockBody.innerHTML=''; stockDataArray=[]; productsMap={};
                let totalStockValue=0, datalistHtml='', lowStockCount=0, lowStockHtml='';
                repItem.innerHTML='<option value="all">All Items</option>';
                if(delItem) delItem.innerHTML='<option value="">-- Select Item to Delete --</option>';
                snap.forEach(doc => {
                    const d=doc.data();
                    const price=d.price||0, stock=d.stock||0, discount=d.discount||0, costPrice=d.costPrice||0;
                    totalStockValue+=(stock*price);
                    productsMap[doc.id]={price,stock,discount,costPrice};
                    const sv=doc.id.replace(/"/g,'&quot;');
                    datalistHtml+=`<option value="${sv}">`;
                    repItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    if(delItem) delItem.innerHTML+=`<option value="${sv}">${doc.id}</option>`;
                    const si=doc.id.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editProduct('${si}',${stock},${price},${discount},${costPrice})" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">✏️</button>
                        <button onclick="deleteProduct('${si}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">🗑️</button>
                    </td>`:'';
                    let discFormat=discount>0?`<b style="color:var(--primary)">${discount}%</b>`:`0%`;
                    let cpDisplay=costPrice>0?`₹${costPrice.toFixed(2)}`:`<span style="color:#94a3b8;">—</span>`;
                    stockBody.innerHTML+=`<tr>
                        <td><b>${doc.id}</b></td>
                        <td style="${stock<=5?'color:#f43f5e;font-weight:700;':''}">${stock}</td>
                        <td>₹${price.toFixed(2)}</td>
                        <td class="mgr-only-col">${cpDisplay}</td>
                        <td>${discFormat}</td>
                        ${actionBtn}
                    </tr>`;
                    stockDataArray.push(userData.role==='manager' ? {"Product":doc.id,"Stock":stock,"Selling Price":price,"Purchase Price":costPrice,"Discount (%)":discount} : {"Product":doc.id,"Stock":stock,"Selling Price":price,"Discount (%)":discount});
                    if(stock<=5){lowStockCount++;lowStockHtml+=`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>${doc.id}</span><span style="color:#f43f5e;font-weight:700;">${stock} left</span></div>`;}
                });
                orderDatalist.innerHTML=datalistHtml;
                if(adminDatalist) adminDatalist.innerHTML=datalistHtml;
                document.getElementById('stockTotalValue').innerText=`₹ ${totalStockValue.toFixed(2)}`;
                document.getElementById('dashLowStockCount').innerText=lowStockCount;
                document.getElementById('dashLowStockList').innerHTML=lowStockCount>0?lowStockHtml:`<div style="padding:10px;color:var(--success);font-weight:700;">✅ All items are well stocked!</div>`;
                filterStock();
            });

            db.collection("purchases").orderBy("time","desc").limit(100).onSnapshot(snap => {
                const pBody=document.getElementById('purchaseTableBody');
                pBody.innerHTML=''; purchaseDataArray=[];
                snap.forEach(doc => {
                    const d=doc.data();
                    const timeStr=d.time?d.time.toDate().toLocaleDateString():'N/A';
                    const sdi=doc.id.replace(/'/g,"\\'");
                    const sin=d.item.replace(/'/g,"\\'").replace(/"/g,'&quot;');
                    let sd=d.dealer?d.dealer.replace(/'/g,"\\'").replace(/"/g,'&quot;'):'';
                    let actionBtn=(userData.role==='manager')?`<td class="no-print" style="white-space:nowrap;">
                        <button onclick="editPurchase('${sdi}','${sin}',${d.addedStock},${d.price||0},${d.costPrice||0},'${sd}')" style="border:1px solid orange;color:orange;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;margin-right:4px;">✏️</button>
                        <button onclick="deletePurchaseRecord('${sdi}')" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">🗑️</button>
                    </td>`:'';
                    pBody.innerHTML+=`<tr><td>${timeStr}</td><td><b>${d.item}</b></td><td style="color:var(--primary);">+${d.addedStock}</td><td>₹${(d.price||0).toFixed(2)}</td><td class="mgr-only-col" style="color:var(--danger);">₹${(d.costPrice||0).toFixed(2)}</td><td>${d.dealer||'N/A'}</td>${actionBtn}</tr>`;
                    purchaseDataArray.push(userData.role==='manager' ? {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Cost Price":d.costPrice||0,"Dealer":d.dealer||''} : {"Date":timeStr,"Item":d.item,"Qty":d.addedStock,"Selling Price":d.price,"Dealer":d.dealer||''});
                });
            });

            db.collection("orders").orderBy("time","desc").onSnapshot(snap => {
                const list=document.getElementById('historyList');
                const salesBody=document.getElementById('salesTableBody');
                const billSel=document.getElementById('billingSelect');
                const repSalesman=document.getElementById('repSalesman');
                list.innerHTML=""; salesBody.innerHTML="";
                billSel.innerHTML='<option value="">-- Choose an Order --</option>';
                historyData=[]; salesDataArray=[];
                let totalS=0, totalO=0, shopMap={}, todayS=0;
                const today=new Date().setHours(0,0,0,0);
                let salesmenSet=new Set();
                let last7DaysMap={}, topItemsMap={};
                for(let i=6;i>=0;i--){let dt=new Date();dt.setDate(dt.getDate()-i);last7DaysMap[dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})]=0;}
                let idx=0;
                snap.forEach(doc => {
                    const d=doc.data(); d.orderId=doc.id; historyData.push(d);
                    salesmenSet.add(d.salesman);
                    let oTime=d.time?d.time.toDate():new Date();
                    const timeS=oTime.toLocaleString();
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    if(userData.role==='manager'){
                        let dk=oTime.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
                        if(d.deliveryStatus==='delivered' && last7DaysMap[dk]!==undefined) last7DaysMap[dk]+=d.total;
                        if(d.deliveryStatus==='delivered') d.items.forEach(item=>{topItemsMap[item.id]=(topItemsMap[item.id]||0)+item.qty;});
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        totalO++;
                        if(d.deliveryStatus==='delivered') {
                            totalS+=d.total;
                            if(oTime.getTime()>=today) todayS+=d.total;
                            shopMap[d.shopName]=(shopMap[d.shopName]||0)+d.total;
                        }
                    }
                    billSel.innerHTML+=`<option value="${idx}">${d.shopName} (₹${d.total.toFixed(0)})</option>`;
                    let actionBtn="", billBtn="";
                    if(userData.role==='manager'){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                        billBtn=`<button onclick="document.getElementById('billingSelect').value='${idx}';renderA5Bill();switchView('billing');" class="btn-outline" style="padding:2px 8px;font-size:12px;">Bill</button>`;
                    } else if(d.salesman===userData.name){
                        actionBtn=`<button onclick="editOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:var(--primary);color:var(--primary);margin-left:5px;font-size:12px;">Edit</button>
                                   <button onclick="deleteOrder(${idx})" class="btn-outline" style="padding:2px 8px;border-color:red;color:red;margin-left:5px;font-size:12px;">Delete</button>`;
                    }
                    if(userData.role==='manager'||d.salesman===userData.name){
                        const isPending = !d.deliveryStatus || d.deliveryStatus === 'pending';
                        const statusBadge = isPending
                            ? `<span style="background:rgba(245,158,11,0.15);color:#b45309;border:1px solid rgba(245,158,11,0.4);border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;">🚚 Pending Delivery</span>`
                            : `<span style="background:rgba(16,185,129,0.13);color:#065f46;border:1px solid rgba(16,185,129,0.35);border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;">✅ Delivered</span>`;
                        const deliverBtn = isPending
                            ? `<button onclick="openDeliveryConfirm(${idx})" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;margin-left:5px;">🚚 Deliver</button>`
                            : '';
                        const amountRow = isPending
                            ? `<b style="font-size:16px;color:var(--warning);">₹ ${d.total.toFixed(2)}</b>`
                            : `<div>
                                <b style="font-size:16px;color:var(--success);">₹ ${d.total.toFixed(2)}</b>
                                ${d.orderedTotal && d.orderedTotal !== d.total ? `<span style="font-size:11px;color:#94a3b8;margin-left:6px;text-decoration:line-through;">₹${d.orderedTotal.toFixed(2)}</span>` : ''}
                               </div>`;
                        list.innerHTML+=`<div class="card" style="border-left:3px solid ${isPending?'#f59e0b':'#10b981'};">
                            <div class="flex-between">
                                <b style="color:var(--primary);font-size:15px;">${d.shopName}</b>
                                <small style="color:#64748b;">${timeS}</small>
                            </div>
                            <div style="margin:5px 0;">${statusBadge}</div>
                            <div style="font-size:13px;margin:6px 0;color:var(--text);">${itemsText}</div>
                            <div style="font-size:11px;margin-bottom:6px;color:#64748b;">👤 ${d.salesman}</div>
                            <div class="flex-between">
                                ${amountRow}
                                <div>${billBtn}${deliverBtn}${actionBtn}</div>
                            </div>
                        </div>`;
                    }
                    let salesActionBtn=(userData.role==='manager')?`<td class="no-print"><button onclick="deleteOrder(${idx})" style="border:1px solid red;color:red;background:none;cursor:pointer;padding:2px 5px;border-radius:4px;">🗑️</button></td>`:'';
                    salesBody.innerHTML+=`<tr><td>${timeS}</td><td>${d.shopName}</td><td>${itemsText}</td><td>₹${d.total.toFixed(2)}</td><td>${d.salesman}</td>${salesActionBtn}</tr>`;
                    salesDataArray.push({"Date":timeS,"Shop":d.shopName,"Total":d.total});
                    idx++;
                });
                document.getElementById('dashTodaySales').innerText=`₹ ${todayS.toFixed(2)}`;
                document.getElementById('dashTotalSales').innerText=`₹ ${totalS.toFixed(2)}`;
                document.getElementById('dashTotalOrders').innerText=totalO;
                renderQuickAccess();
                if(repSalesman){repSalesman.innerHTML='<option value="all">All Salesmen</option>';salesmenSet.forEach(s=>repSalesman.innerHTML+=`<option value="${s}">${s}</option>`);}
                if(userData.role==='manager') updateDashboardCharts(last7DaysMap,topItemsMap);
                renderDueList();
                renderQuickAccess();
            });

            db.collection("shop_notes").orderBy("time","desc").limit(500).onSnapshot(snap => {
                allShopNotes = [];
                snap.forEach(doc => { const d = doc.data(); d.docId = doc.id; allShopNotes.push(d); });
                if (document.getElementById('view-shop-notes')?.classList.contains('active')) renderShopNotes();
            });

            db.collection("due_entries").orderBy("time","desc").onSnapshot(snap => {
                allDueData={};
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id;
                    if(!allDueData[d.shopName]) allDueData[d.shopName]=[];
                    allDueData[d.shopName].push(d);
                });
                renderDueList();
            });

            db.collection("returns").orderBy("time","desc").limit(100).onSnapshot(snap => {
                allReturnsData=[];
                const rList=document.getElementById('returnHistoryList');
                rList.innerHTML='';
                snap.forEach(doc => {
                    const d=doc.data(); d.docId=doc.id; allReturnsData.push(d);
                    const timeS=d.time?d.time.toDate().toLocaleString():'';
                    const itemsText=d.items.map(i=>`${i.id}(${i.qty})`).join(', ');
                    const safeDocId = d.docId.replace(/'/g,"\\'");
                    // FIX: Only managers can edit/delete returns
                    const canEdit = (userData.role === 'manager');
                    const editDeleteBtns = canEdit ? `
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            <button class="action-btn action-btn-edit" onclick="editReturn('${safeDocId}')">✏️ Edit Note</button>
                            <button class="action-btn action-btn-delete" onclick="deleteReturn('${safeDocId}',${d.refundAmt||0})">🗑️ Delete</button>
                        </div>` : '';
                    rList.innerHTML+=`<div class="card" style="margin-bottom:10px;" data-return-id="${d.docId}">
                        <div class="flex-between"><b style="color:var(--warning);">↩️ ${d.shopName}</b><small style="color:#64748b;">${timeS}</small></div>
                        <div style="font-size:13px;margin:6px 0;">${itemsText}</div>
                        <div style="font-size:11px;color:#64748b;">👤 ${d.salesman} ${d.reason?'| Reason: '+d.reason:''}</div>
                        <div style="margin-top:6px;font-weight:700;color:var(--warning);">Refund: ₹ ${(d.refundAmt||0).toFixed(2)}</div>
                        ${editDeleteBtns}
                    </div>`;
                });
                if(!snap.size) rList.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No returns yet.</div>';
            });

            db.collection("visits").orderBy("time","desc").limit(300).onSnapshot(snap => {
                allVisitsData=[];
                const salesmenSet=new Set(['all']);
                snap.forEach(doc => { const d=doc.data(); d.docId=doc.id; allVisitsData.push(d); salesmenSet.add(d.salesman); });
                const vsf=document.getElementById('visitSalesmanFilter');
                const curVal=vsf.value;
                vsf.innerHTML='<option value="all">All Salesmen</option>';
                salesmenSet.forEach(s=>{ if(s!=='all') vsf.innerHTML+=`<option value="${s}">${s}</option>`; });
                vsf.value=curVal;
                renderVisits();
            });

            // After all data loaded, populate incentive & shop selects
            setTimeout(() => {
                populateIncSalesmanFilter();
                populateShopCreatedBySelect();
            }, 1500);

            // ===== AREAS REALTIME LISTENER =====
            db.collection("areas").orderBy("name").onSnapshot(snap => {
                globalAreas = [];
                snap.forEach(doc => globalAreas.push({ id: doc.id, name: doc.data().name || doc.id }));
                renderAreaList();
                populateAreaDropdowns();
            });
        }

        // ===== AREA MANAGEMENT =====

        function populateAreaDropdowns() {
            // Populate all area dropdowns/selects throughout the app
            const selects = [
                { id: 'shopArea', current: null },
                { id: 'editShopAreaInput', current: null },
                { id: 'swAreaFilter', current: null },
                { id: 'pwAreaFilter', current: null },
                { id: 'repArea', current: null },
            ];
            selects.forEach(({ id }) => {
                const el = document.getElementById(id);
                if (!el) return;
                const cur = el.value;
                const isFilter = ['swAreaFilter','pwAreaFilter','repArea'].includes(id);
                el.innerHTML = isFilter
                    ? '<option value="all">All Areas</option>'
                    : '<option value="">-- Select Area --</option>';
                globalAreas.forEach(a => {
                    el.innerHTML += `<option value="${a.name}">${a.name}</option>`;
                });
                // Restore previous selection if still valid
                if (cur && [...el.options].some(o => o.value === cur)) el.value = cur;
            });
        }

        function renderAreaList() {
            const container = document.getElementById('areaListContainer');
            if (!container) return;

            if (!globalAreas.length) {
                container.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#94a3b8;">
                        <div style="font-size:32px; margin-bottom:8px;">🗺️</div>
                        <div style="font-size:13px;">No areas found. Add a new area above.</div>
                    </div>`;
                return;
            }

            container.innerHTML = globalAreas.map((a, i) => {
                // Count shops in this area
                const shopCount = Object.values(globalShops).filter(s => s.area === a.name).length;
                return `
                <div style="
                    display:flex; align-items:center; justify-content:space-between;
                    background:var(--bg); border:1.5px solid var(--border);
                    border-radius:12px; padding:11px 14px; margin-bottom:8px;
                    transition:box-shadow 0.2s;"
                    onmouseover="this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.boxShadow='none'">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="
                            background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));
                            border:1px solid rgba(245,158,11,0.3);
                            border-radius:8px; width:32px; height:32px;
                            display:flex; align-items:center; justify-content:center;
                            font-size:15px; flex-shrink:0;">🗺️</div>
                        <div>
                            <div style="font-weight:700; font-size:14px; color:var(--text);">${a.name}</div>
                            <div style="font-size:11px; color:#94a3b8; margin-top:1px;">
                                ${shopCount > 0
                                    ? `<span style="color:#b45309; font-weight:600;">🏪 ${shopCount} shop${shopCount > 1 ? 's' : ''}</span>`
                                    : `<span>No shops yet</span>`}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <button onclick="editAreaPrompt('${a.id}','${a.name.replace(/'/g,"\\\'")}')"
                            style="background:var(--primary-light); color:var(--primary); border:1px solid rgba(99,102,241,0.2);
                            border-radius:8px; padding:6px 10px; font-size:11px; font-weight:700;
                            cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(99,102,241,0.18)'"
                            onmouseout="this.style.background='var(--primary-light)'">✏️ Edit</button>
                        <button onclick="deleteArea('${a.id}','${a.name.replace(/'/g,"\\\'")}')"
                            style="background:rgba(244,63,94,0.08); color:#f43f5e; border:1px solid rgba(244,63,94,0.18);
                            border-radius:8px; padding:6px 10px; font-size:11px; font-weight:700;
                            cursor:pointer; font-family:'Poppins',sans-serif; transition:background 0.15s;"
                            onmouseover="this.style.background='rgba(244,63,94,0.15)'"
                            onmouseout="this.style.background='rgba(244,63,94,0.08)'">🗑️</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function addArea() {
            const input = document.getElementById('newAreaInput');
            const name = (input?.value || '').trim();
            if (!name) return toast('Please enter an area name', 'error');

            // Check duplicate
            if (globalAreas.some(a => a.name.toLowerCase() === name.toLowerCase())) {
                return toast(`"${name}" area already exists!`, 'error');
            }

            try {
                const docId = name.replace(/[^a-zA-Z0-9_\u0980-\u09FF\s]/g, '').replace(/\s+/g, '_').toLowerCase();
                await db.collection('areas').doc(docId).set({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                if (input) input.value = '';
                toast(`✅ Area "${name}" added!`, 'success');
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        async function editAreaPrompt(areaId, oldName) {
            const newName = prompt(`✏️ Rename area:\n(current: "${oldName}")`, oldName);
            if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
            const trimmed = newName.trim();

            if (globalAreas.some(a => a.name.toLowerCase() === trimmed.toLowerCase() && a.id !== areaId)) {
                return toast(`"${trimmed}" area already exists!`, 'error');
            }

            try {
                await db.collection('areas').doc(areaId).update({ name: trimmed });
                // Also update all shops that have this area
                const batch = db.batch();
                Object.entries(globalShops).forEach(([id, d]) => {
                    if (d.area === oldName) {
                        batch.update(db.collection('shops').doc(id), { area: trimmed });
                    }
                });
                await batch.commit();
                toast(`✅ Area renamed to "${trimmed}"!`, 'success');
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        async function deleteArea(areaId, areaName) {
            const shopCount = Object.values(globalShops).filter(s => s.area === areaName).length;
            const msg = shopCount > 0
                ? `⚠️ "${areaName}" area has ${shopCount} shop${shopCount>1?'s':''}!\nDeleting it will clear the area from those shops.\n\nAre you sure?`
                : `Delete "${areaName}" area?`;

            if (!confirm(msg)) return;

            try {
                await db.collection('areas').doc(areaId).delete();
                // Clear area from shops
                if (shopCount > 0) {
                    const batch = db.batch();
                    Object.entries(globalShops).forEach(([id, d]) => {
                        if (d.area === areaName) {
                            batch.update(db.collection('shops').doc(id), { area: '' });
                        }
                    });
                    await batch.commit();
                }
                toast(`🗑️ Area "${areaName}" deleted!`, 'success');
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        // ===== CHARTS =====
        function updateDashboardCharts(salesMap, itemsMap) {
            const salesCtx=document.getElementById('dashSalesChart').getContext('2d');
            if(dashSalesChartInstance) dashSalesChartInstance.destroy();
            dashSalesChartInstance=new Chart(salesCtx,{type:'line',data:{labels:Object.keys(salesMap),datasets:[{label:'Sales (₹)',data:Object.values(salesMap),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',fill:true,tension:0.4,pointBackgroundColor:'#6366f1',pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
            const sortedItems=Object.entries(itemsMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const itemCtx=document.getElementById('dashItemChart').getContext('2d');
            if(dashItemChartInstance) dashItemChartInstance.destroy();
            dashItemChartInstance=new Chart(itemCtx,{type:'doughnut',data:{labels:sortedItems.map(i=>i[0]),datasets:[{data:sortedItems.map(i=>i[1]),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10}}}}}});
        }

        function updateReportChart(groupMap) {
            const ctx=document.getElementById('reportChart').getContext('2d');
            if(reportChartInstance) reportChartInstance.destroy();
            const labels=Object.keys(groupMap), values=Object.values(groupMap);
            reportChartInstance=new Chart(ctx,{type:labels.length<=6?'bar':'line',data:{labels,datasets:[{label:'Sales (₹)',data:values,backgroundColor:'rgba(16,185,129,0.7)',borderColor:'#10b981',borderRadius:6,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
        }

        // ===== REPORT HELPERS =====
        function applyDatePreset(preset, btn) {
            document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const today=new Date(); let start, end;
            if(preset==='today'){start=end=today;}
            else if(preset==='yesterday'){const yd=new Date(today);yd.setDate(yd.getDate()-1);start=end=yd;}
            else if(preset==='week'){start=new Date(today);start.setDate(today.getDate()-today.getDay());end=today;}
            else if(preset==='lastweek'){end=new Date(today);end.setDate(today.getDate()-today.getDay()-1);start=new Date(end);start.setDate(end.getDate()-6);}
            else if(preset==='month'){start=new Date(today.getFullYear(),today.getMonth(),1);end=today;}
            else if(preset==='lastmonth'){start=new Date(today.getFullYear(),today.getMonth()-1,1);end=new Date(today.getFullYear(),today.getMonth(),0);}
            document.getElementById('repStartDate').value=start.toISOString().split('T')[0];
            document.getElementById('repEndDate').value=end.toISOString().split('T')[0];
        }
        function clearPresets(){document.querySelectorAll('.date-preset-grid .preset-btn').forEach(b=>b.classList.remove('active-preset'));}
        function setSortOption(opt,el){currentSortOption=opt;document.querySelectorAll('#sortOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function setGroupOption(opt,el){currentGroupOption=opt;document.querySelectorAll('#groupOptions .sort-option').forEach(b=>b.classList.remove('active-sort'));el.classList.add('active-sort');}
        function resetReportFilters(){
            ['repStartDate','repEndDate','repMinAmount','repMaxAmount'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('repShop').value='all'; document.getElementById('repItem').value='all'; document.getElementById('repSalesman').value='all';
            const repAreaEl = document.getElementById('repArea'); if(repAreaEl) repAreaEl.value='all';
            clearPresets(); currentSortOption='date-desc'; currentGroupOption='none';
            document.querySelectorAll('#sortOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.querySelectorAll('#groupOptions .sort-option').forEach((b,i)=>b.classList.toggle('active-sort',i===0));
            document.getElementById('reportResultArea').style.display='none';
            toast("Filters reset!","success");
        }

        function generateCustomReport() {
            const sVal=document.getElementById('repStartDate').value, eVal=document.getElementById('repEndDate').value;
            const start=sVal?new Date(sVal).setHours(0,0,0,0):null, end=eVal?new Date(eVal).setHours(23,59,59,999):null;
            const shop=document.getElementById('repShop').value, item=document.getElementById('repItem').value;
            const salesmanFilter=document.getElementById('repSalesman').value;
            const areaFilter = (document.getElementById('repArea')?.value) || 'all';
            const minAmt=parseFloat(document.getElementById('repMinAmount').value)||0;
            const maxAmt=parseFloat(document.getElementById('repMaxAmount').value)||Infinity;
            // Build set of shops in selected area
            const shopsInArea = areaFilter !== 'all' ? new Set(
                Object.entries(globalShops)
                    .filter(([id,d]) => (d.area||'') === areaFilter)
                    .map(([id,d]) => d.name || id)
            ) : null;
            customReportArray=[]; let tAmt=0,tQty=0,orderCount=0; let grouped={};
            historyData.forEach(d => {
                let oTime=d.time?d.time.toDate().getTime():0;
                if(start&&oTime<start) return; if(end&&oTime>end) return;
                if(shop!=='all'&&d.shopName!==shop) return;
                if(salesmanFilter!=='all'&&d.salesman!==salesmanFilter) return;
                if(shopsInArea && !shopsInArea.has(d.shopName)) return;
                let filtered=(item==='all')?d.items:d.items.filter(i=>i.id===item);
                if(!filtered.length) return;
                let rowAmt=filtered.reduce((s,i)=>s+i.total,0);
                if(rowAmt<minAmt||rowAmt>maxAmt) return;
                let rowQty=filtered.reduce((s,i)=>s+i.qty,0);
                tAmt+=rowAmt; tQty+=rowQty; orderCount++;
                let dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
                let itemStr=filtered.map(i=>`${i.id}(${i.qty})`).join(', ');
                customReportArray.push({Date:dateStr,Shop:d.shopName,Items:itemStr,"Amount (₹)":rowAmt,Salesman:d.salesman,_time:oTime});
                let gKey=currentGroupOption==='shop'?d.shopName:currentGroupOption==='salesman'?d.salesman:dateStr;
                grouped[gKey]=(grouped[gKey]||0)+rowAmt;
            });
            customReportArray.sort((a,b)=>{
                if(currentSortOption==='date-desc') return b._time-a._time;
                if(currentSortOption==='date-asc') return a._time-b._time;
                if(currentSortOption==='amount-desc') return b['Amount (₹)']-a['Amount (₹)'];
                return a['Amount (₹)']-b['Amount (₹)'];
            });
            const tbody=document.getElementById('repTableBody'), thead=document.getElementById('repTableHead');
            tbody.innerHTML='';
            if(currentGroupOption!=='none'){
                let groupedRows={};
                customReportArray.forEach(row=>{
                    let gKey=currentGroupOption==='shop'?row.Shop:currentGroupOption==='salesman'?row.Salesman:row.Date;
                    if(!groupedRows[gKey]) groupedRows[gKey]={rows:[],total:0};
                    groupedRows[gKey].rows.push(row); groupedRows[gKey].total+=row['Amount (₹)'];
                });
                let groupLabel=currentGroupOption==='shop'?'🏪 Shop':currentGroupOption==='salesman'?'👤 Salesman':'📅 Date';
                thead.innerHTML=`<tr><th>${groupLabel}</th><th>Orders</th><th>Total (₹)</th><th>% of Total</th></tr>`;
                Object.entries(groupedRows).forEach(([key,data])=>{
                    let pct=tAmt>0?((data.total/tAmt)*100).toFixed(1):'0.0';
                    tbody.innerHTML+=`<tr><td><b>${key}</b></td><td>${data.rows.length}</td><td style="color:var(--success);font-weight:700;">₹${data.total.toFixed(2)}</td><td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;">${pct}%</span></td></tr>`;
                });
            } else {
                thead.innerHTML=`<tr><th>Date</th><th>Shop</th><th>Items</th><th>Amount (₹)</th><th>Salesman</th></tr>`;
                customReportArray.forEach(row=>{tbody.innerHTML+=`<tr><td>${row.Date}</td><td>${row.Shop}</td><td style="max-width:200px;white-space:normal;">${row.Items}</td><td style="color:var(--success);font-weight:700;">₹${row['Amount (₹)'].toFixed(2)}</td><td>${row.Salesman}</td></tr>`;});
            }
            document.getElementById('repTotalAmount').innerText=`₹ ${tAmt.toFixed(2)}`;
            document.getElementById('repTotalQty').innerText=tQty;
            document.getElementById('repOrderCount').innerText=orderCount;
            document.getElementById('repAvgOrder').innerText=orderCount>0?`₹ ${(tAmt/orderCount).toFixed(2)}`:'₹ 0.00';
            document.getElementById('repDataCount').innerText=`(${orderCount} records)`;
            if(customReportArray.length>0){
                document.getElementById('reportResultArea').style.display='block';
                document.getElementById('reportChartWrapper').style.display='block';
                document.getElementById('reportChartCard').style.display='block';
                updateReportChart(grouped);
            } else { toast("No data found!","error"); document.getElementById('reportResultArea').style.display='none'; }
        }

        // ===== PAYMENT REPORT =====
        function generatePaymentReport() {
            const shopFilter = document.getElementById('payRepShopSel').value;
            const startVal = document.getElementById('payRepStart').value;
            const endVal = document.getElementById('payRepEnd').value;
            const startMs = startVal ? new Date(startVal).setHours(0,0,0,0) : 0;
            const endMs = endVal ? new Date(endVal).setHours(23,59,59,999) : Infinity;
            paymentReportArray = [];
            let totalBillFiltered = 0, totalPaidFiltered = 0;
            Object.entries(allDueData).forEach(([shopName, entries]) => {
                if (shopFilter !== 'all' && shopName !== shopFilter) return;
                entries.forEach(e => {
                    const eMs = e.time ? e.time.toDate().getTime() : 0;
                    if (eMs < startMs || eMs > endMs) return;
                    const dateStr = e.time ? e.time.toDate().toLocaleDateString('en-GB') : '—';
                    paymentReportArray.push({
                        Date: dateStr,
                        Shop: shopName,
                        "Amount Paid (₹)": e.payment || 0,
                        Note: e.note || '—',
                        Salesman: e.salesman || '—',
                        _time: eMs
                    });
                    totalPaidFiltered += (e.payment || 0);
                });
            });
            historyData.forEach(d => {
                if (shopFilter !== 'all' && d.shopName !== shopFilter) return;
                totalBillFiltered += d.total;
            });
            paymentReportArray.sort((a,b) => b._time - a._time);
            const tbody = document.getElementById('payRepTableBody');
            tbody.innerHTML = '';
            paymentReportArray.forEach(row => {
                tbody.innerHTML += `<tr>
                    <td>${row.Date}</td>
                    <td><b>${row.Shop}</b></td>
                    <td style="color:var(--success);font-weight:700;">₹${(row['Amount Paid (₹)']).toFixed(2)}</td>
                    <td style="color:#64748b;">${row.Note}</td>
                    <td>${row.Salesman}</td>
                </tr>`;
            });
            const remaining = totalBillFiltered - totalPaidFiltered;
            document.getElementById('payRepTotalBill').innerText = `₹ ${totalBillFiltered.toFixed(2)}`;
            document.getElementById('payRepTotalPaid').innerText = `₹ ${totalPaidFiltered.toFixed(2)}`;
            document.getElementById('payRepRemaining').innerText = `₹ ${Math.max(0, remaining).toFixed(2)}`;
            document.getElementById('payRepCount').innerText = `(${paymentReportArray.length} payments)`;
            if (paymentReportArray.length > 0) {
                document.getElementById('payRepResultArea').style.display = 'block';
            } else {
                document.getElementById('payRepResultArea').style.display = 'none';
                toast("No payment records found!", "error");
            }
        }

        // ===== EXCEL IMPORT =====
        function getExcelVal(row,keys){
            for(let k of keys) if(row[k]!==undefined&&row[k]!==null&&row[k]!=="") return row[k];
            const rowKeys=Object.keys(row);
            for(let k of keys){const match=rowKeys.find(rk=>rk.trim().toLowerCase()===k.trim().toLowerCase());if(match&&row[match]!==undefined&&row[match]!==null&&row[match]!=="") return row[match];}
            return null;
        }
        async function handleExcelImport(event) {
            const file=event.target.files[0]; if(!file) return;
            const reader=new FileReader();
            reader.onload=async function(e){
                try{
                    const data=new Uint8Array(e.target.result);
                    const workbook=XLSX.read(data,{type:'array'});
                    const json=XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(!json.length) return toast("Excel file is empty!","error");
                    let successCount=0,errorCount=0;
                    for(let row of json){
                        let pName=getExcelVal(row,['Product','product','Product Name','Item','item']);
                        let qty=parseInt(getExcelVal(row,['Qty','Added Qty','Quantity','qty']));
                        let price=parseFloat(getExcelVal(row,['Price','price','Base Price','Selling Price']));
                        let costPrice=parseFloat(getExcelVal(row,['Cost Price','cost price','CostPrice','Buy Price','Purchase Price'])||0);
                        let dealer=getExcelVal(row,['Dealer','Dealer info','dealer'])||'';
                        let discount=parseFloat(getExcelVal(row,['Discount','discount','Disc'])||0);
                        if(!pName||isNaN(qty)||qty<=0){errorCount++;continue;}
                        let safeName=pName.toString().trim().replace(/\//g,'-');
                        const ref=db.collection("products").doc(safeName);
                        const doc=await ref.get();
                        let finalS=doc.exists?(doc.data().stock||0)+qty:qty;
                        let finalP=isNaN(price)?(doc.exists?doc.data().price||0:0):price;
                        let finalCP=(!isNaN(costPrice)&&costPrice>0)?costPrice:(doc.exists?doc.data().costPrice||0:0);
                        let finalD=isNaN(discount)?(doc.exists?doc.data().discount||0:0):discount;
                        await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
                        await db.collection("purchases").add({item:safeName,addedStock:qty,price:finalP,costPrice:finalCP,dealer:dealer.toString(),time:firebase.firestore.FieldValue.serverTimestamp()});
                        successCount++;
                    }
                    if(successCount>0) toast(`Import done! ${successCount} items. (Errors: ${errorCount})`,"success");
                    else toast("Failed to import. Check headers.","error");
                }catch(err){toast("Error parsing Excel.","error");}
                event.target.value="";
            };
            reader.readAsArrayBuffer(file);
        }

        // ===== CART =====
        function togglePriceMode() {
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            document.getElementById('manualPriceContainer').style.display=mode==='manual'?'block':'none';
            if(mode!=='manual') document.getElementById('manualPriceInput').value="";
            const dc=document.getElementById('itemDiscContainer');
            if(dc) dc.style.display=mode==='auto'?'block':'none';
        }
        function updateDiscPreview() {
            const pId=document.getElementById('orderItemInput').value;
            if(!productsMap[pId]) return;
            const base=productsMap[pId].price;
            const disc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
            document.getElementById('discPricePreview').innerText=disc>0?`→ ₹${(base-(base*disc/100)).toFixed(2)}`:'';
        }
        function showPriceInfo() {
            const val=document.getElementById('orderItemInput').value;
            const box=document.getElementById('priceHighlightBox');
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            const dc=document.getElementById('itemDiscContainer');
            if(productsMap[val]){
                const p=productsMap[val];
                const disc=p.price-(p.price*(p.discount/100));
                box.innerHTML=p.discount>0?`🛒 Stock: <b>${p.stock}</b> &nbsp;|&nbsp; ✨ Price: <b>₹${p.price.toFixed(2)}</b><br><small style="color:var(--danger);">💡 Default ${p.discount}% disc = ₹${disc.toFixed(2)}</small>`:`🛒 Stock: <b>${p.stock}</b> &nbsp;|&nbsp; ✨ Price: <b>₹${p.price.toFixed(2)}</b>`;
                box.style.display='block';
                if(dc&&mode==='auto'){dc.style.display='block';updateDiscPreview();}
            } else { box.style.display='none'; if(dc) dc.style.display='none'; }
        }
        function addToCart() {
            const pId=document.getElementById('orderItemInput').value;
            const qty=parseInt(document.getElementById('orderQty').value);
            if(!pId||!qty||qty<=0) return toast("Invalid Qty or Item not found","error");
            if(!productsMap[pId]) return toast("Please select a valid item from the list","error");
            const pData=productsMap[pId];
            let finalUnitPrice=0;
            const mode=document.querySelector('input[name="priceMode"]:checked').value;
            if(mode==='manual'){
                const mPrice=parseFloat(document.getElementById('manualPriceInput').value);
                if(isNaN(mPrice)||mPrice<0) return toast("Please enter a valid manual price","error");
                finalUnitPrice=mPrice;
            } else {
                const extraDisc=parseFloat(document.getElementById('itemDiscInput')?.value)||0;
                finalUnitPrice=pData.price-(pData.price*extraDisc/100);
            }
            const existing=cart.find(i=>i.id===pId);
            const totalQty=(existing?existing.qty:0)+qty;
            if(totalQty>pData.stock) return toast("Stock Limit! Only "+pData.stock+" left.","error");
            if(existing){existing.qty+=qty;existing.price=finalUnitPrice;existing.total=existing.qty*finalUnitPrice;}
            else cart.push({id:pId,qty,price:finalUnitPrice,total:qty*finalUnitPrice});
            renderCart();
            document.getElementById('orderItemInput').value="";
            document.getElementById('orderQty').value="";
            if(mode==='manual') document.getElementById('manualPriceInput').value="";
            if(document.getElementById('itemDiscInput')) document.getElementById('itemDiscInput').value="";
            if(document.getElementById('discPricePreview')) document.getElementById('discPricePreview').innerText="";
            if(document.getElementById('itemDiscContainer')) document.getElementById('itemDiscContainer').style.display='none';
            showPriceInfo();
        }
        function undoCart(){if(cart.length>0){cart.pop();renderCart();}}
        function renderCart() {
            const list=document.getElementById('cartList');
            list.innerHTML=""; let grand=0;
            cart.forEach((item,i)=>{
                grand+=item.total;
                list.innerHTML+=`<div class="flex-between" style="font-size:14px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);">
                    <span><b>${item.id}</b> <span style="color:#64748b;">(x${item.qty}) @ ₹${item.price.toFixed(2)}</span></span>
                    <span style="font-weight:700;">₹${item.total.toFixed(2)} <span onclick="cart.splice(${i},1);renderCart();" style="color:#f43f5e;cursor:pointer;margin-left:8px;">✖</span></span>
                </div>`;
            });
            document.getElementById('cartTotal').innerText="₹ "+grand.toFixed(2);
            document.getElementById('cartCard').style.display=cart.length?'block':'none';
        }
        async function placeFinalOrder() {
            const shop=document.getElementById('orderShop').value;
            if(!shop||!cart.length) return toast("Empty Shop/Cart","error");
            const btn = document.getElementById('btnPlace');
            btn.innerText="Processing..."; btn.disabled=true;
            const orderObj = {
                shopName: shop, items: [...cart],
                total: cart.reduce((s,i)=>s+i.total,0),
                salesman: userData.name,
                localTime: new Date().toISOString()
            };
            // ---- OFFLINE: queue and show WA modal ----
            if (!isOnline) {
                const q = getOfflineQueue();
                q.push(orderObj);
                saveOfflineQueue(q);
                updateOfflineBadge();
                toast("📵 Saved offline — will sync when online", "success");
                cart=[]; renderCart();
                btn.innerText="Place Final Order"; btn.disabled=false;
                openWAModal(orderObj);
                return;
            }
            // ---- ONLINE: normal flow ----
            try {
                for(let i of cart){
                    const ref=db.collection("products").doc(i.id);
                    await db.runTransaction(async t=>{const doc=await t.get(ref);t.update(ref,{stock:doc.data().stock-i.qty});});
                }
                await db.collection("orders").add({
                    shopName:orderObj.shopName, items:orderObj.items,
                    total:orderObj.total, salesman:orderObj.salesman,
                    time:firebase.firestore.FieldValue.serverTimestamp(),
                    deliveryStatus: 'pending'
                });
                cart=[]; renderCart();
                btn.innerText="Place Final Order"; btn.disabled=false;
                openWAModal(orderObj);
            } catch(e) {
                toast(e.message,"error");
                btn.innerText="Place Final Order"; btn.disabled=false;
            }
        }
        async function deleteOrder(idx) {
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                // Save snapshot for undo
                const orderSnap = JSON.parse(JSON.stringify(d));
                for(let item of d.items){const ref=db.collection("products").doc(item.id);await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:pDoc.data().stock+item.qty});});}
                await db.collection("orders").doc(d.orderId).delete();
                toast("🗑️ Order deleted — stock returned","success");
                pushUndo("Order deleted", async () => {
                    // Re-add order and deduct stock
                    const newRef = await db.collection("orders").add({
                        shopName: orderSnap.shopName, items: orderSnap.items,
                        total: orderSnap.total, salesman: orderSnap.salesman,
                        time: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    for(let item of orderSnap.items){
                        const ref=db.collection("products").doc(item.id);
                        await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:Math.max(0,pDoc.data().stock-item.qty)});});
                    }
                });
            }catch(e){toast("Error: "+e.message,"error");}
        }
        async function editOrder(idx) {
            if(!confirm("Edit: This will move items back to cart and delete the order. Proceed?")) return;
            let d=historyData[idx]; if(!d||!d.orderId) return;
            try{
                for(let item of d.items){const ref=db.collection("products").doc(item.id);await db.runTransaction(async tr=>{const pDoc=await tr.get(ref);if(pDoc.exists) tr.update(ref,{stock:pDoc.data().stock+item.qty});});}
                await db.collection("orders").doc(d.orderId).delete();
                cart=[...d.items];
                const sel=document.getElementById('orderShop');
                for(let i=0;i<sel.options.length;i++){if(sel.options[i].value===d.shopName){sel.selectedIndex=i;break;}}
                renderCart(); switchView('order');
                toast("Order moved to cart!","success");
            }catch(e){toast("Error: "+e.message,"error");}
        }

        // ===== MANAGER CRUD =====
        async function addShop() {
            const n=document.getElementById('shopName').value.trim();
            if(!n) return toast("Shop name required","error");
            const createdBy = document.getElementById('shopCreatedBy').value || '';
            const area = document.getElementById('shopArea').value.trim();
            await db.collection("shops").doc(n.replace(/\//g,'-')).set({
                name: n.replace(/\//g,'-'),
                phone: document.getElementById('shopPhone').value,
                addr: document.getElementById('shopAddr').value,
                area: area,
                createdBy: createdBy,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            },{merge:true});
            toast("Shop Saved!","success");
            document.getElementById('shopName').value="";
            document.getElementById('shopPhone').value="";
            document.getElementById('shopAddr').value="";
            document.getElementById('shopArea').value="";
            document.getElementById('shopCreatedBy').value="";
        }
        async function addProduct() {
            let n=document.getElementById('prodName').value.trim();
            const s=parseInt(document.getElementById('prodStock').value);
            const p=parseFloat(document.getElementById('prodPrice').value);
            const cp=parseFloat(document.getElementById('prodCostPrice').value);
            if(!n||isNaN(s)) return toast("Name and valid stock required","error");
            if(n.includes('/')) n=n.replace(/\//g,'-');
            const ref=db.collection("products").doc(n);
            const doc=await ref.get();
            let finalS=doc.exists?doc.data().stock+s:s;
            let finalP=isNaN(p)?(doc.exists?doc.data().price:0):p;
            let finalCP=isNaN(cp)?(doc.exists?doc.data().costPrice||0:0):cp;
            let finalD=doc.exists?(doc.data().discount||0):0;
            await ref.set({stock:finalS,price:finalP,costPrice:finalCP,discount:finalD},{merge:true});
            if(s>0) await db.collection("purchases").add({item:n,addedStock:s,price:finalP,costPrice:finalCP,dealer:document.getElementById('purchaseInfo').value,time:firebase.firestore.FieldValue.serverTimestamp()});
            toast("Stock Updated!","success");
            document.getElementById('prodName').value=""; document.getElementById('prodStock').value=""; document.getElementById('prodPrice').value=""; document.getElementById('prodCostPrice').value=""; document.getElementById('purchaseInfo').value="";
        }
        async function editProduct(id, oldStock, oldPrice, oldDisc, oldCostPrice) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nStock=prompt(`Edit Stock for "${id}":`,oldStock); if(nStock===null) return;
            let nPrice=prompt(`Edit Selling Price for "${id}" (₹):`,oldPrice); if(nPrice===null) return;
            let nCostPrice=prompt(`Edit Purchase/Cost Price for "${id}" (₹):`,oldCostPrice); if(nCostPrice===null) return;
            let nDisc=prompt(`Edit Discount % for "${id}":`,oldDisc); if(nDisc===null) return;
            try{
                await db.collection("products").doc(id).update({
                    stock:parseInt(nStock),
                    price:parseFloat(nPrice),
                    costPrice:parseFloat(nCostPrice)||0,
                    discount:parseFloat(nDisc)||0
                });
                toast("Product updated!","success");
            }catch(e){toast(e.message,"error");}
        }
        async function editPurchase(docId,item,oldQty,oldPrice,oldCostPrice,oldDealer) {
            if (userData.role !== 'manager') return toast('Access denied', 'error');
            let nQty=prompt(`Edit Qty for ${item}:`,oldQty); if(nQty===null) return;
            let nPrice=prompt(`Edit Selling Price (₹):`,oldPrice); if(nPrice===null) return;
            let nCP=prompt(`Edit Cost Price (₹):`,oldCostPrice); if(nCP===null) return;
            let nDealer=prompt(`Edit Dealer:`,oldDealer); if(nDealer===null) return;
            try{await db.collection("purchases").doc(docId).update({addedStock:parseInt(nQty),price:parseFloat(nPrice),costPrice:parseFloat(nCP)||0,dealer:nDealer});toast("Updated!","success");}catch(e){toast(e.message,"error");}
        }
        async function deleteProduct(id) {
            try{
                const snap = await db.collection("products").doc(id).get();
                if(!snap.exists) return toast("Product not found","error");
                const data = snap.data();
                await db.collection("products").doc(id).delete();
                toast("🗑️ Product deleted","success");
                pushUndo(`"${id}" deleted`, async () => {
                    await db.collection("products").doc(id).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deletePurchaseRecord(id) {
            try{
                const purchDoc=await db.collection("purchases").doc(id).get();
                if(!purchDoc.exists) return toast("Record not found","error");
                const pData=purchDoc.data();
                const itemName=pData.item, addedQty=pData.addedStock||0;
                if(itemName&&addedQty>0){
                    const prodRef=db.collection("products").doc(itemName);
                    await db.runTransaction(async t=>{
                        const prodDoc=await t.get(prodRef);
                        if(prodDoc.exists) t.update(prodRef,{stock:Math.max(0,(prodDoc.data().stock||0)-addedQty)});
                    });
                }
                await db.collection("purchases").doc(id).delete();
                toast(`🗑️ Purchase record deleted — stock reduced by ${addedQty}`,"success");
                pushUndo("Purchase record deleted", async () => {
                    await db.collection("purchases").doc(id).set(pData);
                    if(itemName && addedQty>0){
                        const prodRef=db.collection("products").doc(itemName);
                        await db.runTransaction(async t=>{
                            const prodDoc=await t.get(prodRef);
                            if(prodDoc.exists) t.update(prodRef,{stock:(prodDoc.data().stock||0)+addedQty});
                        });
                    }
                });
            }catch(e){toast(e.message,"error");}
        }
        async function deleteShop() {
            const shopId=document.getElementById('delShopSelect').value;
            if(!shopId) return toast("Select a shop","error");
            try{
                const snap = await db.collection("shops").doc(shopId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("shops").doc(shopId).delete();
                toast("🗑️ Shop deleted","success");
                document.getElementById('delShopSelect').value="";
                pushUndo(`Shop "${shopId}" deleted`, async () => {
                    if(data) await db.collection("shops").doc(shopId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }
        // ===== SHOP LIST (MANAGER PANEL) =====
        let allShopsArray = [];

        function renderShopList() {
            const search = (document.getElementById('shopListSearch')?.value || '').toLowerCase();
            const container = document.getElementById('shopListContainer');
            if (!container) return;

            const filtered = allShopsArray.filter(s =>
                s.name.toLowerCase().includes(search) ||
                (s.phone || '').includes(search) ||
                (s.addr || '').toLowerCase().includes(search) ||
                (s.area || '').toLowerCase().includes(search) ||
                (s.createdBy || '').toLowerCase().includes(search)
            );

            if (!filtered.length) {
                container.innerHTML = `<div style="text-align:center; color:#64748b; font-size:13px; padding:16px;">No shops found.</div>`;
                return;
            }

            container.innerHTML = filtered.map((s, idx) => {
                const creator = s.createdBy || '';
                const phone = s.phone || '';
                const addr = s.addr || '';
                const area = s.area || '';
                // encode for data attribute
                const encoded = encodeURIComponent(JSON.stringify({id:s.id, name:s.name, phone, addr, area, createdBy:creator}));
                return `
                <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:16px; padding:14px 16px; margin-bottom:10px; transition:box-shadow 0.2s;" onmouseover="this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.boxShadow='none'">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:800; font-size:15px; color:var(--text); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
                                <span style="background:var(--primary-light); color:var(--primary); border-radius:8px; padding:2px 7px; font-size:11px; font-weight:700;">#${idx+1}</span>
                                🏪 ${s.name}
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">
                                ${phone ? `<span style="background:rgba(16,185,129,0.1); color:#065f46; border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">📞 ${phone}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">📞 No phone</span>`}
                                ${area ? `<span style="background:rgba(245,158,11,0.1); color:#b45309; border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">🗺️ ${area}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">🗺️ No area</span>`}
                                ${creator ? `<span style="background:rgba(99,102,241,0.1); color:var(--primary); border-radius:8px; padding:3px 9px; font-size:11px; font-weight:600;">👤 ${creator}</span>` : `<span style="background:var(--bg); color:#94a3b8; border-radius:8px; padding:3px 9px; font-size:11px; border:1px dashed var(--border);">👤 No maker</span>`}
                            </div>
                            ${addr ? `<div style="font-size:11px; color:#64748b; margin-top:6px; display:flex; align-items:flex-start; gap:4px;"><span>📍</span><span>${addr}</span></div>` : `<div style="font-size:11px; color:#94a3b8; margin-top:6px;">📍 No address</div>`}
                        </div>
                        <button onclick='openEditShopFull(${JSON.stringify({id:s.id, name:s.name, phone:phone, addr:addr, area:area, createdBy:creator})})'
                            style="background:linear-gradient(135deg,var(--primary),#6366f1); color:white; border:none; border-radius:10px; padding:8px 14px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; flex-shrink:0; box-shadow:0 4px 12px rgba(79,70,229,0.3); transition:transform 0.15s, box-shadow 0.15s;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 18px rgba(79,70,229,0.4)'"
                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(79,70,229,0.3)'">
                            ✏️ Edit
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateShopListFromGlobal() {
            allShopsArray = Object.entries(globalShops).map(([id, d]) => ({
                id, name: d.name || id, phone: d.phone || '', addr: d.addr || '', area: d.area || '', createdBy: d.createdBy || ''
            })).sort((a, b) => a.name.localeCompare(b.name));

            const badge = document.getElementById('shopListCountBadge');
            if (badge) badge.textContent = allShopsArray.length;

            // Populate datalist for edit modal
            const dl = document.getElementById('editShopMakerList');
            if (dl) {
                const salesmen = [...new Set(allShopsArray.map(s => s.createdBy).filter(Boolean))];
                // also add users from globalShops createdBy
                dl.innerHTML = salesmen.map(n => `<option value="${n}">`).join('');
            }

            renderShopList();
        }

        function openEditShopFull(shopObj) {
            document.getElementById('editShopMakerShopId').value = shopObj.id;
            document.getElementById('editShopOrigName').textContent = `ID: ${shopObj.id}`;
            document.getElementById('editShopNameInput').value = shopObj.name || '';
            document.getElementById('editShopPhoneInput').value = shopObj.phone || '';
            document.getElementById('editShopAddrInput').value = shopObj.addr || '';
            document.getElementById('editShopMakerInput').value = shopObj.createdBy || '';

            // Populate area select from globalAreas
            const areaEl = document.getElementById('editShopAreaInput');
            if (areaEl) {
                const curArea = shopObj.area || '';
                areaEl.innerHTML = '<option value="">-- Select Area --</option>';
                globalAreas.forEach(a => {
                    areaEl.innerHTML += `<option value="${a.name}"${a.name === curArea ? ' selected' : ''}>${a.name}</option>`;
                });
                areaEl.value = curArea;
            }

            const modal = document.getElementById('editShopMakerModal');
            modal.style.display = 'flex';
            // Populate datalist with salesman names
            if (window.db) {
                db.collection('users').get().then(snap => {
                    const names = snap.docs.map(d => d.data().name || d.id).filter(Boolean);
                    const dl = document.getElementById('editShopMakerList');
                    if (dl) dl.innerHTML = names.map(n => `<option value="${n}">`).join('');
                });
            }
        }

        // keep old name as alias for any residual calls
        function openEditShopMaker(shopId, shopName, currentMaker) {
            openEditShopFull({ id: shopId, name: shopName, phone: '', addr: '', createdBy: currentMaker === '—' ? '' : currentMaker });
        }

        function closeEditShopMaker() {
            document.getElementById('editShopMakerModal').style.display = 'none';
        }

        async function saveShopFull() {
            const shopId = document.getElementById('editShopMakerShopId').value;
            const newName = document.getElementById('editShopNameInput').value.trim();
            const newPhone = document.getElementById('editShopPhoneInput').value.trim();
            const newAddr = document.getElementById('editShopAddrInput').value.trim();
            const newArea = document.getElementById('editShopAreaInput').value.trim();
            const newMaker = document.getElementById('editShopMakerInput').value.trim();

            if (!shopId) return toast('Shop ID missing', 'error');
            if (!newName) return toast('Shop name is required', 'error');

            try {
                const updateData = {
                    name: newName,
                    phone: newPhone,
                    addr: newAddr,
                    area: newArea,
                    createdBy: newMaker
                };

                // If name changed and it's used as doc ID, we need special handling
                if (newName !== shopId) {
                    // Just update fields; doc ID stays same
                    await db.collection('shops').doc(shopId).update(updateData);
                } else {
                    await db.collection('shops').doc(shopId).update(updateData);
                }

                toast('✅ Shop updated successfully!', 'success');
                closeEditShopMaker();
            } catch (e) {
                toast(e.message, 'error');
            }
        }

        // keep old save as alias
        async function saveShopMaker() { await saveShopFull(); }

        // ===== DELIVERY CONFIRMATION SYSTEM =====
        let dcCurrentIdx = -1;

        function openDeliveryConfirm(idx) {
            const d = historyData[idx];
            if (!d) return;
            dcCurrentIdx = idx;

            // Shop & order info
            const timeS = d.time ? d.time.toDate().toLocaleString() : '';
            document.getElementById('dcShopInfo').innerHTML =
                `🏪 <b>${d.shopName}</b> &nbsp;·&nbsp; 📅 ${timeS} &nbsp;·&nbsp; 👤 ${d.salesman}`;

            // Ordered total
            document.getElementById('dcOrderedTotal').textContent = '₹ ' + d.total.toFixed(2);

            // Build item rows
            const container = document.getElementById('dcItemsContainer');
            container.innerHTML = d.items.map((item, i) => {
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                return `
                <div style="background:var(--bg); border:1.5px solid var(--border); border-radius:14px; padding:12px 14px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="font-weight:700; font-size:13px; color:var(--text); flex:1;">${item.id}</div>
                        <div style="font-size:11px; color:#64748b;">₹${unitPrice.toFixed(2)}/unit</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:11px; color:#94a3b8; min-width:80px;">
                            Ordered: <b style="color:var(--text);">${item.qty}</b>
                        </div>
                        <div style="flex:1; display:flex; align-items:center; gap:6px;">
                            <label style="font-size:11px; font-weight:700; color:#64748b; white-space:nowrap;">Actual:</label>
                            <input type="number" id="dcQty_${i}" value="${item.qty}" min="0" max="${item.qty * 5}"
                                class="input-field"
                                style="margin:0; text-align:center; font-weight:800; font-size:15px; color:var(--success); padding:8px; border-color:rgba(16,185,129,0.4);"
                                oninput="dcUpdateTotal()">
                        </div>
                        <div id="dcItemTotal_${i}" style="font-size:13px; font-weight:700; color:var(--primary); min-width:70px; text-align:right;">
                            ₹${item.total.toFixed(2)}
                        </div>
                    </div>
                </div>`;
            }).join('');

            dcUpdateTotal();
            document.getElementById('deliveryConfirmModal').style.display = 'flex';
        }

        function dcUpdateTotal() {
            const d = historyData[dcCurrentIdx];
            if (!d) return;
            let deliveredTotal = 0;
            d.items.forEach((item, i) => {
                const inp = document.getElementById(`dcQty_${i}`);
                if (!inp) return;
                const actualQty = Math.max(0, parseFloat(inp.value) || 0);
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                const lineTotal = actualQty * unitPrice;
                deliveredTotal += lineTotal;
                const el = document.getElementById(`dcItemTotal_${i}`);
                if (el) el.textContent = '₹' + lineTotal.toFixed(2);
            });
            document.getElementById('dcDeliveredTotal').textContent = '₹ ' + deliveredTotal.toFixed(2);
        }

        async function confirmDelivery() {
            const d = historyData[dcCurrentIdx];
            if (!d || !d.orderId) return toast('Order not found', 'error');

            const deliveredItems = d.items.map((item, i) => {
                const inp = document.getElementById(`dcQty_${i}`);
                const actualQty = Math.max(0, parseFloat(inp?.value) || 0);
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                return {
                    ...item,
                    orderedQty: item.qty,
                    qty: actualQty,
                    total: parseFloat((actualQty * unitPrice).toFixed(2)),
                    price: unitPrice
                };
            });

            const deliveredTotal = deliveredItems.reduce((s, it) => s + it.total, 0);

            // Stock adjustment: return the difference for items not fully taken
            try {
                for (const item of deliveredItems) {
                    const diff = item.orderedQty - item.qty; // qty NOT delivered = return to stock
                    if (diff > 0) {
                        const ref = db.collection('products').doc(item.id);
                        await db.runTransaction(async t => {
                            const doc = await t.get(ref);
                            if (doc.exists) t.update(ref, { stock: (doc.data().stock || 0) + diff });
                        });
                    }
                }

                await db.collection('orders').doc(d.orderId).update({
                    items: deliveredItems,
                    total: parseFloat(deliveredTotal.toFixed(2)),
                    deliveryStatus: 'delivered',
                    deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    orderedTotal: d.total
                });

                toast('✅ Delivery confirmed!', 'success');
                closeDeliveryConfirm();
            } catch (e) {
                toast(e.message, 'error');
            }
        }

        function closeDeliveryConfirm() {
            document.getElementById('deliveryConfirmModal').style.display = 'none';
            dcCurrentIdx = -1;
        }

        // ===== ATTENDANCE SYSTEM =====
        let attCurrentDate = '';
        let attSalesmenList = [];
        let attCurrentData = {};   // { uid: status }
        let attBarChart, attPieChart, attLineChart;
        let attExportArray = [];

        function todayISO() {
            const d = new Date();
            return d.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        function initAttendanceView() {
            // Set today's date in picker
            const picker = document.getElementById('attDatePicker');
            if (!picker.value) picker.value = todayISO();
            updateAttDateLabel(picker.value);
            loadSalesmenForAtt();
            loadAttendanceForDate();
            populateAttSalesmanFilter();
            setAttReportDefaultDates();
        }

        function updateAttDateLabel(dateStr) {
            attCurrentDate = dateStr;
            const d = new Date(dateStr + 'T00:00:00');
            const label = d.toLocaleDateString('en-IN', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
            const el = document.getElementById('attDateLabel');
            if (el) el.textContent = '📅 ' + label;
        }

        function loadSalesmenForAtt() {
            db.collection('users').get().then(snap => {
                attSalesmenList = snap.docs
                    .map(d => ({ uid: d.id, name: d.data().name || d.id, role: d.data().role || 'salesman' }))
                    .filter(u => u.role !== 'manager')
                    .sort((a,b) => a.name.localeCompare(b.name));
                renderAttGrid();
                populateAttSalesmanFilter();
            });
        }

        function renderAttGrid() {
            const grid = document.getElementById('attSalesmanGrid');
            if (!grid) return;
            if (!attSalesmenList.length) {
                grid.innerHTML = `<div style="text-align:center;color:#64748b;font-size:13px;padding:16px;">No salesmen found.</div>`;
                return;
            }
            grid.innerHTML = attSalesmenList.map(u => {
                const initials = u.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
                const cur = attCurrentData[u.uid] || 'present';
                return `
                <div class="att-salesman-row" id="attRow_${u.uid}">
                    <div class="att-avatar">${initials}</div>
                    <div style="flex:1; min-width:0;">
                        <div class="att-name">${u.name}</div>
                        <div class="att-status-btns" style="margin-top:6px;">
                            <button class="att-status-btn ${cur==='present'?'selected-present':''}" onclick="setAttStatus('${u.uid}','present',this)">✅ Present</button>
                            <button class="att-status-btn ${cur==='absent'?'selected-absent':''}"  onclick="setAttStatus('${u.uid}','absent',this)">❌ Absent</button>
                            <button class="att-status-btn ${cur==='halfday'?'selected-halfday':''}" onclick="setAttStatus('${u.uid}','halfday',this)">🌗 Half Day</button>
                            <button class="att-status-btn ${cur==='leave'?'selected-leave':''}"   onclick="setAttStatus('${u.uid}','leave',this)">🏖️ Leave</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function setAttStatus(uid, status, btn) {
            attCurrentData[uid] = status;
            // Update button styles in this row
            const row = document.getElementById('attRow_' + uid);
            if (!row) return;
            row.querySelectorAll('.att-status-btn').forEach(b => {
                b.classList.remove('selected-present','selected-absent','selected-halfday','selected-leave');
            });
            btn.classList.add('selected-' + status);
        }

        function attMarkAll(status) {
            attSalesmenList.forEach(u => {
                attCurrentData[u.uid] = status;
            });
            renderAttGrid();
        }

        async function loadAttendanceForDate() {
            const dateStr = document.getElementById('attDatePicker').value;
            if (!dateStr) return;
            updateAttDateLabel(dateStr);
            attCurrentData = {};
            try {
                const snap = await db.collection('attendance').doc(dateStr).get();
                if (snap.exists) {
                    const data = snap.data().records || {};
                    attCurrentData = data;
                    const badge = document.getElementById('attTodayBadge');
                    if (badge) badge.textContent = '✅ Saved';
                } else {
                    // Default all present
                    attSalesmenList.forEach(u => { attCurrentData[u.uid] = 'present'; });
                    const badge = document.getElementById('attTodayBadge');
                    if (badge) badge.textContent = '';
                }
                renderAttGrid();
            } catch(e) {
                attSalesmenList.forEach(u => { attCurrentData[u.uid] = 'present'; });
                renderAttGrid();
            }
        }

        async function saveAttendance() {
            const dateStr = document.getElementById('attDatePicker').value;
            if (!dateStr) return toast('Select a date first', 'error');
            if (!attSalesmenList.length) return toast('No salesmen found', 'error');
            const records = {};
            attSalesmenList.forEach(u => {
                records[u.uid] = attCurrentData[u.uid] || 'present';
            });
            try {
                await db.collection('attendance').doc(dateStr).set({
                    date: dateStr,
                    records,
                    savedBy: userData.name,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const badge = document.getElementById('attTodayBadge');
                if (badge) badge.textContent = '✅ Saved';
                toast('✅ Attendance saved for ' + dateStr, 'success');
            } catch(e) { toast(e.message, 'error'); }
        }

        function populateAttSalesmanFilter() {
            const sel = document.getElementById('attRepSalesman');
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="all">All Salesmen</option>';
            attSalesmenList.forEach(u => {
                sel.innerHTML += `<option value="${u.uid}">${u.name}</option>`;
            });
            if (cur) sel.value = cur;
        }

        function setAttReportDefaultDates() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('attRepStart').value = firstDay.toISOString().split('T')[0];
            document.getElementById('attRepEnd').value   = now.toISOString().split('T')[0];
        }

        function attReportPreset(period, btn) {
            document.querySelectorAll('#att-report .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const now = new Date();
            let start, end = now.toISOString().split('T')[0];
            if (period === 'week') {
                const day = now.getDay() || 7;
                start = new Date(now); start.setDate(now.getDate() - day + 1);
                start = start.toISOString().split('T')[0];
            } else if (period === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            } else if (period === 'lastmonth') {
                start = new Date(now.getFullYear(), now.getMonth()-1, 1).toISOString().split('T')[0];
                end   = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
            } else {
                start = '2020-01-01';
            }
            document.getElementById('attRepStart').value = start;
            document.getElementById('attRepEnd').value   = end;
        }

        function clearAttPresets() {
            document.querySelectorAll('#att-report .preset-btn').forEach(b=>b.classList.remove('active-preset'));
        }

        async function generateAttReport() {
            const startStr = document.getElementById('attRepStart').value;
            const endStr   = document.getElementById('attRepEnd').value;
            const selSm    = document.getElementById('attRepSalesman').value;
            if (!startStr || !endStr) return toast('Select date range', 'error');

            toast('Generating report...', 'success');

            try {
                const snap = await db.collection('attendance')
                    .where('date', '>=', startStr)
                    .where('date', '<=', endStr)
                    .orderBy('date', 'asc')
                    .get();

                if (snap.empty) { toast('No attendance data found for this period', 'error'); return; }

                // Build date list
                const dates = snap.docs.map(d => d.data().date);
                const totalDays = dates.length;

                // Aggregate per salesman
                const smMap = {}; // { uid: { name, present, absent, halfday, leave } }
                const dailyPresent = {}; // { date: count }

                snap.docs.forEach(doc => {
                    const data = doc.data();
                    const date = data.date;
                    const records = data.records || {};
                    dailyPresent[date] = 0;
                    Object.entries(records).forEach(([uid, status]) => {
                        if (selSm !== 'all' && uid !== selSm) return;
                        if (!smMap[uid]) {
                            const sm = attSalesmenList.find(u => u.uid === uid);
                            smMap[uid] = { name: sm ? sm.name : uid, present:0, absent:0, halfday:0, leave:0 };
                        }
                        smMap[uid][status] = (smMap[uid][status] || 0) + 1;
                        if (status === 'present' || status === 'halfday') dailyPresent[date]++;
                    });
                });

                if (!Object.keys(smMap).length) { toast('No data for selected salesman', 'error'); return; }

                // Stats
                const smArr = Object.entries(smMap).map(([uid, v]) => ({ uid, ...v }));
                const totalPresent = smArr.reduce((s,r) => s+r.present+r.halfday, 0);
                const totalAbsent  = smArr.reduce((s,r) => s+r.absent, 0);
                const totalCells   = smArr.reduce((s,r) => s+r.present+r.absent+r.halfday+r.leave, 0);
                const avgPct = totalCells > 0 ? ((totalPresent / totalCells) * 100).toFixed(1) : 0;

                document.getElementById('attStatDays').textContent    = totalDays;
                document.getElementById('attStatPresent').textContent = totalPresent;
                document.getElementById('attStatAbsent').textContent  = totalAbsent;
                document.getElementById('attStatAvg').textContent     = avgPct + '%';
                document.getElementById('attRepStats').style.display  = 'block';

                // ── Bar Chart ──
                const barCtx = document.getElementById('attBarChart').getContext('2d');
                if (attBarChart) attBarChart.destroy();
                attBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: smArr.map(r => r.name),
                        datasets: [
                            { label: 'Present',  data: smArr.map(r=>r.present),  backgroundColor: '#10b981', borderRadius: 6 },
                            { label: 'Half Day', data: smArr.map(r=>r.halfday),  backgroundColor: '#f59e0b', borderRadius: 6 },
                            { label: 'Absent',   data: smArr.map(r=>r.absent),   backgroundColor: '#f43f5e', borderRadius: 6 },
                            { label: 'Leave',    data: smArr.map(r=>r.leave),    backgroundColor: '#6366f1', borderRadius: 6 },
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position:'top', labels:{font:{size:11}} } },
                        scales: {
                            x: { stacked: true, ticks:{font:{size:10}} },
                            y: { stacked: true, beginAtZero: true, ticks:{stepSize:1} }
                        }
                    }
                });

                // ── Pie Chart ──
                const pieCtx = document.getElementById('attPieChart').getContext('2d');
                if (attPieChart) attPieChart.destroy();
                attPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'Half Day', 'Absent', 'Leave'],
                        datasets: [{ data: [
                            smArr.reduce((s,r)=>s+r.present,0),
                            smArr.reduce((s,r)=>s+r.halfday,0),
                            smArr.reduce((s,r)=>s+r.absent,0),
                            smArr.reduce((s,r)=>s+r.leave,0)
                        ], backgroundColor: ['#10b981','#f59e0b','#f43f5e','#6366f1'], borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{position:'bottom', labels:{font:{size:11}}} } }
                });

                // ── Line Chart (daily present count) ──
                const lineCtx = document.getElementById('attLineChart').getContext('2d');
                if (attLineChart) attLineChart.destroy();
                attLineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{ label: 'Present (incl. half day)', data: dates.map(d=>dailyPresent[d]||0),
                            borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)',
                            fill: true, tension: 0.35, pointRadius: 4, pointBackgroundColor: '#6366f1' }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend:{ display:false } },
                        scales: { y:{ beginAtZero:true, ticks:{stepSize:1} }, x:{ ticks:{font:{size:9}, maxTicksLimit:12} } }
                    }
                });

                // ── Detail Table ──
                const tbody = document.getElementById('attDetailBody');
                tbody.innerHTML = '';
                attExportArray = [];
                smArr.forEach(r => {
                    const total = r.present + r.absent + r.halfday + r.leave;
                    const pct = total > 0 ? ((r.present + r.halfday) / total * 100).toFixed(1) : 0;
                    const color = pct >= 90 ? '#10b981' : pct >= 75 ? '#f59e0b' : '#f43f5e';
                    tbody.innerHTML += `<tr>
                        <td style="font-weight:700;">${r.name}</td>
                        <td style="color:#10b981;font-weight:700;">${r.present}</td>
                        <td style="color:#f43f5e;font-weight:700;">${r.absent}</td>
                        <td style="color:#f59e0b;font-weight:700;">${r.halfday}</td>
                        <td style="color:#6366f1;font-weight:700;">${r.leave}</td>
                        <td>${total}</td>
                        <td>
                            <span style="font-weight:800;color:${color};">${pct}%</span>
                            <div class="att-pct-bar"><div class="att-pct-bar-fill" style="width:${pct}%;background:${color};"></div></div>
                        </td>
                    </tr>`;
                    attExportArray.push({ Salesman:r.name, Present:r.present, Absent:r.absent, 'Half Day':r.halfday, Leave:r.leave, 'Total Days':total, 'Attendance %': pct+'%' });
                });

                // ── Daily breakdown per salesman ──
                const breakdown = document.getElementById('attDailyBreakdown');
                breakdown.innerHTML = `<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:10px;">📅 Daily Breakdown</div>`;
                smArr.forEach(r => {
                    if (selSm !== 'all' && r.uid !== selSm) return;
                    let cells = '';
                    snap.docs.forEach(doc => {
                        const recs = doc.data().records || {};
                        const status = recs[r.uid] || '–';
                        const emoji = {present:'✅',absent:'❌',halfday:'🌗',leave:'🏖️'}[status] || '–';
                        const bg = {present:'rgba(16,185,129,0.1)',absent:'rgba(244,63,94,0.08)',halfday:'rgba(245,158,11,0.1)',leave:'rgba(99,102,241,0.08)'}[status]||'var(--bg)';
                        cells += `<div style="background:${bg};border-radius:6px;padding:4px 6px;font-size:10px;text-align:center;min-width:44px;">
                            <div style="font-size:13px;">${emoji}</div>
                            <div style="color:#64748b;font-size:9px;">${doc.data().date.slice(5)}</div>
                        </div>`;
                    });
                    breakdown.innerHTML += `
                    <div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:8px;">
                        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">${r.name}</div>
                        <div style="display:flex;flex-wrap:wrap;gap:5px;">${cells}</div>
                    </div>`;
                });

                toast('✅ Report generated!', 'success');
            } catch(e) { toast(e.message, 'error'); console.error(e); }
        }

        function exportAttExcel() {
            if (!attExportArray.length) return toast('Generate report first', 'error');
            exportDataExcel(attExportArray, 'Attendance_Report');
        }

        function exportAttPDF() {
            if (!attExportArray.length) return toast('Generate report first', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');
            toast('Generating PDF...');
            const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(30,41,59);
            doc.text('Attendance Report', 14, 14);
            doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(100,116,139);
            doc.text('Generated: ' + today, pageW - 14, 14, {align:'right'});
            doc.autoTable({
                head: [['Salesman','Present','Absent','Half Day','Leave','Total Days','Attendance %']],
                body: attExportArray.map(r => [r.Salesman, r.Present, r.Absent, r['Half Day'], r.Leave, r['Total Days'], r['Attendance %']]),
                startY: 20, margin:{left:10,right:10},
                styles:{font:'helvetica',fontSize:10,cellPadding:4,overflow:'linebreak',lineColor:[203,213,225],lineWidth:0.3,textColor:[26,26,46],valign:'middle',minCellHeight:8},
                headStyles:{fillColor:[241,245,249],textColor:[26,26,46],fontStyle:'bold',fontSize:9,lineColor:[26,26,46],lineWidth:0.5},
                alternateRowStyles:{fillColor:[248,250,252]},
                didDrawPage:(data)=>{ doc.setFontSize(8); doc.setTextColor(148,163,184); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'}); },
                showHead:'everyPage'
            });
            doc.save('Attendance_Report_' + today.replace(/ /g,'_') + '.pdf');
            toast('✅ PDF saved!', 'success');
        }

        // ===== OFFLINE MODE =====
        const OFFLINE_QUEUE_KEY = 'owm_offline_queue';
        let isOnline = navigator.onLine;
        let lastPlacedOrder = null;

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const bar = document.getElementById('offlineBar');
            if (bar) {
                bar.style.display = isOnline ? 'none' : 'block';
                updateOfflineBadge();
            }
            const appScreen = document.getElementById('app-screen');
            if (appScreen) appScreen.style.paddingTop = (!isOnline) ? '40px' : '';
            if (isOnline) syncOfflineQueue();
        }

        function getOfflineQueue() {
            try { return JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]'); }
            catch(e) { return []; }
        }

        function saveOfflineQueue(q) {
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(q));
        }

        function updateOfflineBadge() {
            const q = getOfflineQueue();
            const el = document.getElementById('offlinePendingCount');
            if (el) el.textContent = q.length > 0 ? `${q.length} order${q.length>1?'s':''} pending sync` : '';
        }

        async function syncOfflineQueue() {
            const q = getOfflineQueue();
            if (!q.length) return;
            let synced = 0;
            const remaining = [];
            for (const item of q) {
                try {
                    // Deduct stock
                    for (let i of item.items) {
                        const ref = db.collection('products').doc(i.id);
                        await db.runTransaction(async t => {
                            const doc = await t.get(ref);
                            if (doc.exists) t.update(ref, { stock: Math.max(0, doc.data().stock - i.qty) });
                        });
                    }
                    // Save order (without serverTimestamp since we store local time)
                    await db.collection('orders').add({
                        shopName: item.shopName, items: item.items, total: item.total,
                        salesman: item.salesman, time: firebase.firestore.Timestamp.fromDate(new Date(item.localTime)),
                        syncedFromOffline: true
                    });
                    synced++;
                } catch(e) {
                    remaining.push(item); // keep failed ones
                }
            }
            saveOfflineQueue(remaining);
            updateOfflineBadge();
            if (synced > 0) toast(`✅ ${synced} offline order${synced>1?'s':''} synced!`, 'success');
        }

        window.addEventListener('online',  updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // ===== WHATSAPP INVOICE =====
        function openWAModal(orderObj) {
            lastPlacedOrder = orderObj;
            // Build summary
            const total = orderObj.total.toFixed(2);
            const itemCount = orderObj.items.length;
            document.getElementById('waSummaryText').innerHTML =
                `<b>${orderObj.shopName}</b> &nbsp;·&nbsp; ${itemCount} item${itemCount>1?'s':''} &nbsp;·&nbsp; <b>₹${total}</b>`;
            // Auto-fill shop phone
            const shopData = globalShops[orderObj.shopName];
            const phone = shopData && shopData.phone ? shopData.phone.replace(/[^0-9]/g,'').slice(-10) : '';
            document.getElementById('waPhoneInput').value = phone;
            const hint = document.getElementById('waSavedPhoneHint');
            if (hint) hint.style.display = phone ? 'block' : 'none';
            const modal = document.getElementById('waModal');
            modal.style.display = 'flex';
        }

        function closeWAModal() {
            document.getElementById('waModal').style.display = 'none';
            lastPlacedOrder = null;
            switchView('history');
        }

        function sendWAInvoice() {
            if (!lastPlacedOrder) return;
            const d = lastPlacedOrder;
            const rawPhone = document.getElementById('waPhoneInput').value.replace(/[^0-9]/g,'');
            const dateStr = new Date().toLocaleDateString('en-GB');
            let msg = `🛒 *Order With Me — Invoice*\n━━━━━━━━━━━━━━━━━\n🏪 *Shop:* ${d.shopName}\n📅 *Date:* ${dateStr}\n👤 *Sales Rep:* ${d.salesman}\n━━━━━━━━━━━━━━━━━\n`;
            d.items.forEach((item, i) => {
                msg += `${i+1}. ${item.id}\n   ${item.qty} × ₹${item.price.toFixed(2)} = ₹${item.total.toFixed(2)}\n`;
            });
            msg += `━━━━━━━━━━━━━━━━━\n💰 *Grand Total: ₹${d.total.toFixed(2)}*\n\n_Thank you for your business!_ 🙏`;
            const phone = rawPhone.length >= 10 ? '91' + rawPhone.slice(-10) : '';
            const url = phone
                ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
            closeWAModal();
        }

        // ===== CARD STATE MEMORY =====
        const CARD_STATE_KEY = 'owm_card_states_';
        function _cardStateKey() { return CARD_STATE_KEY + (userData.user || 'default'); }

        function loadCardStates() {
            try { return JSON.parse(localStorage.getItem(_cardStateKey()) || '{}'); } catch(e) { return {}; }
        }
        function saveCardState(id, isOpen) {
            try {
                const states = loadCardStates();
                states[id] = isOpen;
                localStorage.setItem(_cardStateKey(), JSON.stringify(states));
            } catch(e) {}
        }

        // ===== COLLAPSIBLE ADMIN PANEL (with state memory) =====
        function toggleCollapse(id) {
            const body  = document.getElementById(id);
            const arrow = document.getElementById('arrow-' + id);
            const isOpen = body.style.display !== 'none' && body.style.display !== '';
            body.style.display = isOpen ? 'none' : 'block';
            if (arrow) arrow.classList.toggle('open', !isOpen);
            saveCardState(id, !isOpen);
            // Lazy-load triggers
            if (id === 'col-users'   && !isOpen) loadUserList();
            if (id === 'col-offline' && !isOpen) renderOfflineQueueList();
        }

        // Restore saved card states for admin panel
        function restoreAdminCardStates() {
            const states = loadCardStates();
            const cardIds = ['col-offline','col-daily','col-shop','col-product',
                             'col-users','col-delete','col-incentive-calc'];
            cardIds.forEach(id => {
                const body  = document.getElementById(id);
                const arrow = document.getElementById('arrow-' + id);
                if (!body) return;
                // Default: all closed. Only open if explicitly saved as true.
                const shouldOpen = states[id] === true;
                body.style.display = shouldOpen ? 'block' : 'none';
                if (arrow) arrow.classList.toggle('open', shouldOpen);
            });
            // Lazy-load for cards that are open on restore
            if (states['col-users']   === true) loadUserList();
            if (states['col-offline'] === true) renderOfflineQueueList();
        }

        // ===== USER MANAGEMENT =====
        let resetTargetUid = null;
        let resetTargetName = null;

        async function loadUserList() {
            const container = document.getElementById('userListContainer');
            if (!container) return;
            try {
                const snap = await db.collection('users').orderBy('name').get();
                if (snap.empty) {
                    container.innerHTML = '<div style="text-align:center; color:#64748b; font-size:13px; padding:12px;">No users found.</div>';
                    return;
                }
                let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const roleColor = d.role === 'manager' ? '#6366f1' : '#10b981';
                    const roleLabel = d.role === 'manager' ? '⚙️ Manager' : '👤 Salesman';
                    const isMe = userData && userData.uid === doc.id;
                    html += `<div style="display:flex; align-items:center; justify-content:space-between; background:var(--bg); border-radius:12px; padding:12px 14px; border:1px solid var(--border);">
                        <div>
                            <div style="font-weight:700; font-size:14px;">${d.name || d.user}${isMe ? ' <span style="font-size:10px; color:#6366f1;">(You)</span>' : ''}</div>
                            <div style="font-size:11px; color:#64748b; margin-top:2px;">@${d.user} &nbsp;·&nbsp; <span style="color:${roleColor}; font-weight:600;">${roleLabel}</span></div>
                        </div>
                        <button onclick="openResetModal('${doc.id}', '${(d.name||d.user).replace(/'/g,"\\\'")}')"
                            style="padding:8px 12px; border-radius:10px; border:1.5px solid #6366f1; background:transparent; color:#6366f1; font-weight:700; font-size:12px; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap;">
                            🔑 Reset
                        </button>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = '<div style="text-align:center; color:#e11d48; font-size:13px; padding:12px;">Failed to load users.</div>';
            }
        }

        function openResetModal(uid, name) {
            resetTargetUid = uid;
            resetTargetName = name;
            document.getElementById('resetModalTitle').innerText = name + ' — Password Reset';
            document.getElementById('resetModalSub').innerText = name + ' — Enter a new password';
            document.getElementById('newPassInput').value = '';
            document.getElementById('confirmPassInput').value = '';
            const modal = document.getElementById('resetPassModal');
            modal.style.display = 'flex';
        }

        function closeResetModal() {
            document.getElementById('resetPassModal').style.display = 'none';
            resetTargetUid = null;
            resetTargetName = null;
        }

        async function confirmPasswordReset() {
            const newPass = document.getElementById('newPassInput').value;
            const confirmPass = document.getElementById('confirmPassInput').value;
            if (!newPass || newPass.length < 6) return toast('❌ Password must be at least 6 characters.', 'error');
            if (newPass !== confirmPass) return toast('❌ Passwords do not match!', 'error');

            const btn = document.getElementById('btnConfirmReset');
            btn.innerText = 'Processing...'; btn.disabled = true;

            try {
                // Save reset request to Firestore
                await db.collection('pending_resets').doc(resetTargetUid).set({
                    newPassword: newPass,
                    resetBy: userData.user,
                    resetAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                toast(`✅ ${resetTargetName}'s password reset request saved. The new password will apply on next login.`, 'success');
                closeResetModal();
            } catch(e) {
                toast('❌ Reset failed: ' + e.message, 'error');
            } finally { btn.innerText = '✅ Reset'; btn.disabled = false; }
        }

        async function checkPendingReset(uid) {
            try {
                const doc = await db.collection('pending_resets').doc(uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    const user = auth.currentUser;
                    if (user) {
                        await user.updatePassword(data.newPassword);
                        await db.collection('pending_resets').doc(uid).delete();
                        toast('🔑 Your password has been reset by an Admin.', 'success');
                    }
                }
            } catch(e) { /* silent */ }
        }

        async function deleteProductFromAdmin() {
            const itemId=document.getElementById('delItemSelect').value;
            if(!itemId) return toast("Select an item","error");
            try{
                const snap = await db.collection("products").doc(itemId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("products").doc(itemId).delete();
                toast("🗑️ Item deleted","success");
                document.getElementById('delItemSelect').value="";
                pushUndo(`"${itemId}" deleted`, async () => {
                    if(data) await db.collection("products").doc(itemId).set(data);
                });
            }catch(e){toast(e.message,"error");}
        }

        // ===== BILLING =====
        // ===== BRAND / INVOICE SETTINGS =====
        let brandSettings = JSON.parse(localStorage.getItem('owm_brand') || '{}');

        function applyBrandSettings() {
            // Company name on bill
            const nameEl = document.getElementById('b-companyName');
            if (nameEl) nameEl.textContent = brandSettings.name || 'Order With Me';
            // Logo on bill
            const logoWrap = document.getElementById('b-logoWrap');
            const logoImg  = document.getElementById('b-logoImg');
            if (logoWrap && logoImg) {
                if (brandSettings.logo) {
                    logoImg.src = brandSettings.logo;
                    logoWrap.style.display = 'block';
                } else {
                    logoWrap.style.display = 'none';
                }
            }
            // Footer note
            const fn = document.getElementById('b-footerNote');
            if (fn) fn.textContent = brandSettings.footerNote || '';
            // Populate inputs if visible
            const ni = document.getElementById('brandNameInput');
            if (ni && !ni.value) ni.value = brandSettings.name || 'Order With Me';
            const fi = document.getElementById('brandFooterInput');
            if (fi && !fi.value) fi.value = brandSettings.footerNote || '';
            // Show current logo preview in manager panel
            const cp = document.getElementById('currentLogoPreview');
            const ci = document.getElementById('currentLogoImg');
            if (cp && ci) {
                if (brandSettings.logo) { ci.src = brandSettings.logo; cp.style.display = 'flex'; }
                else { cp.style.display = 'none'; }
            }
        }

        function handleLogoFile(file) {
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return toast('Logo too large (max 2MB)', 'error');
            const reader = new FileReader();
            reader.onload = e => {
                brandSettings.logo = e.target.result;
                // Show preview in drop zone
                document.getElementById('logoPreviewArea').innerHTML = `
                    <img src="${e.target.result}" style="max-height:60px; max-width:180px; object-fit:contain; border-radius:8px; margin-bottom:4px;">
                    <div style="font-size:11px; font-weight:700; color:var(--success);">✅ Logo selected</div>`;
                applyBrandSettings();
            };
            reader.readAsDataURL(file);
        }

        function handleLogoDrop(e) {
            e.preventDefault();
            document.getElementById('logoDropZone').style.borderColor = 'rgba(99,102,241,0.4)';
            document.getElementById('logoDropZone').style.background = 'var(--bg)';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleLogoFile(file);
        }

        function removeLogo() {
            brandSettings.logo = '';
            document.getElementById('logoPreviewArea').innerHTML = `
                <div style="font-size:28px; margin-bottom:6px;">🖼️</div>
                <div style="font-size:13px; font-weight:600; color:#64748b;">Click or drag logo here</div>
                <div style="font-size:11px; color:#94a3b8; margin-top:3px;">PNG, JPG, SVG — max 2MB</div>`;
            applyBrandSettings();
            toast('Logo removed', 'success');
        }

        function saveBrandSettings() {
            brandSettings.name = document.getElementById('brandNameInput').value.trim() || 'Order With Me';
            brandSettings.footerNote = document.getElementById('brandFooterInput').value.trim();
            localStorage.setItem('owm_brand', JSON.stringify(brandSettings));
            applyBrandSettings();
            toast('✅ Invoice settings saved!', 'success');
        }

        // Call on load
        setTimeout(applyBrandSettings, 800);

        function renderA5Bill() {
            const idxStr = document.getElementById('billingSelect').value;
            if (idxStr === '') { document.getElementById('bill-preview-section').style.display = 'none'; return; }
            const d = historyData[parseInt(idxStr)];
            if (!d) return;

            const shopData = globalShops[d.shopName] || {};

            // Apply brand settings
            applyBrandSettings();

            // Header info
            document.getElementById('b-shopName').textContent = d.shopName;
            document.getElementById('b-shopPhone').textContent = shopData.phone ? '📞 ' + shopData.phone : '';
            document.getElementById('b-shopAddr').textContent  = shopData.addr  ? '📍 ' + shopData.addr  : '';
            document.getElementById('b-date').textContent      = d.time ? d.time.toDate().toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'}) : '';
            document.getElementById('b-salesman').textContent  = d.salesman || '';
            document.getElementById('b-orderId').textContent   = '#' + (d.orderId || '').substring(0, 8).toUpperCase();

            // Items table — each item on its own line with Rate, Qty, Amount columns
            let rows = '';
            let subTotal = 0;
            d.items.forEach((item, sl) => {
                const unitPrice = item.price || (item.qty > 0 ? item.total / item.qty : 0);
                const lineTotal = item.total || (unitPrice * item.qty);
                subTotal += lineTotal;
                rows += `
                <tr>
                    <td class="col-sl">${sl + 1}</td>
                    <td class="col-desc">
                        <span class="prod-name">${item.id}</span>
                    </td>
                    <td class="col-rate">${unitPrice.toFixed(2)}</td>
                    <td class="col-qty">${item.qty}</td>
                    <td class="col-amt">${lineTotal.toFixed(2)}</td>
                </tr>`;
            });
            document.getElementById('b-itemsBody').innerHTML = rows;

            // Totals
            document.getElementById('b-subTotal').textContent  = subTotal.toFixed(2);
            document.getElementById('b-grandTotal').textContent = d.total.toFixed(2);

            // Hide discount row (can be enhanced later)
            document.getElementById('b-discountRow').style.display = 'none';

            document.getElementById('bill-preview-section').style.display = 'block';
        }
        function openPrintSizeModal() {
            document.getElementById('printSizeModal').style.display = 'flex';
        }
        function openBillSizePDFModal() {
            document.getElementById('billPDFSizeModal').style.display = 'flex';
        }

        function doPrint(size) {
            document.getElementById('printSizeModal').style.display = 'none';
            // Inject @page rule dynamically
            let styleEl = document.getElementById('print-page-style');
            if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = 'print-page-style'; document.head.appendChild(styleEl); }
            const sizeMap = { A4: 'A4', A5: 'A5', A6: '105mm 148mm' };
            styleEl.textContent = `@page { size: ${sizeMap[size] || '105mm 148mm'}; margin: 8mm; }`;
            setTimeout(() => window.print(), 120);
        }

        function downloadBillPDF(size) {
            document.getElementById('billPDFSizeModal').style.display = 'none';
            toast('Generating PDF...');
            const sizeMap = { A4: 'a4', A5: 'a5', A6: [105, 148] };
            const fmt = sizeMap[size] || [105, 148];
            const orderId = document.getElementById('b-orderId').innerText || 'Invoice';
            const zone = document.getElementById('a5-print-zone');

            // Force all rows to not break mid-row before render
            zone.querySelectorAll('tr, td, th').forEach(el => {
                el.style.pageBreakInside = 'avoid';
                el.style.breakInside = 'avoid';
            });

            html2pdf().set({
                margin:        [5, 5, 5, 5],
                filename:      'Invoice_' + orderId + '_' + size + '.pdf',
                image:         { type: 'jpeg', quality: 1.0 },
                html2canvas:   { scale: 3, useCORS: true, backgroundColor: '#ffffff', logging: false, letterRendering: true },
                jsPDF:         { unit: 'mm', format: fmt, orientation: 'portrait' },
                pagebreak:     { mode: 'avoid-all', avoid: ['tr','td','th','.bill-totals-block','.bill-sign-row','.bill-footer'] }
            }).from(zone).save().then(() => {
                toast('✅ Invoice PDF saved!', 'success');
            });
        }

        // Legacy alias kept for any remaining calls
        function downloadA5PDF() { downloadBillPDF('A5'); }

        function exportAnyTable(tableId, reportName) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');

            const tableEl = document.getElementById(tableId);
            if (!tableEl) return toast('Table not found', 'error');

            // Find the actual <table> inside the container (or IS the table)
            const tbl = tableEl.tagName === 'TABLE' ? tableEl : tableEl.querySelector('table');
            if (!tbl) return toast('No table found inside element', 'error');

            toast('Generating PDF...');

            // Collect headers
            const headers = [];
            tbl.querySelectorAll('thead tr th').forEach(th => {
                if (th.classList.contains('no-print') || th.style.display === 'none') return;
                headers.push(th.innerText.trim());
            });

            // Collect rows
            const rows = [];
            tbl.querySelectorAll('tbody tr').forEach(tr => {
                if (tr.style.display === 'none') return;
                const row = [];
                tr.querySelectorAll('td').forEach((td, i) => {
                    if (td.classList.contains('no-print') || td.style.display === 'none') return;
                    row.push(td.innerText.trim().replace(/\n+/g, ' '));
                });
                if (row.length) rows.push(row);
            });

            if (!rows.length) return toast('No data rows to export', 'error');

            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'landscape' });
            const pageW = doc.internal.pageSize.getWidth();

            // Title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(30, 41, 59);
            doc.text(reportName.replace(/_/g, ' '), 14, 14);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            doc.text('Generated: ' + new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'}), pageW - 14, 14, { align: 'right' });

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 20,
                margin: { left: 10, right: 10 },
                styles: {
                    font: 'helvetica',
                    fontSize: 9,
                    cellPadding: 4,
                    overflow: 'linebreak',
                    lineColor: [203, 213, 225],
                    lineWidth: 0.3,
                    textColor: [26, 26, 46],
                    valign: 'middle',
                    halign: 'left',
                    minCellHeight: 8
                },
                headStyles: {
                    fillColor: [241, 245, 249],
                    textColor: [26, 26, 46],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                    halign: 'left',
                    lineColor: [26, 26, 46],
                    lineWidth: 0.5
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                columnStyles: {
                    0: { cellWidth: 'auto' }
                },
                didDrawPage: (data) => {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(148, 163, 184);
                    doc.text(
                        'Page ' + doc.internal.getCurrentPageInfo().pageNumber,
                        pageW / 2, doc.internal.pageSize.getHeight() - 6,
                        { align: 'center' }
                    );
                },
                tableWidth: 'auto',
                showHead: 'everyPage'
            });

            doc.save(reportName + '.pdf');
            toast('✅ PDF saved!', 'success');
        }
        function exportDataExcel(arr,name) {
            if(!arr||!arr.length) return toast("No data to export","error");
            toast("Exporting Excel...");
            const ws=XLSX.utils.json_to_sheet(arr);
            const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
            XLSX.writeFile(wb,name+".xlsx");
        }

        // ===== WHATSAPP — FIX: Always ask who to send to =====
        function shareWhatsApp() {
            const idxStr=document.getElementById('billingSelect').value;
            if(!idxStr) return toast("Select an order first","error");
            const d=historyData[parseInt(idxStr)]; if(!d) return;
            const dateStr=d.time?d.time.toDate().toLocaleDateString('en-GB'):'';
            let msg=`🛒 *Order With Me — Invoice*\n━━━━━━━━━━━━━━━━━\n🏪 *Shop:* ${d.shopName}\n📅 *Date:* ${dateStr}\n👤 *Sales Rep:* ${d.salesman}\n━━━━━━━━━━━━━━━━━\n`;
            d.items.forEach((item,i)=>{msg+=`${i+1}. ${item.id}\n   ${item.qty} × ₹${item.price.toFixed(2)} = ₹${item.total.toFixed(2)}\n`;});
            msg+=`━━━━━━━━━━━━━━━━━\n💰 *Grand Total: ₹${d.total.toFixed(2)}*\n\n_Thank you for your business!_ 🙏`;
            const phone = prompt(
                `Send WhatsApp invoice to:\n\nEnter phone number with country code (e.g. 919876543210)\nLeave blank to open WhatsApp without a pre-filled number.`,
                ""
            );
            if (phone === null) return; // User cancelled
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const url = cleanPhone
                ? `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // ===== DUE / CREDIT =====
        function getShopDueStats(shopName) {
            let totalBill = 0;
            historyData.forEach(d => { if(d.shopName === shopName) totalBill += d.total; });
            let totalPaid = 0;
            const entries = allDueData[shopName] || [];
            entries.forEach(e => { totalPaid += (e.payment || 0); });
            const remaining = totalBill - totalPaid;
            return { totalBill, totalPaid, remaining };
        }

        function onDueShopChange() {
            const shop = document.getElementById('dueShopSel').value;
            const summary = document.getElementById('dueShopBillSummary');
            if(!shop) { summary.style.display='none'; return; }
            summary.style.display='block';
            refreshDueShopSummaryPanel(shop);
        }

        function refreshDueShopSummaryPanel(shop) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shop);
            const paidPct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 100;
            const barColor = remaining <= 0 ? 'var(--success)' : (paidPct > 60 ? 'var(--warning)' : 'var(--danger)');
            document.getElementById('dueShopTotalBill').innerText = `₹ ${totalBill.toFixed(2)}`;
            document.getElementById('dueShopTotalPaid').innerText = `₹ ${totalPaid.toFixed(2)}`;
            const progressBar = document.getElementById('dueShopProgressBar');
            progressBar.style.width = `${paidPct.toFixed(0)}%`;
            progressBar.style.background = barColor;
            const remEl = document.getElementById('dueShopRemaining');
            if(remaining <= 0) {
                remEl.innerText = '✅ Fully Paid!';
                remEl.style.color = 'var(--success)';
            } else {
                remEl.innerText = `₹ ${remaining.toFixed(2)}`;
                remEl.style.color = 'var(--danger)';
            }
        }

        function renderDueList() {
            const area = document.getElementById('dueListArea');
            const dueShopSel = document.getElementById('dueShopSel');
            if(!area) return;
            if(dueShopSel) {
                const curVal = dueShopSel.value;
                dueShopSel.innerHTML = '<option value="">-- Select Shop --</option>';
                Object.keys(globalShops).forEach(k => {
                    dueShopSel.innerHTML += `<option value="${k}">${globalShops[k].name || k}</option>`;
                });
                dueShopSel.value = curVal;
                if(curVal) refreshDueShopSummaryPanel(curVal);
            }

            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allShops[d.shopName].totalBill += d.total;
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });

            area.innerHTML = '';
            let grandTotalDue = 0;
            let allCardsHTML = '';

            if(!Object.keys(allShops).length) {
                area.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;font-size:14px;">No orders or due entries found.</div>';
                document.getElementById('totalDueAmt').innerText = '₹ 0.00';
                return;
            }

            const sorted = Object.entries(allShops).sort((a,b) => {
                const dueA = a[1].totalBill - a[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                const dueB = b[1].totalBill - b[1].payments.reduce((s,e)=>s+(e.payment||0),0);
                return dueB - dueA;
            });

            let shopCardIndex = 0;
            sorted.forEach(([shopName, data]) => {
                if(data.totalBill === 0 && data.payments.length === 0) return;

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if(!isCleared) grandTotalDue += remaining;

                const paidPct = data.totalBill > 0 ? Math.min(100, (data.totalPaid / data.totalBill) * 100) : 100;
                const barColor = isCleared ? '#10b981' : (paidPct > 60 ? '#f59e0b' : '#f43f5e');
                const borderColor = isCleared ? 'rgba(16,185,129,0.4)' : 'rgba(244,63,94,0.4)';
                const cardId = 'dsc_' + (shopCardIndex++);

                const payRows = data.payments.map(e => {
                    const ts = e.time ? e.time.toDate().toLocaleDateString('en-GB') : '';
                    const safeDocId = e.docId ? e.docId.replace(/'/g,"\\'") : '';
                    const canManage = (userData.role === 'manager');
                    const actionBtns = canManage && safeDocId ? `
                        <div style="display:flex;gap:4px;margin-left:8px;flex-shrink:0;">
                            <button class="action-btn action-btn-edit" onclick="editDueEntry('${safeDocId}',${e.payment||0},'${(e.note||'').replace(/'/g,"\\'")}')" title="Edit">✏️</button>
                            <button class="action-btn action-btn-delete" onclick="deleteDueEntry('${safeDocId}','${shopName.replace(/'/g,"\\'")}',${e.payment||0})" title="Delete">🗑️</button>
                        </div>` : '';
                    return `<div class="payment-row" style="align-items:flex-start;">
                        <div style="flex:1;">
                            <span style="color:var(--success); font-size:13px;">💰 ${ts}</span>
                            ${e.note ? `<span style="color:#94a3b8; font-size:11px; margin-left:4px;">(${e.note})</span>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">
                            <span style="color:var(--success); font-weight:700; font-size:13px;">- ₹${(e.payment||0).toFixed(2)}</span>
                            ${actionBtns}
                        </div>
                    </div>`;
                }).join('');

                const safeShopName = shopName.replace(/'/g, "\\'");
                const safeShopNameJson = JSON.stringify(shopName);

                allCardsHTML += `
                <div class="due-shop-card" style="border-left:4px solid ${borderColor}; padding:0; overflow:hidden;">
                    <!-- Card top bar: left=clickable collapse, right=PDF button (separate, no stopPropagation needed) -->
                    <div style="display:flex;align-items:stretch;background:var(--card);">
                        <div onclick="toggleDueCard('${cardId}')"
                            style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;
                                   padding:14px 12px 14px 16px;cursor:pointer;user-select:none;">
                            <span style="font-size:18px;flex-shrink:0;">${isCleared ? '✅' : '🔴'}</span>
                            <div style="min-width:0;flex:1;">
                                <div style="font-size:15px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">🏪 ${shopName}</div>
                                <div style="font-size:11px;color:#94a3b8;margin-top:1px;">${data.payments.length} payment(s) · ${paidPct.toFixed(0)}% paid</div>
                            </div>
                            <span class="due-badge ${isCleared?'cleared':'has-due'}" style="font-size:11px;padding:3px 10px;flex-shrink:0;">
                                ${isCleared ? 'Cleared' : '₹'+remaining.toFixed(2)}
                            </span>
                            <span id="${cardId}_arrow" style="color:#94a3b8;font-size:14px;transition:transform 0.25s;display:inline-block;flex-shrink:0;">▼</span>
                        </div>
                        <div style="display:flex;align-items:center;padding:0 12px;border-left:1px solid var(--border);flex-shrink:0;">
                            <button data-pdf-shop="${shopName}"
                                style="background:transparent;border:1.5px solid var(--primary);color:var(--primary);
                                       border-radius:8px;padding:6px 11px;font-size:11px;font-weight:700;cursor:pointer;
                                       font-family:'Poppins',sans-serif;white-space:nowrap;line-height:1.2;">📄 PDF</button>
                        </div>
                    </div>
                    <div id="${cardId}" style="display:none;padding:14px 16px;border-top:1px solid var(--border);">
                        <div style="background:var(--bg);border-radius:12px;padding:14px;margin-bottom:12px;">
                            <div class="due-stat-row"><span style="color:#64748b;">📦 Total Orders (Billed)</span><span style="font-weight:700;color:var(--text);">₹ ${data.totalBill.toFixed(2)}</span></div>
                            <div class="due-stat-row"><span style="color:#64748b;">✅ Total Paid</span><span style="font-weight:700;color:var(--success);">₹ ${data.totalPaid.toFixed(2)}</span></div>
                            <div class="due-progress-wrap"><div class="due-progress-bar" style="width:${paidPct.toFixed(0)}%;background:${barColor};"></div></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#94a3b8;margin-bottom:8px;">
                                <span>${paidPct.toFixed(0)}% paid</span>
                                <span>${isCleared ? '✅ Complete' : (100-paidPct).toFixed(0)+'% remaining'}</span>
                            </div>
                            <div class="due-total-row">
                                <span style="font-size:14px;">${isCleared ? '✅ Fully Paid' : '🔴 Remaining Due'}</span>
                                <span style="color:${isCleared?'var(--success)':'var(--danger)'};font-size:18px;">${isCleared ? '₹ 0.00' : '₹ '+remaining.toFixed(2)}</span>
                            </div>
                        </div>
                        ${data.payments.length > 0 ? `
                        <div style="margin-bottom:10px;">
                            <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Payment History</div>
                            ${payRows}
                        </div>` : `<div style="font-size:12px;color:#94a3b8;padding:6px 0;margin-bottom:10px;">No payments recorded yet.</div>`}
                        ${userData.role==='manager' && !isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-success" style="margin-bottom:0;padding:11px;font-size:13px;">
                            💰 Collect Due Payment (₹${remaining.toFixed(2)})
                        </button>` : ''}
                        ${userData.role==='manager' && isCleared ? `
                        <button onclick="quickRecordPayment('${safeShopName}')" class="btn btn-outline" style="margin-bottom:0;padding:11px;font-size:12px;">
                            + Record More Payment
                        </button>` : ''}
                    </div>
                </div>`;
            });

            area.innerHTML = allCardsHTML;
            // Attach PDF button listeners after DOM is built (avoids onclick escaping issues)
            area.querySelectorAll('[data-pdf-shop]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const shopName = this.getAttribute('data-pdf-shop');
                    exportSingleShopDuePDF(shopName);
                });
            });
            document.getElementById('totalDueAmt').innerText = `₹ ${grandTotalDue.toFixed(2)}`;
        }

        function toggleDueCard(cardId) {
            const body = document.getElementById(cardId);
            const arrow = document.getElementById(cardId + '_arrow');
            if (!body) return;
            const isOpen = body.style.display !== 'none';
            body.style.display = isOpen ? 'none' : 'block';
            if (arrow) arrow.style.transform = isOpen ? '' : 'rotate(180deg)';
        }
        async function saveDueEntry() {
            const shop = document.getElementById('dueShopSel').value;
            const payment = parseFloat(document.getElementById('duePayAmt').value) || 0;
            const note = document.getElementById('dueNote').value.trim();
            if(!shop) return toast("Please select a shop","error");
            if(!payment || payment <= 0) return toast("Please enter a valid payment amount","error");
            const { remaining } = getShopDueStats(shop);
            if(remaining > 0 && payment > remaining) {
                if(!confirm(`⚠️ Payment (₹${payment.toFixed(2)}) exceeds the remaining due (₹${remaining.toFixed(2)}). Continue?`)) return;
            }
            try {
                await db.collection("due_entries").add({
                    shopName: shop, credit: 0, payment, note,
                    salesman: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast(`✅ ₹${payment.toFixed(2)} payment saved!`, "success");
                document.getElementById('duePayAmt').value = '';
                document.getElementById('dueNote').value = '';
                refreshDueShopSummaryPanel(shop);
            } catch(e) { toast(e.message, "error"); }
        }

        async function editDueEntry(docId, oldPayment, oldNote) {
            const newAmt = prompt(`Edit payment amount (₹):`, oldPayment);
            if(newAmt === null) return;
            const newNote = prompt(`Edit note:`, oldNote);
            if(newNote === null) return;
            const amt = parseFloat(newAmt);
            if(isNaN(amt) || amt <= 0) return toast("Invalid amount","error");
            try {
                await db.collection("due_entries").doc(docId).update({ payment: amt, note: newNote });
                toast("✅ Payment entry updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteDueEntry(docId, shopName, paymentAmt) {
            try {
                const snap = await db.collection("due_entries").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("due_entries").doc(docId).delete();
                toast("🗑️ Payment entry deleted","success");
                pushUndo(`Payment ₹${paymentAmt.toFixed(2)} deleted`, async () => {
                    if(data) await db.collection("due_entries").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function quickRecordPayment(shopName) {
            const { totalBill, totalPaid, remaining } = getShopDueStats(shopName);
            const amt = prompt(
                `💰 ${shopName}\n━━━━━━━━━━━━━━━━━\n` +
                `📦 Total Bill:    ₹${totalBill.toFixed(2)}\n` +
                `✅ Already Paid:  ₹${totalPaid.toFixed(2)}\n` +
                `🔴 Remaining:     ₹${Math.max(0,remaining).toFixed(2)}\n` +
                `━━━━━━━━━━━━━━━━━\nHow much did they pay?`
            );
            if(!amt || isNaN(parseFloat(amt)) || parseFloat(amt) <= 0) return;
            const note = prompt("Note (optional):") || '';
            db.collection("due_entries").add({
                shopName, credit:0, payment:parseFloat(amt), note,
                salesman: userData.name,
                time: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => toast(`✅ ₹${parseFloat(amt).toFixed(2)} payment recorded!`, "success"))
              .catch(e => toast(e.message, "error"));
        }

        // ===== HELPERS: Build allShops data for PDFs =====
        function buildAllShopsData() {
            const allShops = {};
            historyData.forEach(d => {
                if(!allShops[d.shopName]) allShops[d.shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allShops[d.shopName].totalBill += d.total;
                allShops[d.shopName].orders.push(d);
            });
            Object.keys(allDueData).forEach(shopName => {
                if(!allShops[shopName]) allShops[shopName] = { totalBill:0, totalPaid:0, payments:[], orders:[] };
                allDueData[shopName].forEach(e => {
                    allShops[shopName].totalPaid += (e.payment || 0);
                    allShops[shopName].payments.push(e);
                });
            });
            return allShops;
        }

        // ===== PDF EXPORT: DUE — Summary (all shops on one PDF) =====
        function exportDuePDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No due data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Report_' + today.replace(/ /g, '-') + '.pdf';

            // Header bar
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pw, 28, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16); doc.setFont('helvetica', 'bold');
            doc.text('ORDER WITH ME', 14, 11);
            doc.setFontSize(9); doc.setFont('helvetica', 'normal');
            doc.text('Due / Credit Report', 14, 18);
            doc.text('Generated: ' + today, pw - 14, 18, { align: 'right' });

            // Table
            let grandDue = 0;
            const tableBody = [];
            sorted.forEach(([shopName, data]) => {
                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                if (!isCleared) grandDue += remaining;
                tableBody.push([
                    shopName,
                    'Rs.' + data.totalBill.toFixed(2),
                    'Rs.' + data.totalPaid.toFixed(2),
                    'Rs.' + Math.max(0, remaining).toFixed(2),
                    isCleared ? 'Cleared' : 'Pending'
                ]);
            });

            doc.autoTable({
                startY: 35,
                head: [['Shop Name', 'Total Bill', 'Total Paid', 'Remaining Due', 'Status']],
                body: tableBody,
                foot: [['', '', 'Grand Total Due:', 'Rs.' + grandDue.toFixed(2), '']],
                headStyles: { fillColor: [241, 245, 249], textColor: [30, 41, 59], fontStyle: 'bold', halign: 'left' },
                footStyles: { fillColor: [241, 245, 249], textColor: [225, 29, 72], fontStyle: 'bold' },
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    1: { halign: 'right' },
                    2: { halign: 'right', textColor: [16, 185, 129] },
                    3: { halign: 'right', fontStyle: 'bold' },
                    4: { halign: 'center' }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                    if (data.section === 'body' && data.column.index === 4) {
                        const row = tableBody[data.row.index];
                        if (row && row[4] === 'Cleared') data.cell.styles.textColor = [16, 185, 129];
                        else data.cell.styles.textColor = [225, 29, 72];
                    }
                },
                margin: { left: 14, right: 14 },
                styles: { fontSize: 9, cellPadding: 4 },
                alternateRowStyles: { fillColor: [248, 250, 252] }
            });

            // Footer note
            const finalY = doc.lastAutoTable.finalY + 6;
            doc.setFontSize(8); doc.setTextColor(148, 163, 184); doc.setFont('helvetica', 'normal');
            doc.text('Generated by Order With Me ERP', pw - 14, finalY, { align: 'right' });

            doc.save(fileName);
            toast("✅ PDF saved!", "success");
        }


        // ===== PDF EXPORT: DUE — Separate page per shop =====
        function exportDuePerShopPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast("jsPDF not loaded", "error");
            const allShops = buildAllShopsData();
            const sorted = Object.entries(allShops)
                .filter(([,d]) => d.totalBill > 0 || d.payments.length > 0)
                .sort((a,b) => (b[1].totalBill - b[1].totalPaid) - (a[1].totalBill - a[1].totalPaid));
            if (!sorted.length) return toast("No data to export", "error");

            toast("Generating PDF...");
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
            const pw = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
            const fileName = 'Due_Per_Shop_' + today.replace(/ /g, '-') + '.pdf';

            sorted.forEach(([shopName, data], idx) => {
                if (idx > 0) doc.addPage();

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const statusColor = isCleared ? [16, 185, 129] : [225, 29, 72];
                const shopInfo = globalShops[shopName] || {};

                // Header bar
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER WITH ME', 14, 9);
                doc.setFontSize(15); doc.setFont('helvetica', 'bold');
                doc.text(shopName, 14, 20);
                doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                doc.text('Generated: ' + today, pw - 14, 9, { align: 'right' });
                const statusLabel = isCleared ? 'CLEARED' : 'PENDING';
                doc.setTextColor(...statusColor);
                // White bg pill for status
                doc.setFillColor(255,255,255);
                doc.roundedRect(pw - 55, 13, 41, 12, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text(statusLabel, pw - 34.5, 18, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), pw - 34.5, 23, { align: 'center' });

                let y = 35;

                // Shop info
                if (shopInfo.phone || shopInfo.addr) {
                    doc.setTextColor(100, 116, 139); doc.setFontSize(8); doc.setFont('helvetica', 'normal');
                    if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                    if (shopInfo.addr) { doc.text('Addr: ' + shopInfo.addr, 14, y); y += 5; }
                }

                // Summary boxes
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    { label: 'TOTAL BILLED', val: 'Rs.' + data.totalBill.toFixed(2), bg: [240, 244, 255], color: [79, 70, 229] },
                    { label: 'TOTAL PAID', val: 'Rs.' + data.totalPaid.toFixed(2), bg: [240, 255, 248], color: [16, 185, 129] },
                    { label: 'REMAINING DUE', val: 'Rs.' + Math.max(0, remaining).toFixed(2), bg: isCleared ? [240, 255, 248] : [255, 240, 240], color: statusColor }
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(...b.bg);
                    doc.roundedRect(bx, y, boxW, 16, 3, 3, 'F');
                    doc.setTextColor(100, 116, 139); doc.setFontSize(7); doc.setFont('helvetica', 'bold');
                    doc.text(b.label, bx + boxW / 2, y + 5, { align: 'center' });
                    doc.setTextColor(...b.color); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
                    doc.text(b.val, bx + boxW / 2, y + 12, { align: 'center' });
                });
                y += 22;

                // Orders table
                doc.setTextColor(79, 70, 229); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderBody = [];
                if (data.orders && data.orders.length) {
                    [...data.orders].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(o => {
                        const date = o.time ? o.time.toDate().toLocaleDateString('en-GB') : '—';
                        const items = (o.items || []).map(it => it.id + ' x' + it.qty).join(', ');
                        orderBody.push([date, items || '—', 'Rs.' + (o.total||0).toFixed(2), o.salesman || '—']);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Items', 'Amount', 'By']],
                    body: orderBody.length ? orderBody : [['—', 'No orders', '—', '—']],
                    foot: [['', 'Total Billed:', 'Rs.' + data.totalBill.toFixed(2), '']],
                    headStyles: { fillColor: [240, 244, 255], textColor: [79, 70, 229], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 244, 255], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold' }, 3: { halign: 'center' } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                });
                y = doc.lastAutoTable.finalY + 6;

                // Payments table
                doc.setTextColor(16, 185, 129); doc.setFontSize(8); doc.setFont('helvetica', 'bold');
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payBody = [];
                if (data.payments && data.payments.length) {
                    [...data.payments].sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .forEach(p => {
                        const date = p.time ? p.time.toDate().toLocaleDateString('en-GB') : '—';
                        payBody.push([date, p.note || '—', 'Rs.' + (p.payment||0).toFixed(2)]);
                    });
                }

                doc.autoTable({
                    startY: y,
                    head: [['Date', 'Note', 'Paid']],
                    body: payBody.length ? payBody : [['—', 'No payments recorded', '—']],
                    foot: [['', 'Total Paid:', 'Rs.' + data.totalPaid.toFixed(2)]],
                    headStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fillColor: [240, 255, 248], textColor: [16, 185, 129], fontStyle: 'bold', fontSize: 8 },
                    columnStyles: { 2: { halign: 'right', fontStyle: 'bold', textColor: [16, 185, 129] } },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    alternateRowStyles: { fillColor: [248, 255, 252] }
                });

                // Page footer
                const ph = doc.internal.pageSize.getHeight();
                doc.setDrawColor(226, 232, 240); doc.setLineWidth(0.3);
                doc.line(14, ph - 10, pw - 14, ph - 10);
                doc.setTextColor(148, 163, 184); doc.setFontSize(7); doc.setFont('helvetica', 'normal');
                doc.text('Order With Me ERP', 14, ph - 6);
                doc.text('Page ' + (idx + 1) + ' of ' + sorted.length, pw - 14, ph - 6, { align: 'right' });
            });

            doc.save(fileName);
            toast("✅ PDF saved!", "success");
        }


        // ===== PDF EXPORT: SINGLE SHOP DUE STATEMENT (jsPDF direct) =====
        function exportSingleShopDuePDF(shopName) {
            try {
                const { jsPDF } = window.jspdf;
                const allShops = buildAllShopsData();
                const data = allShops[shopName];
                if (!data) return toast("No data for this shop", "error");

                const remaining = data.totalBill - data.totalPaid;
                const isCleared = remaining <= 0;
                const shopInfo = globalShops[shopName] || {};
                const today = new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});

                const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const pw = doc.internal.pageSize.getWidth();
                let y = 15;

                // ── Header bar ──
                doc.setFillColor(79, 70, 229);
                doc.rect(0, 0, pw, 28, 'F');
                doc.setTextColor(255,255,255);
                doc.setFontSize(16); doc.setFont('helvetica','bold');
                doc.text('ORDER WITH ME', 14, 11);
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.text('Shop Due Statement', 14, 18);
                doc.text(`Generated: ${today}`, pw - 14, 18, {align:'right'});
                y = 36;

                // ── Shop info ──
                doc.setTextColor(26,26,46);
                doc.setFontSize(15); doc.setFont('helvetica','bold');
                doc.text(shopName, 14, y); y += 6;
                doc.setFontSize(9); doc.setFont('helvetica','normal');
                doc.setTextColor(100,116,139);
                if (shopInfo.phone) { doc.text('Phone: ' + shopInfo.phone, 14, y); y += 5; }
                if (shopInfo.addr)  { doc.text('Address: ' + shopInfo.addr,  14, y); y += 5; }
                y += 2;

                // ── Status badge (right side) ──
                const badgeX = pw - 55, badgeY = 34;
                doc.setFillColor(isCleared ? 220 : 254, isCleared ? 252 : 226, isCleared ? 231 : 226);
                doc.roundedRect(badgeX, badgeY, 48, 20, 3, 3, 'F');
                doc.setFontSize(8); doc.setFont('helvetica','bold');
                doc.setTextColor(isCleared ? 16 : 220, isCleared ? 185 : 38, isCleared ? 129 : 38);
                doc.text(isCleared ? 'CLEARED' : 'PENDING', badgeX + 24, badgeY + 7, {align:'center'});
                doc.setFontSize(13);
                doc.text('Rs.' + Math.max(0, remaining).toFixed(2), badgeX + 24, badgeY + 16, {align:'center'});

                // ── Summary boxes ──
                y += 4;
                const boxW = (pw - 28 - 8) / 3;
                const boxes = [
                    {label:'TOTAL BILLED', val:'Rs.'+data.totalBill.toFixed(2), r:66,g:99,b:235},
                    {label:'TOTAL PAID',   val:'Rs.'+data.totalPaid.toFixed(2),  r:16,g:185,b:129},
                    {label:'REMAINING',    val:'Rs.'+Math.max(0,remaining).toFixed(2), r:isCleared?16:244, g:isCleared?185:63, b:isCleared?129:94},
                ];
                boxes.forEach((b, i) => {
                    const bx = 14 + i * (boxW + 4);
                    doc.setFillColor(245, 247, 255);
                    doc.roundedRect(bx, y, boxW, 18, 2, 2, 'F');
                    doc.setFontSize(7); doc.setFont('helvetica','bold');
                    doc.setTextColor(100,116,139);
                    doc.text(b.label, bx + boxW/2, y + 6, {align:'center'});
                    doc.setFontSize(12); doc.setFont('helvetica','bold');
                    doc.setTextColor(b.r, b.g, b.b);
                    doc.text(b.val, bx + boxW/2, y + 14, {align:'center'});
                });
                y += 24;

                // ── Orders table ──
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(79, 70, 229);
                doc.text('ORDER HISTORY', 14, y); y += 2;

                const orderRows = (data.orders||[])
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(o => [
                        o.time ? o.time.toDate().toLocaleDateString('en-GB') : '—',
                        (o.items||[]).map(it => it.id + ' x' + it.qty).join(', ') || '—',
                        'Rs.' + (o.total||0).toFixed(2),
                        o.salesman || '—'
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Items','Amount','Salesman']],
                    body: orderRows.length ? orderRows : [['No orders found','','','']],
                    foot: [['','Total Bill:', 'Rs.'+data.totalBill.toFixed(2),'']],
                    theme: 'grid',
                    headStyles: {fillColor:[79,70,229], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[224,231,255], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}, 0:{cellWidth:25}, 3:{cellWidth:25}},
                    alternateRowStyles: {fillColor:[248,250,255]},
                    margin: {left:14, right:14},
                });
                y = doc.lastAutoTable.finalY + 8;

                // ── Payments table ──
                if (y > 250) { doc.addPage(); y = 15; }
                doc.setFontSize(10); doc.setFont('helvetica','bold');
                doc.setTextColor(16, 185, 129);
                doc.text('PAYMENT HISTORY', 14, y); y += 2;

                const payRows = [...(data.payments||[])]
                    .sort((a,b) => (a.time?.toDate?.()?.getTime()||0) - (b.time?.toDate?.()?.getTime()||0))
                    .map(p => [
                        p.time ? p.time.toDate().toLocaleDateString('en-GB') : '—',
                        p.note || '—',
                        'Rs.' + (p.payment||0).toFixed(2)
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Date','Note','Amount Paid']],
                    body: payRows.length ? payRows : [['No payments recorded','','']],
                    foot: [['','Total Paid:', 'Rs.'+data.totalPaid.toFixed(2)]],
                    theme: 'grid',
                    headStyles: {fillColor:[16,185,129], textColor:255, fontStyle:'bold', fontSize:9},
                    footStyles: {fillColor:[209,250,229], textColor:[26,26,46], fontStyle:'bold', fontSize:9},
                    bodyStyles: {fontSize:8, textColor:[30,41,59]},
                    columnStyles: {2:{halign:'right'}},
                    alternateRowStyles: {fillColor:[240,255,248]},
                    margin: {left:14, right:14},
                });

                const safeFilename = shopName.replace(/[^a-zA-Z0-9]/g,'_');
                doc.save(`Due_Statement_${safeFilename}_${today.replace(/ /g,'_')}.pdf`);
                toast("✅ PDF saved!", "success");

            } catch(e) {
                console.error("PDF error:", e);
                toast("PDF error: " + e.message, "error");
            }
        }

        // ===== RETURNS =====        // ===== RETURNS =====
        function loadReturnItems() {
            const idx=document.getElementById('returnOrderSel').value;
            const area=document.getElementById('returnItemsArea');
            const list=document.getElementById('returnItemsList');
            if(!idx){area.style.display='none';return;}
            const d=historyData[parseInt(idx)]; if(!d) return;
            list.innerHTML='';
            d.items.forEach((item,i)=>{
                list.innerHTML+=`<div class="return-item-row">
                    <input type="checkbox" id="ret_chk_${i}" value="${i}" style="width:18px;height:18px;cursor:pointer;accent-color:var(--primary);">
                    <label for="ret_chk_${i}" style="flex:1;cursor:pointer;"><b>${item.id}</b> <span style="color:#64748b;">× ${item.qty} @ ₹${item.price.toFixed(2)}</span></label>
                    <input type="number" id="ret_qty_${i}" class="input-field" placeholder="Qty" min="1" max="${item.qty}" value="${item.qty}" style="width:70px;margin-bottom:0;padding:8px 10px;">
                </div>`;
            });
            area.style.display='block';
        }
        async function processReturn() {
            const idx=document.getElementById('returnOrderSel').value;
            if(!idx) return toast("Select an order","error");
            const d=historyData[parseInt(idx)];
            const reason=document.getElementById('returnReason').value.trim();
            let returnItems=[], refundAmt=0;
            d.items.forEach((item,i)=>{
                const chk=document.getElementById(`ret_chk_${i}`);
                if(chk&&chk.checked){
                    const qty=parseInt(document.getElementById(`ret_qty_${i}`).value)||0;
                    if(qty>0&&qty<=item.qty){returnItems.push({...item,qty});refundAmt+=qty*item.price;}
                }
            });
            if(!returnItems.length) return toast("Select at least one item","error");
            if(!confirm(`Process return for ${returnItems.length} item(s)? Refund: ₹${refundAmt.toFixed(2)}. Stock will be restored.`)) return;
            try{
                for(let item of returnItems){
                    const ref=db.collection("products").doc(item.id);
                    await db.runTransaction(async t=>{const pDoc=await t.get(ref);if(pDoc.exists) t.update(ref,{stock:pDoc.data().stock+item.qty});});
                }
                // Save return doc first, then link the due_entry back to it
                const returnRef = await db.collection("returns").add({orderId:d.orderId,shopName:d.shopName,items:returnItems,refundAmt,reason,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                if(refundAmt>0){
                    const dueRef = await db.collection("due_entries").add({shopName:d.shopName,credit:0,payment:refundAmt,note:`Auto: Return refund (${reason||'return'})`,salesman:userData.name,isReturnEntry:true,returnDocId:returnRef.id,time:firebase.firestore.FieldValue.serverTimestamp()});
                    // Link the due entry ID back into the return document
                    await returnRef.update({dueEntryId: dueRef.id});
                }
                toast(`Return processed! Refund: ₹${refundAmt.toFixed(2)}`,"success");
                document.getElementById('returnOrderSel').value='';
                document.getElementById('returnItemsArea').style.display='none';
                document.getElementById('returnReason').value='';
            }catch(e){toast(e.message,"error");}
        }
        function populateReturnOrderSel() {
            const sel=document.getElementById('returnOrderSel');
            if(!sel) return;
            sel.innerHTML='<option value="">-- Select Order --</option>';
            historyData.forEach((d,i)=>{
                const ts=d.time?d.time.toDate().toLocaleDateString():'';
                sel.innerHTML+=`<option value="${i}">${d.shopName} — ${ts} (₹${d.total.toFixed(0)})</option>`;
            });
        }

        async function editReturn(docId) {
            const ret = allReturnsData.find(r => r.docId === docId);
            if(!ret) return toast("Record not found","error");
            const newReason = prompt(`Edit return reason:`, ret.reason || '');
            if(newReason === null) return;
            try {
                await db.collection("returns").doc(docId).update({ reason: newReason });
                toast("✅ Return reason updated!","success");
            } catch(e) { toast(e.message,"error"); }
        }

        async function deleteReturn(docId, refundAmt) {
            if(!confirm(`Delete this return? The ₹${refundAmt.toFixed(2)} refund payment will also be reversed from the due/payment ledger.`)) return;
            try {
                const snap = await db.collection("returns").doc(docId).get();
                if(!snap.exists) return toast("Return not found","error");
                const data = snap.data();

                // 1. Delete the linked due_entry (auto refund payment)
                let savedDueData = null;
                let savedDueId = data.dueEntryId || null;
                if(savedDueId) {
                    const dueSnap = await db.collection("due_entries").doc(savedDueId).get();
                    if(dueSnap.exists) {
                        savedDueData = dueSnap.data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                } else {
                    // Fallback: search by returnDocId field for older records
                    const q = await db.collection("due_entries")
                        .where("returnDocId","==",docId)
                        .limit(1).get();
                    if(!q.empty) {
                        savedDueId = q.docs[0].id;
                        savedDueData = q.docs[0].data();
                        await db.collection("due_entries").doc(savedDueId).delete();
                    }
                }

                // 2. Reverse stock (deduct back what was restored on return)
                if(data.items && data.items.length) {
                    for(let item of data.items) {
                        const ref = db.collection("products").doc(item.id);
                        await db.runTransaction(async t => {
                            const pDoc = await t.get(ref);
                            if(pDoc.exists) {
                                const newStock = Math.max(0, pDoc.data().stock - item.qty);
                                t.update(ref, {stock: newStock});
                            }
                        });
                    }
                }

                // 3. Delete the return document itself
                await db.collection("returns").doc(docId).delete();
                toast("🗑️ Return deleted & payment reversed","success");

                // 4. Undo support
                pushUndo(`Return ₹${refundAmt.toFixed(2)} deleted`, async () => {
                    // Restore return doc
                    await db.collection("returns").doc(docId).set(data);
                    // Restore due entry
                    if(savedDueId && savedDueData) {
                        await db.collection("due_entries").doc(savedDueId).set(savedDueData);
                        await db.collection("returns").doc(docId).update({dueEntryId: savedDueId});
                    }
                    // Re-restore stock
                    if(data.items && data.items.length) {
                        for(let item of data.items) {
                            const ref = db.collection("products").doc(item.id);
                            await db.runTransaction(async t => {
                                const pDoc = await t.get(ref);
                                if(pDoc.exists) t.update(ref, {stock: pDoc.data().stock + item.qty});
                            });
                        }
                    }
                });
            } catch(e) { toast(e.message,"error"); }
        }

        // ===== PDF EXPORT: RETURNS =====
        function exportReturnsPDF() {
            if (!allReturnsData.length) return toast('No returns to export', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');
            toast('Generating PDF...');
            const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            const totalRefund = allReturnsData.reduce((s,r)=>s+(r.refundAmt||0), 0);

            doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(30,41,59);
            doc.text('Returns History Report', 14, 14);
            doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(100,116,139);
            doc.text('Generated: ' + today + '  |  Total Refund: Rs.' + totalRefund.toFixed(2), pageW-14, 14, {align:'right'});

            doc.autoTable({
                head: [['Date','Shop','Items','Salesman','Reason','Refund (Rs.)']],
                body: allReturnsData.map(r => [
                    r.time ? r.time.toDate().toLocaleDateString('en-GB') : 'N/A',
                    r.shopName, r.items.map(i=>`${i.id}(${i.qty})`).join(', '),
                    r.salesman, r.reason||'—', (r.refundAmt||0).toFixed(2)
                ]),
                startY:20, margin:{left:10,right:10},
                styles:{font:'helvetica',fontSize:9,cellPadding:4,overflow:'linebreak',lineColor:[203,213,225],lineWidth:0.3,textColor:[26,26,46],valign:'middle',minCellHeight:8},
                headStyles:{fillColor:[241,245,249],textColor:[26,26,46],fontStyle:'bold',fontSize:8.5,lineColor:[26,26,46],lineWidth:0.5},
                alternateRowStyles:{fillColor:[248,250,252]},
                columnStyles:{2:{cellWidth:'auto'},5:{halign:'right'}},
                foot:[['','','','','Total Refund:', totalRefund.toFixed(2)]],
                footStyles:{fillColor:[241,245,249],fontStyle:'bold',textColor:[26,26,46]},
                showHead:'everyPage',
                didDrawPage:(data)=>{ doc.setFontSize(8); doc.setTextColor(148,163,184); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'}); }
            });
            doc.save('Returns_Report_' + today.replace(/ /g,'_') + '.pdf');
            toast('✅ PDF saved!', 'success');
        }

        // ===== SALESMAN PERFORMANCE =====
        function setPerfPeriod(period, btn) {
            document.querySelectorAll('#view-salesman-perf .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            perfPeriod=period;
            renderSalesmanPerf();
        }
        function renderSalesmanPerf() {
            const now=new Date(); let startMs=0;
            if(perfPeriod==='month'){startMs=new Date(now.getFullYear(),now.getMonth(),1).getTime();}
            else if(perfPeriod==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            else if(perfPeriod==='today'){startMs=new Date().setHours(0,0,0,0);}
            const perfMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(startMs&&oMs<startMs) return;
                if(!perfMap[d.salesman]) perfMap[d.salesman]={total:0,orders:0,shops:new Set(),items:0};
                perfMap[d.salesman].total+=d.total; perfMap[d.salesman].orders++;
                perfMap[d.salesman].shops.add(d.shopName);
                d.items.forEach(i=>perfMap[d.salesman].items+=i.qty);
            });
            const sorted=Object.entries(perfMap).sort((a,b)=>b[1].total-a[1].total);
            const maxTotal=sorted.length?sorted[0][1].total:1;
            const medals=['🥇','🥈','🥉'];
            const summaryEl=document.getElementById('perfSummaryCards');
            summaryEl.innerHTML='';
            if(sorted.length){summaryEl.innerHTML=`<div class="dash-card dc-today" style="cursor:default;"><span class="dc-icon">🏆</span><div class="dc-lbl">Top Salesman</div><div class="dc-val" style="font-size:15px;">${sorted[0][0]}</div></div><div class="dash-card dc-total" style="cursor:default;"><span class="dc-icon">💰</span><div class="dc-lbl">Best Revenue</div><div class="dc-val">₹${(sorted[0][1].total/1000).toFixed(1)}k</div></div>`;}
            const lb=document.getElementById('perfLeaderboard');
            lb.innerHTML='';
            if(!sorted.length){lb.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No data for this period.</div>';return;}
            sorted.forEach(([name,stats],idx)=>{
                const pct=((stats.total/maxTotal)*100).toFixed(0);
                lb.innerHTML+=`<div class="perf-card"><div class="flex-between"><div style="display:flex;align-items:center;gap:8px;"><span class="perf-rank">${medals[idx]||'#'+(idx+1)}</span><div><div style="font-weight:700;font-size:15px;">${name}</div><div style="font-size:11px;color:#64748b;">${stats.orders} orders · ${stats.shops.size} shops · ${stats.items} items sold</div></div></div><div style="text-align:right;"><div style="font-weight:800;font-size:18px;color:var(--primary);">₹${stats.total.toFixed(0)}</div><div style="font-size:11px;color:#64748b;">Avg ₹${(stats.total/stats.orders).toFixed(0)}/order</div></div></div><div class="perf-bar-wrap"><div class="perf-bar" style="width:${pct}%;"></div></div></div>`;
            });
            const cw=document.getElementById('perfChartWrapper');
            cw.style.display=sorted.length>1?'block':'none';
            if(sorted.length>1){
                const ctx=document.getElementById('perfChart').getContext('2d');
                if(perfChartInstance) perfChartInstance.destroy();
                perfChartInstance=new Chart(ctx,{type:'bar',data:{labels:sorted.map(s=>s[0]),datasets:[{label:'Sales (₹)',data:sorted.map(s=>s[1].total),backgroundColor:['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee'],borderRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
            }
        }

        // ===== P&L =====
        function setPnlPeriod(period, btn) {
            document.querySelectorAll('#view-pnl .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            pnlPeriod=period;
            const now=new Date(); let start, end;
            if(period==='month'){start=new Date(now.getFullYear(),now.getMonth(),1);end=now;}
            else if(period==='lastmonth'){start=new Date(now.getFullYear(),now.getMonth()-1,1);end=new Date(now.getFullYear(),now.getMonth(),0);}
            else if(period==='week'){start=new Date(now);start.setDate(now.getDate()-now.getDay());start.setHours(0,0,0,0);end=now;}
            else{start=null;end=null;}
            document.getElementById('pnlStart').value=start?start.toISOString().split('T')[0]:'';
            document.getElementById('pnlEnd').value=end?end.toISOString().split('T')[0]:'';
        }
        function generatePnl() {
            const sVal=document.getElementById('pnlStart').value, eVal=document.getElementById('pnlEnd').value;
            const startMs=sVal?new Date(sVal).setHours(0,0,0,0):0, endMs=eVal?new Date(eVal).setHours(23,59,59,999):Infinity;
            let revenue=0,cost=0,totalQty=0; const itemProfitMap={};
            historyData.forEach(d=>{
                const oMs=d.time?d.time.toDate().getTime():0;
                if(oMs<startMs||oMs>endMs) return;
                revenue+=d.total;
                d.items.forEach(item=>{
                    totalQty+=item.qty;
                    const purchasePrice=productsMap[item.id]?.costPrice||productsMap[item.id]?.price||0;
                    const itemCost=purchasePrice*item.qty;
                    cost+=itemCost;
                    if(!itemProfitMap[item.id]) itemProfitMap[item.id]={profit:0,qty:0,revenue:0};
                    itemProfitMap[item.id].profit+=item.total-itemCost;
                    itemProfitMap[item.id].qty+=item.qty;
                    itemProfitMap[item.id].revenue+=item.total;
                });
            });
            let returnsDeduction=0;
            allReturnsData.forEach(r=>{const oMs=r.time?r.time.toDate().getTime():0;if(oMs>=startMs&&oMs<=endMs) returnsDeduction+=r.refundAmt||0;});
            const netProfit=revenue-cost-returnsDeduction;
            const margin=revenue>0?((netProfit/revenue)*100).toFixed(1):0;
            const profitColor=netProfit>=0?'var(--success)':'var(--danger)';
            const pp=netProfit>=0?'+':'';
            document.getElementById('pnlRevenue').innerText=`₹ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCost').innerText=`₹ ${cost.toFixed(2)}`;
            document.getElementById('pnlNet').innerText=`${pp}₹ ${netProfit.toFixed(2)}`; document.getElementById('pnlNet').style.color=profitColor;
            document.getElementById('pnlQty').innerText=totalQty;
            document.getElementById('pnlRevDetail').innerText=`₹ ${revenue.toFixed(2)}`;
            document.getElementById('pnlCostDetail').innerText=`₹ ${cost.toFixed(2)}`;
            document.getElementById('pnlReturnsDetail').innerText=`- ₹ ${returnsDeduction.toFixed(2)}`;
            document.getElementById('pnlMargin').innerText=`${margin}%`; document.getElementById('pnlMargin').style.color=parseFloat(margin)>=0?'var(--success)':'var(--danger)';
            document.getElementById('pnlNetDetail').innerText=`${pp}₹ ${netProfit.toFixed(2)}`; document.getElementById('pnlNetDetail').style.color=profitColor;
            const topItems=Object.entries(itemProfitMap).sort((a,b)=>b[1].profit-a[1].profit).slice(0,8);
            const topEl=document.getElementById('pnlTopItems'); topEl.innerHTML='';
            topItems.forEach(([name,stats])=>{
                const pc=stats.profit>=0?'var(--success)':'var(--danger)';
                topEl.innerHTML+=`<div class="pnl-row"><div><b>${name}</b><div style="font-size:11px;color:#94a3b8;">Qty: ${stats.qty} | Rev: ₹${stats.revenue.toFixed(0)}</div></div><span style="font-weight:700;color:${pc};">${stats.profit>=0?'+':''}₹${stats.profit.toFixed(2)}</span></div>`;
            });
            if(!topItems.length) topEl.innerHTML='<div style="color:#94a3b8;font-size:13px;text-align:center;padding:10px;">No data</div>';
            toast("P&L generated!","success");
        }

        // ===== VISITS =====
        let visitPeriodFilter2='all';
        function setVisitFilter(period, btn) {
            document.querySelectorAll('#view-visits .preset-btn').forEach(b=>b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            visitPeriodFilter2=period;
            renderVisits();
        }
        async function logVisit() {
            const shop=document.getElementById('visitShopSel').value;
            const note=document.getElementById('visitNote').value.trim();
            if(!shop) return toast("Select a shop","error");
            try{
                await db.collection("visits").add({shopName:shop,note,salesman:userData.name,time:firebase.firestore.FieldValue.serverTimestamp()});
                toast("Visit logged!","success"); document.getElementById('visitNote').value='';
            }catch(e){toast(e.message,"error");}
        }

        async function deleteVisit(docId) {
            try {
                const snap = await db.collection("visits").doc(docId).get();
                const data = snap.exists ? snap.data() : null;
                await db.collection("visits").doc(docId).delete();
                toast("🗑️ Visit deleted","success");
                pushUndo("Visit record deleted", async () => {
                    if(data) await db.collection("visits").doc(docId).set(data);
                });
            } catch(e) { toast(e.message,"error"); }
        }

        function renderVisits() {
            const area=document.getElementById('visitListArea');
            const salesmanF=document.getElementById('visitSalesmanFilter')?.value||'all';
            const now=new Date(); let startMs=0;
            if(visitPeriodFilter2==='today') startMs=new Date().setHours(0,0,0,0);
            else if(visitPeriodFilter2==='week'){const d=new Date(now);d.setDate(d.getDate()-d.getDay());d.setHours(0,0,0,0);startMs=d.getTime();}
            const vss=document.getElementById('visitShopSel');
            if(vss){vss.innerHTML='<option value="">-- Select Shop Visited --</option>';Object.keys(globalShops).forEach(k=>vss.innerHTML+=`<option value="${k}">${globalShops[k].name||k}</option>`);}
            let filtered=allVisitsData.filter(v=>{
                const vMs=v.time?v.time.toDate().getTime():0;
                if(startMs&&vMs<startMs) return false;
                if(salesmanF!=='all'&&v.salesman!==salesmanF) return false;
                if(userData.role!=='manager'&&v.salesman!==userData.name) return false;
                return true;
            });
            visitExportArray=filtered.map(v=>({Date:v.time?v.time.toDate().toLocaleString():'',Shop:v.shopName,Salesman:v.salesman,Note:v.note||''}));
            document.getElementById('visitCount').innerText=`(${filtered.length})`;
            area.innerHTML='';
            if(!filtered.length){area.innerHTML='<div style="text-align:center;padding:20px;color:#64748b;">No visits found.</div>';return;}
            filtered.forEach(v=>{
                const ts=v.time?v.time.toDate().toLocaleString():'';
                const safeDocId = v.docId ? v.docId.replace(/'/g,"\\'") : '';
                const canDelete = (userData.role==='manager' || v.salesman===userData.name);
                area.innerHTML+=`<div class="visit-card">
                    <div class="flex-between">
                        <div class="vc-shop">🏪 ${v.shopName}</div>
                        ${canDelete && safeDocId ? `<button class="action-btn action-btn-delete" onclick="deleteVisit('${safeDocId}')">🗑️</button>` : ''}
                    </div>
                    <div class="vc-meta">👤 ${v.salesman} &nbsp;|&nbsp; 🕐 ${ts}</div>
                    ${v.note?`<div style="margin-top:6px;font-size:13px;color:var(--text);">${v.note}</div>`:''}
                </div>`;
            });
        }

        // ===== PDF EXPORT: VISITS =====
        function exportVisitsPDF() {
            if (!visitExportArray.length) return toast('No visits to export', 'error');
            const { jsPDF } = window.jspdf;
            if (!jsPDF) return toast('jsPDF not loaded', 'error');

            toast('Generating PDF...');
            const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'landscape' });
            const pageW = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor(30, 41, 59);
            doc.text('Shop Visit Log', 14, 14);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            doc.text('Generated: ' + today + '  |  Total: ' + visitExportArray.length + ' visits', pageW - 14, 14, { align:'right' });

            doc.autoTable({
                head: [['Date & Time', 'Shop', 'Salesman', 'Notes']],
                body: visitExportArray.map(v => [v.Date || '', v.Shop || '', v.Salesman || '', v.Note || '—']),
                startY: 20,
                margin: { left: 10, right: 10 },
                styles: { font:'helvetica', fontSize:9, cellPadding:4, overflow:'linebreak', lineColor:[203,213,225], lineWidth:0.3, textColor:[26,26,46], valign:'middle', minCellHeight:8 },
                headStyles: { fillColor:[241,245,249], textColor:[26,26,46], fontStyle:'bold', fontSize:8.5, lineColor:[26,26,46], lineWidth:0.5 },
                alternateRowStyles: { fillColor:[248,250,252] },
                columnStyles: { 0:{cellWidth:38}, 1:{cellWidth:50}, 2:{cellWidth:38}, 3:{cellWidth:'auto'} },
                didDrawPage: (data) => {
                    doc.setFontSize(8); doc.setTextColor(148,163,184);
                    doc.text('Page ' + doc.internal.getCurrentPageInfo().pageNumber, pageW/2, doc.internal.pageSize.getHeight()-6, {align:'center'});
                },
                showHead: 'everyPage'
            });
            doc.save('Shop_Visits_' + today.replace(/ /g,'_') + '.pdf');
            toast('✅ PDF saved!', 'success');
        }

        // ===== SHOP NOTES / REMARKS =====
        let allShopNotes = [];
        const NOTE_TAG_LABELS = {
            general: '📌 General', payment: '💰 Payment',
            closed: '🚫 Closed Info', complaint: '⚠️ Complaint', preference: '⭐ Preference'
        };

        async function saveShopNote() {
            const shop = document.getElementById('noteShopSel').value;
            const text = document.getElementById('noteText').value.trim();
            const tag  = document.getElementById('noteTag').value;
            if (!shop) return toast('Please select a shop', 'error');
            if (!text) return toast('Please write a note', 'error');
            try {
                await db.collection('shop_notes').add({
                    shopName: shop, text, tag,
                    author: userData.name,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                toast('✅ Note saved!', 'success');
                document.getElementById('noteText').value = '';
            } catch(e) { toast(e.message, 'error'); }
        }

        async function deleteShopNote(docId) {
            if (!confirm('Delete this note?')) return;
            try {
                await db.collection('shop_notes').doc(docId).delete();
                toast('🗑️ Note deleted', 'success');
            } catch(e) { toast(e.message, 'error'); }
        }

        function renderShopNotes() {
            const area = document.getElementById('shopNotesArea');
            if (!area) return;
            const shopF = (document.getElementById('noteFilterShop')?.value) || 'all';
            const tagF  = (document.getElementById('noteFilterTag')?.value) || 'all';

            let filtered = allShopNotes.filter(n => {
                if (shopF !== 'all' && n.shopName !== shopF) return false;
                if (tagF  !== 'all' && n.tag !== tagF) return false;
                return true;
            });

            if (!filtered.length) {
                area.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">No notes found.</div>';
                return;
            }

            // Group by shop
            const byShop = {};
            filtered.forEach(n => {
                if (!byShop[n.shopName]) byShop[n.shopName] = [];
                byShop[n.shopName].push(n);
            });

            area.innerHTML = Object.entries(byShop).map(([shopName, notes]) => `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; font-weight:800; color:var(--primary); margin-bottom:6px;
                                text-transform:uppercase; letter-spacing:0.5px;">
                        🏪 ${shopName}
                        <span class="shop-note-badge">${notes.length} note${notes.length>1?'s':''}</span>
                    </div>
                    ${notes.map(n => {
                        const ts = n.time ? n.time.toDate().toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '—';
                        const canDel = userData.role === 'manager' || n.author === userData.name;
                        return `<div class="shop-note-card">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                                <div style="flex:1;">
                                    <span style="font-size:10px; font-weight:700; background:rgba(245,158,11,0.2);
                                           color:#b45309; border-radius:20px; padding:1px 8px;">
                                        ${NOTE_TAG_LABELS[n.tag] || n.tag}
                                    </span>
                                    <div class="note-text" style="margin-top:6px;">${n.text}</div>
                                    <div class="note-meta">👤 ${n.author} · 🕐 ${ts}</div>
                                </div>
                                ${canDel ? `<button onclick="deleteShopNote('${n.docId}')"
                                    style="background:none; border:none; cursor:pointer; font-size:14px;
                                           color:#94a3b8; padding:2px 4px; flex-shrink:0;"
                                    title="Delete">🗑️</button>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>`).join('');
        }

        function populateNoteShopSelects() {
            const sel = document.getElementById('noteShopSel');
            const filterSel = document.getElementById('noteFilterShop');
            if (!sel) return;
            const shops = Object.keys(globalShops).sort();
            sel.innerHTML = '<option value="">-- Select Shop --</option>' +
                shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            if (filterSel) {
                filterSel.innerHTML = '<option value="all">All Shops</option>' +
                    shops.map(s => `<option value="${s}">${globalShops[s].name || s}</option>`).join('');
            }
        }

        // ===== ORDER PANEL — DUE ALERT =====
        function showOrderDueAlert(shopName) {
            const el = document.getElementById('orderDueAlert');
            if (!el) return;
            if (!shopName) { el.style.display = 'none'; el.innerHTML = ''; return; }

            const { totalBill, totalPaid } = getShopDueStats(shopName);
            const remaining = totalBill - totalPaid;

            if (remaining <= 0) {
                // Cleared — show green tick briefly
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px 14px;
                                background:rgba(16,185,129,0.1); border:1.5px solid rgba(16,185,129,0.3);
                                border-radius:12px; font-size:13px;">
                        <span style="font-size:18px;">✅</span>
                        <div>
                            <div style="font-weight:700; color:#065f46;">No Pending Due</div>
                            <div style="font-size:11px; color:#047857;">This shop has cleared all payments</div>
                        </div>
                    </div>`;
            } else {
                const pct = totalBill > 0 ? Math.min(100, (totalPaid / totalBill) * 100) : 0;
                const isHigh = remaining > 5000;
                const borderCol = isHigh ? 'rgba(244,63,94,0.5)' : 'rgba(245,158,11,0.5)';
                const bgCol    = isHigh ? 'rgba(244,63,94,0.08)' : 'rgba(245,158,11,0.08)';
                const textCol  = isHigh ? '#be123c' : '#92400e';
                const icon     = isHigh ? '🔴' : '🟡';
                el.style.display = 'block';
                el.innerHTML = `
                    <div style="padding:12px 14px; background:${bgCol}; border:1.5px solid ${borderCol};
                                border-radius:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="font-size:18px;">${icon}</span>
                                <div>
                                    <div style="font-weight:800; font-size:13px; color:${textCol};">Pending Due Alert</div>
                                    <div style="font-size:10px; color:#64748b;">Collect payment before placing order</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px; font-weight:900; color:${textCol};">₹${remaining.toFixed(2)}</div>
                                <div style="font-size:10px; color:#64748b;">remaining</div>
                            </div>
                        </div>
                        <div style="background:rgba(0,0,0,0.06); border-radius:99px; height:6px; overflow:hidden; margin-bottom:6px;">
                            <div style="width:${pct.toFixed(0)}%; height:100%; border-radius:99px;
                                        background:${isHigh ? '#f43f5e' : '#f59e0b'}; transition:width 0.5s;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:#64748b;">
                            <span>Total Billed: ₹${totalBill.toFixed(2)}</span>
                            <span>Paid: ₹${totalPaid.toFixed(2)} (${pct.toFixed(0)}%)</span>
                        </div>
                    </div>`;
            }
        }

        // ===== SWITCH VIEW =====
        function updateBottomNav(view) {
            const map = { dashboard:'dashboard', order:'order', history:'history', stock:'stock' };
            document.querySelectorAll('.bn-item').forEach(b => b.classList.remove('bn-active'));
            const key = Object.keys(map).find(k => k === view);
            if (key) { const el = document.getElementById('bn-' + key); if(el) el.classList.add('bn-active'); }
        }

        function switchView(v) {
            document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
            const viewEl = document.getElementById('view-'+v);
            if(viewEl) viewEl.classList.add('active');
            document.getElementById('pageTitle').innerText=v==='admin'?'MANAGER PANEL':v.toUpperCase().replace(/-/g,' ');
            updateBottomNav(v);
            trackUsage(v);
            renderSidebar();
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow='';
            if(v==='order') {
                const al=document.getElementById('orderDueAlert');
                if(al){al.style.display='none';al.innerHTML='';}
                // If shop already selected (e.g. redirected from edit), show alert
                const os = document.getElementById('orderShop');
                if(os && os.value) showOrderDueAlert(os.value);
            }
            if(v==='salesman-perf') renderSalesmanPerf();
            if(v==='visits') renderVisits();
            if(v==='due') renderDueList();
            if(v==='returns') populateReturnOrderSel();
            if(v==='dashboard') renderQuickAccess();
            if(v==='shop-notes') { populateNoteShopSelects(); renderShopNotes(); }
            if(v==='attendance') { initAttendanceView(); }
            if(v==='reports') pwPopulateFilters();
            if(v==='admin') {
                document.getElementById('pageTitle').innerText = 'MANAGER PANEL';
                initIncentiveSettingsUI();
                populateIncSalesmanFilter();
                populateShopCreatedBySelect();
                restoreAdminCardStates();
            }
        }

        function pwPopulateFilters() {
            const shopSel = document.getElementById('pwShopFilter');
            if (!shopSel) return;
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id, d]) => {
                shopSel.innerHTML += `<option value="${id}">${d.name || id}</option>`;
            });
            shopSel.value = curShop;
            const smSel = document.getElementById('pwSalesmanFilter');
            if (!smSel) return;
            const curSm = smSel.value;
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => smSel.innerHTML += `<option value="${s}">${s}</option>`);
            smSel.value = curSm;

            // Populate salesman filters for other new reports
            ['swSalesmanFilter','slTableBody','trSalesmanFilter'].forEach(id => {
                const el = document.getElementById(id);
                if (!el || el.tagName !== 'SELECT') return;
                const cur = el.value;
                el.innerHTML = '<option value="all">All Salesmen</option>';
                smSet.forEach(s => el.innerHTML += `<option value="${s}">${s}</option>`);
                el.value = cur;
            });
            // Trend report shop filter
            const trShopSel = document.getElementById('trShopFilter');
            if (trShopSel) {
                const cur = trShopSel.value;
                trShopSel.innerHTML = '<option value="all">All Shops</option>';
                Object.entries(globalShops).forEach(([id,d]) => trShopSel.innerHTML+=`<option value="${id}">${d.name||id}</option>`);
                trShopSel.value = cur;
            }
        }

        function renderOfflineQueueList() {
            const q = getOfflineQueue();
            const el = document.getElementById('offlineQueueList');
            const badge = document.getElementById('offlineBadgeMgr');
            if (!el) return;
            if (badge) badge.textContent = q.length > 0 ? q.length : '';
            if (!q.length) {
                el.innerHTML = '<div style="color:#10b981; font-size:13px; font-weight:600;">✅ No pending orders.</div>';
                return;
            }
            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            q.forEach((item, i) => {
                const t = new Date(item.localTime).toLocaleString('en-GB');
                html += `<div style="background:var(--bg); border-radius:12px; padding:12px; border:1px solid var(--border);">
                    <div style="font-weight:700; font-size:13px;">🏪 ${item.shopName}</div>
                    <div style="font-size:11px; color:#64748b; margin-top:2px;">📅 ${t} &nbsp;·&nbsp; ${item.items.length} items &nbsp;·&nbsp; <b>₹${item.total.toFixed(2)}</b></div>
                </div>`;
            });
            html += '</div>';
            el.innerHTML = html;
        }

        // ===== HELPER: date preset for new reports =====
        function _applyDatePresetTo(preset, startId, endId, gridEl) {
            if (gridEl) gridEl.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            const today = new Date();
            let start = null, end = null;
            if (preset==='today')     { start = end = new Date(today); }
            else if (preset==='week') { start = new Date(today); start.setDate(today.getDate()-today.getDay()); end = new Date(today); }
            else if (preset==='month'){ start = new Date(today.getFullYear(),today.getMonth(),1); end = new Date(today); }
            else if (preset==='lastmonth'){ start = new Date(today.getFullYear(),today.getMonth()-1,1); end = new Date(today.getFullYear(),today.getMonth(),0); }
            else if (preset==='all')  { document.getElementById(startId).value=''; document.getElementById(endId).value=''; return; }
            if (start) document.getElementById(startId).value = start.toISOString().split('T')[0];
            if (end)   document.getElementById(endId).value   = end.toISOString().split('T')[0];
        }
        function _filterHistory(startId, endId) {
            const sVal=document.getElementById(startId).value, eVal=document.getElementById(endId).value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            return historyData.filter(d => {
                const ms = d.time ? d.time.toDate().getTime() : 0;
                return ms >= startMs && ms <= endMs;
            });
        }
        function _destroyChart(instance) { if (instance) { try { instance.destroy(); } catch(e){} } return null; }

        // ===== SHOP-WISE REPORT =====
        let swDataArray = [], swBarChartInst = null;
        function swApplyPreset(p,btn){ _applyDatePresetTo(p,'swStartDate','swEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function swClearPresets(){ document.getElementById('swStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetShopWiseReport(){ document.getElementById('swStartDate').value=''; document.getElementById('swEndDate').value=''; document.getElementById('swResultArea').style.display='none'; }

        function generateShopWiseReport() {
            const salesmanF = document.getElementById('swSalesmanFilter').value;
            const areaF = document.getElementById('swAreaFilter').value;

            // Populate salesman select
            const smSel = document.getElementById('swSalesmanFilter');
            const cur = smSel.value;
            const smSet = new Set(); historyData.forEach(d=>smSet.add(d.salesman));
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s=>{ if(s) smSel.innerHTML+=`<option value="${s}">${s}</option>`; });
            smSel.value = cur;

            // Filter history by date + salesman
            let rows = _filterHistory('swStartDate','swEndDate').filter(d=>salesmanF==='all'||d.salesman===salesmanF);

            // Filter by area: find shops in the selected area
            if (areaF !== 'all') {
                const shopsInArea = new Set(
                    Object.entries(globalShops)
                        .filter(([id,d]) => (d.area||'')=== areaF)
                        .map(([id,d]) => d.name || id)
                );
                rows = rows.filter(d => shopsInArea.has(d.shopName));
            }

            if (!rows.length) { toast('No data found!','error'); return; }

            const shopMap = {};
            rows.forEach(d => {
                if (!shopMap[d.shopName]) shopMap[d.shopName] = { revenue:0, orders:0 };
                shopMap[d.shopName].revenue += d.total;
                shopMap[d.shopName].orders  += 1;
            });
            const sortBy = document.getElementById('swSortBy').value;
            swDataArray = Object.entries(shopMap).map(([name,v])=>({
                Shop: name,
                Area: (Object.values(globalShops).find(s=>(s.name||'')=== name)||{}).area || '—',
                Orders: v.orders,
                'Revenue (₹)': parseFloat(v.revenue.toFixed(2)),
                'Avg/Order (₹)': parseFloat((v.revenue/v.orders).toFixed(2)),
                _rev: v.revenue, _ord: v.orders
            }));
            const totalRev = swDataArray.reduce((s,r)=>s+r._rev,0);
            swDataArray.forEach(r=>r['Share (%)']=totalRev>0?parseFloat(((r._rev/totalRev)*100).toFixed(1)):0);
            if (sortBy==='revenue') swDataArray.sort((a,b)=>b._rev-a._rev);
            else if (sortBy==='orders') swDataArray.sort((a,b)=>b._ord-a._ord);
            else if (sortBy==='avg')    swDataArray.sort((a,b)=>b['Avg/Order (₹)']-a['Avg/Order (₹)']);
            else swDataArray.sort((a,b)=>a.Shop.localeCompare(b.Shop));

            document.getElementById('swTotalShops').innerText   = swDataArray.length;
            document.getElementById('swTotalOrders').innerText  = swDataArray.reduce((s,r)=>s+r.Orders,0);
            document.getElementById('swTotalRevenue').innerText = '₹ '+totalRev.toFixed(2);
            document.getElementById('swTableCount').innerText   = `(${swDataArray.length} shops${areaF!=='all'?' · '+areaF:''})`;

            // Table
            const medals=['🥇','🥈','🥉'];
            document.getElementById('swTableBody').innerHTML = swDataArray.map((r,i)=>`<tr>
                <td style="font-weight:800; text-align:center;">${medals[i]||'#'+(i+1)}</td>
                <td>
                    <div style="font-weight:700;">${r.Shop}</div>
                    ${r.Area && r.Area!=='—' ? `<div style="font-size:10px; color:#b45309; background:rgba(245,158,11,0.1); border-radius:6px; padding:1px 6px; display:inline-block; margin-top:3px;">🗺️ ${r.Area}</div>` : ''}
                    <div style="background:var(--border);border-radius:99px;height:4px;margin-top:4px;overflow:hidden;">
                        <div style="width:${r['Share (%)'].toFixed(0)}%;height:100%;background:linear-gradient(90deg,var(--primary),#6366f1);border-radius:99px;"></div>
                    </div>
                </td>
                <td style="color:#64748b;">${r.Orders}</td>
                <td style="color:var(--success);font-weight:800;">₹${r['Revenue (₹)'].toFixed(2)}</td>
                <td style="color:#64748b;">₹${r['Avg/Order (₹)'].toFixed(2)}</td>
                <td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Share (%)'].toFixed(1)}%</span></td>
            </tr>`).join('');

            // Chart (top 10)
            const top10 = swDataArray.slice(0,10);
            const colors=['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16'];
            swBarChartInst = _destroyChart(swBarChartInst);
            swBarChartInst = new Chart(document.getElementById('swBarChart').getContext('2d'),{
                type:'bar',
                data:{ labels:top10.map(r=>r.Shop.length>12?r.Shop.substring(0,10)+'…':r.Shop), datasets:[{label:'Revenue (₹)',data:top10.map(r=>r._rev),backgroundColor:colors,borderRadius:8,borderSkipped:false}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'₹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:10}}}}}
            });
            document.getElementById('swResultArea').style.display='block';
            toast('✅ Shop report generated!','success');
        }

        // ===== SALESMAN PERFORMANCE REPORT =====
        let slDataArray=[], slBarChartInst=null, slOrderChartInst=null;
        function slApplyPreset(p,btn){ _applyDatePresetTo(p,'slStartDate','slEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function slClearPresets(){ document.getElementById('slStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetSalesmanReport(){ document.getElementById('slStartDate').value=''; document.getElementById('slEndDate').value=''; document.getElementById('slResultArea').style.display='none'; }

        function generateSalesmanReport() {
            const rows = _filterHistory('slStartDate','slEndDate');
            if (!rows.length) { toast('No data found!','error'); return; }

            const smMap = {};
            rows.forEach(d => {
                const s = d.salesman || 'Unknown';
                if (!smMap[s]) smMap[s] = { revenue:0, orders:0, shops:new Set() };
                smMap[s].revenue += d.total;
                smMap[s].orders  += 1;
                smMap[s].shops.add(d.shopName);
            });
            const totalRev = Object.values(smMap).reduce((s,v)=>s+v.revenue,0);
            slDataArray = Object.entries(smMap).map(([name,v])=>({
                Salesman: name, Orders: v.orders,
                'Revenue (₹)': parseFloat(v.revenue.toFixed(2)),
                'Avg/Order (₹)': parseFloat((v.revenue/v.orders).toFixed(2)),
                'Unique Shops': v.shops.size,
                'Share (%)': totalRev>0 ? parseFloat(((v.revenue/totalRev)*100).toFixed(1)) : 0,
                _rev: v.revenue, _ord: v.orders
            })).sort((a,b)=>b._rev-a._rev);

            document.getElementById('slTotalSalesmen').innerText  = slDataArray.length;
            document.getElementById('slTotalOrders').innerText    = slDataArray.reduce((s,r)=>s+r.Orders,0);
            document.getElementById('slTotalRevenue').innerText   = '₹ '+totalRev.toFixed(2);
            document.getElementById('slTableCount').innerText     = `(${slDataArray.length} salesmen)`;

            const medals=['🥇','🥈','🥉'];
            const colors=['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee'];
            document.getElementById('slTableBody').innerHTML = slDataArray.map((r,i)=>`<tr>
                <td style="font-weight:800;font-size:16px;text-align:center;">${medals[i]||'#'+(i+1)}</td>
                <td style="font-weight:700;">${r.Salesman}</td>
                <td>${r.Orders}</td>
                <td style="color:var(--success);font-weight:800;">₹${r['Revenue (₹)'].toFixed(2)}</td>
                <td style="color:#64748b;">₹${r['Avg/Order (₹)'].toFixed(2)}</td>
                <td>${r['Unique Shops']}</td>
                <td><span style="background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Share (%)'].toFixed(1)}%</span></td>
            </tr>`).join('');

            slBarChartInst = _destroyChart(slBarChartInst);
            slBarChartInst = new Chart(document.getElementById('slBarChart').getContext('2d'),{
                type:'bar', data:{labels:slDataArray.map(r=>r.Salesman),datasets:[{label:'Revenue',data:slDataArray.map(r=>r._rev),backgroundColor:colors,borderRadius:6}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'₹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}}}}
            });
            slOrderChartInst = _destroyChart(slOrderChartInst);
            slOrderChartInst = new Chart(document.getElementById('slOrderChart').getContext('2d'),{
                type:'doughnut', data:{labels:slDataArray.map(r=>r.Salesman),datasets:[{data:slDataArray.map(r=>r._ord),backgroundColor:colors,borderWidth:2}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},boxWidth:10}}}}
            });
            document.getElementById('slResultArea').style.display='block';
            toast('✅ Salesman report generated!','success');
        }

        // ===== SALES TREND REPORT =====
        let trDataArray=[], trLineChartInst=null;
        function resetTrendReport(){ document.getElementById('trStartDate').value=''; document.getElementById('trEndDate').value=''; document.getElementById('trResultArea').style.display='none'; }

        function generateTrendReport() {
            const groupBy = document.querySelector('input[name="trendGroup"]:checked').value;
            const shopF   = document.getElementById('trShopFilter').value;
            const salesmanF = document.getElementById('trSalesmanFilter').value;

            // Populate filters
            const shopSel = document.getElementById('trShopFilter');
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id,d])=>shopSel.innerHTML+=`<option value="${id}">${d.name||id}</option>`);
            shopSel.value = curShop;
            const smSel = document.getElementById('trSalesmanFilter');
            const curSm = smSel.value;
            const smSet=new Set(); historyData.forEach(d=>smSet.add(d.salesman));
            smSel.innerHTML='<option value="all">All Salesmen</option>';
            smSet.forEach(s=>{ if(s) smSel.innerHTML+=`<option value="${s}">${s}</option>`; });
            smSel.value = curSm;

            const rows = _filterHistory('trStartDate','trEndDate')
                .filter(d=>(shopF==='all'||d.shopName===shopF)&&(salesmanF==='all'||d.salesman===salesmanF));
            if (!rows.length) { toast('No data found!','error'); return; }

            const buckets = {};
            rows.forEach(d => {
                const dt = d.time ? d.time.toDate() : new Date();
                let key;
                if (groupBy==='daily')        key = dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
                else if (groupBy==='weekly')  { const wStart=new Date(dt); wStart.setDate(dt.getDate()-dt.getDay()); key='W/'+wStart.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
                else                           key = dt.toLocaleDateString('en-GB',{month:'short',year:'numeric'});
                if (!buckets[key]) buckets[key]={revenue:0,orders:0,qty:0,_ts:dt.getTime()};
                buckets[key].revenue += d.total;
                buckets[key].orders  += 1;
                buckets[key].qty     += d.items.reduce((s,i)=>s+i.qty,0);
            });

            const sorted = Object.entries(buckets).sort((a,b)=>a[1]._ts-b[1]._ts);
            const totalRev = sorted.reduce((s,[,v])=>s+v.revenue,0);
            const avgRev   = sorted.length ? totalRev/sorted.length : 0;
            const peakEntry= sorted.reduce((max,cur)=>cur[1].revenue>max[1].revenue?cur:max, sorted[0]);

            document.getElementById('trPeakPeriod').innerText  = peakEntry[0];
            document.getElementById('trPeakRevenue').innerText = '₹ '+peakEntry[1].revenue.toFixed(2);
            document.getElementById('trAvgRevenue').innerText  = '₹ '+avgRev.toFixed(2);
            document.getElementById('trTableCount').innerText  = `(${sorted.length} periods)`;

            trDataArray = sorted.map(([period,v],i)=>({
                Period:period, Orders:v.orders, 'Revenue (₹)':parseFloat(v.revenue.toFixed(2)),
                'Qty Sold':v.qty,
                'vs Prev %': i>0?parseFloat((((v.revenue-sorted[i-1][1].revenue)/sorted[i-1][1].revenue)*100).toFixed(1)):0
            }));

            document.getElementById('trTableBody').innerHTML = trDataArray.map((r,i)=>{
                const chg = r['vs Prev %'];
                const chgHtml = i===0?'—':`<span style="color:${chg>=0?'var(--success)':'var(--danger)'};font-weight:700;">${chg>=0?'▲':'▼'}${Math.abs(chg)}%</span>`;
                return `<tr>
                    <td style="font-weight:700;">${r.Period}</td>
                    <td>${r.Orders}</td>
                    <td style="color:var(--success);font-weight:700;">₹${r['Revenue (₹)'].toFixed(2)}</td>
                    <td>${r['Qty Sold']}</td>
                    <td>${chgHtml}</td>
                </tr>`;
            }).join('');

            trLineChartInst = _destroyChart(trLineChartInst);
            trLineChartInst = new Chart(document.getElementById('trLineChart').getContext('2d'),{
                type: sorted.length<=10?'bar':'line',
                data:{ labels:sorted.map(([k])=>k), datasets:[
                    {label:'Revenue (₹)',data:sorted.map(([,v])=>v.revenue),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',fill:true,tension:0.4,borderWidth:2,pointRadius:4,borderRadius:6,borderSkipped:false}
                ]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'₹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:10},maxRotation:45}}}}
            });
            document.getElementById('trResultArea').style.display='block';
            toast('✅ Trend report generated!','success');
        }

        // ===== PROFIT & MARGIN REPORT =====
        let pmDataArray=[], pmBarChartInst=null;
        function pmApplyPreset(p,btn){ _applyDatePresetTo(p,'pmStartDate','pmEndDate',btn.closest('.date-preset-grid')); btn.classList.add('active-preset'); }
        function pmClearPresets(){ document.getElementById('pmStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active-preset')); }
        function resetProfitReport(){ document.getElementById('pmStartDate').value=''; document.getElementById('pmEndDate').value=''; document.getElementById('pmResultArea').style.display='none'; }

        function generateProfitReport() {
            const rows = _filterHistory('pmStartDate','pmEndDate');
            if (!rows.length) { toast('No data found!','error'); return; }

            const productMap = {};
            rows.forEach(d => {
                d.items.forEach(item => {
                    const cp = (productsMap[item.id]||{}).costPrice || 0;
                    if (!productMap[item.id]) productMap[item.id] = { qty:0, revenue:0, cost:0, costKnown: cp>0 };
                    productMap[item.id].qty     += item.qty;
                    productMap[item.id].revenue += (item.total || item.qty*(item.price||0));
                    productMap[item.id].cost    += item.qty * cp;
                    if (cp>0) productMap[item.id].costKnown = true;
                });
            });

            let totalRev=0, totalCost=0;
            pmDataArray = Object.entries(productMap).map(([name,v])=>{
                const profit = v.revenue - v.cost;
                const margin = v.revenue>0 ? (profit/v.revenue)*100 : 0;
                totalRev  += v.revenue;
                totalCost += v.cost;
                return { Product:name, 'Qty Sold':v.qty,
                    'Revenue (₹)':parseFloat(v.revenue.toFixed(2)),
                    'Cost (₹)':parseFloat(v.cost.toFixed(2)),
                    'Profit (₹)':parseFloat(profit.toFixed(2)),
                    'Margin (%)':parseFloat(margin.toFixed(1)),
                    _rev:v.revenue, _profit:profit, _margin:margin, _costKnown:v.costKnown };
            }).sort((a,b)=>b._profit-a._profit);

            const netProfit = totalRev - totalCost;
            const netMargin = totalRev>0 ? (netProfit/totalRev)*100 : 0;

            document.getElementById('pmRevenue').innerText  = '₹ '+totalRev.toFixed(2);
            document.getElementById('pmCost').innerText     = '₹ '+totalCost.toFixed(2);
            document.getElementById('pmNetProfit').innerText= '₹ '+netProfit.toFixed(2);
            document.getElementById('pmNetProfit').style.color = netProfit>=0?'var(--success)':'var(--danger)';
            document.getElementById('pmMargin').innerText   = netMargin.toFixed(1)+'%';
            document.getElementById('pmMargin').style.color = netMargin>=0?'var(--success)':'var(--danger)';
            document.getElementById('pmTableCount').innerText=`(${pmDataArray.length} products)`;

            document.getElementById('pmTableBody').innerHTML = pmDataArray.map(r=>{
                const profitColor = r['Profit (₹)']>=0?'var(--success)':'var(--danger)';
                const marginColor = r['Margin (%)']>=20?'var(--success)':r['Margin (%)']>=10?'var(--warning)':'var(--danger)';
                const noCost = !r._costKnown ? `<span style="font-size:10px;color:#94a3b8;" title="Cost price not set">⚠️</span>` : '';
                return `<tr>
                    <td style="font-weight:700;">${r.Product} ${noCost}</td>
                    <td>${r['Qty Sold']}</td>
                    <td style="color:var(--primary);">₹${r['Revenue (₹)'].toFixed(2)}</td>
                    <td style="color:var(--danger);">₹${r['Cost (₹)'].toFixed(2)}</td>
                    <td style="color:${profitColor};font-weight:800;">₹${r['Profit (₹)'].toFixed(2)}</td>
                    <td><span style="background:rgba(16,185,129,0.1);color:${marginColor};padding:2px 8px;border-radius:20px;font-weight:700;font-size:11px;">${r['Margin (%)'].toFixed(1)}%</span></td>
                </tr>`;
            }).join('');

            // Top margin products (with cost known)
            const topMargin = pmDataArray.filter(r=>r._costKnown&&r._rev>0).sort((a,b)=>b._margin-a._margin).slice(0,3);
            const gradients=['rgba(16,185,129,0.1)','rgba(99,102,241,0.08)','rgba(245,158,11,0.08)'];
            document.getElementById('pmTopMargin').innerHTML = topMargin.length ? topMargin.map((r,i)=>`
                <div style="background:${gradients[i]};border-radius:10px;padding:10px 12px;margin-bottom:8px;">
                    <div style="font-weight:700;font-size:12px;">${r.Product}</div>
                    <div style="font-size:11px;color:#64748b;margin-top:3px;">
                        <span style="color:var(--success);font-weight:700;">${r['Margin (%)'].toFixed(1)}% margin</span>
                        &nbsp;·&nbsp; Profit ₹${r['Profit (₹)'].toFixed(0)}
                    </div>
                </div>`).join('') : '<div style="color:#94a3b8;font-size:12px;padding:10px;">Set cost prices to see margin leaders</div>';

            // Bar chart: revenue vs cost vs profit
            const top8 = pmDataArray.slice(0,8);
            pmBarChartInst = _destroyChart(pmBarChartInst);
            pmBarChartInst = new Chart(document.getElementById('pmBarChart').getContext('2d'),{
                type:'bar',
                data:{ labels:top8.map(r=>r.Product.length>10?r.Product.substring(0,8)+'…':r.Product),
                    datasets:[
                        {label:'Revenue',data:top8.map(r=>r._rev),backgroundColor:'rgba(99,102,241,0.7)',borderRadius:4},
                        {label:'Cost',data:top8.map(r=>r['Cost (₹)']),backgroundColor:'rgba(244,63,94,0.6)',borderRadius:4},
                        {label:'Profit',data:top8.map(r=>r._profit),backgroundColor:'rgba(16,185,129,0.7)',borderRadius:4}
                    ]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:9},boxWidth:10}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'₹'+(v>=1000?(v/1000).toFixed(1)+'k':v)}},x:{ticks:{font:{size:9}}}}}
            });
            document.getElementById('pmResultArea').style.display='block';
            toast('✅ Profit report generated!','success');
        }

        // ===== INCENTIVE RATES (localStorage) =====
        const INC_RATES_KEY = 'owm_incentive_rates';

        function loadIncentiveRates() {
            try {
                const saved = JSON.parse(localStorage.getItem(INC_RATES_KEY) || '{}');
                return {
                    shopCreator: saved.shopCreator !== undefined ? saved.shopCreator : 1.0,
                    orderTaker:  saved.orderTaker  !== undefined ? saved.orderTaker  : 0.5
                };
            } catch(e) { return { shopCreator: 1.0, orderTaker: 0.5 }; }
        }

        function saveIncentiveRates() {
            const sc = parseFloat(document.getElementById('incShopCreatorPct').value);
            const ot = parseFloat(document.getElementById('incOrderTakerPct').value);
            if (isNaN(sc) || isNaN(ot) || sc < 0 || ot < 0) return toast('Invalid rates!', 'error');
            localStorage.setItem(INC_RATES_KEY, JSON.stringify({ shopCreator: sc, orderTaker: ot }));
            const el = document.getElementById('incCurrentRates');
            el.style.display = 'block';
            document.getElementById('incCurrentRatesText').innerHTML =
                `✅ Saved — Shop Creator: <b>${sc}%</b> &nbsp;|&nbsp; Order Taker: <b>${ot}%</b>`;
            toast(`✅ Rates saved! Shop Creator: ${sc}% | Order Taker: ${ot}%`, 'success');
        }

        function initIncentiveSettingsUI() {
            const rates = loadIncentiveRates();
            // Sync the separate Settings card inputs (if present)
            const sc = document.getElementById('incShopCreatorPct');
            const ot = document.getElementById('incOrderTakerPct');
            if (sc) sc.value = rates.shopCreator;
            if (ot) ot.value  = rates.orderTaker;
            // Sync the inline Calculator inputs
            const cc = document.getElementById('incCalcCreatorPct');
            const co = document.getElementById('incCalcOrderPct');
            if (cc) cc.value = rates.shopCreator;
            if (co) co.value  = rates.orderTaker;
            // Show current rates note in Settings card
            const el = document.getElementById('incCurrentRates');
            if (el) {
                el.style.display = 'block';
                document.getElementById('incCurrentRatesText').innerHTML =
                    `Current rates — Shop Creator: <b>${rates.shopCreator}%</b> &nbsp;|&nbsp; Order Taker: <b>${rates.orderTaker}%</b>`;
            }
            incPreviewRates();
        }

        function incPreviewRates() {
            const cc = document.getElementById('incCalcCreatorPct');
            const co = document.getElementById('incCalcOrderPct');
            const pl = document.getElementById('incRatePreviewLine');
            if (!cc || !co || !pl) return;
            const sc = parseFloat(cc.value) || 0;
            const ot = parseFloat(co.value) || 0;
            pl.innerHTML = `Example: ₹10,000 billing → Creator earns <b>₹${(10000*sc/100).toFixed(0)}</b> &nbsp;|&nbsp; Order Taker earns <b>₹${(10000*ot/100).toFixed(0)}</b>`;
        }

        function incSaveRatesInline() {
            const sc = parseFloat(document.getElementById('incCalcCreatorPct').value);
            const ot = parseFloat(document.getElementById('incCalcOrderPct').value);
            if (isNaN(sc) || isNaN(ot) || sc < 0 || ot < 0) return toast('Invalid rates!', 'error');
            localStorage.setItem(INC_RATES_KEY, JSON.stringify({ shopCreator: sc, orderTaker: ot }));
            // Also sync the separate Settings card if open
            const sc2 = document.getElementById('incShopCreatorPct');
            const ot2 = document.getElementById('incOrderTakerPct');
            if (sc2) sc2.value = sc;
            if (ot2) ot2.value  = ot;
            const btn = document.getElementById('incSaveRateBtn');
            if (btn) { btn.textContent = '✅ Saved!'; setTimeout(() => btn.textContent = '💾 Save Rates', 2000); }
            toast(`✅ Rates saved! Shop Creator: ${sc}% | Order Taker: ${ot}%`, 'success');
        }

        function populateShopCreatedBySelect() {
            const sel = document.getElementById('shopCreatedBy');
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="">-- Select Salesman --</option>';
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            // Also add from users if available
            smSet.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (cur) sel.value = cur;
        }

        // ===== INCENTIVE CALCULATOR =====
        let incExportArray = [];

        function incApplyPreset(p, btn) {
            btn.closest('.date-preset-grid').querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            _applyDatePresetTo(p, 'incStartDate', 'incEndDate', null);
        }
        function incClearPresets() {
            const body = document.getElementById('incStartDate').closest('.collapse-body');
            if (body) body.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
        }

        function populateIncSalesmanFilter() {
            const sel = document.getElementById('incSalesmanFilter');
            if (!sel) return;
            const cur = sel.value;
            const smSet = new Set();
            historyData.forEach(d => { if(d.salesman) smSet.add(d.salesman); });
            sel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (cur) sel.value = cur;
        }

        function calculateIncentive() {
            // Read rates from inline inputs (most up-to-date values)
            const creatorPctEl = document.getElementById('incCalcCreatorPct');
            const orderPctEl   = document.getElementById('incCalcOrderPct');
            const rates = {
                shopCreator: creatorPctEl ? (parseFloat(creatorPctEl.value) || 0) : loadIncentiveRates().shopCreator,
                orderTaker:  orderPctEl   ? (parseFloat(orderPctEl.value)   || 0) : loadIncentiveRates().orderTaker
            };
            const sVal = document.getElementById('incStartDate').value;
            const eVal = document.getElementById('incEndDate').value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            const salesmanF = document.getElementById('incSalesmanFilter').value;

            // Filter orders by date
            const orders = historyData.filter(d => {
                const ms = d.time ? d.time.toDate().getTime() : 0;
                return ms >= startMs && ms <= endMs;
            });

            if (!orders.length) { toast('No orders found for selected period!', 'error'); return; }

            // Build salesman map: { name: { orderTakerRev, creatorRev, orders, createdShops } }
            const smMap = {};
            const ensureSm = name => {
                if (!smMap[name]) smMap[name] = { orderTakerRev: 0, creatorRev: 0, orders: 0, createdShops: new Set() };
            };

            orders.forEach(d => {
                const taker = d.salesman || 'Unknown';
                ensureSm(taker);
                smMap[taker].orderTakerRev += d.total;
                smMap[taker].orders += 1;

                // Check who created this shop
                const shopData = globalShops[d.shopName] || globalShops[Object.keys(globalShops).find(k => globalShops[k].name === d.shopName)] || null;
                const creator = shopData ? (shopData.createdBy || '') : '';
                if (creator && creator !== taker) {
                    ensureSm(creator);
                    smMap[creator].creatorRev += d.total;
                    smMap[creator].createdShops.add(d.shopName);
                } else if (creator && creator === taker) {
                    // same person took order & created shop — both incentives apply
                    smMap[taker].creatorRev += d.total;
                    smMap[taker].createdShops.add(d.shopName);
                }
            });

            // Build results
            const results = Object.entries(smMap)
                .filter(([name]) => salesmanF === 'all' || name === salesmanF)
                .map(([name, v]) => {
                    const creatorInc  = (v.creatorRev  * rates.shopCreator) / 100;
                    const orderInc    = (v.orderTakerRev * rates.orderTaker)  / 100;
                    const totalInc    = creatorInc + orderInc;
                    return { name, ...v, creatorInc, orderInc, totalInc };
                })
                .sort((a, b) => b.totalInc - a.totalInc);

            if (!results.length) { toast('No data for selected salesman!', 'error'); return; }

            const totalRev = results.reduce((s,r) => s + r.orderTakerRev, 0);
            const totalPayout = results.reduce((s,r) => s + r.totalInc, 0);

            document.getElementById('incTotalRevenue').innerText = '₹ ' + totalRev.toFixed(2);
            document.getElementById('incTotalPayout').innerText  = '₹ ' + totalPayout.toFixed(2);
            document.getElementById('incRateBanner').innerHTML   =
                `📌 Applied Rates — Shop Creator: <b>${rates.shopCreator}%</b> of shop's billing &nbsp;|&nbsp; Order Taker: <b>${rates.orderTaker}%</b> of order amount`;

            const medals = ['🥇','🥈','🥉'];
            const colors = ['rgba(99,102,241,0.08)','rgba(16,185,129,0.07)','rgba(245,158,11,0.07)'];
            const borderColors = ['rgba(99,102,241,0.3)','rgba(16,185,129,0.25)','rgba(245,158,11,0.25)'];

            document.getElementById('incCardsArea').innerHTML = results.map((r, i) => {
                const medal = medals[i] || `#${i+1}`;
                const bg     = colors[Math.min(i,2)];
                const border = borderColors[Math.min(i,2)];
                const hasCreator = r.creatorRev > 0;
                const hasOrder   = r.orderTakerRev > 0;
                return `<div style="background:${bg}; border:1.5px solid ${border}; border-radius:16px; padding:16px; margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:22px;">${medal}</span>
                            <div>
                                <div style="font-weight:800; font-size:15px;">${r.name}</div>
                                <div style="font-size:11px; color:#64748b;">${r.orders} orders &nbsp;·&nbsp; ${r.createdShops.size} shops created</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#64748b; font-weight:600;">TOTAL INCENTIVE</div>
                            <div style="font-size:22px; font-weight:900; color:var(--warning);">₹${r.totalInc.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="border-top:1px solid var(--border); padding-top:12px; display:flex; flex-direction:column; gap:8px;">
                        ${hasOrder ? `<div style="display:flex; justify-content:space-between; align-items:center; background:rgba(99,102,241,0.07); border-radius:10px; padding:10px 12px;">
                            <div>
                                <div style="font-size:12px; font-weight:700; color:var(--primary);">📦 Order Taker Incentive</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Revenue: ₹${r.orderTakerRev.toFixed(2)} × ${rates.orderTaker}%</div>
                            </div>
                            <div style="font-size:16px; font-weight:800; color:var(--primary);">₹${r.orderInc.toFixed(2)}</div>
                        </div>` : ''}
                        ${hasCreator ? `<div style="display:flex; justify-content:space-between; align-items:center; background:rgba(16,185,129,0.07); border-radius:10px; padding:10px 12px;">
                            <div>
                                <div style="font-size:12px; font-weight:700; color:var(--success);">🏪 Shop Creator Incentive</div>
                                <div style="font-size:11px; color:#64748b; margin-top:2px;">Shop billing: ₹${r.creatorRev.toFixed(2)} × ${rates.shopCreator}%</div>
                                <div style="font-size:10px; color:#94a3b8; margin-top:1px;">Shops: ${[...r.createdShops].join(', ')}</div>
                            </div>
                            <div style="font-size:16px; font-weight:800; color:var(--success);">₹${r.creatorInc.toFixed(2)}</div>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');

            // Build export array
            incExportArray = results.map(r => ({
                'Salesman': r.name,
                'Orders': r.orders,
                'Shops Created': r.createdShops.size,
                'Order Revenue (₹)': parseFloat(r.orderTakerRev.toFixed(2)),
                'Shop Billing (₹)': parseFloat(r.creatorRev.toFixed(2)),
                [`Order Incentive (${rates.orderTaker}%) (₹)`]: parseFloat(r.orderInc.toFixed(2)),
                [`Creator Incentive (${rates.shopCreator}%) (₹)`]: parseFloat(r.creatorInc.toFixed(2)),
                'Total Incentive (₹)': parseFloat(r.totalInc.toFixed(2))
            }));

            document.getElementById('incResultArea').style.display = 'block';
            toast(`✅ Incentive calculated for ${results.length} salesman!`, 'success');
        }

        async function manualSync() {
            if (!isOnline) return toast('📵 Still offline. Please connect to the internet.', 'error');
            await syncOfflineQueue();
            renderOfflineQueueList();
        }

        // ===== PRODUCT-WISE SALES REPORT =====
        let pwDataArray = [];
        let pwSortKey = 'revenue';
        let pwSortDir = -1; // -1 = desc, 1 = asc
        let pwBarChartInstance = null;
        let pwPieChartInstance = null;

        function pwApplyPreset(preset, btn) {
            document.querySelectorAll('.collapsible-section .date-preset-grid .preset-btn').forEach(b => {
                if (b.closest('#pwResultArea') === null) b.classList.remove('active-preset');
            });
            // target only the pw preset buttons
            btn.closest('.date-preset-grid').querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active-preset'));
            btn.classList.add('active-preset');
            const today = new Date();
            let start = null, end = null;
            if (preset === 'today') { start = end = new Date(today); }
            else if (preset === 'yesterday') { const yd = new Date(today); yd.setDate(yd.getDate()-1); start = end = yd; }
            else if (preset === 'week') { start = new Date(today); start.setDate(today.getDate()-today.getDay()); end = new Date(today); }
            else if (preset === 'month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today); }
            else if (preset === 'lastmonth') { start = new Date(today.getFullYear(), today.getMonth()-1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
            else if (preset === 'all') { document.getElementById('pwStartDate').value = ''; document.getElementById('pwEndDate').value = ''; return; }
            if (start) document.getElementById('pwStartDate').value = start.toISOString().split('T')[0];
            if (end) document.getElementById('pwEndDate').value = end.toISOString().split('T')[0];
        }

        function pwClearPresets() {
            const grid = document.getElementById('pwStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn');
            grid.forEach(b => b.classList.remove('active-preset'));
        }

        function resetProductWiseReport() {
            document.getElementById('pwStartDate').value = '';
            document.getElementById('pwEndDate').value = '';
            document.getElementById('pwShopFilter').value = 'all';
            document.getElementById('pwSalesmanFilter').value = 'all';
            document.getElementById('pwAreaFilter').value = 'all';
            document.getElementById('pwResultArea').style.display = 'none';
            const grid = document.getElementById('pwStartDate').closest('.collapsible-body').querySelectorAll('.preset-btn');
            grid.forEach((b,i) => { b.classList.remove('active-preset'); if(i===3) b.classList.add('active-preset'); });
            toast('Filters reset!', 'success');
        }

        function generateProductWiseReport() {
            const sVal = document.getElementById('pwStartDate').value;
            const eVal = document.getElementById('pwEndDate').value;
            const startMs = sVal ? new Date(sVal).setHours(0,0,0,0) : 0;
            const endMs   = eVal ? new Date(eVal).setHours(23,59,59,999) : Infinity;
            const shopF   = document.getElementById('pwShopFilter').value;
            const salesmanF = document.getElementById('pwSalesmanFilter').value;
            const areaF   = document.getElementById('pwAreaFilter').value;

            // Populate salesman filter dynamically
            const smSel = document.getElementById('pwSalesmanFilter');
            const curSm = smSel.value;
            const smSet = new Set();
            historyData.forEach(d => smSet.add(d.salesman));
            smSel.innerHTML = '<option value="all">All Salesmen</option>';
            smSet.forEach(s => { if(s) smSel.innerHTML += `<option value="${s}">${s}</option>`; });
            smSel.value = curSm;

            // Populate shop filter dynamically
            const shopSel = document.getElementById('pwShopFilter');
            const curShop = shopSel.value;
            shopSel.innerHTML = '<option value="all">All Shops</option>';
            Object.entries(globalShops).forEach(([id, d]) => {
                shopSel.innerHTML += `<option value="${id}">${d.name || id}</option>`;
            });
            shopSel.value = curShop;

            // Build set of shops in selected area
            const shopsInArea = areaF !== 'all' ? new Set(
                Object.entries(globalShops)
                    .filter(([id,d]) => (d.area||'') === areaF)
                    .map(([id,d]) => d.name || id)
            ) : null;

            // Aggregate
            const productMap = {}; // { name: { qty, revenue, orders } }
            let totalRevenue = 0;

            historyData.forEach(d => {
                const oMs = d.time ? d.time.toDate().getTime() : 0;
                if (oMs < startMs || oMs > endMs) return;
                if (shopF !== 'all' && d.shopName !== shopF) return;
                if (salesmanF !== 'all' && d.salesman !== salesmanF) return;
                if (shopsInArea && !shopsInArea.has(d.shopName)) return;

                d.items.forEach(item => {
                    if (!productMap[item.id]) productMap[item.id] = { qty: 0, revenue: 0, orders: 0 };
                    productMap[item.id].qty += item.qty;
                    productMap[item.id].revenue += (item.total || (item.qty * item.price) || 0);
                    productMap[item.id].orders += 1;
                    totalRevenue += (item.total || 0);
                });
            });

            if (!Object.keys(productMap).length) {
                toast('No data found for selected filters!', 'error');
                document.getElementById('pwResultArea').style.display = 'none';
                return;
            }

            // Build sorted array
            pwDataArray = Object.entries(productMap).map(([name, v]) => ({
                Product: name,
                'Qty Sold': v.qty,
                'Revenue (₹)': parseFloat(v.revenue.toFixed(2)),
                'Orders': v.orders,
                'Avg Per Order (₹)': v.orders > 0 ? parseFloat((v.revenue / v.orders).toFixed(2)) : 0,
                'Share (%)': totalRevenue > 0 ? parseFloat(((v.revenue / totalRevenue) * 100).toFixed(1)) : 0,
                _revenue: v.revenue,
                _qty: v.qty,
                _orders: v.orders
            }));

            pwDataArray.sort((a, b) => pwSortDir * (b._revenue - a._revenue));

            // Stats
            document.getElementById('pwTotalProducts').innerText = pwDataArray.length;
            document.getElementById('pwTotalQty').innerText = pwDataArray.reduce((s,r) => s + r['Qty Sold'], 0);
            document.getElementById('pwTotalRevenue').innerText = '₹ ' + totalRevenue.toFixed(2);
            document.getElementById('pwTableCount').innerText = `(${pwDataArray.length} products)`;

            pwRenderTable();
            pwRenderCharts(totalRevenue);
            pwRenderTopThree();

            document.getElementById('pwResultArea').style.display = 'block';
            toast('✅ Product report generated!', 'success');
        }

        function pwRenderTable() {
            const tbody = document.getElementById('pwTableBody');
            tbody.innerHTML = '';
            const medals = ['🥇','🥈','🥉'];
            const sortedByRevenue = [...pwDataArray].sort((a,b) => b._revenue - a._revenue);
            const totalRev = pwDataArray.reduce((s,r) => s + r._revenue, 0);

            pwDataArray.forEach((row, i) => {
                const rank = sortedByRevenue.findIndex(r => r.Product === row.Product) + 1;
                const medal = medals[rank-1] || `#${rank}`;
                const barWidth = totalRev > 0 ? Math.max(4, (row._revenue / totalRev) * 100).toFixed(0) : 0;
                const isTop = rank <= 3;
                tbody.innerHTML += `<tr style="${isTop ? 'background:rgba(99,102,241,0.04);' : ''}">
                    <td style="font-weight:800; font-size:15px; text-align:center;">${medal}</td>
                    <td>
                        <div style="font-weight:700;">${row.Product}</div>
                        <div style="background:var(--border); border-radius:99px; height:4px; margin-top:5px; overflow:hidden;">
                            <div style="width:${barWidth}%; height:100%; border-radius:99px; background:linear-gradient(90deg,var(--primary),#6366f1); transition:width 0.6s;"></div>
                        </div>
                    </td>
                    <td style="color:var(--primary); font-weight:700;">${row['Qty Sold']}</td>
                    <td style="color:var(--success); font-weight:800;">₹${row['Revenue (₹)'].toFixed(2)}</td>
                    <td style="color:#64748b;">${row.Orders}</td>
                    <td style="color:#64748b;">₹${row['Avg Per Order (₹)'].toFixed(2)}</td>
                    <td><span style="background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:20px; font-weight:700; font-size:11px;">${row['Share (%)'].toFixed(1)}%</span></td>
                </tr>`;
            });
        }

        function pwRenderCharts(totalRevenue) {
            const top10 = [...pwDataArray].sort((a,b) => b._revenue - a._revenue).slice(0, 10);
            const colors = ['#6366f1','#10b981','#f59e0b','#f43f5e','#22d3ee','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16'];

            // Bar chart
            const barCtx = document.getElementById('pwBarChart').getContext('2d');
            if (pwBarChartInstance) pwBarChartInstance.destroy();
            pwBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: top10.map(r => r.Product.length > 14 ? r.Product.substring(0,12)+'…' : r.Product),
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: top10.map(r => r._revenue),
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => '₹' + (v>=1000 ? (v/1000).toFixed(1)+'k' : v) } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });

            // Pie chart (top 5 + others)
            const top5 = top10.slice(0, 5);
            const othersRev = pwDataArray.slice(5).reduce((s,r) => s + r._revenue, 0);
            const pieLabels = top5.map(r => r.Product.length > 12 ? r.Product.substring(0,10)+'…' : r.Product);
            const pieData   = top5.map(r => r._revenue);
            if (othersRev > 0) { pieLabels.push('Others'); pieData.push(othersRev); }

            const pieCtx = document.getElementById('pwPieChart').getContext('2d');
            if (pwPieChartInstance) pwPieChartInstance.destroy();
            pwPieChartInstance = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: pieLabels,
                    datasets: [{ data: pieData, backgroundColor: [...colors, '#94a3b8'], borderWidth: 2 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 9 }, boxWidth: 10 } } }
                }
            });
        }

        function pwRenderTopThree() {
            const top3 = [...pwDataArray].sort((a,b) => b._revenue - a._revenue).slice(0, 3);
            const medals = ['🥇','🥈','🥉'];
            const bgColors = ['rgba(99,102,241,0.1)','rgba(16,185,129,0.08)','rgba(245,158,11,0.08)'];
            const borderColors = ['rgba(99,102,241,0.3)','rgba(16,185,129,0.25)','rgba(245,158,11,0.25)'];
            document.getElementById('pwTopThree').innerHTML = top3.map((r, i) => `
                <div style="background:${bgColors[i]}; border:1px solid ${borderColors[i]}; border-radius:12px; padding:10px 12px; margin-bottom:8px;">
                    <div style="font-size:18px; display:inline;">${medals[i]}</div>
                    <span style="font-weight:700; font-size:13px; margin-left:4px;">${r.Product}</span>
                    <div style="font-size:11px; color:#64748b; margin-top:4px;">
                        <span style="color:var(--success); font-weight:700;">₹${r['Revenue (₹)'].toFixed(0)}</span>
                        &nbsp;·&nbsp; ${r['Qty Sold']} units
                        &nbsp;·&nbsp; ${r.Orders} orders
                    </div>
                </div>`).join('');
        }

        function pwSortTable(key) {
            const keyMap = { rank:'_revenue', name:'Product', qty:'_qty', revenue:'_revenue', orders:'_orders' };
            const realKey = keyMap[key] || '_revenue';
            if (pwSortKey === realKey) pwSortDir *= -1; else { pwSortKey = realKey; pwSortDir = -1; }
            if (realKey === 'Product') {
                pwDataArray.sort((a,b) => pwSortDir * a.Product.localeCompare(b.Product));
            } else {
                pwDataArray.sort((a,b) => pwSortDir * (b[realKey] - a[realKey]));
            }
            pwRenderTable();
        }

    </script>
</body>
</html>
